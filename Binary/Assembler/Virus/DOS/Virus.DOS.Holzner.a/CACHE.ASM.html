<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc5">INTERRUPTS</span><span class="sc0">      </span><span class="sc9">SEGMENT</span><span class="sc0"> </span><span class="sc9">AT</span><span class="sc0"> </span><span class="sc2">0H</span><span class="sc0">    </span><span class="sc1">;This is where the disk interrupt</span><span class="sc0">
        </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc2">13H</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">;holds the address of its service routine</span><span class="sc0">
</span><span class="sc5">DISK_INT</span><span class="sc0">        </span><span class="sc9">LABEL</span><span class="sc0">   </span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc5">INTERRUPTS</span><span class="sc0">      </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc5">CODE_SEG</span><span class="sc0">        </span><span class="sc9">SEGMENT</span><span class="sc0">
        </span><span class="sc9">ASSUME</span><span class="sc0">  </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">CODE_SEG</span><span class="sc0">
        </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc2">100H</span><span class="sc0">            </span><span class="sc1">;ORG = 100H to make this into a .COM file</span><span class="sc0">
</span><span class="sc5">FIRST</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">LOAD_CACHE</span><span class="sc0">      </span><span class="sc1">;First time through jump to initialize routine</span><span class="sc0">

        </span><span class="sc5">CPY_RGT</span><span class="sc0"> </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'(C)1985 S.Holzner'</span><span class="sc0">     </span><span class="sc1">;A signature in bytes</span><span class="sc0">
        </span><span class="sc5">TBL_LEN</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">64</span><span class="sc0"> </span><span class="sc1">;&lt;-- # OF SECTORS TO STORE IN CACHE, MIN=24, MAX=124.</span><span class="sc0">
  </span><span class="sc1">;THIS IS THE ONLY PLACE YOU MUST SET THIS NUMBER. EACH SECTOR = 512 BYTES.</span><span class="sc0">
        </span><span class="sc5">TIME</span><span class="sc0">    </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;Time used to time-stamp each sector</span><span class="sc0">
        </span><span class="sc5">OLD_CX</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;Stores original value of CX (CX is used often)</span><span class="sc0">
        </span><span class="sc5">LOW_TIM</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;Used in searching for least recently used sect.</span><span class="sc0">
        </span><span class="sc5">INT13H</span><span class="sc0">  </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;Stores the original INT 13H address</span><span class="sc0">
        </span><span class="sc5">RET_ADR</span><span class="sc0"> </span><span class="sc9">LABEL</span><span class="sc0">   </span><span class="sc10">DWORD</span><span class="sc0">   </span><span class="sc1">;Playing games with the stack here to preserve</span><span class="sc0">
        </span><span class="sc5">RET_ADR_WORD</span><span class="sc0">    </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">            </span><span class="sc1">;flags returned by Int 13H</span><span class="sc0">

</span><span class="sc5">DISK_CACHE</span><span class="sc0">      </span><span class="sc9">PROC</span><span class="sc0">    </span><span class="sc10">FAR</span><span class="sc0">     </span><span class="sc1">;The Disk interrupt will now come here.</span><span class="sc0">
        </span><span class="sc9">ASSUME</span><span class="sc0">  </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">CODE_SEG</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">201H</span><span class="sc0">         </span><span class="sc1">;Is this a read (AH=2) of 1 sector (AL=1)?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">READ</span><span class="sc0">            </span><span class="sc1">;Yes, jump to Read</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">            </span><span class="sc1">;No. Perchance a write or format?</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">OLD_INT</span><span class="sc0">         </span><span class="sc1">;No, release control to old disk Int.</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">WRITE</span><span class="sc0">           </span><span class="sc1">;Yes, jump to Write</span><span class="sc0">
</span><span class="sc5">OLD_INT</span><span class="sc4">:</span><span class="sc6">PUSHF</span><span class="sc0">                   </span><span class="sc1">;Pushf for Int 13H's final Iret</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">INT13H</span><span class="sc0">          </span><span class="sc1">;Call the Disk Int</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">PAST</span><span class="sc0">            </span><span class="sc1">;And jump past all usual Pops</span><span class="sc0">
</span><span class="sc5">READ</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc0">              </span><span class="sc1">;Push just about every register ever heard of</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc8">BX</span><span class="sc0">       </span><span class="sc1">;Int 13H gets data address as ES:BX, switch to ES:DI</span><span class="sc0">
        </span><span class="sc9">ASSUME</span><span class="sc0">  </span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">CODE_SEG</span><span class="sc0">     </span><span class="sc1">;Make sure all labels found correctly</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">              </span><span class="sc1">;Move CS into DS by pushing CS, popping DS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">OLD_CX</span><span class="sc4">,</span><span class="sc8">CX</span><span class="sc0">       </span><span class="sc1">;Save original CX since we're about to use it</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">;DH holds requested head -- head 0?</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">NOT_FAT1</span><span class="sc0">        </span><span class="sc1">;Nope, this can't be the first Fat sector</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">            </span><span class="sc1">;If this is the directory, check if we have a</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">FAT1</span><span class="sc0">            </span><span class="sc1">; new disk.</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">;Track 0 (CH)? Sector 2 (CL)?</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">NOT_FAT1</span><span class="sc0">        </span><span class="sc1">;If not, this sure isn't the FAT1</span><span class="sc0">
</span><span class="sc5">FAT1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">FIND_MATCH</span><span class="sc0">  </span><span class="sc1">;DOS reads in this sector first to check disk format</span><span class="sc0">
        </span><span class="sc6">JCXZ</span><span class="sc0">    </span><span class="sc10">NONE</span><span class="sc0">            </span><span class="sc1">;We'll use it for a check-sum. Do we have it</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc8">DI</span><span class="sc0">           </span><span class="sc1">; stored yet? CX=0--&gt;no. If yes, restore BX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc5">OLD_CX</span><span class="sc0">       </span><span class="sc1">; and CX from original values</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">                   </span><span class="sc1">;And now do the Pushf and call of Int13H to read</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">INT13H</span><span class="sc0">          </span><span class="sc1">; FAT1</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">ERR</span><span class="sc0">             </span><span class="sc1">;If error, leave</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">256</span><span class="sc0">          </span><span class="sc1">;No error, FAT1 was read, check our value</span><span class="sc0">
</span><span class="sc6">REPE</span><span class="sc0">    </span><span class="sc6">CMPSW</span><span class="sc0">                   </span><span class="sc1">; with CMPSW -- if no match, disk was changed</span><span class="sc0">
        </span><span class="sc6">JCXZ</span><span class="sc0">    </span><span class="sc5">BYE</span><span class="sc0">             </span><span class="sc1">;Everything checks out, Bingo, exit.</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc5">TABLE</span><span class="sc0">        </span><span class="sc1">;New Disk! Zero all the old disk's sectors</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc5">TBL_LEN</span><span class="sc0">      </span><span class="sc1">;Loop over all entries, DL holds drive #</span><span class="sc0">
</span><span class="sc5">CLR</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">DL</span><span class="sc0">    </span><span class="sc1">;Is this stored sector from the old disk?</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">NO_CLR</span><span class="sc0">          </span><span class="sc1">;Nope, don't clear this entry</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">;Match, zero this entry, zero first word</span><span class="sc0">
</span><span class="sc5">NO_CLR</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc2">518</span><span class="sc0">      </span><span class="sc1">;Move on to next stored sector (512 bytes of stored</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">CLR</span><span class="sc0">         </span><span class="sc1">; sector and 3 words of identification &amp; time-stamp)</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">BYE</span><span class="sc0">             </span><span class="sc1">;Reset for new disk, let's leave</span><span class="sc0">
</span><span class="sc10">NONE</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">STORE_SECTOR</span><span class="sc0">    </span><span class="sc1">;Store FAT1 if there was no match to it</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">ERR</span><span class="sc0">             </span><span class="sc1">;Error -- exit ungraciously</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">BYE</span><span class="sc0">             </span><span class="sc1">;No Error, Bye.</span><span class="sc0">
</span><span class="sc5">NOT_FAT1</span><span class="sc4">:</span><span class="sc0">                       </span><span class="sc1">;The requested sector was not FAT1. Let's</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">FIND_MATCH</span><span class="sc0">      </span><span class="sc1">;get it. Or do we have it already?</span><span class="sc0">
        </span><span class="sc6">JCXZ</span><span class="sc0">    </span><span class="sc5">NO_MATCH</span><span class="sc0">        </span><span class="sc1">;No, jump to No_Match, store sector</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">          </span><span class="sc1">;ES:DI and DS:SI already set up from Find_Match</span><span class="sc0">
</span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSB</span><span class="sc0">                   </span><span class="sc1">;Move 512 bytes to requested memory area</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">0FFFFH</span><span class="sc0">          </span><span class="sc1">;Is this a a directory sector?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">BYE</span><span class="sc0">             </span><span class="sc1">;Yes, don't reset time (already highest poss.)</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc5">TIME</span><span class="sc0">            </span><span class="sc1">;No, reset the time, this sector just accessed</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc5">TIME</span><span class="sc0">         </span><span class="sc1">;Move time into Time word of sector's 3 words</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">       </span><span class="sc1">; of identification</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">BYE</span><span class="sc0">             </span><span class="sc1">;And leave. If there's an article you'd like to</span><span class="sc0">
</span><span class="sc5">NO_MATCH</span><span class="sc4">:</span><span class="sc0">                       </span><span class="sc1">;see, by all means write in C/O PC Magazine.</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">STORE_SECTOR</span><span class="sc0">    </span><span class="sc1">;Don't have this sector yet, get it.</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">ERR</span><span class="sc0">             </span><span class="sc1">;If read failed, exit with error</span><span class="sc0">
</span><span class="sc5">BYE</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CLC</span><span class="sc0">                     </span><span class="sc1">;The exit point. Clear carry flag, set AX=1</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; CY=0 --&gt; no error, AH=0 --&gt; error code = 0</span><span class="sc0">
</span><span class="sc5">ERR</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">              </span><span class="sc1">;If error, preserve flags and AX with error code</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">              </span><span class="sc1">;Pop all conceivable registers (except AX)</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">              </span><span class="sc1">;Now that the flags are set, we want to get the</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">              </span><span class="sc1">;old flags off the stack (put there by original</span><span class="sc0">
</span><span class="sc5">PAST</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">RET_ADR_WORD</span><span class="sc0"> </span><span class="sc1">;Int call) To do that we save the return address</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">RET_ADR_WORD</span><span class="sc4">[</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;first and then pop the flags harmlessly</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">OLD_CX</span><span class="sc0">       </span><span class="sc1">;into Old_CX, and then jump to RET_ADR.</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">RET_ADR</span><span class="sc0">      </span><span class="sc1">;Done with read. Now let's consider write.</span><span class="sc0">
</span><span class="sc5">WRITE</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc0">              </span><span class="sc1">;Push all registers, past and present</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">301H</span><span class="sc0">         </span><span class="sc1">;Is this a write of one sector?</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">NOSAVE</span><span class="sc0">          </span><span class="sc1">;No, don't save it in the sector bank</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">              </span><span class="sc1">;Yep, set DS (for call to Int13H label) and</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">              </span><span class="sc1">; write this sector out</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">INT13H</span><span class="sc0">
        </span><span class="sc6">JNC</span><span class="sc0">     </span><span class="sc5">SAVE</span><span class="sc0">       </span><span class="sc1">;If there was an error we don't want to save sector</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">OLD_CX</span><span class="sc0">       </span><span class="sc1">;Save AH error code, Pop old AX into Old_CX</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">ERR</span><span class="sc0">             </span><span class="sc1">;And jump to an ignoble exit</span><span class="sc0">
</span><span class="sc5">SAVE</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">OLD_CX</span><span class="sc4">,</span><span class="sc8">CX</span><span class="sc0">       </span><span class="sc1">;We're going to save this sector.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc8">BX</span><span class="sc0">           </span><span class="sc1">;Set up DI for string move (to store written</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">FIND_MATCH</span><span class="sc0">      </span><span class="sc1">; sector. Do we have it in memory? (set SI)</span><span class="sc0">
        </span><span class="sc6">JCXZ</span><span class="sc0">    </span><span class="sc6">LEAVE</span><span class="sc0">           </span><span class="sc1">;Nope, Leave (like above's Bye).</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc8">SI</span><span class="sc0">           </span><span class="sc1">;Exchange destination and source</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">              </span><span class="sc1">;Set up DS:SI to point to where data written</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">              </span><span class="sc1">; from. We'll then use a string move</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">              </span><span class="sc1">;Set up ES so ES:DI points to sector bank</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">              </span><span class="sc1">; SI was set by Find_Match, Xchg'd into DI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">          </span><span class="sc1">;Get ready to move 512 bytes</span><span class="sc0">
</span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSB</span><span class="sc0">                   </span><span class="sc1">;Here we go</span><span class="sc0">
</span><span class="sc6">LEAVE</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">              </span><span class="sc1">;Here is the leave</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">BYE</span><span class="sc0">             </span><span class="sc1">;Which only pops AX and then jumps to Bye</span><span class="sc0">
</span><span class="sc5">NOSAVE</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">              </span><span class="sc1">;More than 1 sector written, don't save but</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">              </span><span class="sc1">; do zero stored sectors that will be written</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">;Use AX as loop index (AL=# of sectors to write)</span><span class="sc0">
</span><span class="sc5">TOP</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">              </span><span class="sc1">;Save CX since destroyed by Find_Match</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">FIND_MATCH</span><span class="sc0">      </span><span class="sc1">;Do we have this one?</span><span class="sc0">
        </span><span class="sc6">JCXZ</span><span class="sc0">    </span><span class="sc5">NOPE</span><span class="sc0">            </span><span class="sc1">;Nope if CX = 0</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;There is a match, zero this sector</span><span class="sc0">
</span><span class="sc5">NOPE</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">              </span><span class="sc1">;Restore CX, the sector index</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc0">              </span><span class="sc1">;Move on to next one</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">              </span><span class="sc1">;Decrement loop index</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">TOP</span><span class="sc0">             </span><span class="sc1">;And, unless that gives 0, go back again</span><span class="sc0">
</span><span class="sc5">POPS</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">              </span><span class="sc1">;Pop 'em all, starting with AX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">OLD_INT</span><span class="sc0">         </span><span class="sc1">;And go back to OLD_INT for write.</span><span class="sc0">
</span><span class="sc5">DISK_CACHE</span><span class="sc0">      </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc5">FIND_MATCH</span><span class="sc0">      </span><span class="sc9">PROC</span><span class="sc0">    </span><span class="sc10">NEAR</span><span class="sc0">    </span><span class="sc1">;This routine finds a sector in the sector bank</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">              </span><span class="sc1">;And returns SI set to sector's entry, BX set</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc5">SECTORS</span><span class="sc0">      </span><span class="sc1">; to the beginning of the 'table' -- the 3 words</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc5">TABLE</span><span class="sc0">        </span><span class="sc1">;that precede all sectors. If there was no match</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc5">TBL_LEN</span><span class="sc0">      </span><span class="sc1">; CX=0. When Int13H called, CH=trk #, CL=sec. #</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">CX</span><span class="sc0">           </span><span class="sc1">; DH=head #, DL=Drive #. Get Tbl_Len into CX</span><span class="sc0">
</span><span class="sc5">FIND</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">;Compare stored sector's original AX to current</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">NO</span><span class="sc0">              </span><span class="sc1">;If not, not.</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">DX</span><span class="sc0">    </span><span class="sc1">;If so, check DX of stored sector with current</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">GOT_IT</span><span class="sc0">          </span><span class="sc1">;Yes, there is a match, leave</span><span class="sc0">
</span><span class="sc5">NO</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc2">518</span><span class="sc0">          </span><span class="sc1">;Point to next Table entry</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc2">518</span><span class="sc0">          </span><span class="sc1">;And next sector too</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">FIND</span><span class="sc0">            </span><span class="sc1">;Keep looping until there is a match</span><span class="sc0">
</span><span class="sc5">GOT_IT</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">              </span><span class="sc1">;If there is no match, CX will be left 0</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">                     </span><span class="sc1">;Return</span><span class="sc0">
</span><span class="sc5">FIND_MATCH</span><span class="sc0">      </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc5">STORE_SECTOR</span><span class="sc0">    </span><span class="sc9">PROC</span><span class="sc0">    </span><span class="sc10">NEAR</span><span class="sc0">    </span><span class="sc1">;This routine, as it says, stores sectors</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc8">DI</span><span class="sc0">           </span><span class="sc1">;Original BX (ES:BX was original data address)</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc5">OLD_CX</span><span class="sc0">       </span><span class="sc1">; and CX restored (CX=trk#, Sector#)</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">                   </span><span class="sc1">;Pushf for Int 13H's Iret and call it</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">INT13H</span><span class="sc0">
        </span><span class="sc6">JNC</span><span class="sc0">     </span><span class="sc5">ALL_OK</span><span class="sc0">          </span><span class="sc1">;If there was an exit, exit ignominiously</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">FIN</span><span class="sc0">             </span><span class="sc1">;If error, leave CY flag set, code in AH, exit</span><span class="sc0">
</span><span class="sc5">ALL_OK</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">              </span><span class="sc1">;No error, push used registers</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc0">              </span><span class="sc1">; and find space for sector in sector bank</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc5">SECTORS</span><span class="sc0">      </span><span class="sc1">;Point to sector bank</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc5">TABLE</span><span class="sc0">        </span><span class="sc1">; and Table</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc5">TBL_LEN</span><span class="sc0">      </span><span class="sc1">; and get ready to loop over all of them to</span><span class="sc0">
</span><span class="sc5">CHK0</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">;find if there is an unused sector</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">FOUND</span><span class="sc0">           </span><span class="sc1">;If the first word is 0, use this sector</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc2">518</span><span class="sc0">          </span><span class="sc1">;But this one isn't so update DI, SI and</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc2">518</span><span class="sc0">          </span><span class="sc1">; loop again</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">CHK0</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">LOW_TIM</span><span class="sc4">,</span><span class="sc2">0FFFEH</span><span class="sc0">  </span><span class="sc1">;All sectors were filled, find least recently</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc5">SECTORS</span><span class="sc0">      </span><span class="sc1">; used and write over that one</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc5">TABLE</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc5">TBL_LEN</span><span class="sc0">      </span><span class="sc1">;Loop over all stored sectors</span><span class="sc0">
</span><span class="sc5">CHKTIM</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc5">LOW_TIM</span><span class="sc0">      </span><span class="sc1">;Compare stored sector to so-far low time</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">JA</span><span class="sc0">      </span><span class="sc5">MORE_RECENT</span><span class="sc0">     </span><span class="sc1">;If this one is more recent, don't use it</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">DI</span><span class="sc0">           </span><span class="sc1">;This one is older than previous oldest</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc8">SI</span><span class="sc0">           </span><span class="sc1">;Store sector bank address (DI) and table</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; entry (now in SI)</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">LOW_TIM</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc0">      </span><span class="sc1">;And update the Low Time to this one</span><span class="sc0">
</span><span class="sc5">MORE_RECENT</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc2">518</span><span class="sc0">          </span><span class="sc1">;Move on to next stored sector</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc2">518</span><span class="sc0">          </span><span class="sc1">;And next table entry</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">CHKTIM</span><span class="sc0">          </span><span class="sc1">;Loop again until all covered</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">           </span><span class="sc1">;Get Sector bank address of oldest into DI</span><span class="sc0">
</span><span class="sc5">FOUND</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">              </span><span class="sc1">;Restore used registers</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">              </span><span class="sc1">;Old BX (data read-to-address) --&gt; SI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">],</span><span class="sc8">CX</span><span class="sc0">         </span><span class="sc1">;Store the new CX as the sector's first word</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">DX</span><span class="sc0">       </span><span class="sc1">;2nd word of Table is sector's DX</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc5">TIME</span><span class="sc0">            </span><span class="sc1">;Now find the new time</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc5">TIME</span><span class="sc0">         </span><span class="sc1">;Prepare to move it into 3rd word of Table</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">;Is this directory or FAT? (time--&gt;FFFF)</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">SIDE1</span><span class="sc0">           </span><span class="sc1">;If head is not 0, check other head</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">            </span><span class="sc1">;Head zero, trk# 0, first sector? (directory)</span><span class="sc0">
        </span><span class="sc6">JLE</span><span class="sc0">     </span><span class="sc5">DIR</span><span class="sc0">             </span><span class="sc1">;Yes, this is a piece we always want stored</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">NOT_DIR</span><span class="sc0">         </span><span class="sc1">;No, definitely not FAT or directory</span><span class="sc0">
</span><span class="sc5">SIDE1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">;Head 1?</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">NOT_DIR</span><span class="sc0">         </span><span class="sc1">;No, this is not File Alloc. Table or directory</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">;Part of the top of the directory?</span><span class="sc0">
        </span><span class="sc6">JA</span><span class="sc0">      </span><span class="sc5">NOT_DIR</span><span class="sc0">         </span><span class="sc1">;No, go to Not_Dir and set time</span><span class="sc0">
</span><span class="sc5">DIR</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">0FFFFH</span><span class="sc0">       </span><span class="sc1">;Dir or FAT, set time high so always kept</span><span class="sc0">
</span><span class="sc5">NOT_DIR</span><span class="sc4">:</span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">       </span><span class="sc1">;Not FAT or dir, store the incremented time</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">              </span><span class="sc1">;And now get the data to fill the sector</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">              </span><span class="sc1">;SI, DI already set. Now set ES and DS for</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">              </span><span class="sc1">; string move.</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">          </span><span class="sc1">;Move 512 bytes</span><span class="sc0">
</span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSB</span><span class="sc0">                   </span><span class="sc1">;Right here</span><span class="sc0">
        </span><span class="sc6">CLC</span><span class="sc0">                     </span><span class="sc1">;Clear the carry flag (no error)</span><span class="sc0">
</span><span class="sc5">FIN</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">RET</span><span class="sc0">                     </span><span class="sc1">;Error exit here (do not reset CY flag)</span><span class="sc0">
</span><span class="sc5">STORE_SECTOR</span><span class="sc0">    </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc5">TABLE</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">        </span><span class="sc1">;Table and sector storage begins right here</span><span class="sc0">
</span><span class="sc5">SECTORS</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">;First thing to write over is the following</span><span class="sc0">
                                </span><span class="sc1">; booster program.</span><span class="sc0">
</span><span class="sc5">LOAD_CACHE</span><span class="sc0">        </span><span class="sc9">PROC</span><span class="sc0">    </span><span class="sc10">NEAR</span><span class="sc0">  </span><span class="sc1">;This procedure intializes everything</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc5">CLEAR</span><span class="sc0">
        </span><span class="sc9">ASSUME</span><span class="sc0">  </span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">INTERRUPTS</span><span class="sc0">   </span><span class="sc1">;The data segment will be the Interrupt area</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc5">INTERRUPTS</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">DISK_INT</span><span class="sc0">    </span><span class="sc1">;Get the old interrupt service routine</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">INT13H</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; address and put it into our location         MOV     AX,word ptr DISK_INT[2]</span><span class="sc0">
                                        </span><span class="sc1">; INT13H so we can call it.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">INT13H</span><span class="sc4">[</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">DISK_INT</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">DISK_CACHE</span><span class="sc0">  </span><span class="sc1">;Now load address of Cache</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">DISK_INT</span><span class="sc4">[</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">CS</span><span class="sc0">   </span><span class="sc1">;routine into the Disk interrupt</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc5">TBL_LEN</span><span class="sc0">              </span><span class="sc1">;The number of sectors to store in cache</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">518</span><span class="sc0">                  </span><span class="sc1">;Multiply by 518 (3 words of id and 512</span><span class="sc0">
        </span><span class="sc6">MUL</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">                      </span><span class="sc1">; bytes of sector data)</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                   </span><span class="sc1">;Also, zero all the bytes so that</span><span class="sc0">
</span><span class="sc5">ZERO</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; Store_Sector will find 1st word a 0,</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">                      </span><span class="sc1">; indicating virgin territory.</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">ZERO</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">TABLE</span><span class="sc0">         </span><span class="sc1">;To attach in memory, add # bytes to</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                   </span><span class="sc1">;store to Table's location and use</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">27H</span><span class="sc0">                     </span><span class="sc1">; Int 27H</span><span class="sc0">
</span><span class="sc5">LOAD_CACHE</span><span class="sc0">        </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc5">CLEAR</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">CODE_SEG</span><span class="sc0">        </span><span class="sc9">ENDS</span><span class="sc0">
        </span><span class="sc9">END</span><span class="sc0">     </span><span class="sc5">FIRST</span><span class="sc0">           </span><span class="sc1">;END "FIRST" so 8088 will go to FIRST first.</span><span class="sc0">
</span></div></body>
</html>
