<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;This is a simple boot sector that will load either MS-DOS or PC-DOS. It is not</span><span class="sc0">
</span><span class="sc1">;self-reproducing, but it will be used as the foundation on which to build a</span><span class="sc0">
</span><span class="sc1">;virus into a boot sector.</span><span class="sc0">

</span><span class="sc1">;This segment is where the first operating system file (IBMBIO.COM or IO.SYS)</span><span class="sc0">
</span><span class="sc1">;will be loaded and executed from. We don't know (or care) what is there, but</span><span class="sc0">
</span><span class="sc1">;we do need the address to jump to defined in a separate segment so we can</span><span class="sc0">
</span><span class="sc1">;execute a far jump to it.</span><span class="sc0">
</span><span class="sc5">DOS_LOAD</span><span class="sc0">        </span><span class="sc9">SEGMENT</span><span class="sc0"> </span><span class="sc9">AT</span><span class="sc0"> </span><span class="sc2">0070H</span><span class="sc0">
                </span><span class="sc9">ASSUME</span><span class="sc0">  </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">DOS_LOAD</span><span class="sc0">

                </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">LOAD</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;Start of the first operating system program</span><span class="sc0">

</span><span class="sc5">DOS_LOAD</span><span class="sc0">        </span><span class="sc9">ENDS</span><span class="sc0">


</span><span class="sc5">MAIN</span><span class="sc0">            </span><span class="sc9">SEGMENT</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0">
                </span><span class="sc9">ASSUME</span><span class="sc0">  </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">MAIN</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">MAIN</span><span class="sc4">,</span><span class="sc8">SS</span><span class="sc4">:</span><span class="sc10">NOTHING</span><span class="sc0">

</span><span class="sc1">;This jump instruction is just here so we can compile this program as a COM</span><span class="sc0">
</span><span class="sc1">;file. It is never actually executed, and never becomes a part of the boot</span><span class="sc0">
</span><span class="sc1">;sector. Only the 512 bytes after the address 7C00 in this file become part of</span><span class="sc0">
</span><span class="sc1">;the boot sector.</span><span class="sc0">
                </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc2">100H</span><span class="sc0">

</span><span class="sc5">START</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">BOOTSEC</span><span class="sc0">

</span><span class="sc1">;The following two definitions are BIOS RAM bytes which contain information</span><span class="sc0">
</span><span class="sc1">;about the number and type of disk drives in the computer. These are needed by</span><span class="sc0">
</span><span class="sc1">;the virus to decide on where to look to find drives to infect. They are not</span><span class="sc0">
</span><span class="sc1">;normally needed by an ordinary boot sector.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;               ORG     0410H</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;SYSTEM_INFO:    DB      ?                       ;System info byte: Take bits 6 &amp; 7 and add 1 to get number of</span><span class="sc0">
</span><span class="sc1">;                                                ;disk drives on this system (eg 01 = 2 drives)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                ORG     0475H</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;HD_COUNT:       DB      ?                       ;Number of hard drives in the system</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;This area is reserved for loading the first sector of the root directory, when</span><span class="sc0">
</span><span class="sc1">;checking for the existence of system files and loading the first system file.</span><span class="sc0">

                </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc2">0500H</span><span class="sc0">

</span><span class="sc5">DISK_BUF</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">;Start of the buffer</span><span class="sc0">

</span><span class="sc1">;Here is the start of the boot sector code. This is the chunk we will take out</span><span class="sc0">
</span><span class="sc1">;of the compiled COM file and put it in the first sector on a 360K floppy disk.</span><span class="sc0">
</span><span class="sc1">;Note that this MUST be loaded onto a 360K floppy to work, because the</span><span class="sc0">
</span><span class="sc1">;parameters in the data area that follow are set up to work only with a 360K</span><span class="sc0">
</span><span class="sc1">;disk!</span><span class="sc0">

                </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc2">7C00H</span><span class="sc0">

</span><span class="sc5">BOOTSEC</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">BOOT</span><span class="sc0">                    </span><span class="sc1">;Jump to start of boot sector code</span><span class="sc0">

                </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc2">7C03H</span><span class="sc0">                   </span><span class="sc1">;This is needed because the jump will get coded as 2 bytes</span><span class="sc0">

</span><span class="sc5">DOS_ID</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'EZBOOT  '</span><span class="sc0">              </span><span class="sc1">;Name of this boot sector (8 bytes)</span><span class="sc0">
</span><span class="sc5">SEC_SIZE</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">200H</span><span class="sc0">                    </span><span class="sc1">;Size of a sector, in bytes</span><span class="sc0">
</span><span class="sc5">SECS_PER_CLUST</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">02</span><span class="sc0">                      </span><span class="sc1">;Number of sectors in a cluster</span><span class="sc0">
</span><span class="sc5">FAT_START</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">                       </span><span class="sc1">;Starting sector for the first File Allocation Table (FAT)</span><span class="sc0">
</span><span class="sc5">FAT_COUNT</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">2</span><span class="sc0">                       </span><span class="sc1">;Number of FATs on this disk</span><span class="sc0">
</span><span class="sc5">ROOT_ENTRIES</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">70H</span><span class="sc0">                     </span><span class="sc1">;Number of root directory entries</span><span class="sc0">
</span><span class="sc5">SEC_COUNT</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">2D0H</span><span class="sc0">                    </span><span class="sc1">;Total number of sectors on this disk</span><span class="sc0">
</span><span class="sc5">DISK_ID</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0FDH</span><span class="sc0">                    </span><span class="sc1">;Disk type code (This is 360KB)</span><span class="sc0">
</span><span class="sc5">SECS_PER_FAT</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">2</span><span class="sc0">                       </span><span class="sc1">;Number of sectors per FAT</span><span class="sc0">
</span><span class="sc5">SECS_PER_TRK</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">9</span><span class="sc0">                       </span><span class="sc1">;Sectors per track for this drive</span><span class="sc0">
</span><span class="sc5">HEADS</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">2</span><span class="sc0">                       </span><span class="sc1">;Number of heads (sides) on this drive</span><span class="sc0">
</span><span class="sc5">HIDDEN_SECS</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">;Number of hidden sectors on the disk</span><span class="sc0">

</span><span class="sc5">DSKBASETBL</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">;Specify byte 1: step rate time, head unload time</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">;Specify byte 2: Head load time, DMA mode</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">;Wait time until motor turned off, in clock ticks</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">;Bytes per sector (0=128, 1=256, 2=512, 3=1024)</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">12H</span><span class="sc0">                     </span><span class="sc1">;Last sector number (we make it large enough to handle 1.2/1.44 MB floppies)</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">;Gap length between sectors for r/w operations, in bytes</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">;Data transfer length when sector length not specified</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">;Gap length between sectors for format operations, in bytes</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">;Value stored in newly formatted sectors</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">                       </span><span class="sc1">;Head settle time, in milliseconds (we set it small to speed operations)</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">;Motor startup time, in 1/8 seconds</span><span class="sc0">

</span><span class="sc5">HEAD</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">;Current head to read from (scratch area used by boot sector)</span><span class="sc0">

</span><span class="sc1">;Here is the start of the boot sector code</span><span class="sc0">

</span><span class="sc5">BOOT</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">CLI</span><span class="sc0">                                     </span><span class="sc1">;interrupts off</span><span class="sc0">
                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                           </span><span class="sc1">;prepare to set up segments</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                           </span><span class="sc1">;set ES=0</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SS</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                           </span><span class="sc1">;start stack at 0000:7C00</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SP</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">BOOTSEC</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc2">1EH</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">                        </span><span class="sc1">;get address of disk</span><span class="sc0">
                </span><span class="sc6">LDS</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc8">SS</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;param table in ds:si</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">                              </span><span class="sc1">;save that address</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SS</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc0">                              </span><span class="sc1">;and its address</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">DSKBASETBL</span><span class="sc0">            </span><span class="sc1">;and update default</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">11</span><span class="sc0">                           </span><span class="sc1">;values to the table stored here</span><span class="sc0">
                </span><span class="sc6">CLD</span><span class="sc0">                                     </span><span class="sc1">;direction flag cleared</span><span class="sc0">
</span><span class="sc5">DFLT1</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">LODSB</span><span class="sc0">
                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">;anything non-zero</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">DFLT2</span><span class="sc0">                     </span><span class="sc1">;is not a default, so don't save it</span><span class="sc0">
                </span><span class="sc6">STOSB</span><span class="sc0">                                   </span><span class="sc1">;else put default value in place</span><span class="sc0">
                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">DFLT3</span><span class="sc0">                     </span><span class="sc1">;and go on to next</span><span class="sc0">
</span><span class="sc5">DFLT2</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc0">
</span><span class="sc5">DFLT3</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">DFLT1</span><span class="sc0">                           </span><span class="sc1">;and loop until cx=0</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">AH</span><span class="sc0">                           </span><span class="sc1">;set ax=0</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                           </span><span class="sc1">;set ds=0 so we can set disk tbl</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">              </span><span class="sc1">;to @DSKBASETBL (ax=0 here)</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">],</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">DSKBASETBL</span><span class="sc0"> </span><span class="sc1">;ok, done</span><span class="sc0">
                </span><span class="sc6">STI</span><span class="sc0">                                     </span><span class="sc1">;now turn interrupts on</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">13H</span><span class="sc0">                             </span><span class="sc1">;and reset disk drive system</span><span class="sc0">
</span><span class="sc5">ERROR1</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">ERROR1</span><span class="sc0">                          </span><span class="sc1">;if an error, hang the machine</span><span class="sc0">

</span><span class="sc1">;Here we look at the first file on the disk to see if it is the first MS-DOS or</span><span class="sc0">
</span><span class="sc1">;PC-DOS system file, IO.SYS or IBMBIO.COM, respectively.</span><span class="sc0">
</span><span class="sc5">LOOK_SYS</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FAT_COUNT</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;get fats per disk</span><span class="sc0">
                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc8">AH</span><span class="sc0">
                </span><span class="sc6">MUL</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SECS_PER_FAT</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;multiply by sectors per fat</span><span class="sc0">
                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">HIDDEN_SECS</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;add hidden sectors</span><span class="sc0">
                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FAT_START</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;add starting fat sector</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DOS_ID</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">            </span><span class="sc1">;root dir, save it</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">20H</span><span class="sc0">                          </span><span class="sc1">;dir entry size</span><span class="sc0">
                </span><span class="sc6">MUL</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ROOT_ENTRIES</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;dir size in ax</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SEC_SIZE</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;sector size</span><span class="sc0">
                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">BX</span><span class="sc0">                           </span><span class="sc1">;add one sector</span><span class="sc0">
                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">                              </span><span class="sc1">;decrement by 1</span><span class="sc0">
                </span><span class="sc6">DIV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">                              </span><span class="sc1">;ax=# sectors in root dir</span><span class="sc0">
                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DOS_ID</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">            </span><span class="sc1">;DOS_ID=start of data</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">DISK_BUF</span><span class="sc0">              </span><span class="sc1">;set up disk read buffer at 0000:0500</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CONVERT</span><span class="sc0">                         </span><span class="sc1">;and go convert sequential sector number to bios data</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">;prepare for a disk read for 1 sector</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">READ_DISK</span><span class="sc0">                       </span><span class="sc1">;go read it</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc8">BX</span><span class="sc0">                           </span><span class="sc1">;compare first file on disk with</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">11</span><span class="sc0">                           </span><span class="sc1">;required file name</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">SYSFILE_1</span><span class="sc0">             </span><span class="sc1">;of first system file for PC DOS</span><span class="sc0">
                </span><span class="sc6">REPZ</span><span class="sc0">    </span><span class="sc6">CMPSB</span><span class="sc0">
                </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">SYSTEM_THERE</span><span class="sc0">                    </span><span class="sc1">;ok, found it, go load it</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc8">BX</span><span class="sc0">                           </span><span class="sc1">;compare first file with</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">11</span><span class="sc0">                           </span><span class="sc1">;required file name</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">SYSFILE_2</span><span class="sc0">             </span><span class="sc1">;of first system file for MS DOS</span><span class="sc0">
                </span><span class="sc6">REPZ</span><span class="sc0">    </span><span class="sc6">CMPSB</span><span class="sc0">
</span><span class="sc5">ERROR2</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">ERROR2</span><span class="sc0">                          </span><span class="sc1">;not the same - an error, so hang the machine</span><span class="sc0">

</span><span class="sc1">;Ok, system file is there, so load it</span><span class="sc0">
</span><span class="sc5">SYSTEM_THERE</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DISK_BUF</span><span class="sc4">+</span><span class="sc2">1CH</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;get file size of IBMBIO.COM/IO.SYS</span><span class="sc0">
                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc0">
                </span><span class="sc6">DIV</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SEC_SIZE</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;and divide by sector size</span><span class="sc0">
                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc0">                              </span><span class="sc1">;ax=number of sectors to read</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                           </span><span class="sc1">;store that number in BP</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DOS_ID</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;get sector number of start of data</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc2">700H</span><span class="sc0">                         </span><span class="sc1">;set disk read buffer to 0000:0700</span><span class="sc0">
</span><span class="sc5">RD_BOOT1</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DOS_ID</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;and get sector to read</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CONVERT</span><span class="sc0">                         </span><span class="sc1">;convert to bios Trk/Cyl/Sec info</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">;read one sector</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">READ_DISK</span><span class="sc0">                       </span><span class="sc1">;go read the disk</span><span class="sc0">
                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">;subtract 1 from number of sectors to read</span><span class="sc0">
                </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">DO_BOOT</span><span class="sc0">                         </span><span class="sc1">;and quit if we're done</span><span class="sc0">
                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DOS_ID</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">             </span><span class="sc1">;add sectors read to sector to read</span><span class="sc0">
                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SEC_SIZE</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;and update buffer address</span><span class="sc0">
                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">RD_BOOT1</span><span class="sc0">                        </span><span class="sc1">;then go for another</span><span class="sc0">


</span><span class="sc1">;Ok, the first system file has been read in, now transfer control to it</span><span class="sc0">
</span><span class="sc5">DO_BOOT</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CH</span><span class="sc4">,</span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DISK_ID</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;Put drive type in ch</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DRIVE</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;Drive number in dl</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">
                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc10">FAR</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">LOAD</span><span class="sc0">                    </span><span class="sc1">;and transfer control to the first system file</span><span class="sc0">


</span><span class="sc1">;Convert sequential sector number in ax to BIOS Track, Head, Sector information.</span><span class="sc0">
</span><span class="sc1">;Save track number in DX, sector number in CH,</span><span class="sc0">
</span><span class="sc5">CONVERT</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc0">
                </span><span class="sc6">DIV</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SECS_PER_TRK</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;divide ax by sectors per track</span><span class="sc0">
                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">DL</span><span class="sc0">                              </span><span class="sc1">;dl=sector number to start read on, al=track/head count</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CH</span><span class="sc4">,</span><span class="sc8">DL</span><span class="sc0">                           </span><span class="sc1">;save it here</span><span class="sc0">
                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc0">
                </span><span class="sc6">DIV</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">HEADS</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;divide ax by head count</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">HEAD</span><span class="sc4">],</span><span class="sc8">DL</span><span class="sc0">              </span><span class="sc1">;dl=head number, save it</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                           </span><span class="sc1">;ax=track number, save it in dx</span><span class="sc0">
                </span><span class="sc6">RET</span><span class="sc0">


</span><span class="sc1">;Read the disk for the number of sectors in al, into the buffer es:bx, using</span><span class="sc0">
</span><span class="sc1">;the track number in DX, the head number at HEAD, and the sector</span><span class="sc0">
</span><span class="sc1">;number at CH.</span><span class="sc0">
</span><span class="sc5">READ_DISK</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                            </span><span class="sc1">;read disk command</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">                            </span><span class="sc1">;shift possible upper 2 bits of track number to</span><span class="sc0">
                </span><span class="sc6">SHL</span><span class="sc0">     </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc8">CL</span><span class="sc0">                           </span><span class="sc1">;the high bits in dh</span><span class="sc0">
                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc8">CH</span><span class="sc0">                           </span><span class="sc1">;and put sector number in the low 6 bits</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc0">
                </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">CH</span><span class="sc4">,</span><span class="sc8">CL</span><span class="sc0">                           </span><span class="sc1">;ch (0-5) = sector, cl, ch (6-7) = track</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DRIVE</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;get drive number from here</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">HEAD</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;and head number from here</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">13H</span><span class="sc0">                             </span><span class="sc1">;go read the disk</span><span class="sc0">
</span><span class="sc5">ERROR3</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">ERROR3</span><span class="sc0">                          </span><span class="sc1">;hang in case of an error</span><span class="sc0">
                </span><span class="sc6">RET</span><span class="sc0">

</span><span class="sc1">;Move data that doesn't change from this boot sector to the one read in at</span><span class="sc0">
</span><span class="sc1">;DISK_BUF. That includes everything but the DRIVE ID (at offset 7DFDH) and</span><span class="sc0">
</span><span class="sc1">;the data area at the beginning of the boot sector.</span><span class="sc0">
</span><span class="sc5">MOVE_DATA</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">DSKBASETBL</span><span class="sc0">            </span><span class="sc1">;Move all of the boot sector code after the data area</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">DISK_BUF</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">DSKBASETBL</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">BOOTSEC</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">DRIVE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">DSKBASETBL</span><span class="sc0">
                </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSB</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">BOOTSEC</span><span class="sc0">               </span><span class="sc1">;Move the initial jump and the sector ID</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">DISK_BUF</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">11</span><span class="sc0">
                </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSB</span><span class="sc0">
                </span><span class="sc6">RET</span><span class="sc0">


</span><span class="sc5">SYSFILE_1</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'IBMBIO  COM'</span><span class="sc0">                   </span><span class="sc1">;PC DOS System file</span><span class="sc0">
</span><span class="sc5">SYSFILE_2</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'IO      SYS'</span><span class="sc0">                   </span><span class="sc1">;MS DOS System file</span><span class="sc0">

                </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc2">7DFDH</span><span class="sc0">

</span><span class="sc5">DRIVE</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                               </span><span class="sc1">;Drive number, used in disk reads, etc.</span><span class="sc0">
</span><span class="sc5">BOOT_ID</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0AA55H</span><span class="sc0">                          </span><span class="sc1">;Boot sector ID word</span><span class="sc0">


</span><span class="sc5">MAIN</span><span class="sc0">            </span><span class="sc9">ENDS</span><span class="sc0">


                </span><span class="sc9">END</span><span class="sc0"> </span><span class="sc5">START</span></div></body>
</html>
