<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;  Формат слова статуса для REG/MEM trash</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  WD = 00 - W нет D нет             0,1 Wbit &amp; Dbit</span><span class="sc0">
</span><span class="sc1">;   01 - W=0,1 D нет</span><span class="sc0">
</span><span class="sc1">;   10 - W=0,1 D=1</span><span class="sc0">
</span><span class="sc1">;   11 - W=0,1 D=0,1</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  TR = 0 - не тестировать поле REG      2   TestREG</span><span class="sc0">
</span><span class="sc1">;   1 - тестировать поле REG</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                        3   TestREG/MEM</span><span class="sc0">
</span><span class="sc1">;  TRM = 0 - не тестить поле REG/MEM</span><span class="sc0">
</span><span class="sc1">;    1 - тестить на регистр</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  MemOnly = 0 - произвольно             4   MemOnly</span><span class="sc0">
</span><span class="sc1">;        1 - только в память</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  PLCMD = 00 - нет дополнительной команды   5,6 PLaceCoMmanD</span><span class="sc0">
</span><span class="sc1">;      01 - в КОП'e              местоположение</span><span class="sc0">
</span><span class="sc1">;      10 - в ModeRM</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  ImmF = 0 - нет дополнительного операнда    7   Immediate</span><span class="sc0">
</span><span class="sc1">;     1 - есть дополнительный операнд</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                        8,9,10</span><span class="sc0">
</span><span class="sc1">;                        дополнительная команда</span><span class="sc0">
</span><span class="sc1">;                        11,12,13</span><span class="sc0">
</span><span class="sc1">;                        дополнительный КОП</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  KillAD = 0 - не портит AX и DX        14  KillAX,DX</span><span class="sc0">
</span><span class="sc1">;       1 - портит AX и DX</span><span class="sc0">

</span><span class="sc5">Wbit</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">WDbit</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000011b</span><span class="sc0">
</span><span class="sc5">TR</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000100b</span><span class="sc0">
</span><span class="sc5">TRM</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00001000b</span><span class="sc0">
</span><span class="sc5">MemOnly</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00010000b</span><span class="sc0">
</span><span class="sc5">CMDinCOP</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00100000b</span><span class="sc0">
</span><span class="sc5">CMDinRM</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">01000000b</span><span class="sc0">
</span><span class="sc5">ImmF</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">10000000b</span><span class="sc0">
</span><span class="sc1">;       High Byte</span><span class="sc0">
</span><span class="sc5">XtraCMD</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000111b</span><span class="sc0">
</span><span class="sc5">XtraCOP</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00111000b</span><span class="sc0">
</span><span class="sc5">KillAD</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">01000000b</span><span class="sc0">

</span><span class="sc5">RMTAB</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">10001010b</span><span class="sc4">,</span><span class="sc2">10b</span><span class="sc4">+</span><span class="sc5">TR</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">; MOV REG,REG/MEM</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">10000110b</span><span class="sc4">,</span><span class="sc2">01b</span><span class="sc4">+</span><span class="sc5">TR</span><span class="sc4">+</span><span class="sc5">TRM</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">; XCHG REG,REG</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">10001101b</span><span class="sc4">,</span><span class="sc2">00b</span><span class="sc4">+</span><span class="sc5">TR</span><span class="sc4">+</span><span class="sc5">MemOnly</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; LEA REG,MEM</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00000010b</span><span class="sc4">,</span><span class="sc2">10b</span><span class="sc4">+</span><span class="sc5">TR</span><span class="sc4">+</span><span class="sc5">CMDinCOP</span><span class="sc4">,</span><span class="sc2">111b</span><span class="sc0">      </span><span class="sc1">; ARCMD REG,REG/MEM</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00111000b</span><span class="sc4">,</span><span class="sc2">11b</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">             </span><span class="sc1">; CMP REG,REG/MEM</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">10000100b</span><span class="sc4">,</span><span class="sc2">01b</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">             </span><span class="sc1">; TEST REG,REG/MEM</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11000110b</span><span class="sc4">,</span><span class="sc2">01b</span><span class="sc4">+</span><span class="sc5">TR</span><span class="sc4">+</span><span class="sc5">CMDinRM</span><span class="sc4">+</span><span class="sc5">TRM</span><span class="sc4">+</span><span class="sc5">ImmF</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; MOV REG,Imm8/16</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">10000000b</span><span class="sc4">,</span><span class="sc2">01b</span><span class="sc4">+</span><span class="sc5">TR</span><span class="sc4">+</span><span class="sc5">CMDinRM</span><span class="sc4">+</span><span class="sc5">TRM</span><span class="sc4">+</span><span class="sc5">ImmF</span><span class="sc4">,</span><span class="sc2">111b</span><span class="sc0">  </span><span class="sc1">; ARCMD REG,Imm8/16</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11110110b</span><span class="sc4">,</span><span class="sc2">01b</span><span class="sc4">+</span><span class="sc5">TR</span><span class="sc4">+</span><span class="sc5">CMDinRM</span><span class="sc4">+</span><span class="sc5">ImmF</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; TEST REG/MEM,Imm8/16</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11111110b</span><span class="sc4">,</span><span class="sc2">01b</span><span class="sc4">+</span><span class="sc5">TR</span><span class="sc4">+</span><span class="sc5">CMDinRM</span><span class="sc4">+</span><span class="sc5">TRM</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">      </span><span class="sc1">; INC/DEC REG</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11110110b</span><span class="sc4">,</span><span class="sc2">01b</span><span class="sc4">+</span><span class="sc5">TR</span><span class="sc4">+</span><span class="sc5">CMDinRM</span><span class="sc4">+</span><span class="sc5">TRM</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc2">010000b</span><span class="sc0">  </span><span class="sc1">; NOT/NEG REG</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11110110b</span><span class="sc4">,</span><span class="sc2">01b</span><span class="sc4">+</span><span class="sc5">TR</span><span class="sc4">+</span><span class="sc5">CMDinRM</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc2">100000b</span><span class="sc4">+</span><span class="sc5">KillAD</span><span class="sc0">    </span><span class="sc1">; MUL/IMUL REG/MEM</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">10001100b</span><span class="sc4">,</span><span class="sc2">00b</span><span class="sc4">+</span><span class="sc5">TR</span><span class="sc4">+</span><span class="sc5">CMDinRM</span><span class="sc4">+</span><span class="sc5">TRM</span><span class="sc4">,</span><span class="sc2">11b</span><span class="sc0">    </span><span class="sc1">; MOV REG,SREG</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11010000b</span><span class="sc4">,</span><span class="sc2">01b</span><span class="sc4">+</span><span class="sc5">TR</span><span class="sc4">+</span><span class="sc5">CMDinRM</span><span class="sc4">+</span><span class="sc5">TRM</span><span class="sc4">,</span><span class="sc2">111b</span><span class="sc0">   </span><span class="sc1">; SHIFT REG,1</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11010010b</span><span class="sc4">,</span><span class="sc2">01b</span><span class="sc4">+</span><span class="sc5">TR</span><span class="sc4">+</span><span class="sc5">CMDinRM</span><span class="sc4">+</span><span class="sc5">TRM</span><span class="sc4">,</span><span class="sc2">111b</span><span class="sc0">   </span><span class="sc1">; SHIFT REG,CL</span><span class="sc0">

</span><span class="sc1">; Замечания :</span><span class="sc0">
</span><span class="sc1">;       Нет сдвигового мусора через НОП imm8</span><span class="sc0">
</span><span class="sc1">;       Нет расширения НОП'а до полного размера в ARCMD , S=0</span><span class="sc0">

</span><span class="sc5">ENDRMTAB</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc1">; Таблица offset'ов на SUB'ы</span><span class="sc0">
</span><span class="sc5">SUBOFFS</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0FFFFh</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0FFFFh</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0FFFFh</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0FFFFh</span><span class="sc0">

</span><span class="sc1">; Таблица простого мусора</span><span class="sc0">

</span><span class="sc5">RotF</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000010b</span><span class="sc0">
</span><span class="sc5">KillAX</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00001000b</span><span class="sc0">
</span><span class="sc5">SmplyCMD</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">01110000b</span><span class="sc0">

</span><span class="sc5">SimplyTAB</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">10110000b</span><span class="sc4">,</span><span class="sc2">01b</span><span class="sc4">+</span><span class="sc5">TR</span><span class="sc4">+</span><span class="sc5">ImmF</span><span class="sc0">           </span><span class="sc1">; MOV REG,Imm8/16</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">10010000b</span><span class="sc4">,</span><span class="sc2">00b</span><span class="sc4">+</span><span class="sc5">TR</span><span class="sc4">+</span><span class="sc5">KillAX</span><span class="sc0">         </span><span class="sc1">; XCHG AX,REG</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">01000000b</span><span class="sc4">,</span><span class="sc2">00b</span><span class="sc4">+</span><span class="sc5">TR</span><span class="sc4">+</span><span class="sc5">RotF</span><span class="sc4">+</span><span class="sc2">10000b</span><span class="sc0">        </span><span class="sc1">; INC/DEC REG</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">10100001b</span><span class="sc4">,</span><span class="sc2">00b</span><span class="sc4">+</span><span class="sc5">KillAX</span><span class="sc4">+</span><span class="sc5">ImmF</span><span class="sc0">       </span><span class="sc1">; MOV AX,MEM</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00000100b</span><span class="sc4">,</span><span class="sc2">01b</span><span class="sc4">+</span><span class="sc5">KillAX</span><span class="sc4">+</span><span class="sc5">RotF</span><span class="sc4">+</span><span class="sc5">ImmF</span><span class="sc4">+</span><span class="sc5">SmplyCMD</span><span class="sc0"> </span><span class="sc1">; ARCMD AL/AX,Imm8/16</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">10101000b</span><span class="sc4">,</span><span class="sc2">01b</span><span class="sc4">+</span><span class="sc5">ImmF</span><span class="sc0">          </span><span class="sc1">; TEST AL/AX,Imm8/16</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00100111b</span><span class="sc4">,</span><span class="sc2">00b</span><span class="sc4">+</span><span class="sc5">KillAX</span><span class="sc4">+</span><span class="sc5">RotF</span><span class="sc4">+</span><span class="sc2">110000b</span><span class="sc0">   </span><span class="sc1">; DAA/DAS/AAA/AAS</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11111000b</span><span class="sc4">,</span><span class="sc2">00b</span><span class="sc4">+</span><span class="sc2">1010000b</span><span class="sc0">          </span><span class="sc1">; STI,CLI,STD,CLD,STC,CLC</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11110101b</span><span class="sc4">,</span><span class="sc2">00b</span><span class="sc0">               </span><span class="sc1">; CMC</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">10011000b</span><span class="sc4">,</span><span class="sc2">00b</span><span class="sc4">+</span><span class="sc5">KillAX</span><span class="sc0">            </span><span class="sc1">; CBW</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11010111b</span><span class="sc4">,</span><span class="sc2">00b</span><span class="sc4">+</span><span class="sc5">KillAX</span><span class="sc0">            </span><span class="sc1">; XLAT</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11001100b</span><span class="sc4">,</span><span class="sc2">00b</span><span class="sc0">               </span><span class="sc1">; INT 3</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">10011110b</span><span class="sc4">,</span><span class="sc2">00b</span><span class="sc4">+</span><span class="sc5">KillAX</span><span class="sc4">+</span><span class="sc2">10000b</span><span class="sc0">     </span><span class="sc1">; SAHF,LAHF</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">10010000b</span><span class="sc4">,</span><span class="sc2">00b</span><span class="sc0">               </span><span class="sc1">; NOP</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00100110b</span><span class="sc4">,</span><span class="sc2">00b</span><span class="sc4">+</span><span class="sc5">RotF</span><span class="sc4">+</span><span class="sc2">110000b</span><span class="sc0">      </span><span class="sc1">; ES/CS/SS/DS</span><span class="sc0">

</span><span class="sc5">SimplyEND</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc1">; Замечания :</span><span class="sc0">
</span><span class="sc1">;       Нет мусора ввода в аккумулятор из порта</span><span class="sc0">
</span><span class="sc1">;       Нет мусора AAM,AAD</span><span class="sc0">
</span><span class="sc1">;       Нет MOV AL,MEM</span><span class="sc0">

</span><span class="sc1">; Таблица мусорных процедур</span><span class="sc0">

</span><span class="sc5">TRCMDs</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SimplyTRASH</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SUBROUTINE</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CALLtoSUB</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RMTRASH</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">JUMPTRASH</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PUSHPOPTRASH</span><span class="sc0">
</span><span class="sc5">TREND</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">GETVAL</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc1">;       Взять значение по случайному индексу</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">GETVAL</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;-------------------</span><span class="sc0">
</span><span class="sc5">GETTRASHREG</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
        </span><span class="sc6">bt</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">Wbit</span><span class="sc0">       </span><span class="sc1">; Истинный Wbit</span><span class="sc0">
        </span><span class="sc6">cmc</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GETFREEREG</span><span class="sc0">    </span><span class="sc1">; Берем незанятый регистр</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FREEREG</span><span class="sc0">       </span><span class="sc1">; Но не помечаем его как занятый -</span><span class="sc0">
                      </span><span class="sc1">; это же мусор</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">GETTRASHREG</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;-------------------</span><span class="sc0">
</span><span class="sc5">AddImmediate</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc1">; Добавление непосредственного операнда</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc5">ImmF</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">ExitImmed</span><span class="sc0">

        </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">bt</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">Wbit</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">ExitImmed</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">ExitImmed</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">AddImmediate</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;-------------------</span><span class="sc0">
</span><span class="sc5">AddXtraCMD</span><span class="sc0">  </span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc1">; Добавление дополнительной команды</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc5">XtraCOP</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">         </span><span class="sc1">; Добавляем дополнительную команду</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc5">XtraCMD</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">          </span><span class="sc1">; влево на 3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">AddXtraCMD</span><span class="sc0">  </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc1">;-------------------</span><span class="sc0">
</span><span class="sc5">MAKE_WDbits</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc1">; Enter : Bl - flags</span><span class="sc0">
</span><span class="sc1">; Exit  : Dl - WDbits</span><span class="sc0">
</span><span class="sc1">;     Bl - Real WDbits</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">          </span><span class="sc1">; CL - индекс WDbits</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc5">WDbit</span><span class="sc0">   </span><span class="sc1">; Сбросим индекс WDbits</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc5">WDbit</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc1">;              ┌┬─┬─┬──────── RND bits</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">10100100b</span><span class="sc0">
</span><span class="sc5">WDbits</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">

        </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11010100b</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WDbits</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">          </span><span class="sc1">; Истинные биты W и D</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">          </span><span class="sc1">; Во флаге команды заменим индекс WD</span><span class="sc0">
                       </span><span class="sc1">; на истинное значение</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ExitWDbits</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">         </span><span class="sc1">; Если Wbit не присутствует в команде</span><span class="sc0">
                       </span><span class="sc1">; то он по умолчанию W=1</span><span class="sc0">
</span><span class="sc5">ExitWDbits</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">MAKE_WDbits</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc1">;-------------------</span><span class="sc0">
</span><span class="sc5">MAKE_ModeRM</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc1">; Enter : AL - ModeRM байт</span><span class="sc0">
</span><span class="sc1">;     BX - status с RealWD</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc5">TR</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">COPorREG</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">          </span><span class="sc1">; Не тестируем регистр</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">AddREG</span><span class="sc0">
</span><span class="sc5">COPorREG</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc5">CMDinRM</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">AddFreeREG</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">AddXtraCMD</span><span class="sc0">    </span><span class="sc1">; Добавим команду</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">REGMEM</span><span class="sc0">
</span><span class="sc5">AddFreeREG</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GETTRASHREG</span><span class="sc0">    </span><span class="sc1">; Берем незанятый регистр</span><span class="sc0">
</span><span class="sc5">AddREG</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">          </span><span class="sc1">; + REG</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc5">REGMEM</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc5">TRM</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">TestRM</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">         </span><span class="sc1">; Mode</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc5">MemOnly</span><span class="sc0">   </span><span class="sc1">; Mode!=11b - только в память</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">falce</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc5">falce</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">        </span><span class="sc1">; DH=Mode</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">         </span><span class="sc1">; DL=REG/MEM</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">RMdone</span><span class="sc0">
</span><span class="sc5">TestRM</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GETTRASHREG</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc5">RMdone</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">         </span><span class="sc1">; + Mode</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">         </span><span class="sc1">; + RM</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">        </span><span class="sc1">; Индексная без НОП'a</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">NextMode</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">00000110b</span><span class="sc0">     </span><span class="sc1">; НОП операнд MEM</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Index16</span><span class="sc0">

</span><span class="sc5">NextMode</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">01000000b</span><span class="sc0">     </span><span class="sc1">; Индексная + imm8</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Index8</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">10000000b</span><span class="sc0">     </span><span class="sc1">; Регистровая адресация</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ExitModeRM</span><span class="sc0">
</span><span class="sc5">Index16</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">; Индексная + imm16</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7Fh</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">Index8</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7Fh</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">ExitModeRM</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">MAKE_ModeRM</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc1">;-------------------</span><span class="sc0">
</span><span class="sc5">FinishJP</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">JRQ</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">FinishPP</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">JUMPTRASH</span><span class="sc0">      </span><span class="sc1">;закроем JMP</span><span class="sc0">
</span><span class="sc5">FinishPP</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">PRQ</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">JPisFinished</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PUSHPOPTRASH</span><span class="sc0">       </span><span class="sc1">;закроем PUSH/POP</span><span class="sc0">
</span><span class="sc5">JPisFinished</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">FinishJP</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;-------------------</span><span class="sc0">
</span><span class="sc5">JUMPTRASH</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc1">;       Мусор из условных переходов</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">PH_FLAGS</span><span class="sc4">],</span><span class="sc5">JRQ</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">AddRel8toJMP</span><span class="sc0">          </span><span class="sc1">;Закончим Jump</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01110000B</span><span class="sc0">          </span><span class="sc1">;Jxx Rel8</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">   </span><span class="sc1">;Тип Jump'a готов</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">JmpPLACE</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">   </span><span class="sc1">;адрес места для Relative</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">PH_FLAGS</span><span class="sc4">],</span><span class="sc5">JRQ</span><span class="sc0">  </span><span class="sc1">;Установим Jump Request</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">AddRel8toJMP</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1234h</span><span class="sc0">
</span><span class="sc5">JmpPLACE</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PH_FLAGS</span><span class="sc4">],</span><span class="sc5">JRQ</span><span class="sc0"> </span><span class="sc1">;Сбросим запрос на завершение Jmp'a</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">JUMPTRASH</span><span class="sc0">   </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc1">;-------------------</span><span class="sc0">
</span><span class="sc5">PUSHPOPTRASH</span><span class="sc0">    </span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc1">;       Мусорные push'истые pop'ы</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">PH_FLAGS</span><span class="sc4">],</span><span class="sc5">JRQ</span><span class="sc0">  </span><span class="sc1">; Если есть флаг запроса jmp'a ,то</span><span class="sc0">
                    </span><span class="sc1">; делать PUSH/POP нельзя</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">PPExit</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01010000b</span><span class="sc0">    </span><span class="sc1">; PUSH/POP</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">PH_FLAGS</span><span class="sc4">],</span><span class="sc5">PRQ</span><span class="sc0">  </span><span class="sc1">; PUSH/POP request is set ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">MakePOP</span><span class="sc0">
</span><span class="sc5">MakePUSH</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PH_FLAGS</span><span class="sc4">],</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">PRQ</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">        </span><span class="sc1">; RND регистр или SREG</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DROPCOIN</span><span class="sc0">    </span><span class="sc1">; PUSH reg или PUSH Sreg</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">DonePUSHPOP</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00000110b</span><span class="sc0">    </span><span class="sc1">; PUSH Sreg</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">00000011b</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">DonePUSHPOP</span><span class="sc0">
</span><span class="sc5">MakePOP</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00001000b</span><span class="sc0">    </span><span class="sc1">; POP Reg</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GETFREEREG</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FREEREG</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">PH_FLAGS</span><span class="sc4">],</span><span class="sc5">PRQ</span><span class="sc0">
</span><span class="sc5">DonePUSHPOP</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PH_FLAGS</span><span class="sc4">],</span><span class="sc5">PRQ</span><span class="sc0">
</span><span class="sc5">PPExit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">PUSHPOPTRASH</span><span class="sc0">    </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc1">;-------------------</span><span class="sc0">
</span><span class="sc5">SUBROUTINE</span><span class="sc0">  </span><span class="sc9">PROC</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc5">PH_FLAGS</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">SRQ</span><span class="sc0">       </span><span class="sc1">; SRQ установлен ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">FinishSUB</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">JRQ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">PRQ</span><span class="sc0">    </span><span class="sc1">; Не делаем процедуру</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">SUBExit</span><span class="sc0">      </span><span class="sc1">; если JRQ,PRQ=1</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">SRQ</span><span class="sc0">       </span><span class="sc1">; Установим SUB request</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">CRQ</span><span class="sc0">   </span><span class="sc1">; Теперь можно делать CALL'ы</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PH_FLAGS</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">      </span><span class="sc1">; JMP Relative 8 bit</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">JMPovrSUB</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RMTRASH</span><span class="sc0">     </span><span class="sc1">; + маленько мусора</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SimplyTRASH</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0000b</span><span class="sc0">
</span><span class="sc5">SubPtr</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SUBOFFS</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">  </span><span class="sc1">; Заносим адрес процедуры</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; в таблицу смещений на SUB'ы</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">00000111b</span><span class="sc0">        </span><span class="sc1">; таблица из 4х релокейшнов</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SubPtr</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">SUBExit</span><span class="sc0">
</span><span class="sc5">FinishSUB</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FinishJP</span><span class="sc0">    </span><span class="sc1">; Закончим JMP и PUSH/POP мусор</span><span class="sc0">
                    </span><span class="sc1">; (если он есть)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SimplyTRASH</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RMTRASH</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">JMPovrSUB</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PH_FLAGS</span><span class="sc4">],</span><span class="sc5">SRQ</span><span class="sc0">
</span><span class="sc5">SUBExit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">SUBROUTINE</span><span class="sc0">  </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc1">;-------------------</span><span class="sc0">
</span><span class="sc5">CALLtoSUB</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0">

        </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">DontMakeCALL</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">PH_FLAGS</span><span class="sc4">],</span><span class="sc5">CRQ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">SRQ</span><span class="sc0">    </span><span class="sc1">; Если не закончена</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">DontMakeCALL</span><span class="sc0">         </span><span class="sc1">; какая то SUB'рутина</span><span class="sc0">
                         </span><span class="sc1">; или CALL'ы вообще</span><span class="sc0">
                         </span><span class="sc1">; не разрешены то выход</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc5">NextSubroutine</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">00000011b</span><span class="sc0">      </span><span class="sc1">; 4 offset'a на CALL'ы</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SUBOFFS</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GETVAL</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">NextSubRoutine</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc5">DontMakeCALL</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">CALLtoSUB</span><span class="sc0">   </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc1">;-------------------</span><span class="sc0">
</span><span class="sc5">RMTRASH</span><span class="sc0">     </span><span class="sc9">PROC</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,(</span><span class="sc5">ENDRMTAB</span><span class="sc4">-</span><span class="sc5">RMTAB</span><span class="sc4">)/</span><span class="sc2">3</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">

        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">; Index</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RMTAB</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Load Code Operation</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RMTAB</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Load Status Word</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc5">KillAD</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">SimplyCMD</span><span class="sc0">      </span><span class="sc1">; Портит ли команда AX,DX ?</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">REG_USED</span><span class="sc4">],</span><span class="sc2">00000101b</span><span class="sc0"> </span><span class="sc1">; А можно ли ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ExitRMtrash</span><span class="sc0">
</span><span class="sc5">SimplyCMD</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MAKE_WDbits</span><span class="sc0">    </span><span class="sc1">; Сделаем биты W и D</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc5">CMDinCOP</span><span class="sc0">    </span><span class="sc1">; Есть дополнительная команда ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">OneCommand</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">AddXtraCMD</span><span class="sc0">
</span><span class="sc5">OneCommand</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">; байт ModeRM</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MAKE_ModeRM</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">AddImmediate</span><span class="sc0">
</span><span class="sc5">ExitRMtrash</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">RMTRASH</span><span class="sc0">     </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc1">;-------------------</span><span class="sc0">
</span><span class="sc5">SimplyTRASH</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,(</span><span class="sc5">SimplyEND</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">SimplyTAB</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SimplyTAB</span><span class="sc0">     </span><span class="sc1">; AL - COP</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GETVAL</span><span class="sc0">              </span><span class="sc1">; AH - StatByte</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc5">KillAX</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">GoodCMD</span><span class="sc0">      </span><span class="sc1">; Портит ли команда AX ?</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">REG_USED</span><span class="sc4">],</span><span class="sc2">00000001b</span><span class="sc0"> </span><span class="sc1">; А можно ли ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ExitSimply</span><span class="sc0">
</span><span class="sc5">GoodCMD</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc5">RotF</span><span class="sc0">     </span><span class="sc1">; Выделим бит RotF</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Make_WDbits</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">       </span><span class="sc1">; Установим обратно бит RotF</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc5">TR</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">DontREG</span><span class="sc0">

        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GETTRASHREG</span><span class="sc0"> </span><span class="sc1">; Берем незанятый регистр</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">AddCMD</span><span class="sc0">
</span><span class="sc5">DontREG</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">
</span><span class="sc5">AddCMD</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc5">SmplyCMD</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc5">RotF</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">DontRot</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc5">DontRot</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">AddImmediate</span><span class="sc0">
</span><span class="sc5">ExitSimply</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">SimplyTRASH</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;-------------------</span><span class="sc0">
</span><span class="sc5">TRCHAIN</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">     </span><span class="sc1">; От 8 до 16 мусорных команд</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc5">AddTRCommand</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TRCMDs</span><span class="sc0">   </span><span class="sc1">; массив мусорных процедур</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,(</span><span class="sc5">TREND</span><span class="sc4">-</span><span class="sc5">TRCMDs</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GETVAL</span><span class="sc0">         </span><span class="sc1">; Возьмем offset</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">; Вызовем</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">AddTRCommand</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc5">PH_FLAGS</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FinishJP</span><span class="sc0">       </span><span class="sc1">; Закончим JMP и PUSH/POP trash</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">SRQ</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">ExitTRchain</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SUBROUTINE</span><span class="sc0">     </span><span class="sc1">; Закончим SUB'рутину</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RMTRASH</span><span class="sc0">
</span><span class="sc5">ExitTRchain</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">; Не имеет значения</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">TRCHAIN</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">
</span></div></body>
</html>
