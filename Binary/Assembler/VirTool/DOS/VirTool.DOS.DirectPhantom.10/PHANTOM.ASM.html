<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc5">CntF</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000001b</span><span class="sc0">   </span><span class="sc1">; счетчик / предел</span><span class="sc0">
</span><span class="sc5">RMF</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000010b</span><span class="sc0">   </span><span class="sc1">; регистр / память</span><span class="sc0">
</span><span class="sc5">UcF</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000100b</span><span class="sc0">   </span><span class="sc1">; неизвестное место кода</span><span class="sc0">

</span><span class="sc5">REG_AX</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; Регистры по порядку</span><span class="sc0">
</span><span class="sc5">REG_CX</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">REG_DX</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">REG_BX</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc5">REG_SP</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">REG_BP</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
</span><span class="sc5">REG_SI</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
</span><span class="sc5">REG_DI</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">

</span><span class="sc5">PhantomID</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Direct Phantom v1.0 beta'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

                     </span><span class="sc1">; 7             0</span><span class="sc0">
</span><span class="sc5">REG_USED</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00010000b</span><span class="sc0">    </span><span class="sc1">; DI SI BP SP BX DX CX AX</span><span class="sc0">
                     </span><span class="sc1">; 7             0</span><span class="sc0">
</span><span class="sc5">HALF_USED</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00000000b</span><span class="sc0">    </span><span class="sc1">; BH DH CH AH BL DL CL AL</span><span class="sc0">

</span><span class="sc5">PH_FLAGS</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; флаги</span><span class="sc0">

</span><span class="sc5">BASE_REG</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">KEY_REG</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; ключ</span><span class="sc0">
</span><span class="sc5">CNT_REG</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">TMP_REG</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">BASE_RM</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; адресация через базу в память</span><span class="sc0">
</span><span class="sc5">BASE_TR</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; база - init</span><span class="sc0">

</span><span class="sc5">PHTEMP_BASE</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; адрес места повторной INIT базы</span><span class="sc0">
</span><span class="sc5">PHTEMP_CNT</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; адрес места повторной INIT счетчика</span><span class="sc0">
</span><span class="sc5">EncryptPart</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; адрес EP в стеке</span><span class="sc0">

</span><span class="sc5">INITTAB</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">INITBASEOFFS</span><span class="sc0">   </span><span class="sc1">; Таблица инициализации</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">INITBASESEG</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">INITKEY</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">INITCOUNTER</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">INITBASESEG</span><span class="sc0">
</span><span class="sc5">INITFLAGS</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------</span><span class="sc0">
</span><span class="sc5">ImmF</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">10000000b</span><span class="sc0">
</span><span class="sc5">KeyF</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">01000000b</span><span class="sc0">

        </span><span class="sc1">; COP , ModeR/M , Flags &amp; Зеркальная команда</span><span class="sc0">

</span><span class="sc5">CRYPTTAB</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11000000b</span><span class="sc4">,</span><span class="sc2">11000000b</span><span class="sc4">,</span><span class="sc5">ImmF</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">   </span><span class="sc1">; ROL REG/MEM,IMM8</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11000000b</span><span class="sc4">,</span><span class="sc2">11001000b</span><span class="sc4">,</span><span class="sc5">ImmF</span><span class="sc4">+</span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; ROR REG/MEM,IMM8</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">10000000b</span><span class="sc4">,</span><span class="sc2">11000000b</span><span class="sc4">,</span><span class="sc5">ImmF</span><span class="sc4">+</span><span class="sc2">9</span><span class="sc0">   </span><span class="sc1">; ADD REG/MEM,imm8</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">10000000b</span><span class="sc4">,</span><span class="sc2">11101000b</span><span class="sc4">,</span><span class="sc5">ImmF</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc0">   </span><span class="sc1">; SUB REG/MEM,imm8</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">10000000b</span><span class="sc4">,</span><span class="sc2">11110000b</span><span class="sc4">,</span><span class="sc5">ImmF</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc0">  </span><span class="sc1">; XOR reg/mem,imm8</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11110110b</span><span class="sc4">,</span><span class="sc2">11010000b</span><span class="sc4">,</span><span class="sc2">15</span><span class="sc0">       </span><span class="sc1">; NOT reg/mem</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11110110b</span><span class="sc4">,</span><span class="sc2">11011000b</span><span class="sc4">,</span><span class="sc2">18</span><span class="sc0">       </span><span class="sc1">; NEG reg/mem</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11111110b</span><span class="sc4">,</span><span class="sc2">11000000b</span><span class="sc4">,</span><span class="sc2">24</span><span class="sc0">       </span><span class="sc1">; INC reg/mem</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11111110b</span><span class="sc4">,</span><span class="sc2">11001000b</span><span class="sc4">,</span><span class="sc2">21</span><span class="sc0">       </span><span class="sc1">; DEC reg/mem</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11010000b</span><span class="sc4">,</span><span class="sc2">11000000b</span><span class="sc4">,</span><span class="sc2">30</span><span class="sc0">       </span><span class="sc1">; ROL REG/MEM,1</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">11010000b</span><span class="sc4">,</span><span class="sc2">11001000b</span><span class="sc4">,</span><span class="sc2">27</span><span class="sc0">       </span><span class="sc1">; ROR REG/MEM,1</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00000000b</span><span class="sc4">,</span><span class="sc2">11000000b</span><span class="sc4">,</span><span class="sc5">KeyF</span><span class="sc4">+</span><span class="sc2">36</span><span class="sc0">  </span><span class="sc1">; ADD reg/mem,KEY</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00101000b</span><span class="sc4">,</span><span class="sc2">11000000b</span><span class="sc4">,</span><span class="sc5">KeyF</span><span class="sc4">+</span><span class="sc2">33</span><span class="sc0">  </span><span class="sc1">; SUB reg/mem,KEY</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00110000b</span><span class="sc4">,</span><span class="sc2">11000000b</span><span class="sc4">,</span><span class="sc5">KeyF</span><span class="sc4">+</span><span class="sc2">39</span><span class="sc0">  </span><span class="sc1">; XOR reg/mem,KEY</span><span class="sc0">
</span><span class="sc5">ENDCRCMD</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">RND</span><span class="sc0">     </span><span class="sc9">PROC</span><span class="sc0">        </span><span class="sc1">; DL = RND (0..DL)  Получить случайный байт</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc8">DL</span><span class="sc0">            </span><span class="sc1">; RND(0..0)=0</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">  </span><span class="sc5">EXRND</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">

        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">          </span><span class="sc1">; для 0FFh не надо +1</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0"> </span><span class="sc5">OKK</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">
</span><span class="sc5">OKK</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">0100H</span><span class="sc0">        </span><span class="sc1">; размер единичного отрезка</span><span class="sc0">
        </span><span class="sc6">DIV</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">
        </span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">

        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">DL</span><span class="sc0">
        </span><span class="sc6">IN</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">40H</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ROTATE</span><span class="sc4">],</span><span class="sc8">AL</span><span class="sc0">

        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">55H</span><span class="sc0">
</span><span class="sc5">OLD_RND</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">RCL</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">55H</span><span class="sc0">
</span><span class="sc5">ROTATE</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">OLD_RND</span><span class="sc4">],</span><span class="sc8">AL</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">AH</span><span class="sc0">     </span><span class="sc1">; Если RND больше, чем ЕдОтр*ВерхГран,</span><span class="sc0">
        </span><span class="sc6">JBE</span><span class="sc0"> </span><span class="sc5">OKK1</span><span class="sc0">      </span><span class="sc1">; то обрезаем до EдOтр*ВерхГран</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">AH</span><span class="sc0">
</span><span class="sc5">OKK1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc8">AH</span><span class="sc0">         </span><span class="sc1">; Делим полученный RND-байт на Единичн.Отрезок</span><span class="sc0">
        </span><span class="sc6">DIV</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc8">AL</span><span class="sc0">
</span><span class="sc5">EXRND</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">RETN</span><span class="sc0">
</span><span class="sc5">RND</span><span class="sc0">     </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc1">;-------------------</span><span class="sc0">
</span><span class="sc5">DROPCOIN</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc1">; подбрасывание монетки - результат в ZF</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">DROPCOIN</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;-------------------</span><span class="sc0">
</span><span class="sc5">GETNUM</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc1">; Exit - RND = 0...dl , al = mask</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">GETNUM</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;-------------------</span><span class="sc0">
</span><span class="sc5">GETFREEREG</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc1">; CF=0 - регистр</span><span class="sc0">
</span><span class="sc1">; CF=1 - полурегистр</span><span class="sc0">
</span><span class="sc1">; Возвращает свободный регистр в DL</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">HalfReg</span><span class="sc0">
</span><span class="sc5">NextReg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GETNUM</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">REG_USED</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">NextReg</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">REG_USED</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">; Пометим как занятый</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">        </span><span class="sc1">; биты 3...0 в 7...0</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">         </span><span class="sc1">; для HALF_USED</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">HALF_USED</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">   </span><span class="sc1">; Пометим</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">RegDone</span><span class="sc0">
</span><span class="sc5">HalfReg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GETNUM</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">HALF_USED</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">HalfReg</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">HALF_USED</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">  </span><span class="sc1">; Пометим как занятый</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">DontRotate</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">        </span><span class="sc1">; Пометим как занятый и в REG_USED</span><span class="sc0">
</span><span class="sc5">DontRotate</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">REG_USED</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">RegDone</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">GETFREEREG</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;-------------------</span><span class="sc0">
</span><span class="sc5">FREEREG</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc1">; Обьвляет регистр свободным</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">; биты 3...0 в 7...0</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">           </span><span class="sc1">; для HALF_USED</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">FreeHalfReg</span><span class="sc0">

        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">         </span><span class="sc1">; Освобождаем регистр и</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">REG_USED</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">      </span><span class="sc1">; два соответствующих полурегистра</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">HALF_USED</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">EndFreeReg</span><span class="sc0">
</span><span class="sc5">FreeHalfReg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">HALF_USED</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">     </span><span class="sc1">; Если второй полурегистр свободен</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc5">HALF_USED</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; то освобождаем регистр</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">EndFreeReg</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">REG_USED</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">EndFreeReg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">FREEREG</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;-------------------</span><span class="sc0">
</span><span class="sc5">MAKERM</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc1">; Исходя из индексного регистра в DL делает</span><span class="sc0">
</span><span class="sc1">; соответствующую адресацию впамять</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00011011b</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc5">REG_BX</span><span class="sc0">    </span><span class="sc1">; BX</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">RM</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc5">REG_BP</span><span class="sc0">    </span><span class="sc1">; BP</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">RM</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc5">REG_DI</span><span class="sc0">    </span><span class="sc1">; DI</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">RM</span><span class="sc0">

        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">         </span><span class="sc1">; SI</span><span class="sc0">
</span><span class="sc5">RM</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00000011b</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00000100b</span><span class="sc0">     </span><span class="sc1">; DONE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BASE_RM</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">MAKERM</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;-------------------</span><span class="sc0">
</span><span class="sc5">SavePRFX</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BASE_REG</span><span class="sc4">],</span><span class="sc5">REG_BP</span><span class="sc0">    </span><span class="sc1">; Префикс только перед [BP]</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">PRFX_OUT</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00100110b</span><span class="sc0">
</span><span class="sc5">RNDPRFX</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00011000b</span><span class="sc0">   </span><span class="sc1">; ES или DS</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">RNDPRFX</span><span class="sc0">

        </span><span class="sc6">stosb</span><span class="sc0">              </span><span class="sc1">; DONE</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">PRFX_OUT</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">SavePRFX</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;-------------------</span><span class="sc0">
</span><span class="sc5">INITBASEOFFS</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc1">; базирует регистр на криптуемый код</span><span class="sc0">
</span><span class="sc1">; возможно неизвестное смещение - код сразу за декриптором</span><span class="sc0">

</span><span class="sc5">GetBase</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GETFREEREG</span><span class="sc0">    </span><span class="sc1">; получили базу</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11101000b</span><span class="sc0"> </span><span class="sc1">;маска индексных регистров : SI,DI,BP,BX</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">BASEOK</span><span class="sc0">

        </span><span class="sc6">clc</span><span class="sc0">          </span><span class="sc1">;только индексные</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FREEREG</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">GetBase</span><span class="sc0">
</span><span class="sc5">BASEOK</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BASE_REG</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">     </span><span class="sc1">; запомним</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MAKERM</span><span class="sc0">        </span><span class="sc1">; сделаем r/m байт</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10111000b</span><span class="sc0">      </span><span class="sc1">; mov reg,imm16</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">DEST_CODE</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Смещение криптуемого кода</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">PH_FLAGS</span><span class="sc4">],</span><span class="sc5">UcF</span><span class="sc0">  </span><span class="sc1">; еще известно - доделаем потом</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">make_base</span><span class="sc0">   </span><span class="sc1">; DESTCODE будет сразу за декриптором</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">            </span><span class="sc1">; пока база 0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PHTEMP_BASE</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
</span><span class="sc5">make_base</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">   </span><span class="sc1">; Словное дополнительное TRASH смещение</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">    </span><span class="sc1">; INITBASE = BASE - TRASH</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BASE_TR</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TRCHAIN</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">INITBASEOFFS</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;-------------------</span><span class="sc0">
</span><span class="sc5">INITBASESEG</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc1">; Установим ES,DS = CS</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">00011000b</span><span class="sc0">       </span><span class="sc1">; ES или DS</span><span class="sc0">
</span><span class="sc5">DEST_SREG</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">00001000b</span><span class="sc0">       </span><span class="sc1">; CS</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MAKESEGREG</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DEST_SREG</span><span class="sc4">],</span><span class="sc2">00011000b</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">INITBASESEG</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;-------------------</span><span class="sc0">
</span><span class="sc5">MAKESEGREG</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc1">; dh - destination sreg      Моделируется : PUHS SRC  или  MOV REG,SRC</span><span class="sc0">
</span><span class="sc1">; dl - source sreg              POP DEST       MOV DEST,REG</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DROPCOIN</span><span class="sc0">    </span><span class="sc1">; подбросим монетку</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">SECONDPART</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00000110b</span><span class="sc0">      </span><span class="sc1">; PUSH SREG</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">         </span><span class="sc1">; + SOURCE</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TRCHAIN</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">         </span><span class="sc1">; сбросим SOURCE</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">; + POP</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">         </span><span class="sc1">; + DESTINATION</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">DoneSreg</span><span class="sc0">
</span><span class="sc5">SECONDPART</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1100000010001100B</span><span class="sc0">      </span><span class="sc1">; MOV REG,SREG</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GETFREEREG</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">         </span><span class="sc1">; промежуточный регистр</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TRCHAIN</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">         </span><span class="sc1">; сбросим SOURCE</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">          </span><span class="sc1">; Set Dbit - MOV SREG,AX</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">         </span><span class="sc1">; + DESTINATION</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">         </span><span class="sc1">; + промежуточный регистр</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">         </span><span class="sc1">; свободен для дальнейшего</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FREEREG</span><span class="sc0">

</span><span class="sc5">DoneSreg</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TRCHAIN</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">MAKESEGREG</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;-------------------</span><span class="sc0">
</span><span class="sc5">INITKEY</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">      </span><span class="sc1">; ключ</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10110000b</span><span class="sc0">    </span><span class="sc1">; MOV REG,IMM8</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GETFREEREG</span><span class="sc0">  </span><span class="sc1">; сам регистр</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">KEY_REG</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">    </span><span class="sc1">; он нам еще будет нужен</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TRCHAIN</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">INITKEY</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;-------------------</span><span class="sc0">
</span><span class="sc5">INITCOUNTER</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DROPCOIN</span><span class="sc0">    </span><span class="sc1">; ограничивание криптуемого кода -</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">CodeLimit</span><span class="sc0">   </span><span class="sc1">; сравнивание с пределом</span><span class="sc0">

        </span><span class="sc6">clc</span><span class="sc0">         </span><span class="sc1">; сделаем счетчик</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GETFREEREG</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CNT_REG</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10111000b</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">counter</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">PH_FLAGS</span><span class="sc4">],</span><span class="sc5">CntF</span><span class="sc0">    </span><span class="sc1">; ограничивание по счетчику</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TRCHAIN</span><span class="sc0">        </span><span class="sc1">; DEC CNT</span><span class="sc0">
</span><span class="sc5">CodeLimit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PH_FLAGS</span><span class="sc4">],</span><span class="sc5">CntF</span><span class="sc0">    </span><span class="sc1">; ограничивание по пределу</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">            </span><span class="sc1">; CMP BASE,DESTCODE+COUNTER</span><span class="sc0">
</span><span class="sc5">INITCOUNTER</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;-------------------</span><span class="sc0">
</span><span class="sc5">INITPHANTOM</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc1">;Инициализация всех параметров в произвольном порядке</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DROPCOIN</span><span class="sc0">      </span><span class="sc1">;криптование REG/MEM ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">CRYPTTYPE</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">PH_FLAGS</span><span class="sc4">],</span><span class="sc5">RMF</span><span class="sc0">    </span><span class="sc1">; криптование непосредственно</span><span class="sc0">
                      </span><span class="sc1">; в память</span><span class="sc0">
</span><span class="sc5">CRYPTTYPE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DEST_CODE</span><span class="sc4">],</span><span class="sc2">0FFFFh</span><span class="sc0">   </span><span class="sc1">; DEST_CODE неизвестно</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">fixed</span><span class="sc0">            </span><span class="sc1">; будет сразу за декриптором</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">PH_FLAGS</span><span class="sc4">],</span><span class="sc5">UcF</span><span class="sc0">       </span><span class="sc1">; установим Unknown Code Flag</span><span class="sc0">
</span><span class="sc5">fixed</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; Последовательный RND вызов процедур настройки параметров</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">INITTAB</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">NextProc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GETNUM</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">    </span><span class="sc1">; index в таблице адресов процедур</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">INITFLAGS</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ThisProcIsDone</span><span class="sc0">    </span><span class="sc1">; Уже была выполнена</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">INITFLAGS</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">; Пометим</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc8">BX</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Выполним</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">NextProc</span><span class="sc0">
</span><span class="sc5">ThisProcIsDone</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">INITFLAGS</span><span class="sc4">],</span><span class="sc2">1Fh</span><span class="sc0">   </span><span class="sc1">; все процедуры выполнены ?</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NextProc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">INITPHANTOM</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;-------------------</span><span class="sc0">
</span><span class="sc5">ENCRYPT</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc1">; Генерирует команды загрузки/сохранения байта из криптуемого кода,если RmF=0</span><span class="sc0">
</span><span class="sc1">; Генерирует последовательность расшифровывающих команд - DecryptPart ,</span><span class="sc0">
</span><span class="sc1">; параллельно в стеке генерится зеркальная последовательность - EncryptPart</span><span class="sc0">
</span><span class="sc1">; для последующей зашифровки кода</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CryptExit</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PH_LABEL</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">   </span><span class="sc1">; метка дла перехода</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TRCHAIN</span><span class="sc0">          </span><span class="sc1">; разбавим дерьмом</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">PH_FLAGS</span><span class="sc4">],</span><span class="sc5">RMF</span><span class="sc0">  </span><span class="sc1">; не надо загрузки байта в TMP_REG</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">MEMCRYPT</span><span class="sc0">

</span><span class="sc1">; Моделируем Загрузку байта из кода</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GETFREEREG</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TMP_REG</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SavePRFX</span><span class="sc0">         </span><span class="sc1">; Если нужно сделаем префикс</span><span class="sc0">

                         </span><span class="sc1">; для команды сохранения байта</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LoadSaveCMD</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10001010b</span><span class="sc0">       </span><span class="sc1">; MOV REG,R/M</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10000000b</span><span class="sc0">       </span><span class="sc1">; байт ModeR/M</span><span class="sc0">

        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">           </span><span class="sc1">; + TMP_REG</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">          </span><span class="sc1">; + адресацию в память</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc5">BASE_RM</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">BASE_TR</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; + мусор - REALBASE = INIT + TRASH</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TRCHAIN</span><span class="sc0">
</span><span class="sc5">MEMCRYPT</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; Генерим EN/DEcryptionPart</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CRYPTLAB</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc1">; В [CRYPTLAB] будет помещен JMP в DecryptPart</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CRYPTTAB</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">      </span><span class="sc1">; криптующих команд : RND (8...16)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
                        </span><span class="sc1">; STKFRM - размер DecPart в стеке</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">STKFRM</span><span class="sc4">],</span><span class="sc2">6</span><span class="sc0"> </span><span class="sc1">; Пока только дальний JMP</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">  </span><span class="sc1">; Seg:Offs Decryptor'a</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OffsFARJump</span><span class="sc4">],</span><span class="sc8">sp</span><span class="sc0">  </span><span class="sc1">; Для смещения - оно</span><span class="sc0">
                           </span><span class="sc1">; еще не известно</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0EA90h</span><span class="sc0">     </span><span class="sc1">; Far Jump обратно в декриптор</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">MAKE_CRYPT_CMD</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,(</span><span class="sc5">ENDCRCMD</span><span class="sc4">-</span><span class="sc5">CRYPTTAB</span><span class="sc4">)/</span><span class="sc2">3</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RND</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">         </span><span class="sc1">; индекс команды в таблице</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">9090h</span><span class="sc0">     </span><span class="sc1">; Stack Frame for THIS command</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">STKFRM</span><span class="sc4">],</span><span class="sc2">6</span><span class="sc0">  </span><span class="sc1">; увеличим</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">PH_FLAGS</span><span class="sc4">],</span><span class="sc5">RMF</span><span class="sc0">  </span><span class="sc1">; Нужен префикс ? (если в память)</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">DoNotPRFX</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SAVEPRFX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">26h</span><span class="sc0">     </span><span class="sc1">; И в stack frame</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc5">DoNotPRFX</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">           </span><span class="sc1">; КОП</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">       </span><span class="sc1">; ModeR/M байт</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">00111111b</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; код зеркальной команды</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc5">KeyF</span><span class="sc0"> </span><span class="sc1">; не добавлять ключ</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">DontAddKEY</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,[</span><span class="sc5">KEY_REG</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; + KEY_REG</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">       </span><span class="sc1">; This COP</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">       </span><span class="sc1">; COP в stack frame</span><span class="sc0">
</span><span class="sc5">DontAddKEY</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; добaвление памяти или TMP_REG'a</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc5">TMP_REG</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">PH_FLAGS</span><span class="sc4">],</span><span class="sc5">RMF</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">AddTMP</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc5">BASE_RM</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10111111b</span><span class="sc0">   </span><span class="sc1">; MODE = [mem+imm16]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">10111111b</span><span class="sc0">
</span><span class="sc5">AddTMP</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">          </span><span class="sc1">; COP's Done</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">dh</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">

        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">AddIMM8</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">BASE_TR</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; + мусор (как при загрузке байта)</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">   </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">   </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc5">AddIMM8</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc5">ImmF</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">CRCMD_DONE</span><span class="sc0">         </span><span class="sc1">; Immediate8  не надо</span><span class="sc0">

        </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">   </span><span class="sc1">; B stack frame</span><span class="sc0">
</span><span class="sc5">CRCMD_DONE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TRCHAIN</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">      </span><span class="sc1">; Следующую команду</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">MAKE_CRYPT_CMD</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">   </span><span class="sc1">; выход из stackframe в DECRYPTOR</span><span class="sc0">
</span><span class="sc5">OffsFARJump</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EncryptPart</span><span class="sc4">],</span><span class="sc8">sp</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">PH_FLAGS</span><span class="sc4">],</span><span class="sc5">RMF</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">DontMakeSaveCMD</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SAVEPRFX</span><span class="sc0">      </span><span class="sc1">; Сделаем команду сохранения байта -</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">      </span><span class="sc1">; возьмем команду загрузки и</span><span class="sc0">
</span><span class="sc5">LoadSaveCMD</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">         </span><span class="sc1">; сбросим Direction bit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11111101b</span><span class="sc0">

        </span><span class="sc6">stosd</span><span class="sc0">             </span><span class="sc1">; Done</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TRCHAIN</span><span class="sc0">
</span><span class="sc5">DontMakeSaveCMD</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">CryptExit</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ENCRYPT</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;-------------------</span><span class="sc0">
</span><span class="sc5">CHANGECNT</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DROPCOIN</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">second</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01000000b</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc5">BASE_REG</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ChangeEndCrypt</span><span class="sc0">
</span><span class="sc5">second</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1100000010000011b</span><span class="sc0">    </span><span class="sc1">; ADD/SUB BASE,imm8</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc5">BASE_REG</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DROPCOIN</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">met</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">IncDec</span><span class="sc4">],</span><span class="sc2">00001000b</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">00101000b</span><span class="sc0">
</span><span class="sc5">met</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TRCHAIN</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc5">IncDec</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">00101000b</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">IncDec</span><span class="sc4">],</span><span class="sc2">00001000b</span><span class="sc0">
</span><span class="sc5">ChangeEndCrypt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TRCHAIN</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">PH_FLAGS</span><span class="sc4">],</span><span class="sc5">CntF</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Limit_</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01001000b</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc5">CNT_REG</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">endchange</span><span class="sc0">
</span><span class="sc5">Limit_</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1111100010000001b</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc5">BASE_REG</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">DEST_CODE</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">PH_FLAGS</span><span class="sc4">],</span><span class="sc5">UcF</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">unk</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">unk</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">BASE_TR</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PHTEMP_CNT</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">COUNTER</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc5">endchange</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">CHANGECNT</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;-------------------</span><span class="sc0">
</span><span class="sc5">MAKEJNE</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">1234h</span><span class="sc0">
</span><span class="sc5">PH_LABEL</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">      </span><span class="sc1">; Не выходит ли за пределы 128 байт</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">REL8bit</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">850Fh</span><span class="sc0">    </span><span class="sc1">; JNE Rel16</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; и смещение</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">EndJNE</span><span class="sc0">
</span><span class="sc5">REL8bit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">75h</span><span class="sc0">      </span><span class="sc1">; сделаем короткий</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">EndJNE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TRCHAIN</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">MAKEJNE</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">PHANTOM</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc1">; Структура заполняемая для вызова PHANTOM</span><span class="sc0">
</span><span class="sc1">;    RELOFFS      - TARGETOFFS + RELOFFS = реальное место выполнения</span><span class="sc0">
</span><span class="sc1">;    DEST_CODE    - адрес криптуемого кода</span><span class="sc0">
</span><span class="sc1">;    COUNTER      - длинна кода</span><span class="sc0">
</span><span class="sc1">;    TARGETPLACE      - место для декриптора</span><span class="sc0">
</span><span class="sc1">;    LENDECRYPTOR     - длинна декриптора (генерится)</span><span class="sc0">

</span><span class="sc1">; Инициализация</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EXPHANTOM</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PH_FLAGS</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">     </span><span class="sc1">; Все флаги сброшены</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">INITFLAGS</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">HALF_USED</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">REG_USED</span><span class="sc4">],</span><span class="sc2">00010000b</span><span class="sc0">

        </span><span class="sc6">les</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc5">TARGETPLACE</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Куда будем генерить</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TRCHAIN</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">INITPHANTOM</span><span class="sc0"> </span><span class="sc1">; Part 1 - инициализация регистров</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ENCRYPT</span><span class="sc0">     </span><span class="sc1">; Part 2 - GEN EN/DEcryptionPart</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CHANGECNT</span><span class="sc0">   </span><span class="sc1">; Part 3 - изменение счетчиков</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MAKEJNE</span><span class="sc0">     </span><span class="sc1">; Part 4 - циклический переход</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ENDLOOP</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc1">; Для зашифровывания используется тот же декриптор -</span><span class="sc0">
        </span><span class="sc1">; DI - адрес для временного RETF</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; Только для версии 1.00 beta</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">PH_FLAGS</span><span class="sc4">],</span><span class="sc5">UcF</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">DONTADDOFFS</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DEST_CODE</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">      </span><span class="sc1">; делаем Relative DEST_CODE</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ADDREALPLACE</span><span class="sc0">
</span><span class="sc5">DONTADDOFFS</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TARGETPLACE</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LENDECRYPTOR</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">; Длинна декриптора</span><span class="sc0">

        </span><span class="sc6">sti</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">EXPHANTOM</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">PHANTOM</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;-------------------</span><span class="sc0">
</span><span class="sc5">JuNK_DOIT</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc1">; Зашифровка кода и удаление EncryptionPart</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EXJUNK</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">   </span><span class="sc1">; Сделаем временный возврат</span><span class="sc0">
</span><span class="sc5">ENDLOOP</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">0CBh</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">dh</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">CRYPTLAB</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                   </span><span class="sc1">; Сделаем jmp SS:EncryptChain</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">0EAh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc0">      </span><span class="sc1">; Сегмент стека</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">EncryptPart</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Смещение</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">TARGETPLACE</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">dh</span><span class="sc0">      </span><span class="sc1">; восстановим все что поменяли</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc5">RELOFFS</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Сделаем Реальное смещение</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ADDREALPLACE</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">StkFrm</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">EncryptPart</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
</span><span class="sc5">Move</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jcxz</span><span class="sc0">    </span><span class="sc5">EndMoveStk</span><span class="sc0">
        </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Move</span><span class="sc0">
</span><span class="sc5">EndMoveStk</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

        </span><span class="sc6">sti</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">EXJUNK</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">JuNK_DOIT</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;-------------------</span><span class="sc0">
</span><span class="sc5">ADDREALPLACE</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">PHTEMP_BASE</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">PH_FLAGS</span><span class="sc4">],</span><span class="sc5">CntF</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">NOTLIMIT</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">PHTEMP_CNT</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
</span><span class="sc5">NOTLIMIT</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ADDREALPLACE</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span></div></body>
</html>
