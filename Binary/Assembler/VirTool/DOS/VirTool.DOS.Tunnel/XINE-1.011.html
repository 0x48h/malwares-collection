<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>XINE-1.011</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;                                        /-----------------------------\
;                                        | Xine - issue #1 - Phile 011 |</span><span class="sc0">
</span><span class="sc1">;                                        \-----------------------------/</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Methyl [Immortal Riot/Genesis] proudly presents:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                 ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;                 ³               Tunneling               ³</span><span class="sc0">
</span><span class="sc1">;                 ³                 with                  ³</span><span class="sc0">
</span><span class="sc1">;                 ³            Single step mode           ³</span><span class="sc0">
</span><span class="sc1">;                 ³                                       ³</span><span class="sc0">
</span><span class="sc1">;                 ³            EXAMPLE PROGRAM            ³</span><span class="sc0">
</span><span class="sc1">;                 ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   So you can code a good tunneling routine now, but which one should you </span><span class="sc0">
</span><span class="sc1">;choose?  A good method of working out which handler you want to use is to </span><span class="sc0">
</span><span class="sc1">;first have a look at how each method performs on YOUR system, and then maybe</span><span class="sc0">
</span><span class="sc1">;on other systems if you have them available.  So as to save you unknown</span><span class="sc0">
</span><span class="sc1">;coding time, I have assembled all the methods you have learnt so far into</span><span class="sc0">
</span><span class="sc1">;this example program, which will simply show you the results of each type</span><span class="sc0">
</span><span class="sc1">;of tunneling method.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Please note there are no anti-anti-tunneling routines in here, as they are</span><span class="sc0">
</span><span class="sc1">;not really needed for an example program such as this.  Also note that this is</span><span class="sc0">
</span><span class="sc1">;NOT a virus, it is an EXAMPLE PROGRAM!  Almost all of the code in here, at</span><span class="sc0">
</span><span class="sc1">;least the major portions of the INT 1 handlers, was copied straight from</span><span class="sc0">
</span><span class="sc1">;my document, cut+paste style, just to prove the routines I provided you are</span><span class="sc0">
</span><span class="sc1">;ready to run without modification!</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">codesg</span><span class="sc0"> </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">para</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'code'</span><span class="sc0">
    </span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">codesg</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">codesg</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">codesg</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">codesg</span><span class="sc0">
    </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">0100h</span><span class="sc0">
</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">begin</span><span class="sc0">
    </span><span class="sc5">orig_1</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">return_address</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">m_startup</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Methyl''s example interrupt tunneler$'</span><span class="sc0">
    </span><span class="sc5">m_segment_o_13</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'SEGMENT CHECK, int 13, BIOS method    - $'</span><span class="sc0">
    </span><span class="sc5">m_segment_n_13</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'SEGMENT CHECK, int 13, IO method      - $'</span><span class="sc0">
    </span><span class="sc5">m_segment_21</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'SEGMENT CHECK, int 21                 - $'</span><span class="sc0">
    </span><span class="sc5">m_hand_o_13</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'HAND METHOD, int 13, BIOS method      - $'</span><span class="sc0">
    </span><span class="sc5">m_hand_n_13</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'HAND METHOD, int 13, IO  method       - $'</span><span class="sc0">
    </span><span class="sc5">m_hand_21</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'HAND METHOD, int 21                   - $'</span><span class="sc0">
    </span><span class="sc5">m_opcode_13</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'OPCODE CHECK, int 13                  - $'</span><span class="sc0">
    </span><span class="sc5">m_opcode_21</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'OPCODE CHECK, int 21                  - $'</span><span class="sc0">
    </span><span class="sc5">m_list_13</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'CS:LIST METHOD, int 13                - $'</span><span class="sc0">
    </span><span class="sc5">m_list_21</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'CS:LIST METHOD, int 21                - $'</span><span class="sc0">
    </span><span class="sc5">m_iret_13</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'IRET CHECK, int 13                    - $'</span><span class="sc0">
    </span><span class="sc5">m_iret_21</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'IRET CHECK, int 21                    - $'</span><span class="sc0">
    </span><span class="sc5">m_desq</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'DESQView detected, exitting'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'$'</span><span class="sc0">
    </span><span class="sc5">m_end</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'End of example program'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'$'</span><span class="sc0">
</span><span class="sc5">begin</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">m_startup</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">                    </span><span class="sc1">; Show startup message</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03501h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">orig_1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">orig_1</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">; Save original INT 1 handler</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02b01h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'DE'</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'SQ'</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">desqview_not_here</span><span class="sc0">        </span><span class="sc1">; Exit if DESQView found</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">m_desq</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04c01h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">

</span><span class="sc5">desqview_not_here</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">m_segment_o_13</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">segment_o_13</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">show_int_address</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">m_segment_n_13</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">segment_n_13</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">show_int_address</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">m_segment_21</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">segment_21</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">show_int_address</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">m_hand_o_13</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">hand_o_13</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">show_int_address</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">m_hand_n_13</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">hand_n_13</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">show_int_address</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">m_hand_21</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">hand_21</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">show_int_address</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">m_opcode_13</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">opcode_13</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">show_int_address</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">m_opcode_21</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">opcode_21</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">show_int_address</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">m_list_13</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">list_13</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">show_int_address</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">m_list_21</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">list_21</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">show_int_address</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">m_iret_13</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">iret_13</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">show_int_address</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">m_iret_21</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">iret_21</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">show_int_address</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">m_end</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">                    </span><span class="sc1">; Show exit message</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">cli</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">orig_1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">orig_1</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">sti</span><span class="sc0">                         </span><span class="sc1">; Reset original interrupt 1 address</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04c00h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">
</span><span class="sc5">begin</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">segment_o_13</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">cli</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">segment_handler</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">sti</span><span class="sc0">                         </span><span class="sc1">; redirect INT 1 to our routine</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">return_address</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">return_address</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; Clear return address</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">segment_status</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">segment_type</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                                </span><span class="sc1">; Set us up to start tunneling</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; Point DS to IVT</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">popf</span><span class="sc0">                        </span><span class="sc1">; Set TF</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">far</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[(</span><span class="sc2">013h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">     </span><span class="sc1">; Simulate interrupt call</span><span class="sc0">
    
    </span><span class="sc6">popf</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; Restore our DS</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">segment_o_13</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">segment_n_13</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">cli</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">segment_handler</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">sti</span><span class="sc0">                         </span><span class="sc1">; redirect INT 1 to our routine</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">return_address</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">return_address</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; Clear return address</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">segment_status</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">segment_type</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                                </span><span class="sc1">; Set us up to start tunneling</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; Point DS to IVT</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">popf</span><span class="sc0">                        </span><span class="sc1">; Set TF</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">far</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[(</span><span class="sc2">013h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">     </span><span class="sc1">; Simulate interrupt call</span><span class="sc0">
    
    </span><span class="sc6">popf</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; Restore our DS</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">segment_n_13</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">segment_21</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">cli</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">segment_handler</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">sti</span><span class="sc0">                         </span><span class="sc1">; redirect INT 1 to our routine</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">030h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">                    </span><span class="sc1">; DOS version check</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">alternative_segment</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">052h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">first_mcb</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">; Setup first MCB address</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">segment_done</span><span class="sc0">
</span><span class="sc5">alternative_segment</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">first_mcb</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0300h</span><span class="sc0">
</span><span class="sc5">segment_done</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">return_address</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">return_address</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; Clear return address</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">segment_status</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">segment_type</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc1">; Set us up to start tunneling</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; Point DS to IVT</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">popf</span><span class="sc0">                        </span><span class="sc1">; Set TF</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">052h</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">far</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[(</span><span class="sc2">021h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">     </span><span class="sc1">; Simulate interrupt call</span><span class="sc0">
    
    </span><span class="sc6">popf</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; Restore our DS</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">segment_21</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">hand_o_13</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">cli</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">hand_handler</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">sti</span><span class="sc0">                         </span><span class="sc1">; redirect INT 1 to our routine</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">return_address</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">return_address</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; Clear return address</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hand_segment</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hand_type</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                                </span><span class="sc1">; Set us up to start tunneling</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; Point DS to IVT</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">popf</span><span class="sc0">                        </span><span class="sc1">; Set TF</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">far</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[(</span><span class="sc2">013h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">     </span><span class="sc1">; Simulate interrupt call</span><span class="sc0">
    
    </span><span class="sc6">popf</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; Restore our DS</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">hand_o_13</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">hand_n_13</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">cli</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">hand_handler</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">sti</span><span class="sc0">                         </span><span class="sc1">; redirect INT 1 to our routine</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">return_address</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">return_address</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; Clear return address</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hand_segment</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hand_type</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc1">; Set us up to start tunneling</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; Point DS to IVT</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">popf</span><span class="sc0">                        </span><span class="sc1">; Set TF</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">far</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[(</span><span class="sc2">013h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">     </span><span class="sc1">; Simulate interrupt call</span><span class="sc0">
    
    </span><span class="sc6">popf</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; Restore our DS</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">hand_n_13</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">hand_21</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">cli</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">hand_handler</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">sti</span><span class="sc0">                         </span><span class="sc1">; redirect INT 1 to our routine</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">return_address</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">return_address</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; Clear return address</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hand_segment</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hand_type</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc1">; Set us up to start tunneling</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; Point DS to IVT</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">popf</span><span class="sc0">                        </span><span class="sc1">; Set TF</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">052h</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">far</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[(</span><span class="sc2">021h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">     </span><span class="sc1">; Simulate interrupt call</span><span class="sc0">
    
    </span><span class="sc6">popf</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; Restore our DS</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">hand_21</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">opcode_13</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">cli</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">opcode_handler</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">sti</span><span class="sc0">                         </span><span class="sc1">; redirect INT 1 to our routine</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">return_address</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">return_address</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; Clear return address</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; Point DS to IVT</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">popf</span><span class="sc0">                        </span><span class="sc1">; Set TF</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">far</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[(</span><span class="sc2">013h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">     </span><span class="sc1">; Simulate interrupt call</span><span class="sc0">
    
    </span><span class="sc6">popf</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; Restore our DS</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">opcode_13</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">opcode_21</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">cli</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">opcode_handler</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">sti</span><span class="sc0">                         </span><span class="sc1">; redirect INT 1 to our routine</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">return_address</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">return_address</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; Clear return address</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; Point DS to IVT</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">popf</span><span class="sc0">                        </span><span class="sc1">; Set TF</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">052h</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">far</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[(</span><span class="sc2">021h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">     </span><span class="sc1">; Simulate interrupt call</span><span class="sc0">
    
    </span><span class="sc6">popf</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; Restore our DS</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">opcode_21</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">list_13</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">cli</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">list_handler</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">sti</span><span class="sc0">                         </span><span class="sc1">; redirect INT 1 to our routine</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">return_address</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">return_address</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; Clear return address</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">list_begin</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">zero_loop_13</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">list_end</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">zero_loop_13</span><span class="sc0">            </span><span class="sc1">; Zero out list</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">list_begin</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">        

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; Point DS to IVT</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">popf</span><span class="sc0">                        </span><span class="sc1">; Set TF</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">far</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[(</span><span class="sc2">013h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">     </span><span class="sc1">; Simulate interrupt call</span><span class="sc0">
    
    </span><span class="sc6">popf</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; Restore our DS</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">list_13</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">list_21</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">cli</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">list_handler</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">sti</span><span class="sc0">                         </span><span class="sc1">; redirect INT 1 to our routine</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">return_address</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">return_address</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; Clear return address</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">list_begin</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">zero_loop_21</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">list_end</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">zero_loop_21</span><span class="sc0">            </span><span class="sc1">; Zero out list</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">list_begin</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">        

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; Point DS to IVT</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">popf</span><span class="sc0">                        </span><span class="sc1">; Set TF</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">052h</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">far</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[(</span><span class="sc2">021h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">     </span><span class="sc1">; Simulate interrupt call</span><span class="sc0">
    
    </span><span class="sc6">popf</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; Restore our DS</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">list_21</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">iret_13</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">cli</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">iret_handler</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">sti</span><span class="sc0">                         </span><span class="sc1">; redirect INT 1 to our routine</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">return_address</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">return_address</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; Clear return address</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">iret_status</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                                </span><span class="sc1">; Set us up to start tunneling</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; Point DS to IVT</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">popf</span><span class="sc0">                        </span><span class="sc1">; Set TF</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">far</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[(</span><span class="sc2">013h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">     </span><span class="sc1">; Simulate interrupt call</span><span class="sc0">
    
    </span><span class="sc6">popf</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; Restore our DS</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">iret_13</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">iret_21</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">cli</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">iret_handler</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">sti</span><span class="sc0">                         </span><span class="sc1">; redirect INT 1 to our routine</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">052h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">first_mcb</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">; Setup first MCB address</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">return_address</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">return_address</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; Clear return address</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">iret_status</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                                </span><span class="sc1">; Set us up to start tunneling</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; Point DS to IVT</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">popf</span><span class="sc0">                        </span><span class="sc1">; Set TF</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">052h</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">far</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[(</span><span class="sc2">021h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">     </span><span class="sc1">; Simulate interrupt call</span><span class="sc0">
    
    </span><span class="sc6">popf</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; Restore our DS</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">iret_21</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; Start of INT 1 handler using SEGMENT CHECK method</span><span class="sc0">
    </span><span class="sc5">first_mcb</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">segment_status</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">segment_type</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">             </span><span class="sc1">; 0=DOS KERNEL scan</span><span class="sc0">
                                    </span><span class="sc1">; 1=IO KERNEL scan</span><span class="sc0">
                                    </span><span class="sc1">; 2=ROM BIOS scan</span><span class="sc0">
</span><span class="sc5">segment_handler</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">far</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">segment_status</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">segment_exit</span><span class="sc0">                 </span><span class="sc1">; exit if we've finished tunneling already    </span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">; get CS:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">segment_type</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">segment_io_scan</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">segment_type</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">segment_bios_scan</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">first_mcb</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">segment_found</span><span class="sc0">                </span><span class="sc1">; check CS: is in DOS kernel</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">segment_exit</span><span class="sc0">
</span><span class="sc5">segment_io_scan</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">070h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">segment_found</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">segment_exit</span><span class="sc0">                </span><span class="sc1">; check CS: is in IO kernel</span><span class="sc0">
</span><span class="sc5">segment_bios_scan</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c800h</span><span class="sc0">                  </span><span class="sc1">; check for XT bios</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">segment_found</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0f000h</span><span class="sc0">                  </span><span class="sc1">; check for XT+ bios</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">segment_found</span><span class="sc0">
</span><span class="sc5">segment_exit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
    </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc5">segment_found</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">return_address</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">return_address</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">; save CS:IP</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">segment_status</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; indicate to stop tunneling</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">segment_exit</span><span class="sc0">
</span><span class="sc5">segment_handler</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">; End of INT 1 handler using SEGMENT CHECK method</span><span class="sc0">
</span><span class="sc1">; Start of INT 1 handler using OPCODE CHECK method</span><span class="sc0">
</span><span class="sc5">_override</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">; used to store current override</span><span class="sc0">
</span><span class="sc5">_cs</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">; CS of instruction being executed, needed</span><span class="sc0">
                                    </span><span class="sc1">; to simplify override usage</span><span class="sc0">
</span><span class="sc5">_ds</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">; DS before we modified it, needed to </span><span class="sc0">
                                    </span><span class="sc1">; simplify override usage</span><span class="sc0">

</span><span class="sc5">opcode_handler</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">far</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                         </span><span class="sc1">; save registers</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">_cs</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                </span><span class="sc1">; save CS</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">_ds</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                </span><span class="sc1">; save DS</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">_override</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; setup override as default</span><span class="sc0">
    </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">; get address of instruction into DS:SI</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">read_opcode</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">026h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">es_override</span><span class="sc0">                  </span><span class="sc1">; use ES override</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">036h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">ss_override</span><span class="sc0">                  </span><span class="sc1">; use SS override</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02eh</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">cs_override</span><span class="sc0">                  </span><span class="sc1">; use CS override</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03eh</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">ds_override</span><span class="sc0">                  </span><span class="sc1">; use DS override</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0eah</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">immediate</span><span class="sc0">                    </span><span class="sc1">; jmp far off:seg</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02effh</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">variable</span><span class="sc0">                     </span><span class="sc1">; jmp far [variable]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">09ah</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">immediate</span><span class="sc0">                    </span><span class="sc1">; call far off:seg</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01effh</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">variable</span><span class="sc0">                     </span><span class="sc1">; call far [variable]</span><span class="sc0">

</span><span class="sc5">opcode_exit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
    </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">immediate</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">return_address</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">return_address</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">; save address of area we're going into</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">opcode_exit</span><span class="sc0">

</span><span class="sc5">variable</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">_override</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">immediate</span><span class="sc0">                   </span><span class="sc1">; extract off:seg</span><span class="sc0">

</span><span class="sc5">ds_override</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">_ds</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">_override</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">read_opcode</span><span class="sc0">
</span><span class="sc5">cs_override</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">_cs</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">_override</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">read_opcode</span><span class="sc0">
</span><span class="sc5">es_override</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">_override</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">read_opcode</span><span class="sc0">
</span><span class="sc5">ss_override</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">_override</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">read_opcode</span><span class="sc0">    
</span><span class="sc5">opcode_handler</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">; End of INT 1 handler using OPCODE CHECK method</span><span class="sc0">
</span><span class="sc1">; Start of INT 1 handler using CS:LIST method</span><span class="sc0">
</span><span class="sc5">list_begin</span><span class="sc4">:</span><span class="sc0"> 
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">015h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">list_end</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">list_handler</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">far</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">list_begin</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">list_traverse</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">list_end</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">list_error</span><span class="sc0">                   </span><span class="sc1">; this is a check to make sure the </span><span class="sc0">
                                    </span><span class="sc1">; list of CS: values doesn't outgrow</span><span class="sc0">
                                    </span><span class="sc1">; the space allocated for them</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">list_exit</span><span class="sc0">                    </span><span class="sc1">; this is if the CS: is already on the </span><span class="sc0">
                                    </span><span class="sc1">; list</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">list_insert</span><span class="sc0">                  </span><span class="sc1">; add us to the list if we've reached the</span><span class="sc0">
                                    </span><span class="sc1">; end of defined values</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">list_traverse</span><span class="sc0">               </span><span class="sc1">; this moves down to the next item on </span><span class="sc0">
                                    </span><span class="sc1">; the CS: list</span><span class="sc0">
</span><span class="sc5">list_insert</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                 </span><span class="sc1">; put us on the list</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">return_address</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">return_address</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">; save CS:IP value</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">list_exit</span><span class="sc0">

</span><span class="sc5">list_error</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">return_address</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">return_address</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; set error indicator</span><span class="sc0">

</span><span class="sc5">list_exit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
    </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc5">list_handler</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">; End of INT 1 handler using CS:LIST method</span><span class="sc0">
</span><span class="sc1">; Start of INT 1 handler using HAND-over-HAND method</span><span class="sc0">
</span><span class="sc5">hand_segment</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">; Where we save our CS: values</span><span class="sc0">
</span><span class="sc5">hand_type</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">; 0=Go down</span><span class="sc0">
                                    </span><span class="sc1">; 1=Go up</span><span class="sc0">
</span><span class="sc5">hand_handler</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">far</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">hand_type</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">go_up</span><span class="sc0">
</span><span class="sc5">go_down</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">hand_segment</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">hand_over_hand</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">hand_exit</span><span class="sc0">
</span><span class="sc5">go_up</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">hand_segment</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">hand_over_hand</span><span class="sc0">           
</span><span class="sc5">hand_exit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
    </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc5">hand_over_hand</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">return_address</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">hand_segment</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">return_address</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">; save CS:IP</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">hand_exit</span><span class="sc0">
</span><span class="sc5">hand_handler</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">; End of INT 1 handler using HAND-over-HAND method</span><span class="sc0">
</span><span class="sc1">; Start of INT 1 handler using IRET method</span><span class="sc0">
</span><span class="sc5">iret_status</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">iret_handler</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">far</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">iret_status</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">iret_exit</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">return_address</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">iret_save</span><span class="sc0">
    </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0cfh</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">iret_exit_detected</span><span class="sc0">
</span><span class="sc5">iret_exit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
    </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc5">iret_save</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">return_address</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">return_address</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">; save CS:IP</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">iret_exit</span><span class="sc0">
</span><span class="sc5">iret_exit_detected</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">iret_status</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">iret_exit</span><span class="sc0">
</span><span class="sc5">iret_handler</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">; End of INT 1 handler using IRET method</span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">show_int_address</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">      </span><span class="sc1">; displays return_address</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">return_address</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">show_hex</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">show_colon</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">return_address</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">show_hex</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">    
</span><span class="sc5">show_int_address</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">show_colon</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">            </span><span class="sc1">; displays a colon on screen</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">':'</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">show_colon</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">show_hex</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">              </span><span class="sc1">; displays a HEX number on screen</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">rotate</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0fh</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">030h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'9'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jl</span><span class="sc0"> </span><span class="sc5">print_it</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07h</span><span class="sc0">
</span><span class="sc5">print_it</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">rotate</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">show_hex</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">codesg</span><span class="sc0"> </span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">

</span></div></body>
</html>
