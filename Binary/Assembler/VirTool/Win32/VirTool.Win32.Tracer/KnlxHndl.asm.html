<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;this is disassembly of system xHandler (kernel32.dll)</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBP</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EBP</span><span class="sc4">,</span><span class="sc8">ESP</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">ESP</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBP</span><span class="sc0">
        </span><span class="sc6">CLD</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc2">0CH</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; xFrame (exception_registration)</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; EXCEPTION_REC_ptr</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">6</span><span class="sc0">    </span><span class="sc1">; EXCEPTION_RECORD.ExceptionFlags</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0"> </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">LOC_5</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc2">10H</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; CONTEXT_ptr</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">+</span><span class="sc2">0CH</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; xFrame.xScope</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; xFrame.xTable</span><span class="sc0">
</span><span class="sc5">LOC_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc2">0FFFFFFFFH</span><span class="sc0">         </span><span class="sc1">; if xScope == -1 ; -1..end of xTables chain</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">LOC_4</span><span class="sc0">        </span><span class="sc1">; goto Unhandled</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,[</span><span class="sc8">ESI</span><span class="sc4">][</span><span class="sc8">ESI</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; size of xTable structure 12 bytes</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">][</span><span class="sc8">ECX</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; if xTableArray[xScope].filter == 0  ;not present</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">LOC_2</span><span class="sc0">        </span><span class="sc1">; goto next xTable_RECORD</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBP</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EBP</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">+</span><span class="sc2">10H</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">][</span><span class="sc8">ECX</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; call xTableArray[xScope].filter</span><span class="sc0">
            </span><span class="sc1">; it will call UnhandledExceptionFilter and from that is called</span><span class="sc0">
                </span><span class="sc1">; procedure ("top-level exception filter function") that was </span><span class="sc0">
                </span><span class="sc1">; specified as parameter of SetUnhandledExceptionFilter </span><span class="sc0">
                </span><span class="sc1">; (procedure should RETURN! - for authors of PECRYPT32)</span><span class="sc0">

        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EBP</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc2">0CH</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; xFrame</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">            </span><span class="sc1">; return code is</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">  </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">LOC_2</span><span class="sc0">        </span><span class="sc1">; == 0 do next xTable_RECORD</span><span class="sc0">
        </span><span class="sc6">JS</span><span class="sc0">  </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">LOC_3</span><span class="sc0">        </span><span class="sc1">; &lt;  0 do return (0)</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; xFrame.xTable</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">            </span><span class="sc1">; xFrame</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">XXXXX</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">ESP</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EBP</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">+</span><span class="sc2">10H</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">            </span><span class="sc1">; xScope</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">YYYYY</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">ESP</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">

        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,[</span><span class="sc8">ESI</span><span class="sc4">][</span><span class="sc8">ESI</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc8">EDI</span><span class="sc4">][</span><span class="sc8">ECX</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">+</span><span class="sc2">0CH</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">    </span><span class="sc1">; xScope = xTableArray[xScope].NextxScope</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">][</span><span class="sc8">ECX</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; call xTableArray[xScope].handler</span><span class="sc0">
                           </span><span class="sc1">; it will call ExitProcess or ExitThread</span><span class="sc0">

</span><span class="sc5">LOC_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; do next xTable_RECORD in xTableArray</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,[</span><span class="sc8">ESI</span><span class="sc4">][</span><span class="sc8">ESI</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,[</span><span class="sc8">EDI</span><span class="sc4">][</span><span class="sc8">ECX</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; esi = xTable.NextxScope</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">LOC_1</span><span class="sc0">
</span><span class="sc5">LOC_3</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">; Okay</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">LOC_6</span><span class="sc0">
</span><span class="sc5">LOC_4</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">              </span><span class="sc1">; unhandled, do next xFrame</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">LOC_6</span><span class="sc0">
</span><span class="sc5">LOC_5</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBP</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EBP</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">+</span><span class="sc2">10H</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">0FFFFFFFFH</span><span class="sc0">         </span><span class="sc1">; xScope</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">YYYYY</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">ESP</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EBP</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">              </span><span class="sc1">; unhandled, do next xFrame</span><span class="sc0">
</span><span class="sc5">LOC_6</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EBP</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ESP</span><span class="sc4">,</span><span class="sc8">EBP</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EBP</span><span class="sc0">
        </span><span class="sc6">RETN</span><span class="sc0">

</span></div></body>
</html>
