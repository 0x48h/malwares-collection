<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>R0RES.BAT</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc14 {
	font-weight: bold;
	color: #804000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;@GOTO -)</span><span class="sc0">
</span><span class="sc2">.586P</span><span class="sc0">
</span><span class="sc9">.MODEL</span><span class="sc0"> </span><span class="sc10">FLAT</span><span class="sc0">
</span><span class="sc5">UNICODE</span><span class="sc4">=</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">NT4</span><span class="sc4">=</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">NT5</span><span class="sc4">=</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">OSVER</span><span class="sc4">=</span><span class="sc5">NT5</span><span class="sc0">                 </span><span class="sc1">; Версия операционной системы в вашем случае ...</span><span class="sc0">
</span><span class="sc9">INCLUDE</span><span class="sc0"> </span><span class="sc5">WINDOWS.inc</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">INCLUDE</span><span class="sc0"> </span><span class="sc5">APIMACRO.mac</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">INCLUDE</span><span class="sc0"> </span><span class="sc5">NtStruc.inc</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">INCLUDE</span><span class="sc0"> </span><span class="sc5">Secrty.inc</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">INCLUDELIB</span><span class="sc0"> </span><span class="sc5">iKERNEL32.lib</span><span class="sc0">  </span><span class="sc1">; Если с этим возникнет проблемка </span><span class="sc0">
              </span><span class="sc1">; см. здесь http://members.nbci.com/_XMCM/elicz/infos/EliASM2.zip</span><span class="sc0">

  </span><span class="sc5">xDT</span><span class="sc0">         </span><span class="sc9">STRUC</span><span class="sc0">       </span><span class="sc1">; Структура описывает GDTR &amp; IDTR</span><span class="sc0">
   </span><span class="sc5">Limit</span><span class="sc0">      </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc5">Base</span><span class="sc0">       </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
  </span><span class="sc5">xDT</span><span class="sc0">         </span><span class="sc9">ENDS</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">

  </span><span class="sc5">R0CSNT</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">08H</span><span class="sc0">        </span><span class="sc1">; Кодовый дескриптор НТ-ки для ring0</span><span class="sc0">

</span><span class="sc9">.DATA?</span><span class="sc0">
   </span><span class="sc5">GetSecurityInfo</span><span class="sc0">  </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> </span><span class="sc1">; Процедурки с  ADVAPI32.dll</span><span class="sc0">
   </span><span class="sc5">SetEntriesInAcl</span><span class="sc0">  </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc5">SetSecurityInfo</span><span class="sc0">  </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

   </span><span class="sc5">hSection</span><span class="sc0">   </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; Handle секции</span><span class="sc0">
   </span><span class="sc5">phSection</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">   </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">hSection</span><span class="sc0"> </span><span class="sc1">; Указатель на этот Handle секции</span><span class="sc0">

   </span><span class="sc5">SectionGDT</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; Здесь мы храним секцию с GDT</span><span class="sc0">
   </span><span class="sc5">SectionIDT</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; a здесь с  IDT</span><span class="sc0">

   </span><span class="sc5">GDTstart</span><span class="sc0">   </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">GDTend</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">ReturnEIP</span><span class="sc0">  </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">OrigDesc</span><span class="sc0">   </span><span class="sc10">QWORD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
               </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

   </span><span class="sc5">GDT</span><span class="sc0">        </span><span class="sc5">xDT</span><span class="sc0">   </span><span class="sc4">&lt;&gt;</span><span class="sc0">
   </span><span class="sc5">IDT</span><span class="sc0">        </span><span class="sc5">xDT</span><span class="sc0">   </span><span class="sc4">&lt;&gt;</span><span class="sc0">

</span><span class="sc9">.CODE</span><span class="sc0">

</span><span class="sc1">; Объект который используется для открытия секции</span><span class="sc0">
</span><span class="sc5">oa</span><span class="sc0"> </span><span class="sc5">OBJECT_ATTRIBUTES</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc0">                  \
                      </span><span class="sc5">OBJECT_ATTRIBUTES</span><span class="sc4">,</span><span class="sc0">\  </span><span class="sc1">;Length_</span><span class="sc0">
                                      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0">\  </span><span class="sc1">;RootDirectory</span><span class="sc0">
                                </span><span class="sc5">PhMemUS</span><span class="sc4">,</span><span class="sc0">\  </span><span class="sc1">;ObjectName</span><span class="sc0">
                   </span><span class="sc5">OBJ_CASE_INSENSITIVE</span><span class="sc4">,</span><span class="sc0">\  </span><span class="sc1">;Attributes</span><span class="sc0">
                                   </span><span class="sc5">NULL</span><span class="sc4">,</span><span class="sc0">\  </span><span class="sc1">;SecurityDescriptor</span><span class="sc0">
                                   </span><span class="sc5">NULL</span><span class="sc0"> \  </span><span class="sc1">;SecurityQualityOfService</span><span class="sc0">
              </span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">poa</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">oa</span><span class="sc0">                          </span><span class="sc1">; Pointer to oa</span><span class="sc0">


</span><span class="sc5">PhMemUS</span><span class="sc0"> </span><span class="sc5">UNICODE_STRING</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc0">                \
                          </span><span class="sc5">LzPhMem</span><span class="sc4">*</span><span class="sc5">WCHAR</span><span class="sc4">,\
</span><span class="sc0">              </span><span class="sc5">LzPhMem</span><span class="sc4">*</span><span class="sc5">WCHAR</span><span class="sc4">,</span><span class="sc0">\ 
                </span><span class="sc5">szPhMem</span><span class="sc0"> \
            </span><span class="sc4">&gt;</span><span class="sc0">

</span><span class="sc1">; Стуктура описывает доступ к объектам</span><span class="sc0">
</span><span class="sc5">ExplicitAccess</span><span class="sc0">  </span><span class="sc5">EXPLICIT_ACCESS</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc0"> </span><span class="sc5">SECTION_MAP_WRITE</span><span class="sc4">,</span><span class="sc0">\ 
                                     </span><span class="sc5">GRANT_ACCESS</span><span class="sc4">,\
</span><span class="sc0">                                   </span><span class="sc5">NO_INHERITANCE</span><span class="sc4">,\
</span><span class="sc0">                                     </span><span class="sc4">&lt;</span><span class="sc5">NULL</span><span class="sc4">,\
</span><span class="sc0">                                   </span><span class="sc5">NO_MULTIPLE_TRUSTEE</span><span class="sc4">,</span><span class="sc0">\ 
                                       </span><span class="sc5">TRUSTEE_IS_NAME</span><span class="sc4">,\
</span><span class="sc0">                                       </span><span class="sc5">TRUSTEE_IS_USER</span><span class="sc4">,</span><span class="sc0">\ 
                                              </span><span class="sc5">ststName</span><span class="sc0"> \
                    </span><span class="sc4">&gt;\
</span><span class="sc0">                                  </span><span class="sc4">&gt;</span><span class="sc0">

   </span><span class="sc5">TEXTW</span><span class="sc0">    </span><span class="sc5">zPhMem</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc0">\</span><span class="sc5">Device</span><span class="sc0">\</span><span class="sc5">PhysicalMemory</span><span class="sc4">&gt;</span><span class="sc0">

   </span><span class="sc5">TEXT</span><span class="sc0">     </span><span class="sc5">tstName</span><span class="sc4">,&lt;</span><span class="sc5">CURRENT_USER</span><span class="sc4">/</span><span class="sc2">0</span><span class="sc4">&gt;</span><span class="sc0">

   </span><span class="sc5">pExplicitAccess</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">ExplicitAccess</span><span class="sc0">

   </span><span class="sc5">TEXT</span><span class="sc0">     </span><span class="sc5">zADVAPI32</span><span class="sc4">,</span><span class="sc0">        </span><span class="sc4">&lt;</span><span class="sc5">ADVAPI32.dll</span><span class="sc4">/</span><span class="sc2">0</span><span class="sc4">&gt;</span><span class="sc0">
   </span><span class="sc5">TEXTA</span><span class="sc0">    </span><span class="sc5">zGetSecurityInfo</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GetSecurityInfo</span><span class="sc4">/</span><span class="sc2">0</span><span class="sc4">&gt;</span><span class="sc0">
   </span><span class="sc5">TEXTA</span><span class="sc0">    </span><span class="sc5">zSetEntriesInAcl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">SetEntriesInAclA</span><span class="sc4">/</span><span class="sc2">0</span><span class="sc4">&gt;</span><span class="sc0">
   </span><span class="sc5">TEXTA</span><span class="sc0">    </span><span class="sc5">zSetSecurityInfo</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">SetSecurityInfo</span><span class="sc4">/</span><span class="sc2">0</span><span class="sc4">&gt;</span><span class="sc0">

   </span><span class="sc5">TEXT</span><span class="sc0">     </span><span class="sc5">zNTDLL</span><span class="sc4">,</span><span class="sc0">           </span><span class="sc4">&lt;</span><span class="sc5">NTDLL.dll</span><span class="sc4">/</span><span class="sc2">0</span><span class="sc4">&gt;</span><span class="sc0">
   </span><span class="sc5">TEXTA</span><span class="sc0">    </span><span class="sc5">zNtOpenSection</span><span class="sc4">,</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc5">NtOpenSection</span><span class="sc4">/</span><span class="sc2">0</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------------</span><span class="sc0">
  </span><span class="sc5">xHandler</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc6">MOV</span><span class="sc0">      </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">MOV</span><span class="sc0">      </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">ADD</span><span class="sc0">      </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CONTEXT.regEip</span><span class="sc0">
   </span><span class="sc6">SUB</span><span class="sc0">      </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
   </span><span class="sc6">MOV</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">ECX</span><span class="sc4">][</span><span class="sc5">CONTEXT.regEip</span><span class="sc4">-</span><span class="sc5">CONTEXT.regEip</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">xExit</span><span class="sc0">
   </span><span class="sc6">MOV</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">ECX</span><span class="sc4">][</span><span class="sc5">CONTEXT.regEsp</span><span class="sc4">-</span><span class="sc5">CONTEXT.regEip</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
   </span><span class="sc6">RET</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------------------------------------------------</span><span class="sc0">
 </span><span class="sc5">SetSectionSecurity</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0"> </span><span class="sc10">USES</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">
   </span><span class="sc9">LOCAL</span><span class="sc0">    </span><span class="sc5">pDacl</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
   </span><span class="sc9">LOCAL</span><span class="sc0">    </span><span class="sc5">pSD</span><span class="sc0">   </span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">

   </span><span class="sc6">SUB</span><span class="sc0">      </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">
   </span><span class="sc6">LEA</span><span class="sc0">      </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pDacl</span><span class="sc0">
   </span><span class="sc6">LEA</span><span class="sc0">      </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pSD</span><span class="sc0">

   </span><span class="sc6">PUSH</span><span class="sc0">     </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">;assume non ERROR_SUCCESS result</span><span class="sc0">

   </span><span class="sc5">sWin32</span><span class="sc0">   </span><span class="sc5">GetSecurityInfo</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">hSection</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SE_KERNEL_OBJECT</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">DACL_SECURITY_INFORMATION</span><span class="sc4">,\
</span><span class="sc0">                             </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">
   </span><span class="sc6">TEST</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
   </span><span class="sc6">MOV</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
   </span><span class="sc6">JNE</span><span class="sc0">      </span><span class="sc5">CantOpen</span><span class="sc0">
  
   </span><span class="sc6">PUSH</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">
   </span><span class="sc5">sWin32</span><span class="sc0">   </span><span class="sc5">SetEntriesInAcl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pExplicitAccess</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pDacl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ESP</span><span class="sc0">
   </span><span class="sc6">POP</span><span class="sc0">      </span><span class="sc8">ESI</span><span class="sc0">
   </span><span class="sc6">TEST</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
   </span><span class="sc6">MOV</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
   </span><span class="sc6">JNE</span><span class="sc0">      </span><span class="sc5">CantSet</span><span class="sc0">

   </span><span class="sc5">sWin32</span><span class="sc0">   </span><span class="sc5">SetSecurityInfo</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">hSection</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SE_KERNEL_OBJECT</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">DACL_SECURITY_INFORMATION</span><span class="sc4">,\
</span><span class="sc0">                             </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">
   </span><span class="sc6">MOV</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
   </span><span class="sc5">iWin32</span><span class="sc0">   </span><span class="sc5">LocalFree</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
  </span><span class="sc5">CantSet</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc5">iWin32</span><span class="sc0">   </span><span class="sc5">LocalFree</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc0">
  </span><span class="sc5">CantOpen</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc6">POP</span><span class="sc0">      </span><span class="sc8">EAX</span><span class="sc0">
   </span><span class="sc6">RET</span><span class="sc0">
 </span><span class="sc5">SetSectionSecurity</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------------------------</span><span class="sc0">
 </span><span class="sc5">QuasiMmGetPhysicalAddress</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0"> </span><span class="sc5">VirtualAddress</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">mSize</span><span class="sc0">
   </span><span class="sc6">MOV</span><span class="sc0">      </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VirtualAddress</span><span class="sc0">
   </span><span class="sc6">MOV</span><span class="sc0">      </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
   </span><span class="sc6">AND</span><span class="sc0">      </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000000FFFH</span><span class="sc0">    </span><span class="sc1">;offset</span><span class="sc0">
   </span><span class="sc6">CMP</span><span class="sc0">      </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">080000000H</span><span class="sc0">
   </span><span class="sc6">JB</span><span class="sc0">       </span><span class="sc5">CantGetPhysical</span><span class="sc0">
   </span><span class="sc6">MOV</span><span class="sc0">      </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">mSize</span><span class="sc0">
   </span><span class="sc6">ADD</span><span class="sc0">      </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
   </span><span class="sc6">CMP</span><span class="sc0">      </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A0000000H</span><span class="sc0">
   </span><span class="sc6">JAE</span><span class="sc0">      </span><span class="sc5">CantGetPhysical</span><span class="sc0">
   </span><span class="sc6">CMP</span><span class="sc0">      </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VirtualAddress</span><span class="sc0">
   </span><span class="sc6">JB</span><span class="sc0">       </span><span class="sc5">CantGetPhysical</span><span class="sc0">
   </span><span class="sc6">AND</span><span class="sc0">      </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01FFFF000H</span><span class="sc0">   </span><span class="sc1">;physical address (page aligned)</span><span class="sc0">
   </span><span class="sc6">RET</span><span class="sc0">      
  </span><span class="sc5">CantGetPhysical</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc6">AND</span><span class="sc0">      </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000FFF000H</span><span class="sc0">   </span><span class="sc1">;guess it</span><span class="sc0">
   </span><span class="sc5">GuessPhysical</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
   </span><span class="sc6">RET</span><span class="sc0">      
 </span><span class="sc5">QuasiMmGetPhysicalAddress</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------------------------</span><span class="sc0">
 </span><span class="sc5">PrepareMemory</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0"> </span><span class="sc5">Base</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Limit</span><span class="sc0">
   </span><span class="sc5">sWin32</span><span class="sc0">   </span><span class="sc5">QuasiMmGetPhysicalAddress</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Base</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Limit</span><span class="sc0">
   </span><span class="sc6">MOV</span><span class="sc0">      </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Limit</span><span class="sc0">
   </span><span class="sc6">INC</span><span class="sc0">      </span><span class="sc8">EDX</span><span class="sc0">
   </span><span class="sc6">AND</span><span class="sc0">      </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">  </span><span class="sc1">;QWORD alignment</span><span class="sc0">
   </span><span class="sc6">RET</span><span class="sc0">
 </span><span class="sc5">PrepareMemory</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------------------------</span><span class="sc0">
 </span><span class="sc5">BringMemoryNT</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0"> </span><span class="sc5">Address</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">mSize</span><span class="sc0">
   </span><span class="sc5">iWin32</span><span class="sc0">   </span><span class="sc5">MapViewOfFile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">hSection</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ExplicitAccess.grfAccessPermissions</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Address</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">mSize</span><span class="sc0">
   </span><span class="sc6">RET</span><span class="sc0">
 </span><span class="sc5">BringMemoryNT</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------------------------</span><span class="sc0">
 </span><span class="sc5">FreeMemoryNT</span><span class="sc0">  </span><span class="sc9">PROC</span><span class="sc0">
   </span><span class="sc5">iMOV</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">UnmapViewOfFile</span><span class="sc0">
   </span><span class="sc5">sWin32</span><span class="sc0">   </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SectionGDT</span><span class="sc0">
   </span><span class="sc5">sWin32</span><span class="sc0">   </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SectionIDT</span><span class="sc0">
   </span><span class="sc5">iWin32</span><span class="sc0">   </span><span class="sc5">CloseHandle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">hSection</span><span class="sc0">
   </span><span class="sc6">RET</span><span class="sc0">
 </span><span class="sc5">FreeMemoryNT</span><span class="sc0">  </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------------------------</span><span class="sc0">
 </span><span class="sc5">PrimaryThread</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc9">ASSUME</span><span class="sc0">   </span><span class="sc8">FS</span><span class="sc4">:</span><span class="sc10">NOTHING</span><span class="sc0">           </span><span class="sc1">;  Настройка своего перехватчика</span><span class="sc0">
   </span><span class="sc6">SUB</span><span class="sc0">      </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">             </span><span class="sc1">;  ошибок</span><span class="sc0">
   </span><span class="sc5">PUSHp</span><span class="sc0">    </span><span class="sc5">xHandler</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">FS</span><span class="sc4">:[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc6">MOV</span><span class="sc0">      </span><span class="sc8">FS</span><span class="sc4">:[</span><span class="sc8">EAX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ESP</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">

   </span><span class="sc6">SGDT</span><span class="sc0">     </span><span class="sc5">GDT</span><span class="sc0">                   </span><span class="sc1">; Получаем содержимое GDT и IDT</span><span class="sc0">
   </span><span class="sc6">SIDT</span><span class="sc0">     </span><span class="sc5">IDT</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">

   </span><span class="sc5">iMOV</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">         </span><span class="sc1">; Получаем адреса </span><span class="sc0">
   </span><span class="sc5">iWin32i</span><span class="sc0">  </span><span class="sc5">LoadLibrary</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">szADVAPI32</span><span class="sc0">     </span><span class="sc1">; GetSecurityInfo</span><span class="sc0">
   </span><span class="sc6">TEST</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                    </span><span class="sc1">; SetEntriesInAcl</span><span class="sc0">
   </span><span class="sc6">JE</span><span class="sc0">       </span><span class="sc5">CantGetSection</span><span class="sc0">              </span><span class="sc1">; SetSecurityInfo</span><span class="sc0">
   </span><span class="sc6">MOV</span><span class="sc0">      </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc5">sWin32</span><span class="sc0">   </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">szGetSecurityInfo</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc6">TEST</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc6">MOV</span><span class="sc0">      </span><span class="sc5">GetSecurityInfo</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc6">JE</span><span class="sc0">       </span><span class="sc5">CantGetSection</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc5">sWin32</span><span class="sc0">   </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">szSetEntriesInAcl</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc6">TEST</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc6">MOV</span><span class="sc0">      </span><span class="sc5">SetEntriesInAcl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc6">JE</span><span class="sc0">       </span><span class="sc5">CantGetSection</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc5">sWin32</span><span class="sc0">   </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">szSetSecurityInfo</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc6">TEST</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc6">MOV</span><span class="sc0">      </span><span class="sc5">SetSecurityInfo</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc6">JE</span><span class="sc0">       </span><span class="sc5">CantGetSection</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">

   </span><span class="sc5">iWin32i</span><span class="sc0">  </span><span class="sc5">GetModuleHandle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">szNTDLL</span><span class="sc0">    </span><span class="sc1">; Получаем адрес NtOpenSection</span><span class="sc0">
   </span><span class="sc6">TEST</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc6">JE</span><span class="sc0">       </span><span class="sc5">CantGetSection</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc5">sWin32</span><span class="sc0">   </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">szNtOpenSection</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc6">TEST</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc6">JE</span><span class="sc0">       </span><span class="sc5">CantGetSection</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc6">MOV</span><span class="sc0">      </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc1">; EDI=NtSectionOpen</span><span class="sc0">

   </span><span class="sc1">; Открываем  \Device\PhysicalMemory</span><span class="sc0">
   </span><span class="sc5">sWin32</span><span class="sc0">   </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">phSection</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ExplicitAccess.grfAccessPermissions</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">poa</span><span class="sc0">
   </span><span class="sc6">TEST</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
   </span><span class="sc6">JGE</span><span class="sc0">      </span><span class="sc5">SectionOpened</span><span class="sc0">
   
    </span><span class="sc5">sWin32</span><span class="sc0">   </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">phSection</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">READ_CONTROL</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">WRITE_DAC</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">poa</span><span class="sc0">
    </span><span class="sc6">TEST</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">JL</span><span class="sc0">       </span><span class="sc5">CantGetSection</span><span class="sc0">
    </span><span class="sc5">sWin32</span><span class="sc0">   </span><span class="sc5">SetSectionSecurity</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc5">iWin32</span><span class="sc0">   </span><span class="sc5">CloseHandle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">hSection</span><span class="sc0">
    </span><span class="sc6">POP</span><span class="sc0">      </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">TEST</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">JNE</span><span class="sc0">      </span><span class="sc5">CantGetSection</span><span class="sc0">
    </span><span class="sc5">sWin32</span><span class="sc0">   </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">phSection</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ExplicitAccess.grfAccessPermissions</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">poa</span><span class="sc0">
    </span><span class="sc6">TEST</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">JGE</span><span class="sc0">      </span><span class="sc5">SectionOpened</span><span class="sc0">
</span><span class="sc5">CantGetSection</span><span class="sc4">:</span><span class="sc0"> 
   </span><span class="sc6">JMP</span><span class="sc0">      </span><span class="sc5">fExit</span><span class="sc0">

  </span><span class="sc5">SectionOpened</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc5">MapGDT</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc6">MOVZX</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">GDT.Limit</span><span class="sc0">
   </span><span class="sc5">sWin32</span><span class="sc0">   </span><span class="sc5">PrepareMemory</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">GDT.Base</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
   </span><span class="sc6">TEST</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
   </span><span class="sc6">JNE</span><span class="sc0">      </span><span class="sc10">@F</span><span class="sc0">
   </span><span class="sc6">JMP</span><span class="sc0">      </span><span class="sc5">MapIDT</span><span class="sc0">
  </span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc5">PUSHp</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">     </span><span class="sc1">;offset, limit</span><span class="sc0">
   </span><span class="sc6">ADD</span><span class="sc0">      </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">     </span><span class="sc1">;nbytes</span><span class="sc0">
   </span><span class="sc5">sWin32</span><span class="sc0">   </span><span class="sc5">BringMemoryNT</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
   </span><span class="sc6">TEST</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
   </span><span class="sc5">POPc</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">     </span><span class="sc1">;offset, limit</span><span class="sc0">
   </span><span class="sc6">JE</span><span class="sc0">       </span><span class="sc5">MapIDT</span><span class="sc0">
   </span><span class="sc6">MOV</span><span class="sc0">      </span><span class="sc5">SectionGDT</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

   </span><span class="sc6">ADD</span><span class="sc0">      </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

   </span><span class="sc6">LEA</span><span class="sc0">      </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">+</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">MOV</span><span class="sc0">      </span><span class="sc5">GDTstart</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
   </span><span class="sc6">MOV</span><span class="sc0">      </span><span class="sc5">GDTend</span><span class="sc4">,</span><span class="sc0">   </span><span class="sc8">ECX</span><span class="sc0">

  </span><span class="sc5">MapIDT</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc6">MOVZX</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IDT.Limit</span><span class="sc0">
   </span><span class="sc5">sWin32</span><span class="sc0">   </span><span class="sc5">PrepareMemory</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IDT.Base</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
   </span><span class="sc6">TEST</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">     </span><span class="sc1">;page aligned address </span><span class="sc0">
   </span><span class="sc6">JNE</span><span class="sc0">      </span><span class="sc10">@F</span><span class="sc0">
   </span><span class="sc6">JMP</span><span class="sc0">      </span><span class="sc5">SpecialActions</span><span class="sc0">
  </span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc5">PUSHp</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">          </span><span class="sc1">;offset, limit</span><span class="sc0">
   </span><span class="sc6">ADD</span><span class="sc0">      </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">          </span><span class="sc1">;nbytes</span><span class="sc0">
   </span><span class="sc5">sWin32</span><span class="sc0">   </span><span class="sc5">BringMemoryNT</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
   </span><span class="sc6">TEST</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
   </span><span class="sc5">POPc</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">          </span><span class="sc1">;offset, limit</span><span class="sc0">
   </span><span class="sc6">JE</span><span class="sc0">       </span><span class="sc5">SpecialActions</span><span class="sc0">
   </span><span class="sc6">MOV</span><span class="sc0">      </span><span class="sc5">SectionIDT</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
  </span><span class="sc5">SpecialActions</span><span class="sc4">:</span><span class="sc0">
  </span><span class="sc5">GoR0</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc6">MOV</span><span class="sc0">      </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">GDTstart</span><span class="sc0">
   </span><span class="sc6">MOV</span><span class="sc0">      </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">GDTend</span><span class="sc0">
   </span><span class="sc6">ADD</span><span class="sc0">      </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
  </span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc6">CMP</span><span class="sc0">      </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">
   </span><span class="sc6">JBE</span><span class="sc0">      </span><span class="sc5">EmptyNotFound</span><span class="sc0">
   </span><span class="sc6">SUB</span><span class="sc0">      </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
   </span><span class="sc6">CMP</span><span class="sc0">      </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">JNE</span><span class="sc0">      </span><span class="sc10">@B</span><span class="sc0">

   </span><span class="sc5">oLEA</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">OrigDesc</span><span class="sc0">
   </span><span class="sc6">PUSH</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc0">
   </span><span class="sc6">PUSH</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc0">
   </span><span class="sc6">MOVSD</span><span class="sc0">
   </span><span class="sc6">MOVSD</span><span class="sc0">
   </span><span class="sc6">POP</span><span class="sc0">      </span><span class="sc8">ESI</span><span class="sc0">
   </span><span class="sc6">MOV</span><span class="sc0">      </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0Proc</span><span class="sc0">
   </span><span class="sc6">MOV</span><span class="sc0">      </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">R0CSNT</span><span class="sc0">
   </span><span class="sc6">MOV</span><span class="sc0">      </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
   </span><span class="sc6">MOV</span><span class="sc0">      </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EC00H</span><span class="sc0">
   </span><span class="sc6">MOV</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
   </span><span class="sc6">SUB</span><span class="sc0">      </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">GDTstart</span><span class="sc0">
   </span><span class="sc6">MOV</span><span class="sc0">      </span><span class="sc5">CallGSel</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">
 
            </span><span class="sc10">BYTE</span><span class="sc0">   </span><span class="sc2">9AH</span><span class="sc0">
            </span><span class="sc10">DWORD</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
   </span><span class="sc5">CallGSel</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">

   </span><span class="sc5">oLEA</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">OrigDesc</span><span class="sc0">
   </span><span class="sc6">POP</span><span class="sc0">      </span><span class="sc8">EDI</span><span class="sc0">
   </span><span class="sc6">MOVSD</span><span class="sc0">
   </span><span class="sc6">MOVSD</span><span class="sc0">
  </span><span class="sc5">EmptyNotFound</span><span class="sc4">:</span><span class="sc0">
  </span><span class="sc5">SkipR0</span><span class="sc4">:</span><span class="sc0">
  </span><span class="sc5">xExit</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc5">sWin32</span><span class="sc0">   </span><span class="sc5">FreeMemoryNT</span><span class="sc0">
  </span><span class="sc5">fExit</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc6">POP</span><span class="sc0">      </span><span class="sc8">FS</span><span class="sc4">:</span><span class="sc5">TEB.ExceptionList</span><span class="sc0">
   </span><span class="sc5">iWin32</span><span class="sc0">   </span><span class="sc5">ExitProcess</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; Этот код будет выполняться в ring0</span><span class="sc0">
</span><span class="sc5">R0Proc</span><span class="sc0">  </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">CLI</span><span class="sc0">
        </span><span class="sc6">PUSHA</span><span class="sc0">
        </span><span class="sc6">CLD</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">BEEP</span><span class="sc0">
        </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">OSVER</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc2">80000000H</span><span class="sc0">    
        </span><span class="sc9">ELSE</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc2">0FDF8A000H</span><span class="sc0">   
        </span><span class="sc9">ENDIF</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">NewCreateFile</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">NewCreateFileEnd</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">NewCreateFile</span><span class="sc0">
        </span><span class="sc6">CLD</span><span class="sc0">
    </span><span class="sc6">REP</span><span class="sc0"> </span><span class="sc6">MOVSB</span><span class="sc0">
    </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">OSVER</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc2">80168E1EH</span><span class="sc0"> </span><span class="sc1">; Nt4CreateFile </span><span class="sc0">
        </span><span class="sc9">ELSE</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc2">804A0C2DH</span><span class="sc0"> </span><span class="sc1">; Nt5CreateFile </span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">0E9H</span><span class="sc0">
    </span><span class="sc6">STOSB</span><span class="sc0">

        </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">OSVER</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">80000000H</span><span class="sc0">
    </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">80168E1EH</span><span class="sc0">
    </span><span class="sc9">ELSE</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">0FDF8A000H</span><span class="sc0">   
    </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">804A0C2DH</span><span class="sc0">
    </span><span class="sc9">ENDIF</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">STOSD</span><span class="sc0"> 
        </span><span class="sc6">POPAD</span><span class="sc0">
        </span><span class="sc6">STI</span><span class="sc0">
        </span><span class="sc6">RETF</span><span class="sc0">
</span><span class="sc5">R0Proc</span><span class="sc0">    </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc5">R0ProcEnd</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; Этот код останется  в памяти </span><span class="sc0">
</span><span class="sc5">NewCreateFile</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">        </span><span class="sc1">; ORG 80000000H</span><span class="sc0">
              </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">BEEP</span><span class="sc0">
</span><span class="sc5">SAVECODE</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">PUSH</span><span class="sc0"> </span><span class="sc8">EBP</span><span class="sc0">
              </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
              </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EBP</span><span class="sc4">,</span><span class="sc8">ESP</span><span class="sc0">

              </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0E9H</span><span class="sc0">
              </span><span class="sc9">IF</span><span class="sc0">  </span><span class="sc5">OSVER</span><span class="sc0">
              </span><span class="sc5">LOCOFS</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">JMP2CONTIN</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NewCreateFile</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">168E1Eh</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">
              </span><span class="sc9">ELSE</span><span class="sc0">
              </span><span class="sc5">LOCOFS</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">804A0C2DH</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">0FDF8A000H</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">JMP2CONTIN</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NewCreateFile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">21</span><span class="sc0"> 
              </span><span class="sc9">ENDIF</span><span class="sc0">
</span><span class="sc5">JMP2CONTIN</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0">  </span><span class="sc5">LOCOFS</span><span class="sc0">
</span><span class="sc5">NewCreateFile</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc5">BEEP</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">PUSHAD</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0b6h</span><span class="sc0">
        </span><span class="sc6">OUT</span><span class="sc0">     </span><span class="sc2">43h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0012h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">34dch</span><span class="sc0">
        </span><span class="sc6">DIV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">OUT</span><span class="sc0">     </span><span class="sc2">42h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">AH</span><span class="sc0">
        </span><span class="sc6">OUT</span><span class="sc0">     </span><span class="sc2">42h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">IN</span><span class="sc0">      </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">61h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">OUT</span><span class="sc0">     </span><span class="sc2">61h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc5">l1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc2">1680</span><span class="sc0">
        </span><span class="sc5">l2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">l2</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">l1</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">
        </span><span class="sc6">OUT</span><span class="sc0">     </span><span class="sc2">61h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">POPA</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">BEEP</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc5">NewCreateFileEnd</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc9">END</span><span class="sc0"> </span><span class="sc5">PrimaryThread</span><span class="sc0">
</span><span class="sc4">:-)</span><span class="sc0">
</span><span class="sc5">@ECHO</span><span class="sc0"> </span><span class="sc5">OFF</span><span class="sc0">
</span><span class="sc5">@del</span><span class="sc0"> </span><span class="sc5">ml.log</span><span class="sc0">
</span><span class="sc5">@del</span><span class="sc0"> </span><span class="sc5">ln.log</span><span class="sc0">
</span><span class="sc5">@ECHO</span><span class="sc0"> Ассемблируем</span><span class="sc5">...</span><span class="sc0">
</span><span class="sc5">ML</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc10">c</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc5">coff</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc5">Gz</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc5">Cp</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc5">nologo</span><span class="sc0"> </span><span class="sc5">R0RES.bat</span><span class="sc0"> </span><span class="sc4">&gt;</span><span class="sc5">ml.log</span><span class="sc0">
</span><span class="sc5">@ECHO</span><span class="sc0"> Линкуем</span><span class="sc5">...</span><span class="sc0">
</span><span class="sc5">eLINK</span><span class="sc0"> </span><span class="sc5">R0RES</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc5">IGNORE</span><span class="sc4">:</span><span class="sc2">4078</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc5">nologo</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc5">SUBSYSTEM</span><span class="sc4">:</span><span class="sc5">CONSOLE</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc5">MERGE</span><span class="sc4">:</span><span class="sc5">.idata</span><span class="sc4">=</span><span class="sc10">.text</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc5">MERGE</span><span class="sc4">:</span><span class="sc5">.rdata</span><span class="sc4">=</span><span class="sc10">.text</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc9">SECTION</span><span class="sc4">:</span><span class="sc10">.text</span><span class="sc4">,</span><span class="sc5">EWR</span><span class="sc0"> </span><span class="sc4">&gt;</span><span class="sc5">ln.log</span><span class="sc0">
</span><span class="sc5">DEL</span><span class="sc0">   </span><span class="sc5">R0RES.obj</span><span class="sc0">
</span><span class="sc14">PAUSE</span><span class="sc0">
</span><span class="sc5">CLS</span></div></body>
</html>
