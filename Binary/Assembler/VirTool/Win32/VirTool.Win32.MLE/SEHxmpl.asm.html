<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>SEHxmpl.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;@GOTO TRANSLATE</span><span class="sc0">

</span><span class="sc2">.586P</span><span class="sc0">
</span><span class="sc9">.MODEL</span><span class="sc0"> </span><span class="sc10">FLAT</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">STDCALL</span><span class="sc0">

 </span><span class="sc9">EXTRN</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0"> 
 </span><span class="sc9">EXTRN</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">

 </span><span class="sc5">LOCALS</span><span class="sc0">

 </span><span class="sc9">INCLUDE</span><span class="sc0"> </span><span class="sc5">SEH.inc</span><span class="sc0">

</span><span class="sc9">.CODE</span><span class="sc0">
 </span><span class="sc5">START</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;first of all FAULTS OFF </span><span class="sc0">


</span><span class="sc1">;BTW----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;TRY_MSVC  EQU 0   ;uncomment it</span><span class="sc0">

</span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">TRY_MSVC</span><span class="sc0">
 </span><span class="sc1">; I've discovered this:</span><span class="sc0">
 </span><span class="sc1">; When is program, written in MS Visual C++, run,</span><span class="sc0">
 </span><span class="sc1">; MSVCRT??.dll installs top-level exception handler, which</span><span class="sc0">
 </span><span class="sc1">; checks if ExceptionCode=0E06D7363H, NumberParameters=3 </span><span class="sc0">
 </span><span class="sc1">; and ExceptionInformation[0]=19930520H</span><span class="sc0">
 </span><span class="sc1">; Let's try it:</span><span class="sc0">
 </span><span class="sc9">EXTRN</span><span class="sc0"> </span><span class="sc5">atoi</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">  </span><span class="sc1">; force library load</span><span class="sc0">
 </span><span class="sc6">CALL</span><span class="sc0">  </span><span class="sc5">RaiseException</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_msc</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">EXCEPTION_CONTINUABLE</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">mscparms</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">mscdate</span><span class="sc0">
 </span><span class="sc5">_msc</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">  </span><span class="sc2">0E06D7363H</span><span class="sc0">
 </span><span class="sc5">mscparms</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">  </span><span class="sc2">3</span><span class="sc0">
 </span><span class="sc5">mscdate</span><span class="sc0">        </span><span class="sc9">DD</span><span class="sc0">   </span><span class="sc2">19930520H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
</span><span class="sc1">;End-of-BTW---------------------------------------------------------------------</span><span class="sc0">



</span><span class="sc1">;Install </span><span class="sc0">
 </span><span class="sc5">Inst_xFrame</span><span class="sc0">   </span><span class="sc5">xHandler0</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">NoxTable</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">xScopeEnd</span><span class="sc0">
 </span><span class="sc5">Inst_xFrame</span><span class="sc0">   </span><span class="sc5">xHandler1</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">NoxTable</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">xScopeEnd</span><span class="sc0">
 </span><span class="sc5">Inst_xFrame</span><span class="sc0">   </span><span class="sc5">xHandler2</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">NoxTable</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">xScopeEnd</span><span class="sc0">
 </span><span class="sc5">Inst_TopLevel</span><span class="sc0"> </span><span class="sc5">TLHandler0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">OldTLHandler</span><span class="sc0">



 </span><span class="sc9">COMMENT</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc0">

 </span><span class="sc5">What</span><span class="sc0"> </span><span class="sc5">was</span><span class="sc0"> </span><span class="sc5">constructed?</span><span class="sc0">

 </span><span class="sc5">xFrames</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc5">xFrameHead</span><span class="sc0"> </span><span class="sc4">--&gt;</span><span class="sc0">  </span><span class="sc5">xFrame2</span><span class="sc0"> </span><span class="sc4">--&gt;</span><span class="sc0"> </span><span class="sc5">xFrame1</span><span class="sc0"> </span><span class="sc4">--&gt;</span><span class="sc0"> </span><span class="sc5">xFrame0</span><span class="sc0"> </span><span class="sc4">--&gt;</span><span class="sc0"> </span><span class="sc5">KnlxFrame</span><span class="sc0">
                 </span><span class="sc9">low</span><span class="sc0"> </span><span class="sc8">ESP</span><span class="sc0"> </span><span class="sc4">--</span><span class="sc0">                      </span><span class="sc4">--&gt;</span><span class="sc0"> </span><span class="sc9">high</span><span class="sc0"> </span><span class="sc8">ESP</span><span class="sc0">

 </span><span class="sc5">xHandlers</span><span class="sc4">:</span><span class="sc0">
                          </span><span class="sc5">back</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">thread</span><span class="sc0">
                   
                      </span><span class="sc4">^</span><span class="sc0">                      </span><span class="sc4">^</span><span class="sc0">
                      </span><span class="sc4">|</span><span class="sc5">yes</span><span class="sc0">                   </span><span class="sc4">|</span><span class="sc5">yes</span><span class="sc0">

                   </span><span class="sc5">xHandler2</span><span class="sc0">      </span><span class="sc5">no</span><span class="sc0">     </span><span class="sc5">xHandler1</span><span class="sc0">           </span><span class="sc5">no</span><span class="sc0">
  </span><span class="sc5">exception</span><span class="sc0"> </span><span class="sc4">--&gt;</span><span class="sc0"> </span><span class="sc5">ACCESS_VIOLATION</span><span class="sc0">  </span><span class="sc4">--&gt;</span><span class="sc0"> </span><span class="sc5">ACCESS_VIOLATION</span><span class="sc0">       </span><span class="sc4">--&gt;</span><span class="sc0">   ###
                    </span><span class="sc5">WRITE</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                </span><span class="sc5">READ</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

                   

                   </span><span class="sc5">xHandler0</span><span class="sc0">      </span><span class="sc5">no</span><span class="sc0">       </span><span class="sc5">Kernel</span><span class="sc0">
     ###    </span><span class="sc4">--&gt;</span><span class="sc0">    </span><span class="sc5">BREAKPOINT</span><span class="sc0">     </span><span class="sc4">--&gt;</span><span class="sc0">     </span><span class="sc5">xHandler</span><span class="sc0">   
                       </span><span class="sc10">?</span><span class="sc0">
                      </span><span class="sc4">||</span><span class="sc5">yes</span><span class="sc0">                  </span><span class="sc4">||</span><span class="sc0">
                      \</span><span class="sc4">/</span><span class="sc0">                     \</span><span class="sc4">/</span><span class="sc0">
                                   </span><span class="sc5">UnhandledExceptionFilter</span><span class="sc0">  </span><span class="sc5">no</span><span class="sc0">
                                      </span><span class="sc5">Was</span><span class="sc0"> </span><span class="sc5">set</span><span class="sc0"> </span><span class="sc5">TL</span><span class="sc0"> </span><span class="sc5">handler</span><span class="sc0">     </span><span class="sc4">--&gt;</span><span class="sc0">   </span><span class="sc10">ERROR</span><span class="sc0">
                                             </span><span class="sc10">?</span><span class="sc0">
                                             </span><span class="sc4">||</span><span class="sc5">yes</span><span class="sc0">
                                  </span><span class="sc5">yes</span><span class="sc0">        \</span><span class="sc4">/</span><span class="sc0">              </span><span class="sc5">no</span><span class="sc0">
                 </span><span class="sc5">back</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">thread</span><span class="sc0">   </span><span class="sc4">&lt;--</span><span class="sc0">     </span><span class="sc5">TLHandler0</span><span class="sc0">         </span><span class="sc4">--&gt;</span><span class="sc0">   </span><span class="sc10">ERROR</span><span class="sc0">
                                           </span><span class="sc5">MyxCode</span><span class="sc0">
                                              </span><span class="sc10">?</span><span class="sc0">

   </span><span class="sc5">Of</span><span class="sc0"> </span><span class="sc5">course</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">all</span><span class="sc0"> </span><span class="sc5">exceptions</span><span class="sc0"> </span><span class="sc5">can</span><span class="sc0"> </span><span class="sc5">be</span><span class="sc0"> </span><span class="sc5">handled</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc5">single</span><span class="sc0"> </span><span class="sc5">xHandler</span><span class="sc0"> </span><span class="sc5">too</span><span class="sc0">

                                  </span><span class="sc5">yes</span><span class="sc0">
   </span><span class="sc10">ERROR</span><span class="sc0">    </span><span class="sc4">--&gt;</span><span class="sc0">  </span><span class="sc5">ErrorMode</span><span class="sc0">        </span><span class="sc4">--&gt;</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">
                 </span><span class="sc4">=</span><span class="sc5">NOGPFAULT</span><span class="sc0">             </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">ExitThread</span><span class="sc0">
                    </span><span class="sc10">?</span><span class="sc0">
                    </span><span class="sc4">||</span><span class="sc5">no</span><span class="sc0">                  
                    \</span><span class="sc4">/</span><span class="sc0">  
                  </span><span class="sc5">ErrorBox</span><span class="sc0">
                 </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">DrWatson</span><span class="sc0">

 </span><span class="sc5">@</span><span class="sc0">

</span><span class="sc1">;-------------------------------------------------------------------------------</span><span class="sc0">


 </span><span class="sc6">INT</span><span class="sc0">   </span><span class="sc2">3</span><span class="sc0">       </span><span class="sc1">;breakpoint</span><span class="sc0">
 </span><span class="sc6">NOP</span><span class="sc0">           </span><span class="sc1">;NOP is here because Win95 has DPL of IntGate3 =3</span><span class="sc0">
               </span><span class="sc1">;so cx_Eip(NT) will point to INT 3, but cx_Eip(95)</span><span class="sc0">
               </span><span class="sc1">;will point to NOP</span><span class="sc0">

 </span><span class="sc5">@Foo</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">MOV</span><span class="sc0">   </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc2">01234H</span><span class="sc0">  </span><span class="sc1">;access violation read</span><span class="sc0">
 </span><span class="sc5">SizeOfInstruction</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">@Foo</span><span class="sc0">

 </span><span class="sc1">;let's make our exception</span><span class="sc0">
 </span><span class="sc6">CALL</span><span class="sc0">  </span><span class="sc5">RaiseException</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MyxCode</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MyxFlags</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">NumberMyParams</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">MyInfo</span><span class="sc0">
               </span><span class="sc1">;cx_Eip points to the next instruction (no need to update)</span><span class="sc0">


 </span><span class="sc6">MOV</span><span class="sc0">   </span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc2">4321H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">   </span><span class="sc1">;access violation write</span><span class="sc0">

 </span><span class="sc6">INT</span><span class="sc0">   </span><span class="sc2">3</span><span class="sc0">
 </span><span class="sc6">NOP</span><span class="sc0">
</span><span class="sc1">;-------------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;Restore</span><span class="sc0">
 </span><span class="sc5">Rest_TopLevel</span><span class="sc0"> </span><span class="sc5">TLHandler0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">OldTLHandler</span><span class="sc0">
 </span><span class="sc5">Rest_xFrame</span><span class="sc0">   </span><span class="sc5">xHandler2</span><span class="sc0">
 </span><span class="sc5">Rest_xFrame</span><span class="sc0">   </span><span class="sc5">xHandler1</span><span class="sc0">
 </span><span class="sc5">Rest_xFrame</span><span class="sc0">   </span><span class="sc5">xHandler0</span><span class="sc0">

 </span><span class="sc6">CALL</span><span class="sc0">  </span><span class="sc5">MessageBoxA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Ended</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">ExitP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40H</span><span class="sc0">


 </span><span class="sc1">; instead of </span><span class="sc0">
 </span><span class="sc1">;CALL  ExitProcess, 0</span><span class="sc0">
 </span><span class="sc1">; EliCZ's Escape is here :)</span><span class="sc0">
 </span><span class="sc6">CALL</span><span class="sc0">  </span><span class="sc5">SetErrorMode</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SEM_NOGPFAULTERRORBOX</span><span class="sc0">
 </span><span class="sc6">MOV</span><span class="sc0">   </span><span class="sc5">OldErrorMode</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">  </span><span class="sc1">; pro forma</span><span class="sc0">
 </span><span class="sc6">INVD</span><span class="sc0">                     </span><span class="sc1">; better than Copperfield</span><span class="sc0">
 


</span><span class="sc1">;-------------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">BeginxHandler</span><span class="sc0"> </span><span class="sc5">xHandler0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PxRecord</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PxFrame</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PxContext</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PxDispatch</span><span class="sc0">
  </span><span class="sc6">MOV</span><span class="sc0">   </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PxRecord</span><span class="sc0">

  </span><span class="sc6">TEST</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">]</span><span class="sc5">.ExceptionFlags</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">UNWIND_STACK</span><span class="sc0">
  </span><span class="sc6">JNE</span><span class="sc0">   </span><span class="sc5">@@ToNext</span><span class="sc0">
  </span><span class="sc1">;hm.. this should never happen, you can comment those instructions</span><span class="sc0">
  </span><span class="sc1">;..but kernel xHandler checks it, so let's check it too for sure</span><span class="sc0">

  </span><span class="sc6">CMP</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">]</span><span class="sc5">.ExceptionCode</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">EXCEPTION_BREAKPOINT</span><span class="sc0">
  </span><span class="sc6">JNE</span><span class="sc0">   </span><span class="sc5">@@ToNext</span><span class="sc0">

  </span><span class="sc6">MOV</span><span class="sc0">   </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PxContext</span><span class="sc0">
  </span><span class="sc6">MOV</span><span class="sc0">   </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ExceptionContinueExecution</span><span class="sc0">
  </span><span class="sc6">INC</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">]</span><span class="sc5">.cx_Eip</span><span class="sc0">       </span><span class="sc1">;update EIP</span><span class="sc0">

  </span><span class="sc1">;in [EBX].ContextFlags is CONTEXT_ALL</span><span class="sc0">
  </span><span class="sc1">;if you want to save CPU time, you can specify only some parts of context</span><span class="sc0">
  </span><span class="sc6">MOV</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">]</span><span class="sc5">.cx_ContextFlags</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CONTEXT_NORMAL</span><span class="sc0">
  </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">

 </span><span class="sc5">@@ToNext</span><span class="sc4">:</span><span class="sc0">
  </span><span class="sc6">MOV</span><span class="sc0">   </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ExceptionContinueSearch</span><span class="sc0">
 </span><span class="sc5">@@Return</span><span class="sc4">:</span><span class="sc0">
  </span><span class="sc6">RET</span><span class="sc0">
</span><span class="sc5">EndxHandler</span><span class="sc0">   </span><span class="sc5">xHandler0</span><span class="sc0">



</span><span class="sc5">BeginxHandler</span><span class="sc0"> </span><span class="sc5">xHandler1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PxRecord</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PxFrame</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PxContext</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PxDispatch</span><span class="sc0">
  </span><span class="sc6">MOV</span><span class="sc0">   </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PxRecord</span><span class="sc0">
  </span><span class="sc6">TEST</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">]</span><span class="sc5">.ExceptionFlags</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">UNWIND_STACK</span><span class="sc0">
  </span><span class="sc6">JNE</span><span class="sc0">   </span><span class="sc5">@@ToNext</span><span class="sc0">
  </span><span class="sc6">CMP</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">]</span><span class="sc5">.ExceptionCode</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">EXCEPTION_ACCESS_VIOLATION</span><span class="sc0">
  </span><span class="sc6">JNE</span><span class="sc0">   </span><span class="sc5">@@ToNext</span><span class="sc0">
  </span><span class="sc6">CMP</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">]</span><span class="sc5">.ExceptionInformation</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ACCESS_VIOLATION_READ</span><span class="sc0">
  </span><span class="sc6">JNE</span><span class="sc0">   </span><span class="sc5">@@ToNext</span><span class="sc0">

  </span><span class="sc6">MOV</span><span class="sc0">   </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PxContext</span><span class="sc0">
  </span><span class="sc6">MOV</span><span class="sc0">   </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ExceptionContinueExecution</span><span class="sc0">
  </span><span class="sc6">ADD</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">]</span><span class="sc5">.cx_Eip</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SizeOfInstruction</span><span class="sc0">  </span><span class="sc1">;update EIP</span><span class="sc0">
  </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">

 </span><span class="sc5">@@ToNext</span><span class="sc4">:</span><span class="sc0">
  </span><span class="sc6">MOV</span><span class="sc0">   </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ExceptionContinueSearch</span><span class="sc0">
 </span><span class="sc5">@@Return</span><span class="sc4">:</span><span class="sc0">
  </span><span class="sc6">RET</span><span class="sc0">
</span><span class="sc5">EndxHandler</span><span class="sc0">   </span><span class="sc5">xHandler1</span><span class="sc0">



</span><span class="sc5">BeginxHandler</span><span class="sc0"> </span><span class="sc5">xHandler2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PxRecord</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PxFrame</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PxContext</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PxDispatch</span><span class="sc0">
  </span><span class="sc6">MOV</span><span class="sc0">   </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PxRecord</span><span class="sc0">
  </span><span class="sc6">TEST</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">]</span><span class="sc5">.ExceptionFlags</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">UNWIND_STACK</span><span class="sc0">
  </span><span class="sc6">JNE</span><span class="sc0">   </span><span class="sc5">@@ToNext</span><span class="sc0">
  </span><span class="sc6">CMP</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">]</span><span class="sc5">.ExceptionCode</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">EXCEPTION_ACCESS_VIOLATION</span><span class="sc0">
  </span><span class="sc6">JNE</span><span class="sc0">   </span><span class="sc5">@@ToNext</span><span class="sc0">
  </span><span class="sc6">CMP</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">]</span><span class="sc5">.ExceptionInformation</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ACCESS_VIOLATION_WRITE</span><span class="sc0">
  </span><span class="sc6">JNE</span><span class="sc0">   </span><span class="sc5">@@ToNext</span><span class="sc0">

  </span><span class="sc6">CALL</span><span class="sc0">  </span><span class="sc5">MessageBoxA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Ican</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Not95</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40H</span><span class="sc0">

  </span><span class="sc6">MOV</span><span class="sc0">   </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PxContext</span><span class="sc0">
  </span><span class="sc6">MOV</span><span class="sc0">   </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ExceptionContinueExecution</span><span class="sc0">
  </span><span class="sc6">ADD</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">]</span><span class="sc5">.cx_Eip</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SizeOfInstruction</span><span class="sc0"> </span><span class="sc1">;update EIP</span><span class="sc0">
  </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">

 </span><span class="sc5">@@ToNext</span><span class="sc4">:</span><span class="sc0">
  </span><span class="sc6">MOV</span><span class="sc0">   </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ExceptionContinueSearch</span><span class="sc0">
 </span><span class="sc5">@@Return</span><span class="sc4">:</span><span class="sc0">
  </span><span class="sc6">RET</span><span class="sc0">
</span><span class="sc5">EndxHandler</span><span class="sc0">   </span><span class="sc5">xHandler2</span><span class="sc0">



</span><span class="sc5">BeginTopLevelHandler</span><span class="sc0">  </span><span class="sc5">TLHandler0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PxPointers</span><span class="sc0">
  </span><span class="sc6">MOV</span><span class="sc0">   </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PxPointers</span><span class="sc0">              </span><span class="sc1">;this is GetExceptionInformation()</span><span class="sc0">
  </span><span class="sc6">MOV</span><span class="sc0">   </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.ExceptionRecord</span><span class="sc0">
  </span><span class="sc6">MOV</span><span class="sc0">   </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.ContextRecord</span><span class="sc0">

  </span><span class="sc6">MOV</span><span class="sc0">   </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">]</span><span class="sc5">.ExceptionCode</span><span class="sc0">     </span><span class="sc1">;this is GetExceptionCode()</span><span class="sc0">

  </span><span class="sc6">CMP</span><span class="sc0">   </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MyxCode</span><span class="sc0">  </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc5">RaisedExceptionCodeMask</span><span class="sc0">
                                     </span><span class="sc1">;bit 28 is set to 0 by system</span><span class="sc0">
                                     </span><span class="sc1">;for RaisedExceptions</span><span class="sc0">
  </span><span class="sc6">JE</span><span class="sc0">    </span><span class="sc5">ItShouldBe</span><span class="sc0">                   </span><span class="sc1">;but it's true only for NT</span><span class="sc0">
                                      
  </span><span class="sc6">CMP</span><span class="sc0">   </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MyxCode</span><span class="sc0">                 </span><span class="sc1">;so it's next bug in Win95</span><span class="sc0">
  </span><span class="sc6">JNE</span><span class="sc0">   </span><span class="sc5">@@ToNext</span><span class="sc0">

 </span><span class="sc5">ItShouldBe</span><span class="sc4">:</span><span class="sc0">
  </span><span class="sc6">MOV</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc5">.cx_ContextFlags</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CONTEXT_NORMAL</span><span class="sc0"> </span><span class="sc1">;save CPU time</span><span class="sc0">

  </span><span class="sc6">LEA</span><span class="sc0">   </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">]</span><span class="sc5">.ExceptionInformation</span><span class="sc0">
  </span><span class="sc6">CALL</span><span class="sc0">  </span><span class="sc5">MessageBoxA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">RTitle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30H</span><span class="sc0">
  </span><span class="sc6">MOV</span><span class="sc0">   </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">EXCEPTION_CONTINUE_EXECUTION</span><span class="sc0">
  </span><span class="sc6">JMP</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">

 </span><span class="sc5">@@ToNext</span><span class="sc4">:</span><span class="sc0">
  </span><span class="sc6">MOV</span><span class="sc0">   </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">EXCEPTION_CONTINUE_SEARCH</span><span class="sc0">
 </span><span class="sc5">@@Return</span><span class="sc4">:</span><span class="sc0">
  </span><span class="sc6">RET</span><span class="sc0">
</span><span class="sc5">EndTopLevelHandler</span><span class="sc0"> </span><span class="sc5">TLHandler0</span><span class="sc0">
  


</span><span class="sc9">.DATA</span><span class="sc0">

</span><span class="sc1">;parameters for RaiseException</span><span class="sc0">
</span><span class="sc5">MyxCode</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">  </span><span class="sc2">0FDCBA987H</span><span class="sc0">
</span><span class="sc5">MyxFlags</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">  </span><span class="sc5">EXCEPTION_CONTINUABLE</span><span class="sc0">
</span><span class="sc5">MyInfo</span><span class="sc0">         </span><span class="sc9">DB</span><span class="sc0">   </span><span class="sc3">"It's"</span><span class="sc0">
               </span><span class="sc9">DB</span><span class="sc0">   </span><span class="sc3">" my "</span><span class="sc0">
               </span><span class="sc9">DB</span><span class="sc0">   </span><span class="sc3">"litt"</span><span class="sc0">
               </span><span class="sc9">DB</span><span class="sc0">   </span><span class="sc3">"le e"</span><span class="sc0">
               </span><span class="sc9">DB</span><span class="sc0">   </span><span class="sc3">"xcep"</span><span class="sc0">
               </span><span class="sc9">DB</span><span class="sc0">   </span><span class="sc3">"tion"</span><span class="sc0">
               </span><span class="sc9">DD</span><span class="sc0">    </span><span class="sc2">0000</span><span class="sc0">
</span><span class="sc5">NumberMyParams</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0">  </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">MyInfo</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">


</span><span class="sc1">;MessageBoxes</span><span class="sc0">
</span><span class="sc5">RTitle</span><span class="sc0">         </span><span class="sc9">DB</span><span class="sc0">   </span><span class="sc3">"Raise Exception"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Not95</span><span class="sc0">          </span><span class="sc9">DB</span><span class="sc0">   </span><span class="sc3">"This can't be Windows 95"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Ican</span><span class="sc0">           </span><span class="sc9">DB</span><span class="sc0">   </span><span class="sc3">"Because I can distinguish"</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
               </span><span class="sc9">DB</span><span class="sc0">   </span><span class="sc3">"READ from WRITE"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Ended</span><span class="sc0">          </span><span class="sc9">DB</span><span class="sc0">   </span><span class="sc3">"Happy End!"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ExitP</span><span class="sc0">          </span><span class="sc9">DB</span><span class="sc0">   </span><span class="sc3">"Escape"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;Storage</span><span class="sc0">
</span><span class="sc5">OldTLHandler</span><span class="sc0">   </span><span class="sc9">DD</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">OldErrorMode</span><span class="sc0">   </span><span class="sc9">DD</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">NoxTable</span><span class="sc0">       </span><span class="sc9">LABEL</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0">

</span><span class="sc9">END</span><span class="sc0">  </span><span class="sc5">START</span><span class="sc0">

</span><span class="sc4">:</span><span class="sc5">TRANSLATE</span><span class="sc0">
</span><span class="sc5">@ECHO</span><span class="sc0"> </span><span class="sc5">OFF</span><span class="sc0">
</span><span class="sc5">TASM</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc5">M</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc5">Q</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc5">T</span><span class="sc0"> </span><span class="sc5">SEHxmpl.bat</span><span class="sc0">
</span><span class="sc5">TLINK32</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc5">x</span><span class="sc0">    </span><span class="sc5">SEHxmpl</span><span class="sc4">,,,,</span><span class="sc5">SEHxmpl</span><span class="sc0">
</span><span class="sc5">DEL</span><span class="sc0">           </span><span class="sc5">SEHxmpl.obj</span></div></body>
</html>
