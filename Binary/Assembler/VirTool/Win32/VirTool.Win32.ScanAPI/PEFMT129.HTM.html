<html>
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
   <title>ФОРМАТ ИСПОЛНЯЕМЫХ ФАЙЛОВ PortableExecutables (PE)</title>
</head>
<body>
<br>
<br>
<center>
<font size=+2><b>ФОРМАТ ИСПОЛНЯЕМЫХ ФАЙЛОВ PortableExecutables (PE)</b></font>
<br><i>(даже не руководство системного программиста)</i>
</center>
<br>
<div align="right">by Hard Wisdom</div>
<br>
<hr>[27-Dec-1997y]-[v1.0.0] - Первоначально написанный файл
<hr>[30-Oct-1998y]-[v1.1.0] - Внесены накопленные изменения, + корректировки
                              от Shadow Dragon
<hr>[13-Feb-1999y]-[v1.1.1] - Перевод в HTML by
                     <a href="mailto:rom@xcc.khabarovsk.su">Roland / [RD]</a>
<hr>[26-Feb-1999y]-[v1.2.0] - Исправлена неточность с флажком типа отладочной
                              информации Tnx to Roland
<hr>

<font size=+1><br><u>Содержание</u><br></font>
[0] <a href="#part000">Вступление</a><br>

[1] <a href="#part010">Обзор</a><br>

[2] <a href="#part020">Заголовок PE файла (PE Header)</a><br>

[3] <a href="#part030">Таблица объектов (секций) файла (Object Table)</a><br>

[4] <a href="#part040">Страницы образов секций (Image Pages)</a><br>

[5] <a href="#part050">Экспорт</a><br>
&nbsp; [5.1] <a href="#part051">Таблица экспорта (Export Directory Table)</a><br>
&nbsp; [5.2] <a href="#part052">Таблица адресов экспорта (Address Table)</a><br>
&nbsp; [5.3] <a href="#part053">Таблица указателей на имена (Name Table Pointers)</a><br>
&nbsp; [5.4] <a href="#part054">Таблица ординалов (Ordinal Table)</a><br>
&nbsp; [5.5] <a href="#part055">Таблица имен экспорта (Export Name Table)</a><br>


[6] <a href="#part060">Импорт</a><br>
&nbsp; [6.1] <a href="#part061">Каталог импорта (Import Directory Table)</a><br>
&nbsp; [6.2] <a href="#part062">Таблица просмотра импорта (Import LookUp Table)</a><br>
&nbsp; [6.3] <a href="#part063">Таблица адресов импорта (Import Address Table)</a><br>

[7] <a href="#part070">Локальная область данных цепочек (Thread Local Storage)</a><br>
&nbsp; [7.1] <a href="#part071">Таблица разделов цепочек (TLS Directory table)</a><br>
&nbsp; [7.2] <a href="#part072">Таблица обратных вызовов цепочки (TLS CallBack Table)</a><br>

[8] <a href="#part080">Ресурсы</a><br>
&nbsp; [8.1] <a href="#part081">Каталог ресурсов (Resource Directory Table)</a><br>
&nbsp; [8.2] <a href="#part082">Пример структуры размещения ресурсов</a><br>

[9] <a href="#part090">Таблица настроек адресов (FixUp Table)</a><br>
&nbsp; [9.1] <a href="#part091">Блок настроек перемещений (FixUp Block)</a><br>

[10] <a href="#part100">Отладочная информация (Debug Information)</a><br>
&nbsp; [10.1] <a href="#part101">Отладочный каталог (Debug Directory)</a><br>

[11] <a href="#part110">Вопросы не рассмотренные в данном описании</a><br>

[12] <a href="#part120">P.S.</a><br>

<hr>
<br>
<br><a name="part000"><font size=+1><u>[0] Вступление</u></font></a>
<br>
<br>Итак,  в  этом документе излагается формат PE файла с комментариями. Что
побудило  меня  к  такой  работе? Отчасти пинания Shadow Dragon'a, а отчасти
одна  законченная  шутка для Windows'95. В основе лежит официальное описание
фирмы  Микрософт  (весьма  и  весьма глюкавое), книга Мэтта Питрека "Секреты
системного программирования в Windows'95" (ну очень тяжела для прочтения, ну
очень  много воды...), книга Эндрю Шульмана "Неофициальная Windows'95" (тоже
очень  мокрая),  книга  Джеффри  Рихтера  "Программирование  в Win32 API для
Windows  NT  3.5 и Windows'95", а так же готовые экзешники Windows'95. Общие
соглашения  в  написанном тексте: все именования полей и ключевых структур -
<b>Английские</b>  и  только,  остальной  текст может быть произвольным ;-),
тект   изложения   перемежается   с  вольными  комментариями  и  лирическими
отступлениями. Знаком "<b>?</b>" отмечены места, назначение которых не ясно,
либо вызывает сомнения.
<hr>
<br>
<br><a name="part010"><font size=+1><u>[1] Обзор</u></font></a>
<br>
<br>PE  формат файлов существует очень давно, Windows 3.11 при установленном
Win32s  может  запускать такие файлы (более того, это заложено в архитектуру
системы).  Но  только недавно он получил довольно широкое распространение, а
именно  с  расширением  использования  Windows'95.  Формат файла чрезвычайно
прост, но тем не менее в нем есть очень много спотычек, через которые падают
некоторые программы, да и сами Windows'95 (как программа). Следует отметить,
что  формат  файла  слизан  с  аналогичного  в  юних  системах,  кроме того,
мелкомягкие  опять  поехали  на изменении форматов и теперь вы можете так же
лицезреть  COFF  формат  OBJ  файлов, который весьма похож на PE (собственно
говоря  это  почти одно и то же ;-). Добавлю, что с новым форматом объектных
модулей работает только Microsoft (вполне естественно, учитывая, что они его
предложили),  но  найти данный компилятор ассемблера мне не удалось, впрочем
как и линковщик. Borland по прежнему работает со старым форматом OBJ файлов,
а  именно  -  Intel  OMF (справедливо для TASM v5.0 старше я не нашел). Ну а
теперь о самом файловом формате.
<br>Микрософт  решила  оставить у запускаемых файлов расширение EXE, а чтобы
не  было проблем начальным заголовком сделать запускаемый файл MS-DOS. У них
это получилось, вот краткая схема названного:
<br>
<br>
<div align=right><font size=+1><u>Summary File Structure</u></font></div>

<table border width="100%">
<tr>
   <td width="5%" align=center>00h</td>
   <td width="95%">
      <b>DOS 2 Header</b>
      <br>Совместимый заголовок (форматированная часть), будем считать, что
      его формат всем известен.
   </td>
</tr>
<tr>
   <td width="5%" align=center>1Ch</td>
   <td width="95%">
   4 байта, выравнивающие форматированную область заголовка с 1Ch до 20h,
   <br>никто не мешает им там не присутствовать ;-) но у Микрософта они
   описаны.
   <br>Это позволяет заголовку файла иметь красивый размер в 2 параграфа...
   </td>
</tr>
<tr>
   <td width="5%" align=center>20h</td>
   <td width="95%">
   <b>OEM Identifier & OEM Info</b>
   <br>Другими словами, информация о программе, практически никогда не
   присутствует, однако место должно быть зарезервировано. Я встречал файлы
   с заполненным полем, наверное их делали люди буквально соблюдающие
   требования документации от Microsoft.
   </td>
</tr>
<tr>
   <td width="5%" align=center>3Ch</td>
   <td width="95%">
   <b>Offset to PE Header</b>
   <br>Смещение реального PE заголовка в файле, DWord, присутствует именно
   здесь,
   <br><b>?</b> заголовок выравнивается на 8 байтовую границу относительно
   начала файла.
   </td>
</tr>
<tr>
   <td width="5%" align=center>min 40h</td>
   <td width="95%">
   релокейшены программы-заглушки, у стандартного STUB'а их нет.
   <br>На это поле указывает ReloOfs заголовка DOS 2 Header, соответственно
   его значение должно быть >=40h иначе такой файл как кандидат в PE
   рассматриваться вообще не будет. ;-)
   <br>Но на самом деле загрузчику безразлично фактическое их положение.
   </td>
</tr>
<tr>
   <td width="5%" align=center>min 40h + XXh</td>
   <td width="95%">
   собственно говоря, тело DOS программы, иначе говоря STUB'a.
   <br>Чаще всего говорит о невозможности запуска, но может содержать в себе
   очень разрушительные вещи, как то поиск в PATH и запуск файла WIN.COM
   с указанием имени данного файла, причем без предупреждений, что конечно-же
   весьма неприятно. 40h есть нижняя граница данного поля, может,
   собственно говоря, находиться сколь угодно выше, зависит от размера
   заголовка.
   </td>
</tr>
<tr>
   <td width="5%" align=center>XXh</td>
   <td width="95%">
   <b>PE Header</b>
   <br>Туточки находится заголовок PE файла и, другими словами, начинается
   сама 32-битная программа,
   <br>по идее он должен быть выровнен на 8-байтовую границу, пусть так и
   будет.
   </td>
</tr>
<tr>
   <td width="5%" align=center>XXh</td>
   <td width="95%">
   <b>Object Table</b><br>
   табличка описаний секций файла, подробнее далее.
   </td>
</tr>

<tr>
   <td width="5%" align=center>XXh</td>
   <td width="95%">
   <b>Image Pages (import info, export info, fixup info, resource info,
   debug info, etc...)</b><br>
   Остальная часть запускаемого файла...
   </td>
</tr>
</table>

<br>Для проверки на возможность файла быть в формате PE необходимо, чтобы он
был  во  первых  EXE (байты по смещению 0h равны 5A4Dh), во вторых, слово по
смещению  18h должно быть >=40h, тогда и только тогда DWord поле по смещению
3Ch имеет смысл. Загрузчик маздая файлы с заголовком 'ZM' - 4D5Ah не считает
валидными  32-битовыми  программами. При запуске из дос-окна выполняется ДОС
часть  программы, а при запуске с помощью CreateProcessA (консольная утилита
START.EXE вызывает данный сервис) выдается сообщение о невозможности запуска
программы,  т.к.  это  не  валидное  32-битовое приложение. Так же интересен
следующий  момент: возможен запуск файлов с расширением COM и структурой PE,
но  невозможен  запуск  файлов  с расширением COM и структурой NE. Загрузчик
32-битового   приложения   проверяет   на  принадлежность  файла  к  разряду
16-битовых  приложений  и  передает  управление  в 16-битовый Kernel, в свою
очередь тот отбраковывает переданное ему приложение и выполняет STUB.
<br>Так   же  следует  заметить,  что  фактическое  значение  поля  ReloOffs
заголовка  DOS  2  Header  для  загрузчика  PE файлов безразлично (он его не
проверяет),  соответственно это можно использовать в своих целях. (Зато HIEW
это  проверяет и отказывается работать с такими файлами, чтение документаций
- вредная штука).
<hr>
<br>
<br><a name="part020"><font size=+1><u>[2] Заголовок PE файла (PE Header)</u></font></a>
<br>
<br>Заметки:<br>
<ul>
<li>VA есть виртуальный адрес, который уже базирован на смещение Image Base,
    прочитанное из PE Header'а. RVA есть относительный адрес ссылающийся на
    Image Base.
</li>
<li>RVA в PE Header имеющий нулевое значение указывает на то, что
    соответствующее поле не используется (что многие не проверяют IMHO).
</li>
<li>Все используемые страницы (Image pages) выравнены дополнением нулями до
    границы File align (опять же, выравнивать можно чем угодно, и не только
    нулями :-). Базы всех прочих таблиц и структур должны быть выравнены на
    DWord (4 байта) границу. Таким образом, все VA и RVA должны находиться
    на 32-битной границе [имеется ввиду на границе размещения двойных слов,
    начиная от 0 в файле, так что читайте смело DWord'ами ;-) в жизни не
    все так просто - прим. мое]. Все таблицы и структурные поля должны быть
    выравнены на их "родную" границу, за возможным исключением Debug Info.
</li>
</ul>

А теперь поехали...
<br>
<div align=right><font size=+1><u>PE Header</u></font></div>

<table border width="100%">
<tr>
   <td width="5%" align=center><b>Base</b></td>
   <td width="10%" align=center><b>Size or Type</b></td>
   <td width="20%" align=center><b>Name Of field</b></td>
   <td width="65%" align=center><b>Brief description</b></td>
</tr>
<tr>
   <td width="5%" align=center>00h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Signature Bytes</td>
   <td width="65%">
   Сигнатурка того, что этот файл собственно говоря является PE - должна быть
   4550h, иначе - 'PE',0h,0h; два последних байта под что-то-там Микрософт
   зарезервировала (и проверяет их равенству на 0!).
   </td>
</tr>
<tr>
   <td width="5%" align=center>04h</td>
   <td width="10%" align=center>Word</td>
   <td width="20%"><a href="#CPU_Type">CPU Type</a></td>
   <td width="65%">
   это поле указывает на предпочтительный ;-) тип процессора, на котором
   желательно запускать данную программу, вы редко увидите что-либо отличное
   от 14Ch -> i386
   </td>
</tr>
<tr>
   <td width="5%" align=center>06h</td>
   <td width="10%" align=center>Word</td>
   <td width="20%">Num of Objects</td>
   <td width="65%">
   это поле указывает на число реальных входов в Object Table
   </td>
</tr>
<tr>
   <td width="5%" align=center>08h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Time/Date Stamp</td>
   <td width="65%">
   используется для хранения даты и времени создания/модификации линкером
   </td>
</tr>
<tr>
   <td width="5%" align=center>0Ch</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Pointer to COFF table</td>
   <td width="65%">
   дополнительный указатель определяющий местонахождение отладочной COFF
   таблицы в файлах, отладочную информацию лучше всего искать по другому
   </td>
</tr>
<tr>
   <td width="5%" align=center>10h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">COFF table size</td>
   <td width="65%">
   кол-во символов в COFF таблице
   </td>
</tr>
<tr>
   <td width="5%" align=center>14h</td>
   <td width="10%" align=center>Word</td>
   <td width="20%">NT Header Size</td>
   <td width="65%">
   размер заголовка PE файла начиная с поля Magic,
   название взято у программы Hiew, таким образом, общий размер заголовка
   PE файла составляет NT Header Size + 18h
   </td>
</tr>
<tr>
   <td width="5%" align=center>16h</td>
   <td width="10%" align=center>Word</td>
   <td width="20%"><a href="#Flags">Flags</a></td>
   <td width="65%">
   указывает на предназначение программы, конкретное значение флагов см.ниже
   </td>
</tr>
<tr>
   <td width="5%" align=center>18h</td>
   <td width="10%" align=center>Word</td>
   <td width="20%"><a href="#Magic">Magic</a></td>
   <td width="65%">
   поле указывает на основное предназначение программы. абсолютно всем
   наплевать в него
   </td>
</tr>
<tr>
   <td width="5%" align=center>1Ah</td>
   <td width="10%" align=center>Byte</td>
   <td width="20%">Link Major</td>
   <td width="65%">
   старший номер версии использовавшегося при создании линкера
   </td>
</tr>
<tr>
   <td width="5%" align=center>1Bh</td>
   <td width="10%" align=center>Byte</td>
   <td width="20%">Link Minor</td>
   <td width="65%">
   младший номер версии использовавшегося при создании линкера
   (эти 2 поля загрузчик пока игнорирует)
   </td>
</tr>
<tr>
   <td width="5%" align=center>1Ch</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Size of Code</td>
   <td width="65%">
   размер именно программного кода в файле, KERNEL использует это значение
   для фактического отведения памяти под загружаемую программу, установка
   этого значения слишком маленьким приведет к выдаче идиотского сообщения
   о нехватке памяти, хотя ее может быть валом
   </td>
</tr>
<tr>
   <td width="5%" align=center>20h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Size of Init Data</td>
   <td width="65%">
   размер секции инициализированных данных, очевидно не используется
   в Windows'95, но используется в NT, назначение аналогично приведенному выше
   </td>
</tr>
<tr>
   <td width="5%" align=center>24h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Size of UnInit Data</td>
   <td width="65%">
   размер секции неинициализированных данных, сложно сказать, как эти 3 поля
   корреспондируют между собой, но лучше с ними по честному ;-) явно видно,
   что формат разрабатывали одни, а реализовывали его другие. Рекомендую
   изучить регионы памяти и VirtualXXX функции
   </td>
</tr>
<tr>
   <td width="5%" align=center>28h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Entry point RVA</td>
   <td width="65%">
   адрес, относительно Image Base по которому передается управление при
   запуске программы или адрес инициализации/завершения библиотеки
   </td>
</tr>
<tr>
   <td width="5%" align=center>2Ch</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Base of Code</td>
   <td width="65%">
   RVA секции, которая содержит программный код (как будто бы она одна
   единственная ;-) ) судя по всему никем не используется (но установлено
   верно)
   </td>
</tr>
<tr>
   <td width="5%" align=center>30h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Base of Data</td>
   <td width="65%">
   RVA секции содержащей якобы данные, в реальных экзешниках указывает
   и на .data и на .bss и еще бог знает куда, вряд ли кем-нибудь используется
   </td>
</tr>
<tr>
   <td width="5%" align=center>34h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Image Base</td>
   <td width="65%">
   виртуальный начальный адрес загрузки программы (ее первого байта).
   Должен быть на границе 64 Кб (связано с системой памяти Windows'95)
   </td>
</tr>
<tr>
   <td width="5%" align=center>38h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Object align</td>
   <td width="65%">
   выравнивание программных секций, должен быть степенью 2 между 512 и 256М
   включительно, так же связано с системой памяти. При использовании других
   значений программа не загрузится.
   </td>
</tr>
<tr>
   <td width="5%" align=center>3Ch</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">File align</td>
   <td width="65%">
   фактор используемый для выравнивания секций в программном файле.
   В байтовом значении указывает на границу на которую секции дополняются
   0 при размещении в файле. Большое значение приводит к нерациональному
   использованию дискового пространства, маленькое увеличивает компактность,
   но и снижает скорость загрузки. Должен быть степенью 2 в диапазоне от 512
   до 64К включительно. Прочие значения вызовут ошибку загрузки файла. Я так
   думаю, что размер файла штука более важная.
   </td>
</tr>
<tr>
   <td width="5%" align=center>40h</td>
   <td width="10%" align=center>Word</td>
   <td width="20%">OS Major</td>
   <td width="65%">
   старший номер версии операционки необходимый для запуска программы.
   (нулевое значение не позволяет запустить программу, остальные игнорируются
   проверялось на OSR2)
   </td>
</tr>
<tr>
   <td width="5%" align=center>42h</td>
   <td width="10%" align=center>Word</td>
   <td width="20%">OS Minor</td>
   <td width="65%">
   младший номер версии операц.
   </td>
</tr>
<tr>
   <td width="5%" align=center>44h</td>
   <td width="10%" align=center>Word</td>
   <td width="20%">USER Major</td>
   <td width="65%">
   пользовательский номер версии, задается пользователем при линковке
   программы и им же и используется
   </td>
</tr>
<tr>
   <td width="5%" align=center>46h</td>
   <td width="10%" align=center>Word</td>
   <td width="20%">USER Minor</td>
   <td width="65%">
   аналогично, младший номер
   </td>
</tr>
<tr>
   <td width="5%" align=center>48h</td>
   <td width="10%" align=center>Word</td>
   <td width="20%">SubSys Major</td>
   <td width="65%">
   старший номер версии подсистемы, черт его знает как он использается,
   по моему всяких версий уже через край
   </td>
</tr>
<tr>
   <td width="5%" align=center>4Ah</td>
   <td width="10%" align=center>Word</td>
   <td width="20%">SubSys Minor</td>
   <td width="65%">
   аналогично, младший номер
   </td>
</tr>
<tr>
   <td width="5%" align=center>4Ch</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Reserved</td>
   <td width="65%">
   судя по всему так оно и есть
   </td>
</tr>
<tr>
   <td width="5%" align=center>50h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Image Size</td>
   <td width="65%">
   виртуальный размер в байтах всего загружаемого образа, вместе
   с заголовками, кратен Object align
   </td>
</tr>
<tr>
   <td width="5%" align=center>54h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Header Size</td>
   <td width="65%">
   общий размер всех заголовков: DOS Stub + PE Header + Object Table
   </td>
</tr>
<tr>
   <td width="5%" align=center>58h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">File CheckSum</td>
   <td width="65%">
   контрольная сумма всего файла, опять же как и в DOS'е ее никто
   не контролирует, а линкер ее ставит в 0 при линковке
   Предполагалось ее рассчитывать как инверсию суммы всех байтов файла.
   </td>
</tr>
<tr>
   <td width="5%" align=center>5Ch</td>
   <td width="10%" align=center>Word</td>
   <td width="20%"><a href="#SubSystem">SubSystem</a></td>
   <td width="65%">
   операционная подсистема необходимая для запуска данного файла
   (GUI, консоль...)
   </td>
</tr>
<tr>
   <td width="5%" align=center>5Eh</td>
   <td width="10%" align=center>Word</td>
   <td width="20%"><a href="#DLL_Flags">DLL Flags</a></td>
   <td width="65%">
   указывает на специальные потребности при загрузке, начиная с NT 3.5
   устарел и не используется
   </td>
</tr>
<tr>
   <td width="5%" align=center>60h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Stack Reserve Size</td>
   <td width="65%">
   память требуемая для стека приложения, память резервируется, но выделяется
   только Stack Commit Size байтов, следующая страница является охранной.
   Когда приложение достигает этой страницы, то страница становится доступной,
   а следующая страница - охранной, и так до достижения нижней границы, после
   чего Windows'95 убивает программу с воплями об исключении у нее в стеке
   </td>
</tr>
<tr>
   <td width="5%" align=center>64h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Stack Commit Size</td>
   <td width="65%">
   объем памяти отводимой в стеке немедленно после загрузки
   </td>
</tr>
<tr>
   <td width="5%" align=center>68h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Heap Reserve Size</td>
   <td width="65%">
   максимальный возможный размер локального хипа
   </td>
</tr>
<tr>
   <td width="5%" align=center>6Ch</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Heap Comit Size</td>
   <td width="65%">
   отводимый при загрузке хип
   </td>
</tr>
<tr>
   <td width="5%" align=center>70h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Loader Flags</td>
   <td width="65%">
   <b>?</b> начиная с NT 3.5 объявлено неиспользуемым, назначение неясно,
   но в целом связано с поддержкой отладки
   </td>
</tr>
<tr>
   <td width="5%" align=center>74h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Num of RVA and Sizes</td>
   <td width="65%">
   указывает размер массива VA/Size который следует ниже, данная фича
   зарезервирована под будущие расширения формата. В данный момент его
   значение всегда равно 10h
   </td>
</tr>
<tr>
   <td width="5%" align=center>78h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Export Table RVA</td>
   <td width="65%">
   RVA адрес таблицы экспорта
   </td>
</tr>
<tr>
   <td width="5%" align=center>7Ch</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Export Data Size</td>
   <td width="65%">
   размер таблицы экспорта
   </td>
</tr>
<tr>
   <td width="5%" align=center>80h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Import Table RVA</td>
   <td width="65%">
   RVA адрес таблицы импорта
   </td>
</tr>
<tr>
   <td width="5%" align=center>84h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Import Data Size</td>
   <td width="65%">
   размер таблицы импорта
   </td>
</tr>
<tr>
   <td width="5%" align=center>88h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Resource Table RVA</td>
   <td width="65%">
   RVA адрес таблицы ресурсов
   </td>
</tr>
<tr>
   <td width="5%" align=center>8Ch</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Resource Data Size</td>
   <td width="65%">
   размер таблицы ресурсов
   </td>
</tr>
<tr>
   <td width="5%" align=center>90h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Exception Table RVA</td>
   <td width="65%">
   RVA адрес таблицы исключений
   </td>
</tr>
<tr>
   <td width="5%" align=center>94h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Exception Data Size</td>
   <td width="65%">
   размер таблицы исключений
   </td>
</tr>
<tr>
   <td width="5%" align=center>98h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Security Table RVA</td>
   <td width="65%">
   <b>?</b> адрес таблицы безопасности
   </td>
</tr>
<tr>
   <td width="5%" align=center>9Ch</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Security Data Size</td>
   <td width="65%">
   <b>?</b> размер таблицы безопасности
   </td>
</tr>
<tr>
   <td width="5%" align=center>A0h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Fix Up's Table RVA</td>
   <td width="65%">
   RVA адрес таблицы настроек
   </td>
</tr>
<tr>
   <td width="5%" align=center>A4h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Fix Up's Data Size</td>
   <td width="65%">
   размер таблицы настроек
   </td>
</tr>
<tr>
   <td width="5%" align=center>A8h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Debug Table RVA</td>
   <td width="65%">
   RVA адрес таблицы отладочной инфы
   </td>
</tr>
<tr>
   <td width="5%" align=center>ACh</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Debug Data Size</td>
   <td width="65%">
   размер таблицы отладочной инфы
   </td>
</tr>
<tr>
   <td width="5%" align=center>B0h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Image Description RVA</td>
   <td width="65%">
   RVA адрес строки описани модуля
   </td>
</tr>
<tr>
   <td width="5%" align=center>B4h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Description Data Size</td>
   <td width="65%">
   размер строки описания модуля
   </td>
</tr>
<tr>
   <td width="5%" align=center>B8h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Machine Specific RVA</td>
   <td width="65%">
   <b>?</b> адрес таблицы значений специфичных для микропроцессора
   </td>
</tr>
<tr>
   <td width="5%" align=center>BCh</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Machnine Data Size</td>
   <td width="65%">
   <b>?</b> размер таблицы значений специфичных для микропроцессора
   </td>
</tr>
<tr>
   <td width="5%" align=center>C0h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">TLS RVA</td>
   <td width="65%">
   указатель на локальную область данных цепочек
   </td>
</tr>
<tr>
   <td width="5%" align=center>C4h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">TLS Data Size</td>
   <td width="65%">
   размер области данных цепочек
   </td>
</tr>
<tr>
   <td width="5%" align=center>C8h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Load Config RVA</td>
   <td width="65%">
   <b>?</b>
   </td>
</tr>
<tr>
   <td width="5%" align=center>CCh</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Load Config Data Size</td>
   <td width="65%">
   <b>?</b>
   </td>
</tr>
<tr>
   <td width="5%" align=center>D0h</td>
   <td width="10%" align=center>08h</td>
   <td width="20%">Reserved</td>
   <td width="65%">
   <b>?</b>
   </td>
</tr>
<tr>
   <td width="5%" align=center>D8h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">IAT RVA</td>
   <td width="65%">
   <b>?</b> мною это поле обнаружено только в мультимедийных файлах системы
   Windows'95, это SNDREC32, CDPLAYER, MPLAYER. оно указывает на таблицу
   адресов импорта в файле (помимо структуры импорта) писал эти программы
   один человек и чего он хотел...
   <br>используется в NT, в Windows'95 судя по всему нет
   </td>
</tr>
<tr>
   <td width="5%" align=center>DCh</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">IAT Data Size</td>
   <td width="65%">
   <b>?</b> размер описанного поля
   </td>
</tr>
<tr>
   <td width="5%" align=center>E0h</td>
   <td width="10%" align=center>08h</td>
   <td width="20%">Reserved</td>
   <td width="65%">
   <b>?</b>
   </td>
</tr>
<tr>
   <td width="5%" align=center>E8h</td>
   <td width="10%" align=center>08h</td>
   <td width="20%">Reserved</td>
   <td width="65%">
   <b>?</b>
   </td>
</tr>
<tr>
   <td width="5%" align=center>F0h</td>
   <td width="10%" align=center>08h</td>
   <td width="20%">Reserved</td>
   <td width="65%">
   <b>?</b>
   </td>
</tr>
</table>

<table border width="100%">
<tr>
   <td width="30%" align=center><b>Total Structure size</b></td>
   <td width="5%" align=center><b>F8h</b></td>
   <td width="65%">
   <b>Общий размер заголовка</b>
   </td>
</tr>
</table>

<br><a name="CPU_Type"><font size=+1><u>CPU Type имеет следующие значения:</u></font></a>
<ul>
<li>0000h - а черт его знает</li>
<li>014Ch - i386</li>
<li>014Dh - i486</li>
<li>014Eh - i586</li>
<li>0162h - MIPS Mark I (R2000, R3000)</li>
<li>0163h - MIPS Mark II (R6000)</li>
<li>0166h - MIPS Mark III (R4000)</li>
</ul>

<a name="Flags"><font size=+1><u>Flags имеет следующие битовые значения:</u></font></a>
<ul>
<li>0000h - это программа</li>
<li>0001h - файл не содержит перемещений и таблицы перемещаемых элементов</li>
<li>0002h - образ в файле можно запускать
    <br>Если этот бит не установлен, то это обычно указывает на ошибку
    обнаруженную на этапе линковки, или же на то, что код был инкрементально
    отлинкован и, следовательно, не может быть запущен. [инкрементальная
    линковка - частичная линковка кода при изменении участка программы, а
    не тотальная перекомпиляция проекта, что подразумевается здесь -
    сказать очень трудно, скажем так - ОШИБКА!]</li>
<li>0200h - грузить фиксированно
    <br>Указывает на то, что программу можно грузить только по адресу,
    записанному в Image Base, если это невозможно, то такой файл лучше
    вообще не запускать.</li>
<li>2000h - это библиотека</li>
</ul>

<a name="Magic"><font size=+1><u>Magic имеет следующие значения:</u></font></a>
<ul>
<li>0107h - программа должна выполняться в ПЗУ (что за черт?)</li>
<li>010Bh - нормальная программа для ОЗУ</li>
</ul>
(на самом деле можно ставить любое значение, программа грузится нормально)<br><br>

<a name="SubSystem"><font size=+1><u>SubSystem имеет следующие значения:</u></font></a>
<ul>
<li>0000h - а черт его знает</li>
<li>0001h - Native, пошли вы все к такой-то матери, никто не нужен</li>
<li>0002h - Windows GUI, т.е. окошечная</li>
<li>0003h - Windows Character (консольное приложение)</li>
<li>0005h - OS/2 Character</li>
<li>0007h - Posix Character (формат PE с юниховского передран, вот и. . .)</li>
</ul>

<a name="DLL_Flags"><font size=+1><u>DLL Flags имеет следующие битовые значения:</u></font></a>
<ul>
<li>0001h - инициализация библиотеки на процесс</li>
<li>0002h - завершение библиотеки на процесс</li>
<li>0004h - инициализация библиотеки на нить (цепочку)</li>
<li>0008h - завершение библиотеки на нить (цепочку)</li>
</ul>
Все прочие биты зарезервированы и желательно их установить в 0 значение, но
можно этого и не делать ;-)
<hr>
<br>
<br><a name="part030"><font size=+1><u>[3] Таблица объектов (секций) файла (Object Table)</u></font></a>
<br>
<br>Число  входов  в  таблице  объектов  (секций)  определяется полем Num of
Objects  заголовка  PE Header. Входы в таблице объектов нумеруются начиная с
1.    Сама    таблица    располагается   непосредственно   за   PE   Header.
Последовательность  секций  кода  и  данных  в  памяти  выбирается линкером.
Виртуальные  адреса  объектам  должны быть присвоены линкером в возрастающем
порядке  и  являются  кратными  Object  align  в  заголовке PE Header. Стоит
заметить,  что текущая реализация загрузчика Windows'95 не различает порядка
объектов   (секций)   в   таблице,  поэтому  можно  смело  располагать  их в
произвольном  порядке.  Каждая  секция  (объект) располагает именем, которое
никого  ни  к  чему  не обязывает, имя может быть произвольным, но вообще-то
смысл содержания секции и ее наименования как правило совпадают.
<br>
<br>
<div align=right><font size=+1><u>Object Entry</u></font></div>

<table border width="100%">
<tr>
   <td width="5%" align=center><b>Base</b></td>
   <td width="10%" align=center><b>Size or Type</b></td>
   <td width="20%"><b>Name Of field</b></td>
   <td width="65%"><b>Brief description</b></td>
</tr>
<tr>
   <td width="5%" align=center>00h</td>
   <td width="10%" align=center>08h</td>
   <td width="20%"><a href="#Object_Name">Object Name</a></td>
   <td width="65%">
   Имя объекта, остаток заполнен нулями, если имя объекта имеет длину 8
   символов, то заключительного 0 нет. Некоторые PE дамперы падают на этом
   факте. Имя - штука отфонарная и никого ни к чему не обязывает.
   </td>
</tr>
<tr>
   <td width="5%" align=center>08h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Virtual Size</td>
   <td width="65%">
   виртуальный размер секции, именно столько памяти будет отведено под секцию.
   Если Virtual Size превышает Physical Size, то разница заполняется нулями,
   так определяются секции неинициализированных данных (Physical Size = 0)
   </td>
</tr>
<tr>
   <td width="5%" align=center>0Ch</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Section RVA</td>
   <td width="65%">
   размещение секции в памяти, виртуальный ее адрес относительно Image Base.
   Позиция каждой секции выравнена на границу Object align (степень 2 от 512
   до 256М включительно, по умолчанию 64К) и секции упакованы впритык друг
   к другу, впрочем, можно это не соблюдать.
   </td>
</tr>
<tr>
   <td width="5%" align=center>10h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Physical Size</td>
   <td width="65%">
   размер секции (ее инициализированной части) в файле, кратно полю
   File align в заголовке PE Header, должно быть меньше или равно
   Virtual Size. Играя с этим полем можно добиться некоторых результатов ;-)
   загрузчик по идее хлопает всю секцию в отведенное ОЗУ
   </td>
</tr>
<tr>
   <td width="5%" align=center>14h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Physical Offset</td>
   <td width="65%">
   физическое смещение относительно начала EXE файла, выровнено на границу
   File align поля заголовка PE Header. Смещение используется загрузчиком
   как seek значение.
   </td>
</tr>
<tr>
   <td width="5%" align=center>18h</td>
   <td width="10%" align=center>0Ch</td>
   <td width="20%">Reserved</td>
   <td width="65%">
   зарезервировано для OBJ файла, в экзешниках смысла не имеет
   </td>
</tr>
<tr>
   <td width="5%" align=center>28h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%"><a href="#Object_Flags">Object Flags</a></td>
   <td width="65%">
   битовые флаги секции, см.ниже
   </td>
</tr>
</table>

<table border width="100%">
<tr>
   <td width="30%" align=center><b>Total Structure size</b></td>
   <td width="5%" align=center><b>2Ch</b></td>
   <td width="65%">
   <b>Общий размер описателя секции</b>
   </td>
</tr>
</table>

<br><a name="Object_Name"><font size=+1><u>Object Name несколько примеров из жизни:</u></font></a>
<table>
<tr><td>.text</td><td>- сюда Микрософт бросает выполнимый код</td></tr>
<tr><td>CODE</td><td>- а Борланд любит это делать здесь</td></tr>
<tr><td>.icode</td><td>- переходники импорта старых версий TLINK32</td></tr>
<tr><td>.data</td><td>- Микрософт швыряет данные сюда</td></tr>
<tr><td>DATA</td><td>- а Борланд сюда</td></tr>
<tr><td>.bss</td><td>- неинициализированные данные (равна 0 в файле)</td></tr>
<tr><td>.CRT</td><td>- инициализированные данные C/C++ от Борланда</td></tr>
<tr><td>.rsrc</td><td>- ресурсы</td></tr>
<tr><td>.idata</td><td>- секция импорта</td></tr>
<tr><td>.edata</td><td>- секция экспорта</td></tr>
<tr><td>.reloc</td><td>- таблица настроек</td></tr>
<tr><td>.tls</td><td>- данные на базе которых Windows запускает цепочки</td></tr>
<tr><td>.rdata</td><td>- отладочная информация</td></tr>
<tr><td>_FREQASM</td><td>- посмотрите в KERNEL32, я думаю, и так понятно</td></tr>
<tr><td>PROTECTED</td><td>- это взято из Хасповского сервера, вот так</td></tr>
<tr><td>. . . . .</td><td>- и так далее</td></tr>
</table>

<br>Как  можно  заметить - имя секции значит некоторые вещи, но вообще-то не
определяет ничего ;-) Следует еще раз предупредить! Экзешник может содержать
одну  единственную  секцию,  в  которую  можно  натолкать  все.  И это будет
работать!
<br>
<br><a name="Object_Flags"><font size=+1><u>Object Flags имеет следующие значения:</u></font></a>
<ul>
<li>00000004h - используется для кода с 16 битными смещениями</li>
<li>00000020h - секция кода</li>
<li>00000040h - секция инициализированных данных</li>
<li>00000080h - секция неинициализированных данных</li>
<li>00000200h - комментарии или любой другой тип информации</li>
<li>00000400h - оверлейная секция</li>
<li>00000800h - не будет являться частью образа программы</li>
<li>00001000h - общие данные</li>
<li>00500000h - выравнивание по умолчанию, если не указано иное</li>
<li>02000000h - может быть выгружен из памяти</li>
<li>04000000h - не кэшируется</li>
<li>08000000h - не подвергается страничному преобразованию</li>
<li>10000000h - разделяемый</li>
<li>20000000h - выполнимый</li>
<li>40000000h - можно читать</li>
<li>80000000h - можно писать</li>
</ul>
Все   прочие  значения  зарезервированы  и  должны  быть  установлены  в  0.
Большинство   значений  в  Windows'95  не  используется,  наверняка  не  все
используются даже в NT.
<hr>
<br>
<br><a name="part040"><font size=+1><u>[4] Страницы образов секций (Image Pages)</u></font></a>
<br>
<br>Раздел  образов содержит все инициализированные данные для всех объектов
(секций).  Значения  позиционирования  для  начала  страницы каждого объекта
указаны  в таблице объектов (Object Table) и выравнены на границу File align
в заголовке PE Header. Объекты отсортированы в порядке их RVA и выравнены на
Object  align,  это  используется  для оптимизации загрузки, но можно данное
правило не соблюдать, загрузчик Windows'95 это не использует.
<br>Следует  отметить одну важную особенность, если где-то указан RVA, то не
подразумевая   его  расположение  надо  просканировать  таблицу  секций  для
определения  его  реального  места  в файле !!! Программы типа борландовской
TDUMP,  PEDUMP  (Мэтта Питрека) этого не делают и получают свое GPF пенальти
при  попытке  обработать  такие  файлы в которых RVA несколько отличается от
предполагаемых,  тем  не  менее  Windows'95  эти  файлы  прекрасно  грузит и
обрабатывает.  Это  не  ошибка!  Я  видел  гораздо  позднее файлы с подобной
структурой созданные компилятором Borland C++ (связано с импортом, это будет
обсуждено далее, но вовсе от импорта не зависит).
<br>Говоря  об  импорте  нужно указать на одну возможность, не рассмотренную
авторами Bizatch, впрочем об этом так-же ниже.
<hr>
<br>
<br><a name="part050"><font size=+1><u>[5] Экспорт</u></font></a>
<br>
<br>обычно секция экспорта приблизительно выглядит следующим образом:
<br>
<div align=right><font size=+1><u>Typical Export Layout</u></font></div>

<table border width="100%">
<tr>
   <td width="50%" align=center>Таблица собственно экспорта</td>
   <td width="50%" align=center><a href="#part051">Export Directory Table</a></td>
</tr>
<tr>
   <td width="50%" align=center>Адресная таблица</td>
   <td width="50%" align=center><a href="#part052">Export Address Table</a></td>
</tr>
<tr>
   <td width="50%" align=center>Таблица указателей на имена</td>
   <td width="50%" align=center><a href="#part053">Export Name Table Pointers</a></td>
</tr>
<tr>
   <td width="50%" align=center>Таблица ординалов</td>
   <td width="50%" align=center><a href="#part054">Export Ordinal Table</a></td>
</tr>
<tr>
   <td width="50%" align=center>Таблица самих имен</td>
   <td width="50%" align=center><a href="#part055">Export Name Table</a></td>
</tr>
</table>

<br>я сказал обычно, но я не сказал, что так должно быть, чуть ниже мы сейчас
рассмотрим  данные экспорта и механизм экспорта, сейчас замечу, что, как и с
именами  секций,  вышеописанную структуру вы найдете в нормальных исполнимых
файлах  (без наворотов). За исключением Export Directory Table все остальное
структурами можно назвать лишь с натяжкой.
<br>
<br><a name="part051"><font size=+1><u>[5.1] Таблица экспорта (Export Directory Table)</u></font></a>
<br>
<br>Информация   экспорта  начинается  с  Export  Directory  Table,  которая
описывает  требуемую  экспортную информацию. Export Directory Table содержит
адресную информацию используемую при развязке настраиваемых ссылок в внешние
точки входа внутри программы.
<br>
<div align=right><font size=+1><u>Export Directory Table</u></font></div>

<table border width="100%">
<tr>
   <td width="5%" align=center><b>Base</b></td>
   <td width="10%" align=center><b>Size or Type</b></td>
   <td width="20%"><b>Name Of field</b></td>
   <td width="65%"><b>Brief description</b></td>
</tr>
<tr>
   <td width="5%" align=center>00h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Flags</td>
   <td width="65%">
   зарезервировано на будущее = 0
   </td>
</tr>
<tr>
   <td width="5%" align=center>04h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Time/Date Stamp</td>
   <td width="65%">
   время и дата создания экспортных данных
   </td>
</tr>
<tr>
   <td width="5%" align=center>08h</td>
   <td width="10%" align=center>Word</td>
   <td width="20%">Major Version</td>
   <td width="65%">
   опять для нас, блин, старший номер версии таблицы экспорта
   <br>как хочешь, так и используй
   </td>
</tr>
<tr>
   <td width="5%" align=center>0Ah</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Minor Version</td>
   <td width="65%">
   аналогично, младший
   </td>
</tr>
<tr>
   <td width="5%" align=center>0Ch</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Name RVA</td>
   <td width="65%">
   RVA строки указывающей на имя нашей библиотеки
   </td>
</tr>
<tr>
   <td width="5%" align=center>10h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Ordinal Base</td>
   <td width="65%">
   начальный номер экспорта, для функций нашей библиотеки,
   обычно установлено в 1, но не факт
   </td>
</tr>
<tr>
   <td width="5%" align=center>14h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Num of Functions</td>
   <td width="65%">
   количество функций экспортируемых нашим модулем, является числом элементов
   массива Address Table см.ниже
   </td>
</tr>
<tr>
   <td width="5%" align=center>18h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Num of Name Pointers</td>
   <td width="65%">
   число указателей на имена, обычно равно числу функций, но это не так,
   если у нас есть функции экспортируемые только по номеру
   </td>
</tr>
<tr>
   <td width="5%" align=center>1Ch</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%"><a href="#part052">Address Table RVA</a></td>
   <td width="65%">
   указатель на таблицу адресов (RVA) экспорта
   </td>
</tr>

<tr>
   <td width="5%" align=center>20h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%"><a href="#part053">Name Pointers RVA</a></td>
   <td width="65%">
   указатель на таблицу указателей на имена экспорта
   </td>
</tr>

<tr>
   <td width="5%" align=center>24h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%"><a href="#part054">Ordinal Table RVA</a></td>
   <td width="65%">
   указатель на таблицу ординалов экспорта, данный массив по индексам
   параллелен Name Pointers, элементами являются слова
   </td>
</tr>
</table>

<table border width="100%">
<tr>
   <td width="30%" align=center><b>Total Structure size</b></td>
   <td width="5%" align=center><b>28h</b></td>
   <td width="65%">
   <b>Общий размер таблички экспорта</b>
   </td>
</tr>
</table>

<br>Для обработки запросов на связывание загрузчик системы ищет:
<ul>
<li>импорт по имени: имя в массиве имен, по его индексу ординал, ординал
    корректируется на базу и этим индексом вычитывается адрес функции
    из поля массива Address Table</li>
<li>импорт по ординалу: ординал корректируется на базу и далее,
    как описано выше</li>
</ul>
<br>Надо  отметить,  что  таблица экспорта может содержать пропуски, которые
отображаются   нулевыми   значениями   адресов  экспорта.  Импортировать  по
ординалам  очень  нежелательно  ибо  в  разных  версиях  Windows'95 ординалы
функций в модулях различаются, не говоря уже об NT и проч.
<br>
<br><a name="part052"><font size=+1><u>[5.2] Таблица адресов экспорта (Address Table)</u></font></a>
<br>
<br>Данная структура данных содержит адреса экспортируемых функций (их точки
входа)  экпортируемых  данных  и  т.п.  в  формате  DWord RVA (по 4 байта на
элемент).  Для доступа к данным используется ординал функции с коррекцией на
базу ординалов (Ordinal Base).
<br>
<br><a name="part053"><font size=+1><u>[5.3] Таблица указателей на имена (Name Table Pointers)</u></font></a>
<br>
<br>Данная  структура  содержит  указатели  на имена экспортируемых функций,
указатели  отсортированы  в  лексическом порядке для обеспечения возможности
бинарного  поиска.  Каждый  указатель занимает 4 байта. Имена функций обычно
лежат  в секции экспорта, но я опять сказал обычно ;-) Вы их можете помещать
не  туда.  Еще  раз  повторюсь,  секции  -  нечто  эфемерное, обеспечивающее
упаковку программы в файле и защиту участков кода, но не больше.
<br>
<br><a name="part054"><font size=+1><u>[5.4] Таблица ординалов (Ordinal Table)</u></font></a>
<br>
<br>Данная   структура   совместно   с   Name   Table  Pointers  формирует 2
параллельных   массива,   разделенных   для   облегчения   к   ним   доступа
индексированием на родные для процессора данные (слова, двойные слова, но не
сложные  структуры).  Данный  массив  содержит  ординалы экспорта, которые в
общем  случае  являются  индексами в Address Table экспорта (за вычетом базы
Ordinal Base). Элементами данного массива являются слова (2 байта).
<br>
<br><a name="part055"><font size=+1><u>[5.5] Таблица имен экспорта (Export Name Table)</u></font></a>
<br>
<br>Эта  таблица  содержит  необязательные (по мнению Microsoft, ничего себе
;-) имена экспортируемых функций. Данный массив используется для совместно с
Name  Table  Pointers и Ordinal Table для обеспечения связывания загрузчиком
импорта/экспорта  по  имени. Механизм описывался выше. Каждый элемент являет
собой  ASCIZ  строку  с именем экспортируемой функции. Никто не говорит, что
они должны в файле идти друг за другом последовательно, хотя так и построено
большинство  файлов.  Надо  отметить,  что  имена  экспорта  чувствительны к
регистру.
<br>Отметим  особенность  загрузчика  -  при  связывании, если адрес функции
находится  в  секции  экспорта,  то на самом деле по указанному адресу лежит
строка  переадресующая  к другой библиотеке экспортирующей данную функцию (с
указанием  библиотеки  и  самой  функции),  это называется передача экспорта
(если верить Мэту Питреку, я данную фичу еще не проверял).
<hr>
<br>
<br><a name="part060"><font size=+1><u>[6] Импорт</u></font></a>
<br>
<br>Мы  подходим  к  самому  интересному  разделу  данного файла и любого PE
исполнимого  файла.  По  сравнению  со  старыми  16 битными приложениями все
значительно  упростилось  - мы говорим системе о том, что мы хотим вызвать и
откуда,  а  система  в  нужное  место  нашей  программы  предоставляет адрес
перехода (внутри нашей FLAT памяти виртуальной машины). Все. Далее адрес уже
используют  по  разному. Borland строит самостоятельно в секции кода (точнее
линкер) переходники вида
<br>&nbsp; &nbsp; &nbsp;SomeThunkGate: Jmp D,[0XXXXXXXXh]
<br>и все ссылки в программе оформляются:
<br>&nbsp; &nbsp; &nbsp;Call SomeThunkGate
<br>При  этом задача организации импорта возлагается на линковщик (напомним,
Borland  использует  старый  OMF  формат).  Прародители  метода пошли другим
путем.  Переходники  содержатся  в  библиотеке  импорта  и  являются  частью
библиотеки.  Линкер  просто компонует ее в программу, причем с помощью одной
хитрой   особенности:   имена  секций  содержащие  в  себе  знак  '$'  могут
объединяться  с  отсечением  оставшейся  части имени (секции упорядочиваются
перед  слиянием по оставшейся части имени). Линкеру остается лишь из чего-то
вроде  .idata$1  .idata$2 .idata$3 составить одну удобоваримую секцию .idata
Следует  еще  добавить, Microsoft в своих программах часто организует вызовы
внешних  функций  несколько  иным  образом:  вместо Near вызова переходников
используется непосредственно требуемый адрес, примерно так
<br>&nbsp; &nbsp; &nbsp;Call DWord Ptr [SomeServiceAddressVariable]
<br>или так
<br>&nbsp; &nbsp; &nbsp;Mov ESi,SomeServiceAddressValue
<br>&nbsp; &nbsp; &nbsp;Call ESi
<br>&nbsp; &nbsp; &nbsp;...
<br>&nbsp; &nbsp; &nbsp;Call ESi
<br>создавшие формат да создадут удобный компилятор ;-)
<br>
<br><a name="part061"><font size=+1><u>[6.1] Каталог импорта (Import Directory Table)</u></font></a>
<br>
<br>Информация   импорта   начинается  с  Import  Directory  Table,  которая
описывает  остальную  информацию об импорте. Import Directory Table содержит
адресную информацию используемую для разрешения ссылок на точки входа внутри
образа  библиотеки. Таблица импорта состоит из отдельных входов, как минимум
по одному на каждую импортируемую библиотеку. Последний вход, указывающий на
конец таблицы является пустым (заполнен нулями).
<br>В  "нормальных"  файлах  вся  информация об импорте предворяется записью
Import  Directory  Table  (но физически вы можете разместить эту таблицу где
угодно). Дело обстоит примерно так:
<br>
<div align=right><font size=+1><u>Typical Import Layout</u></font></div>

<table border width="100%">
<tr>
   <td width="50%" align=center>Каталог импорта</td>
   <td width="50%" align=center>Import Directory Table</td>
</tr>
<tr>
   <td width="50%" align=center>Таблица ссылок на имена</td>
   <td width="50%" align=center><a href="#part062">LookUp Table</td>
</tr>
<tr>
   <td width="50%" align=center>Таблица имен</td>
   <td width="50%" align=center><a href="#part062">Hint-Name Table</td>
</tr>
<tr>
   <td width="50%" align=center>Таблица адресов импорта</td>
   <td width="50%" align=center><a href="#part063">Import Address Table</td>
</tr>
</table>

<br>это  приблизительная  последовательность  расположения в файле различных
частей  секции импорта, создаваемой существующими компоновщиками. В реальных
файлах  нет  никаких  ограничений  на  порядок  следования  участков  секции
импорта,  а  у  загрузчика  Windows'95  и  на расположение последних. Формат
одного входа каталога импорта приведен в таблице чуть ниже.
<br>
<div align=right><font size=+1><u>Import Directory Entry</u></font></div>

<table border width="100%">
<tr>
   <td width="5%" align=center><b>Base</b></td>
   <td width="10%" align=center><b>Size or Type</b></td>
   <td width="20%"><b>Name Of field</b></td>
   <td width="65%"><b>Brief description</b></td>
</tr>
<tr>
   <td width="5%" align=center>00h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%"><a href="#part062">Import LookUp</a></td>
   <td width="65%">
   Содержит ссылку на табличку RVA указывающих на соответствующие Hint-Name's
   или непосредственно ординал ипортируемого входа
   </td>
</tr>
<tr>
   <td width="5%" align=center>04h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Time/Date Stamp</td>
   <td width="65%">
   Отметка о времени создания, часто содержит 0 (У-уф)
   </td>
</tr>
<tr>
   <td width="5%" align=center>08h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Forward Chain</td>
   <td width="65%">
   <b>?</b> связано с возможностью передачи экспорта в другие библиотеки.
   Обычно равно 0FFFFFFFFh
   </td>
</tr>
<tr>
   <td width="5%" align=center>0Ch</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Name RVA</td>
   <td width="65%">
   Ссылка на библиотеку с которой нам необходимо поиметь вызовы
   представлена в виде ASCIZ.
   </td>
</tr>
<tr>
   <td width="5%" align=center>10h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%"><a href="#part063">Addres Table RVA</a></td>
   <td width="65%">
   Ссылка на табличку адресов импорта, заполняется системой при связывании
   </td>
</tr>
</table>

<table border width="100%">
<tr>
   <td width="30%" align=center><b>Total Structure size</b></td>
   <td width="5%" align=center><b>14h</b></td>
   <td width="65%">
   <b>Общий размер таблички импорта</b>
   </td>
</tr>
</table>

<br><a name="part062"><font size=+1><u>[6.2] Таблица просмотра импорта (Import LookUp Table)</u></font></a>
<br>
<br>Имена  сервисов  библиотеки  содержатся  в  Hint-Name's Table. Ее формат
довольно прост:
<br>
<div align=right><font size=+1><u>Hint-Name Entry</u></font></div>

<table border width="100%">
<tr>
   <td width="10%" align=center>Word<hr>Hint
   </td>
   <td width="30%" align=center>Размер произвольный<hr>ASCIZ Service Name
   </td>
   <td width="10%" align=center>Byte<hr>PAD
   </td>
   <td width="50%">
   Строка закрывается нулевым байтом, и при необходимости ее длинна
   выравнивается до четной границы еще одним 0
   </td>
</tr>
</table>

<br>На  имена  сервисов  и  ссылаются RVA из таблицы Import LookUp. В случае
импорта   по  ординалам  старший  бит  значения  из  таблицы  Import  LookUp
установлен  в  единицу.  Конец  таблицы  находится по нулевому элементу. При
попытке  связывания по имени системный загрузчик использует вначале значение
Hint  (укороченный идентификатор точки входа) и только при неудачной попытке
его  использования  производит  в  своих  системных таблицах поиск требуемой
точки входа. Имя сервиса чувствительно к регистру. Имя библиотеки - нет.
<br>
<br><a name="part063"><font size=+1><u>[6.3] Таблица адресов импорта (Import Address Table)</u></font></a>
<br>
<br>Данная  таблица принимает в себя информацию после связывания загрузчиком
импорта  из  внешних  библиотек,  она  завершается  нулевым элементом. Очень
интересным  фактом  является то, что во многих программах она уже заполнена.
Это  справедливо,  по  меньшей мере, для программ самой Windows'95. Подобный
факт  заставляет предполагать, что загрузчик может не выполнять утомительной
процедуры  настройки  во многих случаях. Ему будет необходимо лишь загрузить
файл  в  ОЗУ  и  передать  туда управление... Да здравствует вечно живой COM
формат!
<br>Да, еще, для перехвата функции из библиотеки можно поменять адрес в этой
таблице  -  довольно  простой  и  общий  метод  перехвата  управления внутри
отдельного  процесса.  И  еще  пара плюшек на заметку, данная таблица (как и
многие другие таблицы импорта) может находиться на своем старом месте, а вот
Import  Directory  Table имеет смысл изменить, перенести в требуемое место и
там  оставить.  Файл  корректируется  минимально, а проблемы возникающие при
этом весьма незначительны и я их описывал.
<hr>
<br>
<br><a name="part070"><font size=+1><u>[7] Локальная область данных цепочек (Thread Local Storage)</u></font></a>
<br>
<br>Локальная  область  данных  цепочек,  это  специальный  протяженный блок
данных.  Каждая  цепочка  получит  собственный  блок при своем создании. Вот
примерная структура данной области:
<br>
<div align=right><font size=+1><u>Typical TLS Layout</u></font></div>

<table border width="100%">
<tr>
   <td width="50%" align=center>Таблица разделов цепочек</td>
   <td width="50%" align=center>TLS Directory Table</td>
</tr>
<tr>
   <td width="50%" align=center>Данные цепочек</td>
   <td width="50%" align=center>TLS Data</td>
</tr>
<tr>
   <td width="50%" align=center>Индексные переменные</td>
   <td width="50%" align=center>Index Variables</td>
</tr>
<tr>
   <td width="50%" align=center>Адреса обратных вызовов</td>
   <td width="50%" align=center>CallBack Addresses</td>
</tr>
</table>

<br><a name="part071"><font size=+1><u>[7.1] Таблица разделов цепочек (TLS Directory table)</u></font></a>
<br>
<br>TLS  Directory  Table содержит адресную информацию, которая используется
при описании остальной части TLS. Она имеет следующий формат:
<br>
<div align=right><font size=+1><u>TLS Directory Table</u></font></div>

<table border width="100%">
<tr>
   <td width="5%" align=center><b>Base</b></td>
   <td width="10%" align=center><b>Size or Type</b></td>
   <td width="20%"><b>Name Of field</b></td>
   <td width="65%"><b>Brief description</b></td>
</tr>
<tr>
   <td width="5%" align=center>00h</td>
   <td width="10%" align=center>Dword</td>
   <td width="20%">Start Data Block VA</td>
   <td width="65%">
   Виртуальный адрес начала блока данных цепочки
   </td>
</tr>
<tr>
   <td width="5%" align=center>04h</td>
   <td width="10%" align=center>Dword</td>
   <td width="20%">End Data Block VA</td>
   <td width="65%">
   Виртуальный адрес конца блока данных цепочки
   </td>
</tr>
<tr>
   <td width="5%" align=center>08h</td>
   <td width="10%" align=center>Dword</td>
   <td width="20%">Index VA</td>
   <td width="65%">
   Виртуальный адрес индексной переменной, используемой для доступа
   к локальному блоку данных цепочки
   </td>
</tr>
<tr>
   <td width="5%" align=center>0Ch</td>
   <td width="10%" align=center>Dword</td>
   <td width="20%"><a href="#part072">CallBack Table VA</a></td>
   <td width="65%">
   Виртуальный адрес таблицы обратных вызовов
   </td>
</tr>
</table>

<table border width="100%">
<tr>
   <td width="30%" align=center><b>Total Structure size</b></td>
   <td width="5%" align=center><b>10h</b></td>
   <td width="65%">
   <b>Общий размер таблички TLS</b>
   </td>
</tr>
</table>

<br><a name="part072"><font size=+1><u>[7.2] Таблица обратных вызовов цепочки (TLS CallBack Table)</u></font></a>
<br>
<br>Локальные  обратные вызовы - массив виртуальных адресов функций, которые
будут   вызваны  загрузчиком  после  создания  цепочки  (нити)  и  после  ее
завершения.  Последний  вход  имеет  нулевое  значение  и  указыает на конец
таблицы.
<hr>
<br>
<br><a name="part080"><font size=+1><u>[8] Ресурсы</u></font></a>
<br>
<br>Ресурсы   представляют   собой   многоуровневое  двоично-отсортированное
дерево.  Их  спроектированная структура позволяет содержать до 2^31 уровней,
однако,  реально используется только 3: самый верхний есть Type, затем Name,
и затем Language (тип, имя, язык). Типичное представление ресурсного участка
в файлах:
<br>
<br>
<div align=right><font size=+1><u>Typical Resources Layout</u></font></div>

<table border width="100%">
<tr>
   <td width="50%" align=center>Каталог ресурсов</td>
   <td width="50%" align=center>Resources Directory Table</td>
</tr>
<tr>
   <td width="50%" align=center>Данные ресурсов</td>
   <td width="50%" align=center>Resources Data</td>
</tr>
</table>

<br>Структуру каталога ресурсов рассмотрим ниже.
<br>
<br><a name="part081"><font size=+1><u>[8.1] Каталог ресурсов (Resource Directory Table)</u></font></a>
<br>
<div align=right><font size=+1><u>Resource Directory Table</u></font></div>

<table border width="100%">
<tr>
   <td width="5%" align=center><b>Base</b></td>
   <td width="10%" align=center><b>Size or Type</b></td>
   <td width="20%"><b>Name Of field</b></td>
   <td width="65%"><b>Brief description</b></td>
</tr>
<tr>
   <td width="5%" align=center>00h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Flags</td>
   <td width="65%">
   Пока не используются, должны быть сброшены в 0
   </td>
</tr>
<tr>
   <td width="5%" align=center>04h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Time/Date Stamp</td>
   <td width="65%">
   Дата и время подключения ресурсов от ресурсного компилятора
   </td>
</tr>
<tr>
   <td width="5%" align=center>08h</td>
   <td width="10%" align=center>Word</td>
   <td width="20%">Major Version</td>
   <td width="65%">
   Уугу, опять для нас номер версии, старший по счету
   </td>
</tr>
<tr>
   <td width="5%" align=center>0Ah</td>
   <td width="10%" align=center>Word</td>
   <td width="20%">Minor Version</td>
   <td width="65%">
   --//-- и младший
   </td>
</tr>
<tr>
   <td width="5%" align=center>0Ch</td>
   <td width="10%" align=center>Word</td>
   <td width="20%">Name Entry</td>
   <td width="65%">
   Количество входов в таблицу имен ресурсов, таблица располагается в самом
   начале массива входов и содержит строковые имена ассоциируемые с ресурсами
   </td>
</tr>
<tr>
   <td width="5%" align=center>0Eh</td>
   <td width="10%" align=center>Word</td>
   <td width="20%">ID_Num Entry</td>
   <td width="65%">
   Количество 32-битовых идентификаторов ресурсов
   </td>
</tr>
</table>

<table border width="100%">
<tr>
   <td width="30%" align=center><b>Total Structure size</b></td>
   <td width="5%" align=center><b>10h</b></td>
   <td width="65%">
   <b>Размер каталога ресурсов</b>
   </td>
</tr>
</table>

<br>За каталогом ресурсов сразу следует массив переменной длинны, содержащий
ресурсные  входы.  Name  Entry содержит число ресурсных входов имеющих имена
(связанные  с каждым входом). Имена нечувствительны к регистру и расположены
в  порядке  возрастания.  ID_Num  Entry  определяет  число  входов имеющих в
качестве  имени  32-битовый идентификатор. Эти входы так же отсортированы по
возрастанию.  Данная  структура позволяет получать быстрый доступ к ресурсам
по  имени или по идентификатору, но для отдельно взятого ресурса только одна
из  форм  поиска поддерживается, не обе! Это согласуется с синтаксисом .RC и
.RES файлов. Каждый вход в таблице ресурсов имеет следующий формат:
<br>
<div align=right><font size=+1><u>Resource Entry Item</u></font></div>

<table border width="100%">
<tr>
   <td width="5%" align=center><b>Base</b></td>
   <td width="10%" align=center><b>Size or Type</b></td>
   <td width="20%"><b>Name Of field</b></td>
   <td width="65%"><b>Brief description</b></td>
</tr>
<tr>
   <td width="5%" align=center>00h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Name RVA or Res ID</td>
   <td width="65%">
   Поле содержит либо идентификатор ресурса, либо указатель на его имя
   в таблице имен ресурсов
   </td>
</tr>
<tr>
   <td width="5%" align=center>04h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Data Entry RVA or SubDirectory RVA</td>
   <td width="65%">
   Указывает либо на данные, либо на еще одну таблицу входов ресурсов,
   31-бит сброшенный в 0 указывает на то, что это ссылка на данные и наоборот
   </td>
</tr>
</table>

<table border width="100%">
<tr>
   <td width="30%" align=center><b>Total Structure size</b></td>
   <td width="5%" align=center><b>08h</b></td>
   <td width="65%">
   <b>Размер ресурсного входа</b>
   </td>
</tr>
</table>

<br>Строки каталога ресурсов имеют следующий формат:
<br>
<div align=right><font size=+1><u>Resource Directory String Entry</u></font></div>

<table border width="100%">
<tr>
   <td width="10%" align=center>File Name:<hr>File Type:
   </td>
   <td width="10%" align=center>Length<hr>Word
   </td>
   <td width="30%" align=center>Unicode String<hr>unpredictable
   </td>
   <td width="50%">
   длинна строки должна быть кратна 2 (это очевидно) Все такие строковые
   объекты часто хранят вместе
   </td>
</tr>
</table>

<br>Строки  каталога  ресурсов размещают после последнего Resource Directory
Entry  но  до  первого  Resource  Data  Item,  это позволяет более компактно
разместить информацию. Каждый пункт данных имеет следующий формат:
<br>
<div align=right><font size=+1><u>Resource Entry Item</u></font></div>

<table border width="100%">
<tr>
   <td width="5%" align=center><b>Base</b></td>
   <td width="10%" align=center><b>Size or Type</b></td>
   <td width="20%"><b>Name Of field</b></td>
   <td width="65%"><b>Brief description</b></td>
</tr>
<tr>
   <td width="5%" align=center>00h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Data RVA</td>
   <td width="65%">
   Указатель на реально расположенные данные относительно Image Base
   </td>
</tr>
<tr>
   <td width="5%" align=center>04h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Size</td>
   <td width="65%">
   Размер ресурсных данных
   </td>
</tr>
<tr>
   <td width="5%" align=center>08h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">CodePage</td>
   <td width="65%">
   Кодовая страница
   </td>
</tr>
<tr>
   <td width="5%" align=center>0Ch</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Reserved</td>
   <td width="65%">
   Не используется и устанавливается в 0
   </td>
</tr>
</table>

<table border width="100%">
<tr>
   <td width="30%" align=center><b>Total Structure size</b></td>
   <td width="5%" align=center><b>10h</b></td>
   <td width="65%">
   <b>Размер указателя данные ресурса</b>
   </td>
</tr>
</table>

<br>Каждый  вход  в  таблице  ресурсов  описывает узел в дереве ресурсов. Он
содержит  адрес  относительно Image Base, поле Size указывает на число байов
данных  находящихся  по  этому  адресу,  а кодовая страница используется для
расшифровки   ключевых   значений  внутри  ресурсных  данных.  Обычно  новые
приложения содержат значение соответствующее Unicode кодовой таблице. (хотя,
хм. Обычно?)
<br>
<br><a name="part082"><font size=+1><u>[8.2] Пример структуры размещения ресурсов</u></font></a>
<br>
<br>Приведем пример приложения которое хочет использовать следующие данные в
качестве ресурсов:
<br>
<br>
<table border width="42%">
<tr>
   <td width="10%" align=center><b>Тип</b></td>
   <td width="10%" align=center><b>Имя</b></td>
   <td width="5%" align=center><b>Язык</b></td>
   <td width="17%" align=center><b>Данные ресурса</b></td>
</tr>
<tr>
   <td width="10%" align=center>00000001</td>
   <td width="10%" align=center>00000001</td>
   <td width="5%" align=center>0</td>
   <td width="17%" align=center>00010001</td>
</tr>
<tr>
   <td width="10%" align=center>00000001</td>
   <td width="10%" align=center>00000001</td>
   <td width="5%" align=center>1</td>
   <td width="17%" align=center>10010001</td>
</tr>
<tr>
   <td width="10%" align=center>00000001</td>
   <td width="10%" align=center>00000002</td>
   <td width="5%" align=center>0</td>
   <td width="17%" align=center>00010002</td>
</tr>
<tr>
   <td width="10%" align=center>00000001</td>
   <td width="10%" align=center>00000003</td>
   <td width="5%" align=center>0</td>
   <td width="17%" align=center>00010003</td>
</tr>
<tr>
   <td width="10%" align=center>00000002</td>
   <td width="10%" align=center>00000001</td>
   <td width="5%" align=center>0</td>
   <td width="17%" align=center>00010001</td>
</tr>
<tr>
   <td width="10%" align=center>00000002</td>
   <td width="10%" align=center>00000002</td>
   <td width="5%" align=center>0</td>
   <td width="17%" align=center>00020002</td>
</tr>
<tr>
   <td width="10%" align=center>00000002</td>
   <td width="10%" align=center>00000003</td>
   <td width="5%" align=center>0</td>
   <td width="17%" align=center>00020003</td>
</tr>
<tr>
   <td width="10%" align=center>00000002</td>
   <td width="10%" align=center>00000004</td>
   <td width="5%" align=center>0</td>
   <td width="17%" align=center>00020004</td>
</tr>
<tr>
   <td width="10%" align=center>00000009</td>
   <td width="10%" align=center>00000001</td>
   <td width="5%" align=center>0</td>
   <td width="17%" align=center>00090001</td>
</tr>
<tr>
   <td width="10%" align=center>00000009</td>
   <td width="10%" align=center>00000009</td>
   <td width="5%" align=center>0</td>
   <td width="17%" align=center>00090009</td>
</tr>
<tr>
   <td width="10%" align=center>00000009</td>
   <td width="10%" align=center>00000009</td>
   <td width="5%" align=center>1</td>
   <td width="17%" align=center>10090009</td>
</tr>
<tr>
   <td width="10%" align=center>00000009</td>
   <td width="10%" align=center>00000009</td>
   <td width="5%" align=center>2</td>
   <td width="17%" align=center>20090009</td>
</tr>
</table>

<br>Тогда ресурсный каталог в PE файле будет выглядеть следующим образом:
<br>
<br>
<table border width="100%">
<tr>
   <td width="10%" align=center><b>Смещение</b></td>
   <td width="90%"><b>Данные</b></td>
</tr>
<tr>
   <td width="10%" align=center valign="top">0000:</td>
   <td width="90%">
   00000000 00000000 00000000 00030000  (3 входа в этом каталоге)
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">0010:</td>
   <td width="90%">
   00000001 80000028     (Тип #1, Подкаталог по смещению 0x28)
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">0018:</td>
   <td width="90%">
   00000002 80000050     (Тип #2, Подкаталог по смещению 0x50)
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">0020:</td>
   <td width="90%">
   00000009 80000080     (Тип #9, Подкаталог по смещению 0x80)
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">0028:</td>
   <td width="90%">
   00000000 00000000 00000000 00030000  (3 входа в этом каталоге)
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">0038:</td>
   <td width="90%">
   00000001 800000A0     (Имя #1, Подкаталог по смещению 0xA0)
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">0040:</td>
   <td width="90%">
   00000002 00000108     (Имя #2, дескриптор данных по смещению 0x108)
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">0048:</td>
   <td width="90%">
   00000003 00000118     (Имя #3, дескриптор данных по смещению 0x118)
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">0050:</td>
   <td width="90%">
   00000000 00000000 00000000 00040000  (4 входа в этом каталоге)
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">0060:</td>
   <td width="90%">
   00000001 00000128     (Имя #1, дескриптор данных по смещению 0x128)
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">0068:</td>
   <td width="90%">
   00000002 00000138     (Имя #2, дескриптор данных по смещению 0x138)
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">0070:</td>
   <td width="90%">
   00000003 00000148     (Имя #3, дескриптор данных по смещению 0x148)
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">0078:</td>
   <td width="90%">
   00000004 00000158     (Имя #4, дескриптор данных по смещению 0x158)
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">0080:</td>
   <td width="90%">
   00000000 00000000 00000000 00020000  (2 входа в этом каталоге)
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">0090:</td>
   <td width="90%">
   00000001 00000168     (Имя #1, дескриптор данных по смещению 0x168)
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">0098:</td>
   <td width="90%">
   00000009 800000C0     (Имя #9, Подкаталог по смещению 0xC0)
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">00A0:</td>
   <td width="90%">
   00000000 00000000 00000000 00020000  (2 входа в этом каталоге)
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">00B0:</td>
   <td width="90%">
   00000000 000000E8     (Язык 0, дескриптор данных по смещению 0xE8)
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">00B8:</td>
   <td width="90%">
   00000001 000000F8     (Язык 1, дескриптор данных по смещению 0xF8)
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">00C0:</td>
   <td width="90%">
   00000000 00000000 00000000 00030000  (3 входа в этом каталоге)
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">00D0:</td>
   <td width="90%">
   00000001 00000178     (Язык 0, дескриптор данных по смещению 0x178)
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">00D8:</td>
   <td width="90%">
   00000001 00000188     (Язык 1, дескриптор данных по смещению 0x188)
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">00E0:</td>
   <td width="90%">
   00000001 00000198     (Язык 2, дескриптор данных по смещению 0x198)
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">00E8:</td>
   <td width="90%">
          000001A8  (По смещению 0x1A8, для Тип #1, Имя #1, Язык #0)
      <br>00000004  (4 байта данных)
      <br>00000000  (кодовая страница)
      <br>00000000  (зарезервировано)
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">00F8:</td>
   <td width="90%">
          000001AC  (По смещению 0x1AC, для Тип #1, Имя #1, Язык #1)
      <br>00000004  (4 байта данных)
      <br>00000000  (кодовая страница)
      <br>00000000  (зарезервировано)
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">0108:</td>
   <td width="90%">
          000001B0  (По смещению 0x1B0, для Тип #1, Имя #2,
      <br>00000004  (4 байта данных)
      <br>00000000  (кодовая страница)
      <br>00000000  (зарезервировано)
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">0118:</td>
   <td width="90%">
          000001B4  (По смещению 0x1B4, для Тип #1, Имя #3,
      <br>00000004  (4 байта данных)
      <br>00000000  (кодовая страница)
      <br>00000000  (зарезервировано)
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">0128:</td>
   <td width="90%">
          000001B8  (По смещению 0x1B8, для Тип #2, Имя #1,
      <br>00000004  (4 байта данных)
      <br>00000000  (кодовая страница)
      <br>00000000  (зарезервировано)
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">0138:</td>
   <td width="90%">
          000001BC  (По смещению 0x1BC, для Тип #2, Имя #2,
      <br>00000004  (4 байта данных)
      <br>00000000  (кодовая страница)
      <br>00000000  (зарезервировано) 0
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">0148:</td>
   <td width="90%">
          000001C0  (По смещению 0x1C0, для Тип #2, Имя #3,
      <br>00000004  (4 байта данных)
      <br>00000000  (кодовая страница)
      <br>00000000  (зарезервировано)
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">0158:</td>
   <td width="90%">
          000001C4  (По смещению 0x1C4, для Тип #2, Имя #4,
      <br>00000004  (4 байта данных)
      <br>00000000  (кодовая страница)
      <br>00000000  (зарезервировано)
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">0168:</td>
   <td width="90%">
          000001C8  (По смещению 0x1C8, для Тип #9, Имя #1,
      <br>00000004  (4 байта данных)
      <br>00000000  (кодовая страница)
      <br>00000000  (зарезервировано)
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">0178:</td>
   <td width="90%">
          000001CC  (По смещению 0x1CC, для Тип #9, Имя #9, Язык #0
      <br>00000004  (4 байта данных)
      <br>00000000  (кодовая страница)
      <br>00000000  (зарезервировано)
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">0188:</td>
   <td width="90%">
          000001D0  (По смещению 0x1D0, для Тип #9, Имя #9, Язык #1
      <br>00000004  (4 байта данных)
      <br>00000000  (кодовая страница)
      <br>00000000  (зарезервировано)
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">0198:</td>
   <td width="90%">
          000001D4  (По смещению 0x1D4, для Тип #9, Имя #9, Язык #2
      <br>00000004  (4 байта данных)
      <br>00000000  (кодовая страница)
      <br>00000000  (зарезервировано)
   </td>
</tr>
</table>

<br>Ну а данные для ресурсов будут таковыми:
<br>
<table width="40%">
<tr>
   <td width="10%" align=center valign="top">01A8:</td>
   <td width="30%">
   00010001
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">01AC:</td>
   <td width="30%">
   10010001
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">01B0:</td>
   <td width="30%">
   00010002
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">01B4:</td>
   <td width="30%">
   00010003
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">01B8:</td>
   <td width="30%">
   00020001
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">01BC:</td>
   <td width="30%">
   00020002
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">01C0:</td>
   <td width="30%">
   00020003
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">01C4:</td>
   <td width="30%">
   00020004
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">01C8:</td>
   <td width="30%">
   00090001
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">01CC:</td>
   <td width="30%">
   00090009
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">01D0:</td>
   <td width="30%">
   10090009
   </td>
</tr>
<tr>
   <td width="10%" align=center valign="top">01D4:</td>
   <td width="30%">
   20090009
   </td>
</tr>
</table>
<hr>
<br>
<br><a name="part090"><font size=+1><u>[9] Таблица настроек адресов (FixUp Table)</u></font></a>
<br>
<br>Таблица  настроек  адресов  содержит  элементы  для  всех  фиксированных
адресов  в  образе  программы. Поле в заголовке PE файла с названием FixUp's
Data  Size  содержит  общий  размер  в  байтах  данной таблицы. Сама таблица
настроет  адресов  разбита  на  блоки  настроек  (каждый  блок  представляет
настройки для 4-х килобайтовой страницы).
<br>Связанные  линкером  адреса  не  нуждаются  в  дополнительной  настройке
загрузчиком  до  тех  пор, пока загрузчик в состоянии загрузить программу по
адресу, указанному в ее заголовке. При невыполнении этого условия загрузчику
прийдется  корректировать  адреса в программе. С учетом FLAT модели памяти и
виртуализации адресного пространства для каждого процесса загрузчику никогда
не  прийдется  изменять  эти  адреса, исключением могут являться библиотеки,
которые  многое  компиляторы  привязывают  к  одному  фиксированному  адресу
(Borland например), либо случайные конфликты в адресах библиотек.
<br>
<br><a name="part091"><font size=+1><u>[9.1] Блок настроек перемещений (FixUp Block)</u></font></a>
<br>
<br>Блок настроек имеет следующий довольно простой формат:
<br>
<div align=right><font size=+1><u>FixUp Block</u></font></div>

<table border width="100%">
<tr>
   <td width="5%" align=center><b>Base</b></td>
   <td width="10%" align=center><b>Size or Type</b></td>
   <td width="20%"><b>Name Of field</b></td>
   <td width="65%"><b>Brief description</b></td>
</tr>
<tr>
   <td width="5%" align=center>00h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Page RVA</td>
   <td width="65%">
   Указатель на страницу применения настроек перемещений
   </td>
</tr>
<tr>
   <td width="5%" align=center>04h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Block Size</td>
   <td width="65%">
   Размер блока настроек (с заголовком)
   </td>
</tr>
<tr>
   <td width="5%" align=center>08h</td>
   <td width="10%" align=center>Word</td>
   <td width="20%"><a href="#TypeOffset">TypeOffset Record</a></td>
   <td width="65%">
   Массив записей настроек, их переменное количество
   </td>
</tr>
</table>

<table border width="100%">
<tr>
   <td width="30%" align=center><b>Total Structure size</b></td>
   <td width="5%" align=center><b>...</b></td>
   <td width="65%">
   <b>таблица имеет переменный размер</b>
   </td>
</tr>
</table>

<br>Для  наложения настройки необходимо вычислить Дельта-значение. 32-битное
Дельта  есть  разница  между  желаемой базой загрузки и действительной. Если
образ  программы  загружен в требуемое место, то Дельта равна нулю и никакой
настройки  произойти  не  может.  Каждый  блок настроек должен начинаться на
DWord  границе  (не  проверял),  для  выравнивания  блока можно пользоваться
нулями.
<br>При настройке необходимую позицию в блоке вычисляют как сумму Page RVA и
Image Base загруженной программы. TypeOffset определен следующим образом:
<br>
<a name="TypeOffset"><div align=right><font size=+1><u>TypeOffset Entry</u></font></div></a>

<table border width="100%">
<tr>
   <td width="15%" align=center>15 . . . 12<hr>Type
   </td>
   <td width="15%" align=center>11 . . . 0<hr>Offset
   </td>
   <td width="70%">
   Биты слова, Type указывает на тип настройки, а Offset на ее смещение
   внутри 4-килобайтового блока применимости настроек.
   </td>
</tr>
</table>

<br><font size=+1><u>Поле Type имеет следующие значения:</u></font>

<table widht="100%">
<tr>
   <td width="5%" valign="top">0h - </td>
   <td>адрес абсолютный и никаких изменений производить не требуется.
   </td>
</tr>
<tr>
   <td width="5%"valign="top">1h - </td>
   <td>добавить старшие 16 битов Дельты к 16 битовому полю находящемуся по
       смещению Offset. 16 битовое поле представляет старшие биты 32-битового
       слова.
   </td>
</tr>
<tr>
   <td width="5%"valign="top">2h - </td>
   <td>добавить младшие 16 битов Дельты по смещению Offset. 16-битовое поле
       представляет младшую половину 32-битового слова. Данная запись
       настройки присутствует только на RISC машине когда Object align не
       является по умолчанию 64К.
   </td>
</tr>
<tr>
   <td width="5%"valign="top">3h - </td>
   <td>прибавляет 32-битовое Дельта к 32-битовому значению.</td>
</tr>
<tr>
   <td width="5%"valign="top">4h - </td>
   <td>настройка требует полного 32-битового значения. Старшие 16-бит
       берутся по адресу Offset, а младшие в следующем элементе TypeOffset
       Все это объединяется в знаковую переменную, затем добавляется
       32-битовое дельта и DWord 8000h. Старшие 16 бит получившегося
       значения сохраняются по адресу Offset в 16-битовом поле.
   </td>
</tr>
<tr>
   <td width="5%"valign="top">5h - </td>
   <td>? что-то связанное с MIPS.</td>
</tr>
</table>

<br>В  реальной  жизни  я сталкивался только с типами 0 и 3, все остальные на
интелах  очевидно не столь юзабельны, интересное поле для экспериментов. Все
прочие типы перемещений зарезервированы Microsoft.
<hr>
<br>
<br><a name="part100"><font size=+1><u>[10] Отладочная информация (Debug Information)</u></font></a>
<br>
<br>Отладочная   информация   размещается   для  использования  отладчиком и
создается в пределах формата линкером. Единственная определенная структура -
Таблица  отладочной  информации  (Debug  Directory  Table).  PE  файлы также
поддерживают  COFF  информацию  для отладчика (соответствующие ссылки есть в
заголовке).  Здесь  будет  дано  очень сокращенное общее описание отладочной
информации в PE файлах.
<br>
<br><a name="part101"><font size=+1><u>[10.1] Отладочный каталог (Debug Directory)</u></font></a>
<br>
<br>В  каталоге  отладки  хранятся  ссылки  на прочую отладочную информацию,
формат его следующий:
<br>
<div align=right><font size=+1><u>Debug Directory Entry</u></font></div>

<table border width="100%">
<tr>
   <td width="5%" align=center><b>Base</b></td>
   <td width="10%" align=center><b>Size or Type</b></td>
   <td width="20%"><b>Name Of field</b></td>
   <td width="65%"><b>Brief description</b></td>
</tr>
<tr>
   <td width="5%" align=center>00h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Debug Flags</td>
   <td width="65%">
   Не используются и установлены в нулевое значение
   </td>
</tr>
<tr>
   <td width="5%" align=center>04h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Time/Date Stamp</td>
   <td width="65%">
   Дата и время создания отладочной информации
   </td>
</tr>
<tr>
   <td width="5%" align=center>08h</td>
   <td width="10%" align=center>Word</td>
   <td width="20%">Major Version</td>
   <td width="65%">
   Старший номер версии отладочной информации
   </td>
</tr>
<tr>
   <td width="5%" align=center>0Ah</td>
   <td width="10%" align=center>Word</td>
   <td width="20%">Minor Version</td>
   <td width="65%">
   Младший номер версии --//--
   </td>
</tr>
<tr>
   <td width="5%" align=center>0Ch</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%"><a href="#Debug_Type">Debug Type</a></td>
   <td width="65%">
   Тип информации для отладчика
   </td>
</tr>
<tr>
   <td width="5%" align=center>10h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Data Size</td>
   <td width="65%">
   Размер в байтах данных для отладки без размера заголовка
   </td>
</tr>
<tr>
   <td width="5%" align=center>14h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Data RVA</td>
   <td width="65%">
   Адрес расположения отладочных данных в ОЗУ
   </td>
</tr>
<tr>
   <td width="5%" align=center>18h</td>
   <td width="10%" align=center>DWord</td>
   <td width="20%">Data Seek</td>
   <td width="65%">
   Смещение к отладочным данным в файле
   </td>
</tr>
</table>

<table border width="100%">
<tr>
   <td width="30%" align=center><b>Total Structure size</b></td>
   <td width="5%" align=center><b>1Ch</b></td>
   <td width="65%">
   <b>Размер элемента каталога отладки</b>
   </td>
</tr>
</table>

<br>
<a name="#Debug_Type"><font size=+1><u>Тип отладочной информации:</u></font></a>
<ul>
<li>0000h - UNKNOWN/BORLAND (всегда они в стороне держатся, Inprise однако)</li>
<li>0001h - COFF таблица символов.</li>
<li>0002h - CodeView Таблица символов.</li>
<li>0003h - FPO таблица символов.</li>
<li>0004h - MISC &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \
</li>
<li>0005h - EXCEPTION &nbsp;&nbsp; > Эти три флага мною не проверялись!</li>
<li>0006h - FIXUP &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;/
</li>
</ul>

Если  в  программе  содержится  более  одного типа отладочной информации, то
следующая  запись в каталоге отладки будет следовать сразу за первой и иметь
не нулевое значение.
<hr>
<br>
<br><a name="part110"><font size=+1><u>[11] Вопросы не рассмотренные в данном описании</u></font></a>
<br>
<br>Несмотря  на  значительное  упрощение  формата  файла PE по сравнению со
старыми  NE  файлами,  он  все  еще  обширен  для  того,  чтобы влезть в это
маленькое    руководство.   Со   временем   описание   будет   расширяться и
корректироваться.  В  данный  момент  времени  за  бортом остались следующие
вопросы:
<ul>
<li>детальное рассмотрение отладочной информации</li>
<li>некоторые нюансы в описании полей заголовков</li>
<li>более полное рассмотрение реакции системы на загрузку файлов</li>
<li>что-то еще...</li>
</ul>
<hr>
<br>
<br><a name="part120"><font size=+1><u>[12] P.S.</u></font></a>
<br>
<br>Для  дальнейшего  пополнения  и  уточнения описания, а так же устранения
неоднозначностей  был  бы  признателен за любые конструктивные комментарии и
дополнения.  Прежде  чем писать ругательства, рекомендую посмотреть на рис.1
Меня можно найти следующим образом:
<br>
<br>
<center>
<a href="mailto:hardwisdom@geocities.com">H a r d   W i s d o m</a>
<hr width="40%">
Seek And Destroy!
</center>
<br>
<hr>
</body>
</html>