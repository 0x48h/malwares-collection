<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc3 {
	color: #008080;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">/* zip.c -- IO on .zip files using zlib
   Version 1.01e, February 12th, 2005

   27 Dec 2004 Rolf Kalbermatter
   Modification to zipOpen2 to support globalComment retrieval.

   Copyright (C) 1998-2005 Gilles Vollant

   Read zip.h for more info
*/</span><span class="sc0">


</span><span class="sc9">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;time.h&gt;
#include "zlib.h"
#include "zip.h"
</span><span class="sc0">
</span><span class="sc9">#ifdef STDC
#  include &lt;stddef.h&gt;
#  include &lt;string.h&gt;
#  include &lt;stdlib.h&gt;
#endif
#ifdef NO_ERRNO_H
</span><span class="sc0">    </span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">errno</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#else
#   include &lt;errno.h&gt;
#endif
</span><span class="sc0">

</span><span class="sc9">#ifndef local
#  define local static
#endif
</span><span class="sc1">/* compile with -Dlocal if your debugger can't find static symbols */</span><span class="sc0">

</span><span class="sc9">#ifndef VERSIONMADEBY
# define VERSIONMADEBY   (0x0) </span><span class="sc1">/* platform depedent */</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">
</span><span class="sc9">#ifndef Z_BUFSIZE
#define Z_BUFSIZE (16384)
#endif
</span><span class="sc0">
</span><span class="sc9">#ifndef Z_MAXFILENAMEINZIP
#define Z_MAXFILENAMEINZIP (256)
#endif
</span><span class="sc0">
</span><span class="sc9">#ifndef ALLOC
# define ALLOC(size) (malloc(size))
#endif
#ifndef TRYFREE
# define TRYFREE(p) {if (p) free(p);}
#endif
</span><span class="sc0">
</span><span class="sc1">/*
#define SIZECENTRALDIRITEM (0x2e)
#define SIZEZIPLOCALHEADER (0x1e)
*/</span><span class="sc0">

</span><span class="sc1">/* I've found an old Unix (a SunOS 4.1.3_U1) without all SEEK_* defined.... */</span><span class="sc0">

</span><span class="sc9">#ifndef SEEK_CUR
#define SEEK_CUR    1
#endif
</span><span class="sc0">
</span><span class="sc9">#ifndef SEEK_END
#define SEEK_END    2
#endif
</span><span class="sc0">
</span><span class="sc9">#ifndef SEEK_SET
#define SEEK_SET    0
#endif
</span><span class="sc0">
</span><span class="sc9">#ifndef DEF_MEM_LEVEL
#if MAX_MEM_LEVEL &gt;= 8
#  define DEF_MEM_LEVEL 8
#else
#  define DEF_MEM_LEVEL  MAX_MEM_LEVEL
#endif
#endif
</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">zip_copyright</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">
   </span><span class="sc6">" zip 1.01 Copyright 1998-2004 Gilles Vollant - http://www.winimage.com/zLibDll"</span><span class="sc10">;</span><span class="sc0">


</span><span class="sc9">#define SIZEDATA_INDATABLOCK (4096-(4*4))
</span><span class="sc0">
</span><span class="sc9">#define LOCALHEADERMAGIC    (0x04034b50)
#define CENTRALHEADERMAGIC  (0x02014b50)
#define ENDHEADERMAGIC      (0x06054b50)
</span><span class="sc0">
</span><span class="sc9">#define FLAG_LOCALHEADER_OFFSET (0x06)
#define CRC_LOCALHEADER_OFFSET  (0x0e)
</span><span class="sc0">
</span><span class="sc9">#define SIZECENTRALHEADER (0x2e) </span><span class="sc1">/* 46 */</span><span class="sc0">

</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">linkedlist_datablock_internal_s</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">linkedlist_datablock_internal_s</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">next_datablock</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">uLong</span><span class="sc0">  </span><span class="sc11">avail_in_this_block</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">uLong</span><span class="sc0">  </span><span class="sc11">filled_in_this_block</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">uLong</span><span class="sc0">  </span><span class="sc11">unused</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc1">/* for future use and alignement */</span><span class="sc0">
  </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">data</span><span class="sc10">[</span><span class="sc11">SIZEDATA_INDATABLOCK</span><span class="sc10">];</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0"> </span><span class="sc11">linkedlist_datablock_internal</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">linkedlist_data_s</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">linkedlist_datablock_internal</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">first_block</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">linkedlist_datablock_internal</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">last_block</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0"> </span><span class="sc11">linkedlist_data</span><span class="sc10">;</span><span class="sc0">


</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">z_stream</span><span class="sc0"> </span><span class="sc11">stream</span><span class="sc10">;</span><span class="sc0">            </span><span class="sc1">/* zLib stream structure for inflate */</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0">  </span><span class="sc11">stream_initialised</span><span class="sc10">;</span><span class="sc0">    </span><span class="sc1">/* 1 is stream is initialised */</span><span class="sc0">
    </span><span class="sc11">uInt</span><span class="sc0"> </span><span class="sc11">pos_in_buffered_data</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc1">/* last written byte in buffered_data */</span><span class="sc0">

    </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">pos_local_header</span><span class="sc10">;</span><span class="sc0">     </span><span class="sc1">/* offset of the local header of the file
                                     currenty writing */</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">central_header</span><span class="sc10">;</span><span class="sc0">       </span><span class="sc1">/* central header data for the current file */</span><span class="sc0">
    </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">size_centralheader</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc1">/* size of the central header for cur file */</span><span class="sc0">
    </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">flag</span><span class="sc10">;</span><span class="sc0">                 </span><span class="sc1">/* flag of the file currently writing */</span><span class="sc0">

    </span><span class="sc16">int</span><span class="sc0">  </span><span class="sc11">method</span><span class="sc10">;</span><span class="sc0">                </span><span class="sc1">/* compression method of file currenty wr.*/</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0">  </span><span class="sc11">raw</span><span class="sc10">;</span><span class="sc0">                   </span><span class="sc1">/* 1 for directly writing raw data */</span><span class="sc0">
    </span><span class="sc11">Byte</span><span class="sc0"> </span><span class="sc11">buffered_data</span><span class="sc10">[</span><span class="sc11">Z_BUFSIZE</span><span class="sc10">];</span><span class="sc1">/* buffer contain compressed data to be writ*/</span><span class="sc0">
    </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">dosDate</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">crc32</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0">  </span><span class="sc11">encrypt</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#ifndef NOCRYPT
</span><span class="sc0">    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">keys</span><span class="sc10">[</span><span class="sc4">3</span><span class="sc10">];</span><span class="sc0">     </span><span class="sc1">/* keys defining the pseudo-random sequence */</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">pcrc_32_tab</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">crypt_header_size</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc10">}</span><span class="sc0"> </span><span class="sc11">curfile_info</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">zlib_filefunc_def</span><span class="sc0"> </span><span class="sc11">z_filefunc</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">voidpf</span><span class="sc0"> </span><span class="sc11">filestream</span><span class="sc10">;</span><span class="sc0">        </span><span class="sc1">/* io structore of the zipfile */</span><span class="sc0">
    </span><span class="sc11">linkedlist_data</span><span class="sc0"> </span><span class="sc11">central_dir</span><span class="sc10">;</span><span class="sc1">/* datablock with central dir in construction*/</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0">  </span><span class="sc11">in_opened_file_inzip</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc1">/* 1 if a file in the zip is currently writ.*/</span><span class="sc0">
    </span><span class="sc11">curfile_info</span><span class="sc0"> </span><span class="sc11">ci</span><span class="sc10">;</span><span class="sc0">            </span><span class="sc1">/* info on the file curretly writing */</span><span class="sc0">

    </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">begin_pos</span><span class="sc10">;</span><span class="sc0">            </span><span class="sc1">/* position of the beginning of the zipfile */</span><span class="sc0">
    </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">add_position_when_writting_offset</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">number_entry</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#ifndef NO_ADDFILEINEXISTINGZIP
</span><span class="sc0">    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">globalcomment</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc10">}</span><span class="sc0"> </span><span class="sc11">zip_internal</span><span class="sc10">;</span><span class="sc0">



</span><span class="sc9">#ifndef NOCRYPT
#define INCLUDECRYPTINGCODE_IFCRYPTALLOWED
#include "crypt.h"
#endif
</span><span class="sc0">
</span><span class="sc11">local</span><span class="sc0"> </span><span class="sc11">linkedlist_datablock_internal</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">allocate_new_datablock</span><span class="sc10">()</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">linkedlist_datablock_internal</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">ldi</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">ldi</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">linkedlist_datablock_internal</span><span class="sc10">*)</span><span class="sc0">
                 </span><span class="sc11">ALLOC</span><span class="sc10">(</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">linkedlist_datablock_internal</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ldi</span><span class="sc10">!=</span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">ldi</span><span class="sc10">-&gt;</span><span class="sc11">next_datablock</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">ldi</span><span class="sc10">-&gt;</span><span class="sc11">filled_in_this_block</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">ldi</span><span class="sc10">-&gt;</span><span class="sc11">avail_in_this_block</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">SIZEDATA_INDATABLOCK</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">ldi</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">local</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">free_datablock</span><span class="sc10">(</span><span class="sc11">ldi</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc11">linkedlist_datablock_internal</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">ldi</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ldi</span><span class="sc10">!=</span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">linkedlist_datablock_internal</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">ldinext</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ldi</span><span class="sc10">-&gt;</span><span class="sc11">next_datablock</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">TRYFREE</span><span class="sc10">(</span><span class="sc11">ldi</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">ldi</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ldinext</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">local</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">init_linkedlist</span><span class="sc10">(</span><span class="sc11">ll</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc11">linkedlist_data</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">ll</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">ll</span><span class="sc10">-&gt;</span><span class="sc11">first_block</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ll</span><span class="sc10">-&gt;</span><span class="sc11">last_block</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">local</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">free_linkedlist</span><span class="sc10">(</span><span class="sc11">ll</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc11">linkedlist_data</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">ll</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">free_datablock</span><span class="sc10">(</span><span class="sc11">ll</span><span class="sc10">-&gt;</span><span class="sc11">first_block</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">ll</span><span class="sc10">-&gt;</span><span class="sc11">first_block</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ll</span><span class="sc10">-&gt;</span><span class="sc11">last_block</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc11">local</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">add_data_in_datablock</span><span class="sc10">(</span><span class="sc11">ll</span><span class="sc10">,</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc11">len</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc11">linkedlist_data</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">ll</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">linkedlist_datablock_internal</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">ldi</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">from_copy</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ll</span><span class="sc10">==</span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">ZIP_INTERNALERROR</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ll</span><span class="sc10">-&gt;</span><span class="sc11">last_block</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">ll</span><span class="sc10">-&gt;</span><span class="sc11">first_block</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ll</span><span class="sc10">-&gt;</span><span class="sc11">last_block</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">allocate_new_datablock</span><span class="sc10">();</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ll</span><span class="sc10">-&gt;</span><span class="sc11">first_block</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">ZIP_INTERNALERROR</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc11">ldi</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ll</span><span class="sc10">-&gt;</span><span class="sc11">last_block</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">from_copy</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">buf</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">len</span><span class="sc10">&gt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">uInt</span><span class="sc0"> </span><span class="sc11">copy_this</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">uInt</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">to_copy</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ldi</span><span class="sc10">-&gt;</span><span class="sc11">avail_in_this_block</span><span class="sc10">==</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">ldi</span><span class="sc10">-&gt;</span><span class="sc11">next_datablock</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">allocate_new_datablock</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ldi</span><span class="sc10">-&gt;</span><span class="sc11">next_datablock</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">ZIP_INTERNALERROR</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">ldi</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ldi</span><span class="sc10">-&gt;</span><span class="sc11">next_datablock</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">ll</span><span class="sc10">-&gt;</span><span class="sc11">last_block</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ldi</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ldi</span><span class="sc10">-&gt;</span><span class="sc11">avail_in_this_block</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">copy_this</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">uInt</span><span class="sc10">)</span><span class="sc11">ldi</span><span class="sc10">-&gt;</span><span class="sc11">avail_in_this_block</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">else</span><span class="sc0">
            </span><span class="sc11">copy_this</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">uInt</span><span class="sc10">)</span><span class="sc11">len</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc11">to_copy</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">&amp;(</span><span class="sc11">ldi</span><span class="sc10">-&gt;</span><span class="sc11">data</span><span class="sc10">[</span><span class="sc11">ldi</span><span class="sc10">-&gt;</span><span class="sc11">filled_in_this_block</span><span class="sc10">]);</span><span class="sc0">

        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">copy_this</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
            </span><span class="sc10">*(</span><span class="sc11">to_copy</span><span class="sc10">+</span><span class="sc11">i</span><span class="sc10">)=*(</span><span class="sc11">from_copy</span><span class="sc10">+</span><span class="sc11">i</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc11">ldi</span><span class="sc10">-&gt;</span><span class="sc11">filled_in_this_block</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">copy_this</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">ldi</span><span class="sc10">-&gt;</span><span class="sc11">avail_in_this_block</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc11">copy_this</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">from_copy</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">copy_this</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">len</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc11">copy_this</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">ZIP_OK</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">



</span><span class="sc3">/****************************************************************************/</span><span class="sc0">

</span><span class="sc9">#ifndef NO_ADDFILEINEXISTINGZIP
</span><span class="sc1">/* ===========================================================================
   Inputs a long in LSB order to the given file
   nbByte == 1, 2 or 4 (byte, short or long)
*/</span><span class="sc0">

</span><span class="sc11">local</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ziplocal_putValue</span><span class="sc0"> </span><span class="sc11">OF</span><span class="sc10">((</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc11">zlib_filefunc_def</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">pzlib_filefunc_def</span><span class="sc10">,</span><span class="sc0">
                                </span><span class="sc11">voidpf</span><span class="sc0"> </span><span class="sc11">filestream</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">nbByte</span><span class="sc10">));</span><span class="sc0">
</span><span class="sc11">local</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ziplocal_putValue</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">pzlib_filefunc_def</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">filestream</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">nbByte</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc11">zlib_filefunc_def</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">pzlib_filefunc_def</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">voidpf</span><span class="sc0"> </span><span class="sc11">filestream</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">nbByte</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">[</span><span class="sc4">4</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">nbByte</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc10">++)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">buf</span><span class="sc10">[</span><span class="sc11">n</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">)(</span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0xff</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">&gt;&gt;=</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
      </span><span class="sc10">{</span><span class="sc0">     </span><span class="sc1">/* data overflow - hack for ZIP64 (X Roche) */</span><span class="sc0">
      </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">nbByte</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
          </span><span class="sc11">buf</span><span class="sc10">[</span><span class="sc11">n</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0xff</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
      </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ZWRITE</span><span class="sc10">(*</span><span class="sc11">pzlib_filefunc_def</span><span class="sc10">,</span><span class="sc11">filestream</span><span class="sc10">,</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc11">nbByte</span><span class="sc10">)!=(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">nbByte</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">ZIP_ERRNO</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">else</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">ZIP_OK</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">local</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">ziplocal_putValue_inmemory</span><span class="sc0"> </span><span class="sc11">OF</span><span class="sc10">((</span><span class="sc16">void</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">dest</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">nbByte</span><span class="sc10">));</span><span class="sc0">
</span><span class="sc11">local</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">ziplocal_putValue_inmemory</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">dest</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">nbByte</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc16">void</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">dest</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">nbByte</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">=(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">dest</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">nbByte</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">buf</span><span class="sc10">[</span><span class="sc11">n</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">)(</span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0xff</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">&gt;&gt;=</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">     </span><span class="sc1">/* data overflow - hack for ZIP64 */</span><span class="sc0">
       </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">nbByte</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc10">++)</span><span class="sc0">
       </span><span class="sc10">{</span><span class="sc0">
          </span><span class="sc11">buf</span><span class="sc10">[</span><span class="sc11">n</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0xff</span><span class="sc10">;</span><span class="sc0">
       </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc3">/****************************************************************************/</span><span class="sc0">


</span><span class="sc11">local</span><span class="sc0"> </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">ziplocal_TmzDateToDosDate</span><span class="sc10">(</span><span class="sc11">ptm</span><span class="sc10">,</span><span class="sc11">dosDate</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc11">tm_zip</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">ptm</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">dosDate</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">year</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">ptm</span><span class="sc10">-&gt;</span><span class="sc11">tm_year</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">year</span><span class="sc10">&gt;</span><span class="sc4">1980</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">year</span><span class="sc10">-=</span><span class="sc4">1980</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">year</span><span class="sc10">&gt;</span><span class="sc4">80</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">year</span><span class="sc10">-=</span><span class="sc4">80</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0">
      </span><span class="sc10">(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(((</span><span class="sc11">ptm</span><span class="sc10">-&gt;</span><span class="sc11">tm_mday</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">32</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ptm</span><span class="sc10">-&gt;</span><span class="sc11">tm_mon</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">512</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">year</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0">
        </span><span class="sc10">((</span><span class="sc11">ptm</span><span class="sc10">-&gt;</span><span class="sc11">tm_sec</span><span class="sc10">/</span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">32</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">ptm</span><span class="sc10">-&gt;</span><span class="sc11">tm_min</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">2048</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">ptm</span><span class="sc10">-&gt;</span><span class="sc11">tm_hour</span><span class="sc10">));</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc3">/****************************************************************************/</span><span class="sc0">

</span><span class="sc11">local</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ziplocal_getByte</span><span class="sc0"> </span><span class="sc11">OF</span><span class="sc10">((</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc11">zlib_filefunc_def</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">pzlib_filefunc_def</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc11">voidpf</span><span class="sc0"> </span><span class="sc11">filestream</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pi</span><span class="sc10">));</span><span class="sc0">

</span><span class="sc11">local</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ziplocal_getByte</span><span class="sc10">(</span><span class="sc11">pzlib_filefunc_def</span><span class="sc10">,</span><span class="sc11">filestream</span><span class="sc10">,</span><span class="sc11">pi</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc11">zlib_filefunc_def</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">pzlib_filefunc_def</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">voidpf</span><span class="sc0"> </span><span class="sc11">filestream</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pi</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">c</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">ZREAD</span><span class="sc10">(*</span><span class="sc11">pzlib_filefunc_def</span><span class="sc10">,</span><span class="sc11">filestream</span><span class="sc10">,&amp;</span><span class="sc11">c</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc10">*</span><span class="sc11">pi</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">c</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">ZIP_OK</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">else</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ZERROR</span><span class="sc10">(*</span><span class="sc11">pzlib_filefunc_def</span><span class="sc10">,</span><span class="sc11">filestream</span><span class="sc10">))</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">ZIP_ERRNO</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">else</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">ZIP_EOF</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc1">/* ===========================================================================
   Reads a long in LSB order from the given gz_stream. Sets
*/</span><span class="sc0">
</span><span class="sc11">local</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ziplocal_getShort</span><span class="sc0"> </span><span class="sc11">OF</span><span class="sc10">((</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc11">zlib_filefunc_def</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">pzlib_filefunc_def</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc11">voidpf</span><span class="sc0"> </span><span class="sc11">filestream</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pX</span><span class="sc10">));</span><span class="sc0">

</span><span class="sc11">local</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ziplocal_getShort</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">pzlib_filefunc_def</span><span class="sc10">,</span><span class="sc11">filestream</span><span class="sc10">,</span><span class="sc11">pX</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc11">zlib_filefunc_def</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">pzlib_filefunc_def</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">voidpf</span><span class="sc0"> </span><span class="sc11">filestream</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pX</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">err</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ziplocal_getByte</span><span class="sc10">(</span><span class="sc11">pzlib_filefunc_def</span><span class="sc10">,</span><span class="sc11">filestream</span><span class="sc10">,&amp;</span><span class="sc11">i</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ziplocal_getByte</span><span class="sc10">(</span><span class="sc11">pzlib_filefunc_def</span><span class="sc10">,</span><span class="sc11">filestream</span><span class="sc10">,&amp;</span><span class="sc11">i</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">i</span><span class="sc10">)&lt;&lt;</span><span class="sc4">8</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">*</span><span class="sc11">pX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">else</span><span class="sc0">
        </span><span class="sc10">*</span><span class="sc11">pX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">err</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">local</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ziplocal_getLong</span><span class="sc0"> </span><span class="sc11">OF</span><span class="sc10">((</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc11">zlib_filefunc_def</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">pzlib_filefunc_def</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc11">voidpf</span><span class="sc0"> </span><span class="sc11">filestream</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pX</span><span class="sc10">));</span><span class="sc0">

</span><span class="sc11">local</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ziplocal_getLong</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">pzlib_filefunc_def</span><span class="sc10">,</span><span class="sc11">filestream</span><span class="sc10">,</span><span class="sc11">pX</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc11">zlib_filefunc_def</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">pzlib_filefunc_def</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">voidpf</span><span class="sc0"> </span><span class="sc11">filestream</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pX</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">err</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ziplocal_getByte</span><span class="sc10">(</span><span class="sc11">pzlib_filefunc_def</span><span class="sc10">,</span><span class="sc11">filestream</span><span class="sc10">,&amp;</span><span class="sc11">i</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ziplocal_getByte</span><span class="sc10">(</span><span class="sc11">pzlib_filefunc_def</span><span class="sc10">,</span><span class="sc11">filestream</span><span class="sc10">,&amp;</span><span class="sc11">i</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">i</span><span class="sc10">)&lt;&lt;</span><span class="sc4">8</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ziplocal_getByte</span><span class="sc10">(</span><span class="sc11">pzlib_filefunc_def</span><span class="sc10">,</span><span class="sc11">filestream</span><span class="sc10">,&amp;</span><span class="sc11">i</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">i</span><span class="sc10">)&lt;&lt;</span><span class="sc4">16</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ziplocal_getByte</span><span class="sc10">(</span><span class="sc11">pzlib_filefunc_def</span><span class="sc10">,</span><span class="sc11">filestream</span><span class="sc10">,&amp;</span><span class="sc11">i</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">i</span><span class="sc10">)&lt;&lt;</span><span class="sc4">24</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">*</span><span class="sc11">pX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">else</span><span class="sc0">
        </span><span class="sc10">*</span><span class="sc11">pX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">err</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc9">#ifndef BUFREADCOMMENT
#define BUFREADCOMMENT (0x400)
#endif
</span><span class="sc1">/*
  Locate the Central directory of a zipfile (at the end, just before
    the global comment)
*/</span><span class="sc0">
</span><span class="sc11">local</span><span class="sc0"> </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">ziplocal_SearchCentralDir</span><span class="sc0"> </span><span class="sc11">OF</span><span class="sc10">((</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc11">zlib_filefunc_def</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">pzlib_filefunc_def</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc11">voidpf</span><span class="sc0"> </span><span class="sc11">filestream</span><span class="sc10">));</span><span class="sc0">

</span><span class="sc11">local</span><span class="sc0"> </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">ziplocal_SearchCentralDir</span><span class="sc10">(</span><span class="sc11">pzlib_filefunc_def</span><span class="sc10">,</span><span class="sc11">filestream</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc11">zlib_filefunc_def</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">pzlib_filefunc_def</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">voidpf</span><span class="sc0"> </span><span class="sc11">filestream</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">uSizeFile</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">uBackRead</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">uMaxBack</span><span class="sc10">=</span><span class="sc4">0xffff</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc1">/* maximum size of global comment */</span><span class="sc0">
    </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">uPosFound</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ZSEEK</span><span class="sc10">(*</span><span class="sc11">pzlib_filefunc_def</span><span class="sc10">,</span><span class="sc11">filestream</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">ZLIB_FILEFUNC_SEEK_END</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">


    </span><span class="sc11">uSizeFile</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ZTELL</span><span class="sc10">(*</span><span class="sc11">pzlib_filefunc_def</span><span class="sc10">,</span><span class="sc11">filestream</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">uMaxBack</span><span class="sc10">&gt;</span><span class="sc11">uSizeFile</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">uMaxBack</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">uSizeFile</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">buf</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">ALLOC</span><span class="sc10">(</span><span class="sc11">BUFREADCOMMENT</span><span class="sc10">+</span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">==</span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">uBackRead</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">uBackRead</span><span class="sc10">&lt;</span><span class="sc11">uMaxBack</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">uReadSize</span><span class="sc10">,</span><span class="sc11">uReadPos</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">uBackRead</span><span class="sc10">+</span><span class="sc11">BUFREADCOMMENT</span><span class="sc10">&gt;</span><span class="sc11">uMaxBack</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">uBackRead</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">uMaxBack</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">else</span><span class="sc0">
            </span><span class="sc11">uBackRead</span><span class="sc10">+=</span><span class="sc11">BUFREADCOMMENT</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">uReadPos</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">uSizeFile</span><span class="sc10">-</span><span class="sc11">uBackRead</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc11">uReadSize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">BUFREADCOMMENT</span><span class="sc10">+</span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">uSizeFile</span><span class="sc10">-</span><span class="sc11">uReadPos</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
                     </span><span class="sc10">(</span><span class="sc11">BUFREADCOMMENT</span><span class="sc10">+</span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">uSizeFile</span><span class="sc10">-</span><span class="sc11">uReadPos</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ZSEEK</span><span class="sc10">(*</span><span class="sc11">pzlib_filefunc_def</span><span class="sc10">,</span><span class="sc11">filestream</span><span class="sc10">,</span><span class="sc11">uReadPos</span><span class="sc10">,</span><span class="sc11">ZLIB_FILEFUNC_SEEK_SET</span><span class="sc10">)!=</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ZREAD</span><span class="sc10">(*</span><span class="sc11">pzlib_filefunc_def</span><span class="sc10">,</span><span class="sc11">filestream</span><span class="sc10">,</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc11">uReadSize</span><span class="sc10">)!=</span><span class="sc11">uReadSize</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">uReadSize</span><span class="sc10">-</span><span class="sc4">3</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">--)&gt;</span><span class="sc4">0</span><span class="sc10">;)</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(((*(</span><span class="sc11">buf</span><span class="sc10">+</span><span class="sc11">i</span><span class="sc10">))==</span><span class="sc4">0x50</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">((*(</span><span class="sc11">buf</span><span class="sc10">+</span><span class="sc11">i</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">))==</span><span class="sc4">0x4b</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0">
                </span><span class="sc10">((*(</span><span class="sc11">buf</span><span class="sc10">+</span><span class="sc11">i</span><span class="sc10">+</span><span class="sc4">2</span><span class="sc10">))==</span><span class="sc4">0x05</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">((*(</span><span class="sc11">buf</span><span class="sc10">+</span><span class="sc11">i</span><span class="sc10">+</span><span class="sc4">3</span><span class="sc10">))==</span><span class="sc4">0x06</span><span class="sc10">))</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">uPosFound</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">uReadPos</span><span class="sc10">+</span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">uPosFound</span><span class="sc10">!=</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc11">TRYFREE</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">uPosFound</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span><span class="sc9">#endif </span><span class="sc1">/* !NO_ADDFILEINEXISTINGZIP*/</span><span class="sc0">

</span><span class="sc3">/************************************************************/</span><span class="sc0">
</span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc11">zipFile</span><span class="sc0"> </span><span class="sc11">ZEXPORT</span><span class="sc0"> </span><span class="sc11">zipOpen2</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">pathname</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">append</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">globalcomment</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pzlib_filefunc_def</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pathname</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">append</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">zipcharpc</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">globalcomment</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">zlib_filefunc_def</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">pzlib_filefunc_def</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">zip_internal</span><span class="sc0"> </span><span class="sc11">ziinit</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">zip_internal</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">zi</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">err</span><span class="sc10">=</span><span class="sc11">ZIP_OK</span><span class="sc10">;</span><span class="sc0">


    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">pzlib_filefunc_def</span><span class="sc10">==</span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">fill_fopen_filefunc</span><span class="sc10">(&amp;</span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">z_filefunc</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">else</span><span class="sc0">
        </span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">z_filefunc</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pzlib_filefunc_def</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">filestream</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(*(</span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">z_filefunc</span><span class="sc10">.</span><span class="sc11">zopen_file</span><span class="sc10">))</span><span class="sc0">
                 </span><span class="sc10">(</span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">z_filefunc</span><span class="sc10">.</span><span class="sc11">opaque</span><span class="sc10">,</span><span class="sc0">
                  </span><span class="sc11">pathname</span><span class="sc10">,</span><span class="sc0">
                  </span><span class="sc10">(</span><span class="sc11">append</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">APPEND_STATUS_CREATE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
                  </span><span class="sc10">(</span><span class="sc11">ZLIB_FILEFUNC_MODE_READ</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">ZLIB_FILEFUNC_MODE_WRITE</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">ZLIB_FILEFUNC_MODE_CREATE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0">
                    </span><span class="sc10">(</span><span class="sc11">ZLIB_FILEFUNC_MODE_READ</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">ZLIB_FILEFUNC_MODE_WRITE</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">ZLIB_FILEFUNC_MODE_EXISTING</span><span class="sc10">));</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">filestream</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">begin_pos</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ZTELL</span><span class="sc10">(</span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">filestream</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">in_opened_file_inzip</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream_initialised</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">number_entry</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">add_position_when_writting_offset</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">init_linkedlist</span><span class="sc10">(&amp;(</span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">central_dir</span><span class="sc10">));</span><span class="sc0">


    </span><span class="sc11">zi</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">zip_internal</span><span class="sc10">*)</span><span class="sc11">ALLOC</span><span class="sc10">(</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">zip_internal</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">==</span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">ZCLOSE</span><span class="sc10">(</span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">filestream</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc1">/* now we add file in a zipfile */</span><span class="sc0">
</span><span class="sc9">#    ifndef NO_ADDFILEINEXISTINGZIP
</span><span class="sc0">    </span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">globalcomment</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">append</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">APPEND_STATUS_ADDINZIP</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">byte_before_the_zipfile</span><span class="sc10">;</span><span class="sc1">/* byte before the zipfile, (&gt;0 for sfx)*/</span><span class="sc0">

        </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">size_central_dir</span><span class="sc10">;</span><span class="sc0">     </span><span class="sc1">/* size of the central directory  */</span><span class="sc0">
        </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">offset_central_dir</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc1">/* offset of start of central directory */</span><span class="sc0">
        </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">central_pos</span><span class="sc10">,</span><span class="sc11">uL</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">number_disk</span><span class="sc10">;</span><span class="sc0">          </span><span class="sc1">/* number of the current dist, used for
                                    spaning ZIP, unsupported, always 0*/</span><span class="sc0">
        </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">number_disk_with_CD</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc1">/* number the the disk with central dir, used
                                    for spaning ZIP, unsupported, always 0*/</span><span class="sc0">
        </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">number_entry</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">number_entry_CD</span><span class="sc10">;</span><span class="sc0">      </span><span class="sc1">/* total number of entries in
                                    the central dir
                                    (same than number_entry on nospan) */</span><span class="sc0">
        </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">size_comment</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc11">central_pos</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ziplocal_SearchCentralDir</span><span class="sc10">(&amp;</span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">filestream</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">central_pos</span><span class="sc10">==</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">err</span><span class="sc10">=</span><span class="sc11">ZIP_ERRNO</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ZSEEK</span><span class="sc10">(</span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">filestream</span><span class="sc10">,</span><span class="sc0">
                                        </span><span class="sc11">central_pos</span><span class="sc10">,</span><span class="sc11">ZLIB_FILEFUNC_SEEK_SET</span><span class="sc10">)!=</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">err</span><span class="sc10">=</span><span class="sc11">ZIP_ERRNO</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc1">/* the signature, already checked */</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ziplocal_getLong</span><span class="sc10">(&amp;</span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">filestream</span><span class="sc10">,&amp;</span><span class="sc11">uL</span><span class="sc10">)!=</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">err</span><span class="sc10">=</span><span class="sc11">ZIP_ERRNO</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc1">/* number of this disk */</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ziplocal_getShort</span><span class="sc10">(&amp;</span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">filestream</span><span class="sc10">,&amp;</span><span class="sc11">number_disk</span><span class="sc10">)!=</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">err</span><span class="sc10">=</span><span class="sc11">ZIP_ERRNO</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc1">/* number of the disk with the start of the central directory */</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ziplocal_getShort</span><span class="sc10">(&amp;</span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">filestream</span><span class="sc10">,&amp;</span><span class="sc11">number_disk_with_CD</span><span class="sc10">)!=</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">err</span><span class="sc10">=</span><span class="sc11">ZIP_ERRNO</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc1">/* total number of entries in the central dir on this disk */</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ziplocal_getShort</span><span class="sc10">(&amp;</span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">filestream</span><span class="sc10">,&amp;</span><span class="sc11">number_entry</span><span class="sc10">)!=</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">err</span><span class="sc10">=</span><span class="sc11">ZIP_ERRNO</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc1">/* total number of entries in the central dir */</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ziplocal_getShort</span><span class="sc10">(&amp;</span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">filestream</span><span class="sc10">,&amp;</span><span class="sc11">number_entry_CD</span><span class="sc10">)!=</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">err</span><span class="sc10">=</span><span class="sc11">ZIP_ERRNO</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">number_entry_CD</span><span class="sc10">!=</span><span class="sc11">number_entry</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
            </span><span class="sc10">(</span><span class="sc11">number_disk_with_CD</span><span class="sc10">!=</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
            </span><span class="sc10">(</span><span class="sc11">number_disk</span><span class="sc10">!=</span><span class="sc4">0</span><span class="sc10">))</span><span class="sc0">
            </span><span class="sc11">err</span><span class="sc10">=</span><span class="sc11">ZIP_BADZIPFILE</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc1">/* size of the central directory */</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ziplocal_getLong</span><span class="sc10">(&amp;</span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">filestream</span><span class="sc10">,&amp;</span><span class="sc11">size_central_dir</span><span class="sc10">)!=</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">err</span><span class="sc10">=</span><span class="sc11">ZIP_ERRNO</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc1">/* offset of start of central directory with respect to the
            starting disk number */</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ziplocal_getLong</span><span class="sc10">(&amp;</span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">filestream</span><span class="sc10">,&amp;</span><span class="sc11">offset_central_dir</span><span class="sc10">)!=</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">err</span><span class="sc10">=</span><span class="sc11">ZIP_ERRNO</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc1">/* zipfile global comment length */</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ziplocal_getShort</span><span class="sc10">(&amp;</span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">filestream</span><span class="sc10">,&amp;</span><span class="sc11">size_comment</span><span class="sc10">)!=</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">err</span><span class="sc10">=</span><span class="sc11">ZIP_ERRNO</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">central_pos</span><span class="sc10">&lt;</span><span class="sc11">offset_central_dir</span><span class="sc10">+</span><span class="sc11">size_central_dir</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0">
            </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">))</span><span class="sc0">
            </span><span class="sc11">err</span><span class="sc10">=</span><span class="sc11">ZIP_BADZIPFILE</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">!=</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">ZCLOSE</span><span class="sc10">(</span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">filestream</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">size_comment</span><span class="sc10">&gt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">globalcomment</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ALLOC</span><span class="sc10">(</span><span class="sc11">size_comment</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">globalcomment</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
               </span><span class="sc11">size_comment</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ZREAD</span><span class="sc10">(</span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">filestream</span><span class="sc10">,</span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">globalcomment</span><span class="sc10">,</span><span class="sc11">size_comment</span><span class="sc10">);</span><span class="sc0">
               </span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">globalcomment</span><span class="sc10">[</span><span class="sc11">size_comment</span><span class="sc10">]=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc11">byte_before_the_zipfile</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">central_pos</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0">
                                </span><span class="sc10">(</span><span class="sc11">offset_central_dir</span><span class="sc10">+</span><span class="sc11">size_central_dir</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">add_position_when_writting_offset</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">byte_before_the_zipfile</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">size_central_dir_to_read</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">size_central_dir</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">size_t</span><span class="sc0"> </span><span class="sc11">buf_size</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">SIZEDATA_INDATABLOCK</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc16">void</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">buf_read</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">*)</span><span class="sc11">ALLOC</span><span class="sc10">(</span><span class="sc11">buf_size</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ZSEEK</span><span class="sc10">(</span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">filestream</span><span class="sc10">,</span><span class="sc0">
                  </span><span class="sc11">offset_central_dir</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">byte_before_the_zipfile</span><span class="sc10">,</span><span class="sc0">
                  </span><span class="sc11">ZLIB_FILEFUNC_SEEK_SET</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                  </span><span class="sc11">err</span><span class="sc10">=</span><span class="sc11">ZIP_ERRNO</span><span class="sc10">;</span><span class="sc0">

            </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">size_central_dir_to_read</span><span class="sc10">&gt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">))</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">read_this</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">SIZEDATA_INDATABLOCK</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">read_this</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc11">size_central_dir_to_read</span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc11">read_this</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">size_central_dir_to_read</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ZREAD</span><span class="sc10">(</span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">filestream</span><span class="sc10">,</span><span class="sc11">buf_read</span><span class="sc10">,</span><span class="sc11">read_this</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">read_this</span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc11">err</span><span class="sc10">=</span><span class="sc11">ZIP_ERRNO</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">add_data_in_datablock</span><span class="sc10">(&amp;</span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">central_dir</span><span class="sc10">,</span><span class="sc11">buf_read</span><span class="sc10">,</span><span class="sc0">
                                                </span><span class="sc10">(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">read_this</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">size_central_dir_to_read</span><span class="sc10">-=</span><span class="sc11">read_this</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc11">TRYFREE</span><span class="sc10">(</span><span class="sc11">buf_read</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">begin_pos</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">byte_before_the_zipfile</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">number_entry</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">number_entry_CD</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ZSEEK</span><span class="sc10">(</span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">filestream</span><span class="sc10">,</span><span class="sc0">
                  </span><span class="sc11">offset_central_dir</span><span class="sc10">+</span><span class="sc11">byte_before_the_zipfile</span><span class="sc10">,</span><span class="sc11">ZLIB_FILEFUNC_SEEK_SET</span><span class="sc10">)!=</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">err</span><span class="sc10">=</span><span class="sc11">ZIP_ERRNO</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">globalcomment</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc10">*</span><span class="sc11">globalcomment</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">globalcomment</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc9">#    endif </span><span class="sc1">/* !NO_ADDFILEINEXISTINGZIP*/</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc9">#    ifndef NO_ADDFILEINEXISTINGZIP
</span><span class="sc0">        </span><span class="sc11">TRYFREE</span><span class="sc10">(</span><span class="sc11">ziinit</span><span class="sc10">.</span><span class="sc11">globalcomment</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#    endif </span><span class="sc1">/* !NO_ADDFILEINEXISTINGZIP*/</span><span class="sc0">
        </span><span class="sc11">TRYFREE</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">else</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc10">*</span><span class="sc11">zi</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ziinit</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">zipFile</span><span class="sc10">)</span><span class="sc11">zi</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc11">zipFile</span><span class="sc0"> </span><span class="sc11">ZEXPORT</span><span class="sc0"> </span><span class="sc11">zipOpen</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">pathname</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">append</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pathname</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">append</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">zipOpen2</span><span class="sc10">(</span><span class="sc11">pathname</span><span class="sc10">,</span><span class="sc11">append</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ZEXPORT</span><span class="sc0"> </span><span class="sc11">zipOpenNewFileInZip3</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">zipfi</span><span class="sc10">,</span><span class="sc0">
                                         </span><span class="sc11">extrafield_local</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">size_extrafield_local</span><span class="sc10">,</span><span class="sc0">
                                         </span><span class="sc11">extrafield_global</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">size_extrafield_global</span><span class="sc10">,</span><span class="sc0">
                                         </span><span class="sc11">comment</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">method</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">level</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">raw</span><span class="sc10">,</span><span class="sc0">
                                         </span><span class="sc11">windowBits</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">memLevel</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strategy</span><span class="sc10">,</span><span class="sc0">
                                         </span><span class="sc11">password</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">crcForCrypting</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc11">zipFile</span><span class="sc0"> </span><span class="sc11">file</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">filename</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc11">zip_fileinfo</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">zipfi</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">extrafield_local</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">uInt</span><span class="sc0"> </span><span class="sc11">size_extrafield_local</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">extrafield_global</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">uInt</span><span class="sc0"> </span><span class="sc11">size_extrafield_global</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">comment</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">method</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">level</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">raw</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">windowBits</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">memLevel</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">strategy</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">password</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">crcForCrypting</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">zip_internal</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">zi</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">uInt</span><span class="sc0"> </span><span class="sc11">size_filename</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">uInt</span><span class="sc0"> </span><span class="sc11">size_comment</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">uInt</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ZIP_OK</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc9">#    ifdef NOCRYPT
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">password</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">ZIP_PARAMERROR</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#    endif
</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">file</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">ZIP_PARAMERROR</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">method</span><span class="sc10">!=</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">method</span><span class="sc10">!=</span><span class="sc11">Z_DEFLATED</span><span class="sc10">))</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">ZIP_PARAMERROR</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">zi</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">zip_internal</span><span class="sc10">*)</span><span class="sc11">file</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">in_opened_file_inzip</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">zipCloseFileInZip</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">err</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">


    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">==</span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">filename</span><span class="sc10">=</span><span class="sc6">"-"</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">comment</span><span class="sc10">==</span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">size_comment</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">else</span><span class="sc0">
        </span><span class="sc11">size_comment</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">uInt</span><span class="sc10">)</span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">comment</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">size_filename</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">uInt</span><span class="sc10">)</span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">zipfi</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">dosDate</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">else</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">zipfi</span><span class="sc10">-&gt;</span><span class="sc11">dosDate</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">dosDate</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">zipfi</span><span class="sc10">-&gt;</span><span class="sc11">dosDate</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">dosDate</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ziplocal_TmzDateToDosDate</span><span class="sc10">(&amp;</span><span class="sc11">zipfi</span><span class="sc10">-&gt;</span><span class="sc11">tmz_date</span><span class="sc10">,</span><span class="sc11">zipfi</span><span class="sc10">-&gt;</span><span class="sc11">dosDate</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">flag</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">level</span><span class="sc10">==</span><span class="sc4">8</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">level</span><span class="sc10">==</span><span class="sc4">9</span><span class="sc10">))</span><span class="sc0">
      </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">flag</span><span class="sc0"> </span><span class="sc10">|=</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">level</span><span class="sc10">==</span><span class="sc4">2</span><span class="sc10">))</span><span class="sc0">
      </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">flag</span><span class="sc0"> </span><span class="sc10">|=</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">level</span><span class="sc10">==</span><span class="sc4">1</span><span class="sc10">))</span><span class="sc0">
      </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">flag</span><span class="sc0"> </span><span class="sc10">|=</span><span class="sc0"> </span><span class="sc4">6</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">password</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
      </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">flag</span><span class="sc0"> </span><span class="sc10">|=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">crc32</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">method</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">method</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">encrypt</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream_initialised</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">pos_in_buffered_data</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">raw</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">raw</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">pos_local_header</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ZTELL</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">filestream</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">size_centralheader</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">SIZECENTRALHEADER</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">size_filename</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0">
                                      </span><span class="sc11">size_extrafield_global</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">size_comment</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">central_header</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">ALLOC</span><span class="sc10">((</span><span class="sc11">uInt</span><span class="sc10">)</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">size_centralheader</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">ziplocal_putValue_inmemory</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">central_header</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">CENTRALHEADERMAGIC</span><span class="sc10">,</span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc1">/* version info */</span><span class="sc0">
    </span><span class="sc11">ziplocal_putValue_inmemory</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">central_header</span><span class="sc10">+</span><span class="sc4">4</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">VERSIONMADEBY</span><span class="sc10">,</span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">ziplocal_putValue_inmemory</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">central_header</span><span class="sc10">+</span><span class="sc4">6</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc4">20</span><span class="sc10">,</span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">ziplocal_putValue_inmemory</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">central_header</span><span class="sc10">+</span><span class="sc4">8</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">flag</span><span class="sc10">,</span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">ziplocal_putValue_inmemory</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">central_header</span><span class="sc10">+</span><span class="sc4">10</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">method</span><span class="sc10">,</span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">ziplocal_putValue_inmemory</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">central_header</span><span class="sc10">+</span><span class="sc4">12</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">dosDate</span><span class="sc10">,</span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">ziplocal_putValue_inmemory</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">central_header</span><span class="sc10">+</span><span class="sc4">16</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc1">/*crc*/</span><span class="sc0">
    </span><span class="sc11">ziplocal_putValue_inmemory</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">central_header</span><span class="sc10">+</span><span class="sc4">20</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc1">/*compr size*/</span><span class="sc0">
    </span><span class="sc11">ziplocal_putValue_inmemory</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">central_header</span><span class="sc10">+</span><span class="sc4">24</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc1">/*uncompr size*/</span><span class="sc0">
    </span><span class="sc11">ziplocal_putValue_inmemory</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">central_header</span><span class="sc10">+</span><span class="sc4">28</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">size_filename</span><span class="sc10">,</span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">ziplocal_putValue_inmemory</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">central_header</span><span class="sc10">+</span><span class="sc4">30</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">size_extrafield_global</span><span class="sc10">,</span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">ziplocal_putValue_inmemory</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">central_header</span><span class="sc10">+</span><span class="sc4">32</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">size_comment</span><span class="sc10">,</span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">ziplocal_putValue_inmemory</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">central_header</span><span class="sc10">+</span><span class="sc4">34</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc1">/*disk nm start*/</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">zipfi</span><span class="sc10">==</span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">ziplocal_putValue_inmemory</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">central_header</span><span class="sc10">+</span><span class="sc4">36</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">else</span><span class="sc0">
        </span><span class="sc11">ziplocal_putValue_inmemory</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">central_header</span><span class="sc10">+</span><span class="sc4">36</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">zipfi</span><span class="sc10">-&gt;</span><span class="sc11">internal_fa</span><span class="sc10">,</span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">zipfi</span><span class="sc10">==</span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">ziplocal_putValue_inmemory</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">central_header</span><span class="sc10">+</span><span class="sc4">38</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">else</span><span class="sc0">
        </span><span class="sc11">ziplocal_putValue_inmemory</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">central_header</span><span class="sc10">+</span><span class="sc4">38</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">zipfi</span><span class="sc10">-&gt;</span><span class="sc11">external_fa</span><span class="sc10">,</span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">ziplocal_putValue_inmemory</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">central_header</span><span class="sc10">+</span><span class="sc4">42</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">pos_local_header</span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">add_position_when_writting_offset</span><span class="sc10">,</span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">size_filename</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc10">*(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">central_header</span><span class="sc10">+</span><span class="sc11">SIZECENTRALHEADER</span><span class="sc10">+</span><span class="sc11">i</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">*(</span><span class="sc11">filename</span><span class="sc10">+</span><span class="sc11">i</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">size_extrafield_global</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc10">*(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">central_header</span><span class="sc10">+</span><span class="sc11">SIZECENTRALHEADER</span><span class="sc10">+</span><span class="sc11">size_filename</span><span class="sc10">+</span><span class="sc11">i</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">
              </span><span class="sc10">*(((</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">extrafield_global</span><span class="sc10">)+</span><span class="sc11">i</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">size_comment</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc10">*(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">central_header</span><span class="sc10">+</span><span class="sc11">SIZECENTRALHEADER</span><span class="sc10">+</span><span class="sc11">size_filename</span><span class="sc10">+</span><span class="sc0">
              </span><span class="sc11">size_extrafield_global</span><span class="sc10">+</span><span class="sc11">i</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">*(</span><span class="sc11">comment</span><span class="sc10">+</span><span class="sc11">i</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">central_header</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">ZIP_INTERNALERROR</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc1">/* write the local header */</span><span class="sc0">
    </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ziplocal_putValue</span><span class="sc10">(&amp;</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">filestream</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">LOCALHEADERMAGIC</span><span class="sc10">,</span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ziplocal_putValue</span><span class="sc10">(&amp;</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">filestream</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc4">20</span><span class="sc10">,</span><span class="sc4">2</span><span class="sc10">);</span><span class="sc1">/* version needed to extract */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ziplocal_putValue</span><span class="sc10">(&amp;</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">filestream</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">flag</span><span class="sc10">,</span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ziplocal_putValue</span><span class="sc10">(&amp;</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">filestream</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">method</span><span class="sc10">,</span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ziplocal_putValue</span><span class="sc10">(&amp;</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">filestream</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">dosDate</span><span class="sc10">,</span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ziplocal_putValue</span><span class="sc10">(&amp;</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">filestream</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc1">/* crc 32, unknown */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ziplocal_putValue</span><span class="sc10">(&amp;</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">filestream</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc1">/* compressed size, unknown */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ziplocal_putValue</span><span class="sc10">(&amp;</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">filestream</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc1">/* uncompressed size, unknown */</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ziplocal_putValue</span><span class="sc10">(&amp;</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">filestream</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">size_filename</span><span class="sc10">,</span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ziplocal_putValue</span><span class="sc10">(&amp;</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">filestream</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">size_extrafield_local</span><span class="sc10">,</span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">size_filename</span><span class="sc10">&gt;</span><span class="sc4">0</span><span class="sc10">))</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ZWRITE</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">filestream</span><span class="sc10">,</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc11">size_filename</span><span class="sc10">)!=</span><span class="sc11">size_filename</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ZIP_ERRNO</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">size_extrafield_local</span><span class="sc10">&gt;</span><span class="sc4">0</span><span class="sc10">))</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ZWRITE</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">filestream</span><span class="sc10">,</span><span class="sc11">extrafield_local</span><span class="sc10">,</span><span class="sc11">size_extrafield_local</span><span class="sc10">)</span><span class="sc0">
                                                                           </span><span class="sc10">!=</span><span class="sc11">size_extrafield_local</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ZIP_ERRNO</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">avail_in</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">uInt</span><span class="sc10">)</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">avail_out</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">uInt</span><span class="sc10">)</span><span class="sc11">Z_BUFSIZE</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">next_out</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">buffered_data</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">total_in</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">total_out</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">method</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">Z_DEFLATED</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">raw</span><span class="sc10">))</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">zalloc</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">alloc_func</span><span class="sc10">)</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">zfree</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">free_func</span><span class="sc10">)</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">opaque</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">voidpf</span><span class="sc10">)</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">windowBits</span><span class="sc10">&gt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">windowBits</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc11">windowBits</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">deflateInit2</span><span class="sc10">(&amp;</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">level</span><span class="sc10">,</span><span class="sc0">
               </span><span class="sc11">Z_DEFLATED</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">windowBits</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">memLevel</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strategy</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">Z_OK</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream_initialised</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc9">#    ifndef NOCRYPT
</span><span class="sc0">    </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">crypt_header_size</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">Z_OK</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">password</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">))</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">bufHead</span><span class="sc10">[</span><span class="sc11">RAND_HEAD_LEN</span><span class="sc10">];</span><span class="sc0">
        </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">sizeHead</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">encrypt</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">pcrc_32_tab</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">get_crc_table</span><span class="sc10">();</span><span class="sc0">
        </span><span class="sc1">/*init_keys(password,zi-&gt;ci.keys,zi-&gt;ci.pcrc_32_tab);*/</span><span class="sc0">

        </span><span class="sc11">sizeHead</span><span class="sc10">=</span><span class="sc11">crypthead</span><span class="sc10">(</span><span class="sc11">password</span><span class="sc10">,</span><span class="sc11">bufHead</span><span class="sc10">,</span><span class="sc11">RAND_HEAD_LEN</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">keys</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">pcrc_32_tab</span><span class="sc10">,</span><span class="sc11">crcForCrypting</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">crypt_header_size</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">sizeHead</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ZWRITE</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">filestream</span><span class="sc10">,</span><span class="sc11">bufHead</span><span class="sc10">,</span><span class="sc11">sizeHead</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">sizeHead</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ZIP_ERRNO</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc9">#    endif
</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">Z_OK</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">in_opened_file_inzip</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">err</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ZEXPORT</span><span class="sc0"> </span><span class="sc11">zipOpenNewFileInZip2</span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">zipfi</span><span class="sc10">,</span><span class="sc0">
                                        </span><span class="sc11">extrafield_local</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">size_extrafield_local</span><span class="sc10">,</span><span class="sc0">
                                        </span><span class="sc11">extrafield_global</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">size_extrafield_global</span><span class="sc10">,</span><span class="sc0">
                                        </span><span class="sc11">comment</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">method</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">level</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">raw</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc11">zipFile</span><span class="sc0"> </span><span class="sc11">file</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">filename</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc11">zip_fileinfo</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">zipfi</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">extrafield_local</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">uInt</span><span class="sc0"> </span><span class="sc11">size_extrafield_local</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">extrafield_global</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">uInt</span><span class="sc0"> </span><span class="sc11">size_extrafield_global</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">comment</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">method</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">level</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">raw</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">zipOpenNewFileInZip3</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">zipfi</span><span class="sc10">,</span><span class="sc0">
                                 </span><span class="sc11">extrafield_local</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">size_extrafield_local</span><span class="sc10">,</span><span class="sc0">
                                 </span><span class="sc11">extrafield_global</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">size_extrafield_global</span><span class="sc10">,</span><span class="sc0">
                                 </span><span class="sc11">comment</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">method</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">level</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">raw</span><span class="sc10">,</span><span class="sc0">
                                 </span><span class="sc10">-</span><span class="sc11">MAX_WBITS</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">DEF_MEM_LEVEL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Z_DEFAULT_STRATEGY</span><span class="sc10">,</span><span class="sc0">
                                 </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ZEXPORT</span><span class="sc0"> </span><span class="sc11">zipOpenNewFileInZip</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">zipfi</span><span class="sc10">,</span><span class="sc0">
                                        </span><span class="sc11">extrafield_local</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">size_extrafield_local</span><span class="sc10">,</span><span class="sc0">
                                        </span><span class="sc11">extrafield_global</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">size_extrafield_global</span><span class="sc10">,</span><span class="sc0">
                                        </span><span class="sc11">comment</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">method</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">level</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc11">zipFile</span><span class="sc0"> </span><span class="sc11">file</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">filename</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc11">zip_fileinfo</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">zipfi</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">extrafield_local</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">uInt</span><span class="sc0"> </span><span class="sc11">size_extrafield_local</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">extrafield_global</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">uInt</span><span class="sc0"> </span><span class="sc11">size_extrafield_global</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">comment</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">method</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">level</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">zipOpenNewFileInZip2</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">zipfi</span><span class="sc10">,</span><span class="sc0">
                                 </span><span class="sc11">extrafield_local</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">size_extrafield_local</span><span class="sc10">,</span><span class="sc0">
                                 </span><span class="sc11">extrafield_global</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">size_extrafield_global</span><span class="sc10">,</span><span class="sc0">
                                 </span><span class="sc11">comment</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">method</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">level</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">local</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">zipFlushWriteBuffer</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">)</span><span class="sc0">
  </span><span class="sc11">zip_internal</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">zi</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">err</span><span class="sc10">=</span><span class="sc11">ZIP_OK</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">encrypt</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc9">#ifndef NOCRYPT
</span><span class="sc0">        </span><span class="sc11">uInt</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">t</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">pos_in_buffered_data</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
            </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">buffered_data</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">zencode</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">keys</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">pcrc_32_tab</span><span class="sc10">,</span><span class="sc0">
                                       </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">buffered_data</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">],</span><span class="sc11">t</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ZWRITE</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">filestream</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">buffered_data</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">pos_in_buffered_data</span><span class="sc10">)</span><span class="sc0">
                                                                    </span><span class="sc10">!=</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">pos_in_buffered_data</span><span class="sc10">)</span><span class="sc0">
      </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ZIP_ERRNO</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">pos_in_buffered_data</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">err</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ZEXPORT</span><span class="sc0"> </span><span class="sc11">zipWriteInFileInZip</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc11">zipFile</span><span class="sc0"> </span><span class="sc11">file</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">zip_internal</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">zi</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">err</span><span class="sc10">=</span><span class="sc11">ZIP_OK</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">file</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">ZIP_PARAMERROR</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">zi</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">zip_internal</span><span class="sc10">*)</span><span class="sc11">file</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">in_opened_file_inzip</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">ZIP_PARAMERROR</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">next_in</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">*)</span><span class="sc11">buf</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">avail_in</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">crc32</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">crc32</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">crc32</span><span class="sc10">,</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc11">len</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">avail_in</span><span class="sc10">&gt;</span><span class="sc4">0</span><span class="sc10">))</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">avail_out</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">zipFlushWriteBuffer</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">ZIP_ERRNO</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ZIP_ERRNO</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">avail_out</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">uInt</span><span class="sc10">)</span><span class="sc11">Z_BUFSIZE</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">next_out</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">buffered_data</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">


        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">method</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">Z_DEFLATED</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">raw</span><span class="sc10">))</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">uTotalOutBefore</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">total_out</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">err</span><span class="sc10">=</span><span class="sc11">deflate</span><span class="sc10">(&amp;</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">,</span><span class="sc0">  </span><span class="sc11">Z_NO_FLUSH</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">pos_in_buffered_data</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">uInt</span><span class="sc10">)(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">total_out</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">uTotalOutBefore</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc5">else</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">uInt</span><span class="sc0"> </span><span class="sc11">copy_this</span><span class="sc10">,</span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">avail_in</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">avail_out</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc11">copy_this</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">avail_in</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">else</span><span class="sc0">
                </span><span class="sc11">copy_this</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">avail_out</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">copy_this</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
                </span><span class="sc10">*(((</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">next_out</span><span class="sc10">)+</span><span class="sc11">i</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">
                    </span><span class="sc10">*(((</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">next_in</span><span class="sc10">)+</span><span class="sc11">i</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">avail_in</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc11">copy_this</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">avail_out</span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc11">copy_this</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">next_in</span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">copy_this</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">next_out</span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">copy_this</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">total_in</span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">copy_this</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">total_out</span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">copy_this</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">pos_in_buffered_data</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">copy_this</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">err</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ZEXPORT</span><span class="sc0"> </span><span class="sc11">zipCloseFileInZipRaw</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">uncompressed_size</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">crc32</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc11">zipFile</span><span class="sc0"> </span><span class="sc11">file</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">uncompressed_size</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">crc32</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">zip_internal</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">zi</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">compressed_size</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">err</span><span class="sc10">=</span><span class="sc11">ZIP_OK</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">file</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">ZIP_PARAMERROR</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">zi</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">zip_internal</span><span class="sc10">*)</span><span class="sc11">file</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">in_opened_file_inzip</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">ZIP_PARAMERROR</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">avail_in</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">method</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">Z_DEFLATED</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">raw</span><span class="sc10">))</span><span class="sc0">
        </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">uTotalOutBefore</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">avail_out</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">zipFlushWriteBuffer</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">ZIP_ERRNO</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ZIP_ERRNO</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">avail_out</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">uInt</span><span class="sc10">)</span><span class="sc11">Z_BUFSIZE</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">next_out</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">buffered_data</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">uTotalOutBefore</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">total_out</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">err</span><span class="sc10">=</span><span class="sc11">deflate</span><span class="sc10">(&amp;</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">,</span><span class="sc0">  </span><span class="sc11">Z_FINISH</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">pos_in_buffered_data</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">uInt</span><span class="sc10">)(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">total_out</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">uTotalOutBefore</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">Z_STREAM_END</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">err</span><span class="sc10">=</span><span class="sc11">ZIP_OK</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc1">/* this is normal */</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">pos_in_buffered_data</span><span class="sc10">&gt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">))</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">zipFlushWriteBuffer</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">)==</span><span class="sc11">ZIP_ERRNO</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ZIP_ERRNO</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">method</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">Z_DEFLATED</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">raw</span><span class="sc10">))</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">err</span><span class="sc10">=</span><span class="sc11">deflateEnd</span><span class="sc10">(&amp;</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream_initialised</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">raw</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">crc32</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">crc32</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">uncompressed_size</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">total_in</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc11">compressed_size</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">total_out</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#    ifndef NOCRYPT
</span><span class="sc0">    </span><span class="sc11">compressed_size</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">crypt_header_size</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#    endif
</span><span class="sc0">
    </span><span class="sc11">ziplocal_putValue_inmemory</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">central_header</span><span class="sc10">+</span><span class="sc4">16</span><span class="sc10">,</span><span class="sc11">crc32</span><span class="sc10">,</span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc1">/*crc*/</span><span class="sc0">
    </span><span class="sc11">ziplocal_putValue_inmemory</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">central_header</span><span class="sc10">+</span><span class="sc4">20</span><span class="sc10">,</span><span class="sc0">
                                </span><span class="sc11">compressed_size</span><span class="sc10">,</span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc1">/*compr size*/</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">stream</span><span class="sc10">.</span><span class="sc11">data_type</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">Z_ASCII</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">ziplocal_putValue_inmemory</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">central_header</span><span class="sc10">+</span><span class="sc4">36</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">Z_ASCII</span><span class="sc10">,</span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">ziplocal_putValue_inmemory</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">central_header</span><span class="sc10">+</span><span class="sc4">24</span><span class="sc10">,</span><span class="sc0">
                                </span><span class="sc11">uncompressed_size</span><span class="sc10">,</span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc1">/*uncompr size*/</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">add_data_in_datablock</span><span class="sc10">(&amp;</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">central_dir</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">central_header</span><span class="sc10">,</span><span class="sc0">
                                       </span><span class="sc10">(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">size_centralheader</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">free</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">central_header</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">cur_pos_inzip</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ZTELL</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">filestream</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ZSEEK</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">filestream</span><span class="sc10">,</span><span class="sc0">
                  </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">pos_local_header</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">14</span><span class="sc10">,</span><span class="sc11">ZLIB_FILEFUNC_SEEK_SET</span><span class="sc10">)!=</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ZIP_ERRNO</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ziplocal_putValue</span><span class="sc10">(&amp;</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">filestream</span><span class="sc10">,</span><span class="sc11">crc32</span><span class="sc10">,</span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc1">/* crc 32, unknown */</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* compressed size, unknown */</span><span class="sc0">
            </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ziplocal_putValue</span><span class="sc10">(&amp;</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">filestream</span><span class="sc10">,</span><span class="sc11">compressed_size</span><span class="sc10">,</span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* uncompressed size, unknown */</span><span class="sc0">
            </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ziplocal_putValue</span><span class="sc10">(&amp;</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">filestream</span><span class="sc10">,</span><span class="sc11">uncompressed_size</span><span class="sc10">,</span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ZSEEK</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">filestream</span><span class="sc10">,</span><span class="sc0">
                  </span><span class="sc11">cur_pos_inzip</span><span class="sc10">,</span><span class="sc11">ZLIB_FILEFUNC_SEEK_SET</span><span class="sc10">)!=</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ZIP_ERRNO</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">number_entry</span><span class="sc0"> </span><span class="sc10">++;</span><span class="sc0">
    </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">in_opened_file_inzip</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">err</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ZEXPORT</span><span class="sc0"> </span><span class="sc11">zipCloseFileInZip</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc11">zipFile</span><span class="sc0"> </span><span class="sc11">file</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">zipCloseFileInZipRaw</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ZEXPORT</span><span class="sc0"> </span><span class="sc11">zipClose</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">global_comment</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc11">zipFile</span><span class="sc0"> </span><span class="sc11">file</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">global_comment</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">zip_internal</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">zi</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">size_centraldir</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">centraldir_pos_inzip</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">uInt</span><span class="sc0"> </span><span class="sc11">size_global_comment</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">file</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">ZIP_PARAMERROR</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">zi</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">zip_internal</span><span class="sc10">*)</span><span class="sc11">file</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">in_opened_file_inzip</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">zipCloseFileInZip</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

</span><span class="sc9">#ifndef NO_ADDFILEINEXISTINGZIP
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">global_comment</span><span class="sc10">==</span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">global_comment</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">globalcomment</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">global_comment</span><span class="sc10">==</span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">size_global_comment</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">else</span><span class="sc0">
        </span><span class="sc11">size_global_comment</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">uInt</span><span class="sc10">)</span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">global_comment</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">centraldir_pos_inzip</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ZTELL</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">filestream</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">linkedlist_datablock_internal</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">ldi</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">central_dir</span><span class="sc10">.</span><span class="sc11">first_block</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ldi</span><span class="sc10">!=</span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ldi</span><span class="sc10">-&gt;</span><span class="sc11">filled_in_this_block</span><span class="sc10">&gt;</span><span class="sc4">0</span><span class="sc10">))</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ZWRITE</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">filestream</span><span class="sc10">,</span><span class="sc0">
                           </span><span class="sc11">ldi</span><span class="sc10">-&gt;</span><span class="sc11">data</span><span class="sc10">,</span><span class="sc11">ldi</span><span class="sc10">-&gt;</span><span class="sc11">filled_in_this_block</span><span class="sc10">)</span><span class="sc0">
                              </span><span class="sc10">!=</span><span class="sc11">ldi</span><span class="sc10">-&gt;</span><span class="sc11">filled_in_this_block</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ZIP_ERRNO</span><span class="sc10">;</span><span class="sc0">

            </span><span class="sc11">size_centraldir</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">ldi</span><span class="sc10">-&gt;</span><span class="sc11">filled_in_this_block</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">ldi</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ldi</span><span class="sc10">-&gt;</span><span class="sc11">next_datablock</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc11">free_datablock</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">central_dir</span><span class="sc10">.</span><span class="sc11">first_block</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* Magic End */</span><span class="sc0">
        </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ziplocal_putValue</span><span class="sc10">(&amp;</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">filestream</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">ENDHEADERMAGIC</span><span class="sc10">,</span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* number of this disk */</span><span class="sc0">
        </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ziplocal_putValue</span><span class="sc10">(&amp;</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">filestream</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* number of the disk with the start of the central directory */</span><span class="sc0">
        </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ziplocal_putValue</span><span class="sc10">(&amp;</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">filestream</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* total number of entries in the central dir on this disk */</span><span class="sc0">
        </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ziplocal_putValue</span><span class="sc10">(&amp;</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">filestream</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">number_entry</span><span class="sc10">,</span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* total number of entries in the central dir */</span><span class="sc0">
        </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ziplocal_putValue</span><span class="sc10">(&amp;</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">filestream</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">number_entry</span><span class="sc10">,</span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* size of the central directory */</span><span class="sc0">
        </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ziplocal_putValue</span><span class="sc10">(&amp;</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">filestream</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">size_centraldir</span><span class="sc10">,</span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* offset of start of central directory with respect to the
                            starting disk number */</span><span class="sc0">
        </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ziplocal_putValue</span><span class="sc10">(&amp;</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">filestream</span><span class="sc10">,</span><span class="sc0">
                                </span><span class="sc10">(</span><span class="sc11">uLong</span><span class="sc10">)(</span><span class="sc11">centraldir_pos_inzip</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">add_position_when_writting_offset</span><span class="sc10">),</span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* zipfile comment length */</span><span class="sc0">
        </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ziplocal_putValue</span><span class="sc10">(&amp;</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">filestream</span><span class="sc10">,(</span><span class="sc11">uLong</span><span class="sc10">)</span><span class="sc11">size_global_comment</span><span class="sc10">,</span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">err</span><span class="sc10">==</span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">size_global_comment</span><span class="sc10">&gt;</span><span class="sc4">0</span><span class="sc10">))</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ZWRITE</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">filestream</span><span class="sc10">,</span><span class="sc0">
                   </span><span class="sc11">global_comment</span><span class="sc10">,</span><span class="sc11">size_global_comment</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">size_global_comment</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ZIP_ERRNO</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ZCLOSE</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">z_filefunc</span><span class="sc10">,</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">filestream</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">ZIP_OK</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ZIP_ERRNO</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc9">#ifndef NO_ADDFILEINEXISTINGZIP
</span><span class="sc0">    </span><span class="sc11">TRYFREE</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">-&gt;</span><span class="sc11">globalcomment</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">    </span><span class="sc11">TRYFREE</span><span class="sc10">(</span><span class="sc11">zi</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">err</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span></div></body>
</html>
