<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">/* adler32.c -- compute the Adler-32 checksum of a data stream
 * Copyright (C) 1995-2004 Mark Adler
 * For conditions of distribution and use, see copyright notice in zlib.h
 */</span><span class="sc0">

</span><span class="sc1">/* @(#) $Id$ */</span><span class="sc0">

</span><span class="sc9">#define ZLIB_INTERNAL
#include "zlib.h"
</span><span class="sc0">
</span><span class="sc9">#define BASE 65521UL    </span><span class="sc1">/* largest prime smaller than 65536 */</span><span class="sc0">
</span><span class="sc9">#define NMAX 5552
</span><span class="sc1">/* NMAX is the largest n such that 255n(n+1)/2 + (n+1)(BASE-1) &lt;= 2^32-1 */</span><span class="sc0">

</span><span class="sc9">#define DO1(buf,i)  {adler += (buf)[i]; sum2 += adler;}
#define DO2(buf,i)  DO1(buf,i); DO1(buf,i+1);
#define DO4(buf,i)  DO2(buf,i); DO2(buf,i+2);
#define DO8(buf,i)  DO4(buf,i); DO4(buf,i+4);
#define DO16(buf)   DO8(buf,0); DO8(buf,8);
</span><span class="sc0">
</span><span class="sc1">/* use NO_DIVIDE if your processor does not do division in hardware */</span><span class="sc0">
</span><span class="sc9">#ifdef NO_DIVIDE
#  define MOD(a) \
    do { \
        if (a &gt;= (BASE &lt;&lt; 16)) a -= (BASE &lt;&lt; 16); \
        if (a &gt;= (BASE &lt;&lt; 15)) a -= (BASE &lt;&lt; 15); \
        if (a &gt;= (BASE &lt;&lt; 14)) a -= (BASE &lt;&lt; 14); \
        if (a &gt;= (BASE &lt;&lt; 13)) a -= (BASE &lt;&lt; 13); \
        if (a &gt;= (BASE &lt;&lt; 12)) a -= (BASE &lt;&lt; 12); \
        if (a &gt;= (BASE &lt;&lt; 11)) a -= (BASE &lt;&lt; 11); \
        if (a &gt;= (BASE &lt;&lt; 10)) a -= (BASE &lt;&lt; 10); \
        if (a &gt;= (BASE &lt;&lt; 9)) a -= (BASE &lt;&lt; 9); \
        if (a &gt;= (BASE &lt;&lt; 8)) a -= (BASE &lt;&lt; 8); \
        if (a &gt;= (BASE &lt;&lt; 7)) a -= (BASE &lt;&lt; 7); \
        if (a &gt;= (BASE &lt;&lt; 6)) a -= (BASE &lt;&lt; 6); \
        if (a &gt;= (BASE &lt;&lt; 5)) a -= (BASE &lt;&lt; 5); \
        if (a &gt;= (BASE &lt;&lt; 4)) a -= (BASE &lt;&lt; 4); \
        if (a &gt;= (BASE &lt;&lt; 3)) a -= (BASE &lt;&lt; 3); \
        if (a &gt;= (BASE &lt;&lt; 2)) a -= (BASE &lt;&lt; 2); \
        if (a &gt;= (BASE &lt;&lt; 1)) a -= (BASE &lt;&lt; 1); \
        if (a &gt;= BASE) a -= BASE; \
    } while (0)
#  define MOD4(a) \
    do { \
        if (a &gt;= (BASE &lt;&lt; 4)) a -= (BASE &lt;&lt; 4); \
        if (a &gt;= (BASE &lt;&lt; 3)) a -= (BASE &lt;&lt; 3); \
        if (a &gt;= (BASE &lt;&lt; 2)) a -= (BASE &lt;&lt; 2); \
        if (a &gt;= (BASE &lt;&lt; 1)) a -= (BASE &lt;&lt; 1); \
        if (a &gt;= BASE) a -= BASE; \
    } while (0)
#else
#  define MOD(a) a %= BASE
#  define MOD4(a) a %= BASE
#endif
</span><span class="sc0">
</span><span class="sc1">/* ========================================================================= */</span><span class="sc0">
</span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">ZEXPORT</span><span class="sc0"> </span><span class="sc11">adler32</span><span class="sc10">(</span><span class="sc11">adler</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">adler</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc11">Bytef</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">buf</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">uInt</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">sum2</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc1">/* split Adler-32 into component sums */</span><span class="sc0">
    </span><span class="sc11">sum2</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">adler</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0xffff</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">adler</span><span class="sc0"> </span><span class="sc10">&amp;=</span><span class="sc0"> </span><span class="sc4">0xffff</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc1">/* in case user likes doing a byte at a time, keep it fast */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">len</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">adler</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">];</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">adler</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">BASE</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">adler</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc11">BASE</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">sum2</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">adler</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sum2</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">BASE</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">sum2</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc11">BASE</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">adler</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sum2</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc1">/* initial Adler-32 value (deferred check for len == 1 speed) */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">Z_NULL</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1L</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc1">/* in case short lengths are provided, keep it somewhat fast */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">len</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">len</span><span class="sc10">--)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">adler</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">buf</span><span class="sc10">++;</span><span class="sc0">
            </span><span class="sc11">sum2</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">adler</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">adler</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">BASE</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">adler</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc11">BASE</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">MOD4</span><span class="sc10">(</span><span class="sc11">sum2</span><span class="sc10">);</span><span class="sc0">             </span><span class="sc1">/* only added so many BASE's */</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">adler</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sum2</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc1">/* do length NMAX blocks -- requires just one modulo operation */</span><span class="sc0">
    </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">len</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">NMAX</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">len</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc11">NMAX</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">NMAX</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">;</span><span class="sc0">          </span><span class="sc1">/* NMAX is divisible by 16 */</span><span class="sc0">
        </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">DO16</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">);</span><span class="sc0">          </span><span class="sc1">/* 16 sums unrolled */</span><span class="sc0">
            </span><span class="sc11">buf</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(--</span><span class="sc11">n</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">MOD</span><span class="sc10">(</span><span class="sc11">adler</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">MOD</span><span class="sc10">(</span><span class="sc11">sum2</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc1">/* do remaining bytes (less than NMAX, still just one modulo) */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">len</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">                  </span><span class="sc1">/* avoid modulos if none remaining */</span><span class="sc0">
        </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">len</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">len</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">DO16</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">buf</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">len</span><span class="sc10">--)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">adler</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">buf</span><span class="sc10">++;</span><span class="sc0">
            </span><span class="sc11">sum2</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">adler</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">MOD</span><span class="sc10">(</span><span class="sc11">adler</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">MOD</span><span class="sc10">(</span><span class="sc11">sum2</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc1">/* return recombined sums */</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">adler</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sum2</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc1">/* ========================================================================= */</span><span class="sc0">
</span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">ZEXPORT</span><span class="sc0"> </span><span class="sc11">adler32_combine</span><span class="sc10">(</span><span class="sc11">adler1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">adler2</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">len2</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">adler1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">adler2</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">z_off_t</span><span class="sc0"> </span><span class="sc11">len2</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">sum1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">sum2</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc11">rem</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc1">/* the derivation of this formula is left as an exercise for the reader */</span><span class="sc0">
    </span><span class="sc11">rem</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc10">)(</span><span class="sc11">len2</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc11">BASE</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">sum1</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">adler1</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0xffff</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">sum2</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">rem</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">sum1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">MOD</span><span class="sc10">(</span><span class="sc11">sum2</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">sum1</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">adler2</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0xffff</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">BASE</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">sum2</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">adler1</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0xffff</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">adler2</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0xffff</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">BASE</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">rem</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sum1</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc11">BASE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">sum1</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc11">BASE</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sum1</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc11">BASE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">sum1</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc11">BASE</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sum2</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">BASE</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc11">sum2</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">BASE</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sum2</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc11">BASE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">sum2</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc11">BASE</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">sum1</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sum2</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span></div></body>
</html>
