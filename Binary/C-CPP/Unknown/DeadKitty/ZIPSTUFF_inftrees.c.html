<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">/* inftrees.c -- generate Huffman trees for efficient decoding
 * Copyright (C) 1995-2005 Mark Adler
 * For conditions of distribution and use, see copyright notice in zlib.h
 */</span><span class="sc0">

</span><span class="sc9">#include "zutil.h"
#include "inftrees.h"
</span><span class="sc0">
</span><span class="sc9">#define MAXBITS 15
</span><span class="sc0">
</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">inflate_copyright</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">
   </span><span class="sc6">" inflate 1.2.3 Copyright 1995-2005 Mark Adler "</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc1">/*
  If you use the zlib library in a product, an acknowledgment is welcome
  in the documentation of your product. If for some reason you cannot
  include such an acknowledgment, I would appreciate that you keep this
  copyright string in the executable of your product.
 */</span><span class="sc0">

</span><span class="sc1">/*
   Build a set of tables to decode the provided canonical Huffman code.
   The code lengths are lens[0..codes-1].  The result starts at *table,
   whose indices are 0..2^bits-1.  work is a writable array of at least
   lens shorts, which is used as a work area.  type is the type of code
   to be generated, CODES, LENS, or DISTS.  On return, zero is success,
   -1 is an invalid code, and +1 means that ENOUGH isn't enough.  table
   on return points to the next available entry's address.  bits is the
   requested root table index bits, and on return it is the actual root
   table index bits.  It will differ if the request is greater than the
   longest code or if it is less than the shortest code.
 */</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">inflate_table</span><span class="sc10">(</span><span class="sc11">type</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">lens</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">codes</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">table</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">bits</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">work</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc11">codetype</span><span class="sc0"> </span><span class="sc11">type</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">FAR</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">lens</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc11">codes</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">code</span><span class="sc0"> </span><span class="sc11">FAR</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">FAR</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">table</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc11">FAR</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">bits</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">FAR</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">work</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc10">;</span><span class="sc0">               </span><span class="sc1">/* a code's length in bits */</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc11">sym</span><span class="sc10">;</span><span class="sc0">               </span><span class="sc1">/* index of code symbols */</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc11">min</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">max</span><span class="sc10">;</span><span class="sc0">          </span><span class="sc1">/* minimum and maximum code lengths */</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc11">root</span><span class="sc10">;</span><span class="sc0">              </span><span class="sc1">/* number of index bits for root table */</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc11">curr</span><span class="sc10">;</span><span class="sc0">              </span><span class="sc1">/* number of index bits for current table */</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc11">drop</span><span class="sc10">;</span><span class="sc0">              </span><span class="sc1">/* code bits to drop for sub-table */</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">left</span><span class="sc10">;</span><span class="sc0">                   </span><span class="sc1">/* number of prefix codes available */</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc11">used</span><span class="sc10">;</span><span class="sc0">              </span><span class="sc1">/* code entries in table used */</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc11">huff</span><span class="sc10">;</span><span class="sc0">              </span><span class="sc1">/* Huffman code */</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc11">incr</span><span class="sc10">;</span><span class="sc0">              </span><span class="sc1">/* for incrementing code, index */</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc11">fill</span><span class="sc10">;</span><span class="sc0">              </span><span class="sc1">/* index for replicating entries */</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc11">low</span><span class="sc10">;</span><span class="sc0">               </span><span class="sc1">/* low bits for current root entry */</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc11">mask</span><span class="sc10">;</span><span class="sc0">              </span><span class="sc1">/* mask for low root bits */</span><span class="sc0">
    </span><span class="sc11">code</span><span class="sc0"> </span><span class="sc11">this</span><span class="sc10">;</span><span class="sc0">                  </span><span class="sc1">/* table entry for duplication */</span><span class="sc0">
    </span><span class="sc11">code</span><span class="sc0"> </span><span class="sc11">FAR</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">next</span><span class="sc10">;</span><span class="sc0">             </span><span class="sc1">/* next available space in table */</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">FAR</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">base</span><span class="sc10">;</span><span class="sc0">     </span><span class="sc1">/* base value table to use */</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">FAR</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">extra</span><span class="sc10">;</span><span class="sc0">    </span><span class="sc1">/* extra bits table to use */</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">end</span><span class="sc10">;</span><span class="sc0">                    </span><span class="sc1">/* use base and extra for symbol &gt; end */</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">count</span><span class="sc10">[</span><span class="sc11">MAXBITS</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">];</span><span class="sc0">    </span><span class="sc1">/* number of codes of each length */</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">offs</span><span class="sc10">[</span><span class="sc11">MAXBITS</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">];</span><span class="sc0">     </span><span class="sc1">/* offsets in table for each length */</span><span class="sc0">
    </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">lbase</span><span class="sc10">[</span><span class="sc4">31</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc1">/* Length codes 257..285 base */</span><span class="sc0">
        </span><span class="sc4">3</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">5</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">6</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">7</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">9</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">10</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">11</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">13</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">15</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">17</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">19</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">23</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">27</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">31</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc4">35</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">43</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">51</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">59</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">67</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">83</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">99</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">115</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">131</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">163</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">195</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">227</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">258</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">};</span><span class="sc0">
    </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">lext</span><span class="sc10">[</span><span class="sc4">31</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc1">/* Length codes 257..285 extra */</span><span class="sc0">
        </span><span class="sc4">16</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">17</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">17</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">17</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">17</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">18</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">18</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">18</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">18</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc4">19</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">19</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">19</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">19</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">20</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">20</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">20</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">20</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">21</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">21</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">21</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">21</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">201</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">196</span><span class="sc10">};</span><span class="sc0">
    </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">dbase</span><span class="sc10">[</span><span class="sc4">32</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc1">/* Distance codes 0..29 base */</span><span class="sc0">
        </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">5</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">7</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">9</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">13</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">17</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">25</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">33</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">49</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">65</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">97</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">129</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">193</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc4">257</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">385</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">513</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">769</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1025</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1537</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">2049</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">3073</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">4097</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">6145</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc4">8193</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">12289</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">16385</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">24577</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">};</span><span class="sc0">
    </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">dext</span><span class="sc10">[</span><span class="sc4">32</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc1">/* Distance codes 0..29 extra */</span><span class="sc0">
        </span><span class="sc4">16</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">17</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">17</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">18</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">18</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">19</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">19</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">20</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">20</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">21</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">21</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">22</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">22</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc4">23</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">23</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">24</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">24</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">25</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">25</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">26</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">26</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">27</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">27</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc4">28</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">28</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">29</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">29</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">64</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">64</span><span class="sc10">};</span><span class="sc0">

    </span><span class="sc1">/*
       Process a set of code lengths to create a canonical Huffman code.  The
       code lengths are lens[0..codes-1].  Each length corresponds to the
       symbols 0..codes-1.  The Huffman code is generated by first sorting the
       symbols by length from short to long, and retaining the symbol order
       for codes with equal lengths.  Then the code starts with all zero bits
       for the first code of the shortest length, and the codes are integer
       increments for the same length, and zeros are appended as the length
       increases.  For the deflate format, these bits are stored backwards
       from their more natural integer increment ordering, and so when the
       decoding tables are built in the large loop below, the integer codes
       are incremented backwards.

       This routine assumes, but does not check, that all of the entries in
       lens[] are in the range 0..MAXBITS.  The caller must assure this.
       1..MAXBITS is interpreted as that code length.  zero means that that
       symbol does not occur in this code.

       The codes are sorted by computing a count of codes for each length,
       creating from that a table of starting indices for each length in the
       sorted table, and then entering the symbols in order in the sorted
       table.  The sorted table is work[], with that space being provided by
       the caller.

       The length counts are used for other purposes as well, i.e. finding
       the minimum and maximum length codes, determining if there are any
       codes at all, checking for a valid set of lengths, and looking ahead
       at length counts to determine sub-table sizes when building the
       decoding tables.
     */</span><span class="sc0">

    </span><span class="sc1">/* accumulate lengths for codes (assumes lens[] all in 0..MAXBITS) */</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">len</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc11">MAXBITS</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc11">count</span><span class="sc10">[</span><span class="sc11">len</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sym</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">sym</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">codes</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">sym</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc11">count</span><span class="sc10">[</span><span class="sc11">lens</span><span class="sc10">[</span><span class="sc11">sym</span><span class="sc10">]]++;</span><span class="sc0">

    </span><span class="sc1">/* bound code lengths, force root to be within code lengths */</span><span class="sc0">
    </span><span class="sc11">root</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">bits</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">max</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">MAXBITS</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">max</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">max</span><span class="sc10">--)</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">count</span><span class="sc10">[</span><span class="sc11">max</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">root</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc11">max</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">root</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">max</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">max</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">                     </span><span class="sc1">/* no symbols to code at all */</span><span class="sc0">
        </span><span class="sc11">this</span><span class="sc10">.</span><span class="sc11">op</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">)</span><span class="sc4">64</span><span class="sc10">;</span><span class="sc0">    </span><span class="sc1">/* invalid code marker */</span><span class="sc0">
        </span><span class="sc11">this</span><span class="sc10">.</span><span class="sc11">bits</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">)</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">this</span><span class="sc10">.</span><span class="sc11">val</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc10">)</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">*(*</span><span class="sc11">table</span><span class="sc10">)++</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">this</span><span class="sc10">;</span><span class="sc0">             </span><span class="sc1">/* make a table to force an error */</span><span class="sc0">
        </span><span class="sc10">*(*</span><span class="sc11">table</span><span class="sc10">)++</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">this</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">*</span><span class="sc11">bits</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">     </span><span class="sc1">/* no symbols, but wait for decoding to report error */</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">min</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">min</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc11">MAXBITS</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">min</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">count</span><span class="sc10">[</span><span class="sc11">min</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">root</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">min</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">root</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">min</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc1">/* check for an over-subscribed or incomplete set of lengths */</span><span class="sc0">
    </span><span class="sc11">left</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">len</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc11">MAXBITS</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">left</span><span class="sc0"> </span><span class="sc10">&lt;&lt;=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">left</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc11">count</span><span class="sc10">[</span><span class="sc11">len</span><span class="sc10">];</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">left</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">        </span><span class="sc1">/* over-subscribed */</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">left</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">type</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">CODES</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">max</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">))</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">                      </span><span class="sc1">/* incomplete set */</span><span class="sc0">

    </span><span class="sc1">/* generate offsets into symbol table for each length for sorting */</span><span class="sc0">
    </span><span class="sc11">offs</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">len</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">MAXBITS</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc11">offs</span><span class="sc10">[</span><span class="sc11">len</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">offs</span><span class="sc10">[</span><span class="sc11">len</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">count</span><span class="sc10">[</span><span class="sc11">len</span><span class="sc10">];</span><span class="sc0">

    </span><span class="sc1">/* sort symbols by length, by symbol order within each length */</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sym</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">sym</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">codes</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">sym</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">lens</span><span class="sc10">[</span><span class="sc11">sym</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">work</span><span class="sc10">[</span><span class="sc11">offs</span><span class="sc10">[</span><span class="sc11">lens</span><span class="sc10">[</span><span class="sc11">sym</span><span class="sc10">]]++]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc10">)</span><span class="sc11">sym</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc1">/*
       Create and fill in decoding tables.  In this loop, the table being
       filled is at next and has curr index bits.  The code being used is huff
       with length len.  That code is converted to an index by dropping drop
       bits off of the bottom.  For codes where len is less than drop + curr,
       those top drop + curr - len bits are incremented through all values to
       fill the table with replicated entries.

       root is the number of index bits for the root table.  When len exceeds
       root, sub-tables are created pointed to by the root entry with an index
       of the low root bits of huff.  This is saved in low to check for when a
       new sub-table should be started.  drop is zero when the root table is
       being filled, and drop is root when sub-tables are being filled.

       When a new sub-table is needed, it is necessary to look ahead in the
       code lengths to determine what size sub-table is needed.  The length
       counts are used for this, and so count[] is decremented as codes are
       entered in the tables.

       used keeps track of how many table entries have been allocated from the
       provided *table space.  It is checked when a LENS table is being made
       against the space in *table, ENOUGH, minus the maximum space needed by
       the worst case distance code, MAXD.  This should never happen, but the
       sufficiency of ENOUGH has not been proven exhaustively, hence the check.
       This assumes that when type == LENS, bits == 9.

       sym increments through all symbols, and the loop terminates when
       all codes of length max, i.e. all codes, have been processed.  This
       routine permits incomplete codes, so another loop after this one fills
       in the rest of the decoding tables with invalid code markers.
     */</span><span class="sc0">

    </span><span class="sc1">/* set up for code type */</span><span class="sc0">
    </span><span class="sc5">switch</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">type</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">CODES</span><span class="sc10">:</span><span class="sc0">
        </span><span class="sc11">base</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">extra</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">work</span><span class="sc10">;</span><span class="sc0">    </span><span class="sc1">/* dummy value--not used */</span><span class="sc0">
        </span><span class="sc11">end</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">19</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">LENS</span><span class="sc10">:</span><span class="sc0">
        </span><span class="sc11">base</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">lbase</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">base</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc4">257</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">extra</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">lext</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">extra</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc4">257</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">end</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">256</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">default</span><span class="sc10">:</span><span class="sc0">            </span><span class="sc1">/* DISTS */</span><span class="sc0">
        </span><span class="sc11">base</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">dbase</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">extra</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">dext</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">end</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc1">/* initialize state for loop */</span><span class="sc0">
    </span><span class="sc11">huff</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">                   </span><span class="sc1">/* starting code */</span><span class="sc0">
    </span><span class="sc11">sym</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">                    </span><span class="sc1">/* starting code symbol */</span><span class="sc0">
    </span><span class="sc11">len</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">min</span><span class="sc10">;</span><span class="sc0">                  </span><span class="sc1">/* starting code length */</span><span class="sc0">
    </span><span class="sc11">next</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">table</span><span class="sc10">;</span><span class="sc0">              </span><span class="sc1">/* current table to fill in */</span><span class="sc0">
    </span><span class="sc11">curr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">root</span><span class="sc10">;</span><span class="sc0">                </span><span class="sc1">/* current table index bits */</span><span class="sc0">
    </span><span class="sc11">drop</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">                   </span><span class="sc1">/* current bits to drop from code for index */</span><span class="sc0">
    </span><span class="sc11">low</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc10">)(-</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">       </span><span class="sc1">/* trigger new sub-table when len &gt; root */</span><span class="sc0">
    </span><span class="sc11">used</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1U</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc11">root</span><span class="sc10">;</span><span class="sc0">          </span><span class="sc1">/* use root table entries */</span><span class="sc0">
    </span><span class="sc11">mask</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">used</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">            </span><span class="sc1">/* mask for comparing low */</span><span class="sc0">

    </span><span class="sc1">/* check available table space */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">type</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">LENS</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">used</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">ENOUGH</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">MAXD</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc1">/* process all codes and make table entries */</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(;;)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc1">/* create table entry */</span><span class="sc0">
        </span><span class="sc11">this</span><span class="sc10">.</span><span class="sc11">bits</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">)(</span><span class="sc11">len</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">drop</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc16">int</span><span class="sc10">)(</span><span class="sc11">work</span><span class="sc10">[</span><span class="sc11">sym</span><span class="sc10">])</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">end</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">this</span><span class="sc10">.</span><span class="sc11">op</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">)</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">this</span><span class="sc10">.</span><span class="sc11">val</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">work</span><span class="sc10">[</span><span class="sc11">sym</span><span class="sc10">];</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc16">int</span><span class="sc10">)(</span><span class="sc11">work</span><span class="sc10">[</span><span class="sc11">sym</span><span class="sc10">])</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc11">end</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">this</span><span class="sc10">.</span><span class="sc11">op</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">)(</span><span class="sc11">extra</span><span class="sc10">[</span><span class="sc11">work</span><span class="sc10">[</span><span class="sc11">sym</span><span class="sc10">]]);</span><span class="sc0">
            </span><span class="sc11">this</span><span class="sc10">.</span><span class="sc11">val</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">base</span><span class="sc10">[</span><span class="sc11">work</span><span class="sc10">[</span><span class="sc11">sym</span><span class="sc10">]];</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">this</span><span class="sc10">.</span><span class="sc11">op</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">)(</span><span class="sc4">32</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">64</span><span class="sc10">);</span><span class="sc0">         </span><span class="sc1">/* end of block */</span><span class="sc0">
            </span><span class="sc11">this</span><span class="sc10">.</span><span class="sc11">val</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc1">/* replicate for those indices with low len bits equal to huff */</span><span class="sc0">
        </span><span class="sc11">incr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1U</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">len</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">drop</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">fill</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1U</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc11">curr</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">min</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">fill</span><span class="sc10">;</span><span class="sc0">                 </span><span class="sc1">/* save offset to next table */</span><span class="sc0">
        </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">fill</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc11">incr</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">next</span><span class="sc10">[(</span><span class="sc11">huff</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc11">drop</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">fill</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">this</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fill</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc1">/* backwards increment the len-bit code huff */</span><span class="sc0">
        </span><span class="sc11">incr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1U</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">len</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">huff</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc11">incr</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">incr</span><span class="sc0"> </span><span class="sc10">&gt;&gt;=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">incr</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">huff</span><span class="sc0"> </span><span class="sc10">&amp;=</span><span class="sc0"> </span><span class="sc11">incr</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">huff</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">incr</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc5">else</span><span class="sc0">
            </span><span class="sc11">huff</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc1">/* go to next symbol, update count, len */</span><span class="sc0">
        </span><span class="sc11">sym</span><span class="sc10">++;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(--(</span><span class="sc11">count</span><span class="sc10">[</span><span class="sc11">len</span><span class="sc10">])</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">len</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">max</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">len</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">lens</span><span class="sc10">[</span><span class="sc11">work</span><span class="sc10">[</span><span class="sc11">sym</span><span class="sc10">]];</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc1">/* create new sub-table if needed */</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">len</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc11">root</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">huff</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc11">mask</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">low</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc1">/* if first time, transition to sub-tables */</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">drop</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc11">drop</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">root</span><span class="sc10">;</span><span class="sc0">

            </span><span class="sc1">/* increment past last table */</span><span class="sc0">
            </span><span class="sc11">next</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">min</span><span class="sc10">;</span><span class="sc0">            </span><span class="sc1">/* here min is 1 &lt;&lt; curr */</span><span class="sc0">

            </span><span class="sc1">/* determine length of next table */</span><span class="sc0">
            </span><span class="sc11">curr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">drop</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">left</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">)(</span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc11">curr</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">curr</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">drop</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">max</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">left</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc11">count</span><span class="sc10">[</span><span class="sc11">curr</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">drop</span><span class="sc10">];</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">left</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">curr</span><span class="sc10">++;</span><span class="sc0">
                </span><span class="sc11">left</span><span class="sc0"> </span><span class="sc10">&lt;&lt;=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">

            </span><span class="sc1">/* check for enough space */</span><span class="sc0">
            </span><span class="sc11">used</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">1U</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc11">curr</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">type</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">LENS</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">used</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">ENOUGH</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">MAXD</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

            </span><span class="sc1">/* point entry in root table to sub-table */</span><span class="sc0">
            </span><span class="sc11">low</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">huff</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc11">mask</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">(*</span><span class="sc11">table</span><span class="sc10">)[</span><span class="sc11">low</span><span class="sc10">].</span><span class="sc11">op</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">)</span><span class="sc11">curr</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">(*</span><span class="sc11">table</span><span class="sc10">)[</span><span class="sc11">low</span><span class="sc10">].</span><span class="sc11">bits</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">)</span><span class="sc11">root</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">(*</span><span class="sc11">table</span><span class="sc10">)[</span><span class="sc11">low</span><span class="sc10">].</span><span class="sc11">val</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc10">)(</span><span class="sc11">next</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">table</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc1">/*
       Fill in rest of table for incomplete codes.  This loop is similar to the
       loop above in incrementing huff for table indices.  It is assumed that
       len is equal to curr + drop, so there is no loop needed to increment
       through high index bits.  When the current sub-table is filled, the loop
       drops back to the root table to fill in any remaining entries there.
     */</span><span class="sc0">
    </span><span class="sc11">this</span><span class="sc10">.</span><span class="sc11">op</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">)</span><span class="sc4">64</span><span class="sc10">;</span><span class="sc0">                </span><span class="sc1">/* invalid code marker */</span><span class="sc0">
    </span><span class="sc11">this</span><span class="sc10">.</span><span class="sc11">bits</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">)(</span><span class="sc11">len</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">drop</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">this</span><span class="sc10">.</span><span class="sc11">val</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc10">)</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">huff</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc1">/* when done with sub-table, drop back to root table */</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">drop</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">huff</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc11">mask</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">low</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">drop</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">len</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">root</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">next</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">table</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">this</span><span class="sc10">.</span><span class="sc11">bits</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">)</span><span class="sc11">len</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc1">/* put invalid code marker in table */</span><span class="sc0">
        </span><span class="sc11">next</span><span class="sc10">[</span><span class="sc11">huff</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc11">drop</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">this</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc1">/* backwards increment the len-bit code huff */</span><span class="sc0">
        </span><span class="sc11">incr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1U</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">len</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">huff</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc11">incr</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">incr</span><span class="sc0"> </span><span class="sc10">&gt;&gt;=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">incr</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">huff</span><span class="sc0"> </span><span class="sc10">&amp;=</span><span class="sc0"> </span><span class="sc11">incr</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">huff</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">incr</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc5">else</span><span class="sc0">
            </span><span class="sc11">huff</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc1">/* set return parameters */</span><span class="sc0">
    </span><span class="sc10">*</span><span class="sc11">table</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">used</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">*</span><span class="sc11">bits</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">root</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span></div></body>
</html>
