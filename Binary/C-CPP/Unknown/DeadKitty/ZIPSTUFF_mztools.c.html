<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc7 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">/*
  Additional tools for Minizip
  Code: Xavier Roche '2004
  License: Same as ZLIB (www.gzip.org)
*/</span><span class="sc0">

</span><span class="sc1">/* Code */</span><span class="sc0">
</span><span class="sc9">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include "zlib.h"
#include "unzip.h"
</span><span class="sc0">
</span><span class="sc9">#define READ_8(adr)  ((unsigned char)*(adr))
#define READ_16(adr) ( READ_8(adr) | (READ_8(adr+1) &lt;&lt; 8) )
#define READ_32(adr) ( READ_16(adr) | (READ_16((adr)+2) &lt;&lt; 16) )
</span><span class="sc0">
</span><span class="sc9">#define WRITE_8(buff, n) do { \
  *((unsigned char*)(buff)) = (unsigned char) ((n) &amp; 0xff); \
} while(0)
#define WRITE_16(buff, n) do { \
  WRITE_8((unsigned char*)(buff), n); \
  WRITE_8(((unsigned char*)(buff)) + 1, (n) &gt;&gt; 8); \
} while(0)
#define WRITE_32(buff, n) do { \
  WRITE_16((unsigned char*)(buff), (n) &amp; 0xffff); \
  WRITE_16((unsigned char*)(buff) + 2, (n) &gt;&gt; 16); \
} while(0)
</span><span class="sc0">
</span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ZEXPORT</span><span class="sc0"> </span><span class="sc11">unzRepair</span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fileOut</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fileOutTmp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">nRecovered</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">bytesRecovered</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">file</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">fileOut</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">fileOutTmp</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">uLong</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">nRecovered</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">uLong</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">bytesRecovered</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Z_OK</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">FILE</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">fpZip</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">fopen</span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"rb"</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc11">FILE</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">fpOut</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">fopen</span><span class="sc10">(</span><span class="sc11">fileOut</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"wb"</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc11">FILE</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">fpOutCD</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">fopen</span><span class="sc10">(</span><span class="sc11">fileOutTmp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"wb"</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fpZip</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0">  </span><span class="sc11">fpOut</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">entries</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">uLong</span><span class="sc0"> </span><span class="sc11">totalBytes</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">header</span><span class="sc10">[</span><span class="sc4">30</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">filename</span><span class="sc10">[</span><span class="sc4">256</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">extra</span><span class="sc10">[</span><span class="sc4">1024</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">offset</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">offsetCD</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">fread</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">30</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fpZip</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">30</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">currentOffset</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">offset</span><span class="sc10">;</span><span class="sc0">

      </span><span class="sc1">/* File entry */</span><span class="sc0">
      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">READ_32</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x04034b50</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">version</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">READ_16</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">gpflag</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">READ_16</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">6</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">method</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">READ_16</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">filetime</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">READ_16</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">10</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">filedate</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">READ_16</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">12</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">crc</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">READ_32</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">14</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc1">/* crc */</span><span class="sc0">
        </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">cpsize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">READ_32</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">18</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc1">/* compressed size */</span><span class="sc0">
        </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">uncpsize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">READ_32</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">22</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc1">/* uncompressed sz */</span><span class="sc0">
        </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fnsize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">READ_16</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">26</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc1">/* file name length */</span><span class="sc0">
        </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">extsize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">READ_16</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">28</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc1">/* extra field length */</span><span class="sc0">
        </span><span class="sc11">filename</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">extra</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc7">'\0'</span><span class="sc10">;</span><span class="sc0">
        
        </span><span class="sc1">/* Header */</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fwrite</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">30</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fpOut</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">30</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
          </span><span class="sc11">offset</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">30</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
          </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Z_ERRNO</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        
        </span><span class="sc1">/* Filename */</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fnsize</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
          </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fread</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fnsize</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fpZip</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">fnsize</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fwrite</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fnsize</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fpOut</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">fnsize</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
              </span><span class="sc11">offset</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">fnsize</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
              </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Z_ERRNO</span><span class="sc10">;</span><span class="sc0">
              </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
          </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Z_ERRNO</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
          </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Z_STREAM_ERROR</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc1">/* Extra field */</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">extsize</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
          </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fread</span><span class="sc10">(</span><span class="sc11">extra</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">extsize</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fpZip</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">extsize</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fwrite</span><span class="sc10">(</span><span class="sc11">extra</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">extsize</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fpOut</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">extsize</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
              </span><span class="sc11">offset</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">extsize</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
              </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Z_ERRNO</span><span class="sc10">;</span><span class="sc0">
              </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
          </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Z_ERRNO</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        
        </span><span class="sc1">/* Data */</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
          </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">dataSize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">cpsize</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">dataSize</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">dataSize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">uncpsize</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc10">}</span><span class="sc0">
          </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">dataSize</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc16">char</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">data</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">malloc</span><span class="sc10">(</span><span class="sc11">dataSize</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">data</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
              </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">fread</span><span class="sc10">(</span><span class="sc11">data</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">dataSize</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fpZip</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">dataSize</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">fwrite</span><span class="sc10">(</span><span class="sc11">data</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">dataSize</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fpOut</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">dataSize</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                  </span><span class="sc11">offset</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">dataSize</span><span class="sc10">;</span><span class="sc0">
                  </span><span class="sc11">totalBytes</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">dataSize</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                  </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Z_ERRNO</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
              </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Z_ERRNO</span><span class="sc10">;</span><span class="sc0">
              </span><span class="sc10">}</span><span class="sc0">
              </span><span class="sc11">free</span><span class="sc10">(</span><span class="sc11">data</span><span class="sc10">);</span><span class="sc0">
              </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">Z_OK</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
              </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
              </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Z_MEM_ERROR</span><span class="sc10">;</span><span class="sc0">
              </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
          </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        
        </span><span class="sc1">/* Central directory entry */</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
          </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">header</span><span class="sc10">[</span><span class="sc4">46</span><span class="sc10">];</span><span class="sc0">
          </span><span class="sc16">char</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">comment</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">""</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">comsize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">comment</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc11">WRITE_32</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x02014b50</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc11">WRITE_16</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">version</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc11">WRITE_16</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">6</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">version</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc11">WRITE_16</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">gpflag</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc11">WRITE_16</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">10</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">method</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc11">WRITE_16</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">12</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">filetime</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc11">WRITE_16</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">14</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">filedate</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc11">WRITE_32</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">crc</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc11">WRITE_32</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">20</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">cpsize</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc11">WRITE_32</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">24</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">uncpsize</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc11">WRITE_16</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">28</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fnsize</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc11">WRITE_16</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">30</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">extsize</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc11">WRITE_16</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">32</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">comsize</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc11">WRITE_16</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">34</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">     </span><span class="sc1">/* disk # */</span><span class="sc0">
          </span><span class="sc11">WRITE_16</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">36</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">     </span><span class="sc1">/* int attrb */</span><span class="sc0">
          </span><span class="sc11">WRITE_32</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">38</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">     </span><span class="sc1">/* ext attrb */</span><span class="sc0">
          </span><span class="sc11">WRITE_32</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">42</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">currentOffset</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc1">/* Header */</span><span class="sc0">
          </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fwrite</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">46</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fpOutCD</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">46</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">offsetCD</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">46</span><span class="sc10">;</span><span class="sc0">
            
            </span><span class="sc1">/* Filename */</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fnsize</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
              </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fwrite</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fnsize</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fpOutCD</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">fnsize</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">offsetCD</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">fnsize</span><span class="sc10">;</span><span class="sc0">
              </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Z_ERRNO</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
              </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
              </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Z_STREAM_ERROR</span><span class="sc10">;</span><span class="sc0">
              </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            
            </span><span class="sc1">/* Extra field */</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">extsize</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
              </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fwrite</span><span class="sc10">(</span><span class="sc11">extra</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">extsize</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fpOutCD</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">extsize</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">offsetCD</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">extsize</span><span class="sc10">;</span><span class="sc0">
              </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Z_ERRNO</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
              </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            
            </span><span class="sc1">/* Comment field */</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">comsize</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
              </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">fwrite</span><span class="sc10">(</span><span class="sc11">comment</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">comsize</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fpOutCD</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">comsize</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">offsetCD</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">comsize</span><span class="sc10">;</span><span class="sc0">
              </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Z_ERRNO</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
              </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            
            
          </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Z_ERRNO</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc1">/* Success */</span><span class="sc0">
        </span><span class="sc11">entries</span><span class="sc10">++;</span><span class="sc0">

      </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc1">/* Final central directory  */</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">entriesZip</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">entries</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">header</span><span class="sc10">[</span><span class="sc4">22</span><span class="sc10">];</span><span class="sc0">
      </span><span class="sc16">char</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">comment</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">""</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">// "ZIP File recovered by zlib/minizip/mztools";
</span><span class="sc0">      </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">comsize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">comment</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">entriesZip</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0xffff</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">entriesZip</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0xffff</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc10">}</span><span class="sc0">
      </span><span class="sc11">WRITE_32</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x06054b50</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc11">WRITE_16</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">    </span><span class="sc1">/* disk # */</span><span class="sc0">
      </span><span class="sc11">WRITE_16</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">6</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">    </span><span class="sc1">/* disk # */</span><span class="sc0">
      </span><span class="sc11">WRITE_16</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">entriesZip</span><span class="sc10">);</span><span class="sc0">   </span><span class="sc1">/* hack */</span><span class="sc0">
      </span><span class="sc11">WRITE_16</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">10</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">entriesZip</span><span class="sc10">);</span><span class="sc0">  </span><span class="sc1">/* hack */</span><span class="sc0">
      </span><span class="sc11">WRITE_32</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">12</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">offsetCD</span><span class="sc10">);</span><span class="sc0">    </span><span class="sc1">/* size of CD */</span><span class="sc0">
      </span><span class="sc11">WRITE_32</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">offset</span><span class="sc10">);</span><span class="sc0">      </span><span class="sc1">/* offset to CD */</span><span class="sc0">
      </span><span class="sc11">WRITE_16</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">20</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">comsize</span><span class="sc10">);</span><span class="sc0">     </span><span class="sc1">/* comment */</span><span class="sc0">
      
      </span><span class="sc1">/* Header */</span><span class="sc0">
      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fwrite</span><span class="sc10">(</span><span class="sc11">header</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">22</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fpOutCD</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">22</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        
        </span><span class="sc1">/* Comment field */</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">comsize</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
          </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">fwrite</span><span class="sc10">(</span><span class="sc11">comment</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">comsize</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fpOutCD</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">comsize</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Z_ERRNO</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        
      </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Z_ERRNO</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc1">/* Final merge (file + central directory) */</span><span class="sc0">
    </span><span class="sc11">fclose</span><span class="sc10">(</span><span class="sc11">fpOutCD</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">Z_OK</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc11">fpOutCD</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">fopen</span><span class="sc10">(</span><span class="sc11">fileOutTmp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"rb"</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fpOutCD</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">nRead</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">[</span><span class="sc4">8192</span><span class="sc10">];</span><span class="sc0">
        </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">nRead</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">fread</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc11">fpOutCD</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
          </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">fwrite</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">nRead</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fpOut</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">nRead</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Z_ERRNO</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">fclose</span><span class="sc10">(</span><span class="sc11">fpOutCD</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    
    </span><span class="sc1">/* Close */</span><span class="sc0">
    </span><span class="sc11">fclose</span><span class="sc10">(</span><span class="sc11">fpZip</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">fclose</span><span class="sc10">(</span><span class="sc11">fpOut</span><span class="sc10">);</span><span class="sc0">
    
    </span><span class="sc1">/* Wipe temporary file */</span><span class="sc0">
    </span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">)</span><span class="sc11">remove</span><span class="sc10">(</span><span class="sc11">fileOutTmp</span><span class="sc10">);</span><span class="sc0">
    
    </span><span class="sc1">/* Number of recovered entries */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">Z_OK</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">nRecovered</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc10">*</span><span class="sc11">nRecovered</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">entries</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc10">}</span><span class="sc0">
      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">bytesRecovered</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc10">*</span><span class="sc11">bytesRecovered</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">totalBytes</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">err</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Z_STREAM_ERROR</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">
  </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">err</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span></div></body>
</html>
